var Mixtures;(()=>{var t={371:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.getElectronBinding=void 0,e.getElectronBinding=t=>process._linkedBinding?process._linkedBinding("electron_common_"+t):process.electronBinding?process.electronBinding(t):null},759:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.browserModuleNames=e.commonModuleNames=void 0;const s=i(371);e.commonModuleNames=["clipboard","nativeImage","shell"],e.browserModuleNames=["app","autoUpdater","BaseWindow","BrowserView","BrowserWindow","contentTracing","crashReporter","dialog","globalShortcut","ipcMain","inAppPurchase","Menu","MenuItem","nativeTheme","net","netLog","MessageChannelMain","Notification","powerMonitor","powerSaveBlocker","protocol","pushNotifications","safeStorage","screen","session","ShareMenu","systemPreferences","TopLevelWindow","TouchBar","Tray","utilityProcess","View","webContents","WebContentsView","webFrameMain"].concat(e.commonModuleNames);const n=s.getElectronBinding("features");n&&n.isDesktopCapturerEnabled&&!n.isDesktopCapturerEnabled()||e.browserModuleNames.push("desktopCapturer"),n&&!n.isViewApiEnabled()||e.browserModuleNames.push("ImageView")},726:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.deserialize=e.serialize=e.isSerializableObject=e.isPromise=void 0;const s=i(157);e.isPromise=function(t){return t&&t.then&&t.then instanceof Function&&t.constructor&&t.constructor.reject&&t.constructor.reject instanceof Function&&t.constructor.resolve&&t.constructor.resolve instanceof Function};const n=[Boolean,Number,String,Date,Error,RegExp,ArrayBuffer];function o(t){return null===t||ArrayBuffer.isView(t)||n.some((e=>t instanceof e))}e.isSerializableObject=o;const l=function(t,e){const i=Object.entries(t).map((([t,i])=>[t,e(i)]));return Object.fromEntries(i)};e.serialize=function t(e){return e&&e.constructor&&"NativeImage"===e.constructor.name?function(t){const e=[],i=t.getScaleFactors();if(1===i.length){const s=i[0],n=t.getSize(s),o=t.toBitmap({scaleFactor:s});e.push({scaleFactor:s,size:n,buffer:o})}else for(const s of i){const i=t.getSize(s),n=t.toDataURL({scaleFactor:s});e.push({scaleFactor:s,size:i,dataURL:n})}return{__ELECTRON_SERIALIZED_NativeImage__:!0,representations:e}}(e):Array.isArray(e)?e.map(t):o(e)?e:e instanceof Object?l(e,t):e},e.deserialize=function t(e){return e&&e.__ELECTRON_SERIALIZED_NativeImage__?function(t){const e=s.nativeImage.createEmpty();if(1===t.representations.length){const{buffer:i,size:s,scaleFactor:n}=t.representations[0],{width:o,height:l}=s;e.addRepresentation({buffer:i,scaleFactor:n,width:o,height:l})}else for(const i of t.representations){const{dataURL:t,size:s,scaleFactor:n}=i,{width:o,height:l}=s;e.addRepresentation({dataURL:t,scaleFactor:n,width:o,height:l})}return e}(e):Array.isArray(e)?e.map(t):o(e)?e:e instanceof Object?l(e,t):e}},280:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CallbacksRegistry=void 0,e.CallbacksRegistry=class{constructor(){this.nextId=0,this.callbacks={},this.callbackIds=new WeakMap,this.locationInfo=new WeakMap}add(t){let e=this.callbackIds.get(t);if(null!=e)return e;e=this.nextId+=1,this.callbacks[e]=t,this.callbackIds.set(t,e);const i=/at (.*)/gi,s=(new Error).stack;if(!s)return e;let n,o;for(;null!==(o=i.exec(s));){const t=o[1];if(t.includes("(native)"))continue;if(t.includes("(<anonymous>)"))continue;if(t.includes("callbacks-registry.js"))continue;if(t.includes("remote.js"))continue;if(t.includes("@electron/remote/dist"))continue;const e=/([^/^)]*)\)?$/gi.exec(t);e&&(n=e[1]);break}return this.locationInfo.set(t,n),e}get(t){return this.callbacks[t]||function(){}}getLocation(t){return this.locationInfo.get(t)}apply(t,...e){return this.get(t).apply(global,...e)}remove(t){const e=this.callbacks[t];e&&(this.callbackIds.delete(e),delete this.callbacks[t])}}},918:function(t,e,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(t,e,i,s){void 0===s&&(s=i),Object.defineProperty(t,s,{enumerable:!0,get:function(){return e[i]}})}:function(t,e,i,s){void 0===s&&(s=i),t[s]=e[i]}),n=this&&this.__exportStar||function(t,e){for(var i in t)"default"===i||Object.prototype.hasOwnProperty.call(e,i)||s(e,t,i)};if(Object.defineProperty(e,"__esModule",{value:!0}),"browser"===process.type)throw new Error('"@electron/remote" cannot be required in the browser process. Instead require("@electron/remote/main").');n(i(246),e)},246:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.createFunctionWithReturnValue=e.getGlobal=e.getCurrentWebContents=e.getCurrentWindow=e.getBuiltin=void 0;const s=i(280),n=i(726),o=i(157),l=i(759),r=i(371),{Promise:a}=global,h=new s.CallbacksRegistry,u=new Map,m=new FinalizationRegistry((t=>{const e=u.get(t);void 0!==e&&void 0===e.deref()&&(u.delete(t),o.ipcRenderer.send("REMOTE_BROWSER_DEREFERENCE",p,t,0))})),d=new WeakMap,c=new WeakSet,p=process.contextId||function(){const t=r.getElectronBinding("v8_util");if(t)return t.getHiddenValue(global,"contextId");throw new Error("Electron >=v13.0.0-beta.6 required to support sandboxed renderers")}();process.on("exit",(()=>{o.ipcRenderer.send("REMOTE_BROWSER_CONTEXT_RELEASE",p)}));const f=Symbol("is-remote-proxy");function g(t,e=new Set){const i=t=>{if(e.has(t))return{type:"value",value:null};if(t&&t.constructor&&"NativeImage"===t.constructor.name)return{type:"nativeimage",value:n.serialize(t)};if(Array.isArray(t)){e.add(t);const i={type:"array",value:g(t,e)};return e.delete(t),i}if(t instanceof Buffer)return{type:"buffer",value:t};if(n.isSerializableObject(t))return{type:"value",value:t};if("object"==typeof t){if(n.isPromise(t))return{type:"promise",then:i((function(e,i){t.then(e,i)}))};if(d.has(t))return{type:"remote-object",id:d.get(t)};const s={type:"object",name:t.constructor?t.constructor.name:"",members:[]};e.add(t);for(const e in t)s.members.push({name:e,value:i(t[e])});return e.delete(t),s}return"function"==typeof t&&c.has(t)?{type:"function-with-return-value",value:i(t())}:"function"==typeof t?{type:"function",id:h.add(t),location:h.getLocation(t),length:t.length}:{type:"value",value:t}};return t.map(i)}function b(t,e,i,s){if(Array.isArray(s))for(const n of s){if(Object.prototype.hasOwnProperty.call(e,n.name))continue;const s={enumerable:n.enumerable};if("method"===n.type){const e=function(...t){let s;return s=this&&this.constructor===e?"REMOTE_BROWSER_MEMBER_CONSTRUCTOR":"REMOTE_BROWSER_MEMBER_CALL",A(o.ipcRenderer.sendSync(s,p,i,n.name,g(t)))};let l=x(e,i,n.name);s.get=()=>(l.ref=t,l),s.set=t=>(l=t,t),s.configurable=!0}else"get"===n.type&&(s.get=()=>A(o.ipcRenderer.sendSync("REMOTE_BROWSER_MEMBER_GET",p,i,n.name)),n.writable&&(s.set=t=>{const e=g([t]),s=o.ipcRenderer.sendSync("REMOTE_BROWSER_MEMBER_SET",p,i,n.name,e);return null!=s&&A(s),t}));Object.defineProperty(e,n.name,s)}}function y(t,e,i,s){if(null===s)return;const n={};b(t,n,i,s.members),y(t,n,i,s.proto),Object.setPrototypeOf(e,n)}function x(t,e,i){let s=!1;const n=()=>{if(s)return;s=!0;const n=o.ipcRenderer.sendSync("REMOTE_BROWSER_MEMBER_GET",p,e,i);b(t,t,n.id,n.members)};return new Proxy(t,{set:(t,e,i)=>("ref"!==e&&n(),t[e]=i,!0),get:(t,e)=>{if(e===f)return!0;Object.prototype.hasOwnProperty.call(t,e)||n();const i=t[e];return"toString"===e&&"function"==typeof i?i.bind(t):i},ownKeys:t=>(n(),Object.getOwnPropertyNames(t)),getOwnPropertyDescriptor:(t,e)=>Object.getOwnPropertyDescriptor(t,e)||(n(),Object.getOwnPropertyDescriptor(t,e))})}function A(t){if("value"===t.type)return t.value;if("array"===t.type)return t.members.map((t=>A(t)));if("nativeimage"===t.type)return n.deserialize(t.value);if("buffer"===t.type)return Buffer.from(t.value.buffer,t.value.byteOffset,t.value.byteLength);if("promise"===t.type)return a.resolve({then:A(t.then)});if("error"===t.type)return v(t);if("exception"===t.type)throw"error"===t.value.type?v(t.value):new Error(`Unexpected value type in exception: ${t.value.type}`);{let e;if("id"in t){const e=function(t){const e=u.get(t);if(void 0!==e){const t=e.deref();if(void 0!==t)return t}}(t.id);if(void 0!==e)return e}if("function"===t.type){const i=function(...e){let s;return s=this&&this.constructor===i?"REMOTE_BROWSER_CONSTRUCTOR":"REMOTE_BROWSER_FUNCTION_CALL",A(o.ipcRenderer.sendSync(s,p,t.id,g(e)))};e=i}else e={};return b(e,e,t.id,t.members),y(e,e,t.id,t.proto),e.constructor&&e.constructor[f]&&Object.defineProperty(e.constructor,"name",{value:t.name}),d.set(e,t.id),function(t,e){const i=new WeakRef(e);u.set(t,i),m.register(e,t)}(t.id,e),e}}function v(t){const e=t.value;for(const{name:i,value:s}of t.members)e[i]=A(s);return e}function M(t,e){o.ipcRenderer.on(t,((i,s,n,...l)=>{0===i.senderId?s===p?e(n,...l):o.ipcRenderer.send("REMOTE_BROWSER_WRONG_CONTEXT_ERROR",p,s,n):console.error(`Message ${t} sent by unexpected WebContents (${i.senderId})`)}))}const T=process.argv.includes("--enable-api-filtering-logging");function w(){const t={stack:void 0};return T&&Error.captureStackTrace(t,w),t.stack}M("REMOTE_RENDERER_CALLBACK",((t,e)=>{h.apply(t,A(e))})),M("REMOTE_RENDERER_RELEASE_CALLBACK",(t=>{h.remove(t)})),e.require=t=>A(o.ipcRenderer.sendSync("REMOTE_BROWSER_REQUIRE",p,t,w())),e.getBuiltin=function(t){return A(o.ipcRenderer.sendSync("REMOTE_BROWSER_GET_BUILTIN",p,t,w()))},e.getCurrentWindow=function(){return A(o.ipcRenderer.sendSync("REMOTE_BROWSER_GET_CURRENT_WINDOW",p,w()))},e.getCurrentWebContents=function(){return A(o.ipcRenderer.sendSync("REMOTE_BROWSER_GET_CURRENT_WEB_CONTENTS",p,w()))},e.getGlobal=function(t){return A(o.ipcRenderer.sendSync("REMOTE_BROWSER_GET_GLOBAL",p,t,w()))},Object.defineProperty(e,"process",{enumerable:!0,get:()=>e.getGlobal("process")}),e.createFunctionWithReturnValue=function(t){const e=()=>t;return c.add(e),e},l.browserModuleNames.forEach((t=>{Object.defineProperty(e,t,{enumerable:!0,get:()=>e.getBuiltin(t)})}))},606:(t,e,i)=>{t.exports=i(918)},317:t=>{"use strict";t.exports=require("child_process")},157:t=>{"use strict";t.exports=require("electron")},692:t=>{"use strict";t.exports=require("https")}},e={};function i(s){var n=e[s];if(void 0!==n)return n.exports;var o=e[s]={exports:{}};return t[s].call(o.exports,o,o.exports,i),o.exports}i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var s={};(()=>{"use strict";i.r(s),i.d(s,{ON_DESKTOP:()=>Cs,openNewWindow:()=>Bs,runMixfileEditor:()=>ks,setOnDesktop:()=>Ss});class t{static isBlank(t){return null==t||0==t.length}static notBlank(t){return null!=t&&t.length>0}static safeArray(t){return null==t?[]:t}static len(t){return null==t?0:t.length}static arrayLength(t){return null==t?0:t.length}static anyTrue(t){if(null==t)return!1;for(let e of t)if(e)return!0;return!1}static allTrue(t){if(null==t)return!0;for(let e of t)if(!e)return!1;return!0}static anyFalse(t){if(null==t)return!1;for(let e of t)if(!e)return!0;return!1}static allFalse(t){if(null==t)return!0;for(let e of t)if(e)return!1;return!0}static iterAnyTrue(t,e){for(let i of t)if(e(i))return!0;return!1}static iterAllTrue(t,e){for(let i of t)if(!e(i))return!1;return!0}static iterAnyFalse(t,e){for(let i of t)if(!e(i))return!0;return!1}static iterAllFalse(t,e){for(let i of t)if(e(i))return!1;return!0}static swap(t,e,i){let s=t[e];t[e]=t[i],t[i]=s}static duplicate(t){return null==t?[]:t.slice(0)}static append(t,e){return null==t||0==t.length?[e]:((t=t.slice(0)).push(e),t)}static prepend(t,e){return null==t||0==t.length?[e]:((t=t.slice(0)).unshift(e),t)}static concat(t,e){return null==t&&null==e?[]:null==t?e.slice(0):null==e?t.slice(0):t.concat(e)}static remove(t,e){return(t=t.slice(0)).splice(e,1),t}static flatten(t){let e=[];for(let i of t)e.push(...i);return e}static transpose(e){let i=e.length,s=e[0].length,n=t.anyArray(null,s);for(let o=0;o<s;o++){n[o]=t.anyArray(null,i);for(let t=0;t<i;t++)n[o][t]=e[t][o]}return n}static equals(t,e){if(null==t&&null==e)return!0;if(null==t||null==e)return!1;if(t.length!=e.length)return!1;for(let i=0;i<t.length;i++)if(t[i]!=e[i])return!1;return!0}static equivalent(t,e){const i=null==t?0:t.length;if(i!=(null==e?0:e.length))return!1;for(let s=0;s<i;s++)if(t[s]!=e[s])return!1;return!0}static compareTo(t,e){const i=Math.max(t.length,e.length);for(let s=0;s<i;s++){if(t[s]<e[s])return-1;if(t[s]>e[s])return 1}return 0}static booleanArray(t,e){let i=new Array(e);return i.fill(t),i}static numberArray(t,e){let i=new Array(e);return i.fill(t),i}static stringArray(t,e){let i=new Array(e);return i.fill(t),i}static anyArray(t,e){let i=new Array(e);return i.fill(t),i}static genericArray(t,e){let i=new Array(e);return i.fill(t),i}static genericBlankArrays(t){let e=new Array(t);for(let i=0;i<t;i++)e[i]=[];return e}static funcArray(t,e){let i=new Array(t);for(let s=0;s<t;s++)i[s]=e(s);return i}static first(t){return null==t||0==t.length?null:t[0]}static last(t){return null==t||0==t.length?null:t[t.length-1]}static min(t){if(null==t||0==t.length)return Number.MAX_VALUE;let e=t[0];for(let i=1;i<t.length;i++)e=Math.min(e,t[i]);return e}static max(t){if(null==t||0==t.length)return Number.MIN_VALUE;let e=t[0];for(let i=1;i<t.length;i++)e=Math.max(e,t[i]);return e}static idxMin(t){if(null==t||0==t.length)return-1;let e=0;for(let i=1;i<t.length;i++)t[i]<t[e]&&(e=i);return e}static idxMax(t){if(null==t||0==t.length)return-1;let e=0;for(let i=1;i<t.length;i++)t[i]>t[e]&&(e=i);return e}static range(t){if(null==t||0==t.length)return 0;let e=t[0],i=t[0];for(let s=1;s<t.length;s++)t[s]<e&&(e=t[s]),t[s]>i&&(i=t[s]);return i-e}static reverse(t){let e=[];for(let i=t.length-1;i>=0;i--)e.push(t[i]);return e}static identity0(t){let e=new Array(t);for(let i=0;i<t;i++)e[i]=i;return e}static identity1(t){let e=new Array(t);for(let i=0;i<t;i++)e[i]=i+1;return e}static identityN(t,e){let i=new Array(e);for(let s=0;s<e;s++)i[s]=s+t;return i}static notMask(t){let e=new Array(t.length);for(let i=t.length-1;i>=0;i--)e[i]=!t[i];return e}static idxGet(t,e){let i=[];for(let s=0;s<e.length;s++)i.push(t[e[s]]);return i}static maskCount(t){if(!t)return 0;let e=0;for(let i=t.length-1;i>=0;i--)t[i]&&e++;return e}static maskIdx(t){let e=[];for(let i=0;i<t.length;i++)t[i]&&e.push(i);return e}static idxMask(e,i){let s=t.booleanArray(!1,i);for(let t of e)s[t]=!0;return s}static maskMap(t){let e=[];for(let i=0,s=0;i<t.length;i++)e.push(t[i]?s++:-1);return e}static maskGet(t,e){let i=[];for(let s=0;s<t.length;s++)e[s]&&i.push(t[s]);return i}static maskEqual(t,e){let i=[];if(e.constructor===Array){let s=e;for(let e=0;e<t.length;e++)i.push(t[e]==s[e])}else for(let s=0;s<t.length;s++)i.push(t[s]==e);return i}static sum(t){if(null==t||0==t.length)return 0;let e=t[0];for(let i=1;i<t.length;i++)e+=t[i];return e}static add(t,e){let i=[];if(e.constructor===Array){let s=e;for(let e=0;e<t.length;e++)i.push(t[e]+s[e])}else for(let s=0;s<t.length;s++)i.push(t[s]+e);return i}static sub(t,e){let i=[];if(e.constructor===Array){let s=e;for(let e=0;e<t.length;e++)i.push(t[e]-s[e])}else for(let s=0;s<t.length;s++)i.push(t[s]-e);return i}static mul(t,e){let i=[];if(e.constructor===Array){let s=e;for(let e=0;e<t.length;e++)i.push(t[e]*s[e])}else for(let s=0;s<t.length;s++)i.push(t[s]*e);return i}static neg(t){let e=t.slice(0);for(let t=e.length-1;t>=0;t--)e[t]*=-1;return e}static setTo(t,e){for(let i=null==t?-1:t.length-1;i>=0;i--)t[i]=e}static addTo(t,e){for(let i=null==t?-1:t.length-1;i>=0;i--)t[i]+=e}static mulBy(t,e){for(let i=null==t?-1:t.length-1;i>=0;i--)t[i]*=e}static addToArray(t,e){for(let i=null==t?-1:t.length-1;i>=0;i--)t[i]+=e[i]}static subFromArray(t,e){for(let i=null==t?-1:t.length-1;i>=0;i--)t[i]-=e[i]}static mulByArray(t,e){for(let i=null==t?-1:t.length-1;i>=0;i--)t[i]*=e[i]}static divByArray(t,e){for(let i=null==t?-1:t.length-1;i>=0;i--)t[i]/=e[i]}static idxSort(t){let e=new Array(t.length);for(let i=0;i<t.length;i++)e[i]=i;return e.sort(((e,i)=>t[e]<t[i]?-1:t[e]>t[i]?1:0)),e}static sort(t){t.sort(((t,e)=>t-e))}static sorted(t){return t=t.slice(0),this.sort(t),t}static sortedUnique(e){if(null==e||0==e.length)return[];let i=t.uniqueUnstable(e);return"number"==typeof e[0]?this.sort(i):i.sort(),i}static uniqueUnstable(t){return Array.from(new Set(t))}static uniqueStable(t){let e=new Set(t),i=[];for(let s of t)e.has(s)&&(i.push(s),e.delete(s));return i}static maskUnique(t){let e=new Set(t),i=this.booleanArray(!1,t.length);for(let s=0;s<t.length;s++)e.has(t[s])&&(i[s]=!0,e.delete(t[s]));return i}static idxUnique(t){let e=new Set(t),i=[];for(let s=0;s<t.length;s++)e.has(t[s])&&(i.push(s),e.delete(t[s]));return i}static exclude(e,i){const s=t.len(e);if(0==s)return[];let n=new Array(s),o=0;for(let t=0;t<e.length;t++)n[t]=i.indexOf(e[t])<0,n[t]&&o++;return o==s?e:t.maskGet(e,n)}}class e{static parityPerms(e){let i=t.booleanArray(!1,e.length),s=0;for(let t=e.length-1;t>=0;t--)if(i[t])s++;else{let s=t;do{s=e[s],i[s]=!0}while(s!=t)}return s}static parityIdentity(t){return 1&this.parityPerms(t)}static parityOrder(t){if(t.length<=1)return 0;if(2==t.length)return t[0]<t[1]?0:1;if(3==t.length){let e=1;return t[0]<t[1]&&e++,t[0]<t[2]&&e++,t[1]<t[2]&&e++,1&e}if(4==t.length){let e=0;return t[0]<t[1]&&e++,t[0]<t[2]&&e++,t[0]<t[3]&&e++,t[1]<t[2]&&e++,t[1]<t[3]&&e++,t[2]<t[3]&&e++,1&e}let e=[],i=t.slice(0);i.sort();for(let s=0;s<t.length;s++)e.push(i.indexOf(t[s]));return this.parityIdentity(e)}static smallPermutation(t){return 1==t?this.PERM1:2==t?this.PERM2:3==t?this.PERM3:4==t?this.PERM4:null}static allPermutations(e){if(e<=this.SMALL_PERMS)return this.smallPermutation(e);for(;this.PERM_CACHE.length<this.MAX_CACHE-this.SMALL_PERMS;)this.PERM_CACHE.push(null);if(e<this.MAX_CACHE&&null!=this.PERM_CACHE[e-this.SMALL_PERMS])return this.PERM_CACHE[e-this.SMALL_PERMS];let i=1;for(let t=2;t<=e;t++)i*=t;let s=[],n=t.identity0(e);s.push(n.slice(0));let o=t.booleanArray(!1,e);for(let l=1;l<i;l++)t:for(;n[0]<e;){n[e-1]++;for(let t=e-1;t>0&&!(n[t]<e);t--)n[t]=0,n[t-1]++;t.setTo(o,!1);for(let t of n){if(o[t])continue t;o[t]=!0}s[l]=n.slice(0);break}return e<this.MAX_CACHE&&(this.PERM_CACHE[e-this.SMALL_PERMS]=s),s}}e.PERM1=[[0]],e.PERM2=[[0,1],[1,0]],e.PERM3=[[0,1,2],[0,2,1],[1,0,2],[1,2,0],[2,0,1],[2,1,0]],e.PERM4=[[0,1,2,3],[0,1,3,2],[0,2,1,3],[0,2,3,1],[0,3,1,2],[0,3,2,1],[1,0,2,3],[1,0,3,2],[1,2,0,3],[1,2,3,0],[1,3,0,2],[1,3,2,0],[2,0,1,3],[2,0,3,1],[2,1,0,3],[2,1,3,0],[2,3,0,1],[2,3,1,0],[3,0,1,2],[3,0,2,1],[3,1,0,2],[3,1,2,0],[3,2,0,1],[3,2,1,0]],e.SMALL_PERMS=4,e.MAX_CACHE=8,e.PERM_CACHE=[];class n{constructor(e,i,s=0){if(this.m=e,this.n=i,0!=e){this.A=new Array(e);for(let n=0;n<e;n++)this.A[n]=t.numberArray(s,i)}}static fromArray(t){let e=new n(0,0);return e.A=t,e.m=t.length,e.n=t[0].length,e}clone(){const{A:t,m:e,n:i}=this;let s=new n(e,i);for(let n=0;n<e;n++)for(let e=0;e<i;e++)s.A[n][e]=t[n][e];return s}get numRows(){return this.m}get numCols(){return this.n}get(t,e){return this.A[t][e]}set(t,e,i){this.A[t][e]=i}transpose(){const{A:t,m:e,n:i}=this;let s=new n(i,e);const o=s.A;for(let s=0;s<e;s++)for(let e=0;e<i;e++)o[e][s]=t[s][e];return s}norm1(){const{A:t,m:e,n:i}=this;let s=0;for(let n=0;n<i;n++){let i=0;for(let s=0;s<e;s++)i+=Math.abs(t[s][n]);s=Math.max(s,i)}return s}normInf(){const{A:t,m:e,n:i}=this;let s=0;for(let n=0;n<e;n++){let e=0;for(let s=0;s<i;s++)e+=Math.abs(t[n][s]);s=Math.max(s,e)}return s}uminus(){const{A:t,m:e,n:i}=this;let s=new n(e,i),o=s.A;for(let s=0;s<e;s++)for(let e=0;e<i;e++)o[s][e]=-t[s][e];return s}plus(t){const{A:e,m:i,n:s}=this;let o=new n(i,s),l=o.A;for(let n=0;n<i;n++)for(let i=0;i<s;i++)l[n][i]=e[n][i]+t.A[n][i];return o}plusEquals(t){const{A:e,m:i,n:s}=this;for(let n=0;n<i;n++)for(let i=0;i<s;i++)e[n][i]=e[n][i]+t.A[n][i];return this}minus(t){const{A:e,m:i,n:s}=this;let o=new n(i,s),l=e;for(let n=0;n<i;n++)for(let i=0;i<s;i++)l[n][i]=e[n][i]-t.A[n][i];return o}minusEquals(t){const{A:e,m:i,n:s}=this;for(let n=0;n<i;n++)for(let i=0;i<s;i++)e[n][i]=e[n][i]-t.A[n][i];return this}arrayTimes(t){const{A:e,m:i,n:s}=this;let o=new n(i,s),l=o.A;for(let n=0;n<i;n++)for(let i=0;i<s;i++)l[n][i]=e[n][i]*t.A[n][i];return o}arrayTimesEquals(t){const{A:e,m:i,n:s}=this;for(let n=0;n<i;n++)for(let i=0;i<s;i++)e[n][i]=e[n][i]*t.A[n][i];return this}arrayRightDivide(t){const{A:e,m:i,n:s}=this;let o=new n(i,s),l=o.A;for(let n=0;n<i;n++)for(let i=0;i<s;i++)l[n][i]=e[n][i]/t.A[n][i];return o}arrayRightDivideEquals(t){const{A:e,m:i,n:s}=this;for(let n=0;n<i;n++)for(let i=0;i<s;i++)e[n][i]=e[n][i]/t.A[n][i];return this}arrayLeftDivide(t){const{A:e,m:i,n:s}=this;let o=new n(i,s),l=o.A;for(let n=0;n<i;n++)for(let i=0;i<s;i++)l[n][i]=t.A[n][i]/e[n][i];return o}arrayLeftDivideEquals(t){const{A:e,m:i,n:s}=this;for(let n=0;n<i;n++)for(let i=0;i<s;i++)e[n][i]=t.A[n][i]/e[n][i];return this}scalarTimes(t){const{A:e,m:i,n:s}=this;let o=new n(i,s),l=o.A;for(let n=0;n<i;n++)for(let i=0;i<s;i++)l[n][i]=t*e[n][i];return o}scalarTimesEquals(t){const{A:e,m:i,n:s}=this;for(let n=0;n<i;n++)for(let i=0;i<s;i++)e[n][i]=t*e[n][i];return this}times(t){const{A:e,m:i,n:s}=this;let o=new n(i,t.n),l=o.A,r=new Array(s);for(let n=0;n<t.n;n++){for(let e=0;e<s;e++)r[e]=t.A[e][n];for(let t=0;t<i;t++){let i=e[t],o=0;for(let t=0;t<s;t++)o+=i[t]*r[t];l[t][n]=o}}return o}rank(){return new o(this).rank()}cond(){return new o(this).cond()}trace(){const{A:t,m:e,n:i}=this;let s=0;for(let n=0;n<Math.min(e,i);n++)s+=t[n][n];return s}static identity(t,e){let i=new n(t,e),s=i.A;for(let i=0;i<t;i++)for(let t=0;t<e;t++)s[i][t]=i==t?1:0;return i}toString(){let t=["["];for(let e of this.A)t.push(JSON.stringify(e));return t.push("]"),t.join("\n")}}class o{constructor(e){let i=e.A,s=this.m=e.m,n=this.n=e.n,l=Math.min(s,n),r=this.s=new Array(Math.min(s+1,n)),a=this.U=new Array(s),h=this.V=new Array(n);for(let e=0;e<s;e++)a[e]=t.numberArray(0,l);for(let e=0;e<n;e++)h[e]=t.numberArray(0,n);let u=new Array(n),m=new Array(s),d=Math.min(s-1,n),c=Math.max(0,Math.min(n-2,s));for(let t=0;t<Math.max(d,c);t++){if(t<d){r[t]=0;for(let e=t;e<s;e++)r[t]=o.hypot(r[t],i[e][t]);if(0!=r[t]){i[t][t]<0&&(r[t]=-r[t]);for(let e=t;e<s;e++)i[e][t]/=r[t];i[t][t]+=1}r[t]=-r[t]}for(let e=t+1;e<n;e++){if(t<d&&0!=r[t]){let n=0;for(let o=t;o<s;o++)n+=i[o][t]*i[o][e];n=-n/i[t][t];for(let o=t;o<s;o++)i[o][e]+=n*i[o][t]}u[e]=i[t][e]}if(t<d)for(let e=t;e<s;e++)a[e][t]=i[e][t];if(t<c){u[t]=0;for(let e=t+1;e<n;e++)u[t]=o.hypot(u[t],u[e]);if(0!=u[t]){u[t+1]<0&&(u[t]=-u[t]);for(let e=t+1;e<n;e++)u[e]/=u[t];u[t+1]+=1}if(u[t]=-u[t],t+1<s&&0!=u[t]){for(let e=t+1;e<s;e++)m[e]=0;for(let e=t+1;e<n;e++)for(let n=t+1;n<s;n++)m[n]+=u[e]*i[n][e];for(let e=t+1;e<n;e++){let n=-u[e]/u[t+1];for(let o=t+1;o<s;o++)i[o][e]+=n*m[o]}}for(let e=t+1;e<n;e++)h[e][t]=u[e]}}let p=Math.min(n,s+1);d<n&&(r[d]=i[d][d]),s<p&&(r[p-1]=0),c+1<p&&(u[c]=i[c][p-1]),u[p-1]=0;for(let t=d;t<l;t++){for(let e=0;e<s;e++)a[e][t]=0;a[t][t]=1}for(let t=d-1;t>=0;t--)if(0!=r[t]){for(let e=t+1;e<l;e++){let i=0;for(let n=t;n<s;n++)i+=a[n][t]*a[n][e];i=-i/a[t][t];for(let n=t;n<s;n++)a[n][e]+=i*a[n][t]}for(let e=t;e<s;e++)a[e][t]=-a[e][t];a[t][t]=1+a[t][t];for(let e=0;e<t-1;e++)a[e][t]=0}else{for(let e=0;e<s;e++)a[e][t]=0;a[t][t]=1}for(let t=n-1;t>=0;t--){if(t<c&&0!=u[t])for(let e=t+1;e<l;e++){let i=0;for(let s=t+1;s<n;s++)i+=h[s][t]*h[s][e];i=-i/h[t+1][t];for(let s=t+1;s<n;s++)h[s][e]+=i*h[s][t]}for(let e=0;e<n;e++)h[e][t]=0;h[t][t]=1}let f=p-1,g=0,b=Math.pow(2,-52),y=Math.pow(2,-966);for(;p>0;){let t,e;for(t=p-2;t>=-1&&-1!=t;t--)if(Math.abs(u[t])<=y+b*(Math.abs(r[t])+Math.abs(r[t+1]))){u[t]=0;break}if(t==p-2)e=4;else{let i;for(i=p-1;i>=t&&i!=t;i--){let e=(i!=p?Math.abs(u[i]):0)+(i!=t+1?Math.abs(u[i-1]):0);if(Math.abs(r[i])<=y+b*e){r[i]=0;break}}i==t?e=3:i==p-1?e=1:(e=2,t=i)}if(t++,1==e){let e=u[p-2];u[p-2]=0;for(let i=p-2;i>=t;i--){let s=o.hypot(r[i],e),l=r[i]/s,a=e/s;r[i]=s,i!=t&&(e=-a*u[i-1],u[i-1]=l*u[i-1]);for(let t=0;t<n;t++)s=l*h[t][i]+a*h[t][p-1],h[t][p-1]=-a*h[t][i]+l*h[t][p-1],h[t][i]=s}}else if(2==e){let e=u[t-1];u[t-1]=0;for(let i=t;i<p;i++){let n=o.hypot(r[i],e),l=r[i]/n,h=e/n;r[i]=n,e=-h*u[i],u[i]=l*u[i];for(let e=0;e<s;e++)n=l*a[e][i]+h*a[e][t-1],a[e][t-1]=-h*a[e][i]+l*a[e][t-1],a[e][i]=n}}else if(3==e){let e=Math.max(Math.max(Math.max(Math.max(Math.abs(r[p-1]),Math.abs(r[p-2])),Math.abs(u[p-2])),Math.abs(r[t])),Math.abs(u[t])),i=r[p-1]/e,l=r[p-2]/e,m=u[p-2]/e,d=r[t]/e,c=u[t]/e,f=((l+i)*(l-i)+m*m)/2,b=i*m*(i*m),y=0;0==f&&0==b||(y=Math.sqrt(f*f+b),f<0&&(y=-y),y=b/(f+y));let x=(d+i)*(d-i)+y,A=d*c;for(let e=t;e<p-1;e++){let i=o.hypot(x,A),l=x/i,m=A/i;e!=t&&(u[e-1]=i),x=l*r[e]+m*u[e],u[e]=l*u[e]-m*r[e],A=m*r[e+1],r[e+1]=l*r[e+1];for(let t=0;t<n;t++)i=l*h[t][e]+m*h[t][e+1],h[t][e+1]=-m*h[t][e]+l*h[t][e+1],h[t][e]=i;if(i=o.hypot(x,A),l=x/i,m=A/i,r[e]=i,x=l*u[e]+m*r[e+1],r[e+1]=-m*u[e]+l*r[e+1],A=m*u[e+1],u[e+1]=l*u[e+1],e<s-1)for(let t=0;t<s;t++)i=l*a[t][e]+m*a[t][e+1],a[t][e+1]=-m*a[t][e]+l*a[t][e+1],a[t][e]=i}u[p-2]=x,g+=1}else if(4==e){if(r[t]<=0){r[t]=r[t]<0?-r[t]:0;for(let e=0;e<=f;e++)h[e][t]=-h[e][t]}for(;t<f&&!(r[t]>=r[t+1]);){let e=r[t];if(r[t]=r[t+1],r[t+1]=e,t<n-1)for(let i=0;i<n;i++)e=h[i][t+1],h[i][t+1]=h[i][t],h[i][t]=e;if(t<s-1)for(let i=0;i<s;i++)e=a[i][t+1],a[i][t+1]=a[i][t],a[i][t]=e;t++}g=0,p--}}}getU(){return n.fromArray(this.U)}getV(){return n.fromArray(this.V)}getSingularValues(){return this.s}getS(){const{n:t}=this;let e=new n(t,t,0),i=e.A;for(let e=0;e<t;e++)i[e][e]=this.s[e];return e}norm2(){return this.s[0]}cond(){const{m:t,n:e,s:i}=this;return i[0]/i[Math.min(t,e)-1]}rank(){const{m:t,n:e,s:i}=this;let s=Math.pow(2,-52),n=Math.max(t,e)*i[0]*s,o=0;for(let t=0;t<i.length;t++)i[t]>n&&o++;return o}static hypot(t,e){let i;return Math.abs(t)>Math.abs(e)?(i=e/t,i=Math.abs(t)*Math.sqrt(1+i*i)):0!=e?(i=t/e,i=Math.abs(e)*Math.sqrt(1+i*i)):i=0,i}}var l=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function l(t){try{a(s.next(t))}catch(t){o(t)}}function r(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(l,r)}a((s=s.apply(t,e||[])).next())}))};function r(t,e=0){if(null==t||0==t.length)return e;let i=t.startsWith("0x")?parseInt(t.substring(2),16):t.startsWith("#")?parseInt(t.substring(1),16):parseInt(t);return isNaN(i)?e:i}function a(t,e,i){let s=it(`<${e}/>`);return i&&s.attr(i),st(t).append(s),s.el}function h(t,e){if(null==t)return"";let i=t.toPrecision(e);if(i.indexOf(".")>0){for(;i.endsWith("0");)i=i.substring(0,i.length-1);i.endsWith(".")&&(i=i.substring(0,i.length-1))}return i}function u(t){let e=(16777215&t).toString(16);for(;e.length<6;)e="0"+e;return"#"+e}function m(t){let e=t>>>24&255;return 0==e?1:255==e?0:1-e*(1/255)}const d=1/255;function c(t){return 16777215==t?"white":0==t?"black":-1==t?null:t>=0&&t<=16777215?u(t):"rgba("+(t>>16&255)+","+(t>>8&255)+","+(255&t)+","+(1-(t>>24&255)*d)+")"}function p(t){let e="";if(!t)return"";for(t=t.firstChild;t;)3!=t.nodeType&&4!=t.nodeType||(e+=t.nodeValue),t=t.nextSibling;return e}function f(t,e){let i=st(e).offset();return[t.pageX-i.x,t.pageY-i.y]}function g(t,e,i,s,n){t.css({left:e+"px",top:i+"px",width:s+"px",height:n+"px"})}function b(t,e){return Math.hypot(t,e)}function y(t,e){return t*t+e*e}function x(t,e,i){return t*t+e*e+i*i}function A(t){return t<0?-1:t>0?1:0}function v(t){return t*t}function M(t){return 0==t?0:1/t}function T(t,e){return t==e||Math.abs(t-e)<=1e-7*Math.max(t,e)}function w(t,e){return t==e||Math.abs(t-e)<=1e-14*Math.max(t,e)}const E=2*Math.PI,C=1/E,S=Math.PI/180,k=180/Math.PI;function B(t){return t==-Math.PI?Math.PI:t<-Math.PI?t+Math.ceil((-t-Math.PI)*C)*E:t>Math.PI?t-Math.ceil((t-Math.PI)*C)*E:t}function N(t,e){let i=B(t)-B(e);return i-(i>Math.PI?E:0)+(i<=-Math.PI?E:0)}function q(t,e){let i=B(t)-B(e);return i+(i<0?E:0)}function O(t){if(null==t||0==t.length)return 0;let e=t[0];for(let i=1;i<t.length;i++)e=Math.min(e,t[i]);return e}function I(t){if(null==t||0==t.length)return 0;let e=t[0];for(let i=1;i<t.length;i++)e=Math.max(e,t[i]);return e}function L(t,e){if(null==t)return null;let i=t.firstChild;for(;i;){if(i.nodeName==e)return i;i=i.nextSibling}return null}function D(t,e){if(null==t)return null;let i=t.firstChild,s=[];for(;i;)i.nodeName==e&&s.push(i),i=i.nextSibling;return s}function R(t,e,i,s,n){let o=new Path2D;return o.moveTo(i-n,e),o.quadraticCurveTo(i,e,i,e+n),o.lineTo(i,s-n),o.quadraticCurveTo(i,s,i-n,s),o.lineTo(t+n,s),o.quadraticCurveTo(t,s,t,s-n),o.lineTo(t,e+n),o.quadraticCurveTo(t,e,t+n,e),o.closePath(),o}function P(t,e,i,s,n){t.beginPath(),t.moveTo(e,i),t.lineTo(s,n),t.stroke()}function z(t){return 1.4*t+"px sans-serif"}function F(){return"devicePixelRatio"in window&&window.devicePixelRatio>1?window.devicePixelRatio:1}function _(t){if(null==t)return null;if(Array.isArray(t))return t.slice(0);if("object"!=typeof t)return t;let e={};for(let i in t)e[i]=t[i];return e}function Y(t){if(null==t)return null;if("function"==typeof t)return null;if("object"!=typeof t)return t;let e=Array.isArray(t)?[]:{};for(let i in t){let s=t[i];e[i]="object"==typeof s?Y(s):s}return e}function X(t){if(!t)return"";const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,(t=>e[t]))}var U;function j(t){return l(this,void 0,void 0,(function*(){return new Promise(((e,i)=>{let s=new XMLHttpRequest;s.open("GET",t.toString(),!0),s.responseType="text",s.onload=()=>e(s.response.toString()),s.onerror=()=>e(null),s.send()}))}))}!function(t){t.Backspace="Backspace",t.Tab="Tab",t.Enter="Enter",t.Escape="Escape",t.Space=" ",t.PageUp="PageUp",t.PageDown="PageDown",t.End="End",t.Home="Home",t.Left="ArrowLeft",t.Right="ArrowRight",t.Up="ArrowUp",t.Down="ArrowDown",t.Delete="Delete",t.Insert="Insert"}(U||(U={}));let H=null;const V=Math.pow(2,-52);class W{constructor(e,i){this.px=e,this.py=i,this.numTriangles=0,this.edgeStack=t.numberArray(0,512),this.hull=null,this.px=e,this.py=i,this.sz=e.length;let s=Math.max(2*this.sz-5,0);this.triangles=new Array(3*s),this.halfedges=new Array(3*s),this.hashSize=Math.ceil(Math.sqrt(this.sz)),this.hullPrev=new Array(this.sz),this.hullNext=new Array(this.sz),this.hullTri=new Array(this.sz),this.hullHash=t.numberArray(-1,this.hashSize),this.ids=new Array(this.sz),this.dists=new Array(this.sz),this.update()}trimConcave(e){const i=v(e),{sz:s,px:n,py:o}=this;let l=this.triangles.slice(0),r=[];for(let t=0,e=0;e<l.length;t++,e+=3)r.push(s*Math.min(l[e+0],l[e+1])+Math.max(l[e+0],l[e+1])),r.push(s*Math.min(l[e+0],l[e+2])+Math.max(l[e+0],l[e+2])),r.push(s*Math.min(l[e+1],l[e+2])+Math.max(l[e+1],l[e+2]));let a=t.uniqueUnstable(r);for(let t=0;t<r.length;t++)r[t]=a.indexOf(r[t]);let h=new Array(r.length);for(;;){const e=l.length/3;h.fill(0);for(let t=0,i=0;t<e;t++,i+=3)h[r[i+0]]++,h[r[i+1]]++,h[r[i+2]]++;let s=t.booleanArray(!0,e);for(let t=0,a=0;t<e;t++,a+=3){const e=h[r[a+0]],u=h[r[a+1]],m=h[r[a+2]],d=l[a],c=l[a+1],p=l[a+2];1==e&&1!=u&&1!=m?s[t]=y(n[d]-n[c],o[d]-o[c])<i:1!=e&&1==u&&1!=m?s[t]=y(n[d]-n[p],o[d]-o[p])<i:1!=e&&1!=u&&1==m&&(s[t]=y(n[c]-n[p],o[c]-o[p])<i)}if(t.allTrue(s))break;let a=new Array(3*t.maskCount(s)),u=new Array(3*t.maskCount(s));for(let t=0,i=0,n=0,o=0;t<e;t++,i+=3)s[t]&&(a[n++]=l[i],a[n++]=l[i+1],a[n++]=l[i+2],u[o++]=r[i],u[o++]=r[i+1],u[o++]=r[i+2]);l=a,r=u}return l}traceOutline(e){const i=e.length/3,{sz:s,px:n,py:o}=this;let l=new Map;for(let t=0,n=0;t<i;t++,n+=3){const t=s*Math.min(e[n+0],e[n+1])+Math.max(e[n+0],e[n+1]),i=s*Math.min(e[n+0],e[n+2])+Math.max(e[n+0],e[n+2]),o=s*Math.min(e[n+1],e[n+2])+Math.max(e[n+1],e[n+2]);l.set(t,(l.get(t)||0)+1),l.set(i,(l.get(i)||0)+1),l.set(o,(l.get(o)||0)+1)}let r=[];for(let t of l.entries())if(1==t[1]){const e=t[0],i=Math.floor(e/s),n=e%s;r.push(i),r.push(n)}const a=t.uniqueUnstable(r),h=a.length,u=new Map;for(let t=0;t<h;t++)u.set(a[t],t);let m=t.numberArray(-1,h),d=t.numberArray(-1,h);for(let t=0;t<r.length;t+=2){const e=u.get(r[t]),i=u.get(r[t+1]);m[e]<0?m[e]=i:d[e]=i,m[i]<0?m[i]=e:d[i]=e}let c=t.booleanArray(!1,h),p=new Array(h);p[0]=0,c[0]=!0;for(let t=1;t<h;t++){const e=p[t-1];c[m[e]]?p[t]=d[e]:p[t]=m[e],c[p[t]]=!0}return t.idxGet(a,p)}update(){const e=this.sz;let{px:i,py:s,ids:n,dists:o,triangles:l,halfedges:r}=this;const a=t.min(i),h=t.min(s),u=t.max(i),m=t.max(s);for(let t=0;t<e;t++)n[t]=t;this.centreX=.5*(a+u),this.centreY=.5*(h+m);let d=0,c=0,p=0,f=Number.POSITIVE_INFINITY;for(let t=0;t<e;t++){const e=b(this.centreX-i[t],this.centreY-s[t]);e<f&&(d=t,f=e)}const g=i[d],y=s[d];f=Number.POSITIVE_INFINITY;for(let t=0;t<e;t++){if(t==d)continue;const e=b(g-i[t],y-s[t]);e<f&&e>0&&(c=t,f=e)}let x=i[c],A=s[c],v=Number.POSITIVE_INFINITY;for(let t=0;t<e;t++){if(t==d||t==c)continue;let e=this.circumRadius(g,y,x,A,i[t],s[t]);e<v&&(p=t,v=e)}let M=i[p],T=s[p];if(!Number.isFinite(v)){for(let t=0;t<e;t++)o[t]=i[t]-i[0],0==o[t]&&(o[t]=s[t]-s[0]);this.quicksort(0,e-1);let t=new Array(e),a=0,h=Number.NEGATIVE_INFINITY;for(let i=0;i<e;i++){let e=n[i];o[e]>h&&(t[a++]=e,h=o[e])}return this.hull=t.slice(0,a),l=[],void(r=[])}if(this.orient(g,y,x,A,M,T)){let t=c,e=x,i=A;c=p,x=M,A=T,p=t,M=e,T=i}this.pickCircumCentre(g,y,x,A,M,T);for(let t=0;t<e;t++)o[t]=b(i[t]-this.centreX,s[t]-this.centreY);this.quicksort(0,e-1),this.hullStart=d;let w=3;const{hullNext:E,hullPrev:C,hullTri:S,hullHash:k,hashSize:B}=this;E[d]=C[p]=c,E[c]=C[d]=p,E[p]=C[c]=d,S[d]=0,S[c]=1,S[p]=2,k.fill(-1),k[this.hashKey(g,y)]=d,k[this.hashKey(x,A)]=c,k[this.hashKey(M,T)]=p,this.numTriangles=0,this.addTriangle(d,c,p,-1,-1,-1);let N=0,q=0;for(let t=0;t<n.length;t++){let e=n[t],o=i[e],l=s[e];if(t>0&&Math.abs(o-N)<=V&&Math.abs(l-q)<=V)continue;if(N=o,q=l,e==d||e==c||e==p)continue;let r=0;for(let t=0,e=this.hashKey(o,l);t<B&&(r=k[(e+t)%B],!(r>=0&&r!=E[r]));t++);r=C[r];let a=r,h=E[a];for(;!this.orient(o,l,i[a],s[a],i[h],s[h]);){if(a=h,a==r){a=-1;break}h=E[a]}if(a<0)continue;let u=this.addTriangle(a,e,E[a],-1,-1,S[a]);S[e]=this.legalise(u+2),S[a]=u,w++;let m=E[a];for(h=E[m];this.orient(o,l,i[m],s[m],i[h],s[h]);)u=this.addTriangle(m,e,h,S[e],-1,S[m]),S[e]=this.legalise(u+2),E[m]=m,w--,m=h,h=E[m];if(a==r)for(h=C[a];this.orient(o,l,i[h],s[h],i[a],s[a]);)u=this.addTriangle(h,e,a,-1,S[a],S[h]),this.legalise(u+2),S[h]=u,E[a]=a,w--,a=h,h=C[a];this.hullStart=C[e]=a,E[a]=C[m]=e,E[e]=m,k[this.hashKey(o,l)]=e,k[this.hashKey(i[a],s[a])]=a}this.hull=new Array(w);for(let t=0,e=this.hullStart;t<w;t++)this.hull[t]=e,e=E[e];this.triangles=l.slice(0,this.numTriangles),this.halfedges=r.slice(0,this.numTriangles)}hashKey(t,e){return Math.floor(this.pseudoAngle(t-this.centreX,e-this.centreY)*this.hashSize)%this.hashSize}legalise(t){let e=0,i=0;for(;;){let s=this.halfedges[t],n=t-t%3;if(i=n+(t+2)%3,s<0){if(0==e)break;t=this.edgeStack[--e];continue}const o=s-s%3,l=n+(t+1)%3,r=o+(s+2)%3,{px:a,py:h,triangles:u,halfedges:m}=this,d=u[i],c=u[t],p=u[l],f=u[r];if(this.inCircle(a[d],h[d],a[c],h[c],a[p],h[p],a[f],h[f])){this.triangles[t]=f,this.triangles[s]=d;const n=m[r];if(n<0){let e=this.hullStart;do{if(this.hullTri[e]==r){this.hullTri[e]=t;break}e=this.hullPrev[e]}while(e!=this.hullStart)}this.link(t,n),this.link(s,m[i]),this.link(i,r);const l=o+(s+1)%3;e<this.edgeStack.length&&(this.edgeStack[e++]=l)}else{if(0==e)break;t=this.edgeStack[--e]}}return i}link(t,e){this.halfedges[t]=e,e>=0&&(this.halfedges[e]=t)}addTriangle(t,e,i,s,n,o){const l=this.numTriangles;return this.triangles[l]=t,this.triangles[l+1]=e,this.triangles[l+2]=i,this.link(l,s),this.link(l+1,n),this.link(l+2,o),this.numTriangles+=3,l}pseudoAngle(t,e){const i=t/(Math.abs(t)+Math.abs(e));return(e>0?3-i:1+i)/4}orientIfSure(t,e,i,s,n,o){const l=(s-e)*(n-t),r=(i-t)*(o-e);return Math.abs(l-r)>=33306690738754716e-32*Math.abs(l+r)?l-r:0}orient(t,e,i,s,n,o){let l=this.orientIfSure(n,o,t,e,i,s);return 0!=l||(l=this.orientIfSure(t,e,i,s,n,o),0!=l||(l=this.orientIfSure(i,s,n,o,t,e))),l<0}inCircle(t,e,i,s,n,o,l,r){const a=t-l,h=e-r,u=i-l,m=s-r,d=n-l,c=o-r,p=u*u+m*m,f=d*d+c*c;return a*(m*f-p*c)-h*(u*f-p*d)+(a*a+h*h)*(u*c-m*d)<0}circumRadius(t,e,i,s,n,o){const l=i-t,r=s-e,a=n-t,h=o-e,u=l*l+r*r,m=a*a+h*h,d=.5/(l*h-r*a),c=(h*u-r*m)*d,p=(l*m-a*u)*d;return c*c+p*p}pickCircumCentre(t,e,i,s,n,o){const l=i-t,r=s-e,a=n-t,h=o-e,u=l*l+r*r,m=a*a+h*h,d=.5/(l*h-r*a);this.centreX=t+(h*u-r*m)*d,this.centreY=e+(l*m-a*u)*d}quicksort(e,i){const{ids:s,dists:n}=this;if(i-e<=20)for(let t=e+1;t<=i;t++){const i=s[t],o=n[i];let l=t-1;for(;l>=e&&n[s[l]]>o;)s[l+1]=s[l--];s[l+1]=i}else{let o=e+i>>1,l=e+1,r=i;t.swap(s,o,l),n[s[e]]>n[s[i]]&&t.swap(s,e,i),n[s[l]]>n[s[i]]&&t.swap(s,l,i),n[s[e]]>n[s[l]]&&t.swap(s,e,l);let a=s[l];const h=n[a];for(;;){do{l++}while(n[s[l]]<h);do{r--}while(n[s[r]]>h);if(r<l)break;t.swap(s,l,r)}s[e+1]=s[r],s[r]=a,i-l+1>=r-e?(this.quicksort(l,i),this.quicksort(e,r-1)):(this.quicksort(e,r-1),this.quicksort(l,i))}}}class G{static pointInPolygon(t,e,i,s){if(t<O(i)||t>I(i)||e<O(s)||e>I(s))return!1;let n=i.length;for(let o=0;o<n;o++)if(i[o]==t&&s[o]==e)return!0;let o=!1;for(let l=0;l<n;l++){let r=i[l],a=s[l],h=i[l+1<n?l+1:0],u=s[l+1<n?l+1:0];e>Math.min(a,u)&&e<=Math.max(a,u)&&t<=Math.max(r,h)&&a!=u&&(r==h||t<=(e-a)*(h-r)/(u-a)+r)&&(o=!o)}return o}static areLinesParallel(t,e,i,s,n,o,l,r){let a=i-t,h=s-e,u=l-n,m=r-o,d=Math.abs(a)>Math.abs(h);if(d!=Math.abs(u)>Math.abs(m))return!1;const c=1e-6;return d?Math.abs(h/a-m/u)<c:Math.abs(a/h-u/m)<c}static lineIntersect(t,e,i,s,n,o,l,r){let a=((l-n)*(e-o)-(r-o)*(t-n))/((r-o)*(i-t)-(l-n)*(s-e));return[t+a*(i-t),e+a*(s-e)]}static isPointOnLineSeg(t,e,i,s,n,o){if(t<Math.min(i,n)||t>Math.max(i,n)||e<Math.min(s,o)||e>Math.max(s,o))return!1;if(t==i&&e==s||t==n&&e==o)return!0;let l=n-i,r=o-s;return Math.abs(l)>Math.abs(r)?w(e,r/l*(t-i)+s):w(t,l/r*(e-s)+i)}static pointLineDistance(t,e,i,s,n,o){let l=n-i,r=o-s;return Math.abs(r*t-l*e+n*s-o*i)/b(l,r)}static pointLineSegDistance(t,e,i,s,n,o){let l=n-i,r=o-s,a=((t-i)*l+(e-s)*r)/y(l,r);return a=Math.max(0,Math.min(1,a)),b(t-(i+a*l),e-(s+a*r))}static doLineSegsIntersect(t,e,i,s,n,o,l,r){if(Math.max(t,i)<Math.min(n,l)||Math.max(e,s)<Math.min(o,r))return!1;if(Math.min(t,i)>Math.max(n,l)||Math.min(e,s)>Math.max(o,r))return!1;if(t==n&&e==o||t==l&&e==r||i==n&&s==o||i==l&&s==r)return!0;if(!(t!=i&&n!=l||t!=n&&t!=l&&i!=n&&i!=l))return!0;if(!(e!=s&&o!=r||e!=o&&e!=r&&s!=o&&s!=r))return!0;let a=l-n,h=r-o,u=i-t,m=s-e,d=t-n,c=e-o,p=a*c-h*d,f=u*c-m*d,g=h*u-a*m;return 0!=g&&(g<0&&(g=-g,p=-p,f=-f),p>=0&&p<=g&&f>=0&&f<=g)}static rectsIntersect(t,e,i,s,n,o,l,r){return t<=n&&t+i>=n+l&&e<=o&&e+s>=o+r||n<=t&&n+l>=t+i&&o<=e&&o+r>=e+s||!(t+i<n||n+l<t||e+s<o||o+r<e)}static sortAngles(e){if(null==e||e.length<2)return e;e=e.slice(0);for(let t=0;t<e.length;t++)e[t]=B(e[t]);if(2==e.length)return q(e[1],e[0])>Math.PI?[e[1],e[0]]:e;for(t.sort(e);;){let t=e[e.length-1],i=e[0],s=e[1];if(N(i,t)<=N(s,i))break;for(let t=e.length-1;t>0;t--)e[t]=e[t-1];e[0]=t}return e}static idxSortAngles(e){const i=t.len(e);if(null==e||i<2)return t.identity0(i);if(2==i)return q(e[1],e[0])>Math.PI?[1,0]:[0,1];e=t.duplicate(e);for(let t=0;t<i;t++)e[t]=B(e[t]);let s=t.idxSort(e);for(;;){let t=e[s[i-1]],n=e[s[0]],o=e[s[1]];if(N(n,t)<=N(o,n))break;let l=s.pop();s.unshift(l)}return s}static uniqueAngles(t,e){let i=G.sortAngles(t),s=[];s.push(i[0]);for(let t=1;t<i.length;t++)Math.abs(N(i[t],i[t-1]))>e&&s.push(i[t]);return s}static thetaObtuse(t,e){let i=e-t;for(;i<-Math.PI;)i+=2*Math.PI;for(;i>Math.PI;)i-=2*Math.PI;return i>0?t-.5*(2*Math.PI-i):t+.5*(2*Math.PI+i)}static emergentAngle(e){let i=e.length;if(1==i)return e[0];if(2==i)return.5*(e[0]+e[1]);t.sort(e);let s=0,n=q(e[0],e[i-1]);for(let t=1;t<i;t++){let i=q(e[t],e[t-1]);i>n&&(s=t,n=i)}let o=0;for(let t=0;t<i;t++){let i=e[t]-e[s];i<0&&(i+=E),o+=i}return o/i+e[s]}static dotProduct(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}static crossProduct(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}static affineTranslate(t,e){return[[1,0,t],[0,1,e],[0,0,1]]}static affineMirror(t,e){return[[t?-1:1,0,0],[0,e?-1:1,0],[0,0,1]]}static affineScale(t,e){return[[t,0,0],[0,e,0],[0,0,1]]}static affineRotate(t){let e=Math.cos(t),i=Math.sin(t);return[[e,-i,0],[i,e,0],[0,0,1]]}static affineCompose(t,e){let i=[[0,0,0],[0,0,0],[0,0,0]],s=[0,0,0];for(let n=0;n<3;n++){for(let e=0;e<3;e++)s[e]=t[e][n];for(let t=0;t<3;t++){let o=e[t],l=0;for(let t=0;t<3;t++)l+=s[t]*o[t];i[t][n]=l}}return i}static applyAffine(t,e,i){return[t*i[0][0]+e*i[0][1]+i[0][2],t*i[1][0]+e*i[1][1]+i[1][2]]}static applyAffineArray(t,e,i){for(let s=0;s<t.length;s++)[t[s],e[s]]=this.applyAffine(t[s],e[s],i)}static isAffineMirror(t){let e=t[0][0],i=t[0][1],s=t[0][2],n=t[1][0],o=t[1][1],l=t[1][2],r=t[2][0],a=t[2][1],h=t[2][2];return e*o*h+i*l*r+s*n*a-s*o*r-i*n*h-e*l*a<0}static magnitude2(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]}static magnitude(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])}static dist2(t,e){let i=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2];return i*i+s*s+n*n}static dist(t,e){let i=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2];return Math.sqrt(i*i+s*s+n*n)}static normalise(t){const e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];if(0==e)return;const i=1/Math.sqrt(e);t[0]*=i,t[1]*=i,t[2]*=i}static normalised(t){let e=t.slice(0);return this.normalise(e),e}static acuteAngle(t,e){let i=this.magnitude(t),s=this.magnitude(e);if(0==i||0==s)return 0;let n=this.dotProduct(t,e)/(i*s);return n=Math.max(-1,Math.min(1,n)),Math.acos(n)}static arcControlPoints(t,e,i,s,n){let o=-i,l=e,r=n,a=-s,h=.5*(e+s),u=.5*(i+n),m=3/8*(o+r),d=3/8*(l+a),c=m*m+d*d,p=h*m+u*d,f=p*p-c*(h*h+u*u-t*t),g=(Math.sqrt(f)-p)/c;return[e+g*o,i+g*l,s+g*r,n+g*a]}static createBezierEllipse(t,e,i,s,n){let o=24,l=Math.cos(n),r=Math.sin(n),a=E/o,h=new Array(49),u=new Array(49);for(let n=0;n<o;n++){let o=n*a,m=Math.cos(o),d=Math.sin(o);h[2*n]=i*m*l-s*d*r+t,u[2*n]=i*m*r+s*d*l+e}h[48]=h[0],u[48]=u[0];for(let t=0;t<o;t++){let e=(t-1+o)%o,i=t,s=(t+1)%o,n=(t+2)%o,l=h[2*e],r=h[2*i],a=h[2*s],m=h[2*n],d=u[2*e],c=u[2*i],p=u[2*s],f=u[2*n];h[2*t+1]=.5*(r+a+.3*(r-l+a-m)),u[2*t+1]=.5*(c+p+.3*(c-d+p-f))}let m=new Array(49);for(let t=0;t<49;t++)m[t]=!(1&~t);return{px:h,py:u,ctrl:m}}static fitCircle(t,e){let i=Number.POSITIVE_INFINITY;for(let s=0;s<t.length;s++)i=Math.min(i,y(t[s],e[s]));return Math.sqrt(i)}static fitEllipse(e,i,s,n,o,l){let r=.5*this.fitCircle(e,i),a=r,h=r*a,u=t.concat(e,[s,o,0,0]),m=t.concat(i,[0,0,n,l]);const d=u.length;let c=t=>{let e=Number.POSITIVE_INFINITY,i=1/(t[0]*t[0]),s=1/(t[1]*t[1]);for(let t=0;t<d;t++)e=Math.min(e,Math.sqrt(u[t]*u[t]*i+m[t]*m[t]*s));e<1&&(t[0]*=e,t[1]*=e),t[2]=t[0]*t[1]},p=1,f=[0,0,0],g=[0,0,0];for(;p>.001;){f[0]=r*(1+p),f[1]=a,c(f),g[0]=r,g[1]=a*(1+p),c(g);let t=!1;f[2]>h&&(r=f[0],a=f[1],h=f[2],t=!0),g[2]>h&&(r=g[0],a=g[1],h=g[2],t=!0),t||(p*=.6)}return[r,a]}static superimpose(e,i,s,l){let r=e.length;if(1==r)return[[1,0,s[0]-e[0]],[0,1,l[0]-i[0]],[0,0,1]];if(2==r){let t=Math.atan2(i[1]-i[0],e[1]-e[0]),n=N(Math.atan2(l[1]-l[0],s[1]-s[0]),t),o=Math.cos(n),r=Math.sin(n),a=o,h=-r,u=r,m=o,d=.5*(e[0]+e[1]),c=.5*(i[0]+i[1]);return[[a,h,.5*(s[0]+s[1])-(a*d+h*c)],[u,m,.5*(l[0]+l[1])-(u*d+m*c)],[0,0,1]]}let a=1/r,h=t.sum(e)*a,u=t.sum(i)*a,m=t.sum(s)*a,d=t.sum(l)*a,c=new n(3,r),p=new n(3,r);for(let t=0;t<r;t++)c.set(0,t,e[t]-h),c.set(1,t,i[t]-u),c.set(2,t,0),p.set(0,t,s[t]-m),p.set(1,t,l[t]-d),p.set(2,t,0);let f=c.times(p.transpose()),g=new o(f),b=g.getV().times(g.getU().transpose()),y=b.get(0,0),x=b.get(0,1),A=b.get(1,0),v=b.get(1,1);return[[y,x,m-(y*h+x*u)],[A,v,d-(A*h+v*u)],[0,0,1]]}static convexHull(t,e,i){let s=new Q(t,e,v(.1*i));return[s.hullX,s.hullY]}static outlinePolygon(e,i,s){let n=new W(e,i),o=n.trimConcave(s),l=n.traceOutline(o);return[t.idxGet(e,l),t.idxGet(i,l)]}}class Q{constructor(t,e,i){this.x=t,this.y=e,this.threshSq=i,this.hsz=0,this.hullX=[],this.hullY=[];const s=t.length;let n=0,o=0;for(let i=0;i<s;i++)(t[o]>t[i]||t[o]==t[i]&&e[o]>e[i])&&(o=i),(t[n]<t[i]||t[n]==t[i]&&e[n]<e[i])&&(n=i);let l=[],r=[];for(let t=0;t<s;t++)t!=n&&t!=o&&(this.right(o,n,t)>0?l.push(t):r.push(t));this.hullX.push(t[o]),this.hullY.push(e[o]),this.quickHull(o,n,l),this.hullX.push(t[n]),this.hullY.push(e[n]),this.quickHull(n,o,r);for(let t=0;t<this.hullX.length-1;)y(this.hullX[t]-this.hullY[t+1],this.hullY[t]-this.hullY[t+1])<i?(this.hullX.splice(t+1,1),this.hullY.splice(t+1,1)):t++}quickHull(t,e,i){if(0==i.length)return;let s=this.furthestPoint(t,e,i),n=[],o=[];for(let l=0;l<i.length;l++){let r=i[l];r!=t&&r!=e&&(this.right(t,s,r)>0?n.push(r):this.right(s,e,r)>0&&o.push(r))}this.quickHull(t,s,n),this.hullX.push(this.x[s]),this.hullY.push(this.y[s]),this.quickHull(s,e,o)}right(t,e,i){const s=this.x,n=this.y;return(s[t]-s[e])*(n[i]-n[e])-(s[i]-s[e])*(n[t]-n[e])}distance(t,e,i){const s=this.x,n=this.y;let o=((s[i]-s[t])*(s[e]-s[t])+(n[i]-n[t])*(n[e]-n[t]))/((s[e]-s[t])*(s[e]-s[t])+(n[e]-n[t])*(n[e]-n[t])),l=s[t]+o*(s[e]-s[t]),r=n[t]+o*(n[e]-n[t]);return(l-s[i])*(l-s[i])+(r-n[i])*(r-n[i])}furthestPoint(t,e,i){let s=-1,n=-1;for(let o=0;o<i.length;o++){let l=i[o];if(l==t||l==e)continue;let r=this.distance(t,e,l);r>s&&(s=r,n=l)}return n}}class K{static zero(){return new K}static fromArray(t){return new K(t[0],t[1])}constructor(t,e){this.x=null==t?0:t,this.y=null==e?0:e}clone(){return new K(this.x,this.y)}equals(t){return this.x==t.x&&this.y==t.y}scaleBy(t){1!=t&&(this.x*=t,this.y*=t)}offsetBy(t,e){this.x+=t,this.y+=e}withScaleBy(t){return new K(this.x*t,this.y*t)}withOffsetBy(t,e){return new K(this.x+t,this.y+e)}toString(){return"["+this.x+","+this.y+"]"}}class ${static zero(){return new $}static fromArray(t){return new $(t[0],t[1])}constructor(t,e){this.w=null==t?0:t,this.h=null==e?0:e}clone(){return new $(this.w,this.h)}equals(t){return this.w==t.w&&this.h==t.h}isZero(){return 0==this.w&&0==this.h}scaleBy(t){1!=t&&(this.w*=t,this.h*=t)}fitInto(t,e){let i=1;this.w>t&&(i=t/this.w),this.h>e&&(i=Math.min(i,e/this.h)),i<1&&this.scaleBy(i)}withScaleBy(t){return new $(this.w*t,this.h*t)}toString(){return"["+this.w+","+this.h+"]"}}class Z{static zero(){return new Z}static fromBounds(t,e,i,s){return new Z(t,e,i-t,s-e)}static fromSize(t){return new Z(0,0,t.w,t.h)}static fromOval(t){return new Z(t.cx-t.rw,t.cy-t.rh,2*t.rw,2*t.rh)}static fromArray(t){return new Z(t[0],t[1],t[2],t[3])}constructor(t,e,i,s){this.x=null==t?0:t,this.y=null==e?0:e,this.w=null==i?0:i,this.h=null==s?0:s}clone(){return new Z(this.x,this.y,this.w,this.h)}equals(t){return this.x==t.x&&this.y==t.y&&this.w==t.w&&this.h==t.h}getPos(){return new K(this.x,this.y)}setPos(t){this.x=t.x,this.y=t.y}getSize(){return new $(this.w,this.h)}setSize(t){this.w=t.w,this.h=t.h}minX(){return this.x}minY(){return this.y}midX(){return this.x+.5*this.w}midY(){return this.y+.5*this.h}maxX(){return this.x+this.w}maxY(){return this.y+this.h}area(){return this.w*this.h}scaleBy(t){1!=t&&(this.x*=t,this.y*=t,this.w*=t,this.h*=t)}offsetBy(t,e){this.x+=t,this.y+=e}grow(t,e){this.x-=t,this.y-=e,this.w+=2*t,this.h+=2*e}withScaleBy(t){return new Z(this.x*t,this.y*t,this.w*t,this.h*t)}withOffsetBy(t,e){return new Z(this.x+t,this.y+e,this.w,this.h)}withGrow(t,e){return new Z(this.x-t,this.y-e,this.w+2*t,this.h+2*e)}intersects(t){return G.rectsIntersect(this.x,this.y,this.w,this.h,t.x,t.y,t.w,t.h)}intersection(t){let e=this.x,i=e+this.w,s=this.y,n=s+this.h,o=t.x,l=o+t.w,r=t.y,a=r+t.h,h=Math.max(e,o),u=Math.max(s,r),m=Math.min(i,l),d=Math.min(n,a);return new Z(h,u,m-h,d-u)}contains(t,e){return t>=this.x&&t<this.x+this.w&&e>=this.y&&e<this.y+this.h}union(t){let e=Math.min(this.x,t.x),i=Math.max(this.x+this.w,t.x+t.w),s=Math.min(this.y,t.y),n=Math.max(this.y+this.h,t.y+t.h);return new Z(e,s,i-e,n-s)}isZero(){return 0==this.w&&0==this.h}isEmpty(){return 0==this.w&&0==this.h}notEmpty(){return this.w>0||this.h>0}toString(){return"["+this.x+","+this.y+";"+this.w+","+this.h+"]"}}class J{static zero(){return new J}static fromBox(t){return new J(t.x+.5*t.w,t.y+.5*t.h,.5*t.w,.5*t.h)}static fromArray(t){return new J(t[0],t[1],t[2],t[3])}constructor(t,e,i,s){this.cx=null==t?0:t,this.cy=null==e?0:e,this.rw=null==i?0:i,this.rh=null==s?0:s}clone(){return new J(this.cx,this.cy,this.rw,this.rh)}setCentre(t){this.cx=t.x,this.cy=t.y}setRadius(t){this.rw=t.w,this.rh=t.h}minX(){return this.cx-this.rw}minY(){return this.cy-this.rh}maxX(){return this.cx+this.rw}maxY(){return this.cy+this.rh}scaleBy(t){1!=t&&(this.cx*=t,this.cy*=t,this.rw*=t,this.rh*=t)}offsetBy(t,e){this.cx+=t,this.cy+=e}withScaleBy(t){return new J(this.cx*t,this.cy*t,this.rw*t,this.rh*t)}withOffsetBy(t,e){return new J(this.cx+t,this.cy+e,this.rw,this.rh)}contains(t,e){let i=t-this.cx,s=e-this.cy,n=i/this.rw,o=s/this.rh;return n*n+o*o<=1}toString(){return"["+this.cx+","+this.cy+";"+this.rw+","+this.rh+"]"}}class tt{static zero(){return new tt}static fromPos(t,e){return new tt(t.x,t.y,e.x,e.y)}constructor(t,e,i,s){this.x1=null==t?0:t,this.y1=null==e?0:e,this.x2=null==i?0:i,this.y2=null==s?0:s}clone(){return new tt(this.x1,this.y1,this.x2,this.y2)}setPos1(t){this.x1=t.x,this.y1=t.y}setPos2(t){this.x2=t.x,this.y2=t.y}minX(){return Math.min(this.x1,this.x2)}minY(){return Math.min(this.y1,this.y2)}maxX(){return Math.max(this.x1,this.x2)}maxY(){return Math.max(this.y1,this.y2)}scaleBy(t){1!=t&&(this.x1*=t,this.y1*=t,this.x2*=t,this.y2*=t)}offsetBy(t,e){this.x1+=t,this.y1+=e,this.x2+=t,this.y2+=e}toString(){return"["+this.x1+","+this.y1+";"+this.x2+","+this.y2+"]"}}class et{static parseXML(t){let e;return e=this.customParser?(new this.customParser).parseFromString(t,"application/xml"):(new DOMParser).parseFromString(t,"application/xml"),null==e?null:e}static toString(t){return this.customSerial?(new this.customSerial).serializeToString(t.documentElement):(new XMLSerializer).serializeToString(t.documentElement)}static toPrettyString(t){let e=['<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">','  <xsl:strip-space elements="*"/>','  <xsl:template match="para[content-style][not(text())]">','    <xsl:value-of select="normalize-space(.)"/>',"  </xsl:template>",'  <xsl:template match="node()|@*">','    <xsl:copy><xsl:apply-templates select="node()|@*"/></xsl:copy>',"  </xsl:template>",'  <xsl:output indent="yes"/>',"</xsl:stylesheet>"].join("\n"),i=this.parseXML(e),s=new XSLTProcessor;s.importStylesheet(i);let n=s.transformToDocument(t);return(new XMLSerializer).serializeToString(n)}static nodeText(t){let e="";for(let i of Array.from(t.childNodes))3!=i.nodeType&&4!=i.nodeType||(e+=i.nodeValue);return e}static childText(t,e){if(null==t)return null;let i=this.findElement(t,e);return null==i?null:this.nodeText(i)}static appendElement(t,e){let i=t.ownerDocument.createElement(e);return t.appendChild(i),i}static appendElementAfter(t,e){let i=t.ownerDocument.createElement(e),s=t.nextSibling;return null==s?t.parentNode.appendChild(i):t.parentNode.insertBefore(i,s),i}static appendText(t,e,i=!1){null!=e&&0!=e.length&&(i?t.appendChild(t.ownerDocument.createCDATASection(e)):t.appendChild(t.ownerDocument.createTextNode(e)))}static createTextChild(t,e,i,s=!1){let n=t.ownerDocument.createElement(e);t.appendChild(n),s?n.appendChild(t.ownerDocument.createCDATASection(i)):n.textContent=i}static setText(t,e,i=!1){for(;null!=t.firstChild;)t.removeChild(t.firstChild);this.appendText(t,e,i)}static findElement(t,e){if(null==t)return null;let i=t.firstChild;for(;null!=i;){if(1==i.nodeType&&i.nodeName==e)return i;i=i.nextSibling}return null}static findChildElements(t,e){if(null==t)return[];let i=[],s=t.firstChild;for(;null!=s;)1==s.nodeType&&s.nodeName===e&&i.push(s),s=s.nextSibling;return i}static childElements(t){if(null==t)return[];let e=[],i=t.firstChild;for(;null!=i;)1==i.nodeType&&e.push(i),i=i.nextSibling;return e}}function it(t){return"string"==typeof t?nt.parse(t):t instanceof nt?t:new nt(t)}function st(t){return null==t?null:t.jquery?it(t[0]):it(t)}et.customParser=null,et.customSerial=null;class nt{constructor(t){this.el=t}get elHTML(){return this.el}get elInput(){return this.el}get elCanvas(){return this.el}static parse(t){let e=et.parseXML(t);if(null==e)throw"Invalid XHTML string: "+t;let i=e.documentElement.outerHTML,s=document.createElement("template");return s.innerHTML=i,new nt(s.content.firstChild)}static find(t){let e=document.querySelector(t);return e?new nt(e):null}static findAll(t){let e=document.querySelectorAll(t),i=[];for(let t=0;t<e.length;t++)i.push(new nt(e.item(t)));return i}parent(){let t=this.el.parentElement;return t?new nt(t):null}ancestor(t){let e=this.el.closest(t);return e?new nt(e):null}children(t){let e=[];for(let i=this.el.firstElementChild;i;i=i.nextElementSibling)t&&i.tagName.toLocaleLowerCase()!=t.toLocaleLowerCase()||e.push(new nt(i));return e}find(t){let e=this.el.querySelector(t);return e?new nt(e):null}findAll(t){let e=this.el.querySelectorAll(t),i=[];for(let t=0;t<e.length;t++)i.push(new nt(e.item(t)));return i}exists(){return document.documentElement.contains(this.el)}isVisible(){return this.elHTML.offsetWidth>0||this.elHTML.offsetHeight>0||this.elHTML.getClientRects().length>0}append(t){this.el.append(t.el)}appendTo(t){return t instanceof nt?t.el.append(this.el):t.appendChild(this.el),this}prepend(t){this.el.prepend(t.el)}prependTo(t){return t instanceof nt?t.el.prepend(this.el):t.append(this.el),this}insertBefore(t){return t.el.parentElement.insertBefore(this.el,t.el),this}insertAfter(t){let e=t.el.nextElementSibling;return e?t.el.parentElement.insertBefore(this.el,e):t.el.parentElement.append(this.el),this}remove(){this.el.remove()}empty(){this.el.innerHTML=""}getHTML(){return this.el.innerHTML}setHTML(t){this.el.innerHTML=t}appendHTML(t){let e=et.parseXML("<z>"+t+"</z>");if(null==e)throw"Invalid XHTML string: "+t;let i=e.documentElement.innerHTML;this.el.insertAdjacentHTML("beforeend",i)}getText(){return this.el.textContent}setText(t){this.el.textContent=t}appendText(t){let e=document.createTextNode(t);this.el.appendChild(e)}getValue(){return this.el.value}setValue(t){this.el.value=t||""}getCSS(t){return this.elHTML.style.getPropertyValue(t)}setCSS(t,e){this.elHTML.style.setProperty(t,null==e?void 0:e.toString())}css(t){for(let e in t)this.setCSS(e,t[e].toString());return this}getAttr(t){return this.el.hasAttribute(t)?this.el.getAttribute(t):null}setAttr(t,e){this.el.setAttribute(t,e)}attr(t){for(let e in t)this.setAttr(e,t[e].toString());return this}addClass(t){for(let e of t.split(" "))e&&this.elHTML.classList.add(e)}removeClass(t){for(let e of t.split(" "))e&&this.elHTML.classList.remove(e)}hasClass(t){return this.elHTML.classList.contains(t)}setClass(t,e){e?this.addClass(t):this.removeClass(t)}class(t){return this.addClass(t),this}toggleClass(t){for(let e in t)t[e]?this.elHTML.classList.add(e):this.elHTML.classList.remove(e)}width(){return this.elHTML.offsetWidth}height(){return this.elHTML.offsetHeight}offset(){let t=this.el.getBoundingClientRect(),e=this.el.ownerDocument.defaultView;return new K(t.left+e.pageXOffset,t.top+e.pageYOffset)}size(){return new $(this.width(),this.height())}area(){let t=this.offset();return new Z(t.x,t.y,this.width(),this.height())}setBoundaryPixels(t,e,i,s){this.css({left:`${t}px`,top:`${e}px`,width:`${i}px`,height:`${s}px`})}setSizePixels(t,e){this.css({width:`${t}px`,height:`${e}px`})}hasFocus(){return this.el===document.activeElement}grabFocus(t=!1){t?setTimeout((()=>this.grabFocus()),10):this.elHTML.focus()}removeEvent(t,e){this.el.removeEventListener(t,e)}onKeyDown(t){this.el.addEventListener("keydown",t)}onKeyUp(t){this.el.addEventListener("keyup",t)}onKeyPress(t){this.el.addEventListener("keypress",t)}onScroll(t){this.el.addEventListener("scroll",t)}onWheel(t){this.el.addEventListener("wheel",t)}onClick(t){this.el.addEventListener("click",t)}onContextMenu(t){this.el.addEventListener("contextmenu",t)}onDblClick(t){this.el.addEventListener("dblclick",t)}onMouseDown(t){this.el.addEventListener("mousedown",t)}onMouseUp(t){this.el.addEventListener("mouseup",t)}onMouseEnter(t){this.el.addEventListener("mouseenter",t)}onMouseLeave(t){this.el.addEventListener("mouseleave",t)}onMouseMove(t){this.el.addEventListener("mousemove",t)}onMouseOver(t){this.el.addEventListener("mouseover",t)}onChange(t){this.el.addEventListener("change",t)}onInput(t){this.el.addEventListener("input",t)}onTouchStart(t){this.el.addEventListener("touchstart",t)}onTouchMove(t){this.el.addEventListener("touchmove",t)}onTouchCancel(t){this.el.addEventListener("touchcancel",t)}onTouchEnd(t){this.el.addEventListener("touchend",t)}}class ot{}ot.BASE_URL=null,ot.RESOURCE_URL=null,ot.foreground=0,ot.background=16777215,ot.lowlight=2412752,ot.lowlightEdge1=4707794,ot.lowlightEdge2=36817,ot.highlight=65280,ot.highlightEdge1=51801,ot.highlightEdge2=34384,ot.error=16711680;let lt=new Set;function rt(t){return lt.has(t)}function at(t,e){if(lt.has(t))return!1;let i=document.createElement("style");return i.innerHTML=e,document.head.appendChild(i),lt.add(t),!0}let ht=null,ut=0;function mt(t,e,i,s){at("tooltip","\n    *.wmk-tooltip-outer\n    {\n\t\tposition: absolute;\n\t\tborder-radius: 4px;\n\t\tborder: 1px solid black;\n\t\tbackground-color: white;\n\t\tpadding: 1px;\n\t\tpointer-events: none;\n        font-family: 'Open Sans', sans-serif;\n\t\tfont-size: 14px;\n    }\n\t*.wmk-tooltip-inner\n\t{\n\t\tcolor: white;\n\t\tborder-radius: 4px;\n\t\tbackground-color: black;\n\t\tpadding: 0.3em;\n\t\tmax-width: calc(min(40em, 50vw));\n\t}\n");let n=it(t),o=new ct(n,e,i,null==s?1e3:s);n.onMouseEnter((()=>o.start())),n.onMouseLeave((()=>o.stop()))}function dt(){null!=ht&&(ut++,ht.stop())}class ct{constructor(t,e,i,s){this.widget=t,this.bodyHTML=e,this.titleHTML=i,this.delay=s,this.domTooltip=null}start(){this.watermark=++ut,(()=>{var t,e,i,s;t=this,e=void 0,s=function*(){null==this.bodyHTML&&this.bodyCallback&&(this.bodyHTML=yield this.bodyCallback()),window.setTimeout((()=>{this.watermark==ut&&this.raise()}),this.delay)},new((i=void 0)||(i=Promise))((function(n,o){function l(t){try{a(s.next(t))}catch(t){o(t)}}function r(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(l,r)}a((s=s.apply(t,e||[])).next())}))})()}stop(){this.domTooltip&&(this.domTooltip.remove(),this.domTooltip=null),this.watermark=-1}raise(t){if(!this.widget.exists())return;if(ht=this,this.domTooltip)return;let e=this.domTooltip=it("<div/>").class("wmk-tooltip-outer").css({visibility:"hidden"}).appendTo(document.body),i=50;for(let t=this.widget;t&&0!=--i;t=t.parent()){let i=parseInt(t.elHTML.style.zIndex);if(i>0){e.setCSS("z-index",(i+1e3).toString());break}}let s=it("<div/>").appendTo(e).class("wmk-tooltip-inner"),n=null!=this.titleHTML&&this.titleHTML.length>0,o=null!=this.bodyHTML&&this.bodyHTML.length>0;n&&it("<div/>").appendTo(s).setHTML("<b>"+this.titleHTML+"</b>"),n&&o&&s.appendHTML("<hr/>"),o&&it("<div/>").appendTo(s).setHTML(this.bodyHTML);let l=window.innerWidth,r=window.innerHeight,a=this.widget.el.getBoundingClientRect(),h=a.left,u=a.top,m=h+a.width,d=u+a.height;t&&(h+=t.x,u+=t.y,m=h+t.w,d=u+t.h),e.css({left:"0px",top:"0px"}),setTimeout((()=>(()=>{let t=e.width(),i=e.height(),s=0,n=0;h+t<l?s=h:t<m&&(s=m-t),n=d+2+i<r?d+2:u-2-i>0?u-2-i:d+2,s+=window.pageXOffset,n+=window.pageYOffset,e.css({left:`${s}px`,top:`${n}px`,visibility:"visible"})})()),1);let c=()=>{this.watermark==ut&&this.widget.isVisible()&&this.widget.exists()?setTimeout(c,100):this.stop()};setTimeout(c,100)}}var pt;!function(t){t.NewMixture="newMixture",t.NewCollection="newCollection",t.Open="open",t.Save="save",t.SaveAs="saveAs",t.EditDetails="editDetails",t.EditStructure="editStructure",t.Lookup="lookup",t.ExportSVG="exportSVG",t.ExportSDF="exportSDF",t.CreateMInChI="createMInChI",t.Append="append",t.Prepend="prepend",t.InsertBefore="insertBefore",t.InsertAfter="insertAfter",t.Delete="delete",t.MoveUp="moveUp",t.MoveDown="moveDown",t.Undo="undo",t.Redo="redo",t.Copy="copy",t.CopyBranch="copyBranch",t.Cut="cut",t.Paste="paste",t.ZoomFull="zoomFull",t.ZoomNormal="zoomNormal",t.ZoomIn="zoomIn",t.ZoomOut="zoomOut",t.ViewDetail="viewDetail",t.ViewCard="viewCard",t.Back="back"}(pt||(pt={}));class ft{constructor(t,e){this.commands=t,this.callbackAction=e,this.callbackRefocus=null,this.mapDiv={},this.mapSVG={},this.mapActive={},this.selected=new Set,at("mixtures-menubanner","\n\t*.mixtures-menubanner-button:hover\n\t{\n\t\tbackground-color: #D0D0D0;\n\t}\n\t*.mixtures-menubanner-button:active\n\t{\n\t\tbackground-color: #C0C0C0;\n\t}\n")}render(t){t.empty(),this.divFlex=it("<div/>").appendTo(t).css({display:"flex",width:"100%",height:"100%"}),this.divFlex.css({"flex-direction":"row","flex-wrap":"nowrap","justify-content":"space-around","align-items":"center"}),this.divFlex.css({background:"linear-gradient(to bottom, #FFFFFF, #C0C0C0)"}),this.divFlex.css({"user-select":"none"});for(let t of this.commands){let e=it("<div/>").appendTo(this.divFlex);for(let i of t){let[t,s]=this.createCommand(i);e.append(t),this.mapDiv[i.cmd]=t,this.mapSVG[i.cmd]=s,this.mapActive[i.cmd]=!0}}}activateButtons(t){for(let e in t){let i=this.mapActive[e]=t[e];this.mapSVG[e].css({opacity:i?1:.5})}}addSelected(t){this.selected.has(t)||(this.selected.add(t),this.mapDiv[t].css({"background-color":"#D0D0D0"}))}removeSelected(t){this.selected.has(t)&&(this.selected.delete(t),this.mapDiv[t].css({"background-color":"transparent"}))}iconPosition(t){let e=this.mapDiv[t];return e?new Z(e.elHTML.offsetLeft,e.elHTML.offsetTop,e.width(),e.height()):null}createCommand(t){let e=it("<div/>").css({display:"inline-block"});e.setAttr("id","mixtureEditor_btn_"+t.icon.substring(0,t.icon.lastIndexOf(".")));let i=t.width?t.width:20;e.css({width:`${i}px`,height:"20px",margin:"2px",padding:"5px"}),e.css({"border-radius":"4px"}),this.selected.has(t.cmd)&&e.css({"background-color":"#D0D0D0"});let s=ot.RESOURCE_URL+"/img/icons/"+t.icon,n=it("<img/>").appendTo(e).attr({src:s});return e.addClass("mixtures-menubanner-button"),e.onClick((()=>{this.callbackRefocus&&this.callbackRefocus(),this.mapActive[t.cmd]&&this.callbackAction(t.cmd)})),t.tip&&mt(e,X(t.tip)),[e,n]}}class gt{}gt.ELEMENTS=[null,"H","He","Li","Be","B","C","N","O","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Ga","Ge","As","Se","Br","Kr","Rb","Sr","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Sb","Te","I","Xe","Cs","Ba","La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","Tl","Pb","Bi","Po","At","Rn","Fr","Ra","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr","Rf","Db","Sg","Bh","Hs","Mt","Ds","Rg","Cn"],gt.ELEMENT_GROUPS=[0,1,18,1,2,13,14,15,16,17,18,1,2,13,14,15,16,17,18,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,1,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,1,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,5,6,7,8,9,10,11,12],gt.ELEMENT_ROWS=[0,1,1,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],gt.ELEMENT_BLOCKS=[0,1,2,1,1,2,2,2,2,2,2,1,1,2,2,2,2,2,2,1,1,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,1,1,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,1,1,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,1,1,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3,3,3,3],gt.ELEMENT_VALENCE=[0,1,2,1,2,3,4,5,6,7,8,1,2,3,4,5,6,7,8,1,2,3,4,5,6,7,8,9,10,11,12,3,4,5,6,7,8,1,2,3,4,5,6,7,8,9,10,11,12,3,4,5,6,7,8,1,2,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,4,5,6,7,8,9,10,11,12,3,4,5,6,7,8,1,1,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,4,5,6,7,8,9,10,11,12],gt.ELEMENT_BONDING=[0,1,0,1,2,3,4,3,2,1,0,1,2,3,4,3,2,1,0,1,2,3,4,5,6,7,8,9,10,11,12,3,4,3,2,1,0,1,2,3,4,5,6,7,8,9,10,11,12,3,4,3,2,1,0,1,2,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,4,5,6,7,8,9,10,11,12,3,4,3,2,1,0,1,1,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,4,5,6,7,8,9,10,11,12],gt.ELEMENT_SHELL=[0,2,2,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,18,18,18,18,18,18,18,18,18,18,8,8,8,8,8,8,8,8,18,18,18,18,18,18,18,18,18,18,8,8,8,8,8,8,8,8,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,8,8,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18],gt.NATURAL_ATOMIC_WEIGHTS=[0,1.00794,4.002602,6.941,9.012182,10.811,12.0107,14.0067,15.9994,18.9984032,20.1797,22.98977,24.305,26.981538,28.0855,30.973761,32.065,35.453,39.948,39.0983,40.078,44.95591,47.867,50.9415,51.9961,54.938049,55.845,58.9332,58.6934,63.546,65.409,69.723,72.64,74.9216,78.96,79.904,83.798,85.4678,87.62,88.90585,91.224,92.90638,95.94,98,101.07,102.9055,106.42,107.8682,112.411,114.818,118.71,121.76,127.6,126.90447,131.293,132.90545,137.327,138.9055,140.116,140.90765,144.24,145,150.36,151.964,157.25,158.92534,162.5,164.93032,167.259,168.93421,173.04,174.967,178.49,180.9479,183.84,186.207,190.23,192.217,195.078,196.96655,200.59,204.3833,207.2,208.98038,209,210,222,223,226,227,230.0331266,231.03588,233.039628,237,244,243,247,247,251,252,257,258,259,262,261,262,266,264,277,268,271,272,285],gt.ELEMENT_H=1,gt.ELEMENT_He=2,gt.ELEMENT_Li=3,gt.ELEMENT_Be=4,gt.ELEMENT_B=5,gt.ELEMENT_C=6,gt.ELEMENT_N=7,gt.ELEMENT_O=8,gt.ELEMENT_F=9,gt.ELEMENT_Ne=10,gt.ELEMENT_Na=11,gt.ELEMENT_Mg=12,gt.ELEMENT_Al=13,gt.ELEMENT_Si=14,gt.ELEMENT_P=15,gt.ELEMENT_S=16,gt.ELEMENT_Cl=17,gt.ELEMENT_Ar=18,gt.ELEMENT_K=19,gt.ELEMENT_Ca=20,gt.ELEMENT_Sc=21,gt.ELEMENT_Ti=22,gt.ELEMENT_V=23,gt.ELEMENT_Cr=24,gt.ELEMENT_Mn=25,gt.ELEMENT_Fe=26,gt.ELEMENT_Co=27,gt.ELEMENT_Ni=28,gt.ELEMENT_Cu=29,gt.ELEMENT_Zn=30,gt.ELEMENT_Ga=31,gt.ELEMENT_Ge=32,gt.ELEMENT_As=33,gt.ELEMENT_Se=34,gt.ELEMENT_Br=35,gt.ELEMENT_Kr=36,gt.ELEMENT_Rb=37,gt.ELEMENT_Sr=38,gt.ELEMENT_Y=39,gt.ELEMENT_Zr=40,gt.ELEMENT_Nb=41,gt.ELEMENT_Mo=42,gt.ELEMENT_Tc=43,gt.ELEMENT_Ru=44,gt.ELEMENT_Rh=45,gt.ELEMENT_Pd=46,gt.ELEMENT_Ag=47,gt.ELEMENT_Cd=48,gt.ELEMENT_In=49,gt.ELEMENT_Sn=50,gt.ELEMENT_Sb=51,gt.ELEMENT_Te=52,gt.ELEMENT_I=53,gt.ELEMENT_Xe=54,gt.ELEMENT_Cs=55,gt.ELEMENT_Ba=56,gt.ELEMENT_La=57,gt.ELEMENT_Ce=58,gt.ELEMENT_Pr=59,gt.ELEMENT_Nd=60,gt.ELEMENT_Pm=61,gt.ELEMENT_Sm=62,gt.ELEMENT_Eu=63,gt.ELEMENT_Gd=64,gt.ELEMENT_Tb=65,gt.ELEMENT_Dy=66,gt.ELEMENT_Ho=67,gt.ELEMENT_Er=68,gt.ELEMENT_Tm=69,gt.ELEMENT_Yb=70,gt.ELEMENT_Lu=71,gt.ELEMENT_Hf=72,gt.ELEMENT_Ta=73,gt.ELEMENT_W=74,gt.ELEMENT_Re=75,gt.ELEMENT_Os=76,gt.ELEMENT_Ir=77,gt.ELEMENT_Pt=78,gt.ELEMENT_Au=79,gt.ELEMENT_Hg=80,gt.ELEMENT_Tl=81,gt.ELEMENT_Pb=82,gt.ELEMENT_Bi=83,gt.ELEMENT_Po=84,gt.ELEMENT_At=85,gt.ELEMENT_Rn=86,gt.ELEMENT_Fr=87,gt.ELEMENT_Ra=88,gt.ELEMENT_Ac=89,gt.ELEMENT_Th=90,gt.ELEMENT_Pa=91,gt.ELEMENT_U=92,gt.ELEMENT_Np=93,gt.ELEMENT_Pu=94,gt.ELEMENT_Am=95,gt.ELEMENT_Cm=96,gt.ELEMENT_Bk=97,gt.ELEMENT_Cf=98,gt.ELEMENT_Es=99,gt.ELEMENT_Fm=100,gt.ELEMENT_Md=101,gt.ELEMENT_No=102,gt.ELEMENT_Lr=103,gt.ELEMENT_Rf=104,gt.ELEMENT_Db=105,gt.ELEMENT_Sg=106,gt.ELEMENT_Bh=107,gt.ELEMENT_Hs=108,gt.ELEMENT_Mt=109,gt.ELEMENT_Ds=110,gt.ELEMENT_Rg=111,gt.ELEMENT_Cn=112;class bt{constructor(t,e,i){if(this.nbrs=[],this.indices=null,this.labels=null,this.props=null,null!=t)for(let e=0;e<t;e++)this.nbrs.push([]);if(null!=e&&null!=i)for(let t=0;t<e.length;t++)this.nbrs[e[t]].push(i[t]),this.nbrs[i[t]].push(e[t])}clone(){let t=new bt;for(let e of this.nbrs)t.nbrs.push(e.slice(0));return t.indices=null==this.indices?null:this.indices.slice(0),t.labels=null==this.labels?null:this.labels.slice(0),t.props=null==this.props?null:this.props.slice(0),t}static fromMolecule(t){let e=new bt;e.indices=[];for(let i=0;i<t.numAtoms;i++)e.nbrs.push([]),e.indices.push(i+1);for(let i=1;i<=t.numBonds;i++){let s=t.bondFrom(i)-1,n=t.bondTo(i)-1;e.nbrs[s].push(n),e.nbrs[n].push(s)}return e}static fromNeighbours(t){let e=new bt;return e.nbrs=t,e}toString(){let e="#nodes="+this.nbrs.length;for(let i=0;i<this.nbrs.length;i++)e+=" "+i+":{"+this.nbrs[i]+"}",i<t.len(this.indices)&&(e+="[i="+this.indices[i]+"]"),i<t.len(this.labels)&&(e+="[l="+this.labels[i]+"]");return e}get numNodes(){return this.nbrs.length}numEdges(t){return this.nbrs[t].length}getEdge(t,e){return this.nbrs[t][e]}getEdges(t){return this.nbrs[t]}getIndex(t){return null==this.indices?0:this.indices[t]}setIndex(e,i){null==this.indices&&(this.indices=t.numberArray(0,this.nbrs.length)),this.indices[e]=i}getLabel(t){return null==this.labels?null:this.labels[t]}setLabel(e,i){null==this.labels&&(this.labels=t.stringArray("",this.nbrs.length)),this.labels[e]=i}getProperty(t){return null==this.props?null:this.props[t]}setProperty(t,e){null==this.props&&(this.props=new Array(this.nbrs.length)),this.props[t]=e}addNode(){return this.nbrs.push([]),null!=this.indices&&this.indices.push(0),null!=this.labels&&this.labels.push(""),null!=this.props&&this.props.push(null),this.nbrs.length-1}hasEdge(t,e){return this.nbrs[t].length<=this.nbrs[e].length?this.nbrs[t].indexOf(e)>=0:this.nbrs[e].indexOf(t)>=0}addEdge(t,e){this.nbrs[t].push(e),this.nbrs[e].push(t)}removeEdge(t,e){let i=this.nbrs[t].indexOf(e),s=this.nbrs[e].indexOf(t);i>=0&&this.nbrs[t].splice(i,1),s>=0&&this.nbrs[e].splice(s,1)}isolateNode(t){for(let e of this.nbrs[t]){let i=this.nbrs[e].indexOf(t);i>=0&&this.nbrs[e].splice(i,1)}this.nbrs[t]=[]}keepNodesMask(e){const i=this.nbrs.length,s=t.maskCount(e);if(s==i)return;if(0==s)return this.nbrs=[],this.indices=null,this.labels=null,void(this.props=null);let n=t.maskMap(e),o=[];for(let t=0;t<s;t++)o.push([]);for(let t=0,s=0;t<i;t++)if(e[t]){for(let i of this.nbrs[t])e[i]&&o[s].push(n[i]);s++}this.nbrs=o,null!=this.indices&&(this.indices=t.maskGet(this.indices,e)),null!=this.labels&&(this.labels=t.maskGet(this.labels,e)),null!=this.props&&(this.props=t.maskGet(this.props,e))}keepNodesIndex(e){this.keepNodesMask(t.idxMask(e,this.numNodes))}removeNodesMask(e){this.keepNodesMask(t.notMask(e))}removeNodesIndex(e){this.removeNodesMask(t.idxMask(e,this.numNodes))}subgraphIndex(t){const e=t.length;let i=new bt(e);if(null!=this.indices||null!=this.labels||null!=this.props)for(let s=0;s<e;s++)null!=this.indices&&i.setIndex(s,this.indices[t[s]]),null!=this.labels&&i.setLabel(s,this.labels[t[s]]),null!=this.props&&i.setProperty(s,this.props[t[s]]);for(let s=0;s<e;s++)for(let e of this.nbrs[t[s]]){let n=t.indexOf(e);n>s&&i.addEdge(s,n)}return i}subgraphMask(t){let e=this.clone();return e.keepNodesMask(t),e}calculateComponents(){const e=this.nbrs.length;if(0==e)return[];let i=t.numberArray(0,e);i[0]=1;let s=1,n=1;for(;;){for(;s<e&&i[s]>0;)s++;if(s>=e)break;let t=!1;for(let n=s;n<e;n++)if(0==i[n])for(let e=0;e<this.nbrs[n].length;e++)0!=i[this.nbrs[n][e]]&&(i[n]=i[this.nbrs[n][e]],t=!0);t||(i[s]=++n)}return i}calculateComponentGroups(){if(0==this.nbrs.length)return[];let e=this.calculateComponents(),i=t.max(e),s=[];for(let t=0;t<i;t++)s.push([]);for(let t=0;t<e.length;t++)s[e[t]-1].push(t);return s}calculateRingBlocks(){let e=this.numNodes,i=this.nbrs;if(0==e)return[[],0];let s=new Array(this.numNodes),n=t.booleanArray(!1,e);t.setTo(s,0);let o=new Array(e+1),l=0,r=0;for(;;){let t,a;if(0==l)for(t=-1,a=0;n[a];a++);else{t=o[l-1],a=-1;for(let e=0;e<i[t].length;e++)if(!n[i[t][e]]){a=i[t][e];break}}if(a>=0&&l>=2){let r=o[l-1];for(let h=0;h<i[a].length;h++){let u=i[a][h];if(u!=r&&n[u]){o[l]=a;for(let i=l;i==l||o[i+1]!=u;i--){let n=s[o[i]];if(0==n)s[o[i]]=t;else if(n!=t)for(let i=0;i<e;i++)s[i]==n&&(s[i]=t)}}}}if(a>=0?(n[a]=!0,o[l++]=a,r++):l--,r==e)break}let a=0;for(let t=0;t<e;t++)if(s[t]>0){a--;for(let i=e-1;i>=t;i--)s[i]==s[t]&&(s[i]=a)}for(let t=0;t<e;t++)s[t]=-s[t];return[s,-a]}calculateRingBlockGroups(){let[e,i]=this.calculateRingBlocks();if(0==i)return[];let s=t.numberArray(0,i);for(let t=0;t<e.length;t++)e[t]>0&&s[e[t]-1]++;let n=new Array(i);for(let t=0;t<i;t++)n[t]=new Array(s[t]),s[t]=0;for(let t=0;t<e.length;t++){let i=e[t]-1;i<0||(n[i][s[i]++]=t)}return n}findRingsOfSize(t){let[e,i]=this.calculateRingBlocks();if(0==i)return[];let s=[],n=new Array(this.numNodes);for(let o=1;o<=i;o++){for(let t=0;t<this.numNodes;t++)n[t]=e[t]==o;let i=this.findRingsOfSizeMask(t,n);for(let t=0;t<i.length;t++)s.push(i[t])}return s}findRingsOfSizeMask(t,e){let i=[];for(let s=0;s<this.numNodes;s++)if(e[s]){let n=new Array(t);n[0]=s,this.recursiveRingFind(n,1,t,e,i)}return i}calculateBFS(e){let i=t.numberArray(-1,this.numNodes);i[e]=0;let s=0,n=1,o=0,l=t.numberArray(0,this.numNodes);for(l[0]=e;;){let t=n;for(let e=o;e<n;e++)for(let n=0;n<this.nbrs[l[e]].length;n++){let o=this.nbrs[l[e]][n];i[o]<0&&(i[o]=s+1,l[t++]=o)}if(t==n)break;o=n,n=t,s++}return i}calculateGravity(){const e=this.numNodes,{nbrs:i}=this;let s=t.numberArray(1,e),n=t.numberArray(0,e);for(let o=0;o<e;o++){t.setTo(n,s);for(let t=0;t<e;t++)for(let e=i[t].length-1;e>=0;e--)n[t]+=s[i[t][e]];t.setTo(s,n)}return s}recursiveRingFind(e,i,s,n,o){if(i<s){let l=e[i-1];for(let r=0;r<this.nbrs[l].length;r++){let a=this.nbrs[l][r];if(!n[a])continue;let h=!1;for(let t=0;t<i;t++)if(e[t]==a){h=!0;break}if(!h){let l=t.duplicate(e);l[i]=a,this.recursiveRingFind(l,i+1,s,n,o)}}return}let l=e[i-1],r=!1;for(let t=0;t<this.nbrs[l].length;t++)if(this.nbrs[l][t]==e[0]){r=!0;break}if(!r)return;for(let t=0;t<e.length;t++){let i=0,s=e[t];for(let t=0;t<this.nbrs[s].length;t++)e.indexOf(this.nbrs[s][t])>=0&&i++;if(2!=i)return}let a=0;for(let t=1;t<i;t++)e[t]<e[a]&&(a=t);let h=(a+1)%i,u=e[(a-1+i)%i]<e[h];if(0!=a||u){let t=new Array(i);for(let s=0;s<i;s++)t[s]=e[(a+(u?i-s:s))%i];e=t}for(let t=0;t<o.length;t++){let s=o[t],n=!0;for(let t=0;t<i;t++)if(s[t]!=e[t]){n=!1;break}if(n)return}o.push(e)}}class yt{constructor(t,e,i=[]){this.mol=t,this.resBonds=e,this.atomHyd=i,this.maxIter=1e3,this.bondOrders=[],this.tolerant=!1,this.mol=t,this.resBonds=e,this.atomHyd=i;for(let e=1;e<=t.numBonds;e++)this.bondOrders.push(t.bondOrder(e))}perform(){const{mol:t}=this;if(null==this.atomHyd){this.atomHyd=[];for(let e=1;e<=t.numAtoms;e++)this.atomHyd.push(t.atomHExplicit(e))}this.correctInputMask();let e=new bt(t.numAtoms);for(let i=1;i<=t.numBonds;i++)this.resBonds[i-1]&&e.addEdge(t.bondFrom(i)-1,t.bondTo(i)-1);let i=e.calculateComponentGroups();for(let t=0;t<i.length;t++)i[t].length>=2&&this.processComponent(i[t])}correctInputMask(){const{mol:e,atomHyd:i}=this,s=e.numAtoms,n=e.numBonds;let o=t.booleanArray(!1,s);for(let t=1;t<=s;t++){let s=e.atomicNumber(t),n=s==gt.ELEMENT_C?4:s==gt.ELEMENT_N||s==gt.ELEMENT_P||s==gt.ELEMENT_B?3:s==gt.ELEMENT_O||s==gt.ELEMENT_S?2:-1;n<0?o[t-1]=!0:(n+=e.atomCharge(t),i[t-1]>0&&(n-=i[t-1]),e.atomAdjCount(t)>=n&&(o[t-1]=!0))}for(let t=1;t<=n;t++)this.resBonds[t-1]||1==e.bondOrder(t)||(o[e.bondFrom(t)-1]=!0,o[e.bondTo(t)-1]=!0);this.resBonds=this.resBonds.slice(0);for(let t=0;t<n;t++)this.resBonds[t]&&(o[e.bondFrom(t+1)-1]||o[e.bondTo(t+1)-1])&&(this.bondOrders[t]=1,this.resBonds[t]=!1)}processComponent(e){const{mol:i,resBonds:s,bondOrders:n,atomHyd:o}=this;let l=e.length;if(2==l)return void(n[i.findBond(e[0]+1,e[1]+1)-1]=2);let r=t.booleanArray(!1,l);for(let t=0;t<l;t++){let s=e[t],n=s+1;r[t]=o[s]==Vt.HEXPLICIT_UNKNOWN&&"N"==i.atomElement(n)&&i.atomAdjCount(n)-i.atomCharge(n)<=2}let a=new bt(l),h=a.calculateGravity(),u=t.idxMask(e,i.numAtoms),m=0;for(let t=1;t<=i.numBonds;t++)s[t-1]&&u[i.bondFrom(t)-1]&&u[i.bondTo(t)-1]&&m++;let d=t.numberArray(0,m),c=t.numberArray(0,m),p=t.numberArray(0,m),f=t.numberArray(0,m);m=0;for(let t=1;t<=i.numBonds;t++)if(s[t-1]&&u[i.bondFrom(t)-1]&&u[i.bondTo(t)-1]){let s=e.indexOf(i.bondFrom(t)-1),n=e.indexOf(i.bondTo(t)-1);d[m]=s,c[m]=n,p[m]=h[s]+h[n],f[m]=t,a.addEdge(s,n),m++}let g=t.numberArray(0,m);g[0]=t.idxMax(p);let b=t.booleanArray(!1,m);b[g[0]]=!0;for(let t=1;t<m;t++){let e=-1;for(let i=t-1;i>=0;i--){for(let t=0;t<m;t++)b[t]||d[t]!=d[g[i]]&&d[t]!=c[g[i]]&&c[t]!=d[g[i]]&&c[t]!=c[g[i]]||(e<0||p[t]>p[e])&&(e=t);if(e>=0)break}if(e<0)throw"Graph walk failed";g[t]=e,b[e]=!0}let y=[];y.push([!0]),y.push([!1]);let x=null,A=0,v=Math.ceil(.5*m),M=0;for(;y.length>0;){let e=y[0],i=t.append(e,!1),s=t.append(e,!0);if(this.validPath(i,g,d,c,a,r)||(i=null),this.validPath(s,g,d,c,a,r)||(s=null),t.len(i)==m){let e=t.maskCount(i);e>A&&(x=i,A=e),i=null}if(t.len(s)==m){let e=t.maskCount(s);e>A&&(x=s,A=e),s=null}if(A>=v)break;if(null==i&&null==s?y.shift():null!=i&&null!=s?(y[0]=i,y.splice(1,0,s)):y[0]=null!=i?i:s,M++,M>this.maxIter){if(null!=x)break;if(this.tolerant)return;throw"Resonance localisation exceeded maximum iteration count"}}if(null==x){if(this.tolerant)return;throw"Unable to find a solution to the resonance block."}for(let t=0;t<m;t++)n[f[g[t]]-1]=x[t]?2:1}validPath(e,i,s,n,o,l){let r=o.numNodes,a=t.numberArray(0,r),h=t.numberArray(0,r);for(let t=0;t<e.length;t++){let o=s[i[t]],l=n[i[t]];e[t]?(h[o]++,h[l]++):(a[o]++,a[l]++)}for(let t=0;t<r;t++){if(h[t]>1)return!1;if(!l[t]&&o.numEdges(t)>1&&a[t]==o.numEdges(t))return!1}return!0}}const xt="xRESPATH:",At="xRESRING:",vt="xARENE:";class Mt{constructor(t){this.mol=t,this.resPaths=new Map,this.resRings=new Map,this.arenes=new Map;for(let t=1;t<=this.mol.numAtoms;t++)for(let e of this.mol.atomExtra(t))e.startsWith(xt)?this.appendResPath(t,e.substring(9).split(":")):e.startsWith(At)?this.appendResRing(t,e.substring(9).split(":")):e.startsWith(vt)&&this.appendArene(t,e.substring(7).split(":"));for(let[t,e]of this.resPaths.entries())e.atoms=this.pack(e.atoms),this.pathify(e.atoms,!1)||this.resPaths.delete(t);for(let[t,e]of this.resRings.entries())e.atoms=this.pack(e.atoms),this.pathify(e.atoms,!0)||this.resRings.delete(t);for(let[t,e]of this.arenes.entries())e.atoms=this.pack(e.atoms),e.atoms.length>1&&(e.centre=e.atoms.shift()),this.pathify(e.atoms,!1)||this.arenes.delete(t)}getPathBlocks(){return Array.from(this.resPaths.keys())}getRingBlocks(){return Array.from(this.resRings.keys())}getAreneBlocks(){return Array.from(this.arenes.keys())}getResPaths(){let e=[];for(let i of t.sorted(Array.from(this.resPaths.keys())))e.push(this.resPaths.get(i));return e}getResRings(){let e=[];for(let i of t.sorted(Array.from(this.resRings.keys())))e.push(this.resRings.get(i));return e}getArenes(){let e=[];for(let i of t.sorted(Array.from(this.arenes.keys())))e.push(this.arenes.get(i));return e}rewriteMolecule(){const t=this.mol;for(let e=1;e<=t.numAtoms;e++){let i=t.atomExtra(e),s=!1;for(let t=i.length-1;t>=0;t--)(i[t].startsWith(xt)||i[t].startsWith(At)||i[t].startsWith(vt))&&(i.splice(t),s=!0);s&&t.setAtomExtra(e,i)}for(let[e,i]of this.resPaths.entries())for(let s=0;s<i.atoms.length;s++){let n=t.atomExtra(i.atoms[s]);n.push(xt+e+":"+(s+1)),t.setAtomExtra(i.atoms[s],n)}for(let[e,i]of this.resRings.entries())for(let s=0;s<i.atoms.length;s++){let n=t.atomExtra(i.atoms[s]);n.push(At+e+":"+(s+1)),t.setAtomExtra(i.atoms[s],n)}for(let[e,i]of this.arenes.entries())for(let s=-1;s<i.atoms.length;s++){let n=s<0?i.centre:i.atoms[s],o=t.atomExtra(n);o.push(vt+e+":"+(s+2)),t.setAtomExtra(n,o)}}harmoniseNumbering(t){let e=t.getPathBlocks(),i=this.getResPaths();this.resPaths.clear();for(let t of i){let i=this.nextIdentifier(e);this.resPaths.set(i,t),e.push(i)}e=t.getRingBlocks();let s=this.getResRings();this.resRings.clear();for(let t of s){let i=this.nextIdentifier(e);this.resRings.set(i,t),e.push(i)}e=t.getAreneBlocks();let n=this.getArenes();this.arenes.clear();for(let t of n){let i=this.nextIdentifier(e);this.arenes.set(i,t),e.push(i)}}createPath(t){if(this.alreadyExists(t))return!1;let e=this.atomsAsPath(t);if(e){let t=this.nextIdentifier(Array.from(this.resPaths.keys()));return this.resPaths.set(t,e),!0}return!1}createRing(t){if(this.alreadyExists(t))return!1;let e=this.atomsAsRing(t);if(e){let t=this.nextIdentifier(Array.from(this.resRings.keys()));return this.resRings.set(t,e),!0}return!1}createArene(t){if(this.alreadyExists(t))return!1;let e=this.atomsAsArene(t);if(e){let t=this.nextIdentifier(Array.from(this.arenes.keys()));return this.arenes.set(t,e),!0}return!1}removeArtifact(t){let e=0,i=0,s=0;for(let[n,o]of this.resPaths.entries()){let l=0;for(let e of o.atoms)t.indexOf(e)>=0&&l++;l>s&&(e=1,i=n,s=l)}for(let[n,o]of this.resRings.entries()){let l=0;for(let e of o.atoms)t.indexOf(e)>=0&&l++;l>s&&(e=2,i=n,s=l)}for(let[n,o]of this.arenes.entries()){let l=t.indexOf(o.centre)>=0?1:0;for(let e of o.atoms)t.indexOf(e)>=0&&l++;l>s&&(e=3,i=n,s=l)}return 0!=e&&(1==e?this.resPaths.delete(i):2==e?this.resRings.delete(i):3==e&&this.arenes.delete(i),!0)}static removeAll(e){for(let i=1;i<=e.numAtoms;i++){let s=e.atomExtra(i),n=!1;for(let e=s.length-1;e>=0;e--)(s[e].startsWith(xt)||s[e].startsWith(At)||s[e].startsWith(vt))&&(s=t.remove(s,e),n=!0);n&&e.setAtomExtra(i,s)}}appendResPath(e,i){let s=r(i[0],0);if(s<=0)return;let n=this.resPaths.get(s);null==n&&this.resPaths.set(s,n={atoms:t.numberArray(0,this.mol.numAtoms)});let o=i.length>=2?r(i[1],0):0;n.atoms.indexOf(e)>=0||(o>=1&&o<=this.mol.numAtoms?n.atoms[o-1]=e:n.atoms.push(e))}appendResRing(e,i){let s=r(i[0],0);if(s<=0)return;let n=this.resRings.get(s);null==n&&this.resRings.set(s,n={atoms:t.numberArray(0,this.mol.numAtoms)});let o=i.length>=2?r(i[1],0):0;n.atoms.indexOf(e)>=0||(o>=1&&o<=this.mol.numAtoms?n.atoms[o-1]=e:n.atoms.push(e))}appendArene(e,i){let s=r(i[0],0);if(s<=0)return;let n=this.arenes.get(s);null==n&&this.arenes.set(s,n={centre:0,atoms:t.numberArray(0,this.mol.numAtoms)});let o=i.length>=2?r(i[1],0):0;n.atoms.indexOf(e)>=0||(o>=1&&o<=this.mol.numAtoms?n.atoms[o-1]=e:n.atoms.push(e))}pack(t){let e=[];for(let i of t)0!=i&&e.push(i);return e}pathify(e,i){let s=e.length;if(s<2)return!1;let n=bt.fromMolecule(this.mol);for(let t=0;t<this.mol.numAtoms;t++)n.setIndex(t,t+1);n=n.subgraphIndex(t.add(e,-1));let o=0;for(let t=1;t<s;t++)n.numEdges(t)<n.numEdges(o)&&(o=t);t.setTo(e,-1);for(let t=0;t<s;t++)if(e[t]=o,t==s-1){if(i&&n.getEdges(o).indexOf(e[0])<0)return!1}else{let t=s;for(let i of n.getEdges(o))e.indexOf(i)<0&&i<t&&(t=i);if(t==s)return!1;o=t}for(let t=0;t<s;t++)e[t]=n.getIndex(e[t]);return!0}alreadyExists(e){e=t.sorted(e);for(let i of this.resPaths.values())if(t.equals(e,t.sorted(i.atoms)))return!0;for(let i of this.resRings.values())if(t.equals(e,t.sorted(i.atoms)))return!0;for(let i of this.arenes.values()){let s=t.append(i.atoms,i.centre);if(t.equals(e,t.sorted(s)))return!0}return!1}atomsAsPath(t){if(t.length<2)return null;let e={atoms:t};return this.pathify(e.atoms,!1)?e:null}atomsAsRing(t){if(t.length<3)return null;let e={atoms:t};return this.pathify(e.atoms,!0)?e:null}atomsAsArene(e){const i=e.length;if(i<3)return null;let s=bt.fromMolecule(this.mol).subgraphIndex(t.add(e,-1)),n=0;if(3==i){let o=[0,0,0];for(let l=0;l<i;l++){if(2!=s.numEdges(l))return null;for(let t of s.getEdges(l))o[l]+=this.mol.bondOrder(this.mol.findBond(e[l],e[t]));n=t.idxMin(o)}}else for(let t=1;t<i;t++)s.numEdges(t)>s.numEdges(n)&&(n=t);let o={centre:e[n],atoms:t.remove(e,n)};return this.pathify(o.atoms,!1)?o:null}nextIdentifier(e){if(0==e.length)return 1;let i=t.sorted(e);for(let t=0;t<i.length-1;t++)if(i[t+1]!=i[t]+1)return i[t]+1;return i[i.length-1]+1}}var Tt,wt;!function(t){t.Molecule="molecule",t.String="string",t.Real="real",t.Integer="integer",t.Boolean="boolean",t.Extend="extend"}(Tt||(Tt={}));class Et{constructor(e){e||(e={}),e.title||(e.title=""),e.description||(e.description=""),null==e.numCols&&(e.numCols=t.len(e.colData)),null==e.numRows&&(e.numRows=t.len(e.rowData)),null==e.numExtens&&(e.numExtens=t.len(e.extData)),null==e.colData&&(e.colData=[]),null==e.rowData&&(e.rowData=[]),null==e.extData&&(e.extData=[]),this.data=e}clone(t=!0){let{numCols:e,numRows:i,colData:s,rowData:n}=this.data,o={title:this.data.title,description:this.data.description,numCols:e,numRows:t?i:0,numExtens:this.data.numExtens,colData:Y(s),rowData:t?new Array(i):[],extData:Y(this.data.extData)};if(t)for(let t=0;t<i;t++){let i=n[t],l=new Array(e);for(let t=0;t<e;t++)null!=i[t]&&"molecule"==s[t].type&&i[t]instanceof Vt?l[t]=i[t].clone():l[t]=i[t];o.rowData[t]=l}return new Et(o)}cloneMask(e,i=null,s=!0){let{numCols:n,numRows:o,colData:l,rowData:r}=this.data,a={title:this.data.title,description:this.data.description,numCols:t.maskCount(e),numRows:i?t.maskCount(i):0,numExtens:s?this.data.numExtens:0,colData:Y(t.maskGet(l,e)),rowData:[],extData:s?Y(this.data.extData):[]};if(i)for(let s=0;s<o;s++)if(i[s]){let i=r[s],n=t.maskGet(i,e);a.rowData.push(n)}const{colData:h,rowData:u}=a;for(let t=h.length-1;t>=0;t--)if("molecule"==h[t].type)for(let e=u.length-1;e>=0;e--)null!=u[e][t]&&u[e][t]instanceof Vt&&(u[e][t]=u[e][t].clone());return new Et(a)}getData(){return this.data}get numCols(){return this.data.numCols}get numRows(){return this.data.numRows}get title(){return this.data.title}set title(t){this.data.title=t}get description(){return this.data.description}set description(t){this.data.description=t}get numExtensions(){return this.data.numExtens}getExtName(t){return this.data.extData[t].name}getExtType(t){return this.data.extData[t].type}getExtData(t){return this.data.extData[t].data}setExtName(t,e){this.data.extData[t].name=e}setExtType(t,e){this.data.extData[t].type=e}setExtData(t,e){this.data.extData[t].data=e}appendExtension(t,e,i){return this.data.numExtens++,this.data.extData.push({name:t,type:e,data:i}),this.data.numExtens-1}insertExtension(t,e,i,s){this.data.numExtens++,this.data.extData.splice(t,0,{name:e,type:i,data:s})}deleteExtension(t){this.data.extData.splice(t,1),this.data.numExtens--}colName(t){return this.data.colData[t].name}colType(t){return this.data.colData[t].type}colDescr(t){return this.data.colData[t].descr}isNull(t,e){return"string"==typeof e&&(e=this.findColByName(e)),e<0?null:null==this.data.rowData[t][e]}notNull(t,e){return!this.isNull(t,e)}isBlank(t,e){if("string"==typeof e&&(e=this.findColByName(e)),this.isNull(t,e))return!0;let i=this.colType(e);return"molecule"==i?0==this.getMolecule(t,e).numAtoms:"string"==i?0==this.getString(t,e).length:"extend"==i&&0==this.getExtend(t,e).length}notBlank(t,e){return!this.isBlank(t,e)}getObject(t,e){return"string"==typeof e&&(e=this.findColByName(e)),this.data.rowData[t][e]}getMolecule(t,e){if("string"==typeof e&&(e=this.findColByName(e)),e<0)return null;let i=this.data.rowData[t][e];return null==i?null:("string"==typeof i&&(i=Vt.fromString(i),this.data.rowData[t][e]=i),i)}getMoleculeClone(t,e){let i=this.getMolecule(t,e);return null==i?null:i.clone()}getMoleculeBlank(t,e){return this.getMolecule(t,e)||new Vt}getString(t,e){if("string"==typeof e&&(e=this.findColByName(e)),e<0)return null;let i=this.data.rowData[t][e];return null==i?"":i}getInteger(t,e){return"string"==typeof e&&(e=this.findColByName(e)),e<0?null:this.data.rowData[t][e]}getReal(t,e){return"string"==typeof e&&(e=this.findColByName(e)),e<0?null:this.data.rowData[t][e]}getBoolean(t,e){return"string"==typeof e&&(e=this.findColByName(e)),e<0?null:this.data.rowData[t][e]}getExtend(t,e){return"string"==typeof e&&(e=this.findColByName(e)),e<0?null:this.data.rowData[t][e]}setToNull(t,e){"string"==typeof e&&(e=this.findColByName(e)),e<0||(this.data.rowData[t][e]=null)}setObject(t,e,i){"string"==typeof e&&(e=this.findColByName(e)),e<0||(this.data.rowData[t][e]=i)}setMolecule(t,e,i){"string"==typeof e&&(e=this.findColByName(e)),e<0||(this.data.rowData[t][e]=i?i.clone():null)}setString(t,e,i){"string"==typeof e&&(e=this.findColByName(e)),e<0||(this.data.rowData[t][e]=i)}setInteger(t,e,i){"string"==typeof e&&(e=this.findColByName(e)),e<0||(this.data.rowData[t][e]=i)}setReal(t,e,i){"string"==typeof e&&(e=this.findColByName(e)),e<0||(this.data.rowData[t][e]=i)}setBoolean(t,e,i){"string"==typeof e&&(e=this.findColByName(e)),e<0||(this.data.rowData[t][e]=i)}setExtend(t,e,i){"string"==typeof e&&(e=this.findColByName(e)),e<0||(this.data.rowData[t][e]=i)}isEqualMolecule(t,e,i){return"string"==typeof e&&(e=this.findColByName(e)),this.isNull(t,e)==(null==i)&&(null==i||0==this.getMolecule(t,e).compareTo(i))}isEqualString(t,e,i){return"string"==typeof e&&(e=this.findColByName(e)),this.isNull(t,e)==(null==i||""==i)&&(null==i||""==i||this.getString(t,e)==i)}isEqualInteger(t,e,i){return"string"==typeof e&&(e=this.findColByName(e)),this.isNull(t,e)==(null==i)&&(null==i||this.getInteger(t,e)==i)}isEqualReal(t,e,i){return"string"==typeof e&&(e=this.findColByName(e)),this.isNull(t,e)==(null==i)&&(null==i||this.getReal(t,e)==i)}isEqualBoolean(t,e,i){return"string"==typeof e&&(e=this.findColByName(e)),this.isNull(t,e)==(null==i)&&(null==i||this.getBoolean(t,e)==i)}appendColumn(t,e,i){this.data.numCols++,this.data.colData.push({name:t,type:e,descr:i});for(let t=0;t<this.data.numRows;t++)this.data.rowData[t].push(null);return this.data.numCols-1}insertColumn(t,e,i,s){this.data.numCols++,this.data.colData.splice(t,0,{name:e,type:i,descr:s});for(let e=0;e<this.data.numRows;e++)this.data.rowData[e].splice(t,0,null)}deleteColumn(t){this.data.numCols--,this.data.colData.splice(t,1);for(let e=0;e<this.data.numRows;e++)this.data.rowData[e].splice(t,1)}changeColumnName(t,e,i){this.data.colData[t].name=e,this.data.colData[t].descr=i}changeColumnType(t,e){let i=this.colType(t);if(i==e)return;let s="molecule"==i||"molecule"==e||"extend"==i||"extend"==e;for(let n=this.data.rowData.length-1;n>=0;n--){let o=this.data.rowData[n];if(null==o[t])continue;if(s){o[t]=null;continue}let l="";if("string"==i?l=o[t]:"integer"==i||"real"==i?l=o[t].toString():"boolean"==i&&(l=o[t]?"true":"false"),o[t]=null,"string"==e)o[t]=l;else if("integer"==e){let e=parseInt(l);o[t]=isFinite(e)?e:null}else if("real"==e){let e=parseFloat(l);o[t]=isFinite(e)?e:null}else"boolean"==e&&(o[t]="true"==l.toLowerCase())}this.data.colData[t].type=e}ensureColumn(t,e,i){for(let s=0;s<this.data.numCols;s++)if(this.data.colData[s].name==t)return this.data.colData[s].type!=e&&this.changeColumnType(s,e),this.data.colData[s].descr=i,s;return this.appendColumn(t,e,i)}reorderColumns(e){let i=!0;for(let t=0;t<e.length-1;t++)if(e[t]!=e[t+1]-1){i=!1;break}if(!i){this.data.colData=t.idxGet(this.data.colData,e);for(let i=0;i<this.data.numRows;i++)this.data.rowData[i]=t.idxGet(this.data.rowData[i],e)}}appendRow(){this.data.numRows++;let t=new Array;for(let e=0;e<this.data.numCols;e++)t.push(null);return this.data.rowData.push(t),this.data.numRows-1}appendRowFrom(t,e){return this.data.numRows++,this.data.rowData.push(t.data.rowData[e].slice(0)),this.data.numRows-1}insertRow(t){this.data.numRows++;let e=new Array;for(let t=0;t<this.data.numCols;t++)e.push(null);this.data.rowData.splice(t,0,e)}deleteRow(t){this.data.numRows--,this.data.rowData.splice(t,1)}deleteAllRows(){this.data.numRows=0,this.data.rowData=new Array}moveRowUp(t){let e=this.data.rowData[t];this.data.rowData[t]=this.data.rowData[t-1],this.data.rowData[t-1]=e}moveRowDown(t){let e=this.data.rowData[t];this.data.rowData[t]=this.data.rowData[t+1],this.data.rowData[t+1]=e}swapRows(e,i){t.swap(this.data.rowData,e,i)}exciseSingleRow(t){let e={title:this.data.title,description:this.data.description,numCols:this.data.numCols,numRows:1,numExtens:this.data.numExtens,colData:this.data.colData.slice(0),rowData:[this.data.rowData[t].slice(0)],extData:this.data.extData.slice(0)};return new Et(e)}colIsPrimitive(t){"string"==typeof t&&(t=this.findColByName(t));let e=this.data.colData[t].type;return"string"==e||"real"==e||"integer"==e||"boolean"==e}findColByName(t,e){for(let i=0;i<this.data.numCols;i++)if(this.data.colData[i].name==t&&(null==e||this.data.colData[i].type==e))return i;return-1}firstColOfType(t){for(let e=0;e<this.data.numCols;e++)if(this.data.colData[e].type==t)return e;return-1}copyCell(t,e,i,s,n){if(this.setToNull(t,e),i.isNull(s,n))return;let o=i.getObject(s,n);this.setObject(t,e,Et.convertType(o,i.colType(n),this.colType(e)))}static convertType(t,e,i){const s=e,n=i;if(null==t||s==n||"string"==typeof t&&""==t)return t;if("string"==n){if("integer"==s)return t.toString();if("real"==s)return t.toString();if("boolean"==s)return t?"true":"false"}else if("real"==n){if("string"==s)return function(t,e=0){if(null==t||0==t.length)return e;let i=parseFloat(t);return isNaN(i)?e:i}(t,null);if("integer"==s)return t;if("boolean"==s)return t?1:0}else if("integer"==n){if("string"==s)return r(t,null);if("real"==s)return Math.round(t);if("boolean"==s)return t?1:0}else if("boolean"==n){if("string"==s)return"true"==t.toLowerCase();if("integer"==s)return t>0;if("real"==s)return t>=.5}return null}toString(t,e){"string"==typeof e&&(e=this.findColByName(e));let i=this.data.rowData[t][e];return null==i?null:i.toString()}toInt(t,e){if(!this.colIsPrimitive(e))return null;let i=this.data.rowData[t][e];return null==i?null:parseInt(i)}toReal(t,e){if(!this.colIsPrimitive(e))return null;let i=this.data.rowData[t][e];return null==i?null:parseFloat(i)}}!function(t){t.AtomAromatic="yAROMATIC",t.BondAromatic="yAROMATIC",t.BondZeroDative="yZERO_DATIVE",t.BondZeroHydrogen="yZERO_HYDROGEN",t.AtomChiralMDLOdd="yCHIRAL_MDL_ODD",t.AtomChiralMDLEven="yCHIRAL_MDL_EVEN",t.AtomChiralMDLRacemic="yCHIRAL_MDL_RACEMIC",t.AtomExplicitValence="yMDL_EXPLICIT_VALENCE",t.AtomSgroupMultiAttach="yMDL_SGROUP_MULTIATTACH",t.AtomSgroupMultiRepeat="yMDL_SGROUP_MULTIREPEAT",t.AtomSgroupData="yMDL_SGROUP_DATA",t.AtomSCSRClass="yMDL_SCSR_CLASS",t.AtomSCSRSeqID="yMDL_SCSR_SEQID",t.AtomSCSRAttchOrd="yMDL_SCSR_ATTCHORD"}(wt||(wt={}));class Ct{static noteAromaticAtoms(e){const i=e.numAtoms;let s=t.booleanArray(!1,i);for(let t=1;t<=i;t++)s[t-1]=e.atomTransient(t).indexOf(wt.AtomAromatic)>=0;return s}static noteAromaticBonds(e){const i=e.numBonds;let s=t.booleanArray(!1,i);for(let t=1;t<=i;t++)s[t-1]=e.bondTransient(t).indexOf(wt.BondAromatic)>=0;return s}static noteZeroDativeBonds(e){const i=e.numBonds;let s=t.booleanArray(!1,i);for(let t=1;t<=i;t++)s[t-1]=e.bondTransient(t).includes(wt.BondZeroDative);return s}static noteZeroHydrogenBonds(e){const i=e.numBonds;let s=t.booleanArray(!1,i);for(let t=1;t<=i;t++)s[t-1]=e.bondTransient(t).includes(wt.BondZeroHydrogen);return s}static markExplicitValence(t,e,i){let s=t.atomTransient(e).filter((t=>!t.startsWith(wt.AtomExplicitValence+":")));s.push(`${wt.AtomExplicitValence}:${i}`),t.setAtomTransient(e,s)}static noteExplicitValence(t,e){let i=t.atomTransient(e);for(let t of i)if(t.startsWith(wt.AtomExplicitValence+":"))return parseInt(t.substring(wt.AtomExplicitValence.length+1));return null}static markSgroupMultiAttach(e,i,s,n={}){let o=0;for(let t=1;t<=e.numAtoms;t++)for(let i of e.atomTransient(t))if(i.startsWith(wt.AtomSgroupMultiAttach+":")){let t=i.substring(wt.AtomSgroupMultiAttach.length+1),e=(t.indexOf(","),t.split(",")),s=parseInt(e[0]);if(!(s>0))continue;o=Math.max(o,s)}let l=`${wt.AtomSgroupMultiAttach}:${o+1},${i}`;for(let[t,e]of Object.entries(n))l+=","+t+"="+e;for(let i of s)e.setAtomTransient(i,t.append(e.atomTransient(i),l))}static hasAnySgroupMultiAttach(t){for(let e=1;e<=t.numAtoms;e++)if(t.atomTransient(e).some((t=>t.startsWith(wt.AtomSgroupMultiAttach+":"))))return!0;return!1}static noteAllSgroupMultiAttach(t){let e={};for(let i=1;i<=t.numAtoms;i++)for(let s of t.atomTransient(i))if(s.startsWith(wt.AtomSgroupMultiAttach+":")){let t=s.substring(wt.AtomSgroupMultiAttach.length+1).split(",");if(t.length<2)continue;let n=parseInt(t[0]),o=t[1];if(!(n>0&&o))continue;let l={};for(let e=2;e<t.length;e++){let i=t[e].indexOf("=");i<0||(l[t[e].substring(0,i)]=t[e].substring(i+1))}let r=e[n];r?r.atoms.push(i):e[n]={name:o,atoms:[i],keyval:l}}return Object.values(e)}static markSgroupMultiRepeat(e,i,s){let n=0;for(let t=1;t<=e.numAtoms;t++)for(let i of e.atomTransient(t))if(i.startsWith(wt.AtomSgroupMultiRepeat+":")){let t=i.substring(wt.AtomSgroupMultiRepeat.length+1),e=t.indexOf(",");if(e<=0)continue;let s=parseInt(t.substring(0,e));if(s<=0)continue;n=Math.max(n,s)}let o=s.length/i,l=`${wt.AtomSgroupMultiRepeat}:${n+1},${i},${o},`;for(let i=0;i<s.length;i++)e.setAtomTransient(s[i],t.append(e.atomTransient(s[i]),l+(i+1)))}static hasAnySgroupMultiRepeat(t){for(let e=1;e<=t.numAtoms;e++)if(t.atomTransient(e).some((t=>t.startsWith(wt.AtomSgroupMultiRepeat+":"))))return!0;return!1}static noteAllSgroupMultiRepeat(e){let i={};for(let s=1;s<=e.numAtoms;s++)for(let n of e.atomTransient(s))if(n.startsWith(wt.AtomSgroupMultiRepeat+":")){let e=n.substring(wt.AtomSgroupMultiRepeat.length+1).split(",");if(e.length<4)continue;let o=parseInt(e[0]),l=parseInt(e[1]),r=parseInt(e[2]),a=parseInt(e[3]);if(!(o>0)||l<2||r<1||a<1||a>l*r)continue;let h=i[o];if(null==h)i[o]=h={mult:l,unit:r,atoms:t.numberArray(0,l*r)};else if(h.mult!=l||h.unit!=r)continue;h.atoms[a-1]=s}return Object.values(i)}static markSgroupData(e,i,s,n,o,l){var r;let a=0;for(let t=1;t<=e.numAtoms;t++)for(let i of e.atomTransient(t))if(i.startsWith(wt.AtomSgroupData+":")){let t=i.substring(wt.AtomSgroupData.length+1),e=t.indexOf(",");if(e<=0)continue;let s=parseInt(t.substring(0,e));if(s<=0)continue;a=Math.max(a,s)}let h=[(a+1).toString(),i,s,n,o];for(let t=1;t<h.length;t++)h[t]=(null!==(r=h[t])&&void 0!==r?r:"").replace(/\,/g,"@@");let u=wt.AtomSgroupData+":"+h.join(",");for(let i=0;i<l.length;i++)e.setAtomTransient(l[i],t.append(e.atomTransient(l[i]),u))}static hasAnySgroupData(t){for(let e=1;e<=t.numAtoms;e++)if(t.atomTransient(e).some((t=>t.startsWith(wt.AtomSgroupData+":"))))return!0;return!1}static noteAllSgroupData(t){let e={};for(let i=1;i<=t.numAtoms;i++)for(let s of t.atomTransient(i))if(s.startsWith(wt.AtomSgroupData+":")){let t=s.substring(wt.AtomSgroupData.length+1).split(",");if(t.length<5)continue;let n=parseInt(t[0]);for(let e=1;e<5;e++)t[e]=t[e].replace(/\@\@/g,",");if(!(n>0))continue;let o=e[n];o?o.atoms.push(i):e[n]={name:t[1],value:t[2],unit:t[3],query:t[4],atoms:[i]}}return Object.values(e)}}const St="xPOLYMER:";var kt,Bt,Nt;!function(t){t.HeadToTail="ht",t.HeadToHead="hh",t.Random="rnd"}(kt||(kt={}));class qt{constructor(t){this.atoms=t,this.connect=null,this.bondConn=null,this.atomName=new Map,this.bondIncl=new Map,this.bondExcl=new Map}clone(){let t=new qt(this.atoms.slice(0));t.connect=this.connect,this.bondConn&&(t.bondConn=this.bondConn.slice(0));for(let[e,i]of this.atomName.entries())t.atomName.set(e,i.slice(0));for(let[e,i]of this.bondIncl.entries())t.bondIncl.set(e,i.slice(0));for(let[e,i]of this.bondExcl.entries())t.bondExcl.set(e,i.slice(0));return t}}class Ot{constructor(e){this.mol=e,this.units=new Map;let i=new Map;for(let t=1;t<=e.numAtoms;t++){let s=e.atomExtra(t);for(let e of s)if(e.startsWith(St)){let s=e.substring(9).split(":"),n=parseInt(s[0]);if(n>0){let e=i.get(n);e?e.push(t):e=[t],i.set(n,e)}}}for(let e of t.sorted(Array.from(i.keys())))this.appendBlock(e,i.get(e))}getIDList(){return t.sorted(Array.from(this.units.keys()))}getUnit(t){return this.units.get(t)}getUnits(){return Array.from(this.units.values())}rewriteMolecule(){this.purgeExtraFields();for(let e of t.sorted(Array.from(this.units.keys())))this.writeUnit(e,this.units.get(e))}harmoniseNumbering(t){let e=t.getIDList();for(let t of this.getIDList())if(e.includes(t)){let i=this.units.get(t);this.units.delete(t),t=this.nextIdentifier(e),this.units.set(t,i),e.push(t)}}removeUnit(e){let i=this.units.get(e);if(null==i)return;this.units.delete(e);let s=St+e+":";for(let e of i.atoms){let i=this.mol.atomExtra(e);for(let e=i.length-1;e>=0;e--)i[e].startsWith(s)&&(i=t.remove(i,e));this.mol.setAtomExtra(e,i)}for(let e=1;e<=this.mol.numBonds;e++){let i=this.mol.bondExtra(e);if(!t.isBlank(i)){for(let e=i.length-1;e>=0;e--)i[e].startsWith(s)&&(i=t.remove(i,e));this.mol.setBondExtra(e,i)}}}removeAll(){this.units.clear(),this.purgeExtraFields()}createUnit(t){let e=this.nextIdentifier();return this.units.set(e,t.clone()),this.writeUnit(e,t),e}static hasPolymerExtensions(t){for(let e=1;e<=t.numAtoms;e++){let i=t.atomExtra(e);if(null!=i)for(let t of i)if(t.startsWith(St))return!0}return!1}static getPolymerExtensions(e,i){let s=e.atomExtra(i),n=null;if(null==s)return null;for(let e of s)e.startsWith(St)&&(n=t.append(n,e));return n}static removePolymerExtensions(e,i){let s=e.atomExtra(i);if(null==s)return;let n=!1;for(let e=s.length-1;e>=0;e--)s[e].startsWith(St)&&(s=t.remove(s,e),n=!0);n&&e.setAtomExtra(i,s)}appendBlock(e,i){const{mol:s}=this;let n=0,o=new qt(i);for(let t of i)for(let l of s.atomExtra(t))if(l.startsWith(St)){let r=l.substring(9).split(":");if(r.length<2||parseInt(r[0])!=e)continue;n=parseInt(r[1]);for(let e=2;e<r.length;e++)if(r[e]==kt.HeadToTail)o.connect=kt.HeadToTail;else if(r[e]==kt.HeadToHead)o.connect=kt.HeadToHead;else if(r[e]==kt.Random)o.connect=kt.Random;else if(r[e].startsWith("n")){let n=!1;for(let e of s.atomAdjList(t))if(!i.includes(e)){n=!0;break}if(n){let i=r[e].substring(1).split(",");o.atomName.set(t,i.map((t=>parseInt(t))))}}}if(n<0)return;for(let t=1;t<=s.numBonds;t++){let e=i.indexOf(s.bondFrom(t))>=0,o=i.indexOf(s.bondTo(t))>=0;(e&&!o||!e&&o)&&n--}if(0!=n)return;let l=null,r=null;for(let i=1;i<=s.numBonds;i++)for(let n of s.bondExtra(i))if(n.startsWith(St)){let s=n.substring(9).split(":");if(s.length<2||parseInt(s[0])!=e)continue;for(let e=1;e<s.length;e++)if(s[e].startsWith("i")){let t=s[e].substring(1).split(",");o.bondIncl.set(i,t.map((t=>parseInt(t))))}else if(s[e].startsWith("e")){let t=s[e].substring(1).split(",");o.bondExcl.set(i,t.map((t=>parseInt(t))))}else{let n=parseInt(s[e]);n>0&&(l=t.append(l,i),r=t.append(r,n))}}if(null!=l){if(l.length%2==1)return;o.bondConn=t.idxGet(l,t.idxSort(r))}this.units.set(e,o)}formatBlockAtom(e,i,s){let n=0;for(let t=1;t<=this.mol.numBonds;t++){let e=i.atoms.indexOf(this.mol.bondFrom(t))>=0,s=i.atoms.indexOf(this.mol.bondTo(t))>=0;(e&&!s||!e&&s)&&n++}let o=St+e+":"+n;null!=i.connect&&(o+=":"+i.connect);let l=i.atomName.get(s);return t.notBlank(l)&&(o+=":n"+l.join(",")),o}formatBlockBond(e,i,s){let n=i.atoms.includes(this.mol.bondFrom(s)),o=i.atoms.includes(this.mol.bondTo(s));if(!(n&&!o||o&&!n))return null;let l=i.bondConn?i.bondConn.indexOf(s):-1,r=i.bondIncl.get(s),a=i.bondExcl.get(s);if(l<0&&t.isBlank(r)&&t.isBlank(a))return null;let h=St+e;return l>=0&&(h+=":"+(l+1)),t.notBlank(r)&&(h+=":i"+r.join(",")),t.notBlank(a)&&(h+=":e"+a.join(",")),h}purgeExtraFields(){for(let e=1;e<=this.mol.numAtoms;e++){let i=this.mol.atomExtra(e),s=!1;for(let e=i.length-1;e>=0;e--)i[e].startsWith(St)&&(i=t.remove(i,e),s=!0);s&&this.mol.setAtomExtra(e,i)}for(let e=1;e<=this.mol.numBonds;e++){let i=this.mol.bondExtra(e),s=!1;for(let e=i.length-1;e>=0;e--)i[e].startsWith(St)&&(i=t.remove(i,e),s=!0);s&&this.mol.setBondExtra(e,i)}}writeUnit(e,i){const{mol:s}=this;for(let n of i.atoms){let o=this.formatBlockAtom(e,i,n);s.setAtomExtra(n,t.append(s.atomExtra(n),o))}for(let n=1;n<=s.numBonds;n++){let o=this.formatBlockBond(e,i,n);o&&s.setBondExtra(n,t.append(s.bondExtra(n),o))}}nextIdentifier(t){if(t||(t=this.getIDList()),0==t.length)return 1;for(let e=0;e<t.length-1;e++)if(t[e+1]!=t[e]+1)return t[e]+1;return t[t.length-1]+1}}!function(t){t.Charges="qC:",t.Aromatic="qA:",t.Unsaturated="qU:",t.Elements="qE:",t.ElementsNot="qE!",t.RingSizes="qR:",t.RingSizesNot="qR!",t.RingBlock="qB:",t.NumRings="qN:",t.RingBonds="qG:",t.Adjacency="qJ:",t.BondSums="qO:",t.Valences="qV:",t.Hydrogens="qH:",t.Isotopes="qI:",t.SubFrags="qX:",t.SubFragsNot="qX!"}(Bt||(Bt={})),function(t){t.RingSizes="qR:",t.RingSizesNot="qR!",t.RingBlock="qB:",t.NumRings="qN:",t.Orders="qO:"}(Nt||(Nt={}));class It{static hasAnyQueryAtom(t,e){let i=t.atomExtra(e);for(let t=i.length-1;t>=0;t--)if(i[t].startsWith("q"))return!0;return!1}static hasAnyQueryBond(t,e){let i=t.bondExtra(e);for(let t=i.length-1;t>=0;t--)if(i[t].startsWith("q"))return!0;return!1}static hasQueryAtom(t,e,i){let s=t.atomExtra(e);for(let t=s.length-1;t>=0;t--)if(s[t].startsWith(i))return!0;return!1}static hasQueryBond(t,e,i){let s=t.bondExtra(e);for(let t=s.length-1;t>=0;t--)if(s[t].startsWith(i))return!0;return!1}static deleteQueryAtom(t,e,i){let s=t.atomExtra(e),n=!1;for(let t=s.length-1;t>=0;t--)s[t].startsWith(i)&&(s.splice(t,1),n=!0);n&&t.setAtomExtra(e,s)}static deleteQueryBond(t,e,i){let s=t.bondExtra(e),n=!1;for(let t=s.length-1;t>=0;t--)s[t].startsWith(i)&&(s.splice(t,1),n=!0);n&&t.setBondExtra(e,s)}static deleteQueryAtomAll(t,e){t.setAtomExtra(e,t.atomExtra(e).filter((t=>!t.startsWith("q"))))}static deleteQueryBondAll(t,e){t.setBondExtra(e,t.bondExtra(e).filter((t=>!t.startsWith("q"))))}static queryAtomString(t,e,i){let s=t.atomExtra(e);for(let t=s.length-1;t>=0;t--)if(s[t].startsWith(i))return s[t].substring(i.length);return null}static queryAtomStringList(e,i,s){let n=e.atomExtra(i),o=null;if(null!=n)for(let e of n)e.startsWith(s)&&(o=t.append(o,e.substring(s.length)));return o}static queryBondString(t,e,i){let s=t.bondExtra(e);for(let t=s.length-1;t>=0;t--)if(s[t].startsWith(i))return s[t].substring(i.length);return null}static setQueryAtom(t,e,i,s){if(!s)return void this.deleteQueryAtom(t,e,i);let n=i+s,o=t.atomExtra(e);for(let t=o.length-1;t>=0;t--)o[t].startsWith(i)&&(null!=n?(o[t]=n,n=null):o.splice(t,1));null!=n&&o.push(n),t.setAtomExtra(e,o)}static setQueryAtomList(e,i,s,n){if(t.isBlank(n))return void this.deleteQueryAtom(e,i,s);let o=e.atomExtra(i);for(let t=o.length-1;t>=0;t--)o[t].startsWith(s)&&o.splice(t,1);for(let t of n)o.push(s+t);e.setAtomExtra(i,o)}static setQueryBond(t,e,i,s){if(!s)return void this.deleteQueryBond(t,e,i);let n=i+s,o=t.bondExtra(e);for(let t=o.length-1;t>=0;t--)o[t].startsWith(i)&&(null!=n?(o[t]=n,n=null):o.splice(t,1));null!=n&&o.push(n),t.setBondExtra(e,o)}static queryAtomCharges(t,e){return this.parseIntegers(this.queryAtomString(t,e,Bt.Charges))}static queryAtomAromatic(t,e){return this.parseBoolean(this.queryAtomString(t,e,Bt.Aromatic))}static queryAtomUnsaturated(t,e){return this.parseBoolean(this.queryAtomString(t,e,Bt.Unsaturated))}static queryAtomElements(t,e){return this.parseStrings(this.queryAtomString(t,e,Bt.Elements))}static queryAtomElementsNot(t,e){return this.parseStrings(this.queryAtomString(t,e,Bt.ElementsNot))}static queryAtomRingSizes(t,e){return this.parseIntegers(this.queryAtomString(t,e,Bt.RingSizes))}static queryAtomRingSizesNot(t,e){return this.parseIntegers(this.queryAtomString(t,e,Bt.RingSizesNot))}static queryAtomRingBlock(t,e){return this.parseBoolean(this.queryAtomString(t,e,Bt.RingBlock))}static queryAtomNumRings(t,e){return this.parseIntegers(this.queryAtomString(t,e,Bt.NumRings))}static queryAtomRingBonds(t,e){return this.parseIntegers(this.queryAtomString(t,e,Bt.RingBonds))}static queryAtomAdjacency(t,e){return this.parseIntegers(this.queryAtomString(t,e,Bt.Adjacency))}static queryAtomBondSums(t,e){return this.parseIntegers(this.queryAtomString(t,e,Bt.BondSums))}static queryAtomValences(t,e){return this.parseIntegers(this.queryAtomString(t,e,Bt.Valences))}static queryAtomHydrogens(t,e){return this.parseIntegers(this.queryAtomString(t,e,Bt.Hydrogens))}static queryAtomIsotope(t,e){return this.parseIntegers(this.queryAtomString(t,e,Bt.Isotopes))}static queryAtomSubFrags(t,e){return this.parseMolecules(this.queryAtomStringList(t,e,Bt.SubFrags))}static queryAtomSubFragsNot(t,e){return this.parseMolecules(this.queryAtomStringList(t,e,Bt.SubFragsNot))}static queryBondRingSizes(t,e){return this.parseIntegers(this.queryBondString(t,e,Nt.RingSizes))}static queryBondRingSizesNot(t,e){return this.parseIntegers(this.queryBondString(t,e,Nt.RingSizesNot))}static queryBondRingBlock(t,e){return this.parseBoolean(this.queryBondString(t,e,Nt.RingBlock))}static queryBondNumRings(t,e){return this.parseIntegers(this.queryBondString(t,e,Nt.NumRings))}static queryBondOrders(t,e){return this.parseIntegers(this.queryBondString(t,e,Nt.Orders))}static setQueryAtomCharges(t,e,i){this.setQueryAtom(t,e,Bt.Charges,this.formatIntegers(i))}static setQueryAtomAromatic(t,e,i){this.setQueryAtom(t,e,Bt.Aromatic,this.formatBoolean(i))}static setQueryAtomUnsaturated(t,e,i){this.setQueryAtom(t,e,Bt.Unsaturated,this.formatBoolean(i))}static setQueryAtomElements(t,e,i){this.setQueryAtom(t,e,Bt.Elements,this.formatStrings(i))}static setQueryAtomElementsNot(t,e,i){this.setQueryAtom(t,e,Bt.ElementsNot,this.formatStrings(i))}static setQueryAtomRingSizes(t,e,i){this.setQueryAtom(t,e,Bt.RingSizes,this.formatIntegers(i))}static setQueryAtomRingSizesNot(t,e,i){this.setQueryAtom(t,e,Bt.RingSizesNot,this.formatIntegers(i))}static setQueryAtomRingBlock(t,e,i){this.setQueryAtom(t,e,Bt.RingBlock,this.formatBoolean(i))}static setQueryAtomNumRings(t,e,i){this.setQueryAtom(t,e,Bt.NumRings,this.formatIntegers(i))}static setQueryAtomRingBonds(t,e,i){this.setQueryAtom(t,e,Bt.RingBonds,this.formatIntegers(i))}static setQueryAtomAdjacency(t,e,i){this.setQueryAtom(t,e,Bt.Adjacency,this.formatIntegers(i))}static setQueryAtomBondSums(t,e,i){this.setQueryAtom(t,e,Bt.BondSums,this.formatIntegers(i))}static setQueryAtomValences(t,e,i){this.setQueryAtom(t,e,Bt.Valences,this.formatIntegers(i))}static setQueryAtomHydrogens(t,e,i){this.setQueryAtom(t,e,Bt.Hydrogens,this.formatIntegers(i))}static setQueryAtomIsotope(t,e,i){this.setQueryAtom(t,e,Bt.Isotopes,this.formatIntegers(i))}static setQueryAtomSubFrags(t,e,i){this.setQueryAtomList(t,e,Bt.SubFrags,this.formatMolecules(i))}static setQueryAtomSubFragsNot(t,e,i){this.setQueryAtomList(t,e,Bt.SubFragsNot,this.formatMolecules(i))}static setQueryBondRingSizes(t,e,i){this.setQueryBond(t,e,Nt.RingSizes,this.formatIntegers(i))}static setQueryBondRingSizesNot(t,e,i){this.setQueryBond(t,e,Nt.RingSizesNot,this.formatIntegers(i))}static setQueryBondRingBlock(t,e,i){this.setQueryBond(t,e,Nt.RingBlock,this.formatBoolean(i))}static setQueryBondNumRings(t,e,i){this.setQueryBond(t,e,Nt.NumRings,this.formatIntegers(i))}static setQueryBondOrders(t,e,i){this.setQueryBond(t,e,Nt.Orders,this.formatIntegers(i))}static parseIntegers(t){if(!t)return null;let e=t.split(","),i=new Array(e.length);for(let t=0;t<e.length;t++)i[t]=parseInt(e[t]);return i}static parseStrings(t){return t?t.split(","):null}static parseBoolean(t){return t?"yes"==t:null}static parseMolecules(t){if(!t)return null;let e=[];for(let i of t){let t=Vt.fromString(i);Kt.notBlank(t)&&e.push(t)}return e}static formatIntegers(e){if(t.isBlank(e))return null;let i="";for(let t=0;t<e.length;t++)t>0&&(i+=","),i+=e[t];return i}static formatStrings(e){if(t.isBlank(e))return null;let i="";for(let t=0;t<e.length;t++)t>0&&(i+=","),i+=e[t];return i}static formatBoolean(t){return t?"yes":"no"}static formatMolecules(e){if(t.isBlank(e))return null;let i=[];for(let t of e)Kt.notBlank(t)&&i.push(t.toString());return i}}const Lt="xCHIRAC:",Dt="xCHIREL:";class Rt{static hasStereoGroups(t){for(let e=1;e<=t.numAtoms;e++){let i=t.atomExtra(e);if(null!=i)for(let t of i)if(t.startsWith(Lt)||t.startsWith(Dt))return!0}return!1}constructor(e){this.mol=e,this.chiRac=new Map,this.chiRel=new Map,this.mol=e;for(let i=1;i<=e.numAtoms;i++){let s=e.atomExtra(i);if(null!=s)for(let e of s)if(e.startsWith(Lt)){let s=parseInt(e.substring(8));s>0&&this.chiRac.set(s,t.append(this.chiRac.get(s),i))}else if(e.startsWith(Dt)){let s=parseInt(e.substring(8));s>0&&this.chiRel.set(s,t.append(this.chiRel.get(s),i))}}for(let[t,e]of this.chiRac.entries()){for(let t=e.length-1;t>=0;t--)this.atomHasWedge(e[t])||e.splice(t,1);e.length>0?this.chiRac.set(t,e):this.chiRac.delete(t)}for(let[t,e]of this.chiRel.entries()){for(let t=e.length-1;t>=0;t--)this.atomHasWedge(e[t])||e.splice(t,1);e.length>0?this.chiRel.set(t,e):this.chiRel.delete(t)}}getRacemicGroups(){return Array.from(this.chiRac.keys())}getRelativeGroups(){return Array.from(this.chiRel.keys())}getRacemicAtoms(){return Array.from(this.chiRac.values())}getRelativeAtoms(){return Array.from(this.chiRel.values())}getRacemicGroupAtoms(t){return this.chiRac.get(t)}getRelativeGroupAtoms(t){return this.chiRel.get(t)}rewriteMolecule(){for(let t=1;t<=this.mol.numAtoms;t++){let e=this.mol.atomExtra(t),i=!1;for(let t=e.length-1;t>=0;t--)(e[t].startsWith(Lt)||e[t].startsWith(Dt))&&(e.splice(t,1),i=!0);i&&this.mol.setAtomExtra(t,e)}for(let[t,e]of this.chiRac.entries())for(let i of e)this.mol.setAtomExtra(i,[...this.mol.atomExtra(i),Lt+t]);for(let[t,e]of this.chiRel.entries())for(let i of e)this.mol.setAtomExtra(i,[...this.mol.atomExtra(i),Dt+t])}harmoniseNumbering(t){let e=t.getRacemicGroups(),i=this.getRacemicAtoms();this.chiRac.clear();for(let t of i){let i=this.nextIdentifier(e);this.chiRac.set(i,t),e.push(i)}e=t.getRelativeGroups(),i=this.getRelativeAtoms(),this.chiRel.clear();for(let t of i){let i=this.nextIdentifier(e);this.chiRel.set(i,t),e.push(i)}}createRacemic(t){let e=this.nextIdentifier(this.getRacemicGroups());return this.chiRac.set(e,t),e}createRelative(t){let e=this.nextIdentifier(this.getRelativeGroups());return this.chiRel.set(e,t),e}removeRacemic(t){this.chiRac.delete(t)}removeRelative(t){this.chiRel.delete(t)}static removeAll(t){for(let e=1;e<=t.numAtoms;e++){let i=t.atomExtra(e),s=!1;for(let t=i.length-1;t>=0;t--)(i[t].startsWith(Lt)||i[t].startsWith(Dt))&&(i.splice(t,1),s=!0);s&&t.setAtomExtra(e,i)}}atomHasWedge(t){if(this.mol.is3D())return!0;let e=!1;for(let i of this.mol.atomAdjBonds(t)){let s=this.mol.bondType(i);if(s==Vt.BONDTYPE_UNKNOWN)return!1;this.mol.bondFrom(i)==t&&(s!=Vt.BONDTYPE_INCLINED&&s!=Vt.BONDTYPE_DECLINED||(e=!0))}return e}nextIdentifier(e){if(0==e.length)return 1;let i=t.sorted(e);for(let t=0;t<i.length-1;t++)if(i[t+1]!=i[t]+1)return i[t]+1;return i[i.length-1]+1}}const Pt={H:[1],B:[3],C:[4],Si:[4],N:[3],P:[3,5],As:[3,5],O:[2],S:[2,4,6],Se:[2,4,6],Te:[2,4,6],F:[1],Cl:[1,3,5,7],Br:[1],I:[1,3,5,7],At:[1,3,5,7]};class zt{constructor(t){this.parseHeader=!0,this.parseExtended=!0,this.allowV3000=!0,this.considerRescale=!0,this.keepAromatic=!1,this.keepParity=!1,this.keepQuery=!0,this.mol=null,this.molName="",this.overallStereoAbsolute=!0,this.resBonds=null,this.groupAttachAny=new Map,this.groupAttachAll=new Map,this.groupStereoAbsolute=[],this.groupStereoRacemic=[],this.groupStereoRelative=[],this.groupLinkNodes=[],this.groupMixtures=[],this.scsrTemplates=null,this.pos=0,this.lines=t.split(/\r?\n/)}parse(){return this.parseHeader&&(this.molName=this.lines[0],this.pos=3),this.parseCTAB(),this.mol}nextLine(){if(this.pos>=this.lines.length)throw"MDL Molfile parser: premature end, at line "+(this.pos+1);return this.lines[this.pos++]}parseCTAB(){this.mol=new Vt,this.mol.keepTransient=!0;let e=this.nextLine(),i=e.length>=39?e.substring(34,39):"";if(this.allowV3000&&"V3000"==i)return this.parseV3000(),void(this.mol.keepTransient=!1);if("V2000"!=i)throw"Invalid MDL MOL: no Vx000 tag.";let s=parseInt(e.substring(0,3).trim()),n=parseInt(e.substring(3,6).trim());e.length>=15&&(this.overallStereoAbsolute=1==parseInt(e.substring(12,15).trim()));for(let i=0;i<s;i++){if(e=this.nextLine(),e.length<34)throw"Invalid MDL MOL: atom line"+(i+1);let s=parseFloat(e.substring(0,10).trim()),n=parseFloat(e.substring(10,20).trim()),o=parseFloat(e.substring(20,30).trim()),l=e.substring(31,34).trim(),r=e.length<39?0:parseInt(e.substring(36,39).trim()),a=0,h=e.length<42?0:parseInt(e.substring(39,42).trim()),u=e.length<45?0:parseInt(e.substring(42,45).trim()),m=e.length<51?0:parseInt(e.substring(48,51).trim()),d=e.length<63?0:parseInt(e.substring(60,63).trim());r>=1&&r<=3?r=4-r:4==r?(r=0,a=2):r=r>=5&&r<=7?4-r:0;let c=this.mol.addAtom(l,s,n,r,a);if(0!=o&&(this.mol.setAtomZ(c,o),this.mol.setIs3D(!0)),this.mol.setAtomMapNum(c,d),u>0&&It.setQueryAtomHydrogens(this.mol,c,[u-1]),h>0&&this.keepParity){let e=this.mol.atomTransient(c);1==h?this.mol.setAtomTransient(c,t.append(e,wt.AtomChiralMDLOdd)):2==h?this.mol.setAtomTransient(c,t.append(e,wt.AtomChiralMDLEven)):3==h&&this.mol.setAtomTransient(c,t.append(e,wt.AtomChiralMDLRacemic))}0!=m&&Ct.markExplicitValence(this.mol,i+1,m>14?0:m)}for(let i=0;i<n;i++){if(e=this.nextLine(),e.length>=9&&e.length<12&&(e=e.substring(0,9)+"  0"),e.length<12)throw"Invalid MDL MOL: bond line"+(i+1);let o=parseInt(e.substring(0,3).trim()),l=parseInt(e.substring(3,6).trim()),r=parseInt(e.substring(6,9).trim()),a=parseInt(e.substring(9,12).trim());if(o==l||o<1||o>s||l<1||l>s)throw"Invalid MDL MOL: bond line"+(i+1);let h=r>=1&&r<=3?r:8==r||9==r||10==r?0:1,u=Vt.BONDTYPE_NORMAL;1==a?u=Vt.BONDTYPE_INCLINED:6==a?u=Vt.BONDTYPE_DECLINED:3!=a&&4!=a||(u=Vt.BONDTYPE_UNKNOWN);let m=this.mol.addBond(o,l,h,u);9==r&&this.mol.appendBondTransient(m,wt.BondZeroDative),9==r&&this.mol.appendBondTransient(m,wt.BondZeroHydrogen),this.keepQuery?4==r?It.setQueryBondOrders(this.mol,m,[-1]):5==r?It.setQueryBondOrders(this.mol,m,[1,2]):6==r?It.setQueryBondOrders(this.mol,m,[-1,1]):7==r?It.setQueryBondOrders(this.mol,m,[-1,2]):8==r&&It.setQueryBondOrders(this.mol,m,[-1,0,1,2,3]):4==r&&(this.keepAromatic?this.mol.setBondTransient(m,t.append(this.mol.bondTransient(m),wt.BondAromatic)):(null==this.resBonds&&(this.resBonds=t.booleanArray(!1,n)),this.resBonds[i]=!0))}let o=new Map,l=new Map,r=new Map,a=new Map,h=new Map;for(;e=this.nextLine(),!e.startsWith("M  END");){let i=0;if(e.startsWith("M  CHG"))i=1;else if(e.startsWith("M  RAD"))i=2;else if(e.startsWith("M  ISO"))i=3;else if(e.startsWith("M  RGP"))i=4;else if(this.parseExtended&&e.startsWith("M  HYD"))i=5;else if(this.parseExtended&&e.startsWith("M  ZCH"))i=6;else if(this.parseExtended&&e.startsWith("M  ZBO"))i=7;else if(this.parseExtended&&e.startsWith("M  ZPA"))i=8;else if(this.parseExtended&&e.startsWith("M  ZRI"))i=9;else if(this.parseExtended&&e.startsWith("M  ZAR"))i=10;else if(this.parseExtended&&e.startsWith("M  RBC"))i=11;else if(this.parseExtended&&e.startsWith("M  SUB"))i=12;else if(this.parseExtended&&e.startsWith("M  UNS"))i=13;else if(e.startsWith("A  ")&&e.length>=6){let t=parseInt(e.substring(3,6).trim());if(t>=1&&t<=this.mol.numAtoms){if(e=this.nextLine(),null==e)break;this.mol.setAtomElement(t,e);continue}}else if(e.startsWith("M  STY")){let t=parseInt(e.substring(6,9).trim());for(let i=0;i<t;i++){let t=parseInt(e.substring(9+8*i,13+8*i).trim()),s=e.substring(14+8*i,17+8*i);"SUP"==s?a.set(t,{atoms:[],name:null}):"MIX"==s||"FOR"==s?h.set(t,{index:t,parent:0,atoms:[],type:s}):"SRU"!=s&&"COP"!=s&&"MUL"!=s&&"DAT"!=s||a.set(t,{atoms:[],name:null,bracketType:s})}}else if(e.startsWith("M  SPL")){let t=parseInt(e.substring(6,9).trim());for(let i=0;i<t;i++){let t=parseInt(e.substring(9+8*i,13+8*i).trim()),s=parseInt(e.substring(13+8*i,17+8*i).trim()),n=h.get(t);null!=n&&(n.parent=s)}}else if(e.startsWith("M  SAL")){let i=parseInt(e.substring(6,10).trim()),s=a.get(i);if(null!=s){let i=parseInt(e.substring(10,13).trim()),n=t.numberArray(0,i);for(let t=0;t<i;t++)n[t]=parseInt(e.substring(13+4*t,17+4*t).trim());s.atoms=t.concat(s.atoms,n)}let n=h.get(i);if(null!=n){let i=parseInt(e.substring(10,13).trim()),s=t.numberArray(0,i);for(let t=0;t<i;t++)s[t]=parseInt(e.substring(13+4*t,17+4*t).trim());n.atoms=t.concat(n.atoms,s)}}else if(e.startsWith("M  SBL")){let i=parseInt(e.substring(6,10).trim()),s=a.get(i);if(null!=s){let i=parseInt(e.substring(10,13).trim()),n=t.numberArray(0,i);for(let t=0;t<i;t++)n[t]=parseInt(e.substring(13+4*t,17+4*t).trim());s.bonds=t.concat(s.bonds,n)}}else if(e.startsWith("M  SMT")){let t=parseInt(e.substring(6,10).trim()),i=a.get(t);null!=i&&(i.name=e.substring(11).trim())}else if(e.startsWith("M  SDT")){let t=parseInt(e.substring(6,10).trim()),i=a.get(t);i&&(i.name=e.substring(11,41).trim(),i.unit=e.substring(43,63).trim(),i.query=e.substring(63).trim())}else if(e.startsWith("M  SED")){let t=parseInt(e.substring(6,10).trim()),i=a.get(t);i&&(i.value=e.substring(11).trim())}else if(e.startsWith("M  SCN")){let t=parseInt(e.substring(6,9).trim());for(let i=0;i<t;i++){let t=parseInt(e.substring(9+8*i,13+8*i).trim()),s=e.substring(14+8*i,17+8*i),n=a.get(t);null!=n&&(n.connectType=s.trim())}}else if(e.startsWith("M  CRS")){let i=parseInt(e.substring(6,10).trim()),s=a.get(i);if(null!=s){let i=parseInt(e.substring(10,13).trim());s.bondConn=t.numberArray(0,i);for(let t=0;t<i;t++)s.bondConn[t]=parseInt(e.substring(13+4*t,17+4*t).trim())}}else if(e.startsWith("M  LIN")){let t=parseInt(e.substring(6,9).trim());for(let i=0;i<t;i++){let t={atom:parseInt(e.substring(9+8*i,13+8*i).trim()),nbrs:[],minRep:1,maxRep:parseInt(e.substring(13+8*i,17+8*i).trim())},s=parseInt(e.substring(17+8*i,21+8*i).trim()),n=parseInt(e.substring(21+8*i,25+8*i).trim());s>0&&t.nbrs.push(s),n>0&&t.nbrs.push(n),this.groupLinkNodes.push(t)}}else if(e.startsWith("M  ALS")){let t=parseInt(e.substring(7,10).trim()),i=parseInt(e.substring(10,13).trim()),s=e.charAt(14),n=[];for(let t=0;t<i;t++)n.push(e.substring(16+4*t,20+4*t).trim());this.mol.setAtomElement(t,"*"),"F"==s?It.setQueryAtomElements(this.mol,t,n):"T"==s&&It.setQueryAtomElementsNot(this.mol,t,n)}if(8==i||9==i||10==i){let t=parseInt(e.substring(6,9).trim()),n=parseInt(e.substring(9,13).trim()),a=8==i?o:9==i?l:r;for(let i=0;i<t;i++){let t=parseInt(e.substring(13+4*i,17+4*i).trim());if(t<1||t>s)throw"Invalid MDL MOL: M-block";let o=a.get(n);o||a.set(n,o=[]),o.push(t)}}else if(i>0){let t=parseInt(e.substring(6,9).trim());for(let s=0;s<t;s++){let t=parseInt(e.substring(9+8*s,13+8*s).trim()),n=parseInt(e.substring(13+8*s,17+8*s).trim());if(t<1)throw"Invalid MDL MOL: M-block";1==i?this.mol.setAtomCharge(t,n):2==i?1==n||3==n?this.mol.setAtomUnpaired(t,2):2==n&&this.mol.setAtomUnpaired(t,1):3==i?this.mol.setAtomIsotope(t,n):4==i?this.mol.setAtomElement(t,"R"+n):5==i?this.mol.setAtomHExplicit(t,n):6==i?this.mol.setAtomCharge(t,n):7==i?this.mol.setBondOrder(t,n):11==i&&0!=n?(-2==n?n=this.countRingBonds(t):-1==n&&(n=0),It.setQueryAtomRingBonds(this.mol,t,[n])):12==i&&0!=n?(-2==n?n=this.countSubstitutions(t):-1==n&&(n=0),It.setQueryAtomAdjacency(this.mol,t,[n])):13==i&&1==n&&It.setQueryAtomUnsaturated(this.mol,t,!0)}}}if(this.postFix(),this.parseExtended){let t=new Mt(this.mol);for(let e of o.values())t.createPath(e);for(let e of l.values())t.createRing(e);for(let e of r.values())t.createArene(e);t.rewriteMolecule()}for(let e of t.sorted(Array.from(a.keys()))){let t=a.get(e);t.bracketType&&(a.delete(e),this.applyPolymerBlock(t))}for(let e of t.sorted(Array.from(a.keys()))){let t=a.get(e);a.delete(e),this.applySuperAtom(t,Array.from(a.values()))}for(let e of t.sorted(Array.from(h.keys())))this.groupMixtures.push(h.get(e));this.mol.keepTransient=!1}postFix(){const e=this.mol;for(let t=1;t<=e.numAtoms;t++){if(Kt.hasAbbrev(e,t)||e.atomTransient(t).some((t=>t.startsWith(wt.AtomSCSRClass))))continue;let i=e.atomElement(t);"D"==i?(e.setAtomElement(t,"H"),e.setAtomIsotope(t,2)):"T"==i&&(e.setAtomElement(t,"H"),e.setAtomIsotope(t,3)),e.is3D&&void 0===e.atomZ(t)&&e.setAtomZ(t,0);let s=Ct.noteExplicitValence(this.mol,t),n=Pt[i];if(null!=s){let i=s<0||s>14?0:s;for(let s of e.atomAdjBonds(t))i-=e.bondOrder(s);i!=e.atomHydrogens(t)&&e.setAtomHExplicit(t,Math.max(0,i))}else if(n){let s=e.atomCharge(t),o="C"==i||"H"==i?Math.abs(s):"B"==i?-Math.abs(s):-s,l=e.atomUnpaired(t);l>0&&("C"==i||"O"==i||"S"==i||"N"==i||"P"==i)&&(o+=l);for(let i of e.atomAdjBonds(t))o+=e.bondOrder(i);for(let i of n)if(o<=i){let s=i-o;s!=e.atomHydrogens(t)&&e.setAtomHExplicit(t,Math.max(0,s));break}}}if(this.considerRescale&&t.isBlank(this.scsrTemplates)&&Wt.normaliseBondDistances(e),null!=this.resBonds){let t=new yt(e,this.resBonds,null);try{t.perform();for(let i=0;i<e.numBonds;i++)e.setBondOrder(i+1,t.bondOrders[i])}catch(t){}}}parseV3000(){var e;let i;!function(t){t[t.Atom=0]="Atom",t[t.Bond=1]="Bond",t[t.Coll=2]="Coll",t[t.SGroup=3]="SGroup",t[t.Template=4]="Template"}(i||(i={}));let s=!1,n=!1,o=null,l=null,r=[],a=[],h=[],u=[],m=[],d=[],c=[];const p="Invalid MDL MOL V3000: ";for(;;){let e=this.nextLine();if("M  END"==e)break;if(!e.startsWith("M  V30 "))continue;let m=e.substring(7);if(m.startsWith("BEGIN TEMPLATE"))n=!0;else if(m.startsWith("END TEMPLATE"))n=!1;else if(m.startsWith("TEMPLATE ")&&n)c.push([e]);else if(n&&null!=c)t.last(c).push(e);else if(m.startsWith("COUNTS "))l=m.substring(7);else if(m.startsWith("BEGIN CTAB"))s=!0;else if(m.startsWith("BEGIN ATOM"))o=i.Atom;else if(m.startsWith("BEGIN BOND"))o=i.Bond;else if(m.startsWith("BEGIN COLLECTION"))o=i.Coll;else if(m.startsWith("BEGIN SGROUP"))o=i.SGroup;else if(m.startsWith("END "))o=null;else if(s&&o==i.Atom)r.push(m);else if(s&&o==i.Bond)a.push(m);else if(s&&o==i.Coll)h.push(m);else if(s&&o==i.SGroup)u.push(m);else if(s&&null==o&&m.startsWith("LINKNODE ")){let e=this.splitWithQuotes(m.substring(9)),i={atom:0,nbrs:[],minRep:parseInt(e[0]),maxRep:parseInt(e[1])},s=parseInt(e[2]),n=[];for(let t=0;t<2*s;t++)n.push(parseInt(e[3+t]));t.sort(n);for(let t=0;t<n.length;t++)t<n.length-1&&n[t]==n[t+1]?i.atom=n[t++]:i.nbrs.push(n[t]);this.groupLinkNodes.push(i)}}let f=l.trim().split(/\s+/);if(f.length<2)throw p+"counts line malformatted";let g=parseInt(f[0]),b=parseInt(f[1]);if(g<0||g>r.length)throw p+"unreasonable atom count: "+g;if(b<0||b>a.length)throw p+"unreasonable bond count: "+b;let y=[],x=[];for(let t=0;t<r.length;t++){let e=r[t];for(;t<r.length-1&&e.endsWith("-");)t++,e=e.substring(0,e.length-1)+r[t];let i=this.splitWithQuotes(e);if(i.length<6)throw p+"atom line has too few components: "+e;let s=parseInt(i[0],0);if(s<1||s>g)throw p+"invalid atom index: "+i[0];if(null!=y[s-1])throw p+"duplicate atom index: "+s;y[s-1]=i}for(let t=0;t<a.length;t++){let e=a[t];for(;t<a.length-1&&e.endsWith("-");)t++,e=e.substring(0,e.length-1)+a[t];let i=this.splitWithQuotes(e);if(i.length<4)throw p+"bond line has too few components: "+e;let s=parseInt(i[0],0);if(s<1||s>b)throw p+"invalid bond index: "+i[0];if(null!=x[s-1])throw p+"duplicate bond index: "+s;x[s-1]=i}for(let t=1;t<=g;t++){let e=y[t-1];if(null==e)throw p+"atom definition missing for #"+t;let i=e[1];i.length>2&&i.startsWith('"')&&i.endsWith('"')&&(i=i.substring(1,i.length-1));let s=parseFloat(e[2]),n=parseFloat(e[3]),o=parseFloat(e[4]),l=parseInt(e[5]);this.mol.addAtom(i,s,n),0!=o&&(this.mol.setAtomZ(t,o),this.mol.setIs3D(!0)),this.mol.setAtomMapNum(t,l),this.parseQueryAtomList(this.mol,t);for(let i=6;i<e.length;i++){let s=e[i].indexOf("=");if(s<0)continue;let n=e[i].substring(0,s),o=e[i].substring(s+1);if("CHG"==n)this.mol.setAtomCharge(t,parseInt(o));else if("RAD"==n){let e=parseInt(o);1==e||3==e?this.mol.setAtomUnpaired(t,2):2==e&&this.mol.setAtomUnpaired(t,1)}else if("MASS"==n)this.mol.setAtomIsotope(t,parseInt(o));else if("CFG"==n)parseInt(o)>0&&this.keepParity;else if("VAL"==n)Ct.markExplicitValence(this.mol,t,parseInt(o));else if("CLASS"==n)this.mol.appendAtomTransient(t,wt.AtomSCSRClass+":"+o);else if("SEQID"==n)this.mol.appendAtomTransient(t,wt.AtomSCSRSeqID+":"+o);else if("ATTCHORD"==n){let e=this.unpackStrings(o);null!=e&&this.mol.appendAtomTransient(t,wt.AtomSCSRAttchOrd+":"+e.join(","))}else if("HCOUNT"==n){let e=parseInt(o);0!=e&&It.setQueryAtomHydrogens(this.mol,t,[Math.max(e,0)])}else if("RBCNT"==n){let e=parseInt(o);-2==e?m.push(t):0!=e&&It.setQueryAtomRingBonds(this.mol,t,[Math.max(e,0)])}else if("SUBST"==n){let e=parseInt(o);-2==e?d.push(t):0!=e&&It.setQueryAtomAdjacency(this.mol,t,[Math.max(e,0)])}else"UNSAT"==n&&1==parseInt(o)&&It.setQueryAtomUnsaturated(this.mol,t,!0)}}for(let e=1;e<=b;e++){let i=x[e-1];if(null==i)throw p+"bond definition missing for #"+e;let s=parseInt(i[1]),n=parseInt(i[2]),o=parseInt(i[3]),l=s>=1&&s<=3?s:9==s||10==s?0:1;this.mol.addBond(n,o,l),9==s&&this.mol.appendBondTransient(e,wt.BondZeroDative),10==s&&this.mol.appendBondTransient(e,wt.BondZeroHydrogen),this.keepQuery?4==s?It.setQueryBondOrders(this.mol,e,[-1]):5==s?It.setQueryBondOrders(this.mol,e,[1,2]):6==s?It.setQueryBondOrders(this.mol,e,[-1,1]):7==s?It.setQueryBondOrders(this.mol,e,[-1,2]):8==s&&It.setQueryBondOrders(this.mol,e,[-1,0,1,2,3]):4==s&&(this.keepAromatic?this.mol.setBondTransient(e,t.append(this.mol.bondTransient(e),wt.BondAromatic)):(null==this.resBonds&&(this.resBonds=t.booleanArray(!1,b)),this.resBonds[e-1]=!0));let r=null,a=null;for(let t=4;t<i.length;t++){let s=i[t].indexOf("=");if(s<0)continue;let n=i[t].substring(0,s),o=i[t].substring(s+1);if("CFG"==n){let t=parseInt(o);this.mol.setBondType(e,1==t?Vt.BONDTYPE_INCLINED:2==t?Vt.BONDTYPE_UNKNOWN:3==t?Vt.BONDTYPE_DECLINED:Vt.BONDTYPE_NORMAL)}else"DISP"==n?"COORD"==o&&this.mol.setBondOrder(e,0):"ENDPTS"==n?r=this.unpackList(o):"ATTACH"==n&&(a=o)}null!=a&&null!=r&&("ALL"==a?this.groupAttachAll.set(e,r):"ANY"==a&&this.groupAttachAny.set(e,r))}for(let t of m)It.setQueryAtomRingBonds(this.mol,t,[this.countRingBonds(t)]);for(let t of d)It.setQueryAtomAdjacency(this.mol,t,[this.countSubstitutions(t)]);this.postFix();for(let t=0;t<h.length;t++){let e=h[t];for(;t<h.length-1&&e.endsWith("-");)t++,e=e.substring(0,e.length-1)+h[t];let i=this.splitWithQuotes(e);i[0].startsWith("MDLV30/STEABS")?i[1].startsWith("ATOMS=")&&(this.groupStereoAbsolute=this.unpackList(i[1].substring(5))):i[0].startsWith("MDLV30/STERAC")?i[1].startsWith("ATOMS=")&&this.groupStereoRacemic.push(this.unpackList(i[1].substring(6))):i[0].startsWith("MDLV30/STEREL")&&i[1].startsWith("ATOMS=")&&this.groupStereoRelative.push(this.unpackList(i[1].substring(6)))}let A=new Rt(this.mol);for(let t of this.groupStereoRacemic)A.createRacemic(t);for(let t of this.groupStereoRelative)A.createRelative(t);A.rewriteMolecule();let v=new Map;for(let t=0;t<u.length;t++){let i=u[t];for(;t<u.length-1&&i.endsWith("-");)t++,i=i.substring(0,i.length-1)+u[t];let s=this.splitWithQuotes(i),n=parseInt(s[0]);if(s.length>3&&n>0&&"SUP"==s[1]){let t={atoms:[],name:null};for(let i=3;i<s.length;i++)if(s[i].startsWith("ATOMS="))t.atoms=this.unpackList(s[i].substring(6));else if(s[i].startsWith("LABEL="))t.name=this.withoutQuotes(s[i].substring(6));else if(s[i].startsWith("XBONDS="))t.bonds=this.unpackList(s[i].substring(7));else if(s[i].startsWith("CLASS="))t.templateClass=this.withoutQuotes(s[i].substring(6));else if(s[i].startsWith("NATREPLACE="))t.natReplace=this.withoutQuotes(s[i].substring(11));else if(s[i].startsWith("SAP=")){const n=this.unpackStrings(s[i].substring(4));t.attachPoints=[...null!==(e=t.attachPoints)&&void 0!==e?e:[],...n]}v.set(n,t)}else if(s.length>3&&n>0&&("MIX"==s[1]||"FOR"==s[1])&&parseInt(s[2])==n){let t={index:n,parent:0,atoms:null,type:s[1]};for(let e=3;e<s.length;e++)s[e].startsWith("ATOMS=")?t.atoms=this.unpackList(s[e].substring(6)):s[e].startsWith("PARENT=")&&(t.parent=parseInt(s[e].substring(7)));this.groupMixtures.push(t)}else if(s.length>3&&n>0&&("SRU"==s[1]||"COP"==s[1]||"MUL"==s[1]||"DAT"==s[1])){let t={atoms:[],name:null,bracketType:s[1]};for(let e=3;e<s.length;e++)s[e].startsWith("ATOMS=")?t.atoms=this.unpackList(s[e].substring(6)):s[e].startsWith("BONDS=")?t.bonds=this.unpackList(s[e].substring(6)):s[e].startsWith("LABEL=")?t.name=this.withoutQuotes(s[e].substring(6)):s[e].startsWith("CONNECT=")?t.connectType=s[e].substring(8):s[e].startsWith("XBCORR=")?t.bondConn=this.unpackList(s[e].substring(7)):s[e].startsWith("MULT=")?t.name=this.withoutQuotes(s[e].substring(5)):s[e].startsWith("FIELDNAME=")?t.name=this.withoutQuotes(s[e].substring(10)):s[e].startsWith("FIELDDATA=")&&(t.value=this.withoutQuotes(s[e].substring(10)));v.set(n,t)}}for(let e of t.sorted(Array.from(v.keys()))){let t=v.get(e);t.bracketType&&(v.delete(e),this.applyPolymerBlock(t))}for(let e of t.sorted(Array.from(v.keys()))){let t=v.get(e);v.delete(e),this.applySuperAtom(t,Array.from(v.values()))}c.length>0&&(this.scsrTemplates=c.map((t=>this.parseV3000Template(t))))}parseQueryAtomList(t,e){let i=t.atomElement(e),s=!1;if(i.startsWith("NOT ")&&(i=i.substring(4),s=!0),i.length<2||!i.startsWith("[")||!i.endsWith("]"))return;i=i.substring(1,i.length-1);let n=i.split(",");t.setAtomElement(e,"*"),s?It.setQueryAtomElementsNot(t,e,n):It.setQueryAtomElements(t,e,n)}applySuperAtom(e,i){if(null==e.name||t.isBlank(e.atoms))return;let s=t.booleanArray(!0,this.mol.numAtoms);for(let t of e.atoms)s[t-1]=!1;let n,o=e.name;for(;(n=o.indexOf("\\S"))>=0;)o=o.substring(0,n)+"{^"+o.substring(n+2);for(;(n=o.indexOf("\\s"))>=0;)o=o.substring(0,n)+"{"+o.substring(n+2);for(;(n=o.indexOf("\\n"))>=0;)o=o.substring(0,n)+"}"+o.substring(n+2);let[l,r]=e.templateClass?[null,null]:Kt.convertToAbbrevIndex(this.mol,s,o);if(null==l){let t={};return e.bonds&&(t.bonds=e.bonds.join(" ")),e.templateClass&&(t.templateClass=e.templateClass),e.natReplace&&(t.natReplace=e.natReplace),e.attachPoints&&(t.attachPoints=e.attachPoints.join(" ")),void Ct.markSgroupMultiAttach(this.mol,o,e.atoms,t)}this.mol=l;let a=t.maskMap(s);for(let e of i){let i=!1;for(let s=e.atoms.length-1;s>=0;s--){let n=a[e.atoms[s]-1]+1;0==n?(e.atoms=t.remove(e.atoms,s),i=!0):e.atoms[s]=n}i&&(e.atoms=t.sorted(t.append(e.atoms,r)))}}applyPolymerBlock(e){if("MUL"==e.bracketType){let t=parseInt(e.name);return void Ct.markSgroupMultiRepeat(this.mol,t,e.atoms)}if("DAT"==e.bracketType)return void(null!=e.atoms&&Ct.markSgroupData(this.mol,e.name,e.value,e.unit,e.query,e.atoms));let i=new Ot(this.mol),s=null;if(null==e.connectType);else if("HT"==e.connectType)s=kt.HeadToTail;else if("HH"==e.connectType)s=kt.HeadToHead;else{if("EU"!=e.connectType)return;s=kt.Random}let n=null;if(3==t.len(e.bondConn)){let t=e.bondConn[0],i=e.bondConn[2],s=e.bondConn[1],o=0;for(let n=1;n<=this.mol.numBonds;n++)if(n!=t&&n!=i&&n!=s){let t=e.atoms.indexOf(this.mol.bondFrom(n))>=0,i=e.atoms.indexOf(this.mol.bondTo(n))>=0;if(t&&!i||!t&&i){if(o>0){o=0;break}o=n}}n=[t,i,s,o]}else 4==t.len(e.bondConn)&&(n=e.bondConn);let o=new qt(e.atoms);o.connect=s,o.bondConn=n,i.createUnit(o)}parseV3000Template(t){let e=t[0],i=this.splitWithQuotes(e.substring(16)),s=i[1],n=null;for(let t=2;t<i.length;t++)i[t].startsWith("NATREPLACE=")&&(n=i[t].substring(11));t[0]="  0  0  0  0  0  0  0  0  0  0  0 V3000",t.push("M  END");let o=new zt(t.join("\n"));return o.parseHeader=!1,o.parse(),{name:s,natReplace:n,mol:o.mol}}withoutQuotes(t){return t.length>=2&&t.startsWith('"')&&t.endsWith('"')?t.substring(1,t.length-1):t}splitWithQuotes(t){let e=[],i="",s=0,n=!1;for(let o=0;o<t.length;o++){let l=t.charAt(o);" "!=l||0!=s||n?(i+=l,'"'==l?n=!n:"("==l||"["==l?s++:")"!=l&&"]"!=l||s--):(i.length>0&&e.push(i),i="")}return i.length>0&&e.push(i),e}unpackList(e){if(!e.startsWith("(")||!e.endsWith(")"))return null;e=e.substring(1,e.length-1);let i=[];for(let t of e.split(" "))i.push(parseInt(t));return i[0]!=i.length-1?null:t.remove(i,0)}unpackStrings(e){if(!e.startsWith("(")||!e.endsWith(")"))return null;let i=(e=e.substring(1,e.length-1)).split(" ");return parseInt(i[0])!=i.length-1?null:t.remove(i,0)}countRingBonds(t){let e=0;for(let i of this.mol.atomAdjBonds(t))this.mol.bondInRing(i)&&e++;return e}countSubstitutions(t){let e=0;for(let i of this.mol.atomAdjList(t))"H"!=this.mol.atomElement(i)&&e++;return e}}class Ft{constructor(t){this.ds=new Et,this.upcastColumns=!0,this.pos=0,this.lines=t.split(/\r?\n/)}parse(){return this.parseStream(),this.upcastColumns&&this.upcastStringColumns(),this.ds}parseStream(){let t=this.ds;t.appendColumn("Molecule","molecule","Molecular structure");let e=-1,i=[];for(;this.pos<this.lines.length;){let s=this.lines[this.pos++];if(!s.startsWith("$$$$")){i.push(s);continue}let n=t.appendRow(),o="",l=0;for(;l<i.length&&(s=i[l],!s.startsWith("> "))&&(o+=s+"\n",l++,!s.startsWith("M\tEND")););let r=null,a=null;try{if(o.length>0){let t=new zt(o);t.parse(),r=t.mol,a=t.molName}}catch(t){}if(null!=r&&t.setMolecule(n,0,r),a&&(e<0&&(e=t.appendColumn("Name","string","Molecule name")),t.setString(n,e,a)),0==n&&null!=r){let e=i[0],s=i[2];e.length>=7&&e.startsWith("$name=")&&t.changeColumnName(0,e.substring(6),t.colDescr(0)),s.length>=8&&s.startsWith("$title=")&&(t.title=s.substring(7))}for(;l+1<i.length;l+=3){let e=i[l],s=i[l+1];if(!e.startsWith(">"))continue;let o=e.indexOf("<");if(o<0)continue;if(e=e.substring(o+1),o=e.indexOf(">"),o<0)continue;if(e=e.substring(0,o),0==e.length)continue;for(;l+2<i.length&&i[l+2].length>0;)s+="\n"+i[l+2],l++;let r=t.findColByName(e);r<0&&(r=t.appendColumn(e,"string","")),0==s.length?t.setToNull(n,r):t.setString(n,r,s)}i=[]}0==t.numRows&&(this.ds=null)}upcastStringColumns(){let t=this.ds;for(let e=0;e<t.numCols;e++)if("string"==t.colType(e)){let i=!0,s=!0,n=!0,o=!0;for(let l=0;l<t.numRows&&(s||n||o);l++){if(t.isNull(l,e))continue;i=!1;let r=t.getString(l,e);if(o){let t=r.toLowerCase();"true"!=t&&"false"!=t&&(o=!1)}if(n){let t=parseInt(r);isFinite(t)&&t==parseFloat(r)||(n=!1)}s&&(isFinite(parseFloat(r))||(s=!1))}i||(n?t.changeColumnType(e,"integer"):s?t.changeColumnType(e,"real"):o&&t.changeColumnType(e,"boolean"))}}}const _t="M  V30 ";class Yt{constructor(t){this.mol=t,this.includeHeader=!0,this.includeCounts=!0,this.includeEnd=!0,this.overallStereoAbsolute=!0,this.enhancedFields=!0,this.chargeSeparate=!1,this.abbrevSgroups=!0,this.polymerBlocks=!0,this.molName="",this.scsrTemplates=null,this.sgroups=[],this.lines=[]}write(){return this.includeHeader&&(this.lines.push(this.molName),this.lines.push("Generated by WebMolKit"),this.lines.push("")),this.writeCTAB(),this.lines.join("\n")}writeV3000(){return this.includeHeader&&(this.lines.push(this.molName),this.lines.push("Generated by WebMolKit"),this.lines.push("")),this.writeCTAB3000(),this.lines.join("\n")}writeEither(){let e=Rt.hasStereoGroups(this.mol)||this.mol.numAtoms>=1e3||this.mol.numBonds>=1e3||t.notBlank(this.scsrTemplates);if(!e)for(let t=1;t<=this.mol.numBonds;t++)if(0==this.mol.bondOrder(t)&&null==It.queryBondOrders(this.mol,t)){e=!0;break}return e?this.writeV3000():this.write()}getResult(){return this.lines.join("\n")}writeCTAB(){var e;let i=this.mol=this.mol.clone();i.keepTransient=!0,(Kt.hasAnyAbbrev(i)||Ct.hasAnySgroupMultiAttach(i)||Ct.hasAnySgroupMultiRepeat(i)||Ct.hasAnySgroupData(i))&&(this.abbrevSgroups?this.partialAbbrevExpansion():Kt.expandAbbrevs(i,!0),this.prepareSgroups());let s=[],n=[];for(let t=1;t<=i.numAtoms;t++){let e=null,o="F";if(e=It.queryAtomElements(i,t),null==e&&(e=It.queryAtomElementsNot(i,t),o="T"),null==e)continue;i.setAtomElement(t,"L");let l=this.intrpad(t,3)+" "+o+"  "+this.intrpad(e.length,3);for(let t of e)l+=this.intrpad(Vt.elementAtomicNumber(t),4);s.push(l),l="M  ALS "+this.intrpad(t,3)+this.intrpad(e.length,3)+" "+o+" ";for(let t of e)l+=this.pad(t,4);n.push(l)}this.lines.push(this.intrpad(i.numAtoms,3)+this.intrpad(i.numBonds,3)+this.intrpad(s.length,3)+"  0"+(this.overallStereoAbsolute?"  1":"  0")+"  0  0  0  0  0999 V2000");let o=[],l=[],r=[],a=[],h=[],u=[],m=[],d=[],c=[],p=[],f=[],g=[],b=[],y=[],x=[],A=[],v=[],M=[];for(let e=1;e<=i.numAtoms;e++){let s=i.atomX(e),n=i.atomY(e),f=i.is3D()?i.atomZ(e):0,g=this.rpad(s.toFixed(4),10)+this.rpad(n.toFixed(4),10)+this.rpad(f.toFixed(4),10),T=i.atomElement(e);for(T.length>3&&(T=T.substring(0,3)),T.length>1&&"R"==T.charAt(0)&&T.charAt(1)>="0"&&T.charAt(1)<="9"&&(m.push(e),d.push(parseInt(T.substring(1))),T="R#");T.length<4;)T+=" ";g+=" "+T+"0";let w=i.atomCharge(e),E=i.atomUnpaired(e),C=i.atomMapNum(e);w=w>=-3&&w<=-1?4-w:0==w&&2==E?4:w>=1&&w<=3?4-w:0;let S=It.queryAtomHydrogens(i,e),k=0;1==t.len(S)&&(k=S[0]+1);let B=this.mdlValence(i,e,15);g+=this.intrpad(w,3)+"  0"+this.intrpad(k,3)+"  0"+this.intrpad(B,3)+"  0  0  0"+this.intrpad(C,3)+"  0  0",this.lines.push(g),0!=i.atomCharge(e)&&(o.push(e),l.push(i.atomCharge(e))),this.enhancedFields&&i.atomHExplicit(e)!=Vt.HEXPLICIT_UNKNOWN&&(c.push(e),p.push(i.atomHExplicit(e))),1==E&&(r.push(e),a.push(2)),2==E&&(r.push(e),a.push(1)),i.atomIsotope(e)!=Vt.ISOTOPE_NATURAL&&(h.push(e),u.push(i.atomIsotope(e)));let N=It.queryAtomRingBonds(i,e),q=It.queryAtomAdjacency(i,e),O=It.queryAtomUnsaturated(i,e);1==t.len(N)&&(b.push(e),y.push(0==N[0]?-1:N[0])),1==t.len(q)&&(x.push(e),A.push(0==q[0]?-1:q[0])),1==O&&(v.push(e),M.push(1))}let T=Ct.noteAromaticBonds(i);for(let s=1;s<=i.numBonds;s++){let n=i.bondOrder(s),o=n,l=t.sorted(null!==(e=It.queryBondOrders(i,s))&&void 0!==e?e:[]);T[s-1]||t.equals(l,[-1])?o=4:t.equals(l,[1,2])?o=5:t.equals(l,[-1,1])?o=6:t.equals(l,[-1,2])?o=7:t.equals(l,[-1,0,1,2,3])?o=8:o>3&&(o=3);let r=i.bondType(s);r==Vt.BONDTYPE_NORMAL||(r=r==Vt.BONDTYPE_INCLINED?1:r==Vt.BONDTYPE_DECLINED?6:r==Vt.BONDTYPE_UNKNOWN?1==o?4:3:0);let a=this.intrpad(i.bondFrom(s),3)+this.intrpad(i.bondTo(s),3)+this.intrpad(o,3)+this.intrpad(r,3)+"  0  0  0";this.lines.push(a),this.enhancedFields&&(n<1||n>3||o!=n&&t.isBlank(l))&&(f.push(s),g.push(n))}if(this.lines.push(...s),this.lines.push(...n),this.writeMBlockPair("CHG",o,l),this.writeMBlockPair("RAD",r,a),this.writeMBlockPair("ISO",h,u),this.writeMBlockPair("RGP",m,d),this.writeMBlockPair("HYD",c,p),this.writeMBlockPair("ZCH",[],[]),this.writeMBlockPair("ZBO",f,g),this.writeMBlockPair("RBC",b,y),this.writeMBlockPair("SUB",x,A),this.writeMBlockPair("UNS",v,M),this.enhancedFields){let e=new Mt(this.mol),i=0;for(let t of e.getResPaths())this.writeMBlockFlat("ZPA",++i,t.atoms);for(let t of e.getResRings())this.writeMBlockFlat("ZRI",++i,t.atoms);for(let s of e.getArenes())this.writeMBlockFlat("ZAR",++i,t.prepend(s.atoms,s.centre))}let w=t.booleanArray(!1,i.numAtoms);for(let t=0;t<this.sgroups.length;t++){let e=this.sgroups[t];for(let t of e.atoms)w[t-1]=!0;let i=this.intrpad(t+1,4);this.lines.push("M  STY  1"+i+" "+e.type);for(let t=0;t<e.atoms.length;t+=15){let s=Math.min(e.atoms.length-t,15),n="M  SAL"+i+this.intrpad(s,3);for(let i=0;i<s;i++)n+=this.intrpad(e.atoms[t+i],4);this.lines.push(n)}if("DAT"!=e.type&&this.lines.push("M  SMT"+i+" "+e.name),"MUL"==e.type){let t=parseInt(e.name),s=e.atoms.length/t;for(let t=0;t<s;t+=15){let n=Math.min(s-t,15),o="M  SPA"+i+this.intrpad(n,3);for(let i=0;i<n;i++)o+=this.intrpad(e.atoms[t+i],4);this.lines.push(o)}e.parent>0&&this.lines.push("M  SPL    1"+i+this.intrpad(e.parent,4))}"DAT"==e.type&&(this.lines.push("M  SDT"+i+" "+this.pad(e.name,32)+this.pad(e.unit,20)+e.query),this.lines.push("M  SED"+i+" "+e.value))}this.polymerBlocks&&this.encodePolymerBlocks(this.sgroups.length);for(let t=1;t<=i.numAtoms;t++)i.atomElement(t).length>2&&(this.lines.push("A  "+this.intrpad(t,3)),this.lines.push(i.atomElement(t)));this.includeEnd&&this.lines.push("M  END")}writeMBlockPair(t,e,i){const s=e.length;for(let n=0;n<s;n+=8){let o=Math.min(8,s-n),l="M  "+t+this.intrpad(o,3);for(let t=0;t<o;t++)l+=this.intrpad(e[n+t],4)+this.intrpad(i[n+t],4);this.lines.push(l)}}writeMBlockFlat(t,e,i){const s=i.length;for(let n=0;n<s;n+=15){let o=Math.min(15,s-n),l="M  "+t+this.intrpad(o,3)+this.intrpad(e,4);for(let t=0;t<o;t++)l+=this.intrpad(i[n+t],4);this.lines.push(l)}}writeMBlockFlatIdxFirst(t,e,i){const s=i.length;for(let n=0;n<s;n+=15){let o=Math.min(15,s-n),l="M  "+t+this.intrpad(e,4)+this.intrpad(o,3);for(let t=0;t<o;t++)l+=this.intrpad(i[n+t],4);this.lines.push(l)}}intrpad(t,e){return this.rpad(t.toString(),e)}rpad(t,e){for(;t.length<e;)t=" "+t;return t}pad(t,e){for(;t.length<e;)t+=" ";return t}mdlValence(t,e,i){let s=Ct.noteExplicitValence(t,e);if(null!=s)return s>0?s:i;let n=t.atomHydrogens(e),o=t.atomElement(e),l=Pt[o];if(null==l&&0==n)return 0;let r=t.atomCharge(e),a="C"==o||"H"==o?Math.abs(r):"B"==o?-Math.abs(r):-r,h=0;for(let i of t.atomAdjBonds(e))h+=t.bondOrder(i);let u=a+n+h;if(null==l?void 0:l.includes(u))return 0;let m=u-a;return m<=0||m>14?i:m}partialAbbrevExpansion(){const{mol:t}=this;for(let e=1;e<=t.numAtoms;e++)if(Kt.hasAbbrev(t,e)){let i=Kt.getAbbrev(t,e);if(null==i||1!=t.atomAdjCount(e)){Kt.clearAbbrev(t,e);continue}Kt.hasAnyAbbrev(i)&&(Kt.expandAbbrevs(i,!0),Kt.setAbbrev(t,e,i));let s=t.bondOrder(t.atomAdjBonds(e)[0]);if(1==i.atomAdjCount(1)&&s==i.bondOrder(i.atomAdjBonds(1)[0]))continue;Kt.expandOneAbbrev(t,e,!0),e--}}prepareSgroups(){const{mol:t}=this;for(let e=1;e<=t.numAtoms;e++)t.atomMapNum(e)<0&&t.setAtomMapNum(e,0);let e=0;for(let i=1;i<=t.numAtoms;i++)if(Kt.hasAbbrev(t,i)){this.sgroups.push({type:"SUP",name:t.atomElement(i),atoms:null});let s=Kt.expandOneAbbrev(t,i,!0);if(null==s)continue;e--;for(let i=0;i<s.length;i++)s[i]&&t.setAtomMapNum(i+1,e);i--}for(let i=-1,s=0;i>=e;i--,s++){let e=[];for(let s=1;s<=t.numAtoms;s++)t.atomMapNum(s)==i&&(e.push(s),t.setAtomMapNum(s,0));this.sgroups[s].atoms=e}for(let e of Ct.noteAllSgroupMultiAttach(t)){let t={type:"SUP",name:e.name,atoms:e.atoms},i=e.keyval.bonds;i&&(t.bonds=i.split(" ").map((t=>parseInt(t)))),t.templateClass=e.keyval.templateClass,t.natReplace=e.keyval.natReplace,i=e.keyval.attachPoints,i&&(t.attachPoints=i.split(" ")),this.sgroups.push(t)}for(let e of Ct.noteAllSgroupMultiRepeat(t))this.sgroups.push({type:"MUL",name:e.mult.toString(),atoms:e.atoms});for(let e of Ct.noteAllSgroupData(t))this.sgroups.push({type:"DAT",name:e.name,value:e.value,unit:e.unit,query:e.query,atoms:e.atoms});for(let t=0;t<this.sgroups.length;t++){let e=this.sgroups[t];if("MUL"!=e.type)continue;let i=-1,s=Number.MAX_SAFE_INTEGER;t:for(let n=0;n<this.sgroups.length;n++)if(n!=t){let t=this.sgroups[n];if("MUL"!=t.type||t.atoms.length>=s)continue;for(let i of e.atoms)if(!t.atoms.includes(i))continue t;i=n,s=t.atoms.length}i>=0&&(e.parent=i+1)}}encodePolymerBlocks(e){let i=new Ot(this.mol);for(let s of i.getIDList()){let n=i.getUnit(s),o=this.intrpad(++e,4);this.lines.push("M  STY  1"+o+" SRU"),n.connect==kt.HeadToTail?this.lines.push("M  SCN  1"+o+" HT "):n.connect==kt.HeadToHead?this.lines.push("M  SCN  1"+o+" HH "):n.connect==kt.Random&&this.lines.push("M  SCN  1"+o+" EU "),this.writeMBlockFlatIdxFirst("SAL",e,n.atoms);let l=null;for(let e=1;e<=this.mol.numBonds;e++){let i=n.atoms.indexOf(this.mol.bondFrom(e))>=0,s=n.atoms.indexOf(this.mol.bondTo(e))>=0;(i&&!s||!i&&s)&&(l=t.append(l,e))}if(null!=l&&this.writeMBlockFlatIdxFirst("SBL",e,l),4==t.len(n.bondConn)){let t=[n.bondConn[0],n.bondConn[2],n.bondConn[1]];this.writeMBlockFlatIdxFirst("CRS",e,t)}this.lines.push("M  SMT"+o+" n")}}writeCTAB3000(){var e;let i=this.mol;(Kt.hasAnyAbbrev(i)||Ct.hasAnySgroupMultiAttach(i)||Ct.hasAnySgroupMultiRepeat(i)||Ct.hasAnySgroupData(i))&&(i=this.mol=i.clone(),i.keepTransient=!0,this.abbrevSgroups?this.partialAbbrevExpansion():Kt.expandAbbrevs(i,!0),this.prepareSgroups());let s=this.populateV3000Sgroups();this.includeCounts&&this.lines.push("  0  0  0     0  0            999 V3000"),this.lines.push(_t+"BEGIN CTAB"),this.lines.push(_t+`COUNTS ${i.numAtoms} ${i.numBonds} ${s.length} 0 ${this.overallStereoAbsolute?1:0}`),this.lines.push(_t+"BEGIN ATOM");for(let e=1;e<=i.numAtoms;e++){let s=i.atomElement(e),n=It.queryAtomElements(i,e);null!=n?s="["+n.join(",")+"]":(n=It.queryAtomElementsNot(i,e),null!=n&&(s="NOT ["+n.join(",")+"]")),s.includes(" ")&&(s=`"${s}"`);let o=i.atomX(e),l=i.atomY(e),r=i.is3D()?i.atomZ(e):0,a=i.atomMapNum(e),h=i.atomCharge(e),u=i.atomUnpaired(e),m=i.atomIsotope(e),d=this.mdlValence(i,e,-1),c=`${_t}${e} ${s} ${o.toFixed(4)} ${l.toFixed(4)} ${r.toFixed(4)} ${a}`;0!=h&&(c+=" CHG="+h),1==u?c+=" RAD=2":2==u&&(c+=" RAD=1"),0!=m&&(c+=" MASS="+m),0!=d&&(c+=" VAL="+d);let p=It.queryAtomHydrogens(i,e),f=It.queryAtomRingBonds(i,e),g=It.queryAtomAdjacency(i,e),b=It.queryAtomUnsaturated(i,e);1==t.len(p)&&(c+=" HCOUNT="+(0==p[0]?-1:p[0])),1==t.len(f)&&(c+=" RBCNT="+(0==f[0]?-1:f[0])),1==t.len(g)&&(c+=" SUBST="+(0==g[0]?-1:g[0])),1==b&&(c+=" UNSAT=1");for(let t of i.atomTransient(e))if(t.startsWith(wt.AtomSCSRClass))c+=" CLASS="+t.substring(wt.AtomSCSRClass.length+1);else if(t.startsWith(wt.AtomSCSRSeqID))c+=" SEQID="+t.substring(wt.AtomSCSRSeqID.length+1);else if(t.startsWith(wt.AtomSCSRAttchOrd)){let e=t.substring(wt.AtomSCSRAttchOrd.length+1).split(",");c+=" ATTCHORD="+this.packV3000Strings(e)}this.lines.push(c)}if(this.lines.push(_t+"END ATOM"),i.numBonds>0){this.lines.push(_t+"BEGIN BOND");let s=Ct.noteAromaticBonds(i),n=Ct.noteZeroHydrogenBonds(i);for(let o=1;o<=i.numBonds;o++){let l=i.bondFrom(o),r=i.bondTo(o),a=i.bondOrder(o),h=a,u=t.sorted(null!==(e=It.queryBondOrders(i,o))&&void 0!==e?e:[]);s[o-1]||t.equals(u,[-1])?h=4:t.equals(u,[1,2])?h=5:t.equals(u,[-1,1])?h=6:t.equals(u,[-1,2])?h=7:t.equals(u,[-1,0,1,2,3])?h=8:0==h?h=n[o-1]?10:9:h>3&&(h=3);let m=i.bondType(o),d=`${_t}${o} ${h} ${l} ${r}`;m==Vt.BONDTYPE_INCLINED?d+=" CFG=1":m==Vt.BONDTYPE_DECLINED?d+=" CFG=3":m==Vt.BONDTYPE_UNKNOWN&&(d+=" CFG=2"),0!=a||n[o-1]||(d+=" DISP=COORD"),this.lines.push(d)}this.lines.push(_t+"END BOND")}s.length>0&&(this.lines.push(_t+"BEGIN SGROUP"),this.lines.push(...s),this.lines.push(_t+"END SGROUP"));let n=[],o=new Rt(i),l=0,r=0;for(let t of o.getRacemicAtoms())n.push(_t+"MDLV30/STERAC"+ ++l+" ATOMS="+this.packV3000List(t));for(let t of o.getRelativeAtoms())n.push(_t+"MDLV30/STEREL"+ ++r+" ATOMS="+this.packV3000List(t));n.length>0&&(this.lines.push(_t+"BEGIN COLLECTION"),this.lines.push(...n),this.lines.push(_t+"END COLLECTION")),this.lines.push(_t+"END CTAB"),t.notBlank(this.scsrTemplates)&&this.populateSCSRTemplates(),this.includeEnd&&this.lines.push("M  END")}populateV3000Sgroups(){let t=this.mol,e=[];for(let t=0;t<this.sgroups.length;t++){let i=this.sgroups[t],s=e.length+1,n=`${_t}${s} ${i.type} 0`;if("SUP"==i.type){if(n+=" LABEL="+(i.name.includes(" ")?`"${i.name}"`:i.name),n+=" ATOMS="+this.packV3000List(i.atoms),i.bonds&&(n+=" XBONDS="+this.packV3000List(i.bonds)),i.templateClass&&(n+=" CLASS="+i.templateClass),i.natReplace&&(n+=" NATREPLACE="+i.natReplace),i.attachPoints)for(let t=0;t+2<i.attachPoints.length;t+=3)n+=` SAP=(3 ${i.attachPoints[t]} ${i.attachPoints[t+1]} ${i.attachPoints[t+2]})`}else if("MUL"==i.type){let t=parseInt(i.name),e=i.atoms.length/t;n+=" MULT="+i.name,n+=" ATOMS="+this.packV3000List(i.atoms),n+=" PATOMS="+this.packV3000List(i.atoms.slice(0,e)),i.parent>0&&(n+=" PARENT="+i.parent)}else"DAT"==i.type&&(n+=" ATOMS="+this.packV3000List(i.atoms),n+=" FIELDNAME="+(i.name.includes(" ")?`"${i.name}"`:i.name),n+=" FIELDDATA="+(i.value.includes(" ")?`"${i.value}"`:i.value));e.push(n)}if(this.polymerBlocks){let i=new Ot(t);for(let s of i.getIDList()){let n=e.length+1,o=i.getUnit(s),l=`${_t}${n} SRU 0`;l+=" ATOMS="+this.packV3000List(o.atoms),o.connect==kt.HeadToTail?l+=" CONNECT=HT":o.connect==kt.HeadToHead?l+=" CONNECT=HH":o.connect==kt.Random&&(l+=" CONNECT=EU");let r=[];for(let e=1;e<=t.numBonds;e++){let i=o.atoms.includes(t.bondFrom(e)),s=o.atoms.includes(t.bondTo(e));(i&&!s||!i&&s)&&r.push(e)}r.length>0&&(l+=" BONDS="+this.packV3000List(r)),null!=o.bondConn&&(l+=" XBCORR="+this.packV3000List(o.bondConn)),e.push(l)}}return e}populateSCSRTemplates(){this.lines.push(_t+"BEGIN TEMPLATE");for(let i=0;i<this.scsrTemplates.length;i++){var t=this.scsrTemplates[i];let s=_t+"TEMPLATE "+(i+1)+" "+t.name;t.natReplace&&(s+=" NATREPLACE="+t.natReplace),this.lines.push(s);var e=new Yt(t.mol);e.includeHeader=!1,e.includeCounts=!1,e.includeEnd=!1;let n=e.writeV3000();for(s of n.trimEnd().split("\n"))this.lines.push(s)}this.lines.push(_t+"END TEMPLATE")}packV3000List(t){let e="("+t.length;for(let i of t)e+=" "+i;return e+")"}packV3000Strings(t){let e="("+t.length;for(let i of t)e+=" "+i;return e+")"}}class Xt{constructor(t){this.ds=t,this.enhancedFields=!0,this.chargeSeparate=!1,this.abbrevSgroups=!0,this.lines=[]}write(){let t=this.ds,e=this.lines,i=this.ds.firstColOfType("molecule");for(let s=0;s<t.numRows;s++){let n=i<0?null:t.getMolecule(s,i);if(null!=n){let t=new Yt(n);t.enhancedFields=this.enhancedFields,t.chargeSeparate=this.chargeSeparate,t.abbrevSgroups=this.abbrevSgroups;let i=t.write();e.push(i)}for(let n=0;n<t.numCols;n++)if(n!=i&&t.notNull(s,n)){let i=t.colType(n),o="";"string"==i?o=t.getString(s,n):"integer"==i?o=t.getInteger(s,n).toString():"real"==i?o=t.getReal(s,n).toString():"boolean"==i&&(o=t.getBoolean(s,n)?"true":"false"),""!=o&&(e.push("> <"+t.colName(n)+">"),e.push(o),e.push(""))}e.push("$$$$")}return e.join("\n")}getResult(){return this.lines.join("\n")}}class Ut{static readUnknown(t){if(t.startsWith('"'))try{let e=JSON.parse(t),i=Ut.readNative(e);if(i)return i}catch(t){}let e=Ut.readNative(t);if(e)return e;try{e=Ut.readMDLMOL(t)}catch(t){}return e}static readNative(t){let e=new Vt;e.keepTransient=!0;let i=t.split(/\r?\n/);if(i.length<2)return null;if(!i[0].startsWith("SketchEl!")&&i.length>=4&&i[3].indexOf("V2000")>=0){let e=t.indexOf("SketchEl!");if(e<0)return null;i=t.substring(e).split(/r?\n/)}let s=i[0].match(/^SketchEl\!\((\d+)\,(\d+)\)/);if(!s)return null;let n=parseInt(s[1]),o=parseInt(s[2]);if(i.length<2+n+o)return null;if(!i[1+n+o].match(/^!End/))return null;for(let t=0;t<n;t++){let s=i[1+t].split(/[=,;]/),n=e.addAtom(Ut.skUnescape(s[0]),parseFloat(s[1]),parseFloat(s[2]),parseInt(s[3]),parseInt(s[4])),o=[],l=[];for(let t=5;t<s.length;t++)s[t].charAt(0),"i"==s[t].charAt(0)||("e"==s[t].charAt(0)?e.setAtomHExplicit(n,parseInt(s[t].substring(1))):"m"==s[t].charAt(0)?e.setAtomIsotope(n,parseInt(s[t].substring(1))):"n"==s[t].charAt(0)?e.setAtomMapNum(n,parseInt(s[t].substring(1))):"x"==s[t].charAt(0)?o.push(Ut.skUnescape(s[t])):"y"==s[t].charAt(0)?l.push(Ut.skUnescape(s[t])):"z"==s[t].charAt(0)?(e.setAtomZ(n,parseFloat(s[t].substring(1))),e.setIs3D(!0)):o.push(Ut.skUnescape(s[t])));e.setAtomExtra(n,o),e.setAtomTransient(n,l)}for(let t=0;t<o;t++){let s=i[1+n+t].split(/[=,]/),o=s[0].split("-"),l=parseInt(o[0].trim()),r=parseInt(o[1].trim());if(l==r)continue;let a=e.addBond(l,r,parseInt(s[1]),parseInt(s[2])),h=new Array,u=new Array;for(let t=3;t<s.length;t++)s[t].charAt(0),"x"==s[t].charAt(0)?h.push(Ut.skUnescape(s[t])):"y"==s[t].charAt(0)?u.push(Ut.skUnescape(s[t])):h.push(Ut.skUnescape(s[t]));e.setBondExtra(a,h),e.setBondTransient(a,u)}return e.keepTransient=!1,e}static writeNative(t){let e="SketchEl!("+t.numAtoms+","+t.numBonds+")\n";for(let i=1;i<=t.numAtoms;i++){let s=t.atomElement(i),n=t.atomX(i),o=t.atomY(i),l=t.atomCharge(i),r=t.atomUnpaired(i),a=t.atomHExplicit(i)!=Vt.HEXPLICIT_UNKNOWN?"e"+t.atomHExplicit(i):"i"+t.atomHydrogens(i);e+=Ut.skEscape(s)+"="+n.toFixed(4)+","+o.toFixed(4)+";"+l+","+r+","+a,t.is3D()&&(e+=",z"+t.atomZ(i)),t.atomIsotope(i)!=Vt.ISOTOPE_NATURAL&&(e+=",m"+t.atomIsotope(i)),t.atomMapNum(i)>0&&(e+=",n"+t.atomMapNum(i)),e+=Ut.skEncodeExtra(t.atomExtra(i)),e+=Ut.skEncodeExtra(t.atomTransient(i)),e+="\n"}for(let i=1;i<=t.numBonds;i++)e+=t.bondFrom(i)+"-"+t.bondTo(i)+"="+t.bondOrder(i)+","+t.bondType(i),e+=Ut.skEncodeExtra(t.bondExtra(i)),e+=Ut.skEncodeExtra(t.bondTransient(i)),e+="\n";return e+="!End\n",e}static readMDLMOL(t){let e=new zt(t);return e.parseHeader=!0,e.parse(),e.mol}static writeMDLMOL(t){return new Yt(t).write()}static skUnescape(t){let e,i="";for(;e=t.match(/^(.*?)\\([0-9A-Fa-f][0-9A-Fa-f][0-9A-Fa-f][0-9A-Fa-f])(.*)/);)i+=e[1]+String.fromCharCode(parseInt("0x"+e[2])),t=e[3];return i+t}static skEscape(t){let e="";for(let i=0;i<t.length;i++){let s=t.charAt(i),n=t.charCodeAt(i);if(n<=32||n>127||"\\"==s||","==s||";"==s||"="==s){let t=(65535&n).toString(16).toUpperCase();e+="\\";for(let i=4-t.length;i>0;i--)e+="0";e+=t}else e+=s}return e}static skEncodeExtra(t){let e="";for(let i=0;i<t.length;i++)e+=","+Ut.skEscape(t[i]);return e}}class jt{}class Ht{}class Vt{constructor(){this.atoms=[],this.bonds=[],this.hasZCoord=!1,this.keepTransient=!1,this.hasTransient=!1,this.graph=null,this.graphBond=null,this.ringID=null,this.compID=null,this.ring3=null,this.ring4=null,this.ring5=null,this.ring6=null,this.ring7=null}clone(){let t=new Vt;return t.atoms=Y(this.atoms),t.bonds=Y(this.bonds),t.hasZCoord=this.hasZCoord,t.keepTransient=this.keepTransient,t.hasTransient=this.hasTransient,t.graph=this.graph,t.graphBond=this.graphBond,t.ringID=this.ringID,t.compID=this.compID,t.ring3=this.ring3,t.ring4=this.ring4,t.ring5=this.ring5,t.ring6=this.ring6,t.ring7=this.ring7,t}static fromString(t){return Ut.readNative(t)}toString(){return Ut.writeNative(this)}append(t){let e=this.atoms.length;for(let e=1;e<=t.numAtoms;e++){let i=this.addAtom(t.atomElement(e),t.atomX(e),t.atomY(e),t.atomCharge(e),t.atomUnpaired(e));this.setAtomIsotope(i,t.atomIsotope(e)),this.setAtomHExplicit(i,t.atomHExplicit(e)),this.setAtomMapNum(i,t.atomMapNum(e)),this.setAtomExtra(i,t.atomExtra(e)),this.setAtomTransient(i,t.atomTransient(e))}for(let i=1;i<=t.numBonds;i++){let s=this.addBond(t.bondFrom(i)+e,t.bondTo(i)+e,t.bondOrder(i),t.bondType(i));this.setBondExtra(s,t.bondExtra(i)),this.setBondTransient(s,t.bondTransient(i))}this.trashTransient()}get numAtoms(){return this.atoms.length}getAtom(t){if(t<1||t>this.atoms.length)throw new Error(`Molecule.getAtom: index ${t} out of range (#atoms=${this.atoms.length})`);return this.atoms[t-1]}atomElement(t){return this.getAtom(t).element}atomX(t){return this.getAtom(t).x}atomY(t){return this.getAtom(t).y}atomCharge(t){return this.getAtom(t).charge}atomUnpaired(t){return this.getAtom(t).unpaired}atomIsotope(t){return this.getAtom(t).isotope}atomHExplicit(t){return this.getAtom(t).hExplicit}atomMapNum(t){return this.getAtom(t).mapNum}atomExtra(t){return this.getAtom(t).extra.slice(0)}atomTransient(t){return this.getAtom(t).transient.slice(0)}get numBonds(){return this.bonds.length}getBond(t){if(t<1||t>this.bonds.length)throw new Error(`Molecule.getBond: index ${t} out of range (#bonds=${this.bonds.length})`);return this.bonds[t-1]}bondFrom(t){return this.getBond(t).from}bondTo(t){return this.getBond(t).to}bondOrder(t){return this.getBond(t).order}bondType(t){return this.getBond(t).type}bondExtra(t){return this.getBond(t).extra.slice(0)}bondTransient(t){return this.getBond(t).transient.slice(0)}bondFromTo(t){let e=this.getBond(t);return[e.from,e.to]}addAtom(t,e,i,s=0,n=0){let o=new jt;return o.element=t,o.x=e,o.y=i,o.charge=s,o.unpaired=n,o.isotope=Vt.ISOTOPE_NATURAL,o.hExplicit=Vt.HEXPLICIT_UNKNOWN,o.mapNum=0,o.extra=[],o.transient=[],this.atoms.push(o),this.trashTransient(),this.trashGraph(),this.atoms.length}setAtomElement(t,e){this.getAtom(t).element=e,this.trashTransient()}setAtomPos(t,e,i,s){let n=this.getAtom(t);n.x=e,n.y=i,n.z=null==s?0:s,this.trashTransient()}setAtomX(t,e){this.getAtom(t).x=e,this.trashTransient()}setAtomY(t,e){this.getAtom(t).y=e,this.trashTransient()}setAtomCharge(t,e){this.getAtom(t).charge=e,this.trashTransient()}setAtomUnpaired(t,e){this.getAtom(t).unpaired=e,this.trashTransient()}setAtomIsotope(t,e){this.getAtom(t).isotope=e,this.trashTransient()}setAtomHExplicit(t,e){this.getAtom(t).hExplicit=e,this.trashTransient()}setAtomMapNum(t,e){this.getAtom(t).mapNum=e,this.trashTransient()}setAtomExtra(t,e){this.getAtom(t).extra=e.slice(0)}setAtomTransient(t,e){this.getAtom(t).transient=e.slice(0),e.length>0&&(this.hasTransient=!0)}swapAtoms(t,e){let i=this.atoms[t-1];this.atoms[t-1]=this.atoms[e-1],this.atoms[e-1]=i;for(let i=0;i<this.bonds.length;i++){let s=this.bonds[i];s.from==e?s.from=t:s.from==t&&(s.from=e),s.to==e?s.to=t:s.to==t&&(s.to=e)}this.trashGraph()}addBond(t,e,i,s=Vt.BONDTYPE_NORMAL){let n=new Ht;return n.from=t,n.to=e,n.order=i,n.type=s,n.extra=[],n.transient=[],this.bonds.push(n),this.trashTransient(),this.trashGraph(),this.bonds.length}setBondFrom(t,e){this.getBond(t).from=e,this.trashTransient(),this.trashGraph()}setBondTo(t,e){this.getBond(t).to=e,this.trashTransient(),this.trashGraph()}setBondFromTo(t,e,i){this.getBond(t).from=e,this.getBond(t).to=i,this.trashTransient(),this.trashGraph()}setBondOrder(t,e){this.getBond(t).order=e,this.trashTransient()}setBondType(t,e){this.getBond(t).type=e,this.trashTransient()}setBondExtra(t,e){this.getBond(t).extra=e.slice(0)}setBondTransient(t,e){this.getBond(t).transient=e.slice(0),e.length>0&&(this.hasTransient=!0)}deleteAtomAndBonds(t){for(let e=this.numBonds;e>=1;e--)this.bondFrom(e)==t||this.bondTo(e)==t?this.deleteBond(e):(this.bondFrom(e)>t&&this.setBondFrom(e,this.bondFrom(e)-1),this.bondTo(e)>t&&this.setBondTo(e,this.bondTo(e)-1));this.atoms.splice(t-1,1),this.trashTransient(),this.trashGraph()}deleteBond(t){this.bonds.splice(t-1,1),this.trashTransient(),this.trashGraph()}atomHydrogens(t){let e=this.atomHExplicit(t);if(e!=Vt.HEXPLICIT_UNKNOWN)return e;for(let i=0;i<Vt.HYVALENCE_EL.length;i++)if(Vt.HYVALENCE_EL[i]==this.atomElement(t)){e=Vt.HYVALENCE_VAL[i];break}if(e==Vt.HEXPLICIT_UNKNOWN)return 0;let i=this.atomCharge(t);"C"==this.atomElement(t)&&(i=-Math.abs(i)),e+=i-this.atomUnpaired(t);let s=this.atomAdjBonds(t);for(let t=0;t<s.length;t++)e-=this.bondOrder(s[t]);return e<0?0:e}findBond(t,e){for(let i=1;i<=this.numBonds;i++){let s=this.bondFrom(i),n=this.bondTo(i);if(t==s&&e==n||t==n&&e==s)return i}return 0}bondOther(t,e){let i=this.bondFrom(t),s=this.bondTo(t);return i==e?s:s==e?i:0}atomExplicit(t){let e=this.atoms[t-1];return e.isotope!=Vt.ISOTOPE_NATURAL||"C"!=e.element||0!=e.charge||0!=e.unpaired||0==this.atomAdjCount(t)}atomRingBlock(t){return null==this.graph&&this.buildGraph(),null==this.ringID&&this.buildRingID(),this.ringID[t-1]}bondInRing(t){let e=this.atomRingBlock(this.bondFrom(t)),i=this.atomRingBlock(this.bondTo(t));return e>0&&e==i}atomConnComp(t){return null==this.graph&&this.buildGraph(),null==this.compID&&this.buildConnComp(),this.compID[t-1]}atomAdjCount(t){return this.buildGraph(),this.graph[t-1].length}atomAdjList(t){this.buildGraph();let e=this.graph[t-1].slice(0);for(let t=e.length-1;t>=0;t--)e[t]++;return e}atomAdjBonds(t){return this.buildGraph(),this.graphBond[t-1].slice(0)}findRingsOfSize(e){let i=null;if(3==e&&null!=this.ring3&&(i=this.ring3),4==e&&null!=this.ring4&&(i=this.ring4),5==e&&null!=this.ring5&&(i=this.ring5),6==e&&null!=this.ring6&&(i=this.ring6),7==e&&null!=this.ring7&&(i=this.ring7),null==i){null==this.graph&&this.buildGraph(),null==this.ringID&&this.buildRingID(),i=[];for(let s=1;s<=this.atoms.length;s++)if(this.ringID[s-1]>0){let n=t.numberArray(0,e);n[0]=s,this.recursiveRingFind(n,1,e,this.ringID[s-1],i)}3==e&&(this.ring3=i),4==e&&(this.ring4=i),5==e&&(this.ring5=i),6==e&&(this.ring6=i),7==e&&(this.ring7=i)}let s=[];for(let t=0;t<i.length;t++)s.push(i[t].slice(0));return s}boundary(){if(0==this.atoms.length)return Z.zero();let t=this.atoms[0].x,e=t,i=this.atoms[0].y,s=i;for(let n=1;n<this.atoms.length;n++)t=Math.min(t,this.atoms[n].x),i=Math.min(i,this.atoms[n].y),e=Math.max(e,this.atoms[n].x),s=Math.max(s,this.atoms[n].y);return new Z(t,i,e-t,s-i)}atomicNumber(t){return Vt.elementAtomicNumber(this.atomElement(t))}static elementAtomicNumber(t){return Math.max(0,gt.ELEMENTS.indexOf(t))}is3D(){return this.hasZCoord}setIs3D(t){this.hasZCoord=t}atomZ(t){return this.getAtom(t).z}setAtomZ(t,e){this.getAtom(t).z=e}compareTo(t){if(null==t||0==t.numAtoms)return 0==this.numAtoms?0:1;if(this.numAtoms<t.numAtoms)return-1;if(this.numAtoms>t.numAtoms)return 1;if(this.numBonds<t.numBonds)return-1;if(this.numBonds>t.numBonds)return 1;for(let e=1;e<=this.numAtoms;e++){if(this.atomElement(e)<t.atomElement(e))return-1;if(this.atomElement(e)>t.atomElement(e))return 1;if(this.atomX(e)<t.atomX(e))return-1;if(this.atomX(e)>t.atomX(e))return 1;if(this.atomY(e)<t.atomY(e))return-1;if(this.atomY(e)>t.atomY(e))return 1;if(this.atomCharge(e)<t.atomCharge(e))return-1;if(this.atomCharge(e)>t.atomCharge(e))return 1;if(this.atomUnpaired(e)<t.atomUnpaired(e))return-1;if(this.atomUnpaired(e)>t.atomUnpaired(e))return 1;if(this.atomHExplicit(e)<t.atomHExplicit(e))return-1;if(this.atomHExplicit(e)>t.atomHExplicit(e))return 1;if(this.atomIsotope(e)<t.atomIsotope(e))return-1;if(this.atomIsotope(e)>t.atomIsotope(e))return 1;if(this.atomMapNum(e)<t.atomMapNum(e))return-1;if(this.atomMapNum(e)>t.atomMapNum(e))return 1;let i=this.atomExtra(e),s=t.atomExtra(e);if(i.length<s.length)return-1;if(i.length>s.length)return 1;for(let t=0;t<i.length;t++){if(i[t]<s[t])return-1;if(i[t]>s[t])return 1}if(i=this.atomTransient(e),s=t.atomTransient(e),i.length<s.length)return-1;if(i.length>s.length)return 1;for(let t=0;t<i.length;t++){if(i[t]<s[t])return-1;if(i[t]>s[t])return 1}}for(let e=1;e<=this.numBonds;e++){if(this.bondFrom(e)<t.bondFrom(e))return-1;if(this.bondFrom(e)>t.bondFrom(e))return 1;if(this.bondTo(e)<t.bondTo(e))return-1;if(this.bondTo(e)>t.bondTo(e))return 1;if(this.bondOrder(e)<t.bondOrder(e))return-1;if(this.bondOrder(e)>t.bondOrder(e))return 1;if(this.bondType(e)<t.bondType(e))return-1;if(this.bondType(e)>t.bondType(e))return 1;let i=this.bondExtra(e),s=t.bondExtra(e);if(i.length<s.length)return-1;if(i.length>s.length)return 1;for(let t=0;t<i.length;t++){if(i[t]<s[t])return-1;if(i[t]>s[t])return 1}if(i=this.bondTransient(e),s=t.bondTransient(e),i.length<s.length)return-1;if(i.length>s.length)return 1;for(let t=0;t<i.length;t++){if(i[t]<s[t])return-1;if(i[t]>s[t])return 1}}return 0}trashTransient(){if(!this.keepTransient&&this.hasTransient){for(let t of this.atoms)t.transient=[];for(let t of this.bonds)t.transient=[];this.hasTransient=!1}}appendAtomExtra(t,e){this.getAtom(t).extra.push(e)}appendAtomTransient(t,e){this.getAtom(t).transient.push(e)}appendBondExtra(t,e){this.getBond(t).extra.push(e)}appendBondTransient(t,e){this.getBond(t).transient.push(e)}trashGraph(){this.graph=null,this.graphBond=null,this.ringID=null,this.compID=null,this.ring3=null,this.ring4=null,this.ring5=null,this.ring6=null,this.ring7=null}buildGraph(){if(null!=this.graph&&null!=this.graphBond)return;let t=[],e=[],i=this.numAtoms,s=this.numBonds;for(let s=0;s<i;s++)t.push([]),e.push([]);for(let i=1;i<=s;i++){let s=this.getBond(i);t[s.from-1].push(s.to-1),t[s.to-1].push(s.from-1),e[s.from-1].push(i),e[s.to-1].push(i)}this.graph=t,this.graphBond=e}buildConnComp(){const e=this.atoms.length;this.compID=t.numberArray(0,e);for(let t=0;t<e;t++)this.compID[t]=0;let i=1;for(this.compID[0]=i;;){let t=!1;for(let s=0;s<e;s++)if(this.compID[s]==i)for(let e=0;e<this.graph[s].length;e++)0==this.compID[this.graph[s][e]]&&(this.compID[this.graph[s][e]]=i,t=!0);if(!t){for(let s=0;s<e;s++)if(0==this.compID[s]){this.compID[s]=++i,t=!0;break}if(!t)break}}}buildRingID(){const e=this.atoms.length;if(this.ringID=t.numberArray(0,e),0==e)return;let i=t.booleanArray(!1,e);for(let t=0;t<e;t++)this.ringID[t]=0,i[t]=!1;let s=t.numberArray(0,e+1),n=0,o=0;for(;;){let t,l;if(0==n)for(t=-1,l=0;i[l];l++);else{t=s[n-1],l=-1;for(let e=0;e<this.graph[t].length;e++)if(!i[this.graph[t][e]]){l=this.graph[t][e];break}}if(l>=0&&n>=2){let o=s[n-1];for(let r=0;r<this.graph[l].length;r++){let a=this.graph[l][r];if(a!=o&&i[a]){s[n]=l;for(let i=n;i==n||s[i+1]!=a;i--){let n=this.ringID[s[i]];if(0==n)this.ringID[s[i]]=t;else if(n!=t)for(let i=0;i<e;i++)this.ringID[i]==n&&(this.ringID[i]=t)}}}}if(l>=0?(i[l]=!0,s[n++]=l,o++):n--,o==e)break}let l=0;for(let t=0;t<e;t++)if(this.ringID[t]>0){l--;for(let i=e-1;i>=t;i--)this.ringID[i]==this.ringID[t]&&(this.ringID[i]=l)}for(let t=0;t<e;t++)this.ringID[t]=-this.ringID[t]}recursiveRingFind(e,i,s,n,o){const{graph:l}=this;if(i<s){let t=e[i-1];for(let r=0;r<l[t-1].length;r++){let a=l[t-1][r]+1;if(this.ringID[a-1]!=n)continue;let h=!1;for(let t=0;t<i;t++)if(e[t]==a){h=!0;break}if(!h){let t=e.slice(0);t[i]=a,this.recursiveRingFind(t,i+1,s,n,o)}}return}let r=e[i-1],a=!1;for(let t=0;t<l[r-1].length;t++)if(l[r-1][t]+1==e[0]){a=!0;break}if(!a)return;for(let t=0;t<e.length;t++){let i=0,s=e[t]-1;for(let t=0;t<l[s].length;t++)e.indexOf(l[s][t]+1)>=0&&i++;if(2!=i)return}let h=0;for(let t=1;t<i;t++)e[t]<e[h]&&(h=t);let u=(h+1)%i,m=e[(h-1+i)%i]<e[u];if(0!=h||m){let s=t.numberArray(0,i);for(let t=0;t<i;t++)s[t]=e[(h+(m?i-t:t))%i];e=s}for(let t=0;t<o.length;t++){let s=o[t],n=!0;for(let t=0;t<i;t++)if(s[t]!=e[t]){n=!1;break}if(n)return}o.push(e)}}Vt.IDEALBOND=1.5,Vt.HEXPLICIT_UNKNOWN=-1,Vt.ISOTOPE_NATURAL=0,Vt.BONDTYPE_NORMAL=0,Vt.BONDTYPE_INCLINED=1,Vt.BONDTYPE_DECLINED=2,Vt.BONDTYPE_UNKNOWN=3,Vt.HYVALENCE_EL=["C","N","O","S","P"],Vt.HYVALENCE_VAL=[4,3,2,2,3],Vt.PREFIX_EXTRA="x",Vt.PREFIX_TRANSIENT="y";class Wt{static atomAtPoint(t,e,i,s){null==s&&(s=Wt.OVERLAP_THRESHOLD);const n=s*s;for(let s=1;s<=t.numAtoms;s++)if(y(t.atomX(s)-e,t.atomY(s)-i)<n)return s;return 0}static sketchEquivalent(e,i,s){null==s&&(s=Wt.DEFAULT_EQUIV_TOLERANCE);const n=e.numAtoms,o=e.numBonds;if(n!=i.numAtoms||o!=i.numBonds)return!1;const l=s*s;let r=e.boundary(),a=i.boundary();if(Math.abs(r.minX()-a.minX())>s)return!1;if(Math.abs(r.minY()-a.minY())>s)return!1;if(Math.abs(r.maxX()-a.maxX())>s)return!1;if(Math.abs(r.maxY()-a.maxY())>s)return!1;let h=Kt.arrayAtomX(e),u=Kt.arrayAtomY(e),m=Kt.arrayAtomX(i),d=Kt.arrayAtomY(i),c=t.numberArray(0,n),p=t.booleanArray(!1,n);for(let t=0;t<n;t++){let s=-1;if(y(h[t]-m[t],u[t]-d[t])<l&&(s=t),s<0){let e=Number.MAX_VALUE;for(let i=0;i<n;i++)if(!p[i]){let n=y(h[t]-m[i],u[t]-d[i]);n<e&&(e=n,s=i)}if(s<0||e>l)return!1}if(c[t]=s+1,p[s]=!0,e.atomElement(t+1)!=i.atomElement(s+1))return!1;if(e.atomCharge(t+1)!=i.atomCharge(s+1))return!1;if(e.atomUnpaired(t+1)!=i.atomUnpaired(s+1))return!1;if(e.atomHExplicit(t+1)!=i.atomHExplicit(s+1)&&e.atomHExplicit(t+1)!=Vt.HEXPLICIT_UNKNOWN&&i.atomHExplicit(s+1)!=Vt.HEXPLICIT_UNKNOWN)return!1}for(let t=1;t<=o;t++){let s=e.bondFrom(t),n=e.bondTo(t),o=c[s-1],l=c[n-1],r=i.findBond(o,l);if(0==r)return!1;if(e.bondOrder(t)!=i.bondOrder(r)||e.bondType(t)!=i.bondType(r))return!1;if(i.bondFrom(r)==o&&i.bondTo(r)==l);else if(i.bondType(r)==Vt.BONDTYPE_INCLINED||i.bondType(r)==Vt.BONDTYPE_DECLINED||i.bondFrom(r)!=l||i.bondTo(r)!=o)return!1}return!0}static sketchMappable(t,e,i){null==i&&(i=Wt.DEFAULT_EQUIV_TOLERANCE);let s=t.boundary(),n=e.boundary(),o=s.minX()-n.minX(),l=s.minY()-n.minY();if(Math.abs(o)>.1*i||Math.abs(l)>.1*i){e=e.clone();for(let t=1;t<=e.numAtoms;t++)e.setAtomPos(t,e.atomX(t)+o,e.atomY(t)+l)}return Wt.sketchEquivalent(t,e,i)}static atomBondAngles(t,e,i){null==i&&(i=t.atomAdjList(e));let s=[],n=t.atomX(e),o=t.atomY(e);for(let e of i)s.push(Math.atan2(t.atomY(e)-o,t.atomX(e)-n));return s}static overlapsAtom(t,e,i,s){const n=s*s;for(let s=1;s<=t.numAtoms;s++)if(y(t.atomX(s)-e,t.atomY(s)-i)<n)return!0;return!1}static overlappingAtomMask(e,i){null==i&&(i=Wt.OVERLAP_THRESHOLD);const s=e.numAtoms;let n,o,l=e.boundary();l.w>l.h?(n=Kt.arrayAtomX(e),o=Kt.arrayAtomY(e)):(n=Kt.arrayAtomY(e),o=Kt.arrayAtomX(e));let r=t.booleanArray(!1,s),a=t.idxSort(n);const h=i*i;for(let t=1;t<s-1;t++){for(let e=t-1;e>=0;e--){let s=n[a[t]]-n[a[e]];if(s>i)break;y(s,o[a[t]]-o[a[e]])<h&&(r[a[t]]=!0,r[a[e]]=!0)}for(let e=t+1;e<s;e++){let s=n[a[e]]-n[a[t]];if(s>i)break;y(s,o[a[e]]-o[a[t]])<h&&(r[a[t]]=!0,r[a[e]]=!0)}}return r}static overlappingAtomList(e,i){return null==i&&(i=Wt.OVERLAP_THRESHOLD),t.add(t.maskIdx(Wt.overlappingAtomMask(e,i)),1)}static congestionPoint(t,e,i,s){null==s&&(s=1e-5);let n=0,o=t.numAtoms;for(let l=1;l<=o;l++)n+=1/(s+y(t.atomX(l)-e,t.atomY(l)-i));return n}static congestionMolecule(t,e){null==e&&(e=1e-5);let i=0;const s=t.numAtoms;let n=Kt.arrayAtomX(t),o=Kt.arrayAtomY(t);for(let t=0;t<s-1;t++)for(let l=t+1;l<s;l++)i+=1/(e+y(n[t]-n[l],o[t]-o[l]));return i}static translateMolecule(t,e,i){for(let s=1;s<=t.numAtoms;s++)t.setAtomPos(s,t.atomX(s)+e,t.atomY(s)+i)}static rotateMolecule(t,e,i,s){if(null==i||null==s){let e=t.boundary();i=e.midX(),s=e.midY()}let n=Math.cos(e),o=Math.sin(e);for(let e=1;e<=t.numAtoms;e++){let l=t.atomX(e)-i,r=t.atomY(e)-s;t.setAtomPos(e,i+l*n-r*o,s+l*o+r*n)}}static rotateBond(t,e,i,s){if(s=B(s),Math.abs(s)<.1*S)return;let n=bt.fromMolecule(t);n.isolateNode(e-1);let o=n.calculateComponents(),l=t.atomX(e),r=t.atomY(e),a=Math.cos(s),h=Math.sin(s);for(let e=1;e<=t.numAtoms;e++)if(o[e-1]==o[i-1]){let i=t.atomX(e)-l,s=t.atomY(e)-r;t.setAtomPos(e,l+i*a-s*h,r+i*h+s*a)}}static rotateAtoms(t,e,i,s,n){let o=Math.cos(n),l=Math.sin(n);for(let n=1;n<=t.numAtoms;n++)if(e[n-1]){let e=t.atomX(n)-i,r=t.atomY(n)-s;t.setAtomPos(n,i+e*o-r*l,s+e*l+r*o)}}static angleNeighbours(e,i){let s=e.atomAdjList(i);if(s.length<=1)return null;let n=[];for(let t=0;t<s.length;t++)n.push(Math.atan2(e.atomY(s[t])-e.atomY(i),e.atomX(s[t])-e.atomX(i)));if(2==s.length)return N(n[1],n[0])>0?s:[s[1],s[0]];let o=t.idxSort(n);return t.idxGet(s,o)}static mergeAtoms(t,e,i){for(let s=1;s<=t.numBonds;s++)t.bondFrom(s)==e&&t.setBondFrom(s,i),t.bondTo(s)==e&&t.setBondTo(s,i);t.deleteAtomAndBonds(e)}static normaliseBondDistances(e){const i=e.numBonds;if(0==i)return;let s=[];for(let t=1;t<=i;t++){let i=e.bondFrom(t),n=e.bondTo(t);s.push(y(e.atomX(n)-e.atomX(i),e.atomY(n)-e.atomY(i)))}t.sort(s);let n=1&~i?.5*(Math.sqrt(s[i>>1])+Math.sqrt(s[(i>>1)-1])):Math.sqrt(s[i>>1]);if(n<.1||n>.9*Vt.IDEALBOND&&n<1.1*Vt.IDEALBOND)return;let o=e.boundary(),l=o.midX(),r=o.midY(),a=Vt.IDEALBOND/n;for(let t=e.numAtoms;t>=1;t--){let i=(e.atomX(t)-l)*a+l,s=(e.atomY(t)-r)*a+r;e.setAtomPos(t,i,s)}}static centreMolecule(e){if(Kt.isBlank(e))return;let i=Kt.arrayAtomX(e),s=Kt.arrayAtomY(e),n=i.length,o=1/n,l=t.sum(i)*o,r=t.sum(s)*o,a=Number.POSITIVE_INFINITY,h=0,u=0;for(let t=0;t<n;t++){let e=y(i[t]-l,s[t]-r);e<a&&(h=-i[t],u=-s[t],a=e)}for(let t=0;t<n;t++)e.setAtomPos(t+1,i[t]+h,s[t]+u)}static mirrorImage(t){t=t.clone();for(let e=1;e<=t.numAtoms;e++)t.setAtomX(e,-t.atomX(e));for(let e=1;e<=t.numBonds;e++)t.bondType(e)==Vt.BONDTYPE_DECLINED?t.setBondType(e,Vt.BONDTYPE_INCLINED):t.bondType(e)==Vt.BONDTYPE_INCLINED&&t.setBondType(e,Vt.BONDTYPE_DECLINED);return t}static alignOrientFlip(t,e,i,s){if(e.length<2||e.length!=s.length)throw"Invalid mapping indices.";let n=t.atomX(e[0]),o=t.atomY(e[0]);Wt.translateMolecule(i,n-i.atomX(s[0]),o-i.atomY(s[0]));const l=e.length-1;let r=[],a=[],h=0,u=0;for(let m=0;m<l;m++){r.push(Math.atan2(t.atomY(e[m+1])-o,t.atomX(e[m+1])-n)),a.push(Math.atan2(i.atomY(s[m+1])-o,i.atomX(s[m+1])-n));let l=N(r[m],a[m]),d=N(r[m],-a[m]);l<-175*S&&h>0?l+=E:l>175*S&&h<0&&(l-=E),d<-175*S&&u>0?d+=E:d>175*S&&u<0&&(d-=E),h+=l,u+=d}if(l>1){let t=1/l;h*=t,u*=t}let m=0,d=0;for(let t=0;t<l;t++)m+=Math.abs(N(r[t],a[t]+h)),d+=Math.abs(N(r[t],-a[t]+u));if(d<m){for(let t=1;t<=i.numAtoms;t++)i.setAtomY(t,2*o-i.atomY(t));for(let t=1;t<=i.numBonds;t++)i.bondType(t)==Vt.BONDTYPE_DECLINED?i.setBondType(t,Vt.BONDTYPE_INCLINED):i.bondType(t)==Vt.BONDTYPE_INCLINED&&i.setBondType(t,Vt.BONDTYPE_DECLINED);Wt.rotateMolecule(i,n,o,u)}else Wt.rotateMolecule(i,n,o,h)}static atomIsWeirdLinear(t,e){let i=t.atomAdjBonds(e);if(2!=i.length)return!1;for(let e=0;e<i.length;e++)if(3==t.bondOrder(i[e]))return!1;let s=t.atomAdjList(e),n=Math.atan2(t.atomY(s[0])-t.atomY(e),t.atomX(s[0])-t.atomX(e)),o=Math.atan2(t.atomY(s[1])-t.atomY(e),t.atomX(s[1])-t.atomX(e));return Math.abs(N(n,o))>=175*S}}var Gt;Wt.OVERLAP_THRESHOLD=.2,Wt.OVERLAP_THRESHOLD_SQ=Wt.OVERLAP_THRESHOLD*Wt.OVERLAP_THRESHOLD,Wt.DEFAULT_EQUIV_TOLERANCE=.2,function(t){t[t.Linear=0]="Linear",t[t.Bent=1]="Bent",t[t.Trigonal=2]="Trigonal",t[t.Tetra1=3]="Tetra1",t[t.Tetra2=4]="Tetra2",t[t.SqPlan=5]="SqPlan",t[t.BasePyram=6]="BasePyram",t[t.TrigBip=7]="TrigBip",t[t.Octa1=8]="Octa1",t[t.Octa2=9]="Octa2"}(Gt||(Gt={}));class Qt{static placeNewAtom(t,e){let i=t.boundary(),s=i.maxX()+Vt.IDEALBOND,n=i.maxY();return t.addAtom(e,s,n)}static placeNewFragment(e,i){if(0==i.numAtoms)return;let s=[1,0,-1,1,-1,1,0,-1],n=[1,1,1,0,0,-1,-1,-1],o=t.numberArray(0,8),l=t.numberArray(0,8),r=t.numberArray(0,8),a=e.boundary(),h=i.boundary();for(let t=0;t<8;t++){let u=s[t],m=n[t];o[t]=0==t||3==t||5==t?a.minX()-h.maxX():2==t||4==t||7==t?a.maxX()-h.minX():.5*(a.minX()+a.maxX()-h.minX()-h.maxX()),l[t]=5==t||6==t||7==t?a.minY()-h.maxY():0==t||1==t||2==t?a.maxY()-h.minY():.5*(a.minY()+a.maxY()-h.minY()-h.maxY()),o[t]-=u,l[t]-=m,r[t]=Qt.fragPosScore(e,i,o[t],l[t]),u*=.25,m*=.25;for(let s=100;s>0;s--){let s=Qt.fragPosScore(e,i,o[t]+u,l[t]+m);if(s<=r[t])break;r[t]=s,o[t]+=u,l[t]+=m}for(let a=100;a>0;a--)for(let a=0;a<8;a++){u=.1*s[a],m=.1*n[a];let h=Qt.fragPosScore(e,i,o[t]+u,l[t]+m);if(h<=r[t])break;r[t]=h,o[t]+=u,l[t]+=m}}let u=0;for(let t=1;t<8;t++)r[t]>r[u]&&(u=t);i=i.clone();for(let t=1;t<=i.numAtoms;t++)i.setAtomPos(t,i.atomX(t)+o[u],i.atomY(t)+l[u]);e.append(i)}static fragPosScore(t,e,i,s){let n=0;for(let o=1;o<=t.numAtoms;o++)for(let l=1;l<=e.numAtoms;l++){let r=e.atomX(l)+i-t.atomX(o),a=e.atomY(l)+s-t.atomY(o),h=r*r+a*a;if(h<1)return 0;n+=1/h}let o=t.boundary(),l=e.boundary(),r=Math.min(l.minX()+i,o.minX()),a=Math.max(l.maxX()+i,o.maxX()),h=Math.min(l.minY()+s,o.minY()),u=Math.max(l.maxY()+s,o.maxY()),m=Math.max(1,a-r),d=Math.max(1,u-h);return n/Math.max(m/d,d/m)}static mergeOverlappingAtoms(t){return Qt.mergeFragmentsDiv(t,0)}static mergeFragmentsDiv(e,i){const s=e.numAtoms;let n=Wt.overlappingAtomMask(e),o=t.booleanArray(!1,s),l=Kt.arrayAtomX(e),r=Kt.arrayAtomY(e),a=[];for(let t=0;t<s;t++)a.push(t+1);let h=i,u=i+1;0==i&&(h=s);for(let t=1;t<=h;t++)if(n[t-1]&&!o[t-1]){0==i&&(u=t+1);for(let i=u;i<=s;i++)if(n[i-1]&&!o[i-1]){if(y(l[t-1]-l[i-1],r[t-1]-r[i-1])>Wt.OVERLAP_THRESHOLD_SQ)continue;let s=i,n=t,h=[0,0];for(let s=0;s<2;s++){let n=0==s?t:i;h[s]=("C"==e.atomElement(n)?0:1)+("X"==e.atomElement(n)?-100:0)+(0!=e.atomCharge(n)?1:0)+(0!=e.atomUnpaired(n)?1:0)+(e.atomIsotope(n)!=Vt.ISOTOPE_NATURAL?1:0)+(e.atomHExplicit(n)!=Vt.HEXPLICIT_UNKNOWN?1:0)+(Kt.hasAbbrev(e,n)?1e3:0)}h[1]>h[0]&&(s=t,n=i);for(let t=1;t<=e.numBonds;t++)e.bondFrom(t)==s&&e.setBondFrom(t,n),e.bondTo(t)==s&&e.setBondTo(t,n);o[s-1]=!0,a[s-1]=n}}for(let t=s;t>=1;t--)if(o[t-1]){t<=i&&i--,e.deleteAtomAndBonds(t);for(let e=0;e<s;e++)a[e]>t&&a[e]--}for(let t=e.numAtoms;t>i;t--)if("X"==e.atomElement(t)){e.deleteAtomAndBonds(t);for(let e=0;e<s;e++)a[e]>t&&a[e]--}return Kt.removeDuplicateBonds(e),a}static mergeFragmentsMask(e,i){let s=t.booleanArray(!1,e.numAtoms),n=e.numAtoms,o=Kt.arrayAtomX(e),l=Kt.arrayAtomY(e);for(let r=1;r<=n;r++)if(i[r-1])for(let a=1;a<=n;a++)if(!i[a-1]&&!s[a-1]&&y(o[r-1]-o[a-1],l[r-1]-l[a-1])<Wt.OVERLAP_THRESHOLD_SQ){let i=a,n=r;"C"==e.atomElement(r)&&"C"!=e.atomElement(a)&&"X"!=e.atomElement(a)&&([i,n]=[r,a]),e.atomHExplicit(n)==Vt.HEXPLICIT_UNKNOWN&&e.setAtomHExplicit(n,e.atomHExplicit(i)),e.setAtomUnpaired(n,e.atomUnpaired(n)+e.atomUnpaired(i)),e.setAtomCharge(n,e.atomCharge(n)+e.atomCharge(i)),e.setAtomExtra(n,t.concat(e.atomExtra(i),e.atomExtra(n)));for(let t=1;t<=e.numBonds;t++)e.bondFrom(t)==i&&e.setBondFrom(t,n),e.bondTo(t)==i&&e.setBondTo(t,n);s[i-1]=!0}for(let t=s.length;t>=1;t--)s[t-1]&&e.deleteAtomAndBonds(t);Kt.removeDuplicateBonds(e)}static matchAngleGeometry(e,i){if(i.length<=1)return!0;let s=Qt.GEOM_ANGLES[e],n=t.numberArray(0,i.length),o=t.booleanArray(!1,s.length);for(let e=0;e<i.length;e++)for(let e=1;e>=-1;e-=2){for(let t=0;t<i.length;t++)n[t]=(i[t]-i[0])*e;t.setTo(o,!1);let l=!0;for(let t=0;t<n.length;t++){let e=!1;for(let i=0;i<s.length;i++)if(!o[i]&&Math.abs(N(n[t],s[i]))<3*S){o[i]=!0,e=!0;break}if(!e){l=!1;break}}if(l)return!0}return!1}static primeDirections(t,e){let i=Qt.calculateNewBondAngles(t,e,1),s=Qt.exitVectors(t,e);return G.uniqueAngles(i.concat(s),2*S)}static exitVectors(t,e){let i=t.atomAdjList(e),s=i.length;if(0==s)return[0,90*S,180*S,-90*S];if(1==s)return[];let n=[],o=G.sortAngles(Wt.atomBondAngles(t,e,i));for(let t=0;t<s;t++){let e=t<s-1?t+1:0;n.push(B(o[t]+.5*q(o[e],o[t])))}return n}static calculateNewBondAngles(t,e,i){let s=t.atomAdjList(e);if(0==s.length){let i=t.atomicNumber(e);return gt.ELEMENT_BLOCKS[i]<=2?[0,90*S,180*S,-90*S]:[90*S,-90*S,30*S,150*S,210*S,-30*S,180*S,0*S]}let n=Qt.guessAtomGeometry(t,e,i),o=Wt.atomBondAngles(t,e,s);for(let t=0;t<n.length;t++){let e=Qt.mapAngleSubstituent(n[t],o);if(null!=e)return e}return[]}static guessAtomGeometry(e,i,s){let n=e.atomAdjList(i),o=n.length,l=e.atomicNumber(i),r=gt.ELEMENT_BLOCKS[l],a=gt.ELEMENT_ROWS[l],h=e.atomElement(i),u=[],m=[],d=[],c=!0;for(let t=0;t<o;t++)u.push(e.bondOrder(e.findBond(i,n[t]))),m.push(e.atomicNumber(n[t])),d.push(200*u[t]+m[t]),1!=u[t]&&(c=!0);for(let e=0;e<o-1;)d[e]>d[e+1]?(t.swap(n,e,e+1),t.swap(u,e,e+1),t.swap(m,e,e+1),t.swap(d,e,e+1),e>0&&e--):e++;let p=Wt.atomBondAngles(e,i,n);if(1==o){if("C"==h||"N"==h){if(2==u[0]&&2==s)return[Gt.Linear];if(3==u[0]&&1==s||1==u[0]&&3==s)return[Gt.Linear]}return r>2?[Gt.Octa1,Gt.Octa2]:0==s||"C"!=h&&"N"!=h&&"O"!=h?[Gt.Trigonal,Gt.Linear]:[Gt.Trigonal]}if(2==o&&Math.abs(N(p[0],p[1]))>=175*S)return r<=2?[Gt.SqPlan]:[Gt.Octa1,Gt.Octa2];let f=[];0==r?f=[Gt.Trigonal,Gt.SqPlan]:1==r?f=[Gt.Trigonal,Gt.SqPlan,Gt.Octa1,Gt.Octa2]:2==r?(f.push(Gt.Trigonal),"C"==h&&c?(f.push(Gt.Tetra1),f.push(Gt.Tetra2),f.push(Gt.SqPlan)):("C"!=h||c)&&(a<=3?(f.push(Gt.Tetra1),f.push(Gt.Tetra2),f.push(Gt.SqPlan)):(f.push(Gt.Tetra1),f.push(Gt.Tetra2),f.push(Gt.SqPlan),f.push(Gt.Octa1),f.push(Gt.Octa2)))):(f.push(Gt.Octa1),f.push(Gt.Octa2));for(let t=f.length-1;t>=0;t--)Qt.matchAngleGeometry(f[t],p)||f.splice(t,1);return f}static mapAngleSubstituent(e,i){let s=Qt.GEOM_ANGLES[e];const n=i.length,o=s.length;if(n>=o)return null;if(0==n)return s.slice(0);let l=[];for(let e=0;e<n;e++)for(let r=0;r<o;r++)for(let a=1;a>=-1;a-=2){let h=[];for(let t=0;t<o;t++)h.push(B(i[e]+a*(s[t]-s[r])));let u=t.booleanArray(!1,o),m=0;for(let t=0;t<o;t++)if(!u[t])for(let e=0;e<n;e++)if(Math.abs(N(h[t],i[e]))<3*S){u[t]=!0,m++;break}if(m==n)for(let t=0;t<o;t++)u[t]||l.push(h[t])}if(0==l.length)return null;l=G.sortAngles(l);for(let t=0;t<l.length-1;t++){let e=l[t],i=N(l[t+1],e);Math.abs(i)<5*S&&(l[t]=e+.5*i,l.splice(t+1,1),t--)}return l}static refitAtomGeometry(e,i,s){let n=Qt.GEOM_ANGLES[s],o=n.length,l=e.atomAdjList(i),r=l.length;if(r<=1||r>o)return null;let a=Wt.atomBondAngles(e,i,l),h=t.booleanArray(!1,r),u=!0;for(let t=0;t<r;t++)h[t]=e.bondInRing(e.findBond(i,l[t])),h[t]||(u=!1);if(u)return null;let m=null,d=0,c=Kt.calculateWalkWeight(e,i);for(let e=0;e<o;e++)for(let i=0;i<r;i++)for(let s=1;s>=-1;s-=2){let u=t.numberArray(0,r),p=t.booleanArray(!1,o);for(let t=0;t<r;t++){let l=-1,r=0;for(let h=0;h<o;h++)if(!p[h]){let o=B(n[h]*s-n[e]+a[i]),m=Math.abs(N(o,a[t]));(l<0||m<r)&&(l=h,r=m,u[t]=o)}p[l]=!0}let f=!1;for(let t=0;t<r;t++)if(h[t]&&Math.abs(N(u[t],a[t]))>2*S){f=!0;break}if(f)continue;let g=0;for(let t=0;t<r;t++)g+=c[l[t]-1]*Math.abs(N(u[t],a[t]));(null==m||g<d)&&(m=u,d=g)}if(null==m)return null;let p=!0;for(let t=0;t<r;t++)if(Math.abs(N(m[t],a[t]))>2*S){p=!1;break}if(p)return null;e=e.clone();for(let t=0;t<r;t++)h[t]||Wt.rotateBond(e,i,l[t],m[t]-a[t]);return e}static switchAtomGeometry(e,i,s,n){let o=0,l=0,r=0,a=0,h=e.atomAdjList(i),u=Wt.atomBondAngles(e,i,h),m=t.numberArray(0,u.length-1),d=e.atomX(i),c=e.atomY(i);for(let t=0;t<s.length;t++){let i=h.indexOf(s[t]),p=u[i];for(let t=0,e=0;t<h.length;t++)t!=i&&(m[e++]=u[t]);let f=b(e.atomX(s[t])-d,e.atomY(s[t])-c);for(let i=0;i<n.length;i++){if(h.length>=Qt.GEOM_ANGLES[n[i]].length)continue;let u=Qt.mapAngleSubstituent(n[i],m);if(null!=u)for(let i=0;i<u.length;i++){let n=N(u[i],p);if(!(Math.abs(n)<3*S)&&(n<0&&(n+=E),0==o||n<l-2*S||n<l+2*S&&s[t]<o)){let h=d+f*Math.cos(u[i]),m=c+f*Math.sin(u[i]);if(0!=Wt.atomAtPoint(e,h,m))continue;o=s[t],l=n,r=h,a=m}}break}}return 0==o?null:((e=e.clone()).setAtomPos(o,r,a),e)}static pickAtomsToConnect(t,e){if(e.length<2)return null;if(2==e.length)return t.findBond(e[0],e[1])>0?null:e;const i=v(Vt.IDEALBOND+.1);let s=Number.MAX_VALUE,n=0,o=0,l=[];for(let r=0;r<e.length-1;r++)for(let a=r+1;a<e.length;a++){if(t.findBond(e[r],e[a])>0)continue;let h=y(t.atomX(e[r])-t.atomX(e[a]),t.atomY(e[r])-t.atomY(e[a]));h<i?(l.push(e[r]),l.push(e[a])):h<s&&(s=h,n=e[r],o=e[a])}return 0==l.length&&0!=n&&(l.push(n),l.push(o)),0==l.length?null:l}static pickNewAtomDirection(t,e,i){if(1==i.length)return i[0];let s=i[0],n=Number.MAX_VALUE;for(let o=0;o<i.length;o++){let l=t.atomX(e)+Vt.IDEALBOND*Math.cos(i[o]),r=t.atomY(e)+Vt.IDEALBOND*Math.sin(i[o]),a=Wt.congestionPoint(t,l,r);a>n||(Wt.overlapsAtom(t,l,r,.2)&&(a+=1e5),a<n&&(s=i[o],n=a))}return s}static joinOverlappingAtoms(e,i){e=e.clone(),i=i.slice(0);const s=e.numAtoms;let n=Kt.arrayAtomX(e),o=Kt.arrayAtomY(e),l=[],r=[],a=[];for(let t=0;t<s-1;t++)if(i[t]){let h=[t+1],u=n[t],m=o[t];for(let l=t+1;l<s;l++)if(i[l]){if(y(n[l]-n[t],o[l]-o[t])>Wt.OVERLAP_THRESHOLD_SQ)continue;h.push(l+1),u+=n[l],m+=o[l];let i=e.atomAdjBonds(l+1);for(let s=0;s<i.length;s++)e.bondFrom(i[s])==l+1?e.setBondFrom(i[s],t+1):e.bondTo(i[s])==l+1&&e.setBondTo(i[s],t+1)}if(1==h.length)continue;l.push(h),r.push(u/h.length),a.push(m/h.length)}if(0==l.length)return null;let h=t.booleanArray(!0,s);for(let t=0;t<l.length;t++){let i=l[t];e.setAtomPos(i[0],r[t],a[t]);for(let t=1;t<i.length;t++)h[i[t]-1]=!1}return e=Kt.subgraphMask(e,h),Kt.removeDuplicateBonds(e),e}static moveToEdge(t,e,i,s){let n=!1,o=!1,l=0,r=0,a=0,h=0,u=0,m=0,d=0,c=0;for(let i=1;i<=t.numAtoms;i++){let s=t.atomX(i),p=t.atomY(i);e[i-1]?((!n||s<l)&&(l=s),(!n||p<r)&&(r=p),(!n||s>a)&&(a=s),(!n||p>h)&&(h=p),n=!0):((!o||s<u)&&(u=s),(!o||p<m)&&(m=p),(!o||s>d)&&(d=s),(!o||p>c)&&(c=p),o=!0)}const p=.9;if(i<0&&0==s&&a<=u-p||i>0&&0==s&&l>=d+p||0==i&&s<0&&h<=m-p||0==i&&s>0&&r>=c+p)return null;t=t.clone();let f=0,g=0;i<0&&(f=u-a-1),i>0&&(f=d-l+1),s<0&&(g=m-h-1),s>0&&(g=c-r+1);for(let i=1;i<=t.numAtoms;i++)e[i-1]&&t.setAtomPos(i,t.atomX(i)+f,t.atomY(i)+g);return t}static placeAdditionalHydrogens(t,e,i){let s=t.numAtoms;const n=t.atomX(e),o=t.atomY(e);let l=t.atomAdjList(e);if(2==l.length&&2==i){const i=Math.atan2(t.atomY(l[0])-o,t.atomX(l[0])-n),r=Math.atan2(t.atomY(l[1])-o,t.atomX(l[1])-n);if(Math.abs(N(i,r))<170*S){let l=.5*(i+r)+Math.PI,a=l-30*S,h=l+30*S;return t.addAtom("H",n+Vt.IDEALBOND*Math.cos(a),o+Vt.IDEALBOND*Math.sin(a)),t.addAtom("H",n+Vt.IDEALBOND*Math.cos(h),o+Vt.IDEALBOND*Math.sin(h)),t.addBond(e,s+1,1),void t.addBond(e,s+2,1)}}if(1==l.length&&3==i){let i=Math.atan2(t.atomY(l[0])-o,t.atomX(l[0])-n),r=i+90*S,a=i+180*S,h=i+270*S;return t.addAtom("H",n+Vt.IDEALBOND*Math.cos(r),o+Vt.IDEALBOND*Math.sin(r)),t.addAtom("H",n+Vt.IDEALBOND*Math.cos(a),o+Vt.IDEALBOND*Math.sin(a)),t.addAtom("H",n+Vt.IDEALBOND*Math.cos(h),o+Vt.IDEALBOND*Math.sin(h)),t.addBond(e,s+1,1),t.addBond(e,s+2,1),void t.addBond(e,s+3,1)}let r=Qt.pickNewAtomDirection(t,e,Qt.primeDirections(t,e));t.addAtom("H",n+Vt.IDEALBOND*Math.cos(r),o+Vt.IDEALBOND*Math.sin(r)),t.addBond(e,s+1,1),i>1&&Qt.placeAdditionalHydrogens(t,e,i-1)}static allViableDirections(t,e,i){if(0==t.atomAdjCount(e)){let t=[];for(let e=0;e<12;e++)t.push(30*S);return t}let s=t.atomAdjList(e),n=Qt.exitVectors(t,e),o=Qt.guessAtomGeometry(t,e,i);1==s.length&&o.indexOf(Gt.Linear)<0&&o.push(Gt.Linear);let l=Wt.atomBondAngles(t,e,s);for(let t of o){let e=Qt.mapAngleSubstituent(t,l);if(null!=e)for(let t of e)n.push(t)}return G.uniqueAngles(n,2*S)}static proposeNewRing(t,e,i,s,n,o,l){let r=0==o&&0==n?.5*Math.PI:Math.atan2(o,n);if(l){const t=30*S;r=Math.round(r/t)*t}return Qt.positionSimpleRing(t,e,i,s,r)}static proposeAtomRing(e,i,s,n,o){let l=[],r=e.atomX(s),a=e.atomY(s);if(0==e.atomAdjCount(s))for(let t=0;t<12;t++)l.push(E*t/12);else if(1==e.atomAdjCount(s)){let t=e.atomAdjList(s)[0];l.push(B(Math.atan2(e.atomY(t)-a,e.atomX(t)-r)+Math.PI))}else{let i=[];for(let t of e.atomAdjList(s))i.push(Math.atan2(e.atomY(t)-a,e.atomX(t)-r));i=function(e){if(null==e||e.length<2)return e;e=e.slice(0);for(let t=0;t<e.length;t++)e[t]=B(e[t]);for(t.sort(e);;){let t=e[e.length-1],i=e[0],s=e[1];if(N(i,t)<=N(s,i))break;for(let t=e.length-1;t>0;t--)e[t]=e[t-1];e[0]=t}return e}(i);for(let t=0;t<i.length;t++){let e=i[t],s=i[t<i.length-1?t+1:0];l.push(e+.5*q(s,e))}}let h=Math.atan2(o,n),u=0,m=Number.MAX_VALUE;for(let t of l){let e=Math.abs(N(t,h));e<m&&(u=t,m=e)}return Qt.positionSimpleRing(e,i,e.atomX(s),e.atomY(s),u)}static proposeBondRing(t,e,i,s,n){let o=t.bondFrom(i),l=t.bondTo(i),r=t.atomX(l)-t.atomX(o),a=t.atomY(l)-t.atomY(o),h=s*a-n*r,u=h>0?-90*S:90*S,m=Math.atan2(a,r)+u,d=E/e,c=Vt.IDEALBOND/(2*Math.sin(.5*d)),p=c*Math.cos(.5*d),f=.5*(t.atomX(o)+t.atomX(l))+p*Math.cos(m),g=.5*(t.atomY(o)+t.atomY(l))+p*Math.sin(m),b=[],y=[];for(let t=0;t<e;t++){let e=m-Math.PI+(t-.5)*d;b.push(f+Math.cos(e)*c),y.push(g+Math.sin(e)*c)}let[x,A]=h<0?[o,l]:[l,o];return b[0]=t.atomX(x),y[0]=t.atomY(x),b[1]=t.atomX(A),y[1]=t.atomY(A),[b,y]}static positionSimpleRing(t,e,i,s,n){let o=E/e,l=Vt.IDEALBOND/(2*Math.sin(.5*o)),r=i+l*Math.cos(n),a=s+l*Math.sin(n),h=[],u=[];for(let t=0;t<e;t++){let e=n-Math.PI+t*o;h.push(r+Math.cos(e)*l),u.push(a+Math.sin(e)*l)}return[h,u]}static guidelineSprouts(e,i){let s=[],n=[],o=[];for(let s=0;s<3;s++){n.push(Qt.allViableDirections(e,i,s+1)),o.push([s+1]);for(let e=0;e<s;e++)null!=n[e]&&t.equals(n[s],n[e])&&(n[s]=null,o[e].push(s+1))}const l=e.atomX(i),r=e.atomY(i);for(let t=0;t<3;t++)if(null!=n[t]){let e={atom:i,orders:o[t],x:[],y:[]};for(let i=0;i<n[t].length;i++)e.x[i]=l+Math.cos(n[t][i])*Vt.IDEALBOND,e.y[i]=r+Math.sin(n[t][i])*Vt.IDEALBOND;s.push(e)}return s}}Qt.GEOM_ANGLES=[[0,180*S],[0,120*S],[0,120*S,240*S],[0,90*S,150*S,240*S],[0,120*S,180*S,240*S],[0,90*S,180*S,270*S],[0,90*S,150*S,210*S,270*S],[0,60*S,90*S,180*S,210*S],[0,60*S,120*S,180*S,240*S,300*S],[0,45*S,90*S,180*S,225*S,270*S]];class Kt{static isBlank(t){return null==t||0==t.numAtoms}static notBlank(t){return null!=t&&t.numAtoms>0}static orBlank(t){return null==t?new Vt:t}static hasAnyAbbrev(t){for(let e=1;e<=t.numAtoms;e++)if(Kt.hasAbbrev(t,e))return!0;return!1}static hasAbbrev(t,e){let i=t.atomExtra(e);for(let t=0;t<(null==i?0:i.length);t++)if(i[t].startsWith("a"))return!0;return!1}static getAbbrev(t,e){let i=t.atomExtra(e);for(let t=0;t<(null!=i?i.length:0);t++)if(i[t].startsWith("a"))return Vt.fromString(i[t].substring(1));return null}static setAbbrev(t,e,i){let s=0;for(let t=1;t<=i.numAtoms;t++)if(i.atomElement(t)==Kt.ABBREV_ATTACHMENT){s=t;break}if(0==s)throw"No attachment points indicated.";if(s>=2&&(i=i.clone()).swapAtoms(s,1),t.atomAdjList(e).length>1)throw"Setting abbreviation for non-terminal atom.";if(1==i.atomAdjCount(1)&&t.atomAdjCount(e)>0){let s=t.findBond(e,t.atomAdjList(e)[0]),n=i.findBond(1,i.atomAdjList(1)[0]);t.setBondOrder(s,i.bondOrder(n))}let n=t.atomExtra(e),o=-1;for(let t=0;t<(null!=n?n.length:0);t++)if(n[t].startsWith("a")){o=t;break}o<0&&(o=n.push(null)-1),n[o]="a"+i.toString(),t.setAtomExtra(e,n)}static validateAbbrevs(t){for(let e=1;e<=t.numAtoms;e++)Kt.hasAbbrev(t,e)&&(t.atomAdjCount(e)>1&&Kt.clearAbbrev(t,e),0!=t.atomCharge(e)&&t.setAtomCharge(e,0),0!=t.atomUnpaired(e)&&t.setAtomUnpaired(e,0),0!=t.atomIsotope(e)&&t.setAtomIsotope(e,Vt.ISOTOPE_NATURAL),t.atomHExplicit(e)!=Vt.HEXPLICIT_UNKNOWN&&t.setAtomHExplicit(e,Vt.HEXPLICIT_UNKNOWN))}static convertToAbbrev(t,e,i){let s=this.convertToAbbrevIndex(t,e,i);return s?s[0]:null}static convertToAbbrevIndex(e,i,s){let n=0,o=null;for(let t=1;t<=e.numBonds;t++){let s=e.bondFrom(t),l=e.bondTo(t),r=0;if(i[s-1]&&!i[l-1]?(r=s,o=Ot.getPolymerExtensions(e,l)):!i[s-1]&&i[l-1]&&(r=l,o=Ot.getPolymerExtensions(e,s)),0!=r){if(n>0&&r!=n)return[null,null];n=r}}if(0==n)return[null,null];let l=e.numAtoms,r=0,a=0,h=t.booleanArray(!1,l),u=t.booleanArray(!1,l);for(let t=0;t<l;t++)h[t]=i[t],u[t]=!i[t]||t+1==n,h[t]&&t+1<=n&&r++,u[t]&&t+1<=n&&a++;let m=Vt.BONDTYPE_NORMAL,d=0;for(let t of e.atomAdjList(n))if(!i[t-1]){if(0!=d){m=Vt.BONDTYPE_NORMAL;break}let i=e.findBond(n,t);e.bondFrom(i)==n&&(m=e.bondType(i)),d++}let c=Kt.subgraphMask(e,u);c.setAtomElement(a,Kt.ABBREV_ATTACHMENT),c.setAtomCharge(a,0),c.setAtomUnpaired(a,0),c.setAtomHExplicit(a,Vt.HEXPLICIT_UNKNOWN);for(let t=1;t<=c.numAtoms;t++)c.setAtomMapNum(t,0);c.setAtomExtra(a,[]),c.setAtomTransient(a,[]);let p=c.atomAdjList(a),f=0,g=0,b=1/p.length,y=1;for(let t=0;t<p.length;t++){f+=c.atomX(p[t]),g+=c.atomY(p[t]);let e=c.findBond(a,p[t]);0==t?y=c.bondOrder(e):y!=c.bondOrder(e)&&(y=1)}f*=b,g*=b,a>1&&c.swapAtoms(a,1);let x=Kt.subgraphMask(e,h),A=x.addAtom(s,f,g);return x.addBond(r,A,y,m),Kt.setAbbrev(x,A,c),null!=o&&x.setAtomExtra(A,t.concat(x.atomExtra(A),o)),[x,A]}static expandAbbrevs(t,e){for(;;){let i=!1;for(let s=1;s<=t.numAtoms;s++)Kt.hasAbbrev(t,s)&&(Kt.expandOneAbbrev(t,s,e)&&(i=!0),s--);if(!i)break}}static expandedAbbrevs(t){return this.hasAnyAbbrev(t)?(t=t.clone(),this.expandAbbrevs(t,!0),t):t}static expandOneAbbrev(t,e,i){let s=Kt.getAbbrev(t,e);if(null==s)return null;if(1!=t.atomAdjCount(e)||0==s.numAtoms)return Kt.clearAbbrev(t,e),null;let n=t.atomMapNum(e);for(let t=1;t<=s.numAtoms;t++)s.setAtomMapNum(t,0);if(n>0)for(let t of s.atomAdjList(1))s.setAtomMapNum(t,n);return Kt.expandOneAbbrevFrag(t,e,s,i)}static expandOneAbbrevFrag(e,i,s,n){let o=Ot.getPolymerExtensions(e,i),l=1==e.atomAdjCount(i)?e.atomAdjList(i)[0]:0,r=e.findBond(i,l),a=Vt.BONDTYPE_NORMAL;if(r>0&&(a=e.bondType(r),e.bondFrom(r)==l||a!=Vt.BONDTYPE_INCLINED&&a!=Vt.BONDTYPE_DECLINED||(a=Vt.BONDTYPE_NORMAL)),n){let t=e.atomX(i)-e.atomX(l),n=e.atomY(i)-e.atomY(l),o=s.atomAdjList(1),r=0,a=0,h=1/o.length;for(let t=0;t<o.length;t++)r+=s.atomX(o[t])-s.atomX(1),a+=s.atomY(o[t])-s.atomY(1);r*=h,a*=h;let u=Math.atan2(n,t),m=Math.atan2(a,r);Wt.rotateMolecule(s,u-m),Wt.translateMolecule(s,e.atomX(l)-s.atomX(1),e.atomY(l)-s.atomY(1))}if(null!=o)for(let e=1;e<=s.numAtoms;e++){let i=s.atomExtra(e);for(let t=i.length-1;t>=0;t--)o.indexOf(i[t])>=0&&i.splice(t,1);s.setAtomExtra(e,t.concat(i,o))}let h=e.numAtoms+1;e.append(s);for(let t=1;t<=e.numBonds;t++)e.bondFrom(t)==h?(e.setBondFrom(t,l),e.setBondType(t,a)):e.bondTo(t)==h&&(e.setBondFromTo(t,l,e.bondFrom(t)),e.setBondType(t,a));let u=t.booleanArray(!1,e.numAtoms);for(let t=u.length-s.numAtoms;t<u.length;t++)u[t]=!0;return e.deleteAtomAndBonds(h),e.deleteAtomAndBonds(i),u.splice(h-1,1),u.splice(i-1,1),u}static clearAbbrev(t,e){let i=t.atomExtra(e);for(let s=0;s<(null!=i?i.length:0);s++)if(i[s].startsWith("a"))return i.splice(s,1),t.setAtomExtra(e,i),void t.setAtomElement(e,"C")}static setAtomElement(t,e,i){t.atomElement(e)!=i&&(this.clearAbbrev(t,e),t.setAtomElement(e,i))}static addBond(t,e,i,s,n){null==n&&(n=Vt.BONDTYPE_NORMAL),t.atomAdjCount(e)>=1&&this.clearAbbrev(t,e),t.atomAdjCount(i)>=1&&this.clearAbbrev(t,i);let o=t.findBond(e,i);return o>0&&t.deleteBond(o),t.addBond(e,i,s,n)}static subgraphMask(t,e){let i=[],s=0;for(let n=0;n<t.numAtoms;n++)e[n]?i.push(++s):i.push(0);if(0==s)return new Vt;if(s==t.numAtoms)return t.clone();let n=new Vt;n.keepTransient=!0;for(let i=1;i<=t.numAtoms;i++)if(e[i-1]){let e=n.addAtom(t.atomElement(i),t.atomX(i),t.atomY(i),t.atomCharge(i),t.atomUnpaired(i));n.setAtomIsotope(e,t.atomIsotope(i)),n.setAtomHExplicit(e,t.atomHExplicit(i)),n.setAtomMapNum(e,t.atomMapNum(i)),n.setAtomExtra(e,t.atomExtra(i)),n.setAtomTransient(e,t.atomTransient(i))}for(let e=1;e<=t.numBonds;e++){let s=i[t.bondFrom(e)-1],o=i[t.bondTo(e)-1];if(s>0&&o>0){let i=n.addBond(s,o,t.bondOrder(e),t.bondType(e));n.setBondExtra(i,t.bondExtra(e)),n.setBondTransient(i,t.bondTransient(e))}}return n.keepTransient=t.keepTransient,n}static subgraphIndex(e,i){let s=t.numberArray(0,e.numAtoms);for(let t=0;t<s.length;t++)s[t]=0;for(let t=0;t<i.length;t++)s[i[t]-1]=t+1;let n=new Vt;n.keepTransient=!0;for(let t=0;t<i.length;t++){let s=n.addAtom(e.atomElement(i[t]),e.atomX(i[t]),e.atomY(i[t]),e.atomCharge(i[t]),e.atomUnpaired(i[t]));n.setAtomIsotope(s,e.atomIsotope(i[t])),n.setAtomHExplicit(s,e.atomHExplicit(i[t])),n.setAtomMapNum(s,e.atomMapNum(i[t])),n.setAtomExtra(s,e.atomExtra(i[t])),n.setAtomTransient(s,e.atomTransient(i[t]))}for(let t=1;t<=e.numBonds;t++){let i=s[e.bondFrom(t)-1],o=s[e.bondTo(t)-1];if(i>0&&o>0){let s=n.addBond(i,o,e.bondOrder(t),e.bondType(t));n.setBondExtra(s,e.bondExtra(t)),n.setBondTransient(s,e.bondTransient(t))}}return n.keepTransient=e.keepTransient,n}static subgraphWithAttachments(t,e){let i=e.slice(0);for(let s=1;s<=t.numBonds;s++){let n=t.bondFrom(s)-1,o=t.bondTo(s)-1;e[n]&&!e[o]?i[o]=!0:e[o]&&!e[n]&&(i[n]=!0)}let s=t.clone();for(let t=1;t<=s.numAtoms;t++)i[t-1]&&!e[t-1]&&(s.setAtomElement(t,"X"),s.setAtomCharge(t,0),s.setAtomUnpaired(t,0),s.setAtomHExplicit(t,Vt.HEXPLICIT_UNKNOWN),s.setAtomExtra(t,[]));return Kt.subgraphMask(s,i)}static append(t,e){let i=t.boundary(),s=e.boundary(),n=i.maxX()+Vt.IDEALBOND-s.minX(),o=.5*(i.minY()+i.maxY()-s.minY()-s.maxY()),l=t.numAtoms;t.append(e);for(let e=l+1;e<=t.numAtoms;e++)t.setAtomPos(e,t.atomX(e)+n,t.atomY(e)+o)}static deleteAtoms(e,i){let s=t.booleanArray(!0,e.numAtoms);for(let t=0;t<i.length;t++)s[i[t]-1]=!1;return Kt.subgraphMask(e,s)}static componentList(e){if(0==e.numAtoms)return null;let i=bt.fromMolecule(e).calculateComponentGroups();for(let e of i)t.addTo(e,1);return i}static getAtomSides(e,i){let s=bt.fromMolecule(e),n=s.calculateComponents(),o=[];for(let t=0;t<n.length;t++)o.push(n[t]==n[i-1]);o[i-1]=!1;let l=t.maskIdx(o);s.keepNodesMask(o),n=s.calculateComponents();let r=t.max(n),a=[];for(let t=0;t<r;t++)a.push([i]);for(let t=0;t<n.length;t++)a[n[t]-1].push(l[t]+1);return a}static getBondSides(e,i){let s=e.bondFrom(i),n=e.bondTo(i),o=e.bondInRing(i),l=bt.fromMolecule(e),r=l.calculateComponents(),a=[];for(let t=0;t<r.length;t++)a.push(r[t]==r[s-1]);o?(a[s-1]=!1,a[n-1]=!1):l.removeEdge(s-1,n-1);let h=t.maskIdx(a);l.keepNodesMask(a),r=l.calculateComponents();let u=t.max(r),m=[];for(let t=0;t<u;t++)m[t]=[],o&&(m[t].push(s),m[t].push(n));for(let t=0;t<r.length;t++)m[r[t]-1].push(h[t]+1);return m}static arrayAtomX(e){let i=t.numberArray(0,e.numAtoms);for(let t=i.length-1;t>=0;t--)i[t]=e.atomX(t+1);return i}static arrayAtomY(e){let i=t.numberArray(0,e.numAtoms);for(let t=i.length-1;t>=0;t--)i[t]=e.atomY(t+1);return i}static arrayAtomMapNum(e){let i=t.numberArray(0,e.numAtoms);for(let t=i.length-1;t>=0;t--)i[t]=e.atomMapNum(t+1);return i}static molecularFormula(e,i){let s="",n="",o="",l="";1==i?[s,n]=["{","}","{^","}"]:i instanceof Array&&(s=i[0],n=i[1],o=i[2],l=i[3]);for(let t=1;t<=e.numAtoms;t++)if(Kt.hasAbbrev(e,t)){e=e.clone(),Kt.expandAbbrevs(e,!1);break}let r=0,a=0,h=t.stringArray("",e.numAtoms);for(let t=1;t<=e.numAtoms;t++){a+=e.atomHydrogens(t);let i=e.atomElement(t);e.atomIsotope(t)!=Vt.ISOTOPE_NATURAL&&(i=o+e.atomIsotope(t)+l+i),"C"==i?r++:"H"==i?a++:h[t-1]=i}h.sort();let u="";r>0&&(u+="C"),r>1&&(i&&(u+=s),u+=r,i&&(u+=n)),a>0&&(u+="H"),a>1&&(i&&(u+=s),u+=a,i&&(u+=n));for(let t=0;t<h.length;t++)if(h[t].length>0){let e=1;for(;t+1<h.length&&h[t]==h[t+1];t++)e++;u+=h[t],e>1&&(i&&(u+=s),u+=e,i&&(u+=n))}return u.toString()}static molecularWeight(t){for(let e=1;e<=t.numAtoms;e++)if(Kt.hasAbbrev(t,e)){t=t.clone(),Kt.expandAbbrevs(t,!1);break}let e=0;for(let i=1;i<=t.numAtoms;i++){e+=t.atomHydrogens(i)*gt.NATURAL_ATOMIC_WEIGHTS[1];let s=t.atomIsotope(i);if(s!=Vt.ISOTOPE_NATURAL){e+=s;continue}let n=Vt.elementAtomicNumber(t.atomElement(i));n>0&&n<gt.NATURAL_ATOMIC_WEIGHTS.length&&(e+=gt.NATURAL_ATOMIC_WEIGHTS[n])}return e}static removeDuplicateBonds(e){let i=[];for(let t=1;t<=e.numBonds;t++){let s=Math.min(e.bondFrom(t),e.bondTo(t))*e.numAtoms+Math.max(e.bondFrom(t),e.bondTo(t));i.push(s)}let s=t.idxSort(i),n=t.booleanArray(!1,s.length),o=0;for(;o<s.length;){let t=1;for(;o+t<s.length&&i[s[o]]==i[s[o+t]];)t++;let l=o;for(let i=o+1;i<o+t;i++){let t=s[l]+1,n=s[i]+1,o=e.bondFrom(t),r=e.bondTo(t),a=e.atomElement(o),h=e.atomElement(r),u=0,m=0;if("C"==a||"N"==a?u=4:"O"==a&&(u=3),"C"==h||"N"==h?m=4:"O"==h&&(m=3),u>0||m>0){let s=0,a=0,h=0,d=0;for(let i=1;i<=e.numBonds;i++)i==n||e.bondFrom(i)!=o&&e.bondTo(i)!=o||(s+=e.bondOrder(i)),i==n||e.bondFrom(i)!=r&&e.bondTo(i)!=r||(a+=e.bondOrder(i)),i==t||e.bondFrom(i)!=o&&e.bondTo(i)!=o||(h+=e.bondOrder(i)),i==t||e.bondFrom(i)!=r&&e.bondTo(i)!=r||(d+=e.bondOrder(i));let c=0,p=0;if(u>0&&s>u&&c++,m>0&&a>m&&c++,u>0&&h>u&&p++,m>0&&d>m&&p++,c<p)continue;if(c>p){l=i;continue}}let d=2*e.bondOrder(t),c=2*e.bondOrder(n);d+=(0==d?4:0)+(e.bondType(t)!=Vt.BONDTYPE_NORMAL?1:0),c+=(0==c?4:0)+(e.bondType(n)!=Vt.BONDTYPE_NORMAL?1:0),c>d&&(l=i)}n[s[l]]=!0,o+=t}for(let t=e.numBonds;t>=1;t--)n[t-1]&&e.bondFrom(t)!=e.bondTo(t)||e.deleteBond(t)}static calculateWalkWeight(e,i){let s=0,n=bt.fromMolecule(e).calculateComponents();for(let t=0;t<n.length;t++)n[t]==n[i-1]&&s++;let o=t.numberArray(1,e.numAtoms),l=t.numberArray(0,e.numAtoms);for(o[i-1]=0;s>0;s--){for(let t=0;t<e.numAtoms;t++)l[t]=o[t];for(let t=1;t<=e.numBonds;t++){let i=e.bondFrom(t)-1,s=e.bondTo(t)-1;o[i]+=.1*l[s],o[s]+=.1*l[i]}o[i-1]=0}return o}static totalHydrogens(t,e){let i=t.atomHydrogens(e),s=t.atomAdjList(e);for(let e=0;e<s.length;e++)"H"==t.atomElement(s[e])&&i++;return i}static stripHydrogens(t,e=!1){for(let i=t.numAtoms;i>=1;i--)(e&&"H"==t.atomElement(i)||this.boringHydrogen(t,i))&&t.deleteAtomAndBonds(i)}static boringHydrogen(e,i){if("H"!=e.atomElement(i))return!1;if(0!=e.atomCharge(i)||0!=e.atomUnpaired(i))return!1;if(e.atomIsotope(i)!=Vt.ISOTOPE_NATURAL)return!1;if(t.notBlank(e.atomExtra(i))||t.notBlank(e.atomTransient(i)))return!1;if(1!=e.atomAdjCount(i))return!1;let s=e.atomAdjList(i)[0];if("H"==e.atomElement(s))return!1;let n=e.atomAdjBonds(i)[0];return 1==e.bondOrder(n)&&e.bondType(n)==Vt.BONDTYPE_NORMAL&&e.atomHExplicit(s)==Vt.HEXPLICIT_UNKNOWN&&!(Vt.HYVALENCE_EL.indexOf(e.atomElement(s))<0)}static createHydrogens(t,e){null==e&&(e=!1);let i=t.numAtoms;for(let s=1;s<=i;s++){let i=t.atomHydrogens(s);if(0!=i)if(t.atomHExplicit(s)!=Vt.HEXPLICIT_UNKNOWN&&t.setAtomHExplicit(s,0),e)Qt.placeAdditionalHydrogens(t,s,i);else for(;i>0;i--){let e=t.addAtom("H",t.atomX(s),t.atomY(s));t.addBond(s,e,1)}}return t.numAtoms-i}static atomVec3(t,e){return t.is3D()?[t.atomX(e),t.atomY(e),t.atomZ(e)]:[t.atomX(e),t.atomY(e),0]}static atomOxidationState(t,e){if(0==t.atomAdjCount(e))return null;if(this.hasAbbrev(t,e))return null;let i=t.atomicNumber(e);if(0==i)return null;let s=i==gt.ELEMENT_H||2==gt.ELEMENT_BLOCKS[i],n=t.atomHydrogens(e)+(s?-t.atomCharge(e):t.atomCharge(e));for(let i of t.atomAdjBonds(e)){let o=t.bondOrder(i),l=t.bondOther(i,e),r=["O","S","Se","Te"].includes(t.atomElement(l));n+=s||r?o:o%2}return i==gt.ELEMENT_H&&1==n||i==gt.ELEMENT_B&&3==n||i==gt.ELEMENT_C&&4==n||i==gt.ELEMENT_N&&3==n||i==gt.ELEMENT_O&&2==n?null:(i!=gt.ELEMENT_S||2!=n&&4!=n&&6!=n)&&(i!=gt.ELEMENT_P||3!=n&&5!=n)&&(i!=gt.ELEMENT_F&&i!=gt.ELEMENT_Cl&&i!=gt.ELEMENT_Br&&i!=gt.ELEMENT_I||1!=n)?n:null}static oxidationStateText(t){if(0==t)return"0";let e=t<0?"-":"",i=Math.abs(t);return 1==i?e+="I":2==i?e+="II":3==i?e+="III":4==i?e+="IV":5==i?e+="V":6==i?e+="VI":7==i?e+="VII":8==i?e+="VIII":9==i?e+="IX":10==i?e+="X":11==i?e+="XI":12==i?e+="XII":e=(t>0?"+":"")+t,e}}Kt.TEMPLATE_ATTACHMENT="X",Kt.ABBREV_ATTACHMENT="*";const $t=require("fs");var Zt=i(606);class Jt{generate(t){return e=this,i=void 0,n=function*(){throw new Error("InChI not implemented.")},new((s=void 0)||(s=Promise))((function(t,o){function l(t){try{a(n.next(t))}catch(t){o(t)}}function r(t){try{a(n.throw(t))}catch(t){o(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(l,r)}a((n=n.apply(e,i||[])).next())}));var e,i,s,n}}let te=null,ee=null;class ie extends Jt{constructor(){if(super(),this.available=!1,this.inchiPath=te,this.inchiPath||(this.inchiPath=(0,Zt.getGlobal)("INCHI_EXEC")),this.inchiPath)try{$t.accessSync(this.inchiPath,$t.constants.X_OK),this.available=!0}catch(t){}}static hasExecutable(){return!!te}static setExecutable(t){te=t}static isAvailable(){return null!=this.nativeMolfileToInChI||(ee||(ee=new ie),ee.available)}generate(t){return e=this,s=void 0,o=function*(){t=t.clone(),Kt.expandAbbrevs(t,!0);for(let e=1;e<=t.numBonds;e++)(t.bondOrder(e)<1||t.bondOrder(e)>3)&&t.setBondOrder(e,1);let e=new Yt(t);e.enhancedFields=!1;let s=e.write();if(null!=ie.nativeMolfileToInChI)return{inchi:yield ie.nativeMolfileToInChI(s,"-AuxNone -NoLabels"),inchiKey:null};if(ee||(ee=new ie),!ee.available)throw"InChI executable is not available.";const n=i(317);let o=ee.inchiPath.replace(/ /g,"\\ "),l=n.spawnSync(o,["-STDIO","-AuxNone","-NoLabels","-Key"],{input:s}).stdout.toString(),r=l.split("\n");if(r.length<2||!r[0].startsWith("InChI="))throw console.log("InChI command returned result:\n"+l),console.log("Molecule:\n"+t),console.log("MDL Molfile:\n"+s),"Invalid returned by InChI generator: "+l;return{inchi:r[0],inchiKey:r[1]}},new((n=void 0)||(n=Promise))((function(t,i){function l(t){try{a(o.next(t))}catch(t){i(t)}}function r(t){try{a(o.throw(t))}catch(t){i(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof n?i:new n((function(t){t(i)}))).then(l,r)}a((o=o.apply(e,s||[])).next())}));var e,s,n,o}}ie.nativeMolfileToInChI=null;class se{constructor(t){this.root=t,this.inchi=new ie,it("body").css({overflow:"hidden"}),t.css({width:"100%",height:document.documentElement.clientHeight+"px"}),window.addEventListener("resize",(()=>this.onResize())),t.css({"user-select":"none"}),this.root.el.addEventListener("menuAction",((t,e)=>this.menuAction(e)))}loadFile(t){}onResize(){this.root.css({height:document.documentElement.clientHeight+"px"})}menuAction(t){t==pt.NewMixture?Bs("MixturePanel"):t==pt.NewCollection?Bs("CollectionPanel"):t==pt.Open?this.actionFileOpen():t==pt.Save?this.actionFileSave():t==pt.SaveAs?this.actionFileSaveAs():this.customMenuAction(t)}customMenuAction(t){console.log("MENU:"+t)}}var ne;class oe{copyEvent(t,e){return!1}pasteEvent(t){return!1}}class le{constructor(){this.handlers=[new oe]}pushHandler(t){this.handlers.push(t)}popHandler(){this.handlers.pop()}currentHandler(){return t.last(this.handlers)}triggerCopy(t){this.currentHandler().copyEvent(t,this)||document.execCommand(t?"cut":"copy")}triggerPaste(){this.currentHandler().pasteEvent(this)||document.execCommand("paste")}getString(){return null}setString(t){}setImage(t){}canSetHTML(){return!1}setHTML(t){}canAlwaysGet(){return!1}downloadString(t,e){}}!function(t){t.pc="http://purl.obolibrary.org/obo/UO_0000187",t.pcWV="http://purl.obolibrary.org/obo/UO_0000164",t.pcWW="http://purl.obolibrary.org/obo/UO_0000163",t.pcVV="http://purl.obolibrary.org/obo/UO_0000205",t.pcMM="http://purl.obolibrary.org/obo/UO_0000076",t.ratio="http://purl.obolibrary.org/obo/UO_0000190",t.mol_L="http://purl.obolibrary.org/obo/UO_0000062",t.mmol_L="http://purl.obolibrary.org/obo/UO_0000063",t.umol_L="http://purl.obolibrary.org/obo/UO_0000064",t.nmol_L="http://purl.obolibrary.org/obo/UO_0000065",t.pmol_L="http://purl.obolibrary.org/obo/UO_0000066",t.g_L="http://purl.obolibrary.org/obo/UO_0000175",t.mg_L="http://purl.obolibrary.org/obo/UO_0000273",t.ug_L="http://purl.obolibrary.org/obo/UO_0000275",t.mol_kg="http://purl.obolibrary.org/obo/UO_0000068",t.kg="http://purl.obolibrary.org/obo/UO_0000009",t.g="http://purl.obolibrary.org/obo/UO_0000021",t.mg="http://purl.obolibrary.org/obo/UO_0000022",t.ug="http://purl.obolibrary.org/obo/UO_0000023",t.ng="http://purl.obolibrary.org/obo/UO_0000024",t.L="http://purl.obolibrary.org/obo/UO_0000099",t.mL="http://purl.obolibrary.org/obo/UO_0000098",t.uL="http://purl.obolibrary.org/obo/UO_0000101",t.nL="http://purl.obolibrary.org/obo/UO_0000102",t.mol="http://purl.obolibrary.org/obo/UO_0000013",t.mmol="http://purl.obolibrary.org/obo/UO_0000040",t.umol="http://purl.obolibrary.org/obo/UO_0000039",t.nmol="http://purl.obolibrary.org/obo/UO_0000041",t.ppm="placeholder1",t.ppb="placeholder2"}(ne||(ne={}));const re=[[ne.pc,"%"],[ne.pcWV,"w/v%"],[ne.pcWW,"w/w%"],[ne.pcVV,"v/v%"],[ne.pcMM,"mol/mol%"],[ne.ratio,"ratio"],[ne.mol_L,"mol/L","M"],[ne.mmol_L,"mmol/L","mM"],[ne.umol_L,"mol/L","umol/L","uM"],[ne.nmol_L,"nmol/L","nM"],[ne.pmol_L,"pmol/L","pM"],[ne.g_L,"g/L"],[ne.mg_L,"mg/L"],[ne.ug_L,"g/L","ug/L"],[ne.mol_kg,"mol/kg"],[ne.kg,"kg"],[ne.g,"g"],[ne.mg,"mg"],[ne.ug,"g","ug"],[ne.ng,"ng"],[ne.L,"L"],[ne.mL,"mL"],[ne.uL,"L","uL"],[ne.nL,"nL"],[ne.mol,"mol"],[ne.mmol,"mmol"],[ne.umol,"mol","umol"],[ne.nmol,"nmol"],[ne.ppm,"ppm"],[ne.ppb,"ppb"]],ae=[[ne.pc,"pp",1],[ne.pcWV,"wv",.01],[ne.pcWW,"wf",.01],[ne.pcVV,"vf",.01],[ne.pcMM,"mf",.01],[ne.ratio,"rt",1],[ne.mol_L,"mr",1],[ne.mmol_L,"mr",.001],[ne.umol_L,"mr",1e-6],[ne.nmol_L,"mr",1e-9],[ne.pmol_L,"mr",1e-12],[ne.g_L,"wv",.001],[ne.mg_L,"wv",1e-6],[ne.ug_L,"wv",1e-9],[ne.mol_kg,"mb",1],[ne.ppm,"pp",1e-6],[ne.ppb,"pp",1e-9]];class he{static setup(){for(let t of re){let e=t[0],i=t[1];this.STANDARD_LIST.push(e),this.COMMON_NAMES.push(i),this.URI_TO_NAME[e]=i;for(let i=1;i<=t.length;i++)this.NAME_TO_URI[t[i]]=e}for(let t of ae){let e=t[0],i=t[1],s=t[2];this.URI_TO_MINCHI[e]=[i,s]}this.setup=()=>{}}static standardList(){return this.setup(),this.STANDARD_LIST}static commonNames(){return this.setup(),this.COMMON_NAMES}static uriToName(t){return this.setup(),this.URI_TO_NAME[t]}static nameToURI(t){return this.setup(),this.NAME_TO_URI[t]}static convertToMInChI(e,i){let[s,n]=this.URI_TO_MINCHI[e]||[null,null];return s?[s,t.mul(i,n)]:[null,null]}}var ue,me;he.STANDARD_LIST=[],he.COMMON_NAMES=[],he.URI_TO_NAME={},he.NAME_TO_URI={},he.URI_TO_MINCHI={},function(t){t[t.O0=0]="O0",t[t.O01=1]="O01",t[t.O1=2]="O1",t[t.O12=3]="O12",t[t.O2=4]="O2",t[t.O23=5]="O23",t[t.O3=6]="O3",t[t.O3X=7]="O3X"}(ue||(ue={})),function(t){t[t.N1X=-3]="N1X",t[t.N1=-2]="N1",t[t.N01=-1]="N01",t[t.Z0=0]="Z0",t[t.P01=1]="P01",t[t.P1=2]="P1",t[t.P1X=3]="P1X"}(me||(me={}));class de{constructor(t){this.mol=t,this.paths=[],t&&this.calculate()}clone(){let t=new de(null);return t.mol=this.mol,t.maskBlock=this.maskBlock,t.paths=this.paths.slice(0),t}getBondOrders(){const t=this.mol;let e=[];for(let i=1;i<=t.numBonds;i++)e.push(t.bondOrder(i));for(let t of this.paths){let i=t.numer/t.denom;for(let t=1;t<=5;t++)T(i,t)&&(i=t);for(let s of t.bonds)e[s-1]=i}return e}getBondClasses(){const t=this.mol;let e=[];for(let i=1;i<=t.numBonds;i++){let s=t.bondOrder(i);e.push(0==s?0:1==s?2:2==s?4:3==s?6:7)}for(let t of this.paths){let i=t.numer/t.denom,s=T(i,0)?0:T(i,1)?2:T(i,2)?4:T(i,3)?6:i<1?1:i<2?3:i<3?5:7;for(let i of t.bonds)e[i-1]=s}return e}getChargeClasses(){const t=this.mol;let e=[];for(let i=1;i<=t.numAtoms;i++){let s=t.atomCharge(i);e.push(0==s?0:-1==s?-2:1==s?2:s<-1?-3:3)}for(let i of this.paths){let s=0;for(let e of i.atoms)s+=t.atomCharge(e);s/=i.atoms.length;let n=T(s,0)?0:T(s,-1)?-2:T(s,1)?2:s>-1&&s<0?-1:s>0&&s<1?1:s<-1?-3:3;for(let t of i.atoms)e[t-1]=n}return e}getAggregateCharges(){const t=this.mol;let e=[];for(let i=1;i<=t.numAtoms;i++)e[i-1]=t.atomCharge(i);for(let t of this.paths){let i=0;for(let s of t.atoms)i+=e[s-1];for(let s of t.atoms)e[s-1]=i}return e}toString(){let t="blocking="+JSON.stringify(this.maskBlock)+"; paths="+this.paths.length;for(let e of this.paths)t+=" ["+e.numer+"/"+e.denom+";a="+JSON.stringify(e.atoms)+";b="+JSON.stringify(e.bonds)+"]";return t}calculate(){const e=this.mol,i=e.numAtoms,s=e.numBonds;let n=t.booleanArray(!1,i),o=t.booleanArray(!1,i),l=t.booleanArray(!1,i),r=t.numberArray(0,i);for(let t=0;t<i;t++)r[t]=e.atomHydrogens(t+1);for(let t=1;t<=s;t++){let i=e.bondOrder(t),s=e.bondFrom(t),a=e.bondTo(t);if(1!=i&&(n[s-1]=!0,n[a-1]=!0),i>=2)o[s-1]=!0,o[a-1]=!0;else{let t=gt.ELEMENT_BLOCKS[e.atomicNumber(s)],i=gt.ELEMENT_BLOCKS[e.atomicNumber(a)];(t>=3||i>=3)&&(l[s-1]=!0,l[a-1]=!0)}r[s-1]+=i,r[a-1]+=i,e.bondTransient(t).indexOf(wt.BondAromatic)>=0&&(o[s-1]=!0,o[a-1]=!0)}let a=t.booleanArray(!1,i);for(let t=1;t<=i;t++)if(!o[t-1]){let i=0;for(let s of e.atomAdjList(t))(o[s-1]||l[s-1])&&i++;i>=2&&(a[t-1]=!0)}for(let t=0;t<i;t++)a[t]&&(o[t]=!0);this.maskBlock=t.booleanArray(!1,i);let h=t.booleanArray(!1,i);const u=[gt.ELEMENT_H,gt.ELEMENT_B,gt.ELEMENT_C,gt.ELEMENT_N,gt.ELEMENT_O,gt.ELEMENT_F,gt.ELEMENT_Al,gt.ELEMENT_Si,gt.ELEMENT_P,gt.ELEMENT_S,gt.ELEMENT_Cl,gt.ELEMENT_Ga,gt.ELEMENT_Ge,gt.ELEMENT_As,gt.ELEMENT_Se,gt.ELEMENT_Br,gt.ELEMENT_In,gt.ELEMENT_Sn,gt.ELEMENT_Sb,gt.ELEMENT_Te,gt.ELEMENT_I,gt.ELEMENT_Tl,gt.ELEMENT_Pb,gt.ELEMENT_Bi,gt.ELEMENT_Po,gt.ELEMENT_At],m=[gt.ELEMENT_B,gt.ELEMENT_Al,gt.ELEMENT_Si,gt.ELEMENT_Ga,gt.ELEMENT_Ge,gt.ELEMENT_In,gt.ELEMENT_Sn,gt.ELEMENT_Tl,gt.ELEMENT_Pb],d=[gt.ELEMENT_N,gt.ELEMENT_O,gt.ELEMENT_F,gt.ELEMENT_P,gt.ELEMENT_S,gt.ELEMENT_Cl,gt.ELEMENT_As,gt.ELEMENT_Se,gt.ELEMENT_Br,gt.ELEMENT_Sb,gt.ELEMENT_Te,gt.ELEMENT_I,gt.ELEMENT_Bi,gt.ELEMENT_Po,gt.ELEMENT_At];t:for(let t=0;t<i;t++){const i=t+1;if(n[t]||o[t])continue;if(0!=e.atomCharge(i)||0!=e.atomUnpaired(i))continue;const s=e.atomicNumber(i);if(0!=s){if(!(u.indexOf(s)<0)&&r[t]==gt.ELEMENT_BONDING[s]){if(m.indexOf(s)>=0)for(let t of e.atomAdjList(i))if(d.indexOf(e.atomicNumber(t))>=0)continue t;if(d.indexOf(s)>=0)for(let t of e.atomAdjList(i))if(m.indexOf(e.atomicNumber(t))>=0)continue t;if(h[t]=!0,s==gt.ELEMENT_C){let s=!1;for(let t of e.atomAdjList(i))u.indexOf(e.atomicNumber(t))<0&&(s=!0);s||(this.maskBlock[t]=!0)}else s==gt.ELEMENT_H&&(this.maskBlock[t]=!0)}}else this.maskBlock[t]=!0}t:for(let t=0;t<i;t++)if(h[t]&&!this.maskBlock[t]){for(let i of e.atomAdjList(t+1))if(!h[i-1])continue t;this.maskBlock[t]=!0}let c=bt.fromMolecule(e);for(let t=0;t<i;t++)this.maskBlock[t]&&c.isolateNode(t);for(let n of c.calculateComponentGroups()){if(1==n.length)continue;let o=t.idxMask(n,i);t.addTo(n,1);let l={atoms:n,bonds:[],numer:0,denom:0};for(let t=1;t<=s;t++)o[e.bondFrom(t)-1]&&o[e.bondTo(t)-1]&&l.bonds.push(t);let r=0,a=0;for(let t of l.atoms){let i=e.atomHydrogens(t);for(let s of e.atomAdjList(t))o[s-1]||i++;let s=e.atomicNumber(t);r+=gt.ELEMENT_VALENCE[s]-e.atomCharge(t)-i,a+=gt.ELEMENT_SHELL[s]-gt.ELEMENT_VALENCE[s]-i}let h=Math.min(r,a);l.numer=h,l.denom=2*l.bonds.length,this.paths.push(l)}}}class ce{constructor(e){this.meta=e,this.mol=e.mol,this.priority=t.numberArray(0,this.mol.numAtoms),this.chiralTetra=t.numberArray(ce.STEREO_NONE,this.mol.numAtoms),this.cistransBond=t.numberArray(ce.STEREO_NONE,this.mol.numBonds),this.squarePlanar=t.numberArray(ce.STEREO_NONE,this.mol.numAtoms)}calculate(){this.isH=t.booleanArray(!1,this.mol.numAtoms);for(let t=this.mol.numAtoms;t>=1;t--)this.isH[t-1]="H"==this.mol.atomElement(t);this.buildPriority(),this.buildTetraChirality(),this.buildBondCisTrans(),this.buildPlanarCisTrans(),this.buildOctaChirality()}atomPriority(t){return this.priority[t-1]}atomTetraChirality(t){return this.chiralTetra[t-1]}bondSideStereo(t){return this.cistransBond[t-1]}atomPlanarStereo(t){return this.squarePlanar[t-1]}getPriorities(){return this.priority.slice(0)}getAtomTetraChiral(){return this.chiralTetra.slice(0)}getBondSideStereo(){return this.cistransBond.slice(0)}static create(t){let e=new ce(t);return e.calculate(),e}static rubricTetrahedral(e,i){if(e.atomAdjCount(i)<3||e.atomAdjCount(i)+e.atomHydrogens(i)!=4)return null;let s=e.atomAdjBonds(i),n=!1;for(let t=0;t<s.length;t++){let o=e.bondType(s[t]);if(o==Vt.BONDTYPE_UNKNOWN)return null;e.bondFrom(s[t])==i&&(o!=Vt.BONDTYPE_INCLINED&&o!=Vt.BONDTYPE_DECLINED||(n=!0))}if(!n&&!e.is3D())return null;let o=e.atomAdjList(i),l=[0,0,0,0],r=[0,0,0,0],a=[0,0,0,0],h=0,u=0;for(let t=0;t<s.length;t++){const n=e.bondFrom(s[t]),p=e.bondType(s[t]);if(l[t]=e.atomX(o[t])-e.atomX(i),r[t]=e.atomY(o[t])-e.atomY(i),e.is3D()?a[t]=e.atomZ(o[t])-e.atomZ(i):n==i&&(p==Vt.BONDTYPE_INCLINED?(a[t]=1,u++):p==Vt.BONDTYPE_DECLINED&&(a[t]=-1,u++)),m=l[t],d=r[t],c=a[t],Math.hypot(m,d,c)<1e-4&&(h++,h>1))return null}var m,d,c;if(3==s.length)if(o.push(0),e.is3D()||1!=u){l[3]=-(l[0]+l[1]+l[2]),r[3]=-(r[0]+r[1]+r[2]),a[3]=-(a[0]+a[1]+a[2]);let t=x(l[3],r[3],a[3]);if(t<1e-4)return null;let e=1/Math.sqrt(t);l[3]*=e,r[3]*=e,a[3]*=e}else{let t=Math.atan2(r[0],l[0]),e=Math.atan2(r[1],l[1]),i=Math.atan2(r[2],l[2]),s=1,n=2;q(e,t)>q(i,t)&&(n=1,s=2),l[0]=1.5,r[0]=0,l[1]=-.75,r[s]=1.3,l[2]=-.75,r[n]=-1.3}let p=0,f=0;for(let t=1;t<=6;t++){let e=0,i=0;1==t?(e=1,i=2):2==t?(e=2,i=3):3==t?(e=3,i=1):4==t?(e=2,i=1):5==t?(e=3,i=2):6==t&&(e=1,i=3);let s=r[e]*a[i]-r[i]*a[e]-l[0],n=a[e]*l[i]-a[i]*l[e]-r[0],o=l[e]*r[i]-l[i]*r[e]-a[0];t<=3?p+=s*s+n*n+o*o:f+=s*s+n*n+o*o}return f>p&&t.swap(o,2,3),o}static rubricSquarePlanar(e,i){if(4!=e.atomAdjCount(i))return null;if(!e.is3D()){let t=0,s=0;for(let n of e.atomAdjBonds(i)){let i=e.bondType(n);i==Vt.BONDTYPE_INCLINED?t++:i==Vt.BONDTYPE_DECLINED&&s++}if(2==t&&2==s);else if(2==t&&0==s);else if(0!=t||2!=s)return null}let s=e.atomAdjList(i),n=Kt.atomVec3(e,i),o=t.sub(Kt.atomVec3(e,s[0]),n),l=t.sub(Kt.atomVec3(e,s[1]),n),r=t.sub(Kt.atomVec3(e,s[2]),n),a=t.sub(Kt.atomVec3(e,s[3]),n);for(let t of[o,l,r,a]){let e=x(t[0],t[1],t[2]);if(e<1e-4)continue;let i=1/Math.sqrt(e);t[0]*=i,t[1]*=i,t[2]*=i}let h=G.dist2(o,l),u=G.dist2(o,r),m=G.dist2(o,a);h>u&&h>=m?(t.swap(s,1,2),[l,r]=[r,l]):m>u&&(t.swap(s,3,2),[r,a]=[a,r]);const d=(e.is3D()?80:45)*S,c=(e.is3D()?100:135)*S,p=G.acuteAngle(o,l);if(p<d||p>c)return null;const f=G.acuteAngle(l,r);if(f<d||f>c)return null;const g=G.acuteAngle(r,a);if(g<d||g>c)return null;const b=G.acuteAngle(a,o);return b<d||b>c?null:s}static rubricBipyrimidal(e,i){const s=e.atomAdjCount(i);if(4!=s&&5!=s)return null;let n=0,o=0,l=e.atomAdjList(i),r=e.atomAdjBonds(i);if(!e.is3D()){for(let t=0;t<l.length;t++)if(e.bondType(r[t])==Vt.BONDTYPE_INCLINED){if(n>0)return null;n=l[t]}else if(e.bondType(r[t])==Vt.BONDTYPE_DECLINED){if(o>0)return null;o=l[t]}if(0==n||0==o)return null;let t=Math.atan2(e.atomY(n)-e.atomY(i),e.atomX(n)-e.atomX(i)),s=Math.atan2(e.atomY(o)-e.atomY(i),e.atomX(o)-e.atomX(i));if(Math.abs(N(t,s))>160*S)return null}let a=Kt.atomVec3(e,i),h=[[],[],[],[],[]];for(let i=0;i<s;i++){h[i]=t.sub(Kt.atomVec3(e,l[i]),a);const s=G.magnitude(h[i]);if(s<.1)return null;t.mulBy(h[i],1/s),l[i]==n?h[i][2]+=1:l[i]==o&&(h[i][2]-=1)}let u=0,m=0;const d=175*S;for(let t=0;t<s-1;t++)if(l[t]!=n&&l[t]!=o)for(let e=t+1;e<s;e++)if(l[e]!=n&&l[e]!=o&&G.acuteAngle(h[t],h[e])>d){if(0!=u)return null;u=l[t],m=l[e]}if(e.is3D())for(let t of l)t!=u&&t!=m&&(0==n?n=t:0==o&&(o=t));if(!u||!m)return null;let c=null,p=h[l.indexOf(n)],f=h[l.indexOf(o)],g=h[l.indexOf(u)],b=h[l.indexOf(m)],y=0;if(5==s){for(let t=0;t<s;t++)if(l[t]!=n&&l[t]!=o&&l[t]!=u&&l[t]!=m){y=l[t],c=h[t];break}}else{c=[0,0,0],c=t.sub(c,p),c=t.sub(c,f);const e=G.magnitude(c);if(e<.1)return null;t.mulBy(c,1/e)}let x=t.sub(b,g),A=G.crossProduct(x,c);return G.dist2(A,p)<G.dist2(A,f)?[y,n,o,u,m]:[y,n,o,m,u]}static rubricOctahedral(e,i){const s=e.atomAdjCount(i);if(5!=s&&6!=s)return null;let n=e.atomAdjList(i),o=e.atomAdjBonds(i);if(5==s&&(n.push(0),o.push(0)),!e.is3D()){let t=0;for(let i of o)if(i>0){const s=e.bondType(i);s!=Vt.BONDTYPE_INCLINED&&s!=Vt.BONDTYPE_DECLINED||t++}if(5==s&&t<1||6==s&&t<2)return null}let l=Kt.atomVec3(e,i),r=[[],[],[],[],[],[]];for(let a=0;a<s;a++){r[a]=Kt.atomVec3(e,n[a]),t.subFromArray(r[a],l);let s=G.magnitude(r[a]);if(s<.1)return null;t.mulBy(r[a],1/s);let h=e.bondType(o[a]);h==Vt.BONDTYPE_INCLINED?e.bondFrom(o[a])==i?r[a][2]+=1:r[a][2]-=1:h==Vt.BONDTYPE_DECLINED&&(e.bondFrom(o[a])==i?r[a][2]-=1:r[a][2]+=1)}if(5==s){r[5]=[0,0,0];for(let e=0;e<5;e++)t.subFromArray(r[5],r[e]);let e=G.magnitude(r[5]);if(e<.1)return null;t.mulBy(r[5],1/e)}let a=[-1,-1,-1,-1,0,1],h=G.acuteAngle(r[0],r[1]);for(let t=0;t<5;t++)for(let e=0==t?2:t+1;e<6;e++){let i=G.acuteAngle(r[t],r[e]);i>h&&(a[4]=t,a[5]=e,h=i)}let u=t.sub(r[a[5]],r[a[4]]),m=Number.POSITIVE_INFINITY;for(let t=0;t<6;t++)if(t!=a[4]&&t!=a[5]){let e=Math.abs(90*S-G.acuteAngle(r[t],u));e<m&&(a[0]=t,m=e)}for(let t=1;t<=2;t++){let e=G.crossProduct(u,r[a[t-1]]),i=Number.POSITIVE_INFINITY;for(let s=0;s<6;s++){if(s==a[4]||s==a[5]||s==a[0]||s==a[1])continue;let n=G.acuteAngle(r[s],e);n<i&&(a[t]=s,i=n)}}for(let t=0;t<6;t++)if(a.indexOf(t)<0){a[3]=t;break}let d=[0,0,0,0,0,0];for(let t=0;t<6;t++)d[t]=a[t]<0?0:n[a[t]];return d}static rubricBondSides(e,i){const s=e.bondFrom(i),n=e.bondTo(i),o=e.atomAdjCount(s),l=e.atomAdjCount(n);if(o<2||o>3||l<2||l>3)return null;let r=e.atomAdjList(s),a=e.atomAdjList(n),h=0,u=0,m=0,d=0;for(let t=0;t<r.length;t++)r[t]!=n&&(0==h?h=r[t]:u=r[t]);for(let t=0;t<a.length;t++)a[t]!=s&&(0==m?m=a[t]:d=a[t]);if(h>0&&u>0&&"H"==e.atomElement(h)){let t=h;h=u,u=t}if(m>0&&d>0&&"H"==e.atomElement(m)){let t=m;m=d,d=t}let c=Kt.atomVec3(e,s),p=Kt.atomVec3(e,n),f=t.sub(p,c),g=t.sub(Kt.atomVec3(e,h),c),b=t.sub(Kt.atomVec3(e,m),p);const y=.1*.1;let x=G.crossProduct(g,f);if(G.magnitude2(x)<y)return null;let A=G.crossProduct(b,f);if(G.magnitude2(A)<y)return null;let v=t.neg(x),M=G.dist2(x,A)<G.dist2(v,A),T=M,w=M,E=M,C=null,S=null,k=null,B=null,N=null;if(u>0)if(C=t.sub(Kt.atomVec3(e,u),c),G.magnitude2(C)<y){if("H"!=e.atomElement(u))return null}else{if(k=G.crossProduct(C,f),G.magnitude2(k)<y)return null;N=t.neg(k),T=G.dist2(k,A)>G.dist2(N,A)}if(d>0)if(S=t.sub(Kt.atomVec3(e,d),p),G.magnitude2(S)<y){if("H"!=e.atomElement(d))return null}else{if(B=G.crossProduct(S,f),G.magnitude2(B)<y)return null;w=G.dist2(x,B)>G.dist2(v,B)}return null!=k&&null!=B&&(E=G.dist2(k,B)<G.dist2(N,B)),M&&T&&w&&E?[h,u,m,d]:M||T||w||E?null:[h,u,d,m]}buildTetraChirality(){const i=this.mol,s=i.numAtoms,n=i.numBonds;let o=t.booleanArray(!1,s);for(let t=1;t<=n;t++)i.bondType(t)!=Vt.BONDTYPE_INCLINED&&i.bondType(t)!=Vt.BONDTYPE_DECLINED||(o[i.bondFrom(t)-1]=!0);t:for(let n=1;n<=s;n++){this.chiralTetra[n-1]=ce.STEREO_NONE;let s=i.atomAdjList(n);if(4!=s.length&&(3!=s.length||1!=i.atomHydrogens(n)))continue;if(3==s.length&&(this.isH[s[0]-1]||this.isH[s[1]-1]||this.isH[s[2]-1]))continue;for(let t=0;t<s.length-1;t++)for(let e=t+1;e<s.length;e++)if(this.priority[s[t]-1]==this.priority[s[e]-1])continue t;if(!o[n-1]&&!i.is3D()){this.chiralTetra[n-1]=ce.STEREO_UNKNOWN;continue}let l=ce.rubricTetrahedral(i,n);if(null==l)continue;let r=[0==l[0]?0:this.priority[l[0]-1],0==l[1]?0:this.priority[l[1]-1],0==l[2]?0:this.priority[l[2]-1],0==l[3]?0:this.priority[l[3]-1]];r=t.idxSort(r);let a=e.parityIdentity(r);this.chiralTetra[n-1]=1&a?ce.STEREO_NEG:ce.STEREO_POS}}buildBondCisTrans(){const e=this.mol,i=(e.numAtoms,e.numBonds);let s=t.booleanArray(!1,i);for(let t=3;t<=7;t++)for(let i of e.findRingsOfSize(t))for(let t=0;t<i.length;t++)s[e.findBond(i[t],i[t<i.length-1?t+1:0])-1]=!0;t:for(let t=1;t<=i;t++){if(this.cistransBond[t-1]=ce.STEREO_NONE,2!=e.bondOrder(t)||this.meta.isBondAromatic(t)||s[t-1])continue;let i=e.bondFrom(t),n=e.bondTo(t),o=e.atomAdjList(i),l=e.atomAdjList(n);if(o.length<=1||l.length<=1||o.length>3||l.length>3)continue;if(2==o.length&&(this.isH[o[0]-1]||this.isH[o[1]-1]))continue;if(2==l.length&&(this.isH[l[0]-1]||this.isH[l[1]-1]))continue;for(let t=0;t<o.length-1;t++)if(o[t]!=i)for(let e=t+1;e<o.length;e++)if(o[e]!=i&&this.priority[o[t]-1]==this.priority[o[e]-1])continue t;for(let t=0;t<l.length-1;t++)if(l[t]!=n)for(let e=t+1;e<l.length;e++)if(l[e]!=n&&this.priority[l[t]-1]==this.priority[l[e]-1])continue t;if(e.bondType(t)==Vt.BONDTYPE_UNKNOWN){this.cistransBond[t-1]=ce.STEREO_UNKNOWN;continue}let r=ce.rubricBondSides(e,t);if(null==r)continue;let a=0==r[0]?0:this.priority[r[0]-1],h=0==r[1]?0:this.priority[r[1]-1],u=0==r[2]?0:this.priority[r[2]-1],m=0==r[3]?0:this.priority[r[3]-1];this.cistransBond[t-1]=a<h==u<m?ce.STEREO_POS:ce.STEREO_NEG}}buildPlanarCisTrans(){const t=this.mol,i=t.numAtoms;t.numBonds;t:for(let s=1;s<=i;s++){if(this.squarePlanar[s-1]=ce.STEREO_NONE,4!=t.atomAdjCount(s))continue;if(gt.ELEMENT_BLOCKS[t.atomicNumber(s)]<3)continue;let i=t.atomAdjList(s);for(let t=0;t<i.length;t++){let e=0;for(let s=0;s<i.length;s++)this.priority[i[t]-1]==this.priority[i[s]-1]&&e++;if(e>=3)continue t}let n=ce.rubricSquarePlanar(t,s);if(null==n)continue;let o=[0==n[0]?0:this.priority[n[0]-1],0==n[1]?0:this.priority[n[1]-1],0==n[2]?0:this.priority[n[2]-1],0==n[3]?0:this.priority[n[3]-1]],l=e.parityOrder(o);this.squarePlanar[s-1]=1&l?ce.STEREO_NEG:ce.STEREO_POS}}buildOctaChirality(){}buildPriority(){const e=this.mol,i=e.numAtoms,s=e.numBonds;let n=[];for(let s=0;s<i;s++)n.push(t.numberArray(-1,e.atomHydrogens(s+1)));for(let t=1;t<=s;t++){let i=e.bondFrom(t)-1,s=e.bondTo(t)-1,o=e.bondOrder(t);if(this.meta.isBondAromatic(t)&&(o=2),i!=s)for(let t=0;t<o;t++)n[i].push(s),n[s].push(i)}this.priority=t.numberArray(0,i);let o=!1;for(let t=0;t<i;t++)this.priority[t]=e.atomicNumber(t+1),1==this.priority[t]&&(o=!0);let l=[];for(let t=0;t<i;t++)l.push([]);for(;;){for(let e=0;e<i;e++){let i=n[e],s=[];for(let t=0;t<i.length;t++)s.push(i[t]<0?1:this.priority[i[t]]);t.sort(s),l[e]=s}let e=this.sortAndGroup(this.priority),s=o?0:1,r=!1;for(let t=0;t<e.length;t++){let i=e[t];for(let t=0;t<i.length-1;){const e=i[t],s=i[t+1];let n=0,o=Math.max(l[e].length,l[s].length);for(let t=0;t<o;t++){let i=t<l[e].length?l[e][t]:0,o=t<l[s].length?l[s][t]:0;if(i<o){n=-1;break}if(i>o){n=1;break}}n>0?(i[t]=s,i[t+1]=e,t>0&&t--):t++}for(let t=0;t<i.length;t++){if(0==t)s++;else if(l[i[t]].length!=l[i[t-1]].length)s++,r=!0;else for(let e=0;e<l[i[t]].length;e++)if(l[i[t]][e]!=l[i[t-1]][e]){s++,r=!0;break}this.priority[i[t]]=s}}if(!r)break}}sortAndGroup(e){let i=new Set;for(let t of e)i.add(t);let s=Array.from(i);t.sort(s);let n=[];for(let t=0;t<s.length;t++)n.push([]);for(let t=0;t<e.length;t++)n[s.indexOf(e[t])].push(t);return n}}ce.STEREO_NONE=0,ce.STEREO_POS=1,ce.STEREO_NEG=2,ce.STEREO_UNKNOWN=3,ce.STEREO_BROKEN=4,ce.RUBRIC_EQUIV_TETRA=[[0,1,2,3],[0,2,3,1],[0,3,1,2],[1,0,3,2],[1,2,0,3],[1,3,2,0],[2,0,1,3],[2,1,3,0],[2,3,0,1],[3,0,2,1],[3,1,0,2],[3,2,1,0]],ce.RUBRIC_EQUIV_SIDES=[[0,1,2,3],[1,0,3,2],[2,3,0,1],[3,2,1,0]],ce.RUBRIC_EQUIV_SQUARE=[[0,1,2,3],[0,3,2,1],[1,2,3,0],[1,0,3,2],[2,1,0,3],[2,3,0,1],[3,2,1,0],[3,0,1,2]],ce.RUBRIC_EQUIV_BIPY=[[0,1,2,3,4],[1,2,0,3,4],[2,0,1,3,4],[0,2,1,4,3],[1,0,2,4,3],[2,1,0,4,3]],ce.RUBRIC_EQUIV_OCTA=[[0,1,2,3,4,5],[0,3,2,1,5,4],[0,4,2,5,3,1],[0,5,2,4,1,3],[1,0,3,2,5,4],[1,2,3,0,4,5],[1,4,3,5,0,2],[1,5,3,4,2,0],[2,1,0,3,5,4],[2,3,0,1,4,5],[2,4,0,5,1,3],[2,5,0,4,3,1],[3,0,1,2,4,5],[3,2,1,0,5,4],[3,4,1,5,2,0],[3,5,1,4,0,2],[4,0,5,2,1,3],[4,1,5,3,2,0],[4,2,5,0,3,1],[4,3,5,1,0,2],[5,0,4,2,3,1],[5,1,4,3,0,2],[5,2,4,0,1,3],[5,3,4,1,2,0]];class pe{constructor(t){this.mol=t,this.atomArom=null,this.bondArom=null,this.rubricTetra=null,this.rubricSquare=null,this.rubricBipy=null,this.rubricOcta=null,this.rubricSides=null,this.hash=null,this.heavyHash=null,this.uniqueElements=null,this.dots=null,this.piAtom=null}calculateStrictAromaticity(){let e=this.mol;this.atomArom=t.booleanArray(!1,e.numAtoms),this.bondArom=t.booleanArray(!1,e.numBonds);let i=e.findRingsOfSize(6);const s=i.length;if(0==s)return;this.ensurePiAtoms();let n=t.booleanArray(!1,s);for(let t=0;t<s;t++)for(let s=0;s<i[t].length;s++){let o=i[t][s];if(!this.piAtom[o-1]){n[t]=!0;break}let l=e.findBond(o,i[t][s==i[t].length-1?0:s+1]),r=e.bondOrder(l);if(1!=r&&2!=r){n[t]=!0;break}}for(;;){let t=!1;for(let o=0;o<s;o++)if(!n[o]){let s=!0,l=!0;for(let t=0;t<i[o].length;t++){let n=e.findBond(i[o][t],i[o][t==i[o].length-1?0:t+1]);if(this.bondArom[n-1])continue;let r=e.bondOrder(n);s=s&&r==2-(1&t),l=l&&r==1+(1&t)}if(!s&&!l)continue;for(let t=0;t<i[o].length;t++){let s=e.findBond(i[o][t],i[o][t==i[o].length-1?0:t+1]);this.bondArom[s-1]=!0}n[o]=!0,t=!0}if(!t)break}for(let t=0;t<this.bondArom.length;t++)this.bondArom[t]&&(this.atomArom[e.bondFrom(t+1)-1]=!0,this.atomArom[e.bondTo(t+1)-1]=!0)}calculateRelaxedAromaticity(){let e=this.mol;this.atomArom=t.booleanArray(!1,e.numAtoms),this.bondArom=t.booleanArray(!1,e.numBonds),this.ensurePiAtoms();const i=e.numAtoms,s=e.numBonds;let n=t.numberArray(0,i),o=t.booleanArray(!1,i);for(let t=1;t<=i;t++){let i=e.atomicNumber(t);n[t-1]=(2==gt.ELEMENT_BLOCKS[i]?gt.ELEMENT_VALENCE[i]:0)-e.atomCharge(t)-e.atomHydrogens(t)-e.atomUnpaired(t)}for(let t=1;t<=s;t++){const i=e.bondFrom(t),s=e.bondTo(t),l=e.bondOrder(t);if(n[i-1]-=l,n[s-1]-=l,2==l){const t=e.atomRingBlock(i),n=e.atomRingBlock(s);t>0&&t!=n&&(o[i-1]=!0),n>0&&n!=t&&(o[s-1]=!0)}}let l=[];for(let t=3;t<=7;t++)for(let i of e.findRingsOfSize(t)){let s=!0;for(let l=0;l<t;l++){const r=i[l];if(!this.piAtom[r-1]&&n[r-1]<2&&!o[r-1]){s=!1;break}let a=e.findBond(r,i[l<t-1?l+1:0]),h=e.bondOrder(a);if(1!=h&&2!=h){s=!1;break}}s&&l.push(i)}for(;l.length>0;){let i=!1;for(let s=0;s<l.length;s++){let o=l[s],r=[0];for(let i=0;i<o.length;i++){const s=o[i],l=e.findBond(s,o[i<o.length-1?i+1:0]),a=e.findBond(s,o[i>0?i-1:o.length-1]);if(this.bondArom[l-1])for(let e=r.length-1;e>=0;e--){const i=r[e]+2;r.indexOf(i)<0&&(r=t.append(r,i))}else(2==e.bondOrder(l)||n[s-1]>=2&&1==e.bondOrder(l)&&1==e.bondOrder(a))&&t.addTo(r,2)}let a=!1;for(let t of r){if(2==t&&3==o.length){a=!0;break}if(6==t){a=!0;break}}if(a){for(let t=0;t<o.length;t++){let i=o[t],s=e.findBond(i,o[t<o.length-1?t+1:0]);this.atomArom[i-1]=!0,this.bondArom[s-1]=!0}l.splice(s,1),s--,i=!0}}if(!i)break}}calculateStereoRubric(){const t=this.mol,e=t.numAtoms,i=t.numBonds;this.rubricTetra=new Array(e),this.rubricSquare=new Array(e),this.rubricBipy=new Array(e),this.rubricOcta=new Array(e),this.rubricSides=new Array(i);for(let i=1;i<=e;i++){let e=gt.ELEMENT_BLOCKS[t.atomicNumber(i)],s=t.atomAdjCount(i),n=t.atomHydrogens(i),o=0,l=0;for(let e of t.atomAdjBonds(i))t.bondType(e)==Vt.BONDTYPE_INCLINED&&t.bondFrom(e)==i?o++:t.bondType(e)==Vt.BONDTYPE_DECLINED&&t.bondFrom(e)==i&&l++;(2==e&&(3==s&&1==n||4==s&&0==n)||e>=3&&4==s&&1==o&&1==l)&&(this.rubricTetra[i-1]=ce.rubricTetrahedral(t,i)),e>=3&&4==s&&0==n&&(this.rubricSquare[i-1]=ce.rubricSquarePlanar(t,i)),e>=3&&(4==s||5==s)&&0==n&&(this.rubricBipy[i-1]=ce.rubricBipyrimidal(t,i)),(e>=3&&(5==s||6==s)&&0==n||2==e&&6==s&&0==n)&&(this.rubricOcta[i-1]=ce.rubricOctahedral(t,i))}for(let e=1;e<=t.numBonds;e++){if(2!=t.bondOrder(e)||t.bondType(e)==Vt.BONDTYPE_UNKNOWN||this.isBondAromatic(e))continue;let i=t.bondFrom(e),s=t.bondTo(e),n=gt.ELEMENT_BLOCKS[t.atomicNumber(i)],o=gt.ELEMENT_BLOCKS[t.atomicNumber(s)],l=t.atomAdjCount(i),r=t.atomHydrogens(i),a=t.atomAdjCount(s),h=t.atomHydrogens(s);2==n&&2==o&&l+r==3&&r<=1&&a+h==3&&h<=1&&(this.rubricSides[e-1]=ce.rubricBondSides(t,e))}}removeHydrogens(){let e=this.mol,i=e.numAtoms,s=e.numBonds,n=t.booleanArray(!0,i),o=t.booleanArray(!0,s);for(let t=1;t<=i;t++)Kt.boringHydrogen(e,t)&&(n[t-1]=!1,o[e.atomAdjBonds(t)[0]-1]=!1);if(!t.allTrue(n)&&(e=Kt.subgraphMask(e,n),this.atomArom&&(this.atomArom=t.maskGet(this.atomArom,n)),this.bondArom&&(this.bondArom=t.maskGet(this.bondArom,o)),this.rubricTetra||this.rubricSquare||this.rubricBipy||this.rubricOcta||this.rubricSides)){this.rubricTetra&&(this.rubricTetra=t.maskGet(this.rubricTetra,n)),this.rubricSquare&&(this.rubricSquare=t.maskGet(this.rubricSquare,n)),this.rubricBipy&&(this.rubricBipy=t.maskGet(this.rubricBipy,n)),this.rubricOcta&&(this.rubricOcta=t.maskGet(this.rubricOcta,n)),this.rubricSides&&(this.rubricSides=t.maskGet(this.rubricSides,o));let e=t.prepend(t.add(t.maskMap(n),1),0);for(let i=0;i<t.len(this.rubricTetra);i++)this.rubricTetra[i]&&(this.rubricTetra[i]=t.idxGet(e,this.rubricTetra[i]));for(let i=0;i<t.len(this.rubricSquare);i++)this.rubricSquare[i]&&(this.rubricSquare[i]=t.idxGet(e,this.rubricSquare[i]));for(let i=0;i<t.len(this.rubricBipy);i++)this.rubricBipy[i]&&(this.rubricBipy[i]=t.idxGet(e,this.rubricBipy[i]));for(let i=0;i<t.len(this.rubricOcta);i++)this.rubricOcta[i]&&(this.rubricOcta[i]=t.idxGet(e,this.rubricOcta[i]));for(let i=0;i<t.len(this.rubricSides);i++)this.rubricSides[i]&&(this.rubricSides[i]=t.idxGet(e,this.rubricSides[i]))}}calculateSkeletonHash(){if(null==pe.skeletonHash)throw"Skeleton hash not available.";this.hash=pe.skeletonHash(this.mol)}calculateHeavyHash(){let t=!1;for(let e=1;e<=this.mol.numAtoms;e++)if("H"==this.mol.atomElement(e)){t=!0;break}if(!t)return void(this.heavyHash=this.getSkeletonHash());let e=this.mol.clone();for(let t=e.numAtoms;t>=1;t--)"H"==e.atomElement(t)&&e.deleteAtomAndBonds(t);this.heavyHash=pe.skeletonHash(e)}isAtomAromatic(t){return null!=this.atomArom&&this.atomArom[t-1]}isBondAromatic(t){return null!=this.bondArom&&this.bondArom[t-1]}bondOrderArom(t){return null!=this.bondArom&&this.bondArom[t-1]?-1:this.mol.bondOrder(t)}getAtomAromaticity(){return null==this.atomArom?null:this.atomArom.slice(0)}getBondAromaticity(){return null==this.bondArom?null:this.bondArom.slice(0)}getSkeletonHash(){return null==this.hash&&this.calculateSkeletonHash(),this.hash}getHeavyHash(){return null==this.heavyHash&&this.calculateHeavyHash(),this.heavyHash}getDotPath(){return null==this.dots&&(this.dots=new de(this.mol)),this.dots}getUniqueElements(){if(null==this.uniqueElements){this.uniqueElements=[];for(let t=1;t<=this.mol.numAtoms;t++){let e=this.mol.atomElement(t);this.uniqueElements.indexOf(e)<0&&this.uniqueElements.push(e)}}return this.uniqueElements}equivalentTo(t,e=1e3){if(null==pe.isomorphMatch)throw"Isomorph search unavailable.";if(this.mol.numAtoms!=t.mol.numAtoms||this.mol.numBonds!=t.mol.numBonds)return!1;if(null==this.hash&&this.calculateSkeletonHash(),null==t.hash&&t.calculateSkeletonHash(),this.hash!=t.hash)return!1;if(0==this.mol.compareTo(t.mol))return!0;let i=this.getUniqueElements(),s=t.getUniqueElements();for(let t=0;t<i.length;t++)if(!s.includes(i[t]))return!1;return pe.isomorphMatch(this,t,e)}static createRubric(t){if(null==t)return null;let e=new pe(t);return e.calculateStereoRubric(),e}static createStrict(t){if(null==t)return null;let e=new pe(t);return e.calculateStrictAromaticity(),e}static createStrictRubric(t){if(null==t)return null;let e=new pe(t);return e.calculateStrictAromaticity(),e.calculateStereoRubric(),e}static createRelaxed(t){if(null==t)return null;let e=new pe(t);return e.calculateRelaxedAromaticity(),e}static createRelaxedRubric(t){if(null==t)return null;let e=new pe(t);return e.calculateRelaxedAromaticity(),e.calculateStereoRubric(),e}ensurePiAtoms(){if(null==this.piAtom){this.piAtom=t.booleanArray(!1,this.mol.numAtoms);for(let t=1;t<=this.mol.numBonds;t++)2==this.mol.bondOrder(t)&&(this.piAtom[this.mol.bondFrom(t)-1]=!0,this.piAtom[this.mol.bondTo(t)-1]=!0)}}}pe.skeletonHash=null,pe.isomorphMatch=null;let fe=[];const ge=4294967295;function be(){return ge}function ye(t,e){return fe[255&(t^e)]^t>>>8}function xe(t){return t^ge}class Ae{constructor(t,e){this.meta=t,this.kind=e,this.hookApplyNewFP=null,this.hookConsiderNewFP=null,this.identity=[],this.resolvedChiral=[],this.atomGroup=[],this.fplist=[],this.amask=[],this.atomAdj=[],this.bondAdj=[],function(){if(!(fe.length>0))for(let t=0;t<256;t++){let e=t;for(let t=0;t<8;t++)1&e?e=3988292384^e>>>1:e>>>=1;fe.push(e)}}()}calculate(){let e=this.meta.mol,i=e.numAtoms;this.identity=t.numberArray(0,i),this.resolvedChiral=t.booleanArray(!1,i);for(let t=0;t<i;t++)this.atomGroup.push([]);this.amask=t.booleanArray(!1,i);for(let t=0;t<i;t++)this.amask[t]=e.atomicNumber(t+1)>=2&&!Kt.hasAbbrev(e,t+1),this.atomAdj.push([]),this.bondAdj.push([]);for(let t=0;t<i;t++)if(this.amask[t]){this.atomAdj[t]=e.atomAdjList(t+1),this.bondAdj[t]=e.atomAdjBonds(t+1);for(let e=this.atomAdj[t].length-1;e>=0;e--)this.amask[this.atomAdj[t][e]-1]||(this.atomAdj[t].splice(e,1),this.bondAdj[t].splice(e,1))}for(let t=0;t<i;t++)this.amask[t]&&(this.identity[t]=this.initialIdentityECFP(t+1),this.atomGroup[t]=[t+1],this.applyNewFP({hashCode:this.identity[t],iteration:0,atoms:this.atomGroup[t],centralAtom:t+1}));let s=this.kind;for(let e=1;e<=s;e++){let s=t.numberArray(0,i);for(let t=0;t<i;t++)this.amask[t]&&(s[t]=this.circularIterate(e,t+1));this.identity=s;for(let t=0;t<i;t++)this.amask[t]&&(this.atomGroup[t]=this.growAtoms(this.atomGroup[t]),this.considerNewFP({hashCode:this.identity[t],iteration:e,atoms:this.atomGroup[t],centralAtom:t+1}))}}static create(t,e){t instanceof Vt&&(t=pe.createStrictRubric(t));let i=new Ae(t,e);return i.calculate(),i}getMolecule(){return this.meta.mol}get numFP(){return this.fplist.length}getFP(t){return this.fplist[t]}getFingerprints(){return this.fplist.slice(0)}getUniqueHashes(){let e=new Set;for(let t of this.fplist)e.add(t.hashCode);return t.sorted(Array.from(e))}getFoldedHashes(e){let i=e-1,s=new Set;for(let t of this.fplist)s.add(t.hashCode&i);return t.sorted(Array.from(s))}static tanimoto(t,e){let i=0,s=0,n=t.length,o=e.length;if(0==n&&0==o)return 0;let l=0,r=0;for(;l<n||r<o;){if(l==n){s+=o-r;break}if(r==o){s+=n-l;break}let a=t[l],h=e[r];a==h?(i+=1,l+=1,r+=1):a<h?l+=1:r+=1,s+=1}return i/s}initialIdentityECFP(t){const e=this.meta.mol;let i=e.atomAdjList(t),s=0,n=e.atomHydrogens(t);for(let t of i)"H"==e.atomElement(t)?n++:s++;let o=e.atomicNumber(t),l=Math.max(0,gt.ELEMENT_BONDING[o]-n),r=e.atomCharge(t),a=e.atomRingBlock(t)>0?1:0,h=be();return h=ye(h,s<<4|l),h=ye(h,o),h=ye(h,r+128),h=ye(h,n<<4|a),xe(h)}circularIterate(i,s){let n=this.atomAdj[s-1],o=this.bondAdj[s-1],l=t.numberArray(0,2+2*n.length);l[0]=i,l[1]=this.identity[s-1];for(let t=0;t<n.length;t++)l[2*t+2]=this.meta.isBondAromatic(o[t])?15:this.meta.mol.bondOrder(o[t]),l[2*t+3]=this.identity[n[t]-1];let r=0;for(;r<n.length-1;){let e=2+2*r;l[e]>l[e+2]||l[e]==l[e+2]&&l[e+1]>l[e+3]?(t.swap(l,e,e+2),t.swap(l,e+1,e+3),r>0&&r--):r++}let a=be();for(let t=0;t<l.length;t+=2){a=ye(a,l[t]);let e=l[t+1];a=ye(a,e>>24),a=ye(a,e>>16&255),a=ye(a,e>>8&255),a=ye(a,255&e)}if(!this.resolvedChiral[s-1]&&t.len(this.meta.rubricTetra)>0&&null!=this.meta.rubricTetra[s-1]){let t=this.meta.rubricTetra[s-1],i=[0==t[0]?0:this.identity[t[0]-1],0==t[1]?0:this.identity[t[1]-1],0==t[2]?0:this.identity[t[2]-1],0==t[3]?0:this.identity[t[3]-1]];i[0]!=i[1]&&i[0]!=i[2]&&i[0]!=i[3]&&i[1]!=i[2]&&i[1]!=i[3]&&i[2]!=i[3]&&(a=ye(a,e.parityOrder(i)+1),this.resolvedChiral[s-1]=!0)}return xe(a)}growAtoms(e){let i=t.booleanArray(!1,this.meta.mol.numAtoms);for(let t=0;t<e.length;t++){i[e[t]-1]=!0;for(let s of this.atomAdj[e[t]-1])i[s-1]=!0}return t.add(t.maskIdx(i),1)}applyNewFP(t){this.hookConsiderNewFP&&this.hookConsiderNewFP(t),this.hookApplyNewFP&&this.hookApplyNewFP(t),this.fplist.push(t)}considerNewFP(e){this.hookConsiderNewFP&&this.hookConsiderNewFP(e);let i=-1,s=null;for(let n=0;n<this.fplist.length;n++){let o=this.fplist[n];if(t.equals(o.atoms,e.atoms)){s=o,i=n;break}}i<0?this.fplist.push(e):s.iteration<e.iteration||s.hashCode<e.hashCode||(this.fplist[i]=e,this.hookApplyNewFP&&this.hookApplyNewFP(e))}}Ae.CLASS_ECFP0=0,Ae.CLASS_ECFP2=1,Ae.CLASS_ECFP4=2,Ae.CLASS_ECFP6=3;class ve{static readXML(t){let e;if(e=et.customParser?(new et.customParser).parseFromString(t,"application/xml"):(new DOMParser).parseFromString(t,"application/xml"),null==e)return null;let i=e.documentElement;if(null==i)return null;let s=new Et,n=L(i,"Summary");if(null==n)return null;s.title=p(L(n,"Title")),s.description=p(L(n,"Description"));let o=L(i,"Extension");if(null!=o){let t=D(o,"Ext");for(let e=0;e<t.length;e++){let i=t[e];s.appendExtension(i.getAttribute("name"),i.getAttribute("type"),p(i))}}let l=L(i,"Header"),r=parseInt(l.getAttribute("ncols")),a=D(l,"Column");if(a.length!=r)return null;for(let t=0;t<r;t++){let e=a[t];if(parseInt(e.getAttribute("id"))!=t+1)return null;s.appendColumn(e.getAttribute("name"),e.getAttribute("type"),p(e))}let h=0;for(let t of D(L(i,"Content"),"Row")){if(parseInt(t.getAttribute("id"))!=h+1)return null;s.appendRow();for(let e of D(t,"Cell")){let t=parseInt(e.getAttribute("id"))-1,i=s.colType(t),n=p(e);""==n||("molecule"==i?s.setObject(h,t,n):"string"==i?s.setString(h,t,n):"real"==i?s.setReal(h,t,parseFloat(n)):"integer"==i?s.setInteger(h,t,parseInt(n)):"boolean"==i?s.setBoolean(h,t,"true"==n||"false"!=n&&null):"extend"==i&&s.setExtend(h,t,n)),e=e.nextElementSibling,t++}t=t.nextElementSibling,h++}return s}static readJSON(t){if(!t.colData||!t.rowData)throw"Not a JSON-formatted datasheet.";return new Et(Y(t))}static writeXML(t){let e;e=et.customParser?(new et.customParser).parseFromString("<DataSheet/>","application/xml"):(new DOMParser).parseFromString("<DataSheet/>","application/xml");let i=e.createElement("Summary");e.documentElement.appendChild(i);let s=e.createElement("Title"),n=e.createElement("Description");i.appendChild(s),s.appendChild(e.createTextNode(t.title)),i.appendChild(n),n.appendChild(e.createCDATASection(t.description));let o=e.createElement("Extension");e.documentElement.appendChild(o);for(let i=0;i<t.numExtensions;i++){let s=e.createElement("Ext");o.appendChild(s),s.setAttribute("name",t.getExtName(i)),s.setAttribute("type",t.getExtType(i)),s.appendChild(e.createCDATASection(t.getExtData(i)))}let l=e.createElement("Header");e.documentElement.appendChild(l),l.setAttribute("nrows",t.numRows.toString()),l.setAttribute("ncols",t.numCols.toString());for(let i=0;i<t.numCols;i++){let s=e.createElement("Column");l.appendChild(s),s.setAttribute("id",(i+1).toString()),s.setAttribute("name",t.colName(i)),s.setAttribute("type",t.colType(i)),s.appendChild(e.createTextNode(t.colDescr(i)))}let r=e.createElement("Content");e.documentElement.appendChild(r);for(let i=0;i<t.numRows;i++){let s=e.createElement("Row");s.setAttribute("id",(i+1).toString()),r.appendChild(s);for(let n=0;n<t.numCols;n++){let o=e.createElement("Cell");o.setAttribute("id",(n+1).toString()),s.appendChild(o);let l=t.colType(n),r=null;if(t.isNull(i,n));else if("molecule"==l){let s=t.getObject(i,n);s instanceof Vt&&(s=Ut.writeNative(s)),r=e.createCDATASection(s)}else"string"==l?r=e.createCDATASection(t.getString(i,n)):"real"==l?r=e.createTextNode(t.getReal(i,n).toString()):"integer"==l?r=e.createTextNode(t.getInteger(i,n).toString()):"boolean"==l?r=e.createTextNode(t.getBoolean(i,n).toString()):"extend"==l&&(r=e.createCDATASection(t.getExtend(i,n)));null!=r&&o.appendChild(r)}}return et.customSerial?(new et.customSerial).serializeToString(e.documentElement):(new XMLSerializer).serializeToString(e.documentElement)}static writeJSON(t){let e=t.data,i=t.numRows,s=t.numCols,n=new Array(i);for(let t=0;t<i;t++)n[t]=new Array(s);for(let o=0;o<s;o++){let s="molecule"==t.colType(o);for(let t=0;t<i;t++){let i=e.rowData[t][o];null!=i&&s&&(i=i.toString()),n[t][o]=i}}return{title:e.title,description:e.description,colData:Y(e.colData),rowData:n,extData:Y(e.extData)}}}const Me=["rings","termgrp","funcgrp","protgrp","nonplrings","largerings","crownethers","ligmonodent","ligbident","ligtrident","ligmultident","cagecmplx","aminoacids","biomolecules","saccharides"];class Te{constructor(){this.abbrevs=[]}static needsSetup(){return!this.main}static setupData(){return t=this,e=void 0,s=function*(){if(!this.main){if(!ot.RESOURCE_URL)throw"RPC resource URL not defined.";this.main=new Te;for(let t of Me){let e=ot.RESOURCE_URL+"/data/templates/"+t+".ds",i=yield j(e),s=ve.readXML(i),n=s.firstColOfType("molecule"),o=s.findColByName("Abbrev","string");if(!(n<0||o<0))for(let t=0;t<s.numRows;t++){let e=s.getMoleculeClone(t,n),i=s.getString(t,o);if(!e||!i)continue;let l=0,r=0;for(let t=1;t<=e.numAtoms;t++)e.atomElement(t)==Kt.TEMPLATE_ATTACHMENT&&(0==r&&(r=t),e.setAtomElement(t,Kt.ABBREV_ATTACHMENT),l++);1==l&&(r>1&&e.swapAtoms(1,r),this.main.submitAbbreviation(i,e))}}}},new((i=void 0)||(i=Promise))((function(n,o){function l(t){try{a(s.next(t))}catch(t){o(t)}}function r(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(l,r)}a((s=s.apply(t,e||[])).next())}));var t,e,i,s}getAbbrevs(){return this.abbrevs.slice(0)}submitAbbreviation(t,e,i=!1){let s=e.clone();this.submitFragment(t,s,i)}submitMolecule(t,e=!1){let i=t.clone();for(let t=1;t<=i.numAtoms;t++){let s=Kt.getAbbrev(i,t);s&&this.submitFragment(i.atomElement(t),s,e)}}substituteAbbrevName(e,i){let s=Kt.getAbbrev(e,i);if(!s)return!1;let n=Kt.expandedAbbrevs(s),o=Kt.molecularFormula(n),l=Ae.create(pe.createStrictRubric(n),Ae.CLASS_ECFP6).getUniqueHashes();for(let n of this.abbrevs)if(n.frag.numAtoms==s.numAtoms){let r=Wt.sketchEquivalent(s,n.frag);if(!r){let e=Kt.expandedAbbrevs(n.frag);if(o==Kt.molecularFormula(e)){let i=Ae.create(pe.createStrictRubric(e),Ae.CLASS_ECFP6).getUniqueHashes();t.equals(l,i)&&(r=!0)}}if(r)return e.setAtomElement(i,n.name),!0}return!1}submitFragment(t,e,i){if("?"==t)return;let s=0,n=0,o=e.atomAdjList(1);for(let t of o)s+=e.atomX(t)-e.atomX(1),n+=e.atomY(t)-e.atomY(1);if(o.length>1){let t=1/o.length;s*=t,n*=t}if(b(s,n)>.1*.1){let t=Math.atan2(n,s);Math.abs(t)>2*S&&Wt.rotateMolecule(e,-t)}let l=-1;for(let e=0;e<this.abbrevs.length;e++)if(this.abbrevs[e].name==t){l=e;break}let[r,a]=this.formatAbbrevLabel(t),h={name:t,frag:e,nameHTML:r,nameSearch:a};l<0?i?this.abbrevs.unshift(h):this.abbrevs.push(h):i&&l>0?(this.abbrevs.splice(l,1),this.abbrevs.unshift(h)):this.abbrevs[l]=h}formatAbbrevLabel(t){let e="",i="",s=(t,s)=>{s&&(e+="<"+s+">"),e+=X(t),i+=t,s&&(e+="</"+s+">")};for(let e of t.split("|")){for(;;){let t=e.match(/^(.*?)\{(.*?)\}(.*)$/);if(!t)break;let i=t[1],n=t[2],o=t[3];s(i,null),n.startsWith("^")?s(n.substring(1),"sup"):s(n,"sub"),e=o}s(e,null)}return[e,i.toLowerCase()]}}Te.main=null;class we{constructor(t,e,i){this.metalAtom=e,this.ligandAttach=i,this.ligands=[],this.mol=t.clone()}generate(){const{mol:e,metalAtom:i,ligandAttach:s,ligands:n}=this;let o=bt.fromMolecule(e);o.isolateNode(i-1);for(let l of o.calculateComponentGroups()){t.addTo(l,1);let o=!1;for(let t of s)if(l.indexOf(t)>=0){o=!0;break}if(!o)continue;let r={atoms:l,attach:[]};r.atoms=l;let a=!1;for(let t of r.atoms)if(e.findBond(t,i)>0){a=!0;break}for(let t of r.atoms)(e.findBond(t,i)>0||!a&&s.includes(t))&&r.attach.push(t);n.push(r);for(let t of r.attach)0==e.findBond(t,i)&&this.makeLigandBond(t)}if(0==n.length)throw new Error("No ligand atoms");let l=e.atomAdjList(i);for(let e of n)l=t.exclude(l,e.attach);let r=e.atomX(i),a=e.atomY(i),h=new Array(l.length);for(let t=0;t<l.length;t++)h[t]=Math.atan2(e.atomY(l[t])-a,e.atomX(l[t])-r);for(let i of n)if(1==i.attach.length){let t=i.attach[0];i.avgTheta=Math.atan2(e.atomY(t)-a,e.atomX(t)-r),this.orientLigand(i)}else{let s=new Array(i.attach.length);for(let t=0;t<i.attach.length;t++){let n=i.attach[t];s[t]=Math.atan2(e.atomY(n)-a,e.atomX(n)-r)}s=G.sortAngles(s);let n=s[0];for(let t=0;t<s.length;t++)s[t]=q(s[t],n);i.avgTheta=n+t.sum(s)/s.length,this.orientLigand(i)}if(0==l.length)n.sort(((t,e)=>A(t.avgTheta-e.avgTheta))),this.arrangeLigandsFree(n);else if(1==l.length)n.sort(((t,e)=>A(q(t.avgTheta,h[0])-q(e.avgTheta,h[0])))),this.arrangeLigandsRange(n,h[0],E,!0);else{let e=t.idxSort(h);for(let t=0;t<e.length;t++){let i=(t+1)%e.length,s=h[e[t]],o=q(h[e[i]],s),l=[];for(let t of n)q(t.avgTheta,s)<o&&l.push(t);0!=l.length&&(l.sort(((t,e)=>A(q(t.avgTheta,s)-q(e.avgTheta,s)))),this.arrangeLigandsRange(l,s,o,!0))}}return this.resolveClashes(),e}makeLigandBond(t){const{mol:e,metalAtom:i}=this;let s=e.atomCharge(i),n=e.atomCharge(t);if(s>0&&n<0)return e.setAtomCharge(i,s-1),e.setAtomCharge(t,n+1),void e.addBond(i,t,1);if(s<0&&n>0)return e.setAtomCharge(i,s+1),e.setAtomCharge(t,n-1),void e.addBond(i,t,1);let o=0;e.atomHExplicit(t)==Vt.HEXPLICIT_UNKNOWN&&e.atomHydrogens(t)>0&&(o=1),e.addBond(i,t,o)}orientLigand(e){const{mol:i,metalAtom:s}=this;let n=i.atomX(s),o=i.atomY(s),l=e.atoms.length,r=e.attach.length,a=new Array(r);for(let t=0;t<r;t++)a[t]=e.atoms.indexOf(e.attach[t]);let h=new Array(l),u=new Array(l),m=Kt.arrayAtomX(i),d=Kt.arrayAtomY(i),c=t.max(m)-t.min(m)+t.max(d)-t.min(d),p=c*Math.cos(e.avgTheta),f=c*Math.sin(e.avgTheta);for(let t=0;t<l;t++)h[t]=i.atomX(e.atoms[t])+p,u[t]=i.atomY(e.atoms[t])+f;let g=t.sum(h)/l,x=t.sum(u)/l,A=[];for(let t=0;t<l;t++){let e=Number.POSITIVE_INFINITY;for(let i of a)e=Math.min(e,y(h[t]-h[i],u[t]-u[i]));A.push(1/(1+Math.sqrt(e)))}let v=Number.POSITIVE_INFINITY,M=null,T=null;for(let t=0;t<360;t+=15){let i=Math.cos(t*S),s=Math.sin(t*S),r=new Array(l),a=new Array(l),m=0;for(let t=0;t<l;t++){let l=h[t]-g,d=u[t]-x;r[t]=g+l*i-d*s,a[t]=x+l*s+d*i;let c=b(r[t]-n,a[t]-o);e.attach.indexOf(e.atoms[t])>=0?m+=c:m-=c*A[t]}m<v&&(v=m,M=r,T=a)}if(h=M,u=T,1==r)p=Vt.IDEALBOND*Math.cos(e.avgTheta),f=Vt.IDEALBOND*Math.sin(e.avgTheta),t.addTo(h,n+p-h[a[0]]),t.addTo(u,o+f-u[a[0]]);else{let i=new Array(r),s=t.numberArray(0,r),m=t.numberArray(0,r),d=t.numberArray(0,r);for(let t=0;t<r;t++){let e=h[a[t]]-n,l=u[a[t]]-o;i[t]=Math.atan2(l,e),r>2&&(s[t]=b(e,l),m[t]=e/s[t],d[t]=l/s[t])}t.addTo(s,-t.min(s));let c=G.idxSortAngles(i),p=new Array(r),f=new Array(r),g=new Array(r),y=new Array(r),x=45*S/(r-1),A=e.avgTheta-.5*x;for(let t=0;t<r;t++)p[t]=h[a[c[t]]],f[t]=u[a[c[t]]],g[t]=n+Vt.IDEALBOND*Math.cos(A)+s[t]*m[t],y[t]=o+Vt.IDEALBOND*Math.sin(A)+s[t]*d[t],A+=x/(r-1);let v=G.superimpose(p,f,g,y);for(let t=0;t<l;t++){let[e,i]=G.applyAffine(h[t],u[t],v);h[t]=e,u[t]=i}}for(let t=0;t<l;t++)i.setAtomPos(e.atoms[t],h[t],u[t])}arrangeLigandsFree(e){if(1==e.length)return;let i=t.last(e).avgTheta;i+=.5*q(t.first(e).avgTheta,i),this.arrangeLigandsRange(e,i,E,!1)}arrangeLigandsRange(t,e,i,s){const{mol:n,metalAtom:o}=this;let l=n.atomX(o),r=n.atomY(o),a=t.length,h=new Array(a),u=new Array(a),m=0;for(let e=0;e<a;e++){let[i,s]=this.determineThetaBounds(t[e]);h[e]=i,u[e]=q(s,i),m+=u[e]}let d=(i-m)/(a+(s?1:0)),c=e+(s?d:.5*d);for(let e=0;e<a;e++){let i=c-h[e],s=Math.cos(i),o=Math.sin(i);for(let i of t[e].atoms){let t=n.atomX(i)-l,e=n.atomY(i)-r;n.setAtomPos(i,l+t*s-e*o,r+t*o+e*s)}c+=u[e]+d}}determineThetaBounds(e){const{mol:i,metalAtom:s}=this;let n=[],o=i.atomX(s),l=i.atomY(s);for(let t=0;t<e.attach.length;t++){let s=i.atomX(e.attach[t])-o,r=i.atomY(e.attach[t])-l;n.push(Math.atan2(r,s))}t.sort(n);let r=Number.POSITIVE_INFINITY,a=0,h=0;for(let e=0;e<n.length;e++){let e=0;for(let t=0;t<n.length-1;t++)e+=q(n[t+1],n[t]);e<r&&(r=e,a=t.first(n),h=t.last(n)),n.push(n.shift())}return[a,h]}resolveClashes(){const{mol:e,metalAtom:i,ligands:s}=this,n=e.numAtoms,o=e.numBonds,l=this.ligands.length;let r=t.numberArray(-1,n),a=t.numberArray(-1,o);for(let t=1;t<=n;t++)e.atomConnComp(t)==e.atomConnComp(i)&&(r[t-1]=0);for(let t=0;t<l;t++)for(let e of s[t].atoms)r[e-1]=t+1;for(let t=1;t<=o;t++){let i=r[e.bondFrom(t)-1],s=r[e.bondTo(t)-1];i<0||s<0||i==s&&(a[t-1]=i)}let h=new Array(l),u=new Array(l),m=e.atomX(i),d=e.atomY(i);for(let t=0;t<l;t++){let i=s[t],n=0,o=0;for(let t of i.attach)n+=e.atomX(t)-m,o+=e.atomY(t)-d;n/=i.attach.length,o/=i.attach.length;let l=1/b(n,o);h[t]=.5*n*l,u[t]=.5*o*l}const c=v(.5);for(let i=0;i<12;i++){let i=t.booleanArray(!1,l);t:for(let s=0;s<n-1;s++)if(!(r[s]<0))for(let o=s+1;o<n;o++)if(r[o]>=0&&r[o]!=r[s]&&(y(e.atomX(s+1)-e.atomX(o+1),e.atomY(s+1)-e.atomY(o+1))<c&&(r[s]>0&&(i[r[s]-1]=!0),r[o]>0&&(i[r[o]-1]=!0)),t.allTrue(i)))break t;if(t.anyFalse(i))t:for(let s=0;s<o-1;s++){if(a[s]<0)continue;let n=e.atomX(e.bondFrom(s+1)),l=e.atomY(e.bondFrom(s+1)),r=e.atomX(e.bondTo(s+1)),h=e.atomY(e.bondTo(s+1));for(let u=s+1;u<o;u++)if(a[u]>=0&&a[u]!=a[s]){let o=e.atomX(e.bondFrom(u+1)),m=e.atomY(e.bondFrom(u+1)),d=e.atomX(e.bondTo(u+1)),c=e.atomY(e.bondTo(u+1));if(G.doLineSegsIntersect(n,l,r,h,o,m,d,c)&&(a[s]>0&&(i[a[s]-1]=!0),a[u]>0&&(i[a[u]-1]=!0)),t.allTrue(i))break t}}if(t.allFalse(i))break;for(let t=0;t<l;t++)if(i[t])for(let i of s[t].atoms)e.setAtomPos(i,e.atomX(i)+h[t],e.atomY(i)+u[t])}}}class Ee{constructor(){this.attdist=0,this.guided=!1,this.bridged=!1,this.scoreModifier=0,this.chainSelect=0}}class Ce{constructor(t,e,i){this.mol=t,this.templ=e,this.abbrev=i,this.perms=[],this.numAttach=0,this.withGuideOnly=!1,this.guidetempl=null,this.guideidx=[],this.guideadj=[],this.timeLimit=5;let s=new Mt(t),n=new Mt(e);n.harmoniseNumbering(s),n.rewriteMolecule();let o=new Ot(t),l=new Ot(e);l.harmoniseNumbering(o),l.rewriteMolecule(),this.huntForGuides()}permuteNone(){let t=this.mol.clone(),e=this.templ.clone();if(t.numAtoms>0){let i=t.boundary(),s=e.boundary(),n=i.maxX()+1-s.minX(),o=.5*(i.minY()+i.maxY())-.5*(s.minY()+s.maxY());Wt.translateMolecule(e,n,o)}else{let t=e.boundary();Wt.translateMolecule(e,-t.midX(),-t.midY())}t.boundary();let i=e.boundary(),s=i.midX(),n=i.midY(),o=[0,30,45,60,90,120,135,150,180,210,225,240,270,300,315,330];t:for(let i=0;i<o.length;i++){let l=e.clone();Wt.rotateMolecule(l,-o[i]*S,s,n);for(let t=0;t<this.perms.length;t++)if(Wt.sketchEquivalent(l,this.perms[t].display))continue t;let r=new Ee;r.mol=t.clone(),r.mol.append(l),r.display=l,r.srcidx=this.sourceIndex(r.mol,t),r.attdist=0,r.guided=!1,this.perms.push(r)}}permuteAtom(t){this.numAttach=1;let e=(new Date).getTime(),i=this.mol.clone(),s=this.templ.clone(),n=[];if(null!=this.guidetempl){let s=Wt.mirrorImage(this.guidetempl.clone());for(let o=0;o<this.guideidx.length&&!((new Date).getTime()-e>1e3*this.timeLimit);o++)this.composeGuidedOne(n,i,this.guidetempl,t,this.guideidx[o]),this.composeGuidedOne(n,i,s,t,this.guideidx[o])}if(!this.withGuideOnly){let o=s.clone();Wt.mirrorImage(o);for(let l=1;l<=s.numAtoms&&!((new Date).getTime()-e>1e3*this.timeLimit);l++)this.composeDirectOne(n,i,s,t,l),this.composeDirectOne(n,i,o,t,l),this.composeBridge(n,i,s,t,l),this.composeBridge(n,i,o,t,l)}this.affixRawPermutations(n)}permuteBond(t,e){this.numAttach=2;let i=(new Date).getTime(),s=this.mol.clone(),n=this.templ.clone(),o=[];if(null!=this.guidetempl){let n=Wt.mirrorImage(this.guidetempl.clone());for(let l=0;l<this.guideidx.length&&!((new Date).getTime()-i>1e3*this.timeLimit);l++){let i=this.guideidx[l],r=this.guidetempl.atomAdjList(i);for(let l=0;l<r.length;l++){let a=r[l];this.composeGuidedTwo(o,s,this.guidetempl,t,e,i,a,!0),this.composeGuidedTwo(o,s,this.guidetempl,e,t,i,a,!0),this.composeGuidedTwo(o,s,n,t,e,i,a,!0),this.composeGuidedTwo(o,s,n,e,t,i,a,!0),this.composeGuidedTwo(o,s,this.guidetempl,t,e,i,a,!1),this.composeGuidedTwo(o,s,this.guidetempl,e,t,i,a,!1),this.composeGuidedTwo(o,s,n,t,e,i,a,!1),this.composeGuidedTwo(o,s,n,e,t,i,a,!1)}}}if(!this.withGuideOnly){let l=n.clone();Wt.mirrorImage(l);for(let r=1;r<=n.numBonds&&!((new Date).getTime()-i>1e3*this.timeLimit);r++){let i=n.bondFrom(r),a=n.bondTo(r);this.composeDirectTwo(o,s,n,t,e,i,a),this.composeDirectTwo(o,s,l,t,e,i,a),this.composeDirectTwo(o,s,n,t,e,a,i),this.composeDirectTwo(o,s,l,t,e,a,i)}}this.affixRawPermutations(o)}permuteMulti(t){this.numAttach=t.length;let e=(new Date).getTime(),i=this.mol.clone(),s=this.templ.clone(),n=[];if(null!=this.guidetempl){let e=Wt.mirrorImage(this.guidetempl.clone());this.guideidx.length==t.length&&(this.composeGuidedMulti(n,i,this.guidetempl,t,this.guideidx,!0),this.composeGuidedMulti(n,i,e,t,this.guideidx,!0)),this.guideadj.length==t.length&&(this.composeGuidedMulti(n,i,this.guidetempl,t,this.guideadj,!1),this.composeGuidedMulti(n,i,e,t,this.guideadj,!1))}if(!this.withGuideOnly){let o=s.clone();Wt.mirrorImage(o);for(let l=1;l<=s.numAtoms&&!((new Date).getTime()-e>1e3*this.timeLimit);l++)this.composeDirectMulti(n,i,s,t,l),this.composeDirectMulti(n,i,o,t,l)}this.affixRawPermutations(n)}huntForGuides(){this.guideidx=[],this.guideadj=[];for(let t=1;t<=this.templ.numAtoms;t++)if("X"==this.templ.atomElement(t)&&this.templ.atomAdjCount(t)>0){this.guideidx.push(t);let e=this.templ.atomAdjList(t);for(let t=0;t<e.length;t++)this.guideadj.indexOf(e[t])<0&&this.guideadj.push(e[t])}if(this.guideidx.length>0){this.guidetempl=this.templ.clone();for(let t=this.guideidx.length-1;t>=0;t--)this.templ.deleteAtomAndBonds(this.guideidx[t])}}composeDirectOne(t,e,i,s,n){let o=Qt.primeDirections(e,s),l=Qt.primeDirections(i,n),r=Wt.atomBondAngles(e,s),a=Wt.atomBondAngles(i,n),h=[],u=[],m=[];for(let t=0;t<r.length;t++)for(let e=0;e<l.length;e++)h.push(r[t]),u.push(l[e]),m.push(-51);for(let t=0;t<o.length;t++)for(let e=0;e<a.length;e++)h.push(o[t]),u.push(a[e]),m.push(0);for(let t=0;t<o.length;t++)for(let e=0;e<l.length;e++)h.push(o[t]),u.push(l[e]),m.push(0);let d=bt.fromMolecule(i).calculateBFS(0),c=e.atomX(s),p=e.atomY(s),f=i.atomX(n),g=i.atomY(n);for(let o=0;o<h.length;o++){let l=N(h[o],u[o]),r=i.clone();Wt.translateMolecule(r,c-f,p-g),Wt.rotateMolecule(r,l,c,p);let a=e.clone(),b=a.numAtoms;a.append(r);let y=this.sourceIndex(a,e);if(Qt.mergeFragmentsMask(a,this.asMask(y)),a.numAtoms==b)continue;let x=new Ee;x.mol=a,x.display=r,x.srcidx=y,x.molidx=[s],x.temidx=[n],x.attdist=d[n-1],x.guided=!1,x.scoreModifier=m[o],this.removeExtraGuides(x,e),t.push(x)}}composeDirectTwo(t,e,i,s,n,o,l){let r=Math.atan2(e.atomY(n)-e.atomY(s),e.atomX(n)-e.atomX(s)),a=Math.atan2(i.atomY(l)-i.atomY(o),i.atomX(l)-i.atomX(o)),h=.5*(e.atomX(s)+e.atomX(n)),u=.5*(e.atomY(s)+e.atomY(n)),m=i.clone();Wt.translateMolecule(m,h-.5*(i.atomX(o)+i.atomX(l)),u-.5*(i.atomY(o)+i.atomY(l))),Wt.rotateMolecule(m,r-a,h,u),m.setAtomPos(o,e.atomX(s),e.atomY(s)),m.setAtomPos(l,e.atomX(n),e.atomY(n));let d=e.clone(),c=d.numAtoms;d.append(m);let p=this.sourceIndex(d,e);if(Qt.mergeFragmentsMask(d,this.asMask(p)),d.numAtoms==c)return;let f=bt.fromMolecule(i).calculateBFS(0),g=new Ee;g.mol=d,g.display=m,g.srcidx=p,g.molidx=[s,n],g.temidx=[o,l],g.attdist=Math.min(f[o-1],f[l-1]),g.guided=!1,this.removeExtraGuides(g,e),t.push(g)}composeDirectMulti(t,e,i,s,n){let o=i.clone(),l=e.atomX(s[0]),r=e.atomY(s[0]);Wt.translateMolecule(o,l-o.atomX(n),r-o.atomY(n));let a=e.atomX(s[1])-l,h=e.atomY(s[1])-r,u=Math.atan2(h,a),m=b(a,h),d=bt.fromMolecule(i).calculateBFS(1),c=[];for(let i=1;i<=o.numAtoms;i++)if(n!=i){let a=o.atomX(i)-o.atomX(n),h=o.atomY(i)-o.atomY(n),p=b(a,h);if(Math.abs(p-m)>.1)continue;let f=Math.atan2(h,a);Wt.rotateMolecule(o,u-f,l,r),c=[n,i];for(let t=2;t<s.length;t++){let i=!1;for(let n=1;n<=o.numAtoms;n++)if(c.indexOf(n)<0&&b(e.atomX(s[t])-o.atomX(n),e.atomY(s[t])-o.atomY(n))<.1*.1){i=!0,c.push(n);break}if(!i)break}if(c.length<s.length)continue;let g=d.length;for(let t=0;t<c.length;t++)g=Math.min(g,d[c[t]-1]);let y=0,x=0;for(let t=0;t<s.length;t++)y+=e.atomX(s[t])-o.atomX(c[t]),x+=e.atomY(s[t])-o.atomY(c[t]);let A=1/s.length;y*=A,x*=A,Wt.translateMolecule(o,y,x);let v=e.clone(),M=v.numAtoms;v.append(o);let T=this.sourceIndex(v,e);for(let t=0;t<c.length;t++){let e=v.atomX(s[t]),i=v.atomY(s[t]);v.setAtomPos(M+c[t],e,i)}if(Qt.mergeFragmentsMask(v,this.asMask(T)),v.numAtoms==M)continue;let w=new Ee;w.mol=v,w.display=o.clone(),w.srcidx=T,w.molidx=s.slice(0),w.temidx=c.slice(0),w.attdist=Math.min(d[n-1],d[i-1]),w.guided=!1,this.removeExtraGuides(w,e),t.push(w)}}composeBridge(t,e,i,s,n){let o=0!=e.atomRingBlock(s)||e.atomAdjCount(s)>=3,l=0!=i.atomRingBlock(n)||i.atomAdjCount(n)>=3;if(!o||!l)return;let r=Qt.primeDirections(e,s),a=Qt.primeDirections(i,n),h=bt.fromMolecule(i).calculateBFS(0);for(let o=0;o<r.length;o++)for(let l=0;l<a.length;l++){let u=e.atomX(s),m=e.atomY(s),d=i.atomX(n),c=i.atomY(n),p=Vt.IDEALBOND*Math.cos(r[o]),f=Vt.IDEALBOND*Math.sin(r[o]),g=N(r[o],Math.PI+a[l]),b=i.clone();Wt.translateMolecule(b,u-d+p,m-c+f),Wt.rotateMolecule(b,g,u+p,m+f);let y=e.clone(),x=y.numAtoms+n,A=y.numAtoms;y.append(b);let v=this.sourceIndex(y,e);if(y.addBond(s,x,1),x=b.addAtom("C",u,m),b.addBond(n,x,1),Qt.mergeFragmentsMask(y,this.asMask(v)),y.numAtoms==A)continue;let M=new Ee;M.mol=y,M.display=b,M.srcidx=v,M.molidx=[s],M.temidx=[x],M.attdist=h[n-1],M.bridged=!0,M.guided=!1,this.removeExtraGuides(M,e),t.push(M)}}composeGuidedOne(t,e,i,s,n){if(0==i.atomAdjCount(n))return;let o=Qt.primeDirections(e,s);if(i.atomAdjCount(n)>1&&e.atomAdjCount(s)>0){let t=0,i=0,n=e.atomAdjList(s);for(let o=0;o<n.length;o++)t+=e.atomX(n[o])-e.atomX(s),i+=e.atomY(n[o])-e.atomY(s);let l=Math.atan2(i,t),r=!0;for(let t=0;t<o.length;t++)if(Math.abs(N(l,o[t]))<3*k){r=!1;break}r&&o.push(l)}let l=i.atomX(n),r=i.atomY(n),a=0,h=0,u=i.atomAdjList(n);for(let t=0;t<u.length;t++)a+=i.atomX(u[t])-l,h+=i.atomY(u[t])-r;a/=u.length,h/=u.length;let m=Math.atan2(h,a),d=0;if(1==u.length){let t=e.atomElement(s),n=i.atomElement(u[0]);"C"!=t&&t==n&&(d=1)}for(let a=0;a<o.length;a++){let h=i.clone();if(2==this.guideidx.length)for(let t=1;t<=h.numAtoms;t++)if(t!=n&&"X"==h.atomElement(t)){h.setAtomElement(t,Ce.RESERVED_GUIDESYMBOL);break}Wt.rotateMolecule(h,o[a]-m,l,r),Wt.translateMolecule(h,e.atomX(s)-l,e.atomY(s)-r);let u=e.clone(),c=u.numAtoms;u.append(h);let p=this.sourceIndex(u,e);if(Qt.mergeFragmentsMask(u,this.asMask(p)),u.numAtoms==c)continue;let f=0;for(let t=1;t<=u.numAtoms;t++)if(u.atomElement(t)==Ce.RESERVED_GUIDESYMBOL){let e=u.atomAdjList(t);1==e.length&&(f=e[0],f>t&&f--),u.deleteAtomAndBonds(t),p.splice(t-1,1);break}let g=new Ee;g.mol=u,g.display=h,g.srcidx=p,g.molidx=[s],g.temidx=[n],g.attdist=0,g.guided=!0,g.scoreModifier=d,g.chainSelect=f,this.removeExtraGuides(g,e),t.push(g)}}composeGuidedTwo(t,e,i,s,n,o,l,r){let a=e.atomX(s),h=e.atomY(s),u=i.atomX(o),m=i.atomY(o),d=i.atomX(l),c=i.atomY(l),p=Math.atan2(e.atomY(n)-h,e.atomX(n)-a),f=Math.atan2(c-m,d-u),g=1==e.atomAdjCount(s),b=e.clone(),y=i.clone();Wt.rotateMolecule(y,p-f,u,m),r?(Wt.translateMolecule(y,a-u,h-m),b.setAtomPos(n,y.atomX(l),y.atomY(l))):(Wt.translateMolecule(y,e.atomX(n)-y.atomX(l),e.atomY(n)-y.atomY(l)),y.setAtomPos(o,a,h));let x=b.numAtoms;b.append(y);let A=this.sourceIndex(b,e);if(Qt.mergeFragmentsMask(b,this.asMask(A)),b.numAtoms==x)return;let v=new Ee;v.mol=b,v.display=y,v.srcidx=A,v.molidx=[s,n],v.temidx=[o,l],v.attdist=g?1:0,v.guided=!0,this.removeExtraGuides(v,e),t.push(v)}composeGuidedMulti(e,i,s,n,o,l){let r=0,a=0,h=0,u=0;for(let t=0;t<n.length;t++)r+=i.atomX(n[t]),a+=i.atomY(n[t]);for(let t=0;t<o.length;t++)h+=s.atomX(o[t]),u+=s.atomY(o[t]);r/=n.length,a/=n.length,h/=o.length,u/=o.length;let m=i.numAtoms;for(let d=0;d<n.length;d++)for(let c=0;c<o.length;c++){let p=i.clone(),f=s.clone(),g=Math.atan2(p.atomY(n[d])-a,p.atomX(n[d])-r),y=Math.atan2(f.atomY(o[c])-u,f.atomX(o[c])-h);Wt.rotateMolecule(f,g-y,h,u),Wt.translateMolecule(f,r-h,a-u),p.append(f);let x=this.sourceIndex(p,i),A=t.numberArray(0,o.length),v=o.slice(0);t.sort(v);let M=t.booleanArray(!1,m);for(let t=v.length-1;t>=0;t--){let e=v[t]+m,i=0,s=0;for(let t=0;t<n.length;t++)if(!M[n[t]-1]){let o=b(p.atomX(n[t])-p.atomX(e),p.atomY(n[t])-p.atomY(e));(0==i||o<s)&&(i=n[t],s=o)}if(!l){if(b(p.atomX(e)-p.atomX(i),p.atomY(e)-p.atomY(i))>.1*.1){let e=f.addAtom("C",p.atomX(i),p.atomY(i));f.addBond(e,v[t],0)}p.setAtomPos(i,p.atomX(e),p.atomY(e))}A[t]=i,M[i-1]=!0;let o=p.atomAdjList(e);for(let t=0;t<o.length;t++){let s=p.findBond(e,o[t]);p.addBond(i,o[t],p.bondOrder(s),p.bondType(s))}p.deleteAtomAndBonds(e),x.splice(e-1,1),f.setAtomPos(v[t],p.atomX(i),p.atomY(i))}for(let t=p.numAtoms;t>m;t--)if("X"==p.atomElement(t)){p.deleteAtomAndBonds(t),x.splice(t-1,1);for(let e=0;e<v.length;e++)t<v[e]&&v[e]--}for(let t=f.numAtoms;t>=1;t--)"X"==f.atomElement(t)&&f.setAtomElement(t,"C");let T=new Ee;T.mol=p,T.display=f,T.srcidx=x,T.molidx=A,T.temidx=v,T.attdist=0,T.guided=!0,this.removeExtraGuides(T,i),e.push(T)}}affixRawPermutations(e){let i=e.length;if(0==i)return;let s=t.booleanArray(!0,i);for(let t=0;t<i-1;t++)if(s[t]){let n=e[t];for(let o=t+1;o<i;o++)if(s[o]){let i=e[o];Wt.sketchEquivalent(n.mol,i.mol)&&(n.scoreModifier+n.attdist>i.scoreModifier+i.attdist&&(e[t]=i,e[o]=n),s[o]=!1)}}let n=t.numberArray(0,i),o=0;for(let t=0;t<i;t++)s[t]?(n[t]=this.scorePermutation(e[t]),n[t]<1e3&&o++):n[t]=0;if(o>0)for(let t=0;t<i;t++)s[t]&&n[t]>=1e3&&(s[t]=!1);let l=[],r=[];for(let t=0;t<i;t++)s[t]&&(l.push(n[t]),r.push(t));let a=t.idxSort(l);for(let t=0;t<a.length;t++){let i=e[r[a[t]]];i.guided&&this.perms.push(i)}for(let t=0;t<a.length;t++){let i=e[r[a[t]]];i.guided||this.perms.push(i)}}removeExtraGuides(t,e){Kt.removeDuplicateBonds(t.mol);for(let e=t.temidx.length-1;e>=0;e--){let i=t.display.atomElement(t.temidx[e]);"X"!=i&&i!=Ce.RESERVED_GUIDESYMBOL||(t.molidx.splice(e,1),t.temidx.splice(e,1))}for(let i=t.display.numAtoms;i>=1;i--){let s=t.display.atomElement(i);if("X"==s||s==Ce.RESERVED_GUIDESYMBOL)if(Wt.atomAtPoint(e,t.display.atomX(i),t.display.atomY(i))>0)t.display.setAtomElement(i,"C");else{t.display.deleteAtomAndBonds(i);for(let e=0;e<t.temidx.length;e++)t.temidx[e]>i&&t.temidx[e]--}}}scorePermutation(e){let i=this.mol,s=e.display,n=e.mol,o=.2*e.attdist+e.scoreModifier;o+=Wt.congestionMolecule(n,.001),o-=n.numAtoms;let l=i.numAtoms,r=s.numAtoms,a=[],h=[],u=[],m=[];for(let t=0;t<l;t++)a.push(i.atomX(t+1)),h.push(i.atomY(t+1));for(let t=0;t<r;t++)u.push(s.atomX(t+1)),m.push(s.atomY(t+1));for(let t=0;t<l;t++)for(let i=0;i<r;i++){if(b(a[t]-u[i],h[t]-m[i])>Wt.OVERLAP_THRESHOLD_SQ)continue;let s=!1;for(let n=0;n<e.molidx.length;n++)if(e.molidx[n]==t+1&&e.temidx[n]==i+1){s=!0;break}s||(o+=100)}if(!e.guided)for(let t=0;t<e.molidx.length;t++){let n=i.atomElement(e.molidx[t]);if("C"==n||"O"==n||"S"==n||"N"==n||"P"==n)continue;let l=i.atomAdjList(e.molidx[t]),r=s.atomAdjList(e.temidx[t]);if(!(l.length+r.length>=4))for(let n=0;n<l.length;n++)for(let d=0;d<r.length;d++){let c=l[n],p=r[d],f=i.bondOrder(i.findBond(e.molidx[t],c)),g=s.bondOrder(s.findBond(e.temidx[t],p)),b=0;if(1==f&&1==g||1==f&&2==g||2==f&&1==g)b=120;else{if(!(2==f&&2==g||1==f&&3==g||3==f&&1==g))continue;b=180}let y=a[c-1]-a[e.molidx[t]-1],x=h[c-1]-h[e.molidx[t]-1],A=u[p-1]-u[e.temidx[t]-1],v=m[p-1]-m[e.temidx[t]-1],M=Math.abs(N(Math.atan2(x,y),Math.atan2(v,A)))*k;Math.abs(M-b)>5&&(o+=50)}}for(let t=1;t<=n.numAtoms;t++)if("C"==n.atomElement(t)||"N"==n.atomElement(t)){let e=n.atomAdjBonds(t),i=0;for(let t=0;t<e.length;t++){let s=n.bondOrder(e[t]);if(i+=s,0==s){i=0;break}}i>4&&(o+=1e3)}if(e.molidx.length>=2){let n=t.booleanArray(!1,l);for(let t=0;t<e.molidx.length;t++)n[e.molidx[t]-1]=!0;for(let t=1;t<=i.numBonds;t++){let l=i.bondFrom(t),r=i.bondTo(t);if(!n[l-1]||!n[r-1])continue;let a=e.molidx.indexOf(l),h=e.molidx.indexOf(r),u=s.findBond(e.temidx[a],e.temidx[h]);0!=u&&i.bondOrder(t)!=s.bondOrder(u)&&(o+=1)}}return o}sourceIndex(e,i){let s=t.numberArray(0,e.numAtoms);for(let t=i.numAtoms;t>=1;t--)s[t-1]=t;return s}asMask(e){let i=t.booleanArray(!1,e.length);for(let t=0;t<e.length;t++)i[t]=0!=e[t];return i}}var Se,ke;Ce.RESERVED_GUIDESYMBOL="XXX",function(t){t[t.Delete=1]="Delete",t[t.Clear=2]="Clear",t[t.Copy=3]="Copy",t[t.Cut=4]="Cut",t[t.SelectAll=5]="SelectAll",t[t.SelectNone=6]="SelectNone",t[t.SelectPrevComp=7]="SelectPrevComp",t[t.SelectNextComp=8]="SelectNextComp",t[t.SelectSide=9]="SelectSide",t[t.SelectGrow=10]="SelectGrow",t[t.SelectShrink=11]="SelectShrink",t[t.SelectChain=12]="SelectChain",t[t.SelectSmRing=13]="SelectSmRing",t[t.SelectRingBlk=14]="SelectRingBlk",t[t.SelectCurElement=15]="SelectCurElement",t[t.SelectToggle=16]="SelectToggle",t[t.SelectUnCurrent=17]="SelectUnCurrent",t[t.Element=18]="Element",t[t.AtomPos=19]="AtomPos",t[t.Charge=20]="Charge",t[t.Connect=21]="Connect",t[t.Disconnect=22]="Disconnect",t[t.MetalLigate=23]="MetalLigate",t[t.BondOrder=24]="BondOrder",t[t.BondType=25]="BondType",t[t.BondGeom=26]="BondGeom",t[t.BondAtom=27]="BondAtom",t[t.BondSwitch=28]="BondSwitch",t[t.BondRotate=29]="BondRotate",t[t.BondAddTwo=30]="BondAddTwo",t[t.BondInsert=31]="BondInsert",t[t.Join=32]="Join",t[t.Nudge=33]="Nudge",t[t.NudgeLots=34]="NudgeLots",t[t.NudgeFar=35]="NudgeFar",t[t.Flip=36]="Flip",t[t.Scale=37]="Scale",t[t.Rotate=38]="Rotate",t[t.BondDist=39]="BondDist",t[t.AlignAngle=40]="AlignAngle",t[t.AlignRegular=41]="AlignRegular",t[t.AdjustTorsion=42]="AdjustTorsion",t[t.Move=43]="Move",t[t.Ring=44]="Ring",t[t.TemplateFusion=45]="TemplateFusion",t[t.AbbrevTempl=46]="AbbrevTempl",t[t.AbbrevGroup=47]="AbbrevGroup",t[t.AbbrevFormula=48]="AbbrevFormula",t[t.AbbrevClear=49]="AbbrevClear",t[t.AbbrevExpand=50]="AbbrevExpand",t[t.BondArtifactPath=51]="BondArtifactPath",t[t.BondArtifactRing=52]="BondArtifactRing",t[t.BondArtifactArene=53]="BondArtifactArene",t[t.BondArtifactClear=54]="BondArtifactClear",t[t.PolymerBlock=55]="PolymerBlock",t[t.AddHydrogens=56]="AddHydrogens",t[t.RemoveHydrogens=57]="RemoveHydrogens",t[t.QueryClear=58]="QueryClear",t[t.QueryCopy=59]="QueryCopy",t[t.QueryPaste=60]="QueryPaste",t[t.QuerySetAtom=61]="QuerySetAtom",t[t.QuerySetBond=62]="QuerySetBond",t[t.QueryBondAny=63]="QueryBondAny",t[t.SproutDirection=64]="SproutDirection"}(Se||(Se={}));class Be{constructor(e,i,s,n){this.input=e,this.activity=i,this.param=s,this.owner=n,this.toClipboard=null,this.output={mol:null,currentAtom:-1,currentBond:-1,selectedMask:null};let o=this.input.mol.numAtoms;for(null==this.input.selectedMask&&(this.input.selectedMask=t.booleanArray(!1,o));this.input.selectedMask.length<o;)this.input.selectedMask.push(!1);if(this.subjectMask=this.input.selectedMask.slice(0),this.subjectLength=t.maskCount(this.subjectMask),this.subjectIndex=[],this.hasSelected=this.subjectLength>0,0==this.subjectLength){if(this.input.currentAtom>0)this.subjectLength=1,this.subjectMask[this.input.currentAtom-1]=!0,this.subjectIndex=[this.input.currentAtom];else if(this.input.currentBond>0){let t=this.input.mol.bondFrom(this.input.currentBond),e=this.input.mol.bondTo(this.input.currentBond),i=Math.min(t,e),s=Math.max(t,e);this.subjectLength=2,this.subjectMask[i-1]=!0,this.subjectMask[s-1]=!0,this.subjectIndex=[i,s]}}else this.subjectIndex=t.maskIdx(this.subjectMask),t.addTo(this.subjectIndex,1)}setOwner(t){this.owner=t}evaluate(){return!0}execute(){let t=this.param;if(this.activity==Se.Delete)this.execDelete();else if(this.activity==Se.Clear)this.execClear();else if(this.activity==Se.Copy)this.execCopy(!1);else if(this.activity==Se.Cut)this.execCopy(!0);else if(this.activity==Se.SelectAll)this.execSelectAll(!0);else if(this.activity==Se.SelectNone)this.execSelectAll(!1);else if(this.activity==Se.SelectPrevComp)this.execSelectComp(-1);else if(this.activity==Se.SelectNextComp)this.execSelectComp(1);else if(this.activity==Se.SelectSide)this.execSelectSide();else if(this.activity==Se.SelectGrow)this.execSelectGrow();else if(this.activity==Se.SelectShrink)this.execSelectShrink();else if(this.activity==Se.SelectChain)this.execSelectChain();else if(this.activity==Se.SelectSmRing)this.execSelectSmRing();else if(this.activity==Se.SelectRingBlk)this.execSelectRingBlk();else if(this.activity==Se.SelectCurElement)this.execSelectCurElement();else if(this.activity==Se.SelectToggle)this.execSelectToggle();else if(this.activity==Se.SelectUnCurrent)this.execSelectUnCurrent();else if(this.activity==Se.Element)this.execElement(t.element,t.positionX,t.positionY,t.keepAbbrev);else if(this.activity==Se.Charge)this.execCharge(t.delta);else if(this.activity==Se.Connect)this.execConnect(1,Vt.BONDTYPE_NORMAL);else if(this.activity==Se.Disconnect)this.execDisconnect();else if(this.activity==Se.MetalLigate)this.execMetalLigate();else if(this.activity==Se.BondOrder)this.execBond(t.order,Vt.BONDTYPE_NORMAL);else if(this.activity==Se.BondType)this.execBond(1,t.type);else if(this.activity==Se.BondGeom)this.execBondGeom(t.geom);else if(this.activity==Se.BondAtom)this.execBondAtom(t.order,t.type,t.element,t.x1,t.y1,t.x2,t.y2);else if(this.activity==Se.BondSwitch)this.execBondSwitch();else if(this.activity==Se.BondRotate)this.execBondRotate();else if(this.activity==Se.BondAddTwo)this.execBondAddTwo();else if(this.activity==Se.BondInsert)this.execBondInsert();else if(this.activity==Se.Join)this.execJoin();else if(this.activity==Se.Nudge)this.execNudge(t.dir,.1);else if(this.activity==Se.NudgeLots)this.execNudge(t.dir,1);else if(this.activity==Se.NudgeFar)this.execNudgeFar(t.dir);else if(this.activity==Se.Flip)this.execFlip(t.axis);else if(this.activity==Se.Scale)this.execScale(t.mag);else if(this.activity==Se.Rotate)this.execRotate(t.theta,t.centreX,t.centreY);else if(this.activity==Se.BondDist)this.execBondDist(t.dist);else if(this.activity==Se.AlignAngle)this.execAlignAngle(t.angle);else if(this.activity==Se.AlignRegular)this.execAlignRegular();else if(this.activity==Se.AdjustTorsion)this.execAdjustTorsion(t.angle);else if(this.activity==Se.Move)this.execMove(t.refAtom,t.deltaX,t.deltaY);else if(this.activity==Se.Ring)this.execRing(t.ringX,t.ringY,t.aromatic);else{if(this.activity==Se.TemplateFusion)return this.execTemplateFusion(Vt.fromString(t.fragNative)),void(this.owner&&this.owner.setPermutations(this.output.permutations));this.activity==Se.AbbrevTempl?this.execAbbrevTempl():this.activity==Se.AbbrevGroup?this.execAbbrevGroup():this.activity==Se.AbbrevFormula?this.execAbbrevFormula():this.activity==Se.AbbrevClear?this.execAbbrevClear():this.activity==Se.AbbrevExpand?this.execAbbrevExpand():this.activity==Se.BondArtifactPath||this.activity==Se.BondArtifactRing||this.activity==Se.BondArtifactArene||this.activity==Se.BondArtifactClear?this.execBondArtifact(this.activity):this.activity==Se.PolymerBlock?this.execPolymerBlock():this.activity==Se.AddHydrogens?this.execAddHydrogens():this.activity==Se.RemoveHydrogens?this.execRemoveHydrogens():this.activity==Se.QueryClear?this.execQueryClear():this.activity==Se.QueryCopy?this.execQueryCopy():this.activity==Se.QueryPaste?this.execQueryPaste():this.activity==Se.QuerySetAtom?this.execQuerySetAtom():this.activity==Se.QuerySetBond?this.execQuerySetBond():this.activity==Se.QueryBondAny?this.execQueryBondAny():this.activity==Se.SproutDirection&&this.execSproutDirection(t.deltaX,t.deltaY)}this.finish()}finish(){this.owner&&(null!=this.output.mol||this.output.currentAtom>=0||this.output.currentBond>=0||null!=this.output.selectedMask?(this.owner.setState(this.output,!0),null!=this.errmsg&&this.owner.showMessage(this.errmsg,!1)):null!=this.errmsg&&this.owner.showMessage(this.errmsg,!0))}execDelete(){if(!this.requireSubject())return;let t=this.input.mol;if(this.output.mol=t.clone(),this.zapSubject(),this.input.currentBond>0&&!this.hasSelected)return this.output.mol.deleteBond(this.input.currentBond),void(this.output.currentBond=0);if(1==this.subjectLength&&this.subjectIndex[0]==this.input.currentAtom){let e=t.atomAdjList(this.input.currentAtom);1==e.length&&(this.output.currentAtom=e[0],this.output.currentAtom>this.input.currentAtom&&this.output.currentAtom--)}for(let t=this.subjectLength-1;t>=0;t--)this.output.mol.deleteAtomAndBonds(this.subjectIndex[t])}execCopy(e){let i=this.input.mol;this.subjectLength>0&&(i=Kt.subgraphWithAttachments(i,this.subjectMask)),this.owner?this.owner.performCopy(i):this.toClipboard=i.toString(),e&&(this.zapSubject(),this.output.mol=Kt.subgraphMask(this.input.mol,t.notMask(this.subjectMask)))}execClear(){this.output.mol=new Vt,this.zapSubject()}execSelectAll(e){let i=!0;for(let t=0;t<this.input.mol.numAtoms;t++)if(this.subjectMask[t]!=e){i=!1;break}i?this.errmsg=e?"All atoms already selected.":"All atoms already deselected.":this.output.selectedMask=t.booleanArray(e,this.input.mol.numAtoms)}execSelectComp(e){let i=Kt.componentList(this.input.mol);if(1==i.length&&this.hasSelected&&this.subjectLength==this.input.mol.numAtoms)return void(this.errmsg="All atoms already selected.");let s=this.pickSelectedGroup(i,e);this.output.selectedMask=t.booleanArray(!1,this.input.mol.numAtoms);for(let t=0;t<i[s].length;t++)this.output.selectedMask[i[s][t]-1]=!0}execSelectSide(){if(!this.requireCurrent())return;let e=this.input.mol,i=this.input.currentAtom,s=this.input.currentBond;if(i>0&&0==e.atomAdjCount(i))return void(this.errmsg="Current atom has no neighbours.");if(s>0&&1==e.atomAdjCount(e.bondFrom(s))&&1==e.atomAdjCount(e.bondTo(s)))return void(this.errmsg="Current bond has no neighbours.");let n=i>0?Kt.getAtomSides(e,i):Kt.getBondSides(e,s),o=this.pickSelectedGroup(n,1);this.output.selectedMask=t.booleanArray(!1,e.numAtoms);for(let t=0;t<n[o].length;t++)this.output.selectedMask[n[o][t]-1]=!0}execSelectGrow(){if(!this.requireSubject())return;let t=this.input.mol,e=this.input.currentAtom,i=this.input.currentBond;if(this.output.selectedMask=this.input.selectedMask.slice(0),this.hasSelected)for(let e=1;e<=t.numBonds;e++){let i=t.bondFrom(e)-1,s=t.bondTo(e)-1;this.input.selectedMask[i]&&!this.input.selectedMask[s]?this.output.selectedMask[s]=!0:this.input.selectedMask&&!this.input.selectedMask[i]&&(this.output.selectedMask[i]=!0)}else e>0?this.output.selectedMask[e-1]=!0:(this.output.selectedMask[t.bondFrom(i)-1]=!0,this.output.selectedMask[t.bondTo(i)-1]=!0)}execSelectShrink(){if(!this.requireSelected())return;let e=this.input.mol,i=t.numberArray(0,e.numAtoms);for(let t=1;t<=e.numBonds;t++){let s=e.bondFrom(t)-1,n=e.bondTo(t)-1;this.input.selectedMask[s]&&this.input.selectedMask[n]&&(i[s]++,i[n]++)}this.output.selectedMask=this.input.selectedMask.slice(0);for(let t=0;t<e.numAtoms;t++)this.output.selectedMask[t]=this.input.selectedMask[t]&&i[t]>=2}execSelectChain(){if(!this.requireSubject())return;let t=this.input.mol;this.output.selectedMask=this.input.selectedMask.slice(0);for(let e=1;e<=t.numBonds;e++){let i=t.bondFrom(e)-1,s=t.bondTo(e)-1;this.input.selectedMask[i]&&!this.input.selectedMask[s]&&0==t.atomRingBlock(s+1)?this.output.selectedMask[s]=!0:this.input.selectedMask[s]&&!this.input.selectedMask[i]&&0==t.atomRingBlock(i+1)&&(this.output.selectedMask[i]=!0)}}execSelectSmRing(){if(this.requireSubject()){this.output.selectedMask=this.input.selectedMask.slice(0);for(let t=3;t<=8;t++){let e=this.input.mol.findRingsOfSize(t);for(let t=0;t<e.length;t++){let i=!1;for(let s=0;s<e[t].length;s++)if(this.subjectMask[e[t][s]-1]){i=!0;break}if(i)for(let i=0;i<e[t].length;i++)this.output.selectedMask[e[t][i]-1]=!0}}}}execSelectRingBlk(){if(!this.requireSubject())return;let e=this.input.mol;this.output.selectedMask=this.input.selectedMask.slice(0);let i=0;for(let t=1;t<=e.numAtoms;t++)i=Math.max(i,e.atomRingBlock(t));if(0==i)return;let s=t.booleanArray(!1,i);for(let t=1;t<=e.numAtoms;t++){let i=e.atomRingBlock(t);i>0&&this.subjectMask[t-1]&&(s[i-1]=!0)}for(let t=1;t<=e.numAtoms;t++){let i=e.atomRingBlock(t);i>0&&s[i-1]&&(this.output.selectedMask[t-1]=!0)}}execSelectCurElement(){if(!this.requireCurrent())return;let t=this.input.mol;this.output.selectedMask=this.input.selectedMask.slice(0);let e="",i="";this.input.currentAtom>0?e=t.atomElement(this.input.currentAtom):(e=t.atomElement(t.bondFrom(this.input.currentBond)),i=t.atomElement(t.bondTo(this.input.currentBond)));for(let s=1;s<=t.numAtoms;s++)t.atomElement(s)!=e&&t.atomElement(s)!=i||(this.output.selectedMask[s-1]=!0)}execSelectToggle(){if(this.requireCurrent())if(this.output.selectedMask=this.input.selectedMask.slice(0),this.input.currentAtom>0)this.output.selectedMask[this.input.currentAtom-1]=!this.output.selectedMask[this.input.currentAtom-1];else{let t=this.input.mol.bondFrom(this.input.currentBond),e=this.input.mol.bondTo(this.input.currentBond),i=!this.input.selectedMask[t-1]||!this.input.selectedMask[e-1];this.output.selectedMask[t-1]=i,this.output.selectedMask[e-1]=i}}execSelectUnCurrent(){this.requireCurrent()&&(this.output.selectedMask=this.input.selectedMask.slice(0),this.input.currentAtom>0?this.output.selectedMask[this.input.currentAtom-1]=!1:(this.output.selectedMask[this.input.mol.bondFrom(this.input.currentBond)-1]=!1,this.output.selectedMask[this.input.mol.bondTo(this.input.currentBond)-1]=!1))}execElement(t,e,i,s){if(this.subjectLength>0&&!["A","X","Y","Z","Q","M","T","E","R"].includes(t)){let e=!1;for(let i=0;i<this.subjectLength;i++)if(this.input.mol.atomElement(this.subjectIndex[i])!=t){e=!0;break}if(!e)return void(this.errmsg="Elements not changed.")}let n=this.output.mol=this.input.mol.clone(),o=e=>{if("A"==t)It.setQueryAtomElementsNot(n,e,["H"]),It.deleteQueryAtom(n,e,Bt.Elements);else if("X"==t)It.setQueryAtomElements(n,e,["F","Cl","Br","I"]),It.deleteQueryAtom(n,e,Bt.ElementsNot);else if("Y"==t)It.setQueryAtomElements(n,e,["O","S","Se","Te"]),It.deleteQueryAtom(n,e,Bt.ElementsNot);else if("Z"==t)It.setQueryAtomElements(n,e,["F","Cl","Br","O","S"]),It.deleteQueryAtom(n,e,Bt.ElementsNot);else if("Q"==t)It.setQueryAtomElementsNot(n,e,["H","C"]),It.deleteQueryAtom(n,e,Bt.Elements);else if("M"==t){const t=["H","B","C","N","O","F","Si","P","S","Cl","As","Se","Br","Te","I"];It.setQueryAtomElementsNot(n,e,t),It.deleteQueryAtom(n,e,Bt.Elements)}else if("T"==t){const t=["Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr"];It.setQueryAtomElements(n,e,t),It.deleteQueryAtom(n,e,Bt.ElementsNot)}else if("E"==t){const t=["B","N","O","F","Al","Si","P","S","Cl","Zn","Ga","Se","As","Se","Br","Cd","In","Sn","Sb","Te","I","Hg","Tl","Pb","Bi","Pb","At"];It.setQueryAtomElements(n,e,t),It.deleteQueryAtom(n,e,Bt.ElementsNot)}else"R"==t&&(It.setQueryAtomElements(n,e,["C","N","O","S","P","H"]),It.deleteQueryAtom(n,e,Bt.ElementsNot))};if(0==n.numAtoms)n.addAtom(t,0,0),o(n.numAtoms);else if(0==this.subjectLength)null!=e&&null!=i?n.addAtom(t,e,i):Qt.placeNewAtom(n,t),o(n.numAtoms);else for(let e=0;e<this.subjectLength;e++)s?n.setAtomElement(this.subjectIndex[e],t):Kt.setAtomElement(n,this.subjectIndex[e],t),o(this.subjectIndex[e])}execCharge(t){if(this.requireSubject()){this.output.mol=this.input.mol.clone();for(let e=0;e<this.subjectLength;e++){let i=Math.max(-20,Math.min(20,this.input.mol.atomCharge(this.subjectIndex[e])+t));this.output.mol.setAtomCharge(this.subjectIndex[e],i)}}}execConnect(t,e){if(!this.requireSubject())return;let i=Qt.pickAtomsToConnect(this.input.mol,this.subjectIndex);if(null!=i){this.output.mol=this.input.mol.clone();for(let s=0;s<i.length;s+=2)Kt.addBond(this.output.mol,i[s],i[s+1],t,e)}else this.errmsg="Subject atoms contain no bonds suitable for connection."}execDisconnect(){let e=[],i=this.input.mol;if(this.hasSelected)for(let t=1;t<=i.numBonds;t++)this.subjectMask[i.bondFrom(t)-1]&&this.subjectMask[i.bondTo(t)-1]&&e.push(t);else if(this.input.currentAtom>0)for(let t of i.atomAdjBonds(this.input.currentAtom))e.push(t);else this.input.currentBond>0&&e.push(this.input.currentBond);if(0==e.length)return void(this.errmsg="Subject atoms contain no bonds suitable for disconnection.");let s=t.booleanArray(!1,i.numBonds);for(let t of e)s[t-1]=!0;this.output.mol=this.input.mol.clone();for(let t=i.numBonds;t>=1;t--)s[t-1]&&this.output.mol.deleteBond(t)}execMetalLigate(){if(!this.requireSubject())return;let e=this.input.mol,i=this.subjectIndex.slice(0),s=this.input.currentAtom;if(0==s)for(let t of this.subjectIndex){let i=e.atomicNumber(t);if(gt.ELEMENT_BLOCKS[i]>=3){s=t;break}}if(0==s)for(let t of this.subjectIndex){let i=e.atomicNumber(t);if(gt.ELEMENT_ROWS[i]>=3){s=t;break}}if(0==s)return void(this.errmsg="Unsure which is the metal atom: try indicating as current.");let n=i.indexOf(s);if(n>=0&&i.splice(n,1),0==i.length&&(i=e.atomAdjList(s)),0!=i.length){e=new we(e,s,i).generate(),this.output.mol=e,this.output.currentAtom=s,this.output.currentBond=-1,this.output.selectedMask=t.booleanArray(!1,e.numAtoms);for(let t of i)this.output.selectedMask[t-1]=!0}else this.errmsg="Metal centre has no attachments: try selecting atom join-points."}execBond(t,e){if(!this.requireSubject())return;if(1==this.subjectLength)return void this.performBondNew(this.subjectIndex[0],t,e);let i=Kt.subgraphMask(this.input.mol,this.subjectMask),s=!0;for(let t=i.numAtoms;t>=1;t--)if(1!=i.atomConnComp(t)){s=!1;break}s?this.performBondChange(t,e):this.execConnect(t,e)}execBondGeom(t){let e=2==this.subjectLength?this.input.mol.findBond(this.subjectIndex[0],this.subjectIndex[1]):0;0==this.subjectLength||this.subjectLength>2||2==this.subjectLength&&0==e?this.errmsg="The subject must be a single atom or bond.":1==this.subjectLength?this.performBondGeomAtom(t,this.subjectIndex[0]):this.performBondGeomBond(t,e)}execBondAtom(t,e,i,s,n,o,l){let r=this.input.mol,a=Wt.atomAtPoint(r,s,n,.01),h=Wt.atomAtPoint(r,o,l,.01);a>0&&a==h||a>0&&h>0&&r.findBond(a,h)>0||(this.output.mol=r.clone(),0==a&&(a=this.output.mol.addAtom("C",s,n)),0==h&&(h=this.output.mol.addAtom(i,o,l)),this.output.mol.addBond(a,h,t,e))}execBondSwitch(){if(this.input.altmol)return this.output.mol=this.input.altmol,void(this.output.altmol=this.input.mol);if(!this.requireSubject())return;let t=this.input.mol,e=0,i=[];if(1==this.subjectLength){e=this.subjectIndex[0];let s=t.atomAdjList(e);for(let e=0;e<s.length;e++)1==t.atomAdjCount(s[e])&&i.push(s[e])}else if(2==this.subjectLength&&t.findBond(this.subjectIndex[0],this.subjectIndex[1])>0){let s=t.atomAdjCount(this.subjectIndex[0]),n=t.atomAdjCount(this.subjectIndex[1]);s>1&&1==n?(e=this.subjectIndex[0],i.push(this.subjectIndex[1])):1==s&&n>1&&(e=this.subjectIndex[1],i.push(this.subjectIndex[0]))}if(0==e||0==i.length)return void(this.errmsg="Subject must include a terminal bond.");let s=Qt.guessAtomGeometry(t,e,1);0!=s.length?(this.output.mol=Qt.switchAtomGeometry(t,e,i,s),null==this.output.mol&&(this.errmsg="No alternative geometries identified.")):this.errmsg="No alternative geometries identified."}execBondRotate(){let e=this.input.currentBond;if(0==e)return void(this.errmsg="There must be a current bond.");let i=this.input.mol;if(i.bondInRing(e))return void(this.errmsg="Cannot rotate a ring-bond.");if(1==i.atomAdjCount(i.bondFrom(e))&&1==i.atomAdjCount(i.bondTo(e)))return void(this.errmsg="Two-atom components do not rotate.");i=i.clone();let[s,n,o]=this.mobileSide(e,!0),l=i.atomX(s),r=i.atomY(s),a=Math.atan2(i.atomY(s)-i.atomY(n),i.atomX(s)-i.atomX(n));for(let t of o)if(t!=s){let e=i.atomX(t)-l,s=i.atomY(t)-r,n=b(e,s),o=Math.atan2(s,e);o=a-N(o,a),i.setAtomPos(t,l+n*Math.cos(o),r+n*Math.sin(o))}let h=t.idxMask(t.add(o,-1),i.numAtoms);for(let t=1;t<=i.numBonds;t++)if(h[i.bondFrom(t)-1]&&h[i.bondTo(t)-1]){let e=i.bondType(t);e==Vt.BONDTYPE_INCLINED?i.setBondType(t,Vt.BONDTYPE_DECLINED):e==Vt.BONDTYPE_DECLINED&&i.setBondType(t,Vt.BONDTYPE_INCLINED)}Wt.sketchEquivalent(this.input.mol,i)?this.errmsg="Rotation has no effect.":this.output.mol=i}execBondAddTwo(){if(1!=this.subjectLength)return void(this.errmsg="Subject must be a single atom.");let t=this.subjectIndex[0];if(this.input.mol.atomAdjCount(t)<2)return void(this.errmsg="Subject atom must already have at least 2 bonds.");let e=Qt.calculateNewBondAngles(this.input.mol,t,1);if(0==e.length&&(e=Qt.exitVectors(this.input.mol,t)),0==e.length)return void(this.errmsg="Could not find a suitable geometry for new substituents.");let i=e[0],s=this.input.mol.atomX(t),n=this.input.mol.atomY(t);if(e.length>1){let t=0;for(let o=0;o<e.length;o++){let l=s+Vt.IDEALBOND*Math.cos(e[o]),r=n+Vt.IDEALBOND*Math.sin(e[o]),a=Wt.congestionPoint(this.input.mol,l,r);(0==o||a<t)&&(t=a,i=e[o])}}let o=i-30*S,l=i+30*S,r=this.input.mol.clone(),a=r.addAtom("C",s+Vt.IDEALBOND*Math.cos(o),n+Vt.IDEALBOND*Math.sin(o)),h=r.addAtom("C",s+Vt.IDEALBOND*Math.cos(l),n+Vt.IDEALBOND*Math.sin(l));r.addBond(t,a,1),r.addBond(t,h,1),this.output.mol=r}execBondInsert(){let e=this.input.mol,i=this.input.currentBond;if(0==i)return void(this.errmsg="There must be a current bond.");if(e.bondInRing(i))return void(this.errmsg="Cannot insert into a ring-bond.");let[s,n,o]=this.mobileSide(i);e=e.clone(),e.setBondOrder(i,1);let l=t.booleanArray(!1,e.numAtoms);for(let t of o)l[t-1]=!0;let r=Kt.subgraphWithAttachments(e,l);for(let t=e.numAtoms;t>=1;t--)l[t-1]&&t!=s&&(e.deleteAtomAndBonds(t),t<s&&(s-=1));e.setAtomElement(s,"C"),e.setAtomCharge(s,0),e.setAtomUnpaired(s,0),e.setAtomHExplicit(s,Vt.HEXPLICIT_UNKNOWN),e.setAtomIsotope(s,Vt.ISOTOPE_NATURAL),e.setAtomMapNum(s,0),e.setAtomExtra(s,[]),e.setAtomTransient(s,[]);let a=new Ce(e,r,"");a.withGuideOnly=!0,a.permuteAtom(s),0!=a.perms.length?(this.output.mol=a.perms[0].mol,this.zapSubject(),this.output.currentAtom=s):this.errmsg="Unable to insert."}execJoin(){this.requireSubject()&&(this.output.mol=Qt.joinOverlappingAtoms(this.input.mol,this.subjectMask),null==this.output.mol?this.errmsg="Subject contains no overlapping atoms.":this.zapSubject())}execNudge(t,e){if(!this.requireSubject())return;let i=e*("left"==t?-1:"right"==t?1:0),s=e*("down"==t?-1:"up"==t?1:0);this.output.mol=this.input.mol.clone();for(let t=0;t<this.subjectLength;t++){let e=this.output.mol.atomX(this.subjectIndex[t]),n=this.output.mol.atomY(this.subjectIndex[t]);this.output.mol.setAtomPos(this.subjectIndex[t],e+i,n+s)}}execNudgeFar(t){if(!this.requireSubject())return;if(this.subjectLength==this.input.mol.numAtoms)return void(this.errmsg="Cannot apply to entire molecule.");let e="left"==t?-1:"right"==t?1:0,i="down"==t?-1:"up"==t?1:0;this.output.mol=Qt.moveToEdge(this.input.mol,this.subjectMask,e,i),null==this.output.mol&&this.execNudge(t,1)}execFlip(e){if(this.input.mol.numAtoms<2)return void(this.errmsg="At least 2 atoms are required.");let i="ver"==e,s=0,n=0,o=this.subjectMask,l=this.input.mol;if(this.input.currentAtom>0){if(s=l.atomX(this.input.currentAtom),n=l.atomY(this.input.currentAtom),!this.hasSelected){o=t.booleanArray(!1,l.numAtoms);let e=l.atomConnComp(this.input.currentAtom);for(let t=1;t<=l.numAtoms;t++)o[t-1]=l.atomConnComp(t)==e}}else if(this.input.currentBond>0){let e=l.bondFrom(this.input.currentBond),i=l.bondTo(this.input.currentBond);if(s=.5*(l.atomX(e)+l.atomX(i)),n=.5*(l.atomY(e)+l.atomY(i)),!this.hasSelected){o=t.booleanArray(!1,l.numAtoms);let i=l.atomConnComp(e);for(let t=1;t<=l.numAtoms;t++)o[t-1]=l.atomConnComp(t)==i}}else if(0==this.subjectLength){let e=l.boundary();s=.5*(e.minX()+e.maxX()),n=.5*(e.minY()+e.maxY()),o=t.booleanArray(!0,l.numAtoms)}else{for(let t=0;t<this.subjectLength;t++)s+=l.atomX(this.subjectIndex[t]),n+=l.atomY(this.subjectIndex[t]);let t=1/this.subjectLength;s*=t,n*=t}this.output.mol=l.clone();for(let t=1;t<=l.numAtoms;t++)o[t-1]&&(i?this.output.mol.setAtomY(t,2*n-this.output.mol.atomY(t)):this.output.mol.setAtomX(t,2*s-this.output.mol.atomX(t)))}execScale(e){const{mol:i,currentAtom:s,currentBond:n}=this.input;if(i.numAtoms<2)return void(this.errmsg="At least 2 atoms are required.");if(s>0){let n=[];for(let t of this.subjectIndex)t!=s&&i.findBond(s,t)>0&&n.push(t);let o=bt.fromMolecule(i);o.isolateNode(s-1);let l=!1;for(let r of o.calculateComponentGroups()){t.addTo(r,1);let o=0,a=0,h=0;for(let t of r)n.includes(t)&&(a+=i.atomX(t)-i.atomX(s),h+=i.atomY(t)-i.atomY(s),o++);if(0!=o&&([a,h]=[a/o,h/o],!(Math.abs(a)<.1&&Math.abs(h)<.1))){[a,h]=[a*(e-1),h*(e-1)],this.output.mol||(this.output.mol=i.clone());for(let t of r)this.output.mol.setAtomPos(t,this.output.mol.atomX(t)+a,this.output.mol.atomY(t)+h);l=!0}}if(l)return}let o;if(2==this.subjectLength&&(o=i.findBond(this.subjectIndex[0],this.subjectIndex[1]))>0&&!i.bondInRing(o)){let t=this.subjectIndex[0],s=this.subjectIndex[1],n=i.clone();n.deleteBond(o);let l=[],r=[];for(let e=1;e<=n.numAtoms;e++)n.atomConnComp(e)==n.atomConnComp(t)?l.push(e):n.atomConnComp(e)==n.atomConnComp(s)&&r.push(e);let a=(i.atomX(s)-i.atomX(t))*(e-1),h=(i.atomY(s)-i.atomY(t))*(e-1);if(l.length==r.length&&(a*=.5,h*=.5),this.output.mol=i.clone(),l.length<=r.length)for(let t=0;t<l.length;t++){let e=l[t];this.output.mol.setAtomPos(e,this.output.mol.atomX(e)-a,this.output.mol.atomY(e)-h)}if(r.length<=l.length)for(let t=0;t<r.length;t++){let e=r[t];this.output.mol.setAtomPos(e,this.output.mol.atomX(e)+a,this.output.mol.atomY(e)+h)}return}let l=0,r=0;if(s>0)l=i.atomX(s),r=i.atomY(s);else if(n>0){let t=i.bondFrom(n),e=i.bondTo(n);l=.5*(i.atomX(t)+i.atomX(e)),r=.5*(i.atomY(t)+i.atomY(e))}else{for(let t=0;t<this.subjectLength;t++)l+=i.atomX(this.subjectIndex[t]),r+=i.atomY(this.subjectIndex[t]);let t=1/this.subjectLength;l*=t,r*=t}this.output.mol=i.clone();for(let t=0;t<this.subjectLength;t++){let i=this.output.mol.atomX(this.subjectIndex[t]),s=this.output.mol.atomY(this.subjectIndex[t]);this.output.mol.setAtomPos(this.subjectIndex[t],(i-l)*e+l,(s-r)*e+r)}}execRotate(e,i,s){e*=S;let n=this.input.mol;if(null!=i&&null!=s){this.output.mol=n.clone();let o=0==this.subjectLength?t.booleanArray(!0,n.numAtoms):this.subjectMask;return void Wt.rotateAtoms(this.output.mol,o,i,s,e)}if(n.numAtoms<2)return void(this.errmsg="At least 2 atoms are required.");let o=0,l=0,r=this.subjectMask;if(this.input.currentAtom>0){if(o=n.atomX(this.input.currentAtom),l=n.atomY(this.input.currentAtom),!this.hasSelected){r=t.booleanArray(!1,n.numAtoms);let e=n.atomConnComp(this.input.currentAtom);for(let t=1;t<=n.numAtoms;t++)r[t-1]=n.atomConnComp(t)==e}if(1==t.maskCount(r)&&r[this.input.currentAtom-1])return void(this.errmsg="Component is isolated.")}else if(this.input.currentBond>0){let e=n.bondFrom(this.input.currentBond),i=n.bondTo(this.input.currentBond);if(o=.5*(n.atomX(e)+n.atomX(i)),l=.5*(n.atomY(e)+n.atomY(i)),!this.hasSelected){r=t.booleanArray(!1,n.numAtoms);let i=n.atomConnComp(e);for(let t=1;t<=n.numAtoms;t++)r[t-1]=n.atomConnComp(t)==i}}else if(0==this.subjectLength){let e=n.boundary();o=.5*(e.minX()+e.maxX()),l=.5*(e.minY()+e.maxY()),r=t.booleanArray(!0,n.numAtoms)}else{if(1==this.subjectLength)return void(this.errmsg="Component is isolated.");for(let t=0;t<this.subjectLength;t++)o+=n.atomX(this.subjectIndex[t]),l+=n.atomY(this.subjectIndex[t]);let t=1/this.subjectLength;o*=t,l*=t}this.output.mol=n.clone(),Wt.rotateAtoms(this.output.mol,r,o,l,e)}execBondDist(t){let e=this.input.currentBond;if(0==e)return void(this.errmsg="There must be a current bond.");let i=this.input.mol.clone();if(i.bondInRing(e)){let s=i.bondFrom(e),n=i.bondTo(e),o=i.atomX(n)-i.atomX(s),l=i.atomY(n)-i.atomY(s),r=b(o,l),a=1/r,h=this.isSelected(s),u=this.isSelected(n),m=o*(t-r)*a,d=l*(t-r)*a;h&&!u?i.setAtomPos(s,i.atomX(s)-m,i.atomY(s)-d):u&&!h?i.setAtomPos(n,i.atomX(n)+m,i.atomY(n)+d):(i.setAtomPos(s,i.atomX(s)-.5*m,i.atomY(s)-.5*d),i.setAtomPos(n,i.atomX(n)+.5*m,i.atomY(n)+.5*d))}else{let[s,n,o]=this.mobileSide(e),l=i.atomX(n)-i.atomX(s),r=i.atomY(n)-i.atomY(s),a=b(l,r),h=1/a,u=l*(t-a)*h,m=r*(t-a)*h;for(let t of o)i.setAtomPos(t,i.atomX(t)-u,i.atomY(t)-m)}this.output.mol=i}execAlignAngle(t){let e=this.input.currentBond;if(0==e)return void(this.errmsg="There must be a current bond.");let i=this.input.mol.clone();if(i.bondInRing(e))return void(this.errmsg="Cannot align a ring-bond.");let[s,n,o]=this.mobileSide(e),l=i.atomX(n),r=i.atomY(n),a=t-Math.atan2(i.atomY(s)-r,i.atomX(s)-l),h=Math.cos(a),u=Math.sin(a);for(let t of o){let e=i.atomX(t)-l,s=i.atomY(t)-r;i.setAtomPos(t,l+e*h-s*u,r+e*u+s*h)}this.output.mol=i}execAlignRegular(){if(0==this.input.currentBond)return void(this.errmsg="There must be a current bond.");let e=this.input.mol.clone(),i=e.bondFrom(this.input.currentBond),s=e.bondTo(this.input.currentBond),n=Math.atan2(e.atomY(s)-e.atomY(i),e.atomX(s)-e.atomX(i))*k;n<0&&(n+=360);let o=30*Math.round(n/30);if(Math.abs(n-o)<.001)return;let l=(o-n)*S,r=this.input.selectedMask;if(t.allFalse(r)){let t=e.atomConnComp(i);for(let i=1;i<=e.numAtoms;i++)r[i-1]=t==e.atomConnComp(i)}let a=.5*(e.atomX(i)+e.atomX(s)),h=.5*(e.atomY(i)+e.atomY(s));for(let t=1;t<=e.numAtoms;t++)if(r[t-1]){let i=e.atomX(t)-a,s=e.atomY(t)-h,n=Math.atan2(s,i)+l,o=b(i,s);e.setAtomPos(t,a+o*Math.cos(n),h+o*Math.sin(n))}this.output.mol=e}execAdjustTorsion(e){if(0==this.input.currentAtom||3!=t.maskCount(this.input.selectedMask))return void(this.errmsg="Must be 3 selected atoms and a current atom.");let i=this.input.mol.clone(),s=this.input.currentAtom,n=[];for(let t=1;t<=i.numAtoms;t++)t!=s&&this.input.selectedMask[t-1]&&n.push(t);let o=i.findBond(s,n[0])>0?n.shift():i.findBond(s,n[1])>0?n.pop():0;if(0==o||0==i.findBond(o,n[0]))return void(this.errmsg="Selected atoms must be consecutive.");let l=n[0],r=i.atomX(o),a=i.atomY(o),h=Math.atan2(i.atomY(s)-a,i.atomX(s)-r),u=e-N(Math.atan2(i.atomY(l)-a,i.atomX(l)-r),h),m=[],d=[];if(0==i.atomRingBlock(s)||i.atomRingBlock(s)!=i.atomRingBlock(l)){let t=bt.fromMolecule(i);t.removeEdge(o-1,s-1),t.removeEdge(o-1,l-1);let e=t.calculateComponents();for(let i=0;i<t.numNodes;i++)e[i]==e[s-1]?m.push(i+1):e[i]==e[l-1]&&d.push(i+1)}i.atomRingBlock(s)>0&&i.atomRingBlock(s)==i.atomRingBlock(o)&&(m=[s]),i.atomRingBlock(l)>0&&i.atomRingBlock(l)==i.atomRingBlock(o)&&(d=[l]),Wt.rotateAtoms(i,t.idxMask(t.add(m,-1),i.numAtoms),r,a,-.5*u),Wt.rotateAtoms(i,t.idxMask(t.add(d,-1),i.numAtoms),r,a,.5*u),this.output.mol=i}execMove(e,i,s){let n=this.subjectIndex;if(0==t.len(n)){if(0==e)return;n=[e]}this.output.mol=this.input.mol.clone();for(let t of n)this.output.mol.setAtomPos(t,this.output.mol.atomX(t)+i,this.output.mol.atomY(t)+s)}execRing(e,i,s){let n=e.length,o=t.numberArray(0,n),l=t.numberArray(0,n),r=this.input.mol.clone();for(let t=0;t<n;t++)o[t]=Wt.atomAtPoint(r,e[t],i[t]),0==o[t]&&(o[t]=r.addAtom("C",e[t],i[t]));for(let t=0;t<n;t++){let e=t<n-1?t+1:0;l[t]=r.findBond(o[t],o[e]),0==l[t]&&(l[t]=r.addBond(o[t],o[e],1))}if(s){let e=t.numberArray(0,n),i=t.booleanArray(!1,n);for(let t=0;t<n;t++){e[t]=gt.ELEMENT_BONDING[r.atomicNumber(o[t])]+r.atomCharge(o[t]),r.atomHExplicit(o[t])!=Vt.HEXPLICIT_UNKNOWN&&(e[t]-=r.atomHExplicit(o[t]));for(let i of r.atomAdjBonds(o[t]))e[t]-=r.bondOrder(i);r.bondOrder(l[t])>=2&&(i[t]=!0,t<n-1?(i[t]=!0,t++):i[0]=!0)}for(let t=0;t<n;t++){let s=t<n-1?t+1:0;i[t]||i[s]||e[t]>0&&e[s]>0&&(r.setBondOrder(l[t],2),i[t]=!0,i[s]=!0,e[t]--,e[s]--)}}this.output.mol=r}execTemplateFusion(t){let e=this.input.mol,i=new Ce(e,t,"");0==this.subjectLength?i.permuteNone():1==this.subjectLength?i.permuteAtom(this.subjectIndex[0]):2==this.subjectLength&&e.findBond(this.subjectIndex[0],this.subjectIndex[1])>0?i.permuteBond(this.subjectIndex[0],this.subjectIndex[1]):i.permuteMulti(this.subjectIndex);let s=[];for(let t of i.perms){let e={};e.mol=t.mol.toString(),e.display=t.display.toString(),e.molidx=t.molidx,e.temidx=t.temidx,e.srcidx=t.srcidx,s.push(e)}this.output.permutations=s}execAbbrevTempl(){}execAbbrevGroup(){if(!this.requireSubject())return;if(!this.checkAbbreviationReady())return;let e=Kt.convertToAbbrev(this.input.mol,t.notMask(this.subjectMask),"?");if(null!=e){if(Te.main){Te.main.submitMolecule(e,!0);for(let t=1;t<=e.numAtoms;t++)"?"==e.atomElement(t)&&Kt.hasAbbrev(e,t)&&Te.main.substituteAbbrevName(e,t)}this.output.mol=e,this.zapSubject(),this.output.currentAtom=e.numAtoms}else this.errmsg="Inline abbreviations must be terminal with exactly one attachment point."}execAbbrevFormula(){if(!this.requireSubject())return;if(!this.checkAbbreviationReady())return;let e=this.input.mol.clone();for(let t=1;t<=e.numAtoms;t++)e.setAtomHExplicit(t,e.atomHydrogens(t));let i=Kt.subgraphMask(e,this.subjectMask),s=Kt.molecularFormula(i,!0),n=Kt.convertToAbbrev(this.input.mol,t.notMask(this.subjectMask),s);null!=n?(this.output.mol=n,this.zapSubject(),this.output.currentAtom=n.numAtoms):this.errmsg="Inline abbreviations must be terminal with exactly one attachment point."}execAbbrevClear(){let t=[];for(let e of this.subjectIndex)Kt.hasAbbrev(this.input.mol,e)&&t.push(e);if(0==t.length)return void(this.errmsg="No abbreviations to clear.");let e=this.input.mol.clone();for(let i of t)Kt.clearAbbrev(e,i);this.output.mol=e}execAbbrevExpand(){let t=[];for(let e of this.subjectIndex)Kt.hasAbbrev(this.input.mol,e)&&t.push(e);if(0==t.length)return void(this.errmsg="No abbreviations to expand.");let e=this.input.mol.clone();for(let i of t)Kt.expandOneAbbrev(e,i,!0);this.output.mol=e,this.zapSubject()}execBondArtifact(t){if(!this.requireAtoms()||!this.requireSubject())return;let e=new Mt(this.input.mol.clone()),i=this.subjectIndex.slice(0),s=this.input.currentAtom;if(s>0&&i.indexOf(s)<0&&i.push(s),t==Se.BondArtifactPath){if(!e.createPath(i))return void(this.errmsg="Path artifact not suitable.")}else if(t==Se.BondArtifactRing){if(!e.createRing(i))return void(this.errmsg="Ring artifact not suitable.")}else if(t==Se.BondArtifactArene){if(!e.createArene(i))return void(this.errmsg="Arene artifact not suitable.")}else if(t==Se.BondArtifactClear&&!e.removeArtifact(i)){if(this.removePolymerBlock(i))return;return void(this.errmsg="No artifact removed.")}e.rewriteMolecule(),this.output.mol=e.mol}execPolymerBlock(){this.requireAtoms()&&this.requireSubject()&&this.owner&&this.owner.performPolymerBlock(this.subjectIndex)}execAddHydrogens(){let e=this.input.mol.clone();if(!this.requireAtoms())return;let i=this.subjectIndex;0==i.length&&(i=t.identity1(e.numAtoms));for(let t of i){let i=e.atomHydrogens(t);i>0&&Qt.placeAdditionalHydrogens(e,t,i)}e.numAtoms!=this.input.mol.numAtoms?this.output.mol=e:this.errmsg="Nothing needs to be added."}execRemoveHydrogens(){if(!this.requireAtoms())return;let e=this.input.mol,i=this.subjectMask;t.allFalse(i)&&(i=t.booleanArray(!0,e.numAtoms));let s=t.booleanArray(!0,e.numAtoms);for(let t=1;t<=e.numAtoms;t++)if(Kt.boringHydrogen(e,t)){let n=e.atomAdjList(t)[0];(i[t-1]||i[n-1])&&(s[t-1]=!1)}t.allTrue(s)?this.errmsg="Nothing to be deleted.":this.output.mol=Kt.subgraphMask(e,s)}execQueryClear(){if(!this.requireSubject())return;let t=this.input.mol.clone();const{currentBond:e}=this.input;if(e>0&&It.hasAnyQueryBond(t,e))return It.deleteQueryBondAll(t,e),void(this.output.mol=t);let i=!1;for(let e of this.subjectIndex)It.hasAnyQueryAtom(t,e)&&(It.deleteQueryAtomAll(t,e),i=!0);for(let e=1;e<=t.numBonds;e++)this.subjectMask[t.bondFrom(e)-1]&&this.subjectMask[t.bondTo(e)-1]&&It.hasAnyQueryBond(t,e)&&(It.deleteQueryBondAll(t,e),i=!0);i?this.output.mol=t:this.errmsg="No query terms to clear."}execQueryCopy(){if(!this.requireSubject())return;const{mol:t,currentBond:e}=this.input;if(e>0){if(!It.hasAnyQueryBond(t,e))return void(this.errmsg="Bond has no query terms.");let i=new Vt;i.addAtom("*",0,0),i.addAtom("*",Vt.IDEALBOND,0),i.addBond(1,2,1),i.setBondExtra(1,t.bondExtra(e).filter((t=>t.startsWith("q")))),this.toClipboard=i.toString()}else if(1==this.subjectLength){let e=this.subjectIndex[0];if(!It.hasAnyQueryAtom(t,e))return void(this.errmsg="Atom has no query terms.");let i=new Vt;i.addAtom("*",0,0),i.setAtomExtra(1,t.atomExtra(e).filter((t=>t.startsWith("q")))),this.toClipboard=i.toString()}else this.errmsg="Subject has to be a single atom or bond."}execQueryPaste(){if(!this.requireSubject())return;let t=this.param.qmol;if(t){if(1==t.numAtoms&&"*"==t.atomElement(1)&&It.hasAnyQueryAtom(t,1)){let e=this.output.mol=this.input.mol.clone(),i=t.atomExtra(1).filter((t=>t.startsWith("q")));for(let t of this.subjectIndex){let s=e.atomExtra(t).filter((t=>t.startsWith("q")));e.setAtomExtra(t,[...s,...i])}return}if(2==t.numAtoms&&"*"==t.atomElement(1)&&"*"==t.atomElement(2)&&1==t.numBonds&&It.hasAnyQueryBond(t,1)){let e=this.output.mol=this.input.mol.clone(),i=t.bondExtra(1).filter((t=>t.startsWith("q")));for(let t=1;t<=e.numBonds;t++)if(this.subjectMask[e.bondFrom(t)-1]&&this.subjectMask[e.bondTo(t)-1]){let s=e.bondExtra(t).filter((t=>t.startsWith("q")));e.setBondExtra(t,[...s,...i])}return}}this.errmsg="Unable to paste query terms."}execQuerySetAtom(){}execQuerySetBond(){}execQueryBondAny(){if(!this.requireSubject())return;const{mol:t,currentBond:e}=this.input;let i=[];for(let e=1;e<=t.numBonds;e++)this.subjectMask[t.bondFrom(e)-1]&&this.subjectMask[t.bondTo(e)-1]&&i.push(e);if(0!=i.length){this.output.mol=t.clone();for(let t of i)this.output.mol.setBondOrder(t,0),It.setQueryBondOrders(this.output.mol,t,[-1,0,1,2,3,4])}else this.errmsg="Must select at least one bond."}execSproutDirection(e,i){var s,n;if(!this.requireCurrent())return;if(0==e&&0==i)return;const{mol:o,currentAtom:l}=this.input;let r;if(r=0==o.atomAdjCount(l)?t.identity0(12).map((t=>t*E/12)):null!==(s=Qt.primeDirections(o,l))&&void 0!==s?s:Qt.exitVectors(o,l),0==r.length)return;let a=Math.atan2(i,e),h=t.idxMin(r.map((t=>Math.abs(N(a,t))+.01*Math.abs(Math.sin(t))))),u=o.atomX(l)+Vt.IDEALBOND*Math.cos(r[h]),m=o.atomY(l)+Vt.IDEALBOND*Math.sin(r[h]);this.output.mol=o.clone();let d=this.output.mol.addAtom("C",u,m);this.output.mol.addBond(l,d,1),this.output.mol=null!==(n=Qt.joinOverlappingAtoms(this.output.mol,t.booleanArray(!0,this.output.mol.numAtoms)))&&void 0!==n?n:this.output.mol;for(let t=1;t<=this.output.mol.numAtoms;t++)if(y(this.output.mol.atomX(t)-u,this.output.mol.atomY(t)-m)<Wt.OVERLAP_THRESHOLD_SQ){this.output.currentAtom=t;break}}requireSubject(){return 0==this.subjectLength&&(this.errmsg="Subject required: current atom/bond or selected atoms."),this.subjectLength>0}requireAtoms(){return 0==this.input.mol.numAtoms&&(this.errmsg="There are no atoms."),this.input.mol.numAtoms>0}requireCurrent(){return 0!=this.input.currentAtom||0!=this.input.currentBond||(this.errmsg="There must be a current atom or bond.",!1)}requireSelected(){return this.hasSelected||(this.errmsg="No atoms are selected."),this.hasSelected}pickSelectedGroup(t,e){if(0==this.subjectLength)return 0;for(let i=0;i<t.length;i++){let s=t[i],n=!0;for(let t=0;t<s.length;t++)if(!this.subjectMask[s[t]-1]){n=!1;break}if(n)return i+=e,i<0?i+t.length:i>=t.length?i-t.length:i}for(let e=0;e<t.length;e++){let i=t[e];for(let t=0;t<i.length;t++)if(this.subjectMask[i[t]-1])return e}return 0}zapSubject(){this.output.currentAtom=0,this.output.currentBond=0,this.output.selectedMask=t.booleanArray(!1,this.input.mol.numAtoms)}performBondNew(e,i,s){let n=this.input.mol,o=Qt.calculateNewBondAngles(n,e,i);if(0==o.length&&(o=Qt.exitVectors(n,e)),0==o.length)return void(this.errmsg="Could not find a suitable geometry for a new substituent.");let l=[],r=[],a=[];for(let t=0;t<o.length;t++){let i=n.atomX(e)+Vt.IDEALBOND*Math.cos(o[t]),s=n.atomY(e)+Vt.IDEALBOND*Math.sin(o[t]),h=Wt.congestionPoint(n,i,s);gt.ELEMENT_BLOCKS[n.atomicNumber(e)]<=2?h+=1e-8*Math.abs(B(o[t])):h+=1e-8*Math.abs(N(.5*Math.PI,o[t])),l.push(i),r.push(s),a.push(h)}let h=t.idxSort(a);this.output.mol=n.clone();let u=Wt.atomAtPoint(this.output.mol,l[h[0]],r[h[0]]);0==u&&(u=this.output.mol.addAtom("C",l[h[0]],r[h[0]])),Kt.addBond(this.output.mol,e,u,i,s),h.length>=2&&(this.output.altmol=n.clone(),u=Wt.atomAtPoint(this.output.altmol,l[h[1]],r[h[1]]),0==u&&(u=this.output.altmol.addAtom("C",l[h[1]],r[h[1]])),Kt.addBond(this.output.altmol,e,u,i,s))}performBondChange(t,e){let i=this.input.mol,s=[];for(let t=1;t<=i.numBonds;t++)this.subjectMask[i.bondFrom(t)-1]&&this.subjectMask[i.bondTo(t)-1]&&s.push(t);let n=e==Vt.BONDTYPE_DECLINED||e==Vt.BONDTYPE_INCLINED,o=n||e==Vt.BONDTYPE_UNKNOWN,l=n;for(let n=0;n<s.length&&!l;n++){let o=s[n];(i.bondOrder(o)!=t&&e==Vt.BONDTYPE_NORMAL||i.bondType(o)!=e)&&(l=!0)}if(l){this.output.mol=i.clone();for(let i=0;i<s.length;i++){let l=s[i],r=this.output.mol.bondFrom(l),a=this.output.mol.bondTo(l);n&&this.output.mol.bondType(l)==e?this.output.mol.setBondFromTo(l,a,r):this.output.mol.bondOrder(l)!=t||this.output.mol.bondType(l)!=e?o||t==this.output.mol.bondOrder(l)?this.output.mol.setBondType(l,e):this.output.mol.setBondOrder(l,t):n&&this.output.mol.setBondFromTo(l,a,r)}}else this.errmsg="No bond changes made."}performBondGeomAtom(t,e){let i=this.input.mol,s=i.atomAdjList(e).length,n=Qt.GEOM_ANGLES[t].length;if(s>n)return void(this.errmsg="The current atom has more bonds than does the selected geometry.");if(0==s)return void this.performBondNew(e,1,Vt.BONDTYPE_NORMAL);if(s==n)return this.output.mol=Qt.refitAtomGeometry(i,e,t),void(null==this.output.mol&&(this.errmsg="Could not re-fit the atom geometry."));let o=Wt.atomBondAngles(i,e),l=Qt.mapAngleSubstituent(t,o);if(null==l)return this.output.mol=Qt.refitAtomGeometry(i,e,t),void(null==this.output.mol&&(this.errmsg="Could not re-fit the atom geometry."));this.output.mol=i.clone();let r=Qt.pickNewAtomDirection(i,e,l),a=this.output.mol.atomX(e)+Vt.IDEALBOND*Math.cos(r),h=this.output.mol.atomY(e)+Vt.IDEALBOND*Math.sin(r),u=Wt.atomAtPoint(this.output.mol,a,h);0==u&&(u=this.output.mol.addAtom("C",a,h)),Kt.addBond(this.output.mol,e,u,1)}performBondGeomBond(t,e){let i=this.input.mol,s=i.bondFrom(e),n=i.bondTo(e),o=i.atomAdjCount(s),l=i.atomAdjCount(n);if(o>1&&1==l);else{if(!(1==o&&l>1))return void(this.errmsg="One end of the bond must be terminal.");{let t=o;o=l,l=t}}let r=i.atomAdjList(s),a=i.atomX(s),h=i.atomY(s),u=i.atomX(n),m=i.atomY(n),d=[];for(let t=0;t<r.length;t++)r[t]!=n&&d.push(Math.atan2(i.atomY(r[t])-h,i.atomX(r[t])-a));let c=Qt.mapAngleSubstituent(t,d);if(null==c)return void(this.errmsg="No alternative geometries identified.");let p=E+1,f=0,g=0,y=Math.atan2(m-h,u-a),x=b(u-a,m-h);for(let t=0;t<c.length;t++){let e=N(c[t],y);if(e<0&&(e+=E),t>0&&e>p)continue;let s=a+x*Math.cos(e+y),n=h+x*Math.sin(e+y);Wt.atomAtPoint(i,s,n)>0||(p=e,f=s,g=n)}p>E?this.errmsg="No alternative geometries identified.":(this.output.mol=i.clone(),this.output.mol.setAtomPos(n,f,g))}checkAbbreviationReady(){let t=0,e=this.input.mol,i=this.subjectMask;for(let s=1;s<=e.numBonds;s++){let n=e.bondFrom(s),o=e.bondTo(s),l=0;if(i[n-1]&&!i[o-1]&&Kt.hasAbbrev(e,n)||i[o-1]&&!i[n-1]&&Kt.hasAbbrev(e,o))return this.errmsg="Already an abbreviation.",!1;if(i[n-1]&&!i[o-1]?l=n:i[o-1]&&!i[n-1]&&(l=o),0==l||l==t);else{if(0!=t)return this.errmsg="The selected group must be terminal.",!1;t=l}}return!0}mobileSide(e,i=!1){let{mol:s}=this.input,n=s.bondFrom(e),o=s.bondTo(e),l=bt.fromMolecule(s);l.removeEdge(n-1,o-1);let r=[],a=[];for(let e of l.calculateComponentGroups())e.includes(n-1)&&(r=t.add(e,1)),e.includes(o-1)&&(a=t.add(e,1));let h=r.length*(s.atomRingBlock(n)>0?2:1),u=a.length*(s.atomRingBlock(o)>0?2:1),m=!1,d=!1;for(let t of r)if(this.isSelected(t)){m=!0;break}for(let t of a)if(this.isSelected(t)){d=!0;break}if(i&&1==s.atomAdjCount(n))return[o,n,a];if(i&&1==s.atomAdjCount(o))return[n,o,r];if(m&&!d);else if(d&&!m||u<h)return[o,n,a];return[n,o,r]}isSelected(t){let e=this.input.selectedMask;return!!e&&e[t-1]}removePolymerBlock(t){let e=new Ot(this.input.mol.clone());for(let i of e.getIDList()){let s=e.getUnit(i);for(let n of t)if(s.atoms.includes(n))return e.removeUnit(i),e.rewriteMolecule(),this.output.mol=e.mol,!0}return!1}}!function(t){t[t.None=0]="None",t[t.Mass=1]="Mass",t[t.Volume=2]="Volume",t[t.Moles=3]="Moles"}(ke||(ke={}));class Ne{constructor(t){this.mixture=t,this.notes=[]}analyse(){let e=this.mixture.getOrigins(),i=e.map((t=>this.mixture.getComponent(t)));for(let s=0;s<e.length;s++){let n={origin:e[s]},o=i[s];if(o.molfile&&t.isBlank(o.contents)){let e=Ut.readUnknown(o.molfile);if(!e)continue;let i=this.enumerateStereo(e);t.notBlank(i)&&(n.stereoEnum=i.map((t=>Ut.writeMDLMOL(t))))}this.notes.push(n)}let s=[];for(let i=0;i<e.length;i++){s[i]=[];let n=e[i];for(let o=i+1;o<e.length;o++)e[o].length==n.length+1&&t.equals(n,e[o].slice(0,n.length))&&s[i].push(o)}let n=new Array(e.length).fill(ke.None),o=t.numberArray(null,e.length),l=t.numberArray(null,e.length),r=t.numberArray(null,e.length);for(;;){let a=!1;for(let h=0;h<e.length;h++){let e=i[h];if(this.notes[h],n[h]==ke.None&&([n[h],o[h],l[h],r[h]]=this.toAbsoluteUnits(e),n[h]!=ke.None&&(a=!0)),!t.isBlank(e.contents)){if(n[h]==ke.None){let t=0,e=ke.None;for(let i of s[h]){if(n[i]==ke.None||null!=l[i]||e!=ke.None&&n[i]!=e){e=ke.None;break}e=n[i],t+=o[i]}e!=ke.None&&(n[h]=e,o[h]=t,a=!0)}if(n[h]!=ke.None&&s[h].length>=2){let t=-1,e=0;for(let i of s[h])if(n[i]==ke.None){if(t>=0){t=-1;break}t=i}else{if(n[i]!=n[h]){t=-1;break}if(null!=l[i]){t=-1;break}e+=o[i]}t>=0&&(n[t]=n[h],o[t]=o[h]-e,a=!0)}}}if(!a)break}for(let t=0;t<e.length;t++)if(n[t]!=ke.None)for(let e of s[t])if(n[e]!=ke.None){let s=0,a=o[t],h=null;n[e]==ke.Mass?n[t]==ke.Mass?[s,h]=[100/a,ne.pcWW]:n[t]==ke.Volume?[s,h]=[100/a,ne.pcWV]:(n[t],ke.Moles):n[e]==ke.Volume?n[t]==ke.Mass||(n[t]==ke.Volume?[s,h]=[100/a,ne.pcVV]:(n[t],ke.Moles)):n[e]==ke.Moles&&(n[t]==ke.Mass||(n[t]==ke.Volume?[s,h]=[1/a,ne.mol_L]:n[t]==ke.Moles&&([s,h]=[100/a,ne.pcMM]))),null!=h&&(null==l[e]?(this.notes[e].concQuantity=o[e]*s,this.notes[e].concError=null==r[e]?null:r[e]*s):this.notes[e].concQuantity=[o[e]*s,l[e]*s],this.notes[e].concUnits=he.uriToName(h),this.notes[e].concRelation=i[t].relation)}}findNote(e){for(let i of this.notes)if(t.equals(e,i.origin))return i;return null}enumerateStereo(t){let e=t=>{for(let e=1;e<=t.numBonds;e++)if(t.bondType(e)==Vt.BONDTYPE_UNKNOWN){let i=t.clone(),s=t.clone();if(1==t.bondOrder(e))return i.setBondType(e,Vt.BONDTYPE_DECLINED),s.setBondType(e,Vt.BONDTYPE_INCLINED),[i,s];if(2==t.bondOrder(e)){let i=t.clone();i.setBondType(e,Vt.BONDTYPE_NORMAL);let s=null;if(!t.bondInRing(e)){let t=new Be({mol:i,currentAtom:0,currentBond:e,selectedMask:null},Se.BondRotate,{});t.execute(),!t.errmsg&&t.output.mol&&(s=t.output.mol)}return s?[i,s]:[i]}}return null},i=[t];for(let t=0;t<i.length;t++){let s=e(i[t]);if(s){i[t]=s[0];for(let e=s.length-1;e>=1;e--)i.splice(t+1,0,s[e]);t--}}return i.length>1?i:null}toAbsoluteUnits(t){if(!t.units||null==t.quantity)return[ke.None,null,null,null];let e=he.nameToURI(t.units);if(!e)return[ke.None,null,null,null];let i=0,s=ke.None;if(e==ne.kg)[i,s]=[1e3,ke.Mass];else if(e==ne.g)[i,s]=[1,ke.Mass];else if(e==ne.mg)[i,s]=[.001,ke.Mass];else if(e==ne.ug)[i,s]=[1e-6,ke.Mass];else if(e==ne.ng)[i,s]=[1e-9,ke.Mass];else if(e==ne.L)[i,s]=[1,ke.Volume];else if(e==ne.mL)[i,s]=[.001,ke.Volume];else if(e==ne.uL)[i,s]=[1e-6,ke.Volume];else if(e==ne.nL)[i,s]=[1e-9,ke.Volume];else if(e==ne.mol)[i,s]=[1,ke.Moles];else if(e==ne.mmol)[i,s]=[.001,ke.Moles];else if(e==ne.umol)[i,s]=[1e-6,ke.Moles];else{if(e!=ne.nmol)return[ke.None,null,null,null];[i,s]=[1e-9,ke.Moles]}if("number"==typeof t.quantity){let e=null==t.error?null:t.error*i;return[s,t.quantity*i,null,e]}{let[e,n]=t.quantity;return[s,e*i,n*i,null]}}}class qe{constructor(t){this.mixfile=t,t?this.mixfile.mixfileVersion||(this.mixfile.mixfileVersion=1):this.mixfile={mixfileVersion:1}}static fromComponent(t){let e=Y(t);return e.mixfileVersion=1,new qe(e)}isEmpty(){return qe.isComponentEmpty(this.mixfile)}static isComponentEmpty(e){const i=["name","description","synonyms","formula","molfile","inchi","inchiKey","smiles","ratio","quantity","units","relation","identifiers","links"];for(let t of i)if(null!=e[t])return!1;return!(t.arrayLength(e.contents)>0)}static hasQuantity(t){return null!=t.quantity||null!=t.ratio}clone(){return new qe(Y(this.mixfile))}equals(t){return null!=t&&this.recursiveEqual(this.mixfile,t.mixfile)}static deserialise(t){let e=JSON.parse(t);return new qe(e)}serialise(){return qe.beautify(this.mixfile)}static serialiseComponent(t){return qe.beautify(t)}getComponent(t){if(0==t.length)return this.mixfile;let e=null,i=this.mixfile.contents||[];for(let s of t){if(e=i[s],!e)return null;i=e.contents||[]}return e}getParentComponent(t){return 0==t.length?null:((t=t.slice()).pop(),this.getComponent(t))}getComponents(){let t=[],e=[this.mixfile];for(;e.length>0;){let i=e.shift();if(t.push(i),i.contents)for(let t of i.contents)e.push(t)}return t}getOrigins(){let e=[],i=(s,n)=>{e.push(s);for(let e=0;e<t.arrayLength(n.contents);e++)i(t.append(s,e),n.contents[e])};return i([],this.mixfile),e}setComponent(t,e){let i=this.mixfile,s=this.mixfile.contents;for(let e of t)i=s[e],s=i.contents;let n=!1;for(let t in e){let s=e[t];s!=i[t]&&(i[t]=s,n=!0)}return Object.keys(i).forEach((t=>{null==i[t]&&delete i[t]})),n}deleteComponent(t){if(0==t.length)return;let e=this.mixfile,i=this.mixfile.contents,s=i;for(let n of t)s=i,e=i[n],i=e.contents;let n=t[t.length-1];if(s.splice(n,1),i)for(let t of i)s.splice(n++,0,t)}prependBefore(t,e){if(0==t.length){let t=this.mixfile,e={};const i=["mixfileVersion","contents"];for(let s in t)i.includes(s)||(e[s]=t[s],delete t[s]);return void(t.contents=[e])}let i=this.mixfile,s=this.mixfile.contents,n=s;for(let e of t)n=s,i=s[e],s=i.contents;n[t[t.length-1]]=e,e.contents=[i]}static splitOrigin(t){if(0==t.length)return[null,null];let e=t.slice(0),i=e.splice(t.length-1,1)[0];return[e,i]}static beautify(t){let e=JSON.stringify(t,null,4).split("\n"),i=/^(\s*\"\w+\": )([\[\{].*)$/,s=/^(\s*)/;for(let t=0;t<e.length;t++){let n=i.exec(e[t]);if(!n)continue;let o=s.exec(e[t]);e[t]=n[1]+"\n"+o[1]+n[2]}return e.join("\n")}recursiveEqual(e,i){let s=e,n=i,o=[],l=[];for(let t in s)"contents"!=t&&null!=s[t]&&o.push(t);for(let t in n)"contents"!=t&&null!=n[t]&&l.push(t);if(o.sort(),l.sort(),!t.equals(o,l))return!1;for(let e of o){let i=s[e],o=n[e];if(Array.isArray(i)&&Array.isArray(o)){if(!t.equals(i,o))return!1}else if(i!=o)return!1}let r=t.arrayLength(e.contents);if(r!=t.arrayLength(i.contents))return!1;for(let t=0;t<r;t++)if(!this.recursiveEqual(e.contents[t],i.contents[t]))return!1;return!0}}let Oe=[];const Ie=4294967295;function Le(t){return t^Ie}var De,Re,Pe;!function(t){t[t.None=0]="None",t[t.Header=1]="Header",t[t.Component=2]="Component",t[t.Hierarchy=3]="Hierarchy",t[t.Concentration=4]="Concentration"}(De||(De={}));class ze{constructor(t,e){this.inchi=e,this.minchi="?",this.segment=null,this.mixture=new qe(Y(t)),this.norm=new Ne(this.mixture),this.norm.analyse()}fillInChI(){return t=this,e=void 0,s=function*(){let t=!1;for(let e of this.mixture.getComponents()){if(!e.molfile||e.inchi)continue;let i=null;try{i=Ut.readUnknown(e.molfile)}catch(t){continue}if(Kt.isBlank(i))continue;let{inchi:s,inchiKey:n}=yield this.inchi.generate(i);e.inchi=s,e.inchiKey=n,t=!0}return t},new((i=void 0)||(i=Promise))((function(n,o){function l(t){try{a(s.next(t))}catch(t){o(t)}}function r(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(l,r)}a((s=s.apply(t,e||[])).next())}));var t,e,i,s}formulate(){let e=this.mixture.clone();for(let t of e.getOrigins()){let i=this.norm.findNote(t);i&&(e.getComponent(t).note=i)}t:for(let i of e.getComponents())if(t.len(i.contents)>=2){if(2!=t.len(i.contents[0].ratio))continue;let[e,s]=i.contents[0].ratio;for(let n=1;n<i.contents.length;n++){let o=i.contents[n].ratio;if(2!=t.len(o)||o[1]!=s)continue t;e+=o[0]}if(e!=s)continue;for(let t of i.contents)t.useRatio=t.ratio[0]}let i=[];for(let s of e.getOrigins()){let n=e.getComponent(s);t.len(n.contents)>0||(n.inchiFrag=n.inchi||"",n.inchiFrag.startsWith("InChI=1S/")&&(n.inchiFrag=n.inchiFrag.substring(9)),i.includes(n.inchiFrag)||i.push(n.inchiFrag))}i.sort();let s=e.mixfile,n=this.assembleContents(s,i);this.minchi="",this.segment=[];let o=(t,e)=>{this.minchi+=t;for(let i=0;i<t.length;i++)this.segment.push(e)};o("MInChI=0.99.1S",De.Header),o("/",De.None);for(let t=0;t<i.length;t++)t>0&&o("&",De.None),o(i[t],De.Component);o("/",De.None),o("n"+n.layerN,De.Hierarchy),o("/",De.None),o("g"+n.layerG,De.Concentration)}getResult(){return this.minchi}getSegment(){return this.segment}makeLongHashKey(){let e=[];for(let t of this.mixture.getComponents())if(t.molfile){if(!t.inchiKey)throw"Mixture has InChIKey(s) missing";if(!t.inchiKey.startsWith("InChIKey="))throw"Invalid InChI key: "+t.inchiKey;e.push(t.inchiKey.substring(9))}return e=t.sortedUnique(e),"Long-MInChIKey="+e.join(";")}makeShortHashKey(){!function(){if(!(Oe.length>0))for(let t=0;t<256;t++){let e=t;for(let t=0;t<8;t++)1&e?e=3988292384^e>>>1:e>>>=1;Oe.push(e)}}();const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ";let i=[],s=0;for(let t=0;t<4;t++)i.push(Ie);let n=t=>{let n=e.indexOf(t);var o;n<0||(i[s]=(o=i[s],Oe[255&(o^n)]^o>>>8),s=s<3?s+1:0)},o=[];for(let t of this.mixture.getComponents())if(t.molfile){if(!t.inchiKey)throw"Mixture has InChIKey(s) missing";if(!t.inchiKey.startsWith("InChIKey="))throw"Invalid InChI key: "+t.inchiKey;o.push(t.inchiKey.substring(9))}for(let e of t.sortedUnique(o))for(let t of e)n(t);let l="Short-MInChIKey=";for(let t of i){t=Le(t)>>>1;for(let i=0;i<7;i++)l+=e[t%26],t=Math.trunc(t/26)}return l}static formatConcentration(t,e,i,s,n){let o=(t,e)=>Math.round(t*Math.pow(10,-e)).toString();if(null!=i){let t=this.determineExponent([i],4);return o(i,t)+"rt"+t}if(null==t||null==s)return null;let l=s;if(l.startsWith("http://")||(l=he.nameToURI(l)),!l)return;let r=[];null!=n&&r.push(n);let a="number"==typeof t?[t]:t;null!=e&&a.push(e);let[h,u]=he.convertToMInChI(l,a);if(!h)return;let m=this.determineExponent(u,4);return r.push(o(u[0],m)),u.length>1&&(Array.isArray(t)?r.push(":"):r.push("?"),r.push(o(u[1],m))),r.push(h),r.push(m.toString()),r.join("")}assembleContents(e,i){let s={layerN:"",layerG:""},n={layerN:"",layerG:""};if(t.len(e.contents)>0&&null!=e.contents)for(let t of e.contents){let e=this.assembleContents(t,i);(s.layerN.length>0||s.layerG.length>0)&&(s.layerN+="&",s.layerG+="&"),s.layerN+=e.layerN,s.layerG+=e.layerG}let o=null!=e.inchiFrag?i.indexOf(e.inchiFrag)+1:0;o>0&&(n.layerN+=o.toString());let l=ze.formatConcentration(e.quantity,e.error,e.useRatio,e.units,e.relation);if(!l&&e.note){let{concQuantity:t,concError:i,concUnits:s,concRelation:n}=e.note;l=ze.formatConcentration(t,i,null,s,n)}return l&&(n.layerG+=l),(s.layerN.length>0||s.layerG.length>0)&&(n.layerN="{"+s.layerN+"}"+n.layerN,n.layerG="{"+s.layerG+"}"+n.layerG,this.shaveBeard(n)),n}shaveBeard(t){for(;t.layerN.startsWith("{{")&&t.layerN.endsWith("}}")&&t.layerG.startsWith("{{")&&t.layerG.endsWith("}}");)t.layerN=t.layerN.substring(1,t.layerN.length-1),t.layerG=t.layerG.substring(1,t.layerG.length-1)}static determineExponent(t,e){let i=Number.POSITIVE_INFINITY;for(let e of t)i=Math.min(i,Math.abs(e));if(!Number.isFinite(i)||Number.isNaN(i)||i<=0)return 0;let s=Math.round(Math.log10(i))-e,n=[];for(let e of t)n.push(Math.round(e*Math.pow(10,-s)).toString());t:for(;;){for(let t=0;t<n.length;t++){if(!n[t].endsWith("0"))break t;n[t]=n[t].substring(0,n[t].length-1)}s++}return s}}class Fe{constructor(){this.ds=new Et,this.colMol=this.ds.appendColumn("Molecule","molecule",""),this.colName=this.ds.appendColumn("Name","string",""),this.colHier=this.ds.appendColumn("MINCHI$N","string",""),this.colConc=this.ds.appendColumn("MINCHI$C","string","")}append(t){if(t.name||t.molfile||t.inchi)this.appendComponent(t,[1]);else if(t.contents)for(let e=0;e<t.contents.length;e++)this.appendComponent(t.contents[e],[e+1])}write(){return new Xt(this.ds).write()}appendComponent(t,e){let i=this.ds.appendRow(),s=null;if(t.molfile&&(s=Vt.fromString(t.molfile),!s))try{s=new zt(t.molfile).parse()}catch(t){}if(s||(s=new Vt),this.ds.setMolecule(i,this.colMol,s),t.name&&this.ds.setString(i,this.colName,t.name),this.ds.setString(i,this.colHier,e.join(".")),this.ds.setString(i,this.colConc,this.formatConcentration(t)),t.contents)for(let i=0;i<t.contents.length;i++){let s=e.slice(0);s.push(i+1),this.appendComponent(t.contents[i],s)}}formatConcentration(e){let i=null;return 2==t.len(e.ratio)&&(i=e.ratio[0]),ze.formatConcentration(e.quantity,e.error,i,e.units,e.relation)}}class _e{constructor(t){if(t)this.data=_(t);else{t={name:"default",pointScale:20,resolutionDPI:100,fontSize:.65,lineSize:.075,bondSep:.2,defaultPadding:.2,foreground:0,background:16777215,atomCols:new Array(112)};for(let e=0;e<=111;e++)t.atomCols[e]=0;this.data=t}}clone(){return new _e(this.data)}static defaultBlackOnWhite(t){let e=new _e;return t&&(e.data.pointScale=t),e}static defaultWhiteOnBlack(t){let e=new _e;t&&(e.data.pointScale=t),e.data.foreground=16777215,e.data.background=0;for(let t=0;t<=111;t++)e.data.atomCols[t]=16777215;return e}static defaultColourOnWhite(t){let e=_e.defaultBlackOnWhite(t);return e.data.atomCols[0]=4210752,e.data.atomCols[1]=8421504,e.data.atomCols[6]=0,e.data.atomCols[7]=255,e.data.atomCols[8]=16711680,e.data.atomCols[9]=16744576,e.data.atomCols[15]=16744448,e.data.atomCols[16]=8421376,e.data.atomCols[17]=49152,e.data.atomCols[35]=12599296,e}static defaultColourOnBlack(t){let e=_e.defaultWhiteOnBlack(t);return e.data.atomCols[0]=10526880,e.data.atomCols[1]=8421504,e.data.atomCols[6]=16777215,e.data.atomCols[7]=4210943,e.data.atomCols[8]=16728128,e.data.atomCols[9]=16744576,e.data.atomCols[15]=16744448,e.data.atomCols[16]=16776960,e.data.atomCols[17]=4259648,e.data.atomCols[35]=16744512,e}static defaultPrintedPublication(){let t=_e.defaultBlackOnWhite(9.6);return t.data.resolutionDPI=600,t.data.fontSize=.8,t.data.bondSep=.27,t.data.lineSize=.0625,t}}class Ye{constructor(){this.colAtom={},this.colBond={},this.dottedRectOutline={},this.dottedBondCross={},this.hideAtoms=new Set,this.hideBonds=new Set,this.atomFrameDotSz=[],this.atomFrameCol=[],this.atomCircleSz=[],this.atomCircleCol=[],this.atomDecoText=[],this.atomDecoCol=[],this.atomDecoSize=[],this.bondDecoText=[],this.bondDecoCol=[],this.bondDecoSize=[],this.overlapAtoms=[]}}!function(t){t.Atom="A",t.Bond="B",t.Artifact="R",t.Effect="E"}(Re||(Re={}));class Xe{constructor(){this.UNITS_PER_EM=2048,this.INV_UNITS_PER_EM=1/this.UNITS_PER_EM,this.PANOSE_1="2 11 6 4 3 5 4 4 2 4",this.ASCENT=1638,this.DESCENT=-410,this.MISSING_HORZ=2048,this.MISSING_DATA="M256 0v1536h1536v-1536h-1536zM384 128h1280v1280h-1280v-1280z",this.ASCENT_FUDGE=.9,this.UNICODE=[" ","!",'"',"#","$","%","&","'","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","[","\\","]","^","_","`","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","{","|","}","~","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],this.HORIZ_ADV_X=[720,806,940,1676,1302,2204,1488,550,930,930,1302,1676,745,930,745,930,1302,1302,1302,1302,1302,1302,1302,1302,1302,1302,930,930,1676,1676,1676,1117,2048,1400,1404,1430,1578,1295,1177,1588,1539,862,931,1419,1140,1726,1532,1612,1235,1612,1424,1400,1262,1499,1400,2025,1403,1260,1403,930,930,930,1676,1302,1302,1230,1276,1067,1276,1220,720,1276,1296,562,705,1212,562,1992,1296,1243,1276,1276,874,1067,807,1296,1212,1676,1212,1212,1076,1300,930,1300,1676,720,806,1302,1302,1302,1302,930,1302,1302,2048,1117,1320,1676,930,2048,1302,1110,1676,1110,1110,1302,1314,1302,745,1302,1110,1117,1320,2048,2048,2048,1117,1400,1400,1400,1400,1400,1400,2016,1430,1295,1295,1295,1295,862,862,862,862,1588,1532,1612,1612,1612,1612,1612,1676,1612,1499,1499,1499,1499,1260,1240,1270,1230,1230,1230,1230,1230,1230,1956,1067,1220,1220,1220,1220,562,562,562,562,1253,1296,1243,1243,1243,1243,1243,1676,1243,1296,1296,1296,1296,1212,1276,930,1302,1302,1400,930,1538,1782,1105,1804,1543,1859,562,1400,1404,1160,1440,1295,1403,1539,1612,862,1419,1404,1726,1532,1329,1612,1539,1235,1377,1262,1260,1677,1403,1783,1676,862,1260,1276,1050,1296,562,1293,1276,1270,1212,1245,1050,937,1296,1278,562,1212,1212,1310,1212,1030,1243,1305,1280,1040,1291,1016,1293,1618,1208,1683,1666,562,1293,1243,1293,1666,1302,1489,1676,1489,1676,740,745,1676,2048,1302,1676,1676,1676,1676],this.GLYPH_DATA=["","M515 1489l-26 -1079h-170l-28 1079h224zM505 0h-204v211h204v-211z","M772 1556l-43 -579h-132l-43 579h218zM386 1556l-43 -579h-132l-43 579h218z","M1481 932h-333l-92 -376h308v-135h-343l-104 -421h-129l104 421h-270l-104 -421h-129l104 421h-298v135h333l92 376h-308v135h343l105 422h129l-105 -422h270l105 422h129l-105 -422h298v-135zM1022 934h-274l-94 -380h274z","M1160 380q0 -155 -121 -257.5t-317 -121.5v-362h-118v357q-132 1 -248 25.5t-201 63.5v198h16q19 -14 68 -40.5t95 -43.5q52 -19 121.5 -35.5t148.5 -19.5v433q-40 8 -74 15.5t-63 15.5q-163 41 -234 123.5t-71 203.5q0 148 116.5 250t325.5 119v272h118v-270 q101 -2 207 -24t178 -51v-196h-14q-75 46 -156.5 81.5t-214.5 44.5v-431q30 -5 65 -13.5t61 -13.5q149 -32 230.5 -110t81.5 -213zM604 747v413q-107 -8 -180 -58.5t-73 -140.5q0 -91 54 -137t199 -77zM971 354q0 94 -58.5 137.5t-190.5 68.5v-414q120 12 184.5 61t64.5 147 z","M884 1076q0 -224 -94.5 -333t-272.5 -109q-182 0 -275 109t-93 332q0 224 95 333t273 109q181 0 274 -110t93 -331zM1575 1489l-780 -1489h-165l780 1489h165zM2055 413q0 -224 -95 -333t-273 -109q-181 0 -274 110t-93 331q0 224 94.5 333t272.5 109q182 0 275 -109 t93 -332zM706 1076q0 172 -44.5 240t-144.5 68q-102 0 -146 -68t-44 -241t44 -240.5t146 -67.5q100 0 144.5 67.5t44.5 241.5zM1877 413q0 172 -44.5 240t-144.5 68q-102 0 -146 -68t-44 -241t44 -240.5t146 -67.5q100 0 144.5 67.5t44.5 241.5z","M792 1191q0 95 -56.5 149.5t-144.5 54.5q-92 0 -150 -61.5t-58 -150.5q0 -75 39.5 -133t170.5 -137q98 35 148.5 102.5t50.5 175.5zM986 315l-478 466q-31 -15 -62 -39.5t-62 -66.5q-28 -39 -46 -94t-18 -124q0 -146 85.5 -235.5t242.5 -89.5q93 0 184.5 45.5 t153.5 137.5zM1287 909v-96q0 -96 -25 -216t-85 -229l378 -368h-246l-229 224q-115 -142 -235 -198.5t-247 -56.5q-208 0 -345.5 121.5t-137.5 318.5q0 92 26 159t61 116q35 47 87 88.5t105 72.5q-110 72 -158.5 145t-48.5 184q0 67 26.5 127.5t79.5 110.5q50 48 130.5 78 t177.5 30q173 0 280 -87.5t107 -221.5q0 -44 -12 -99.5t-41 -99.5q-32 -49 -91 -94t-153 -77l371 -362q14 40 21 88t8 100q2 56 1.5 125t-0.5 117h195z","M386 1556l-43 -579h-136l-43 579h222z","M783 -412h-229q-177 203 -275 443t-98 541t98 541t275 443h229v-10q-81 -73 -154.5 -168.5t-136.5 -222.5q-60 -123 -97.5 -271t-37.5 -312q0 -171 36.5 -313t98.5 -270q60 -123 137 -222.5t154 -168.5v-10z","M749 572q0 -301 -98 -541t-275 -443h-229v10q77 69 154.5 168.5t136.5 222.5q62 128 98.5 270t36.5 313q0 164 -37 312t-98 271q-63 127 -136.5 222.5t-154.5 168.5v10h229q177 -203 275 -443t98 -541z","M1137 887l-64 -110l-362 213l6 -360h-129l5 360l-361 -214l-65 110l381 207l-381 207l65 110l362 -213l-6 359h129l-7 -359l363 212l64 -110l-380 -205z","M1466 572h-545v-545h-166v545h-545v160h545v545h166v-545h545v-160z","M575 285l-282 -655h-146l174 655h254z","M777 561h-624v181h624v-181z","M492 0h-239v285h239v-285z","M860 1556l-717 -1860h-173l714 1860h176z","M1167 745q0 -401 -125.5 -588.5t-389.5 -187.5q-268 0 -391.5 190t-123.5 584q0 397 125 586.5t390 189.5q268 0 391.5 -192.5t123.5 -581.5zM904 291q35 81 47.5 190.5t12.5 263.5q0 152 -12.5 264t-48.5 190q-35 77 -95.5 116t-155.5 39q-94 0 -155.5 -39t-97.5 -118 q-34 -74 -46.5 -193t-12.5 -261q0 -156 11 -261t47 -188q33 -78 93.5 -119t160.5 -41q94 0 156 39t96 118z","M1084 0h-806v152h310v998h-310v136q63 0 135 10.5t109 30.5q46 25 72.5 63.5t30.5 103.5h155v-1342h304v-152z","M1169 0h-1008v209q105 90 210.5 180t196.5 179q192 186 263 295.5t71 236.5q0 116 -76.5 181.5t-213.5 65.5q-91 0 -197 -32t-207 -98h-10v210q71 35 189.5 64t229.5 29q229 0 359 -110.5t130 -299.5q0 -85 -21.5 -158.5t-63.5 -139.5q-39 -62 -91.5 -122t-127.5 -133 q-107 -105 -221 -203.5t-213 -182.5h801v-171z","M1038 717q48 -43 79 -108t31 -168q0 -102 -37 -187t-104 -148q-75 -70 -176.5 -103.5t-222.5 -33.5q-124 0 -244 29.5t-197 64.5v209h15q85 -56 200 -93t222 -37q63 0 134 21t115 62q46 44 68.5 97t22.5 134q0 80 -25.5 132.5t-70.5 82.5q-45 31 -109 42.5t-138 11.5h-90 v166h70q152 0 242.5 63.5t90.5 185.5q0 54 -23 94.5t-64 66.5q-43 26 -92 36t-111 10q-95 0 -202 -34t-202 -96h-10v209q71 35 189.5 64.5t229.5 29.5q109 0 192 -20t150 -64q72 -48 109 -116t37 -159q0 -124 -87.5 -216.5t-206.5 -116.5v-14q48 -8 110 -33.5t105 -63.5z ","M1203 419h-221v-419h-192v419h-713v230l721 840h184v-910h221v-160zM790 579v672l-577 -672h577z","M1157 473q0 -104 -38 -199t-104 -160q-72 -70 -171.5 -107.5t-230.5 -37.5q-122 0 -235 25.5t-191 61.5v211h14q82 -52 192 -88.5t216 -36.5q71 0 137.5 20t118.5 70q44 43 66.5 103t22.5 139q0 77 -26.5 130t-73.5 85q-52 38 -126.5 53.5t-166.5 15.5q-88 0 -169.5 -12 t-140.5 -24v767h896v-175h-703v-396q43 4 88 6t78 2q121 0 212 -20.5t167 -72.5q80 -55 124 -142t44 -218z","M1191 483q0 -227 -149.5 -370.5t-366.5 -143.5q-110 0 -200 34t-159 101q-86 83 -132.5 220t-46.5 330q0 198 42.5 351t135.5 272q88 113 227 176.5t324 63.5q59 0 99 -5t81 -18v-191h-10q-28 15 -84.5 28.5t-115.5 13.5q-215 0 -343 -134.5t-149 -363.5 q84 51 165.5 77.5t188.5 26.5q95 0 167.5 -17.5t148.5 -70.5q88 -61 132.5 -154t44.5 -226zM988 475q0 93 -27.5 154t-90.5 106q-46 32 -102 42t-117 10q-85 0 -158 -20t-150 -62q-2 -22 -3 -42.5t-1 -51.5q0 -158 32.5 -249.5t89.5 -144.5q46 -44 99.5 -64.5t116.5 -20.5 q145 0 228 88.5t83 254.5z","M1173 1266l-674 -1266h-214l717 1314h-848v175h1019v-223z","M1180 415q0 -193 -150.5 -321t-378.5 -128q-242 0 -385.5 125t-143.5 320q0 124 72 224.5t203 159.5v6q-120 64 -177.5 140t-57.5 190q0 168 138 280t351 112q223 0 356 -107t133 -272q0 -101 -63 -198.5t-185 -152.5v-6q140 -60 214 -148t74 -224zM943 1142 q0 107 -82.5 170.5t-210.5 63.5q-126 0 -206.5 -60t-80.5 -162q0 -72 40.5 -124.5t122.5 -93.5q37 -18 106.5 -47t135.5 -48q99 66 137 137t38 164zM974 396q0 92 -40.5 147.5t-158.5 111.5q-47 22 -103 41t-149 53q-90 -49 -144.5 -133t-54.5 -190q0 -135 93 -223t236 -88 q146 0 233.5 75t87.5 206z","M1167 834q0 -195 -44.5 -354t-134.5 -271q-91 -114 -228 -176t-322 -62q-52 0 -98 5.5t-82 17.5v191h10q29 -15 82 -28.5t118 -13.5q221 0 346.5 132.5t145.5 365.5q-93 -56 -175 -80t-179 -24q-92 0 -166.5 18t-149.5 70q-88 61 -132.5 155t-44.5 225q0 228 150 371 t366 143q108 0 200 -33.5t161 -100.5q85 -83 131 -213.5t46 -337.5zM965 877q0 155 -32 249t-88 146q-47 45 -101 64.5t-117 19.5q-144 0 -227.5 -90t-83.5 -253q0 -95 27 -155t91 -105q45 -31 99 -41.5t120 -10.5q78 0 158 21t150 61q1 21 2.5 41.5t1.5 52.5z","M585 832h-239v285h239v-285zM585 0h-239v285h239v-285z","M585 832h-239v285h239v-285zM658 285l-282 -655h-146l174 655h254z","M1408 77l-1154 513v124l1154 513v-180l-910 -395l910 -395v-180z","M1431 782h-1186v160h1186v-160zM1431 362h-1186v160h1186v-160z","M1422 590l-1154 -513v180l910 395l-910 395v180l1154 -513v-124z","M1005 1139q0 -98 -35 -174.5t-92 -135.5q-56 -57 -129 -107t-155 -97v-225h-179v305q65 37 140.5 81t123.5 89q58 52 90 107.5t32 141.5q0 113 -76.5 168.5t-197.5 55.5q-108 0 -204.5 -34t-152.5 -69h-10v204q70 27 177.5 48.5t203.5 21.5q215 0 339.5 -104.5 t124.5 -275.5zM610 0h-204v211h204v-211z","M1870 663q0 -139 -40.5 -269t-115.5 -237h-440l-27 116q-74 -60 -142 -92t-156 -32q-168 0 -268.5 127t-100.5 355q0 227 123 362t294 135q73 0 129 -16.5t121 -49.5v48h159v-842h243q42 75 63.5 187.5t21.5 201.5q0 164 -45.5 298t-133.5 230t-218 147.5t-295 51.5 q-160 0 -292.5 -58t-227.5 -156q-96 -98 -150.5 -234.5t-54.5 -290.5q0 -165 52 -301.5t147 -233.5q99 -101 232 -152.5t290 -51.5q86 0 177.5 11t175.5 35v-142q-97 -21 -181 -28.5t-173 -7.5q-186 0 -345 63.5t-273 177.5q-115 115 -179 276t-64 356q0 185 67 344.5 t183 276.5t275 184t340 67q196 0 350 -62t260 -174t162.5 -269.5t56.5 -350.5zM1245 408v518q-63 29 -113 41.5t-107 12.5q-129 0 -202 -90t-73 -256q0 -163 58 -246.5t181 -83.5q67 0 134 31t122 73z","M1374 0h-211l-146 415h-644l-146 -415h-201l542 1489h264zM956 585l-261 731l-262 -731h523z","M1323 458q0 -111 -42 -196t-113 -140q-84 -66 -184.5 -94t-255.5 -28h-528v1489h441q163 0 244 -12t155 -50q82 -43 119 -110.5t37 -161.5q0 -106 -54 -180.5t-144 -119.5v-8q151 -31 238 -132.5t87 -256.5zM990 1129q0 54 -18 91t-58 60q-47 27 -114 33.5t-166 6.5h-236 v-430h256q93 0 148 9.5t102 39.5t66.5 77.5t19.5 112.5zM1117 450q0 90 -27 143t-98 90q-48 25 -116.5 32.5t-166.5 7.5h-311v-554h262q130 0 213 13.5t136 49.5q56 39 82 89t26 129z","M1350 108q-55 -24 -99.5 -45t-116.5 -44q-61 -19 -132.5 -32.5t-157.5 -13.5q-162 0 -294.5 45.5t-230.5 142.5q-96 95 -150 241.5t-54 340.5q0 184 52 329t150 245q95 97 229.5 148t298.5 51q120 0 239.5 -29t265.5 -102v-235h-15q-123 103 -244 150t-259 47 q-113 0 -203.5 -36.5t-161.5 -113.5q-69 -75 -107.5 -189.5t-38.5 -264.5q0 -157 42.5 -270t109.5 -184q70 -74 163.5 -109.5t197.5 -35.5q143 0 268 49t234 147h14v-232z","M1458 743q0 -203 -88.5 -368t-235.5 -256q-102 -63 -227.5 -91t-330.5 -28h-376v1489h372q218 0 346.5 -31.5t217.5 -86.5q152 -95 237 -253t85 -375zM1251 746q0 175 -61 295t-182 189q-88 50 -187 69.5t-237 19.5h-186v-1149h186q143 0 249.5 21t195.5 78 q111 71 166.5 187t55.5 290z","M1181 0h-981v1489h981v-176h-783v-408h783v-176h-783v-553h783v-176z","M1151 1313h-753v-420h647v-176h-647v-717h-198v1489h951v-176z","M1442 110q-122 -56 -266.5 -97.5t-279.5 -41.5q-174 0 -319 48t-247 144q-103 97 -159 242.5t-56 340.5q0 357 208.5 563.5t572.5 206.5q127 0 259.5 -30.5t285.5 -103.5v-235h-18q-31 24 -90 63t-116 65q-69 31 -156.5 51.5t-198.5 20.5q-250 0 -395.5 -160.5 t-145.5 -434.5q0 -289 152 -449.5t414 -160.5q96 0 191.5 19t167.5 49v365h-399v174h595v-639z","M1339 0h-198v729h-743v-729h-198v1489h198v-584h743v584h198v-1489z","M725 0h-588v152h195v1185h-195v152h588v-152h-195v-1185h195v-152z","M746 387q0 -196 -119.5 -302t-320.5 -106q-48 0 -128 8.5t-134 20.5v185h11q41 -14 101 -29t123 -15q92 0 146.5 21t80.5 60q27 40 34.5 98t7.5 134v869h-315v158h513v-1102z","M1397 0h-257l-589 663l-148 -158v-505h-198v1489h198v-777l723 777h240l-665 -700z","M1142 0h-942v1489h198v-1313h744v-176z","M1526 0h-198v1283l-414 -873h-118l-411 873v-1283h-185v1489h270l397 -829l384 829h275v-1489z","M1336 0h-245l-706 1332v-1332h-185v1489h307l644 -1216v1216h185v-1489z","M1310 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1292 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5z","M1174 1039q0 -99 -34.5 -183.5t-96.5 -146.5q-77 -77 -182 -115.5t-265 -38.5h-198v-555h-198v1489h404q134 0 227 -22.5t165 -70.5q85 -57 131.5 -142t46.5 -215zM968 1034q0 77 -27 134t-82 93q-48 31 -109.5 44.5t-155.5 13.5h-196v-595h167q120 0 195 21.5t122 68.5 q47 48 66.5 101t19.5 119z","M1528 -365q-60 -15 -118.5 -21.5t-119.5 -6.5q-174 0 -279.5 95.5t-114.5 273.5q-24 -4 -46.5 -5.5t-43.5 -1.5q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5 q91 -100 139.5 -245t48.5 -329q0 -273 -111.5 -460t-299.5 -262q4 -114 54 -177t182 -63q41 0 97.5 12.5t80.5 22.5h27v-182zM1292 744q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5z","M1432 0h-257l-498 592h-279v-592h-198v1489h417q135 0 225 -17.5t162 -62.5q81 -51 126.5 -128.5t45.5 -196.5q0 -161 -81 -269.5t-223 -163.5zM969 1070q0 64 -22.5 113.5t-74.5 83.5q-43 29 -102 40.5t-139 11.5h-233v-562h200q94 0 164 16.5t119 61.5q45 42 66.5 96.5 t21.5 138.5z","M1282 425q0 -87 -40.5 -172t-113.5 -144q-80 -64 -186.5 -100t-256.5 -36q-161 0 -289.5 30t-261.5 89v248h14q113 -94 261 -145t278 -51q184 0 286.5 69t102.5 184q0 99 -48.5 146t-147.5 73q-75 20 -162.5 33t-185.5 33q-198 42 -293.5 143.5t-95.5 264.5 q0 187 158 306.5t401 119.5q157 0 288 -30t232 -74v-234h-14q-85 72 -223.5 119.5t-283.5 47.5q-159 0 -255.5 -66t-96.5 -170q0 -93 48 -146t169 -81q64 -14 182 -34t200 -41q166 -44 250 -133t84 -249z","M1262 1313h-532v-1313h-198v1313h-532v176h1262v-176z","M1321 598q0 -162 -35.5 -282.5t-116.5 -200.5q-77 -76 -180 -111t-240 -35q-140 0 -244 37t-175 109q-81 82 -116.5 198t-35.5 285v891h198v-901q0 -121 16.5 -191t55.5 -127q44 -65 119.5 -98t181.5 -33q107 0 182 32.5t120 98.5q39 57 55.5 130.5t16.5 182.5v906h198 v-891z","M1374 1489l-542 -1489h-264l-542 1489h212l467 -1310l467 1310h202z","M1933 1489l-387 -1489h-223l-313 1236l-306 -1236h-218l-394 1489h203l313 -1238l308 1238h201l311 -1250l311 1250h194z","M1336 1489l-514 -736l513 -753h-229l-406 613l-416 -613h-216l519 744l-507 745h228l401 -605l410 605h217z","M1254 1489l-524 -836v-653h-198v632l-526 857h219l407 -666l411 666h211z","M1288 0h-1162v184l913 1129h-879v176h1106v-179l-922 -1134h944v-176z","M759 -392h-520v1948h520v-143h-346v-1662h346v-143z","M960 -304h-173l-717 1860h176z","M691 -392h-520v143h346v1662h-346v143h520v-1948z","M1490 684h-198l-455 627l-454 -629h-197l589 807h126z","M1306 -300h-1310v120h1310v-120z","M762 1302h-149l-273 374h243z","M1053 0h-187v119q-25 -17 -67.5 -47.5t-82.5 -48.5q-47 -23 -108 -38.5t-143 -15.5q-151 0 -256 100t-105 255q0 127 54.5 205.5t155.5 123.5q102 45 245 61t307 24v29q0 64 -22.5 106t-64.5 66q-40 23 -96 31t-117 8q-74 0 -165 -19.5t-188 -56.5h-10v191q55 15 159 33 t205 18q118 0 205.5 -19.5t151.5 -66.5q63 -46 96 -119t33 -181v-758zM866 275v311q-86 -5 -202.5 -15t-184.5 -29q-81 -23 -131 -71.5t-50 -133.5q0 -96 58 -144.5t177 -48.5q99 0 181 38.5t152 92.5z","M1168 567q0 -140 -39.5 -252t-106.5 -188q-71 -79 -156 -118.5t-187 -39.5q-95 0 -166 22.5t-140 60.5l-12 -52h-176v1556h188v-556q79 65 168 106.5t200 41.5q198 0 312.5 -152t114.5 -429zM974 562q0 200 -66 303.5t-213 103.5q-82 0 -166 -35.5t-156 -91.5v-640 q80 -36 137.5 -50t130.5 -14q156 0 244.5 102.5t88.5 321.5z","M1011 70q-94 -45 -178.5 -70t-179.5 -25q-121 0 -222 35.5t-173 107.5q-73 72 -113 182t-40 257q0 274 150.5 430t397.5 156q96 0 188.5 -27t169.5 -66v-209h-10q-86 67 -177.5 103t-178.5 36q-160 0 -252.5 -107.5t-92.5 -315.5q0 -202 90.5 -310.5t254.5 -108.5 q57 0 116 15t106 39q41 21 77 44.5t57 40.5h10v-207z","M1091 0h-188v117q-81 -70 -169 -109t-191 -39q-200 0 -317.5 154t-117.5 427q0 142 40.5 253t109.5 189q68 76 158.5 116t187.5 40q88 0 156 -18.5t143 -57.5v484h188v-1556zM903 275v641q-76 34 -136 47t-131 13q-158 0 -246 -110t-88 -312q0 -199 68 -302.5t218 -103.5 q80 0 162 35.5t153 91.5z","M1120 539h-823q0 -103 31 -179.5t85 -125.5q52 -48 123.5 -72t157.5 -24q114 0 229.5 45.5t164.5 89.5h10v-205q-95 -40 -194 -67t-208 -27q-278 0 -434 150.5t-156 427.5q0 274 149.5 435t393.5 161q226 0 348.5 -132t122.5 -375v-102zM937 683q-1 148 -74.5 229 t-223.5 81q-151 0 -240.5 -89t-101.5 -221h640z","M786 1374h-10q-31 9 -81 18.5t-88 9.5q-121 0 -175.5 -53.5t-54.5 -193.5v-38h339v-158h-333v-959h-188v959h-127v158h127v37q0 199 99 305.5t286 106.5q63 0 113.5 -6t92.5 -14v-172z","M1091 127q0 -284 -129 -417t-397 -133q-89 0 -173.5 12.5t-166.5 35.5v192h10q46 -18 146 -44.5t200 -26.5q96 0 159 23t98 64q35 39 50 94t15 123v102q-85 -68 -162.5 -101.5t-197.5 -33.5q-200 0 -317.5 144.5t-117.5 407.5q0 144 40.5 248.5t110.5 180.5 q65 71 158 110.5t185 39.5q97 0 162.5 -19.5t138.5 -59.5l12 48h176v-990zM903 307v609q-75 34 -139.5 48.5t-128.5 14.5q-155 0 -244 -104t-89 -302q0 -188 66 -285t219 -97q82 0 164.5 31.5t151.5 84.5z","M1119 0h-188v636q0 77 -9 144.5t-33 105.5q-25 42 -72 62.5t-122 20.5q-77 0 -161 -38t-161 -97v-834h-188v1556h188v-563q88 73 182 114t193 41q181 0 276 -109t95 -314v-725z","M387 1304h-212v195h212v-195zM375 0h-188v1117h188v-1117z","M533 1304h-212v195h212v-195zM521 -27q0 -196 -100 -296t-268 -100q-40 0 -105.5 8t-109.5 20v179h10q28 -11 75.5 -25t92.5 -14q72 0 116 20t66 60t28.5 96.5t6.5 137.5v900h-233v158h421v-1144z","M1199 0h-248l-448 489l-122 -116v-373h-188v1556h188v-998l543 559h237l-519 -516z","M375 0h-188v1556h188v-1556z","M1815 0h-188v636q0 72 -6.5 139t-27.5 107q-23 43 -66 65t-124 22q-79 0 -158 -39.5t-158 -100.5q3 -23 5 -53.5t2 -60.5v-715h-188v636q0 74 -6.5 140.5t-27.5 106.5q-23 43 -66 64.5t-124 21.5q-77 0 -154.5 -38t-154.5 -97v-834h-188v1117h188v-124q88 73 175.5 114 t186.5 41q114 0 193.5 -48t118.5 -133q114 96 208 138.5t201 42.5q184 0 271.5 -111.5t87.5 -311.5v-725z","M1119 0h-188v636q0 77 -9 144.5t-33 105.5q-25 42 -72 62.5t-122 20.5q-77 0 -161 -38t-161 -97v-834h-188v1117h188v-124q88 73 182 114t193 41q181 0 276 -109t95 -314v-725z","M1137 558q0 -273 -140 -431t-375 -158q-237 0 -376.5 158t-139.5 431t139.5 431.5t376.5 158.5q235 0 375 -158.5t140 -431.5zM943 558q0 217 -85 322.5t-236 105.5q-153 0 -237.5 -105.5t-84.5 -322.5q0 -210 85 -318.5t237 -108.5q150 0 235.5 107.5t85.5 319.5z","M1168 572q0 -136 -39 -248.5t-110 -190.5q-66 -74 -155.5 -114.5t-189.5 -40.5q-87 0 -157.5 19t-143.5 59v-468h-188v1529h188v-117q75 63 168.5 105.5t199.5 42.5q202 0 314.5 -152.5t112.5 -423.5zM974 567q0 202 -69 302t-212 100q-81 0 -163 -35t-157 -92v-633 q80 -36 137.5 -49t130.5 -13q157 0 245 106t88 314z","M1091 -412h-188v538q-87 -75 -173 -111.5t-186 -36.5q-199 0 -317.5 153.5t-118.5 423.5q0 144 41.5 254.5t109.5 185.5q66 73 155 113t188 40q90 0 159.5 -20t141.5 -59l12 48h176v-1529zM903 284v632q-78 35 -138 49t-130 14q-163 0 -248 -110.5t-85 -304.5 q0 -196 68.5 -301.5t215.5 -105.5q82 0 164 35.5t153 91.5z","M882 912h-10q-42 10 -81.5 14.5t-93.5 4.5q-87 0 -168 -38.5t-156 -99.5v-793h-188v1117h188v-165q112 90 197.5 127.5t174.5 37.5q49 0 71 -2.5t66 -9.5v-193z","M983 322q0 -153 -126.5 -251t-345.5 -98q-124 0 -227.5 29.5t-173.5 64.5v211h10q89 -67 198 -106.5t209 -39.5q124 0 194 40t70 126q0 66 -38 100t-146 58q-40 9 -104.5 21t-117.5 26q-147 39 -208.5 114.5t-61.5 185.5q0 69 28.5 130t86.5 109q56 47 142.5 74.5 t193.5 27.5q100 0 202.5 -24.5t170.5 -59.5v-201h-10q-72 53 -175 89.5t-202 36.5q-103 0 -174 -39.5t-71 -117.5q0 -69 43 -104q42 -35 136 -57q52 -12 116.5 -24t107.5 -22q131 -30 202 -103q71 -74 71 -196z","M765 10q-53 -14 -115.5 -23t-111.5 -9q-171 0 -260 92t-89 295v594h-127v158h127v321h188v-321h388v-158h-388v-509q0 -88 4 -137.5t28 -92.5q22 -40 60.5 -58.5t117.5 -18.5q46 0 96 13.5t72 22.5h10v-169z","M1111 0h-188v124q-95 -75 -182 -115t-192 -40q-176 0 -274 107.5t-98 315.5v725h188v-636q0 -85 8 -145.5t34 -103.5q27 -44 70 -64t125 -20q73 0 159.5 38t161.5 97v834h188v-1117z","M1151 1117l-452 -1117h-189l-449 1117h204l346 -889l343 889h197z","M1590 1117l-291 -1117h-174l-287 861l-285 -861h-173l-294 1117h196l205 -865l279 865h155l286 -865l194 865h189z","M1152 0h-237l-317 429l-319 -429h-219l436 557l-432 560h237l315 -422l316 422h220l-439 -550z","M1151 1117l-652 -1529h-201l208 466l-445 1063h204l343 -828l346 828h197z","M995 0h-902v139l651 821h-637v157h871v-134l-654 -824h671v-159z","M1113 -392h-150q-179 0 -290.5 99.5t-111.5 287.5v149q0 169 -83 264.5t-254 95.5h-51v156h51q171 0 254 95.5t83 264.5v149q0 188 111.5 287.5t290.5 99.5h150v-138h-114q-136 0 -197.5 -63t-61.5 -203v-175q0 -139 -77 -233.5t-214 -149.5v-24q137 -55 214 -149.5 t77 -233.5v-175q0 -140 61.5 -203t197.5 -63h114v-138z","M552 -392h-174v1948h174v-1948z","M1127 504h-51q-171 0 -254 -95.5t-83 -264.5v-149q0 -188 -111.5 -287.5t-290.5 -99.5h-150v138h114q136 0 197.5 63t61.5 203v175q0 139 77 233.5t214 149.5v24q-137 55 -214 149.5t-77 233.5v175q0 140 -61.5 203t-197.5 63h-114v138h150q179 0 290.5 -99.5 t111.5 -287.5v-149q0 -169 83 -264.5t254 -95.5h51v-156z","M1489 927q-2 -99 -22.5 -195t-65.5 -171q-46 -77 -111 -121t-165 -44q-94 0 -167 39.5t-157 141.5q-102 125 -148 157t-96 32q-94 0 -144 -87.5t-59 -283.5h-167q2 100 22.5 194.5t64.5 171.5q43 74 112 119.5t165 45.5q93 0 166.5 -38.5t158.5 -142.5q80 -98 131 -143.5 t112 -45.5q103 0 151.5 101t51.5 270h167z","","M505 1278h-204v211h204v-211zM515 0h-224l26 1079h170z","M1120 74q-71 -30 -161 -53.5t-194 -26.5v-355h-118v359q-227 21 -357.5 165t-130.5 394q0 242 133.5 391.5t354.5 171.5v355h118v-351q104 -3 197 -25t158 -53v-203h-11q-55 44 -142 85t-202 50v-839q120 10 206.5 52.5t137.5 83.5h11v-201zM647 142v834 q-135 -20 -216 -125t-81 -294q0 -181 76 -286t221 -129z","M1163 0h-1026v207q118 32 169.5 126.5t51.5 279.5h-176v138h176v310q0 200 126.5 328.5t331.5 128.5q105 0 181 -17t140 -34v-206h-10q-62 42 -138 66t-162 24q-140 0 -209.5 -82.5t-69.5 -226.5v-291h415v-138h-415v-61q0 -126 -62 -219.5t-160 -150.5v-11h837v-171z ","M1168 257l-110 -110l-236 234q-44 -26 -81 -37t-89 -11q-46 0 -89.5 12.5t-79.5 35.5l-236 -236l-109 113l233 234q-23 37 -35 81.5t-12 87.5q0 52 11 88.5t37 79.5l-234 237l111 110l235 -235q36 23 79.5 35.5t88.5 12.5q44 0 88 -12t81 -35l234 234l113 -109l-235 -237 q24 -38 36 -79.5t12 -89.5q0 -45 -12.5 -89t-35.5 -80zM832 661q0 73 -52.5 129t-127.5 56q-73 0 -126.5 -55t-53.5 -130q0 -74 52.5 -129.5t127.5 -55.5q73 0 126.5 54.5t53.5 130.5z","M1191 1489l-448 -831v-94h372v-138h-370v-426h-188v426h-370v138h372v73l-451 852h212l332 -659l336 659h203z","M552 758h-174v798h174v-798zM552 -392h-174v798h174v-798z","M1128 601q0 -106 -59 -187t-158 -136v-7q97 -46 141 -118.5t44 -162.5q0 -77 -33 -146t-98 -119q-72 -56 -169 -83t-221 -27q-87 0 -170.5 13.5t-175.5 44.5v194h10q79 -37 169 -62t198 -25q134 0 215 48.5t81 135.5q0 56 -19.5 88.5t-64.5 57.5q-41 23 -113 41.5 t-154 38.5q-214 52 -296 133q-83 81 -83 210q0 98 57 182.5t159 141.5v7q-101 48 -143 121t-42 162q0 81 32 146.5t99 117.5q64 50 163.5 79t227.5 29q87 0 171 -14t175 -43v-194h-10q-58 27 -152.5 57t-215.5 30q-127 0 -211.5 -46t-84.5 -133q0 -57 21.5 -92.5t64.5 -58.5 t109 -41.5t157 -39.5q200 -46 290 -125q89 -79 89 -218zM881 399q28 33 43 65.5t15 90.5q0 51 -16.5 86t-45.5 58q-28 24 -67 39.5t-83 27.5q-39 11 -85.5 21.5t-116.5 30.5q-18 -9 -49 -31.5t-53 -46.5q-24 -26 -43 -69t-19 -92q0 -50 15.5 -85t44.5 -59q27 -23 67.5 -39 t84.5 -27q38 -10 86 -22t115 -31q20 11 53 34.5t54 48.5z","M958 1304h-199v195h199v-195zM545 1304h-199v195h199v-195z","M1889 655q0 -358 -253.5 -611.5t-611.5 -253.5t-611.5 253.5t-253.5 611.5t253.5 611.5t611.5 253.5t611.5 -253.5t253.5 -611.5zM1773 655q0 310 -219.5 532t-529.5 222t-529.5 -222t-219.5 -532t219.5 -532t529.5 -222t529.5 222t219.5 532zM1375 258 q-86 -39 -165.5 -58.5t-157.5 -19.5q-227 0 -359 123t-132 357q0 225 134.5 354t356.5 129q89 0 175 -24t148 -52v-181h-16q-54 40 -138.5 75t-173.5 35q-142 0 -221.5 -85.5t-79.5 -250.5q0 -159 76.5 -246t224.5 -87q83 0 161.5 29t150.5 81h16v-179z","M944 554h-170v94q-28 -20 -52.5 -38.5t-68.5 -37.5q-45 -20 -85.5 -30.5t-113.5 -10.5q-128 0 -215.5 85t-87.5 217q0 106 46.5 173.5t123.5 103.5q78 36 197.5 51.5t255.5 21.5v18q0 53 -18 85t-51 51q-34 18 -77.5 23t-91.5 5q-84 0 -168 -24t-123 -38h-14v172 q45 13 137 29t169 16q217 0 312 -84.5t95 -243.5v-638zM774 796v245q-69 -4 -160.5 -12t-145.5 -23q-64 -18 -103 -56.5t-39 -106.5q0 -76 45.5 -114t139.5 -38q82 0 147.5 33.5t115.5 71.5z","M1146 191l-528 419v85l528 418v-188l-357 -273l357 -273v-188zM716 162l-550 446v89l550 445v-196l-371 -294l371 -294v-196z","M1456 57h-171v545h-1075v160h1246v-705z","M777 561h-624v181h624v-181z","M1889 655q0 -358 -253.5 -611.5t-611.5 -253.5t-611.5 253.5t-253.5 611.5t253.5 611.5t611.5 253.5t611.5 -253.5t253.5 -611.5zM1773 655q0 310 -219.5 532t-529.5 222t-529.5 -222t-219.5 -532t219.5 -532t529.5 -222t529.5 222t219.5 532zM1581 215h-223l-331 355 h-162v-355h-165v915h312q94 0 155 -8t120 -39q63 -34 92.5 -82.5t29.5 -121.5q0 -97 -56.5 -161.5t-155.5 -102.5zM1229 868q0 36 -14 64t-47 46q-31 17 -66 22t-88 5h-149v-309h127q62 0 107 9.5t74 32.5q31 25 43.5 55t12.5 75z","M1306 1668h-1305l-5 120h1310v-120z","M956 1116q0 -168 -116 -284t-285 -116t-285 115.5t-116 284.5q0 168 116 284t285 116q170 0 285.5 -116t115.5 -284zM791 1116q0 102 -67 171.5t-169 69.5t-169 -69.5t-67 -171.5q0 -104 68.5 -172.5t167.5 -68.5q102 0 169 70t67 171z","M1461 179h-1246v158h540v422h-540v158h540v545h166v-545h540v-158h-540v-422h540v-158z","M967 566h-760v156q100 62 183.5 117t134.5 96q131 103 168 154.5t37 135.5q0 69 -53.5 107t-143.5 38q-89 0 -175 -30.5t-134 -61.5h-13v180q71 26 158.5 43.5t174.5 17.5q180 0 273.5 -78.5t93.5 -203.5q0 -99 -48.5 -174.5t-163.5 -165.5q-55 -43 -132.5 -94 t-143.5 -92h544v-145z","M956 817q0 -75 -33 -131.5t-89 -90.5q-57 -35 -131 -51.5t-163 -16.5q-94 0 -176.5 15t-156.5 43v179h14q41 -36 138.5 -65.5t190.5 -29.5q100 0 166.5 35.5t66.5 110.5q0 85 -59 115t-171 30h-143v141h128q112 0 165.5 38.5t53.5 106.5q0 61 -49.5 96.5t-153.5 35.5 q-77 0 -174.5 -31t-141.5 -67h-14v178q74 27 160.5 44.5t176.5 17.5q175 0 271.5 -68t96.5 -174q0 -89 -55 -146t-144 -83v-8q95 -17 160.5 -72.5t65.5 -151.5z","M963 1676l-273 -374h-149l179 374h243z","M1124 0h-178l-10 118q-59 -65 -123.5 -102t-155.5 -37q-86 0 -149.5 35t-129.5 99v-525h-188v1529h188v-838q32 -39 109.5 -80t168.5 -41q93 0 159.5 33.5t120.5 93.5v832h188v-1117z","M1106 -363h-148v1722h-214v-1722h-149v956q-206 5 -332 129t-126 328q0 207 130 323t373 116h466v-1852z","M492 511h-239v283h239v-283z","M880 -89q0 -162 -91.5 -248t-237.5 -86q-37 0 -95 7t-103 19v160h9q26 -10 70 -23t94 -13q104 0 153 39t49 127q0 29 -3 65.5t-6 61.5h153q2 -19 5 -45t3 -64z","M914 566h-615v122h234v568h-242v112q45 0 99 6.5t84 18.5q37 16 59 38t25 62h135v-805h221v-122z","M996 1025q0 -235 -122 -364.5t-315 -129.5q-201 0 -319.5 132.5t-118.5 361.5t118.5 362t319.5 133q193 0 315 -130t122 -365zM814 1025q0 172 -67.5 258t-187.5 86q-122 0 -189 -87t-67 -257t67 -256.5t189 -86.5q120 0 187.5 85.5t67.5 257.5z","M1154 608l-550 -446v196l371 294l-371 294v196l550 -445v-89zM702 610l-528 -419v188l357 273l-357 273v188l528 -418v-85z","M545 565h-165v681h-209v117q102 0 165 22t72 108h137v-928zM1410 1489l-780 -1489h-165l780 1489h165zM1857 220h-163v-220h-150v220h-465v185l466 539h149v-591h163v-133zM1548 353v400l-353 -400h353z","M545 565h-165v681h-209v117q102 0 165 22t72 108h137v-928zM1410 1489l-780 -1489h-165l780 1489h165zM1955 0h-688v148q91 69 158 121t106 89q109 103 141 157.5t32 136.5q0 70 -44 107t-120 37q-70 0 -141.5 -30t-112.5 -62h-15v179q65 27 140.5 44t152.5 17 q157 0 241.5 -79t84.5 -201q0 -93 -41 -167t-147 -168q-49 -43 -119.5 -96t-125.5 -94h498v-139z","M793 826q0 -71 -30 -127t-78 -90q-53 -37 -114.5 -53t-140.5 -16q-82 0 -153.5 15t-136.5 43v175h17q37 -35 114 -64.5t156 -29.5q84 0 139 36.5t55 108.5q0 83 -50 112.5t-141 29.5h-140v139h125q87 0 134.5 38t47.5 104q0 60 -41 95.5t-128 35.5q-66 0 -142.5 -31 t-113.5 -66h-17v175q64 27 139 44t154 17q152 0 237 -70t85 -168q0 -87 -48.5 -143.5t-125.5 -82.5v-8q80 -16 138.5 -70.5t58.5 -148.5zM1500 1489l-780 -1489h-165l780 1489h165zM1913 220h-163v-220h-150v220h-465v185l466 539h149v-591h163v-133zM1604 353v400 l-353 -400h353z","M712 1278h-204v211h204v-211zM958 40q-83 -30 -176 -50t-205 -20q-215 0 -339.5 104.5t-124.5 275.5q0 98 34.5 173t93.5 137q58 62 136.5 112.5t146.5 91.5v225h179v-305q-60 -33 -139 -81.5t-125 -88.5q-54 -47 -88 -109t-34 -140q0 -113 76.5 -168.5t197.5 -55.5 q103 0 201.5 33t155.5 70h10v-204z","M1374 0h-211l-146 415h-644l-146 -415h-201l542 1489h264zM956 585l-261 731l-262 -731h523zM862 1675h-149l-273 374h243z","M1374 0h-211l-146 415h-644l-146 -415h-201l542 1489h264zM956 585l-261 731l-262 -731h523zM955 2049l-273 -374h-149l179 374h243z","M1374 0h-211l-146 415h-644l-146 -415h-201l542 1489h264zM956 585l-261 731l-262 -731h523zM1033 1670h-159l-185 256l-184 -256h-155l228 379h227z","M1374 0h-211l-146 415h-644l-146 -415h-201l542 1489h264zM956 585l-261 731l-262 -731h523zM1119 1992q-11 -152 -77 -229t-177 -77q-54 0 -100 19.5t-87 56.5q-47 43 -79.5 64.5t-71.5 21.5q-52 0 -78 -45t-30 -121h-131q8 151 79 228t174 77q50 0 96.5 -19.5 t88.5 -55.5q47 -41 83.5 -61.5t69.5 -20.5q51 0 79.5 46t31.5 116h129z","M1374 0h-211l-146 415h-644l-146 -415h-201l542 1489h264zM956 585l-261 731l-262 -731h523zM1005 1677h-199v195h199v-195zM592 1677h-199v195h199v-195z","M1374 0h-211l-148 415h-640l-148 -415h-201l519 1407q-89 44 -142.5 123.5t-53.5 181.5q0 143 102 240t248 97q147 0 248.5 -97t101.5 -240q0 -100 -52.5 -181.5t-141.5 -123.5zM899 1710q0 86 -57 143.5t-143 57.5t-143 -58t-57 -143q0 -86 57.5 -143.5t142.5 -57.5 q86 0 143 57.5t57 143.5zM953 585l-258 715l-259 -715h517z","M1901 0h-944v556h-524l-212 -556h-207l594 1489h1293v-176h-749v-408h749v-176h-749v-553h749v-176zM957 723v601h-219l-239 -601h458z","M1350 108q-55 -24 -99.5 -45t-116.5 -44q-11 -3 -24 -7.5t-31 -7.5q2 -19 3.5 -44.5t1.5 -48.5q0 -162 -93.5 -248t-240.5 -86q-38 0 -97.5 7t-104.5 19v162h9q26 -10 71.5 -24t95.5 -14q106 0 155 40t49 126q0 19 -1 41.5t-3 42.5q-19 -2 -40.5 -3t-39.5 -1 q-162 0 -294.5 45.5t-230.5 142.5q-96 95 -150 241.5t-54 340.5q0 184 52 329t150 245q95 97 229.5 148t298.5 51q120 0 239.5 -29t265.5 -102v-235h-15q-123 103 -244 150t-259 47q-113 0 -203.5 -36.5t-161.5 -113.5q-69 -75 -107.5 -189.5t-38.5 -264.5q0 -157 42.5 -270 t109.5 -184q70 -74 163.5 -109.5t197.5 -35.5q143 0 268 49t234 147h14v-232z","M1181 0h-981v1489h981v-176h-783v-408h783v-176h-783v-553h783v-176zM822 1675h-149l-273 374h243z","M1181 0h-981v1489h981v-176h-783v-408h783v-176h-783v-553h783v-176zM993 2049l-273 -374h-149l179 374h243z","M1181 0h-981v1489h981v-176h-783v-408h783v-176h-783v-553h783v-176zM1031 1670h-159l-185 256l-184 -256h-155l228 379h227z","M1181 0h-981v1489h981v-176h-783v-408h783v-176h-783v-553h783v-176zM1038 1677h-199v195h199v-195zM625 1677h-199v195h199v-195z","M725 0h-588v152h195v1185h-195v152h588v-152h-195v-1185h195v-152zM568 1675h-149l-273 374h243z","M725 0h-588v152h195v1185h-195v152h588v-152h-195v-1185h195v-152zM725 2049l-273 -374h-149l179 374h243z","M725 0h-588v152h195v1185h-195v152h588v-152h-195v-1185h195v-152zM776 1670h-159l-185 256l-184 -256h-155l228 379h227z","M725 0h-588v152h195v1185h-195v152h588v-152h-195v-1185h195v-152zM738 1677h-199v195h199v-195zM325 1677h-199v195h199v-195z","M1468 743q0 -203 -88.5 -368t-235.5 -256q-102 -63 -227.5 -91t-330.5 -28h-376v740h-196v143h196v606h372q218 0 347 -31.5t217 -86.5q152 -95 237 -253t85 -375zM1261 746q0 175 -61 295t-182 189q-88 50 -187 69.5t-237 19.5h-188v-436h361v-143h-361v-570h188 q143 0 249.5 21t195.5 78q111 71 166.5 187t55.5 290z","M1336 0h-245l-706 1332v-1332h-185v1489h307l644 -1216v1216h185v-1489zM1208 1992q-11 -152 -77 -229t-177 -77q-54 0 -100 19.5t-87 56.5q-47 43 -79.5 64.5t-71.5 21.5q-52 0 -78 -45t-30 -121h-131q8 151 79 228t174 77q50 0 96.5 -19.5t88.5 -55.5 q47 -41 83.5 -61.5t69.5 -20.5q51 0 79.5 46t31.5 116h129z","M1310 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1292 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5zM932 1675h-149l-273 374h243z","M1310 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1292 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5zM1083 2049l-273 -374h-149l179 374h243z","M1310 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1292 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5zM1136 1670h-159l-185 256l-184 -256h-155l228 379h227z","M1310 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1292 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5zM1207 1992q-11 -152 -77 -229t-177 -77q-54 0 -100 19.5t-87 56.5q-47 43 -79.5 64.5t-71.5 21.5q-52 0 -78 -45t-30 -121h-131q8 151 79 228 t174 77q50 0 96.5 -19.5t88.5 -55.5q47 -41 83.5 -61.5t69.5 -20.5q51 0 79.5 46t31.5 116h129z","M1307 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1289 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5zM1108 1677h-199v195h199v-195zM695 1677h-199v195h199v-195z","M1385 216l-111 -111l-436 440l-436 -440l-111 111l440 436l-440 436l111 111l436 -440l436 440l111 -111l-440 -436z","M1498 744q0 -184 -49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-115 0 -215.5 29t-179.5 84l-159 -228h-132l205 294q-101 100 -155.5 250t-54.5 346q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q118 0 215 -27.5t179 -82.5l142 201h132 l-188 -268q101 -100 156.5 -248.5t55.5 -350.5zM1097 1260q-57 46 -129 68.5t-161 22.5q-110 0 -200 -38.5t-156 -116.5q-64 -76 -98.5 -190.5t-34.5 -261.5q0 -140 29.5 -252t87.5 -188zM1295 744q0 139 -30 253t-88 189l-664 -957q60 -45 132.5 -68t161.5 -23 q110 0 201.5 40t153.5 116q67 82 100 194.5t33 255.5z","M1321 598q0 -162 -35.5 -282.5t-116.5 -200.5q-77 -76 -180 -111t-240 -35q-140 0 -244 37t-175 109q-81 82 -116.5 198t-35.5 285v891h198v-901q0 -121 16.5 -191t55.5 -127q44 -65 119.5 -98t181.5 -33q107 0 182 32.5t120 98.5q39 57 55.5 130.5t16.5 182.5v906h198 v-891zM932 1675h-149l-273 374h243z","M1321 598q0 -162 -35.5 -282.5t-116.5 -200.5q-77 -76 -180 -111t-240 -35q-140 0 -244 37t-175 109q-81 82 -116.5 198t-35.5 285v891h198v-901q0 -121 16.5 -191t55.5 -127q44 -65 119.5 -98t181.5 -33q107 0 182 32.5t120 98.5q39 57 55.5 130.5t16.5 182.5v906h198 v-891zM1073 2049l-273 -374h-149l179 374h243z","M1321 598q0 -162 -35.5 -282.5t-116.5 -200.5q-77 -76 -180 -111t-240 -35q-140 0 -244 37t-175 109q-81 82 -116.5 198t-35.5 285v891h198v-901q0 -121 16.5 -191t55.5 -127q44 -65 119.5 -98t181.5 -33q107 0 182 32.5t120 98.5q39 57 55.5 130.5t16.5 182.5v906h198 v-891zM1084 1670h-159l-185 256l-184 -256h-155l228 379h227z","M1321 598q0 -162 -35.5 -282.5t-116.5 -200.5q-77 -76 -180 -111t-240 -35q-140 0 -244 37t-175 109q-81 82 -116.5 198t-35.5 285v891h198v-901q0 -121 16.5 -191t55.5 -127q44 -65 119.5 -98t181.5 -33q107 0 182 32.5t120 98.5q39 57 55.5 130.5t16.5 182.5v906h198 v-891zM1056 1677h-199v195h199v-195zM643 1677h-199v195h199v-195z","M1254 1489l-524 -836v-653h-198v632l-526 857h219l407 -666l411 666h211zM935 2049l-273 -374h-149l179 374h243z","M1174 787q0 -92 -35 -176.5t-95 -141.5q-78 -75 -187.5 -111t-260.5 -36h-198v-322h-198v1489h198v-270h205q133 0 230 -22.5t164 -66.5q83 -53 130 -138t47 -205zM968 782q0 72 -26 125.5t-82 88.5q-48 30 -112 42.5t-154 12.5h-196v-563h167q119 0 195 20.5t123 65.5 q44 41 64.5 92t20.5 116z","M1165 481q0 -214 -135.5 -359.5t-354.5 -145.5q-44 0 -101.5 7.5t-93.5 20.5v165h10q42 -24 91.5 -33t105.5 -9q74 0 129 29t88 78q35 52 50.5 115.5t15.5 139.5q0 166 -105.5 250.5t-303.5 84.5v150q157 0 234 59.5t77 188.5q0 35 -11 68t-41 64q-27 29 -71 46.5 t-105 17.5q-57 0 -103 -14.5t-86 -53.5q-37 -36 -59.5 -102t-22.5 -161v-1087h-188v1080q0 124 36 215.5t100 153.5q60 58 149.5 87.5t183.5 29.5q183 0 297.5 -87t114.5 -238q0 -112 -71 -201t-184 -121v-9q164 -37 259 -148.5t95 -280.5z","M1053 0h-187v119q-25 -17 -67.5 -47.5t-82.5 -48.5q-47 -23 -108 -38.5t-143 -15.5q-151 0 -256 100t-105 255q0 127 54.5 205.5t155.5 123.5q102 45 245 61t307 24v29q0 64 -22.5 106t-64.5 66q-40 23 -96 31t-117 8q-74 0 -165 -19.5t-188 -56.5h-10v191q55 15 159 33 t205 18q118 0 205.5 -19.5t151.5 -66.5q63 -46 96 -119t33 -181v-758zM866 275v311q-86 -5 -202.5 -15t-184.5 -29q-81 -23 -131 -71.5t-50 -133.5q0 -96 58 -144.5t177 -48.5q99 0 181 38.5t152 92.5zM738 1302h-149l-273 374h243z","M1053 0h-187v119q-25 -17 -67.5 -47.5t-82.5 -48.5q-47 -23 -108 -38.5t-143 -15.5q-151 0 -256 100t-105 255q0 127 54.5 205.5t155.5 123.5q102 45 245 61t307 24v29q0 64 -22.5 106t-64.5 66q-40 23 -96 31t-117 8q-74 0 -165 -19.5t-188 -56.5h-10v191q55 15 159 33 t205 18q118 0 205.5 -19.5t151.5 -66.5q63 -46 96 -119t33 -181v-758zM866 275v311q-86 -5 -202.5 -15t-184.5 -29q-81 -23 -131 -71.5t-50 -133.5q0 -96 58 -144.5t177 -48.5q99 0 181 38.5t152 92.5zM934 1676l-273 -374h-149l179 374h243z","M1053 0h-187v119q-25 -17 -67.5 -47.5t-82.5 -48.5q-47 -23 -108 -38.5t-143 -15.5q-151 0 -256 100t-105 255q0 127 54.5 205.5t155.5 123.5q102 45 245 61t307 24v29q0 64 -22.5 106t-64.5 66q-40 23 -96 31t-117 8q-74 0 -165 -19.5t-188 -56.5h-10v191q55 15 159 33 t205 18q118 0 205.5 -19.5t151.5 -66.5q63 -46 96 -119t33 -181v-758zM866 275v311q-86 -5 -202.5 -15t-184.5 -29q-81 -23 -131 -71.5t-50 -133.5q0 -96 58 -144.5t177 -48.5q99 0 181 38.5t152 92.5zM961 1297h-159l-185 256l-184 -256h-155l228 379h227z","M1053 0h-187v119q-25 -17 -67.5 -47.5t-82.5 -48.5q-47 -23 -108 -38.5t-143 -15.5q-151 0 -256 100t-105 255q0 127 54.5 205.5t155.5 123.5q102 45 245 61t307 24v29q0 64 -22.5 106t-64.5 66q-40 23 -96 31t-117 8q-74 0 -165 -19.5t-188 -56.5h-10v191q55 15 159 33 t205 18q118 0 205.5 -19.5t151.5 -66.5q63 -46 96 -119t33 -181v-758zM866 275v311q-86 -5 -202.5 -15t-184.5 -29q-81 -23 -131 -71.5t-50 -133.5q0 -96 58 -144.5t177 -48.5q99 0 181 38.5t152 92.5zM1038 1619q-11 -152 -77 -229t-177 -77q-54 0 -100 19.5t-87 56.5 q-47 43 -79.5 64.5t-71.5 21.5q-52 0 -78 -45t-30 -121h-131q8 151 79 228t174 77q50 0 96.5 -19.5t88.5 -55.5q47 -41 83.5 -61.5t69.5 -20.5q51 0 79.5 46t31.5 116h129z","M1053 0h-187v119q-25 -17 -67.5 -47.5t-82.5 -48.5q-47 -23 -108 -38.5t-143 -15.5q-151 0 -256 100t-105 255q0 127 54.5 205.5t155.5 123.5q102 45 245 61t307 24v29q0 64 -22.5 106t-64.5 66q-40 23 -96 31t-117 8q-74 0 -165 -19.5t-188 -56.5h-10v191q55 15 159 33 t205 18q118 0 205.5 -19.5t151.5 -66.5q63 -46 96 -119t33 -181v-758zM866 275v311q-86 -5 -202.5 -15t-184.5 -29q-81 -23 -131 -71.5t-50 -133.5q0 -96 58 -144.5t177 -48.5q99 0 181 38.5t152 92.5zM926 1304h-199v195h199v-195zM513 1304h-199v195h199v-195z","M1053 0h-187v119q-25 -17 -67.5 -47.5t-82.5 -48.5q-47 -23 -108 -38.5t-143 -15.5q-151 0 -256 100t-105 255q0 127 54.5 205.5t155.5 123.5q102 45 245 61t307 24v29q0 64 -22.5 106t-64.5 66q-40 23 -96 31t-117 8q-74 0 -165 -19.5t-188 -56.5h-10v191q55 15 159 33 t205 18q118 0 205.5 -19.5t151.5 -66.5q63 -46 96 -119t33 -181v-758zM866 275v311q-86 -5 -202.5 -15t-184.5 -29q-81 -23 -131 -71.5t-50 -133.5q0 -96 58 -144.5t177 -48.5q99 0 181 38.5t152 92.5zM956 1630q0 -143 -102 -242t-248 -99q-144 0 -247 98.5t-103 242.5 q0 143 102 241t248 98q147 0 248.5 -98t101.5 -241zM811 1630q0 86 -58.5 145.5t-146.5 59.5t-146.5 -59t-58.5 -146t59 -146t146 -59q88 0 146.5 59t58.5 146z","M1855 559h-819q0 -114 30 -195t85 -133q52 -48 123 -70.5t157 -22.5q111 0 217.5 41.5t172.5 93.5h12v-205q-78 -35 -184.5 -64.5t-215.5 -29.5q-166 0 -284.5 52t-194.5 155q-21 -19 -67 -59t-96 -68q-63 -36 -137 -59.5t-189 -23.5q-150 0 -255.5 97t-105.5 249 q0 124 54 200.5t155 118.5q95 39 241 53t308 17v61q0 65 -23 107.5t-64 65.5q-40 23 -96 31.5t-116 8.5q-79 0 -168.5 -21t-179.5 -57h-13v191q55 15 158 34t204 19q159 0 264.5 -46.5t162.5 -137.5q69 82 170 134t226 52q217 0 342.5 -128t125.5 -379v-82zM1673 703 q-5 68 -23.5 119t-50.5 88q-34 39 -88.5 61t-133.5 22q-133 0 -223 -75t-115 -215h634zM894 298q-20 53 -30.5 119t-10.5 141q-105 -3 -201 -7.5t-178 -25.5q-79 -20 -127.5 -65.5t-48.5 -128.5q0 -95 58 -141t176 -46q99 0 195.5 43t166.5 111z","M1011 70q-33 -15 -71.5 -30.5t-67.5 -24.5q3 -19 5.5 -47.5t2.5 -56.5q0 -162 -91.5 -248t-237.5 -86q-37 0 -95 7t-103 19v160h9q26 -10 70 -23t94 -13q104 0 153 39t49 127q0 22 -1.5 45t-3.5 43q-16 -2 -30.5 -4t-39.5 -2q-121 0 -222 35.5t-173 107.5 q-73 72 -113 182t-40 257q0 274 150.5 430t397.5 156q96 0 188.5 -27t169.5 -66v-209h-10q-86 67 -177.5 103t-178.5 36q-160 0 -252.5 -107.5t-92.5 -315.5q0 -202 90.5 -310.5t254.5 -108.5q57 0 116 15t106 39q41 21 77 44.5t57 40.5h10v-207z","M1120 539h-823q0 -103 31 -179.5t85 -125.5q52 -48 123.5 -72t157.5 -24q114 0 229.5 45.5t164.5 89.5h10v-205q-95 -40 -194 -67t-208 -27q-278 0 -434 150.5t-156 427.5q0 274 149.5 435t393.5 161q226 0 348.5 -132t122.5 -375v-102zM937 683q-1 148 -74.5 229 t-223.5 81q-151 0 -240.5 -89t-101.5 -221h640zM759 1302h-149l-273 374h243z","M1120 539h-823q0 -103 31 -179.5t85 -125.5q52 -48 123.5 -72t157.5 -24q114 0 229.5 45.5t164.5 89.5h10v-205q-95 -40 -194 -67t-208 -27q-278 0 -434 150.5t-156 427.5q0 274 149.5 435t393.5 161q226 0 348.5 -132t122.5 -375v-102zM937 683q-1 148 -74.5 229 t-223.5 81q-151 0 -240.5 -89t-101.5 -221h640zM960 1676l-273 -374h-149l179 374h243z","M1120 539h-823q0 -103 31 -179.5t85 -125.5q52 -48 123.5 -72t157.5 -24q114 0 229.5 45.5t164.5 89.5h10v-205q-95 -40 -194 -67t-208 -27q-278 0 -434 150.5t-156 427.5q0 274 149.5 435t393.5 161q226 0 348.5 -132t122.5 -375v-102zM937 683q-1 148 -74.5 229 t-223.5 81q-151 0 -240.5 -89t-101.5 -221h640zM986 1297h-159l-185 256l-184 -256h-155l228 379h227z","M1120 539h-823q0 -103 31 -179.5t85 -125.5q52 -48 123.5 -72t157.5 -24q114 0 229.5 45.5t164.5 89.5h10v-205q-95 -40 -194 -67t-208 -27q-278 0 -434 150.5t-156 427.5q0 274 149.5 435t393.5 161q226 0 348.5 -132t122.5 -375v-102zM937 683q-1 148 -74.5 229 t-223.5 81q-151 0 -240.5 -89t-101.5 -221h640zM951 1304h-199v195h199v-195zM538 1304h-199v195h199v-195z","M375 0h-188v1117h188v-1117zM401 1302h-149l-273 374h243z","M375 0h-188v1117h188v-1117zM582 1676l-273 -374h-149l179 374h243z","M572 1297h-151l-143 267l-142 -267h-147l178 379h227zM375 0h-188v1117h188v-1117z","M557 1304h-189v195h189v-195zM194 1304h-189v195h189v-195zM375 0h-188v1117h188v-1117z","M1137 637q0 -324 -142 -496t-383 -172q-229 0 -367.5 135t-138.5 380q0 226 137 358t339 132q108 0 185.5 -26.5t163.5 -79.5q-32 112 -99.5 219t-154.5 181l-264 -162l-66 97l237 142q-84 67 -156 107.5t-165 87.5v16h295q35 -25 84 -58.5t86 -59.5l210 128l66 -97 l-186 -109q153 -147 236 -325.5t83 -397.5zM847 226q49 59 75 143.5t26 234.5q0 32 -1.5 59.5t-3.5 57.5q-75 45 -157.5 66.5t-168.5 21.5q-147 0 -231.5 -87.5t-84.5 -239.5q0 -180 84.5 -267t227.5 -87q66 0 127.5 22t106.5 76z","M1119 0h-188v636q0 77 -9 144.5t-33 105.5q-25 42 -72 62.5t-122 20.5q-77 0 -161 -38t-161 -97v-834h-188v1117h188v-124q88 73 182 114t193 41q181 0 276 -109t95 -314v-725zM1075 1619q-11 -152 -77 -229t-177 -77q-54 0 -100 19.5t-87 56.5q-47 43 -79.5 64.5 t-71.5 21.5q-52 0 -78 -45t-30 -121h-131q8 151 79 228t174 77q50 0 96.5 -19.5t88.5 -55.5q47 -41 83.5 -61.5t69.5 -20.5q51 0 79.5 46t31.5 116h129z","M1137 558q0 -273 -140 -431t-375 -158q-237 0 -376.5 158t-139.5 431t139.5 431.5t376.5 158.5q235 0 375 -158.5t140 -431.5zM943 558q0 217 -85 322.5t-236 105.5q-153 0 -237.5 -105.5t-84.5 -322.5q0 -210 85 -318.5t237 -108.5q150 0 235.5 107.5t85.5 319.5z M732 1302h-149l-273 374h243z","M1137 558q0 -273 -140 -431t-375 -158q-237 0 -376.5 158t-139.5 431t139.5 431.5t376.5 158.5q235 0 375 -158.5t140 -431.5zM943 558q0 217 -85 322.5t-236 105.5q-153 0 -237.5 -105.5t-84.5 -322.5q0 -210 85 -318.5t237 -108.5q150 0 235.5 107.5t85.5 319.5z M933 1676l-273 -374h-149l179 374h243z","M1137 558q0 -273 -140 -431t-375 -158q-237 0 -376.5 158t-139.5 431t139.5 431.5t376.5 158.5q235 0 375 -158.5t140 -431.5zM943 558q0 217 -85 322.5t-236 105.5q-153 0 -237.5 -105.5t-84.5 -322.5q0 -210 85 -318.5t237 -108.5q150 0 235.5 107.5t85.5 319.5z M963 1297h-159l-185 256l-184 -256h-155l228 379h227z","M1137 558q0 -273 -140 -431t-375 -158q-237 0 -376.5 158t-139.5 431t139.5 431.5t376.5 158.5q235 0 375 -158.5t140 -431.5zM943 558q0 217 -85 322.5t-236 105.5q-153 0 -237.5 -105.5t-84.5 -322.5q0 -210 85 -318.5t237 -108.5q150 0 235.5 107.5t85.5 319.5z M1038 1619q-11 -152 -77 -229t-177 -77q-54 0 -100 19.5t-87 56.5q-47 43 -79.5 64.5t-71.5 21.5q-52 0 -78 -45t-30 -121h-131q8 151 79 228t174 77q50 0 96.5 -19.5t88.5 -55.5q47 -41 83.5 -61.5t69.5 -20.5q51 0 79.5 46t31.5 116h129z","M1137 558q0 -273 -140 -431t-375 -158q-237 0 -376.5 158t-139.5 431t139.5 431.5t376.5 158.5q235 0 375 -158.5t140 -431.5zM943 558q0 217 -85 322.5t-236 105.5q-153 0 -237.5 -105.5t-84.5 -322.5q0 -210 85 -318.5t237 -108.5q150 0 235.5 107.5t85.5 319.5z M928 1304h-199v195h199v-195zM515 1304h-199v195h199v-195z","M957 1022h-238v275h238v-275zM1466 572h-1256v160h1256v-160zM957 7h-238v275h238v-275z","M1137 558q0 -273 -140 -431t-375 -158q-84 0 -155.5 21t-130.5 60l-133 -198h-110l171 256q-75 77 -116.5 190t-41.5 260q0 273 139.5 431.5t376.5 158.5q87 0 158 -22t125 -57l116 172h111l-155 -231q76 -76 118 -188t42 -264zM813 930q-37 29 -86.5 43.5t-104.5 14.5 q-155 0 -240 -110t-85 -320q0 -97 17 -171t52 -128zM946 558q0 97 -17.5 173t-51.5 130l-448 -671q39 -31 86.5 -46t106.5 -15q150 0 237 108.5t87 320.5z","M1111 0h-188v124q-95 -75 -182 -115t-192 -40q-176 0 -274 107.5t-98 315.5v725h188v-636q0 -85 8 -145.5t34 -103.5q27 -44 70 -64t125 -20q73 0 159.5 38t161.5 97v834h188v-1117zM764 1302h-149l-273 374h243z","M1111 0h-188v124q-95 -75 -182 -115t-192 -40q-176 0 -274 107.5t-98 315.5v725h188v-636q0 -85 8 -145.5t34 -103.5q27 -44 70 -64t125 -20q73 0 159.5 38t161.5 97v834h188v-1117zM945 1676l-273 -374h-149l179 374h243z","M1111 0h-188v124q-95 -75 -182 -115t-192 -40q-176 0 -274 107.5t-98 315.5v725h188v-636q0 -85 8 -145.5t34 -103.5q27 -44 70 -64t125 -20q73 0 159.5 38t161.5 97v834h188v-1117zM985 1297h-159l-185 256l-184 -256h-155l228 379h227z","M1111 0h-188v124q-95 -75 -182 -115t-192 -40q-176 0 -274 107.5t-98 315.5v725h188v-636q0 -85 8 -145.5t34 -103.5q27 -44 70 -64t125 -20q73 0 159.5 38t161.5 97v834h188v-1117zM955 1304h-199v195h199v-195zM542 1304h-199v195h199v-195z","M1151 1117l-652 -1529h-201l208 466l-445 1063h204l343 -828l346 828h197zM928 1676l-273 -374h-149l179 374h243z","M1168 572q0 -136 -39 -248.5t-110 -190.5q-66 -74 -155.5 -114.5t-189.5 -40.5q-87 0 -157.5 19t-143.5 59v-468h-188v1968h188v-556q75 63 168.5 105.5t199.5 42.5q202 0 314.5 -152.5t112.5 -423.5zM974 567q0 202 -69 302t-212 100q-81 0 -163 -35t-157 -92v-633 q80 -36 137.5 -49t130.5 -13q157 0 245 106t88 314z","M585 832h-239v285h239v-285zM658 285l-282 -655h-146l174 655h254z","M773 1676l-49 -384h-145l-49 384h243z","M765 1676l-49 -384h-128l-49 384h226zM1048 1304h-191v195h191v-195zM447 1304h-191v195h191v-195z","M1374 0h-211l-146 415h-644l-146 -415h-201l542 1489h264zM956 585l-261 731l-262 -731h523zM250 1489l-49 -384h-145l-49 384h243z","M585 832h-239v285h239v-285z","M1424 0h-981v1489h981v-176h-783v-408h783v-176h-783v-553h783v-176zM243 1489l-49 -384h-145l-49 384h243z","M1582 0h-198v729h-743v-729h-198v1489h198v-584h743v584h198v-1489zM243 1489l-49 -384h-145l-49 384h243z","M968 0h-588v152h195v1185h-195v152h588v-152h-195v-1185h195v-152zM243 1489l-49 -384h-145l-49 384h243z","M1501 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1483 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5zM243 1489l-49 -384h-145l-49 384h243z","M1537 1489l-524 -836v-653h-198v632l-526 857h219l407 -666l411 666h211zM243 1489l-49 -384h-145l-49 384h243z","M1751 0h-576v387q60 38 119.5 82t103.5 101q45 59 71 138.5t26 185.5q0 206 -127 330.5t-347 124.5t-347 -124.5t-127 -330.5q0 -106 26 -185.5t71 -138.5q45 -57 104 -101t119 -82v-387h-576v174h410v124q-157 90 -258.5 246t-101.5 350q0 276 187.5 451t492.5 175 t492.5 -175t187.5 -451q0 -194 -101.5 -350t-258.5 -246v-124h410v-174zM243 1489l-49 -384h-145l-49 384h243z","M375 0h-188v1117h188v-1117zM379 1676l-56 -384h-84l-56 384h196zM615 1304h-171v195h171v-195zM118 1304h-171v195h171v-195z","M1374 0h-211l-146 415h-644l-146 -415h-201l542 1489h264zM956 585l-261 731l-262 -731h523z","M1323 458q0 -111 -42 -196t-113 -140q-84 -66 -184.5 -94t-255.5 -28h-528v1489h441q163 0 244 -12t155 -50q82 -43 119 -110.5t37 -161.5q0 -106 -54 -180.5t-144 -119.5v-8q151 -31 238 -132.5t87 -256.5zM990 1129q0 54 -18 91t-58 60q-47 27 -114 33.5t-166 6.5h-236 v-430h256q93 0 148 9.5t102 39.5t66.5 77.5t19.5 112.5zM1117 450q0 90 -27 143t-98 90q-48 25 -116.5 32.5t-166.5 7.5h-311v-554h262q130 0 213 13.5t136 49.5q56 39 82 89t26 129z","M1162 1313h-764v-1313h-198v1489h962v-176z","M1414 0h-1388l562 1489h264zM1147 168l-432 1147l-431 -1147h863z","M1181 0h-981v1489h981v-176h-783v-408h783v-176h-783v-553h783v-176z","M1288 0h-1162v184l913 1129h-879v176h1106v-179l-922 -1134h944v-176z","M1339 0h-198v729h-743v-729h-198v1489h198v-584h743v584h198v-1489z","M1310 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1292 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5zM1120 713h-627v179h627v-179z","M725 0h-588v152h195v1185h-195v152h588v-152h-195v-1185h195v-152z","M1397 0h-257l-589 663l-148 -158v-505h-198v1489h198v-777l723 777h240l-665 -700z","M1378 0h-213l-468 1285l-468 -1285h-203l556 1489h240z","M1526 0h-198v1283l-414 -873h-118l-411 873v-1283h-185v1489h270l397 -829l384 829h275v-1489z","M1336 0h-245l-706 1332v-1332h-185v1489h307l644 -1216v1216h185v-1489z","M1215 1313h-1101v176h1101v-176zM1163 729h-997v176h997v-176zM1215 0h-1101v176h1101v-176z","M1310 1318q91 -100 139.5 -245t48.5 -329t-49.5 -329.5t-138.5 -242.5q-92 -101 -217.5 -152t-286.5 -51q-157 0 -285.5 52t-218.5 151t-138.5 243t-48.5 329q0 182 48 326.5t140 247.5q88 98 218.5 150t284.5 52q160 0 287.5 -52.5t216.5 -149.5zM1292 744 q0 290 -130 447.5t-355 157.5q-227 0 -356.5 -157.5t-129.5 -447.5q0 -293 132 -448.5t354 -155.5t353.5 155.5t131.5 448.5z","M1339 0h-198v1313h-743v-1313h-198v1489h1139v-1489z","M1174 1039q0 -99 -34.5 -183.5t-96.5 -146.5q-77 -77 -182 -115.5t-265 -38.5h-198v-555h-198v1489h404q134 0 227 -22.5t165 -70.5q85 -57 131.5 -142t46.5 -215zM968 1034q0 77 -27 134t-82 93q-48 31 -109.5 44.5t-155.5 13.5h-196v-595h167q120 0 195 21.5t122 68.5 q47 48 66.5 101t19.5 119z","M1280 0h-1162v184l620 600l-600 526v179h1096v-176h-832l586 -506v-26l-630 -605h922v-176z","M1262 1313h-532v-1313h-198v1313h-532v176h1262v-176z","M1254 1489l-524 -836v-653h-198v632l-526 857h219l407 -666l411 666h211z","M1572 755q0 -140 -44.5 -248.5t-123.5 -181.5q-85 -79 -207 -125.5t-260 -49.5v-166h-197v166q-134 3 -257 48t-210 127q-79 74 -123.5 182t-44.5 248q0 136 43 238t119 178q81 81 202.5 128t270.5 51v155h197v-155q148 -3 271 -52t202 -127q75 -73 118.5 -177t43.5 -239 zM1366 763q0 99 -32 182t-91 140q-58 56 -129 82t-177 28v-890q94 2 171 30.5t127 75.5q65 60 98 147t33 205zM740 305v890q-106 -1 -177 -28t-129 -82t-90.5 -140t-32.5 -182q0 -112 33.5 -203t97.5 -149q49 -45 126.5 -75t171.5 -31z","M1336 1489l-514 -736l513 -753h-229l-406 613l-416 -613h-216l519 744l-507 745h228l401 -605l410 605h217z","M1604 910q0 -157 -40.5 -264.5t-117.5 -174.5q-80 -69 -192.5 -104t-263.5 -45v-322h-197v322q-154 11 -267 47t-188 102q-78 69 -118.5 176t-40.5 263v579h198v-602q0 -109 29.5 -180t81.5 -115q53 -45 130 -68.5t175 -30.5v996h197v-996q97 8 175 30.5t131 68.5 q56 49 83 115.5t27 179.5v602h198v-579z","M1568 0h-576v387q60 38 119.5 82t103.5 101q45 59 71 138.5t26 185.5q0 206 -127 330.5t-347 124.5t-347 -124.5t-127 -330.5q0 -106 26 -185.5t71 -138.5q45 -57 104 -101t119 -82v-387h-576v174h410v124q-157 90 -258.5 246t-101.5 350q0 276 187.5 451t492.5 175 t492.5 -175t187.5 -451q0 -194 -101.5 -350t-258.5 -246v-124h410v-174z","M725 0h-588v152h195v1185h-195v152h588v-152h-195v-1185h195v-152zM738 1677h-199v195h199v-195zM325 1677h-199v195h199v-195z","M1254 1489l-524 -836v-653h-198v632l-526 857h219l407 -666l411 666h211zM939 1677h-199v195h199v-195zM526 1677h-199v195h199v-195z","M1091 0h-188v117q-81 -70 -169 -109t-191 -39q-200 0 -317.5 154t-117.5 427q0 142 40.5 253t109.5 189q68 76 158.5 116t187.5 40q88 0 156 -22t143 -61v52h188v-1117zM903 275v636q-76 34 -136 49.5t-131 15.5q-158 0 -246 -110t-88 -312q0 -199 68 -302.5t218 -103.5 q80 0 162 35.5t153 91.5zM743 1676l-49 -384h-145l-49 384h243z","M1006 64q-107 -48 -210 -69t-218 -21q-79 0 -161 16t-152 56q-69 39 -112.5 102.5t-43.5 157.5q0 96 56.5 168t177.5 110v7q-91 24 -145 90t-54 158q0 89 47.5 147.5t112.5 92.5q64 33 145 49t160 16q98 0 180 -16.5t172 -44.5v-207h-13q-66 51 -163.5 79t-197.5 28 q-45 0 -84 -5.5t-81 -25.5q-35 -15 -60.5 -48.5t-25.5 -77.5q0 -61 28 -95t76 -49q45 -14 97 -15.5t105 -1.5h111v-166h-158q-62 0 -112 -4.5t-92 -21.5q-41 -17 -65.5 -54t-24.5 -96q0 -53 26 -90t67 -58q37 -19 87.5 -29t106.5 -10q102 0 218 36t187 98h13v-206zM721 1676 l-49 -384h-145l-49 384h243z","M1119 -412h-188v1048q0 77 -9 144.5t-33 105.5q-25 42 -72 62.5t-122 20.5q-77 0 -161 -38t-161 -97v-834h-188v1117h188v-124q88 73 182 114t193 41q181 0 276 -109t95 -314v-1137zM802 1676l-49 -384h-145l-49 384h243z","M375 0h-188v1117h188v-1117zM403 1676l-49 -384h-145l-49 384h243z","M1116 407q0 -218 -122 -327.5t-348 -109.5q-223 0 -346 107.5t-123 329.5v710h188v-641q0 -93 10 -153t42 -106q31 -43 84.5 -64.5t145.5 -21.5q86 0 143.5 22t87.5 66q29 44 39.5 105.5t10.5 151.5v641h188v-710zM760 1676l-49 -384h-128l-49 384h226zM1043 1304h-191 v195h191v-195zM442 1304h-191v195h191v-195z","M1091 0h-188v117q-81 -70 -169 -109t-191 -39q-200 0 -317.5 154t-117.5 427q0 142 40.5 253t109.5 189q68 76 158.5 116t187.5 40q88 0 156 -22t143 -61v52h188v-1117zM903 275v636q-76 34 -136 49.5t-131 15.5q-158 0 -246 -110t-88 -312q0 -199 68 -302.5t218 -103.5 q80 0 162 35.5t153 91.5z","M1165 444q0 -202 -134.5 -334t-339.5 -132q-79 0 -167 22t-151 64v-476h-188v1490q0 224 126.5 351t349.5 127q90 0 164.5 -21.5t133.5 -67.5q57 -43 91 -112t34 -160q0 -127 -69.5 -221.5t-196.5 -131.5v-17q159 -26 253 -125.5t94 -255.5zM971 449q0 89 -34.5 144.5 t-92.5 86.5q-59 32 -132 43t-146 11h-36v160h36q66 0 131 14.5t104 44.5q46 34 68.5 83t22.5 134q0 112 -69 170t-178 58q-73 0 -125 -26.5t-85 -70.5q-32 -44 -47 -102.5t-15 -120.5v-862q66 -38 141 -53.5t147 -15.5q149 0 229.5 78.5t80.5 223.5z","M1151 1117l-457 -1061v-468h-188v468l-445 1061h204l343 -828l346 828h197z","M1139 551q0 -272 -138.5 -427t-376.5 -155q-241 0 -379.5 151.5t-138.5 413.5q0 141 43 239.5t107 162.5q69 72 159 113t182 58q-76 63 -166 130.5t-192 139.5v179h810v-158h-561v-10q68 -46 179 -124t204 -162q150 -136 209 -261.5t59 -289.5zM945 551q0 135 -55 249 t-165 200q-66 -8 -138.5 -32t-138.5 -77q-63 -50 -105.5 -137t-42.5 -214q0 -201 85 -305t241 -104q153 0 236 105.5t83 314.5z","M1006 64q-107 -48 -210 -69t-218 -21q-79 0 -161 16t-152 56q-69 39 -112.5 102.5t-43.5 157.5q0 96 56.5 168t177.5 110v7q-91 24 -145 90t-54 158q0 89 47.5 147.5t112.5 92.5q64 33 145 49t160 16q98 0 180 -16.5t172 -44.5v-207h-13q-66 51 -163.5 79t-197.5 28 q-45 0 -84 -5.5t-81 -25.5q-35 -15 -60.5 -48.5t-25.5 -77.5q0 -61 28 -95t76 -49q45 -14 97 -15.5t105 -1.5h111v-166h-158q-62 0 -112 -4.5t-92 -21.5q-41 -17 -65.5 -54t-24.5 -96q0 -53 26 -90t67 -58q37 -19 87.5 -29t106.5 -10q102 0 218 36t187 98h13v-206z","M922 75q32 -40 46 -85.5t14 -85.5q0 -84 -45 -168.5t-112 -147.5h-179v14q90 79 128 138.5t38 128.5q0 57 -30.5 95t-77.5 38h-145q-229 0 -340 116t-111 345q0 140 46 268t124 247q75 112 173.5 214.5t206.5 196.5v9h-460v158h744v-135q-117 -78 -231.5 -181 t-204.5 -223q-89 -117 -146 -257t-57 -283q0 -34 3 -70t15 -76q10 -38 34.5 -75.5t63.5 -61.5q36 -22 96.5 -24.5t116.5 -2.5h86q71 0 122 -26t82 -66z","M1119 -412h-188v1048q0 77 -9 144.5t-33 105.5q-25 42 -72 62.5t-122 20.5q-77 0 -161 -38t-161 -97v-834h-188v1117h188v-124q88 73 182 114t193 41q181 0 276 -109t95 -314v-1137z","M1141 768q0 -190 -23 -316.5t-59 -210.5q-58 -135 -163 -203.5t-257 -68.5t-257 68.5t-163 203.5q-37 84 -59.5 210.5t-22.5 316.5q0 174 22.5 305.5t60.5 214.5q57 130 162.5 199t256.5 69t256.5 -69t162.5 -199q37 -84 60 -215t23 -305zM952 858q-4 143 -28.5 250 t-56.5 161q-41 70 -95 98.5t-133 28.5t-133 -28.5t-95 -98.5q-34 -55 -57.5 -161.5t-27.5 -249.5h626zM952 697h-626q0 -142 23 -258.5t59 -178.5q40 -69 96 -100t135 -31t135 31t96 100q36 62 59 178.5t23 258.5z","M375 0h-188v1117h188v-1117z","M1192 0h-248l-451 489l-112 -109v-380h-188v1117h188v-550l384 417q72 79 135.5 107t126.5 28q28 0 58 -1t37 -1v-166h-11q-16 2 -39.5 3t-36.5 1q-47 0 -85.5 -23.5t-67.5 -56.5l-251 -271z","M1151 0h-205l-328 829l-361 -829h-196l465 1056l-215 500h211z","M1125 0h-186v118q-74 -78 -141.5 -108.5t-145.5 -30.5q-75 0 -135 27t-144 107v-525h-188v1529h188v-838q32 -39 111 -80t170 -41q93 0 161 33.5t122 93.5v832h188v-1117z","M1151 1117l-452 -1117h-189l-449 1117h204l346 -889l343 889h197z","M1041 -96q0 -85 -45.5 -169t-111.5 -147h-180v14q92 79 129.5 139t37.5 128q0 55 -29 94t-75 39h-140q-140 0 -232.5 27t-155.5 84q-66 60 -100.5 135.5t-34.5 163.5q0 78 25 144t73 119q44 49 112.5 83.5t144.5 53.5v11q-125 28 -200 110.5t-75 186.5q0 83 43.5 150.5 t133.5 125.5v6h-228v154h824v-158h-256q-68 0 -122.5 -14.5t-102.5 -48.5q-45 -32 -72 -83t-27 -118q0 -79 32.5 -128t83.5 -75q45 -23 104 -34t139 -11h170v-165h-295q-66 0 -118.5 -20t-99.5 -59q-43 -37 -68.5 -90t-25.5 -112q0 -102 37.5 -159t101.5 -82 q63 -25 139.5 -28.5t166.5 -3.5h28q68 0 119.5 -23.5t84.5 -60.5q31 -35 48 -82.5t17 -96.5z","M1137 558q0 -273 -140 -431t-375 -158q-237 0 -376.5 158t-139.5 431t139.5 431.5t376.5 158.5q235 0 375 -158.5t140 -431.5zM943 558q0 217 -85 322.5t-236 105.5q-153 0 -237.5 -105.5t-84.5 -322.5q0 -210 85 -318.5t237 -108.5q150 0 235.5 107.5t85.5 319.5z","M1120 0h-188v955h-559v-955h-188v1117h935v-1117z","M1172 577q0 -258 -138.5 -428.5t-360.5 -170.5q-65 0 -146.5 18t-153.5 61v-469h-188v1058q0 123 35.5 215.5t101.5 158.5q62 62 155.5 95t195.5 33q243 0 371 -147t128 -424zM978 565q0 218 -80 320t-226 102q-158 0 -228.5 -96t-70.5 -278v-403q73 -34 132.5 -48.5 t134.5 -14.5q162 0 250 111t88 307z","M1018 -96q0 -87 -47 -172t-109 -144h-177v14q86 75 124.5 135.5t38.5 131.5q0 54 -30 93.5t-75 39.5h-92q-117 0 -216 30t-174 97q-73 66 -114.5 170t-41.5 250q0 270 155.5 432t414.5 162q84 0 164 -18.5t147 -45.5v-211h-12q-94 62 -172.5 87t-146.5 25 q-166 0 -260.5 -119t-94.5 -312q0 -112 28.5 -183t78.5 -116q50 -44 114.5 -63.5t139.5 -19.5h100q115 0 186 -76.5t71 -186.5z","M1137 558q0 -281 -140.5 -435t-373.5 -154q-241 0 -379 158t-138 431q0 275 141 432.5t378 157.5q55 0 108 -11t82 -20h480v-165h-288q62 -73 96 -170t34 -224zM943 558q0 215 -82 322t-236 107q-161 0 -243 -112t-82 -317q0 -209 83.5 -318t239.5 -109q152 0 236 107.5 t84 319.5z","M1006 952h-404v-952h-188v952h-404v165h996v-165z","M1116 407q0 -218 -122 -327.5t-348 -109.5q-223 0 -346 107.5t-123 329.5v710h188v-641q0 -93 10 -153t42 -106q31 -43 84.5 -64.5t145.5 -21.5q86 0 143.5 22t87.5 66q29 44 39.5 105.5t10.5 151.5v641h188v-710z","M1514 576q0 -259 -171.5 -417t-440.5 -173v-398h-187v398q-130 6 -240.5 46.5t-191.5 109.5q-85 74 -132 172t-47 232q0 159 59 296t192 275h229v-17q-136 -99 -210 -232t-74 -300q0 -189 112.5 -304t301.5 -121v1000q33 2 70.5 2.5t76.5 0.5q304 0 478.5 -149.5 t174.5 -420.5zM1319 586q0 184 -112 293.5t-305 109.5v-846q206 10 311.5 126t105.5 317z","M1160 -412h-213l-346 619l-350 -619h-203l444 770l-433 759h213l335 -600l339 600h203l-433 -751z","M1507 446q0 -114 -48 -198t-127 -137q-82 -55 -182 -82.5t-215 -32.5v-408h-187v408q-115 6 -214.5 32t-182.5 83q-80 54 -127.5 137.5t-47.5 197.5v671h188v-612q0 -113 37.5 -180.5t89.5 -102.5q56 -38 123 -53t134 -19v967h187v-967q67 5 134 19t123 53 q59 40 93 101.5t34 181.5v612h188v-671z","M1553 503q0 -96 -23.5 -192.5t-74.5 -171.5q-55 -80 -133.5 -124.5t-193.5 -44.5q-96 0 -177 49.5t-118 116.5h-6q-39 -68 -113 -117t-176 -49q-113 0 -194.5 46.5t-132.5 122.5t-74.5 171.5t-23.5 192.5q0 170 57 308.5t201 305.5h228v-17q-135 -108 -214.5 -262 t-79.5 -337q0 -66 8 -122.5t38 -119.5q26 -55 72.5 -91.5t117.5 -36.5q51 0 86.5 12.5t55.5 29.5q22 18 36.5 40t20.5 37v584h186v-584q9 -17 23 -39t35 -39q24 -19 52.5 -30t86.5 -11q70 0 117 35.5t74 92.5q25 55 36 116t11 126q0 182 -78.5 336t-215.5 263v17h228 q144 -167 201 -305.5t57 -308.5z","M557 1304h-189v195h189v-195zM194 1304h-189v195h189v-195zM375 0h-188v1117h188v-1117z","M1116 407q0 -218 -122 -327.5t-348 -109.5q-223 0 -346 107.5t-123 329.5v710h188v-641q0 -93 10 -153t42 -106q31 -43 84.5 -64.5t145.5 -21.5q86 0 143.5 22t87.5 66q29 44 39.5 105.5t10.5 151.5v641h188v-710zM953 1304h-199v195h199v-195zM540 1304h-199v195h199 v-195z","M1137 558q0 -273 -140 -431t-375 -158q-237 0 -376.5 158t-139.5 431t139.5 431.5t376.5 158.5q235 0 375 -158.5t140 -431.5zM943 558q0 217 -85 322.5t-236 105.5q-153 0 -237.5 -105.5t-84.5 -322.5q0 -210 85 -318.5t237 -108.5q150 0 235.5 107.5t85.5 319.5z M743 1676l-49 -384h-145l-49 384h243z","M1116 407q0 -218 -122 -327.5t-348 -109.5q-223 0 -346 107.5t-123 329.5v710h188v-641q0 -93 10 -153t42 -106q31 -43 84.5 -64.5t145.5 -21.5q86 0 143.5 22t87.5 66q29 44 39.5 105.5t10.5 151.5v641h188v-710zM768 1676l-49 -384h-145l-49 384h243z","M1553 503q0 -96 -23.5 -192.5t-74.5 -171.5q-55 -80 -133.5 -124.5t-193.5 -44.5q-96 0 -177 49.5t-118 116.5h-6q-39 -68 -113 -117t-176 -49q-113 0 -194.5 46.5t-132.5 122.5t-74.5 171.5t-23.5 192.5q0 170 57 308.5t201 305.5h228v-17q-135 -108 -214.5 -262 t-79.5 -337q0 -66 8 -122.5t38 -119.5q26 -55 72.5 -91.5t117.5 -36.5q51 0 86.5 12.5t55.5 29.5q22 18 36.5 40t20.5 37v584h186v-584q9 -17 23 -39t35 -39q24 -19 52.5 -30t86.5 -11q70 0 117 35.5t74 92.5q25 55 36 116t11 126q0 182 -78.5 336t-215.5 263v17h228 q144 -167 201 -305.5t57 -308.5zM955 1676l-49 -384h-145l-49 384h243z","M1145 837q0 -164 -39 -344t-121 -303q-85 -124 -186.5 -173t-214.5 -49q-192 0 -313.5 126.5t-121.5 329.5q0 228 134.5 372.5t336.5 144.5q90 0 169.5 -26t158.5 -91q2 26 3 55.5t1 55.5q0 217 -79 318t-231 101q-78 0 -169.5 -31.5t-169.5 -86.5h-11v194 q81 44 181.5 66.5t196.5 22.5q137 0 239.5 -54.5t164.5 -178.5q42 -86 56.5 -189t14.5 -260zM942 678q-60 47 -136 74t-148 27q-141 0 -225 -91t-84 -261q0 -145 67.5 -221.5t179.5 -76.5q128 0 209.5 97t115.5 287q6 33 11.5 73t9.5 92z","M1438 0h-1388l562 1489h264zM1171 168l-432 1147l-431 -1147h863z","M1532 1315h-200v-1508h-198v1508h-592v-1508h-198v1508h-200v174h1388v-174z","M1369 -189h-1182v191l673 668l-663 631v188h1133v-176h-891l648 -601v-72l-666 -653h948v-176z","M1456 572h-1236v160h1236v-160z","M843 1489l-780 -1489h-165l780 1489h165z","M492 511h-239v283h239v-283z","M1737 1788l-880 -1939h-102l-384 993h-237v139h393l313 -821l730 1628h167z","M1887 663q0 -239 -122.5 -372.5t-329.5 -133.5q-133 0 -244 76.5t-180 222.5q-79 -151 -184.5 -225t-248.5 -74q-191 0 -304 135.5t-113 349.5q0 238 125 372t327 134q134 0 245 -77t179 -222q79 150 185.5 224.5t247.5 74.5q191 0 304 -135.5t113 -349.5zM967 729 q-63 117 -155 175.5t-188 58.5q-138 0 -216 -83.5t-78 -237.5q0 -133 63.5 -216t182.5 -83q110 0 172 48.5t119 142.5q34 57 52.5 92.5t47.5 102.5zM1718 663q0 134 -64 216.5t-182 82.5q-88 0 -152.5 -35.5t-138.5 -155.5q-30 -48 -55.5 -99.5t-44.5 -95.5 q60 -115 153.5 -174.5t189.5 -59.5q138 0 216 83t78 238z","M1168 1367h-10q-32 8 -89.5 18.5t-89.5 10.5q-129 0 -181 -61q-53 -61 -53 -210v-1123q0 -206 -104 -315q-105 -110 -293 -110q-52 0 -106.5 5.5t-103.5 15.5v178h10q33 -8 87 -18.5t88 -10.5q129 0 182 61q52 61 52 210v1123q0 204 104 315q104 110 293 110 q58 0 109 -5.5t105 -15.5v-178z","M1431 1104q-20 -194 -111 -293t-249 -99q-77 0 -147 37.5t-126 82.5q-65 52 -117 79.5t-96 27.5q-75 0 -117 -48t-70 -172h-155q23 182 112.5 280t248.5 98q72 0 143 -37t130 -83q61 -48 114.5 -77.5t98.5 -29.5q76 0 120.5 54.5t63.5 179.5h157zM1432 588 q-25 -184 -112 -281.5t-250 -97.5q-72 0 -144 37.5t-129 82.5q-39 31 -103 69t-110 38q-78 0 -121 -55t-63 -179h-157q19 192 110.5 292t249.5 100q77 0 146 -37t127 -83q35 -28 97 -67.5t116 -39.5q75 0 117 49.5t69 171.5h157z","M1431 362h-608l-104 -335h-153l104 335h-425v156h474l84 268h-558v156h606l105 335h153l-105 -335h427v-156h-476l-83 -268h559v-156z","M1408 303l-1154 483v124l1154 483v-183l-889 -362l889 -362v-183zM1408 0h-1154v160h1154v-160z","M1422 786l-1154 -483v183l889 362l-889 362v183l1154 -483v-124zM1422 0h-1154v160h1154v-160z"],this.OUTLINE_X=[[],[291,301,505,515],[168,211,729,772,554],[195,389,917,1364,1481,1481,1288,760,312,195],[155,604,722,1129.8,1160,1107,722,604,278.5,191.1,162,155],[149,172.3,242,630,1687,1844.3,1960,2031.3,2055,2031.8,1962,1575,517,359.8,244,172.8],[115,149.4,252.5,407.6,598,1555,1287,961.3,881,757.5,601,423.5,293,213.5,187],[164,207,343,386],[181,205.5,279,554,783,783,554,279,205.5],[147,376,651,724.5,749,724.5,651,376,147],[167,232,588,717,1073,1137,1137,1073,717,588,232,167],[210,755,921,1466,1466,921,755,210],[147,293,575,321],[153,777,777,153],[253,492,492,253],[-30,143,860,684],[137,167.9,260.5,420.1,652,881.4,1041.5,1135.6,1167,1136.1,1043.5,883.9,652,422,262,168.3],[278,1084,1084,780,625,278],[161,1169,1169,1106,1073.5,976,821.3,617,387.5,198,161],[167,364,608,830.5,1007,1111,1148,1117,1080,971,821,629,399.5,210,167],[77,790,982,1203,1203,982,798,77],[187,378,613,843.5,1015,1119,1157,1147,251,187],[137,183.5,316,475,675,875.1,1041.5,1153.6,1191,1046,965,866,542,315,179.5],[154,285,499,1173,1173,154],[122,157.9,265.5,433.6,651,859.6,1029.5,1142.4,1180,1140,1106.8,1007,851.5,651,456.8,300,196.5,162],[113,258,340,438,760,988,1122.5,1167,1121,990,829,629,429.5,263,150.5],[346,585,585,346],[230,376,658,585,346],[254,1408,1408,254],[245,1431,1431,245],[268,1422,1422,268],[160,406,610,970,1005,973.9,880.5,733.4,541,337.5,160],[176,240,419,692,1037,1210,1391,1714,1829.5,1870,1813.5,1651,1391,1041,701,426,243],[26,1374,832,568],[200,728,983.5,1168,1281,1323,1196,1159,1040,885,641,200],[115,169,319,549.5,844,1001.5,1134,1250.5,1350,1350,1084.5,845,546.5,317,167],[200,576,906.5,1134,1369.5,1458,1373,1136,918.5,572,200],[200,1181,1181,200],[200,398,1045,1151,1151,200],[115,171,330,577,896,1175.5,1442,1442,1441,1155.5,896,570.9,323.5,167.1],[200,1339,1339,200],[137,725,725,137],[44,178,306,486.6,626.5,716.1,746,746,233,44],[205,1397,1366,205],[200,1142,1142,398,200],[200,1526,1526,200],[200,1336,1336,200],[115,163.5,302,520.5,806,1092.5,1310,1448.5,1498,1449.5,1310,1093.5,806,521.5,303,163],[200,398,1043,1139.5,1174,1127.5,996,831,604,200],[115,163.5,302,520.5,1010.5,1133.1,1290,1409.5,1528,1528,1498,1449.5,1310,1093.5,806,521.5,303,163],[200,1432,1130.5,1004,842,617,200],[134,395.5,685,941.5,1128,1241.5,1282,1222,990,702,480.3,301,182.5,143,134],[0,532,730,1262,1262,0],[178,213.5,330,505,749,989,1169,1285.5,1321,1321,178],[26,568,832,1374,238],[92,486,1546,1933,295],[68,1335,1336,80],[6,532,730,1254,225],[126,1288,1288,1266,160,126],[239,759,759,239],[70,787,960,246],[171,691,691,171],[186,383,1490,901,775],[-4,1306,1306,-4],[340,613,762,583],[104,130.3,209,325.5,465,1053,1053,1020,924,772.5,567,362,203],[185,679,866,1022,1128.5,1168,1139.4,1053.5,918.1,373,185],[105,145,258,431,653,832.5,1011,1011,841.5,653,430.1,255.5,142.6],[108,137.4,225.5,363.6,543,1091,1091,903,258,148.5],[106,145,262,448.5,696,904,1098,1120,1120,1089.4,997.5,849.1,649,428.6,255.5,143.4],[68,195,383,716,786,786,693.5,580,415,294,68],[108,225,391.5,565,798.3,962,1058.8,1091,1091,602,417,259,148.5],[185,1119,1119,1095.3,1024,373,185],[175,187,375,387,387,175],[-62,47.5,153,304,421,496,521,533,533,321,100,-62],[193,1199,1161,381,193],[187,375,375,187],[185,1815,1815,1793.1,1727.5,1615.9,1456,735,185],[185,1119,1119,1095.3,1024,907.5,748,185],[106,140.9,245.5,409.4,622,833.3,997,1102,1137,1102,997,833.3,622,409.4,245.5,140.9],[185,373,1019,1129,1168,1139.9,1055.5,920.6,741,185],[108,137.6,226.5,365.1,903,1091,1091,602,414,259,149.5],[185,373,882,882,816,745,185],[110,283.5,511,706.9,856.5,951.4,983,939,768.5,566,372.5,230,143.5,115,110],[62,211.3,278,387.5,538,649.5,765,765,377,189,62],[177,201.5,275,392.5,549,1111,1111,177],[61,510,699,1151,265],[86,380,1299,1590,766],[60,1152,1152,64],[61,298,499,1151,265],[93,995,995,978,107,93],[173,588.9,672.5,800.9,963,1113,1113,963,800.9,672.5,588.9,173],[378,552,552,378],[187,337,499.1,627.5,711.1,1127,1127,711.1,627.5,499.1,337,187],[187,354,1125,1290,1401,1466.5,1489,1322,551,386,274,209.5],[],[291,515,505,301],[159,191.6,289.5,647,765,1120,1120,765,647,292.5,192.4],[137,1163,1163,1137,997,816,630.6,484.5,389.6,182,137],[138,247,1058,1168,1168,1055,249,138],[108,187,557,745,1115,1191,320],[378,552,552,378],[172,229,404.5,575,796,965,1063,1096,1128,1071,896,725,497.5,334,235,203],[346,958,958,346],[159,222.4,412.5,692.1,1024,1355.9,1635.5,1825.6,1889,1825.6,1635.5,1355.9,1024,692.1,412.5,222.4],[151,238.5,454,944,944,920.3,849,723.5,537,368,231],[166,716,1146,1146,716,166],[210,1285,1456,1456,210],[153,777,777,153],[159,222.4,412.5,692.1,1024,1355.9,1635.5,1825.6,1889,1825.6,1635.5,1355.9,1024,692.1,412.5,222.4],[-4,1,1306,1306],[154,183,270,399.3,555,710.8,840,927,956,927.1,840.5,711.4,555,399.3,270,183],[215,1461,1461,921,755,215],[207,967,967,911,887.6,817.5,544,369.5,211,207],[207,363.5,540,703,834,923,956,929,904.9,832.5,561,384.5,224,207],[541,690,963,720],[190,378,1124,1124,190],[137,168.5,595,1106,1106,640,425.3,267,169.5],[253,492,492,253],[353,456,551,788.5,857.1,880,877,872,719,353],[291,299,914,914,693,558,291],[121,150.6,239.5,378.6,559,734.3,874,965.5,996,965.5,874,734.3,559,378.6,239.5,150.6],[174,604,1154,1154,604,174],[171,465,1694,1857,1857,1694,1410,545,408,171],[171,465,1955,1955,1890,1805.5,1410,545,408,171],[140,555,1750,1913,1913,1750,1500,448,294,155,140],[113,144.1,237.5,384.6,577,782,958,958,712,508,147.5],[26,1374,862,683,440],[26,1374,955,712,533],[26,1374,1033,805,578,350],[26,1374,1119,990,541,367,288],[26,1374,1005,806,393],[26,1374,1049,1023.6,947.5,834.6,699,564,451,374.5,349],[14,1901,1901,608],[115,169,548,652.5,750,990.5,1350,1350,1084.5,845,546.5,317,167],[200,1181,1181,643,400,200],[200,1181,1181,993,750,200],[200,1181,1181,803,576,200],[200,1181,1181,1038,426,200],[137,725,725,389,146,137],[137,725,725,482,137],[93,137,725,776,548,321],[126,137,725,738,738,126],[14,210,586,916.5,1144,1379.5,1468,1383,1146,929,582,210,14],[200,1336,1336,1208,1079,630,456,200],[115,163.5,302,520.5,806,1092.5,1310,1448.5,1498,1449.5,1310,753,510,163],[115,163.5,302,520.5,806,1092.5,1310,1448.5,1498,1449.5,1083,840,303,163],[115,163.5,302,520.5,806,1092.5,1310,1448.5,1498,1449.5,1136,908,681,453,163],[115,163.5,302,520.5,806,1092.5,1310,1448.5,1498,1449.5,1207,1078,629,455,163],[112,160.5,299,517.5,803,1089.5,1307,1445.5,1495,1446.5,1108,909,496,160],[291,402,1274,1385,1385,1274,402,291],[115,120,252,1092.5,1310,1448.5,1498,1474,1342,806,521.5,303,163],[178,213.5,330,505,749,989,1169,1285.5,1321,1321,753,510,178],[178,213.5,330,505,749,989,1169,1285.5,1321,1321,1073,830,178],[178,213.5,330,505,749,989,1169,1285.5,1321,1321,856,629,178],[178,213.5,330,505,749,989,1169,1285.5,1321,1321,1056,444,178],[6,532,730,1254,935,692],[200,398,1044,1139,1174,1127,997,398,200],[185,675,873.1,1029.5,1131.1,1165,1066,1037.4,951.5,819.9,654,470.5,321,221,185],[104,130.3,209,325.5,465,1053,1053,1020,559,316,203],[104,130.3,209,325.5,465,1053,1053,934,691,203],[104,130.3,209,325.5,465,1053,1053,961,733,506,278,203],[104,130.3,209,325.5,465,1053,1053,1038,909,460,286,207],[104,130.3,209,325.5,465,1053,1053,926,314,203],[104,130.3,209,325.5,465,1053,1053,956,930.6,854.5,741.6,606,471,358,281.5,256],[104,130.4,209.5,326.1,465,1433,1648.5,1833,1855,1855,1823.6,1729.5,1581.1,1387,564,360,202],[105,145,353,456,551,788.5,857.1,1011,1011,841.5,653,430.1,255.5,142.6],[106,145,262,448.5,696,904,1098,1120,1120,1089.4,997.5,580,337,143.4],[106,145,262,448.5,696,904,1098,1120,1120,1089.4,960,717,255.5,143.4],[106,145,262,448.5,696,904,1098,1120,1120,1089.4,986,758,531,303,143.4],[106,145,262,448.5,696,904,1098,1120,1120,1089.4,951,339,143.4],[-21,187,375,401,222],[160,187,375,582,339],[-11,187,375,572,394,167],[5,187,375,557,557,5],[106,140.6,244.5,405.6,612,828.3,995,1101.5,1137,1004,938,263],[185,1119,1119,1075,946,497,323,244,185],[106,140.9,245.5,409.4,622,833.3,997,1102,1137,1102,997,553,310,140.9],[106,140.9,245.5,409.4,622,833.3,997,1102,1137,1102,933,690,245.5,140.9],[106,140.9,245.5,409.4,622,833.3,997,1102,1137,1102,963,735,508,280,140.9],[106,140.9,245.5,409.4,622,833.3,997,1102,1137,1038,909,460,286,207],[106,140.9,245.5,409.4,622,833.3,997,1102,1137,1102,928,729,316,140.9],[210,719,957,1466,1466,957,719,210],[93,203,833.3,997,1102,1137,1132,1021,409.4,245.5,140.9,106],[177,201.5,275,392.5,549,1111,1111,585,342,177],[177,201.5,275,392.5,549,1111,1111,945,702,177],[177,201.5,275,392.5,549,1111,1111,757,530,177],[177,201.5,275,392.5,549,1111,1111,955,343,177],[61,298,499,1151,928,685],[185,373,1019,1129,1168,1139.9,1055.5,920.6,373,185],[230,376,658,585,346],[530,579,724,773],[256,588,716,1048,1048,765,539,256],[7,26,1374,832],[346,585,585,346],[0,49,443,1424,1424,443],[0,49,443,1582,1582,443],[0,49,380,968,968,380],[0,49,354.5,493,711.5,997,1283.5,1501,1639.5,1689,1640.5,1501,1284.5,997],[0,49,815,1013,1537,289],[0,49,291,1751,1751,1701,1654.1,1513.5,1296.6,1021],[-53,187,375,615,615,379,183,-53],[26,1374,832,568],[200,728,983.5,1168,1281,1323,1196,1159,1040,885,641,200],[200,398,1162,1162,200],[26,1414,852,588],[200,1181,1181,200],[126,1288,1288,1266,160,126],[200,1339,1339,200],[115,163.5,302,520.5,806,1092.5,1310,1448.5,1498,1449.5,1310,1093.5,806,521.5,303,163],[137,725,725,137],[205,1397,1366,205],[26,1378,822,582],[200,1526,1526,200],[200,1336,1336,200],[114,1215,1215,114],[115,163.5,302,520.5,806,1092.5,1310,1448.5,1498,1449.5,1310,1093.5,806,521.5,303,163],[200,1339,1339,200],[200,398,1043,1139.5,1174,1127.5,996,831,604,200],[118,1280,1280,1234,138,118],[0,532,730,1262,1262,0],[6,532,730,1254,225],[105,149.5,273,740,937,1404,1527.5,1572,1528.5,1410,937,740,267,148],[68,1335,1336,80],[179,219.5,338,793,990,1446,1563.5,1604,1604,179],[108,1568,1568,1518,1471.1,1330.5,1113.6,838,562.4,345.5,204.9,158,108],[126,137,725,738,738,126],[6,532,730,1254,939,740,327],[108,137.4,225.5,363.6,543,1091,1091,743,500,148.5],[109,152.5,265,417,578,796,1006,1006,961,721,478,191.5,144],[185,931,1119,1119,1095.3,802,559,185],[160,187,375,403],[177,207.8,300,448,646,846,994,1085.5,1116,1116,1043,760,534,251,177],[108,137.4,225.5,363.6,543,1091,1091,604,416.5,258,148.5],[185,373,1030.5,1131.4,1165,1084,1050,959,825.5,661,462.1,311.5,216.6,185],[61,506,694,1151,265],[106,140.6,244.5,408.6,624,837.1,1000.5,1104.4,1139,1049,239],[109,152.5,265,417,578,796,1006,1006,961,789,609,449,304,191.5,144],[108,135.8,219,646,825,937,982,942,198],[185,931,1119,1119,1095.3,1024,907.5,748,185],[137,159.5,219,382,639,896,1059,1118,1141,1118,1058,895.5,639,382.5,220,159.5],[187,375,375,187],[193,1192,1122,1085,1027,193],[61,1151,522,311],[185,373,1125,1125,185],[61,510,699,1151,265],[104,138.5,239,704,884,995.5,1041,957,133],[106,140.9,245.5,409.4,622,833.3,997,1102,1137,1102,997,833.3,622,409.4,245.5,140.9],[185,1120,1120,185],[185,373,1033.5,1137.4,1172,1140,1044,887.3,673,477.5,322,220.5,185],[105,146.5,261,685,862,971,1018,986,839,675,441.9,260.5,143.9],[106,140.5,244,407.8,623,832.9,996.5,1101.9,1295,1295,625,412,247,141.3],[10,414,602,1006,1006,10],[177,207.8,300,448,646,846,994,1085.5,1116,1116,177],[104,151,283,715,902,1342.5,1471.1,1514,1470.4,1339.5,1132.6,861,784.5,714,355,163],[48,1160,1149,59],[176,223.5,748,935,1459,1507,1507,176],[113,136.5,211,343.5,538,1128,1321.5,1455,1529.5,1553,1496,1295,371,170],[5,187,375,557,557,5],[177,207.8,300,448,646,846,994,1085.5,1116,1116,953,341,177],[106,140.9,245.5,409.4,622,833.3,997,1102,1137,1102,743,500,140.9],[177,207.8,300,448,646,846,994,1085.5,1116,1116,768,525,177],[113,136.5,211,343.5,538,1128,1321.5,1455,1529.5,1553,1496,955,712,170],[149,179.4,270.5,409.6,584,798.5,985,1106,1145,1130.5,1074,909.5,670,473.5,292],[50,1438,876,612],[144,344,1332,1532,1532,144],[187,1369,1369,1330,197,187],[220,1456,1456,220],[-102,63,843,678],[253,492,492,253],[134,755,857,1737,1570,134],[161,189.3,274,406.5,578,1435,1620.9,1764.5,1856.4,1887,1858.8,1774,1641.5,1470,613,430.3,286,192.3],[138,241.5,348,515.3,641,719,1168,1168,1063,954,786.3,661,583,138],[243,400,1070,1214,1320,1432,1431,1274,604,462.4,355.5,243],[245,566,719,1431,1431,1109,956,245],[254,1408,1408,254],[268,1422,1422,268]],this.OUTLINE_Y=[[],[1489,0,0,1489],[1556,977,977,1556,1556],[421,0,0,421,932,1067,1489,1489,1067,556],[85,-361,-361,238.1,380,1231,1576,1576,1185,1071.5,935,283],[1075,880.5,743,0,-29,-1.8,80,217.8,413,607.5,745,1489,1517,1489.8,1408,1270.3],[409,230.9,90.5,-.6,-31,0,909,1333.4,1432.5,1498.1,1520,1490,1412,1301.5,1174],[1556,977,977,1556],[572,286.3,31,-412,-412,1556,1556,1113,857.8],[-412,-412,31,286.3,572,857.8,1113,1556,1556],[886,776,630,630,777,887,1299,1409,1556,1556,1410,1300],[572,27,27,572,732,1277,1277,732],[-370,-370,285,285],[561,561,742,742],[0,0,285,285],[-304,-304,1556,1556],[743,400,159,16.5,-31,15.9,156.5,397.4,745,1084.9,1326.5,1470.9,1519,1471.6,1329.5,1088.1],[0,0,152,1494,1494,1286],[0,0,171,1110,1279.4,1409.5,1492.4,1520,1491,1427,209],[63,-1.5,-31,2.5,106,254,441,1161,1320,1436,1500,1520,1490.5,1426,272],[419,0,0,419,579,1489,1489,649],[56,-5.5,-31,6.5,114,274,473,1489,1489,267],[654,324,104,3,-31,4.9,112.5,276.9,483,1494,1512,1517,1453.5,1277,1005],[1314,0,0,1266,1489,1489],[411,233.5,91,-2.8,-34,-2,94,238.3,415,1144,1294.5,1416,1496.3,1523,1495,1411,1285,1131],[1005,-6,-23.5,-29,33,209,480,834,1171.5,1385,1485.5,1519,1483.3,1376,1211.8],[0,0,1117,1117],[-370,-370,285,1117,1117],[590,77,1227,714],[362,362,942,942],[77,590,714,1227],[1245,0,0,964.5,1139,1293.4,1414.5,1492.9,1519,1497.5,1449],[647,291,15,-162.5,-226,-218.5,-190,157,394,663,1013.5,1283,1457,1519,1452,1268,991.5],[0,0,1489,1489],[0,0,28,122,262,458,1155,1316.5,1427,1477,1489,1489],[743,402.5,161,18.5,-27,-13.5,19,63,108,1385,1487,1516,1465,1317,1072],[0,0,28,119,375,743,1118,1371,1457.5,1489,1489],[0,0,1489,1489],[0,0,717,1313,1489,1489],[746,405.5,163,19,-29,12.5,110,749,1382,1485.5,1516,1464.4,1309.5,1065.4],[0,0,1489,1489],[0,0,1489,1489],[8,-12.5,-21,5.5,85,213.5,387,1489,1489,193],[0,0,1489,1489],[0,0,176,1489,1489],[0,0,1489,1489],[0,0,1489,1489],[744,415,172,21,-31,20,172,414.5,744,1073,1318,1467.5,1520,1468,1318,1070.5],[0,0,709,855.5,1039,1254,1396,1466.5,1489,1489],[744,415,172,21,-297.5,-369.1,-393,-386.5,-365,-183,744,1073,1318,1467.5,1520,1468,1318,1070.5],[0,0,1280.5,1409,1471.5,1489,1489],[92,3,-27,9,109,253,425,1412,1486,1516,1486.1,1396.5,1260.1,1090,340],[1313,0,0,1313,1489,1489],[598,313,115,6,-31,4,115,315.5,598,1489,1489],[1489,0,0,1489,1489],[1489,0,0,1489,1489],[0,0,1489,1489],[1489,0,0,1489,1489],[0,0,176,1489,1489,184],[-392,-392,1556,1556],[1556,-304,-304,1556],[-392,-392,1556,1556],[682,682,684,1489,1489],[-300,-300,-180,-180],[1676,1302,1302,1676],[324,182.8,69,-6,-31,0,758,939,1058,1124.5,1144,1126,1093],[0,-31,8.5,127,315,567,812.8,996,1110,1556,1556],[557,300,118,10.5,-25,0,70,1050,1116,1143,1104,987,801.5],[550,306.8,123,7.5,-31,0,1556,1556,992,803],[552,306.6,124.5,11.6,-26,1,68,539,641,856.3,1016,1115,1148,1107.8,987,797.8],[959,0,0,959,1374,1546,1560,1566,1539.4,1459.5,1117],[569,-375,-410.5,-423,-389.8,-290,-119.3,127,1117,1148,1108.5,998,817.5],[0,0,725,906,1039,1556,1556],[1304,0,0,1304,1499,1499],[-395,-415,-423,-398,-323,-199,-27,1304,1499,1499,1117,-216],[0,0,1117,1556,1556],[0,0,1556,1556],[0,0,725,902.9,1036.5,1120.1,1148,1148,1117],[0,0,725,906,1039,1120.8,1148,1117],[558,313.8,127,8.5,-31,8.5,127,313.8,558,802.4,989.5,1108.4,1148,1108.4,989.5,802.4],[-412,-412,133,323.5,572,813.4,995.5,1109.9,1148,1117],[555,314.1,131.5,16.4,-412,-412,1117,1148,1108,995,809.5],[0,0,912,1105,1114.5,1117,1117],[67,2.5,-27,-2.5,71,182.8,322,1060,1119.5,1144,1116.5,1042,933,803,278],[959,189.8,70,1,-22,-13,10,1117,1438,1438,1117],[392,209.1,76.5,-4.1,-31,0,1117,1117],[1117,0,0,1117,1117],[1117,0,0,1117,1117],[0,0,1117,1117],[1117,-412,-412,1117,1117],[0,0,159,1117,1117,139],[504,-170.9,-292.5,-367.1,-392,-392,1556,1556,1531.1,1456.5,1334.9,660],[-392,-392,1556,1556],[-392,-392,-367.1,-292.5,-170.9,504,660,1334.9,1456.5,1531.1,1556,1556],[395,395,396,440,561,732,927,927,926,880.5,761,589.5],[],[0,0,1489,1489],[557,333.5,163,-361,-361,74,1046,1475,1475,948.5,775.9],[0,0,171,1467,1501,1518,1485.9,1389.5,1243.1,751,207],[258,145,147,257,1067,1176,1176,1066],[1489,426,0,0,426,1489,1489],[-392,-392,1556,1556],[533,-327,-371.5,-385,-358,-275,-156,-10,601,1462,1505,1519,1490,1411,1293.5,1147],[1304,1304,1499,1499],[655,323.1,43.5,-146.6,-210,-146.6,43.5,323.1,655,986.9,1266.5,1456.6,1520,1456.6,1266.5,986.9],[833,616,531,554,1192,1332.4,1435.5,1498.9,1520,1504,1475],[608,162,191,1113,1142,697],[602,57,57,762,762],[561,561,742,742],[655,323.1,43.5,-146.6,-210,-146.6,43.5,323.1,655,986.9,1266.5,1456.6,1520,1456.6,1266.5,986.9],[1788,1668,1668,1788],[1116,960.4,831.5,744.9,716,745,832,961,1116,1271,1400,1487,1516,1487,1400,1271],[179,179,917,1462,1462,917],[566,566,711,1237,1350.4,1440.5,1519,1501.5,1458,722],[585,542,527,543.5,595,685.5,817,1278,1374.5,1452,1520,1502.5,1458,764],[1302,1302,1676,1676],[-412,-412,0,1117,1117],[1050,866,-363,-363,1489,1489,1460,1373,1234.3],[511,511,794,794],[-397,-416,-423,-337,-232,-89,-25,20,20,-237],[1256,566,566,688,1493,1493,1368],[1025,820.1,663.5,564.1,531,563.4,660.5,816.4,1025,1233.8,1390,1487.5,1520,1486.8,1387,1230],[191,162,608,697,1142,1113],[1246,0,0,220,353,944,1489,1493,1493,1363],[1246,0,0,139,664,865,1489,1493,1493,1363],[598,0,0,220,353,944,1489,1517,1500,1456,773],[350,195.6,74.5,-3.9,-30,-10,40,244,1489,1489,523],[0,0,1675,2049,2049],[0,0,2049,2049,1675],[0,0,1670,2049,2049,1670],[0,0,1992,1992,1987,1910,1682],[0,0,1872,1872,1872],[0,0,1712,1843.5,1952,2024.8,2049,2024.8,1952,1843.5,1712],[0,0,1489,1489],[743,402.5,-397,-416,-423,-337,108,1385,1487,1516,1465,1317,1072],[0,0,1489,2049,2049,1489],[0,0,1489,2049,2049,1489],[0,0,1489,2049,2049,1489],[0,0,1489,1872,1872,1489],[0,0,1489,2049,2049,1489],[0,0,2049,2049,1489],[1670,0,0,1670,2049,2049],[1677,0,0,1677,1872,1872],[740,0,0,28,119,375,743,1118,1371,1457.5,1489,1489,883],[0,0,1489,1992,1992,1987,1910,1489],[744,415,172,21,-31,20,172,414.5,744,1073,1318,2049,2049,1070.5],[744,415,172,21,-31,20,172,414.5,744,1073,2049,2049,1318,1070.5],[744,415,172,21,-31,20,172,414.5,744,1073,1670,2049,2049,1670,1070.5],[744,415,172,21,-31,20,172,414.5,744,1073,1992,1992,1987,1910,1070.5],[744,415,172,21,-31,20,172,414.5,744,1073,1872,1872,1872,1070.5],[216,105,105,216,1088,1199,1199,1088],[744,-146,-146,20,172,414.5,744,1611,1611,1520,1468,1318,1070.5],[598,313,115,6,-31,4,115,315.5,598,1489,2049,2049,1489],[598,313,115,6,-31,4,115,315.5,598,1489,2049,2049,1489],[598,313,115,6,-31,4,115,315.5,598,1489,2049,2049,1489],[598,313,115,6,-31,4,115,315.5,598,1489,1872,1872,1489],[1489,0,0,1489,2049,2049],[0,0,469,610.5,787,992,1130,1489,1489],[0,-24,12.4,121.5,284.1,481,1241,1376,1479,1544.3,1566,1536.5,1449,1295.5,1080],[324,182.8,69,-6,-31,0,758,939,1676,1676,1093],[324,182.8,69,-6,-31,0,758,1676,1676,1093],[324,182.8,69,-6,-31,0,758,1297,1676,1676,1297,1093],[324,182.8,69,-6,-31,0,758,1619,1619,1614,1537,1309],[324,182.8,69,-6,-31,0,758,1499,1499,1093],[324,182.8,69,-6,-31,0,758,1630,1761.8,1871,1944.5,1969,1944.5,1871,1761.8,1630],[317,178.8,68,-4.8,-29,-26,3.5,68,559,641,861.3,1020,1116,1148,1146,1127,1093],[557,300,-397,-416,-423,-337,-232,70,1050,1116,1143,1104,987,801.5],[552,306.6,124.5,11.6,-26,1,68,539,641,856.3,1016,1676,1676,797.8],[552,306.6,124.5,11.6,-26,1,68,539,641,856.3,1676,1676,987,797.8],[552,306.6,124.5,11.6,-26,1,68,539,641,856.3,1297,1676,1676,1297,797.8],[552,306.6,124.5,11.6,-26,1,68,539,641,856.3,1499,1499,797.8],[1676,0,0,1302,1676],[1302,0,0,1676,1676],[1297,0,0,1297,1676,1676],[1304,0,0,1304,1499,1499],[484,266.5,104,2.8,-31,12,141,351,637,1469,1566,1556],[0,0,725,1619,1619,1614,1537,1309,1117],[558,313.8,127,8.5,-31,8.5,127,313.8,558,802.4,989.5,1676,1676,802.4],[558,313.8,127,8.5,-31,8.5,127,313.8,558,802.4,1676,1676,989.5,802.4],[558,313.8,127,8.5,-31,8.5,127,313.8,558,802.4,1297,1676,1676,1297,802.4],[558,313.8,127,8.5,-31,8.5,127,313.8,558,1619,1619,1614,1537,1309],[558,313.8,127,8.5,-31,8.5,127,313.8,558,802.4,1499,1499,1499,802.4],[572,7,7,572,732,1297,1297,732],[-148,-148,8.5,127,313.8,558,1241,1241,1108.4,989.5,802.4,558],[392,209.1,76.5,-4.1,-31,0,1117,1676,1676,1117],[392,209.1,76.5,-4.1,-31,0,1117,1676,1676,1117],[392,209.1,76.5,-4.1,-31,0,1117,1676,1676,1117],[392,209.1,76.5,-4.1,-31,0,1117,1499,1499,1117],[1117,-412,-412,1117,1676,1676],[-412,-412,133,323.5,572,813.4,995.5,1109.9,1556,1556],[-370,-370,285,1117,1117],[1676,1292,1292,1676],[1304,1292,1292,1304,1499,1676,1676,1499],[1489,0,0,1489],[832,832,1117,1117],[1489,1105,0,0,1489,1489],[1489,1105,0,0,1489,1489],[1489,1105,0,0,1489,1489],[1489,1105,415,172,21,-31,20,172,414.5,744,1073,1318,1467.5,1520],[1489,1105,0,0,1489,1489],[1489,1105,0,0,174,894,1144.8,1345,1476.3,1520],[1304,0,0,1304,1499,1676,1676,1499],[0,0,1489,1489],[0,0,28,122,262,458,1155,1316.5,1427,1477,1489,1489],[0,0,1313,1489,1489],[0,0,1489,1489],[0,0,1489,1489],[0,0,176,1489,1489,184],[0,0,1489,1489],[744,415,172,21,-31,20,172,414.5,744,1073,1318,1467.5,1520,1468,1318,1070.5],[0,0,1489,1489],[0,0,1489,1489],[0,0,1489,1489],[0,0,1489,1489],[0,0,1489,1489],[0,0,1489,1489],[744,415,172,21,-31,20,172,414.5,744,1073,1318,1467.5,1520,1468,1318,1070.5],[0,0,1489,1489],[0,0,709,855.5,1039,1254,1396,1466.5,1489,1489],[0,0,176,1489,1489,184],[1313,0,0,1313,1489,1489],[1489,0,0,1489,1489],[755,507,325,-16,-16,325,506.5,755,994,1171,1505,1505,1171,993],[0,0,1489,1489],[910,647,471,0,0,471,645.5,910,1489,1489],[0,0,174,894,1144.8,1345,1476.3,1520,1476.3,1345,1144.8,894,174],[1677,0,0,1677,1872,1872],[1489,0,0,1489,1872,1872,1872],[550,306.8,123,7.5,-31,0,1117,1676,1676,803],[306,148.5,46,-10,-26,-5,64,270,1083,1676,1676,986.5,839],[0,-412,-412,725,906,1676,1676,1117],[1676,0,0,1676],[407,213.6,77.5,-3.1,-30,-2.6,79.5,216.1,407,1117,1499,1676,1676,1499,1117],[550,306.8,123,7.5,-31,0,1117,1148,1108,992,803],[-412,-412,110,259.5,444,1195,1355,1467,1534.5,1556,1524.3,1429,1277.8,1078],[1117,-412,-412,1117,1117],[534,299.6,120.5,6.9,-31,7.8,124,308.3,551,1556,1556],[306,148.5,46,-10,-26,-5,64,270,1083,1127.5,1144,1128,1079,986.5,839],[463,262.3,118,-412,-412,-264.5,-96,1556,1556],[0,-412,-412,725,906,1039,1120.8,1148,1117],[768,451.5,241,37.5,-31,37.5,241,451.5,768,1073,1288,1487,1556,1487,1288,1073.5],[0,0,1117,1117],[0,0,1117,1118,1119,1117],[0,0,1556,1556],[-412,-412,0,1117,1117],[1117,0,0,1117,1117],[412,248.5,113,-412,-412,-265,-96,1556,1556],[558,313.8,127,8.5,-31,8.5,127,313.8,558,802.4,989.5,1108.4,1148,1108.4,989.5,802.4],[0,0,1117,1117],[-412,-412,148.5,340.9,577,821.5,1001,1111.3,1148,1115,1020,861.5,646],[549,299,129,-412,-412,-268,-96,1079,1124.5,1143,1102.5,981,792],[558,313.8,127,8.5,-31,7.5,123,308.8,952,1117,1148,1108.6,990.5,803.6],[952,0,0,952,1117,1117],[407,213.6,77.5,-3.1,-30,-2.6,79.5,216.1,407,1117,1117],[546,314,142,-412,-412,159,342.3,576,816.6,996.5,1108.6,1146,1145.5,1143,1117,842],[-412,-412,1117,1117],[446,248.5,-412,-412,248,446,1117,1117],[503,310.5,139,16.5,-30,-30,14.5,139,310.5,503,811.5,1117,1117,811.5],[1304,0,0,1304,1499,1499],[407,213.6,77.5,-3.1,-30,-2.6,79.5,216.1,407,1117,1499,1499,1117],[558,313.8,127,8.5,-31,8.5,127,313.8,558,802.4,1676,1676,802.4],[407,213.6,77.5,-3.1,-30,-2.6,79.5,216.1,407,1117,1676,1676,1117],[503,310.5,139,16.5,-30,-30,14.5,139,310.5,503,811.5,1676,1676,811.5],[424,240.1,94.5,-.4,-32,17,190,493,837,1097,1286,1464.5,1519,1496.5,1430],[0,0,1489,1489],[1315,-193,-193,1315,1489,1489],[-189,-189,-13,1489,1489,2],[572,572,732,732],[0,0,1489,1489],[511,511,794,794],[842,-151,-151,1788,1788,981],[642,447.6,292.5,190.9,157,157,190.4,290.5,450.4,663,857.4,1012.5,1114.1,1148,1148,1114.5,1014,854],[-402,-417.5,-423,-395.5,-313,-179.8,1367,1545,1560.5,1566,1538.5,1456,1321.8,-224],[202,202,209,233.4,306.5,588,1104,1104,1097,1072.5,999,719],[362,27,27,362,942,1277,1277,942],[0,0,1393,910],[0,0,910,1393]],this.KERN_C1=["'","'","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-",".",".","A","A","A","A","A","A","A","A","A","A","A","A","B","B","B","B","C","D","D","D","D","D","D","D","F","F","F","F","F","F","F","F","F","F","F","F","F","I","J","J","J","J","K","K","K","K","K","K","K","K","K","K","K","K","L","L","L","L","L","L","L","L","L","L","L","L","L","L","O","O","O","O","O","O","P","P","P","P","P","P","P","P","P","P","Q","Q","R","R","R","R","R","R","R","R","R","R","S","S","S","S","S","S","S","S","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","T","U","U","U","U","V","V","V","V","V","V","V","V","V","V","V","V","V","V","W","W","W","W","W","W","W","W","W","W","W","W","W","W","W","X","X","X","X","X","X","X","X","X","X","X","X","X","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Z","Z","Z","Z","Z","Z","Z","Z","Z","Z","Z","Z","Z","Z","a","a","a","b","b","b","c","c","e","f","f","f","f","f","f","f","f","f","f","f","f","h","h","h","k","k","k","k","m","m","m","n","n","n","o","o","o","o","o","p","p","p","r","r","r","r","r","t","t","v","v","v","v","v","v","v","v","w","w","w","w","w","x","x","x","x","x","x","x","x","y","y","y","y","y","y","y","y","y","y","y","y","y","z","z","z","z","z","z","z","z","z","","","","","","","","","","","","",""],this.KERN_C2=["","A","","","z","y","x","w","v","a","Z","Y","X","W","V","T","S","J","I","A","-",",","y","w","v","u","t","Y","W","V","U","T","S","-","T",".","-",",","-","Z","Y","X","W","T",".",",","","","","o","e","a","T","A","?",";",":",".",",","-","","A",".",",","","","","y","w","v","u","o","e","a","O","-","","","y","v","Y","W","V","T","O","J","G","C","-","'","Z","Y","X","T",".",",","","","","o","e","a","Y","A",".",",",".",",","","","y","u","o","e","a","Y","T","-","","y","w","v","S","A",".",",","","","","","","z","y","w","v","u","s","r","o","g","e","c","a","T","S","O","G","C","A","?",";",":",".","-",",","","A",".",",","","","","y","u","o","e","a","A",";",":",".","-",",","","","","y","u","r","o","e","a","A",";",":",".","-",",","","","","","y","u","o","e","a","O","G","C","-","","","","","v","u","s","r","q","p","o","n","m","g","e","d","a","O","A",";",":",".","-",",","","","","","y","w","o","e","a","Z","O","G","C","-","y","w","v","y",".",",","T","-","T","}","y","]","\\","?",".","-",",","*",")","'",'"',"y","w","v","","o","e","-","y","w","v","y","w","v","y","x","v",".",",","y",".",",","","a",".","-",",","y","-","","","o","e","a",".","-",",","","a",".","-",",","","","o","g","e","d","c","-","","","","q","o","g","e","d","c","a",".","-",",","","","q","o","g","e","d","c","-","-","-","Z","Y","X","T",".",",","y","x","v",".",","],this.KERN_K=[100,100,20,50,40,40,50,20,40,20,30,140,80,50,50,150,20,100,30,50,160,130,50,30,50,10,20,80,50,60,10,120,10,50,60,20,-10,20,50,20,20,10,20,50,50,50,50,100,110,50,50,100,-30,100,-60,60,60,300,300,30,10,10,20,20,70,60,20,80,70,80,50,70,70,60,20,110,20,20,110,110,160,100,110,170,20,-100,20,20,160,120,20,20,10,50,30,30,50,50,70,50,50,50,-20,50,300,300,30,30,50,50,55,20,50,50,40,20,60,100,20,30,20,30,22,20,20,20,220,240,50,130,40,170,200,200,200,200,180,200,220,210,220,220,240,70,12,50,40,40,120,-60,200,200,290,150,290,20,10,20,20,100,100,70,65,60,100,100,100,60,80,80,290,50,290,100,100,60,65,60,60,100,100,100,50,80,80,220,50,290,60,50,10,10,80,30,60,60,50,10,10,10,80,130,140,20,80,100,110,110,100,130,100,130,100,100,130,130,120,140,20,80,200,200,290,140,290,60,50,20,20,65,40,60,60,50,10,20,20,20,60,16,10,16,5,20,30,60,20,140,-100,10,-100,-100,-110,120,50,130,-50,-100,-60,-60,20,10,20,20,20,20,100,20,10,20,20,10,20,15,20,15,20,30,5,20,30,40,36,290,20,290,10,40,18,40,18,18,40,180,40,180,20,20,70,20,70,24,20,24,10,24,10,20,50,18,40,18,10,18,10,18,10,18,40,190,40,190,12,10,10,12,10,12,10,10,20,50,20,20,20,10,50,30,30,15,20,15,20,30],this.pathCache=[],this.pathMissing=null,this.ctxReference=null;for(let t=this.GLYPH_DATA.length-1;t>=0;t--)this.pathCache[t]=null}getKerning(t,e){const i=this.KERN_K.length;for(let s=0;s<i;s++)if(this.KERN_C1[s]==t&&this.KERN_C2[s]==e)return-this.KERN_K[s];return 0}static measureText(t,e){return this.main.measureText(t,e)}measureText(t,e){let i=Xe.main,s=e/i.UNITS_PER_EM,n=0;for(let e=0;e<t.length;e++){let s=t.charAt(e),o=this.getIndex(s);o<0?n+=i.MISSING_HORZ:(n+=i.HORIZ_ADV_X[o],e<t.length-1&&(n+=i.getKerning(s,t.charAt(e+1))))}return[n*s,i.ASCENT*s*i.ASCENT_FUDGE,-i.DESCENT*s]}static measureWidths(t,e){return this.main.measureWidths(t,e)}measureWidths(t,e){let i=Xe.main,s=e/i.UNITS_PER_EM,n=[0],o=0;for(let e=0;e<t.length;e++){let l=t.charAt(e),r=this.getIndex(l);r<0?(o+=i.MISSING_HORZ,n.push(o*s)):(o+=i.HORIZ_ADV_X[r],e<t.length-1&&(o+=i.getKerning(l,t.charAt(e+1))),n.push(o*s))}return n}getIndex(t){return this.UNICODE.indexOf(t)}getRawGlyph(t){return this.GLYPH_DATA[t]}getGlyphPath(t){let e=this.pathCache[t];return null!=e||(e=new Path2D(this.GLYPH_DATA[t]),this.pathCache[t]=e),e}getMissingPath(){return this.pathMissing||(this.pathMissing=new Path2D(this.MISSING_DATA)),this.pathMissing}getOutlineX(t){return this.OUTLINE_X[t].slice(0)}getOutlineY(t){return this.OUTLINE_Y[t].slice(0)}initNativeFont(t){if(null!=t||!this.ctxReference)if(null==t){let t=new OffscreenCanvas(256,256);this.ctxReference=t.getContext("2d")}else this.ctxReference=t}static measureTextNative(t,e,i,s={}){return this.main.measureTextNative(t,e,i,s)}measureTextNative(t,e,i,s={}){if(!this.ctxReference)throw"Calling measureTextNative without having called initNativeFont first";this.ctxReference.save();let n="";s.bold&&(n+="bold "),s.italic&&(n+="italic "),this.ctxReference.font=n+i+"px "+e;let o=this.ctxReference.measureText(t);this.ctxReference.restore();const l=this.ASCENT_FUDGE*this.ASCENT/this.UNITS_PER_EM;return[o.width,i*l,i*(-this.DESCENT/this.ASCENT)*l]}}Xe.main=new Xe;class Ue{constructor(t,e,i){this.offsetX=t,this.offsetY=e,this.pointScale=i,this.invScale=1/i}scale(){return this.pointScale}angToX(t){return t*this.pointScale+this.offsetX}angToY(t){return t*-this.pointScale+this.offsetY}xToAng(t){return(t-this.offsetX)*this.invScale}yToAng(t){return(t-this.offsetY)*-this.invScale}yIsUp(){return!1}measureText(t,e){return Xe.main.measureText(t,e)}}class je{constructor(t,e,i){this.px=t,this.py=e,this.margin=i,this.theta=0,this.stop=!1,this.hashKey=JSON.stringify([this.px,this.py])}calculate(){this.lookupCache()||(this.setupParameters(),this.stop||(this.currentScore=this.calculateScore(this.cx,this.cy,this.rw,this.rh),this.coarseDiscovery(),this.fineImprovement(),this.theta=-this.theta,this.saveCache()))}getSpline(){return G.createBezierEllipse(this.cx,this.cy,this.rw,this.rh,this.theta)}lookupCache(){let t=this.hashKey,e=je.cacheMap.get(t);if(e){this.cx=e.cx,this.cy=e.cy,this.rw=e.rw,this.rh=e.rh,this.theta=e.theta;const{cacheVal:i}=je;for(let e=i.length-1;e>=0;e--)if(i[e].hashKey==t){e<i.length-1&&(i.push(i[e]),i.splice(e,1));break}return!0}return!1}saveCache(){let t=this.hashKey;const{cacheVal:e,cacheMap:i}=je;for(e.push(this),i.set(t,this);e.length>1e3;)i.delete(e[0].hashKey),e.splice(0)}setupParameters(){const e=this.psz=this.px.length,i=this.invpsz=1/e;this.cx=t.sum(this.px)*i,this.cy=t.sum(this.py)*i;let s=new Array(e),n=new Array(e);for(let t=0;t<e;t++)s[t]=Math.atan2(this.py[t]-this.cy,this.px[t]-this.cx),n[t]=b(this.px[t]-this.cx,this.py[t]-this.cy);let o=t.idxSort(s);this.px=t.idxGet(this.px,o),this.py=t.idxGet(this.py,o),s=t.idxGet(s,o),n=t.idxGet(n,o);let l=new Array(e),r=new Array(e);const a=(s,n,o)=>{for(let t=0;t<e;t++)l[t]=n[t]*Math.cos(s[t]+o),r[t]=n[t]*Math.sin(s[t]+o);let a=t.sum(l)*i,h=t.sum(r)*i,u=0,m=0;for(let t=0;t<e;t++)u+=v(l[t]-a),m+=Math.abs(r[t]-h);return m/(1+u)};let h=Number.POSITIVE_INFINITY;for(let t=0;t<360;t++){let e=t*S,i=a(s,n,e);i<h&&(this.theta=e,h=i)}for(let t=-1;t<=1;t+=.05){let e=this.theta+t*S,i=a(s,n,e);i<h&&(this.theta=e,h=i)}for(let t=0;t<e;t++)this.px[t]=this.cx+n[t]*Math.cos(s[t]+this.theta),this.py[t]=this.cy+n[t]*Math.sin(s[t]+this.theta);this.cx=t.sum(this.px)*i,this.cy=t.sum(this.py)*i,this.rw=this.rh=1}coarseDiscovery(){const{margin:t}=this;let e=.1*t,i=.5*e;const s=[{dx:-1,dy:0,dw:0,dh:0},{dx:1,dy:0,dw:0,dh:0},{dx:0,dy:-1,dw:0,dh:0},{dx:0,dy:1,dw:0,dh:0},{dx:0,dy:0,dw:-1,dh:0},{dx:0,dy:0,dw:1,dh:0},{dx:0,dy:0,dw:0,dh:-1},{dx:0,dy:0,dw:0,dh:1}];for(let t=0;t<1e3;t++){let t=!1,n=this.currentScore,o=this.cx,l=this.cy,r=this.rw,a=this.rh;for(let h of s){let s=this.cx+h.dx*e,u=this.cy+h.dy*e,m=this.rw+h.dw*i,d=this.rh+h.dh*i,c=this.calculateScore(s,u,m,d);c>n&&!T(c,n)&&(t=!0,n=c,o=s,l=u,r=m,a=d)}if(!t)break;this.currentScore=n,this.cx=o,this.cy=l,this.rw=r,this.rh=a}}fineImprovement(){const{margin:t}=this;let e=.1*t,i=.5*e;const s=2/3;for(let t=0;t<20;t++){let n=!1,o=this.currentScore,l=this.cx,r=this.cy,a=this.rw,h=this.rh;for(let t=-1;t<=1;t++){let s=this.cx+t*e;for(let u=-1;u<=1;u++){let m=this.cy+u*e;for(let e=-1;e<=1;e++){let d=this.rw+e*i;for(let c=-1;c<=1;c++){let p=this.rh+c*i;if(0==t&&0==u&&0==e&&0==c)continue;let f=this.calculateScore(s,m,d,p);f>o&&!T(f,o)&&(n=!0,o=f,l=s,r=m,a=d,h=p)}}}}n?(this.currentScore=o,this.cx=l,this.cy=r,this.rw=a,this.rh=h):(t++,e*=s,i*=s)}}calculateScore(e,i,s,n){const{px:o,py:l,margin:r}=this,a=o.length;let h=E/24,u=t.numberArray(Number.POSITIVE_INFINITY,a);for(let t=0;t<24;t++){let m=t*h,d=Math.cos(m),c=Math.sin(m),p=s*d*1-n*c*0,f=s*d*0+n*c*1,g=b(p,f)+r,x=Math.atan2(f,p),A=e+g*Math.cos(x),v=i+g*Math.sin(x);for(let t=0;t<a;t++){let s=t==a-1?0:t+1;if(G.doLineSegsIntersect(e,i,A,v,o[t],l[t],o[s],l[s]))return 0}for(let t=0;t<a;t++)u[t]=Math.min(u[t],y(A-o[t],v-l[t]))}let m=0;for(let t of u)m+=1/(1+Math.sqrt(t));return s*n+m}}je.cacheVal=[],je.cacheMap=new Map,function(t){t[t.Normal=1]="Normal",t[t.Inclined=2]="Inclined",t[t.Declined=3]="Declined",t[t.Unknown=4]="Unknown",t[t.Dotted=5]="Dotted",t[t.DotDir=6]="DotDir",t[t.IncDouble=7]="IncDouble",t[t.IncTriple=8]="IncTriple",t[t.IncQuadruple=9]="IncQuadruple"}(Pe||(Pe={}));class He{static guestimateSize(t,e,i,s){let n=t.boundary(),o=n.minX(),l=n.minY(),r=n.maxX(),a=n.maxY(),h=e.data.fontSize*this.FONT_CORRECT;for(let e=1;e<=t.numAtoms;e++)if(t.atomExplicit(e)){let i=0;for(let s of t.atomElement(e))"|{}^".includes(s)||i++;let s=t.atomHydrogens(e)>0?1:0;const n=.35*h*(i+s),u=.75*h*(1+.2*s),m=t.atomX(e),d=t.atomY(e);o=Math.min(o,m-n),r=Math.max(r,m+n),l=Math.min(l,d-u),a=Math.max(a,d+u)}let u=Math.max(1,r-o)*e.data.pointScale,m=Math.max(1,a-l)*e.data.pointScale;return i>0&&u>i&&(m*=i/u,u=i),s>0&&m>s&&(u*=s/m,m=s),[u,m]}constructor(t,e,i,s=new Ye){this.mol=t,this.measure=e,this.policy=i,this.effects=s,this.points=[],this.lines=[],this.rings=[],this.paths=[],this.space=[],this.wantArtifacts=!0,this.artifacts=null,this.bondOrder=[],this.atomCharge=[],this.atomUnpaired=[],this.artifactCharge=new Map,this.artifactUnpaired=new Map,this.artifactFract=new Map}getMolecule(){return this.mol}getMeasure(){return this.measure}getPolicy(){return this.policy}getEffects(){return this.effects}getScale(){return this.scale}setWantArtifacts(t){this.wantArtifacts=t}getArtifacts(){return this.artifacts}setArtifacts(t){this.artifacts=t}arrange(){const{mol:e,measure:i,policy:s,effects:n}=this;this.scale=i.scale(),this.bondSepPix=s.data.bondSep*i.scale(),this.lineSizePix=s.data.lineSize*i.scale(),this.fontSizePix=s.data.fontSize*i.scale()*He.FONT_CORRECT,this.ymul=i.yIsUp()?-1:1;let o=null;if(this.wantArtifacts&&null==this.artifacts){this.artifacts=new Mt(e),o=t.booleanArray(!1,e.numAtoms);for(let t of this.artifacts.getResPaths())for(let e of t.atoms)o[e-1]=!0;for(let t of this.artifacts.getResRings())for(let e of t.atoms)o[e-1]=!0;for(let t of this.artifacts.getArenes()){o[t.centre-1]=!0;for(let e of t.atoms)o[e-1]=!0}}this.setupBondOrders();for(let t=1;t<=e.numAtoms;t++){if(e.atomElement(t).length>2&&0==e.atomHydrogens(t)){this.points.push(null),this.space.push(null);continue}let i={anum:t,text:e.atomExplicit(t)||Wt.atomIsWeirdLinear(e,t)?e.atomElement(t):null,fsz:this.fontSizePix,col:this.policy.data.atomCols[e.atomicNumber(t)],oval:new J(this.measure.angToX(e.atomX(t)),this.measure.angToY(e.atomY(t)),0,0)},s=this.effects.colAtom[t];if(s&&(i.col=s),o&&o[t-1]&&"C"==e.atomElement(t)&&(i.text=null),null!=i.text){let t=this.measure.measureText(i.text,i.fsz);const e=1.1;i.oval.rw=.5*t[0]*e,i.oval.rh=.5*t[1]*e}this.points.push(i),this.space.push(this.computeSpacePoint(i))}for(let t=1;t<=e.numAtoms;t++)null==this.points[t-1]&&this.processLabel(t);let l=t.booleanArray(!1,e.numBonds);for(let s=1;s<=e.numBonds;s++){let n=e.bondFrom(s),o=e.bondTo(s),r=e.bondType(s),a=this.bondOrder[s-1];if(a<0)continue;let h=this.effects.colBond[s];h||(h=this.policy.data.foreground),l[s-1]=2==a&&(r==Vt.BONDTYPE_NORMAL||r==Vt.BONDTYPE_UNKNOWN);let u=this.points[n-1],m=this.points[o-1],d=u.oval.cx,c=u.oval.cy,p=m.oval.cx,f=m.oval.cy;if(Math.abs(p-d)<=1&&Math.abs(f-c)<=1){l[s-1]=!1;continue}if(l[s-1])continue;let g=(1==a&&r==Vt.BONDTYPE_NORMAL?.25:.5)*i.scale(),y=this.shrinkBond(d,c,p,f,this.backOffAtom(n,d,c,p,f,g)),x=this.shrinkBond(p,f,d,c,this.backOffAtom(o,p,f,d,c,g));this.ensureMinimumBondLength(y,x,d,c,p,f,g);let A=this.lineSizePix,v=0,M=It.queryBondOrders(e,s);if(t.notBlank(M)){t.sort(M),-1==M[0]&&(M.splice(0,1),M.push(-1));let e=t.equals(M,[0,1,2,3,-1])?"?":M.map((t=>-1==t?"A":t.toString())).join(""),i=this.orthogonalDelta(y[0],y[1],x[0],x[1],1.3*this.bondSepPix),l=-.5;for(let t=0;t<2;t++,l++){let t=y[0]+l*i[0],e=y[1]+l*i[1],r=x[0]+l*i[0],a=x[1]+l*i[1],u={bnum:s,bfr:n,bto:o,type:Pe.Dotted,line:new tt(t,e,r,a),size:.5*A,head:v,col:16777215&h|2147483648};this.lines.push(u),this.space.push(this.computeSpaceLine(u))}let r=Math.atan2(x[1]-y[1],x[0]-y[0])*k;(r<-90||r>90)&&(r+=180);let a={anum:0,text:e,fsz:.35*this.fontSizePix,col:h,oval:new J(.5*(y[0]+x[0]),.5*(y[1]+x[1]),0,0),rotation:r};this.points.push(a),this.space.push(this.computeSpacePoint(a));continue}let T=Pe.Normal;if(1==a&&r==Vt.BONDTYPE_INCLINED?(T=Pe.Inclined,v=.15*i.scale()):1==a&&r==Vt.BONDTYPE_DECLINED?(T=Pe.Declined,v=.15*i.scale()):r==Vt.BONDTYPE_UNKNOWN?(T=Pe.Unknown,v=.2*i.scale()):0==a?T=r==Vt.BONDTYPE_INCLINED||r==Vt.BONDTYPE_DECLINED?Pe.DotDir:Pe.Dotted:2!=a&&3!=a&&4!=a||r!=Vt.BONDTYPE_INCLINED&&r!=Vt.BONDTYPE_DECLINED||(T=2==a?Pe.IncDouble:3==a?Pe.IncTriple:Pe.IncQuadruple,v=(2==a?.2:.25)*i.scale()),0==a){let t=x[0]-y[0],i=x[1]-y[1],s=1/b(t,i),l=.5*t*s*this.bondSepPix,r=.5*i*s*this.bondSepPix;e.atomAdjCount(n)>1&&(y[0]+=l,y[1]+=r),e.atomAdjCount(o)>1&&(x[0]-=l,x[1]-=r)}if(1!=a&&r==Vt.BONDTYPE_DECLINED&&([y,x]=[x,y]),a>1&&(r==Vt.BONDTYPE_NORMAL||r==Vt.BONDTYPE_UNKNOWN)){let t=this.orthogonalDelta(y[0],y[1],x[0],x[1],this.bondSepPix),e=1,i=1;for(let i=0,s=-.5*(a-1);i<a;i++,s++){let i=y[0]+s*t[0],o=y[1]+s*t[1],l=x[0]+s*t[0],r=x[1]+s*t[1];e=Math.min(e,this.backOffAtom(n,i,o,l,r,g))}y=this.shrinkBond(y[0],y[1],x[0],x[1],e);for(let e=0,s=-.5*(a-1);e<a;e++,s++){let e=y[0]+s*t[0],n=y[1]+s*t[1],l=x[0]+s*t[0],r=x[1]+s*t[1];i=Math.min(i,this.backOffAtom(o,l,r,e,n,g))}x=this.shrinkBond(x[0],x[1],y[0],y[1],i);for(let e=0,i=-.5*(a-1);e<a;e++,i++){let e=y[0]+i*t[0],l=y[1]+i*t[1],r=x[0]+i*t[0],a=x[1]+i*t[1],u={bnum:s,bfr:n,bto:o,type:T,line:new tt(e,l,r,a),size:A,head:v,col:h};this.lines.push(u),this.space.push(this.computeSpaceLine(u))}}else{let t={bnum:s,bfr:n,bto:o,type:T,line:new tt(y[0],y[1],x[0],x[1]),size:A,head:v,col:h};this.lines.push(t),this.space.push(this.computeSpaceLine(t))}}let r=this.orderedRingList();for(let t=0;t<r.length;t++)for(let i=0;i<r[t].length;i++){let s=e.findBond(r[t][i],r[t][i<r[t].length-1?i+1:0]);l[s-1]&&(this.processDoubleBond(s,r[t]),l[s-1]=!1)}for(let t=1;t<=e.numBonds;t++)l[t-1]&&this.processDoubleBond(t,this.priorityDoubleSubstit(t));let a=t.numberArray(0,e.numAtoms);for(let t=1;t<=e.numAtoms;t++)a[t-1]=null==this.points[t-1].text?0:e.atomHydrogens(t);for(let t=0;t<e.numAtoms;t++)a[t]>0&&this.placeHydrogen(t,a[t],!0)&&(a[t]=0);for(let t=0;t<e.numAtoms;t++)a[t]>0&&this.placeHydrogen(t,a[t],!1);for(let t=1;t<=e.numAtoms;t++)if(e.atomIsotope(t)!=Vt.ISOTOPE_NATURAL){let i=e.atomIsotope(t).toString(),n=s.data.atomCols[e.atomicNumber(t)];this.placeAdjunct(t,i,.6*this.fontSizePix,n,150*S)}for(let t=1;t<=e.numAtoms;t++){let i="",n=this.atomCharge[t-1];-1==n?i="-":1==n?i="+":n<-1?i=Math.abs(n)+"-":n>1&&(i=n+"+");for(let e=this.atomUnpaired[t-1];e>0;e--)i+=".";if(0==i.length)continue;let o=s.data.atomCols[e.atomicNumber(t)];this.placeAdjunct(t,i,1==i.length?.8*this.fontSizePix:.6*this.fontSizePix,o,30*S)}for(let t=0;t<n.atomDecoText.length;t++){let e=n.atomDecoText[t];e&&this.annotateAtom(t+1,e,n.atomDecoCol[t],n.atomDecoSize[t]*this.scale*He.FONT_CORRECT)}for(let t=0;t<n.bondDecoText.length;t++){let e=n.bondDecoText[t];e&&this.annotateBond(t+1,e,n.bondDecoCol[t],n.bondDecoSize[t]*this.scale*He.FONT_CORRECT)}for(let t=0;t<Math.min(n.atomCircleSz.length,e.numAtoms);t++)if(n.atomCircleSz[t]>0){let e=n.atomCircleSz[t]*this.scale,i=this.points[t],s=new Z(i.oval.cx-e,i.oval.cy-e,2*e,2*e),o={anum:0,bnum:0,box:s,px:[s.minX(),s.maxX(),s.maxX(),s.minX()],py:[s.minY(),s.minY(),s.maxY(),s.maxY()]};this.space.push(o)}if(null!=this.artifacts){for(let t of this.artifacts.getResPaths())this.createCurvedPath(t.atoms,this.artifactFract.get(t),0),this.delocalisedAnnotation(t.atoms,this.artifactCharge.get(t),this.artifactUnpaired.get(t));for(let t of this.artifacts.getResRings())this.createCircularRing(t.atoms),this.delocalisedAnnotation(t.atoms,this.artifactCharge.get(t),this.artifactUnpaired.get(t));for(let t of this.artifacts.getArenes()){let i=t.atoms.length>2;if(i)for(let s=0;s<t.atoms.length;s++){let n=s<t.atoms.length-1?s+1:0;if(0==e.findBond(t.atoms[s],t.atoms[n])){i=!1;break}}let s=2==t.atoms.length;this.createBondCentroid(t.centre,t.atoms),s||(i?this.createCircularRing(t.atoms):this.createCurvedPath(t.atoms,!1,t.centre)),this.delocalisedAnnotation(t.atoms,this.artifactCharge.get(t),this.artifactUnpaired.get(t))}}let h=new Ot(e);for(let t of h.getIDList())this.processPolymerUnit(h.getUnit(t),h.getUnits())}numPoints(){return this.points.length}getPoint(t){return this.points[t]}getPoints(){return this.points}numLines(){return this.lines.length}getLine(t){return this.lines[t]}getLines(){return this.lines}numRings(){return this.rings.length}getRing(t){return this.rings[t]}getRings(){return this.rings}numPaths(){return this.paths.length}getPath(t){return this.paths[t]}getPaths(){return this.paths}numSpace(){return this.space.length}getSpace(t){return this.space[t]}getSpaces(){return this.space}offsetEverything(e,i){for(let t of this.points)t.oval.offsetBy(e,i);for(let t of this.lines)t.line.offsetBy(e,i);for(let t of this.rings)t.cx+=e,t.cy+=i;for(let s of this.paths)t.addTo(s.px,e),t.addTo(s.py,i);for(let s of this.space)s.box.offsetBy(e,i),t.addTo(s.px,e),t.addTo(s.py,i)}offsetOrigin(){let t=this.determineBoundary();0==t[0]&&0==t[1]||this.offsetEverything(-t[0],-t[1])}scaleEverything(e){if(1!=e){this.scale*=e;for(let t of this.points)t.oval.scaleBy(e),t.fsz*=e;for(let t of this.lines)t.line.scaleBy(e),t.size*=e,t.head*=e;for(let t of this.rings)t.cx*=e,t.cy*=e,t.rw*=e,t.rh*=e,t.size*=e;for(let i of this.paths)t.mulBy(i.px,e),t.mulBy(i.py,e),i.size*=e;for(let i of this.space)i.box.scaleBy(e),t.mulBy(i.px,e),t.mulBy(i.py,e)}}determineBoundary(e){if(null==e&&(e=0),0==this.space.length)return[0,0,2*e,2*e];let i=t.numberArray(0,4),s=this.space[0];i[0]=s.box.x,i[1]=s.box.y,i[2]=s.box.x+s.box.w,i[3]=s.box.y+s.box.h;for(let t=this.space.length-1;t>0;t--)s=this.space[t],i[0]=Math.min(i[0],s.box.x),i[1]=Math.min(i[1],s.box.y),i[2]=Math.max(i[2],s.box.x+s.box.w),i[3]=Math.max(i[3],s.box.y+s.box.h);return i}determineBoundaryBox(){let[t,e,i,s]=this.determineBoundary();return new Z(t,e,i-t,s-e)}squeezeInto(e,i,s,n,o){null!=o&&o>0&&(e+=o,i+=o,s-=2*o,n-=2*o);let l=this.determineBoundary(0),r=l[2]-l[0],a=l[3]-l[1];if(r>s||a>n){let e=1;r>s&&(e=s/r),a>n&&(e=Math.min(e,n/a)),this.scaleEverything(e),t.mulBy(l,e)}this.offsetEverything(e-l[0]+.5*(s-l[2]+l[0]),i-l[1]+.5*(n-l[3]+l[1]))}limitBounds(t,e){let i=this.determineBoundary(0);if(i[0]==i[2]&&i[1]==i[3])return;let s=Math.min(1,Math.min(t/(i[2]-i[0]),e/(i[3]-i[1])));this.offsetEverything(-i[0],-i[1]),this.scaleEverything(s)}monochromate(t){for(let e of this.points)e.col=t;for(let e of this.lines)e.col=t}spatialCongestion(t,e,i){null==i&&(i=.001);let s=0;for(let n=0;n<this.points.length;n++){let o=this.points[n];if(null==o)continue;let l=o.oval.cx-t,r=o.oval.cy-e;s+=1/(l*l+r*r+i)}return s}clone(){let t=new He(this.mol,this.measure,this.policy,this.effects);t.scale=this.scale,t.bondSepPix=this.bondSepPix,t.lineSizePix=this.lineSizePix,t.fontSizePix=this.fontSizePix,t.ymul=this.ymul;for(let e of this.points)t.points.push(_(e));for(let e of this.lines)t.lines.push(_(e));for(let e of this.space)t.space.push(_(e));return t}setupBondOrders(){const t=this.mol;for(let e=0;e<t.numBonds;e++)this.bondOrder[e]=t.bondOrder(e+1);for(let e=0;e<t.numAtoms;e++)this.atomCharge[e]=t.atomCharge(e+1),this.atomUnpaired[e]=t.atomUnpaired(e+1);let e=(e,i)=>{let s=0,n=0;for(let t of i)s+=this.atomCharge[t-1],n+=this.atomUnpaired[t-1],this.atomCharge[t-1]=this.atomUnpaired[t-1]=0;this.artifactCharge.set(e,s),this.artifactUnpaired.set(e,n);for(let e of i)for(let s of t.atomAdjList(e))if(!i.includes(s)){let i=t.findBond(e,s);this.bondOrder[i-1]>=0&&(this.bondOrder[i-1]=1)}};if(null!=this.artifacts){for(let i of this.artifacts.getResPaths()){let s=0,n=0,o=0;for(let e=0;e<i.atoms.length;e++){s+=t.atomCharge(i.atoms[e]),n+=t.atomUnpaired(i.atoms[e]);let l=t.findBond(i.atoms[e],i.atoms[e<i.atoms.length-1?e+1:0]);l>0&&(o+=t.bondOrder(l))}let l=(2*o-s+n)/i.atoms.length<1;this.artifactFract.set(i,l);for(let e=0;e<i.atoms.length-1;e++){let s=t.findBond(i.atoms[e],i.atoms[e+1]);s>0&&(this.bondOrder[s-1]=l?-1:1)}e(i,i.atoms)}for(let i of this.artifacts.getResRings()){for(let e=0;e<i.atoms.length;e++){let s=t.findBond(i.atoms[e],i.atoms[e<i.atoms.length-1?e+1:0]);s>0&&(this.bondOrder[s-1]=1)}e(i,i.atoms)}for(let i of this.artifacts.getArenes()){let s=2==i.atoms.length;for(let e=0;e<i.atoms.length;e++){if(!s){let s=t.findBond(i.atoms[e],i.atoms[e<i.atoms.length-1?e+1:0]);s>0&&(this.bondOrder[s-1]=1)}let n=t.findBond(i.centre,i.atoms[e]);n>0&&(this.bondOrder[n-1]=-1)}e(i,i.atoms)}}}placeAdjunct(e,i,s,n,o){let l=this.measure.measureText(i,s),r=this.points[e-1],a=r.oval.cx,h=r.oval.cy,u=.55*l[0],m=.55*l[1];if(".."==i){let t=this.mol.atomAdjBonds(e).filter((t=>0==this.mol.bondOrder(t)));if(1==t.length){let i=this.getPoint(this.mol.bondOther(t[0],e)-1),o=i.oval.cx-a,l=i.oval.cy-h,r=1/b(o,l),d=.15*s,c=l*r*2.5*d,p=-o*r*2.5*d,f=1.2*(u+m)*r;return[o,l]=[o*f,l*f],this.points.push({anum:0,text:".",fsz:s,col:n,oval:new J(a+o+c,h+l+p,d,d)}),void this.points.push({anum:0,text:".",fsz:s,col:n,oval:new J(a+o-c,h+l-p,d,d)})}}let d=0,c=0,p=0,f=t.numberArray(0,4),g=t.numberArray(0,4),y=10,x=!1;for(let t=.5*(r.oval.rw+r.oval.rh);!x&&t<1.5*this.measure.scale();t+=.1*this.measure.scale()){const e=5*S;for(let i=0;!x&&i<Math.PI-1e-4;i+=e)for(let s=-1;s<=1;s+=2){let n=i*s+(s>0?e:0),l=o+n,r=t*Math.cos(l),b=t*Math.sin(l)*-this.ymul,A=a+r-u,v=a+r+u,M=h+b-m,T=h+b+m;f[0]=A,g[0]=M,f[1]=v,g[1]=M,f[2]=v,g[2]=T,f[3]=A,g[3]=T;let w=this.countPolyViolations(f,g,null,!1),E=10*w+Math.abs(n)+10*t,C=0==w&&Math.abs(n)<(y+1)*S;if((0==d||C||E<d)&&(d=E,c=r,p=b),C){x=!0;break}}y+=5}r={anum:0,text:i,fsz:s,col:n,oval:new J(a+c,h+p,u,m)},this.points.push(r);let A={anum:0,bnum:0,box:new Z(r.oval.cx-u,r.oval.cy-m,2*u,2*m),px:[r.oval.cx-u,r.oval.cx+u,r.oval.cx+u,r.oval.cx-u],py:[r.oval.cy-m,r.oval.cy-m,r.oval.cy+m,r.oval.cy+m]};this.space.push(A)}processLabel(e){let i=this.mol.atomX(e),s=this.mol.atomY(e),n=0,o=0,l=this.mol.atomAdjList(e);for(let t=0;t<l.length;t++){let e=Math.atan2(this.mol.atomY(l[t])-s,this.mol.atomX(l[t])-i)*k;e>=-15&&e<=15?o+=3:e>=-85&&e<=85?o++:e>85&&e<95||e<-85&&e>-95||(e>165||e<-165?n+=3:n++)}let r=this.mol.atomElement(e),a=r.indexOf("|"),h=r.indexOf("{"),u=0;0==n&&0==o&&a<0&&h<0||(u=n<o?-1:o<n?1:Wt.congestionPoint(this.mol,i-1,s)<.5*Wt.congestionPoint(this.mol,i+1,s)?-1:1);let m=null,d=null,c=null,p=0;if(a<0&&h<0)0==u?m=[r]:u<0?(m=[r.substring(0,r.length-1),r.substring(r.length-1)],p=1):m=[r.substring(0,1),r.substring(1)];else{let e=[],i=[],s=[],n=r.split("|");u<0&&(n=t.reverse(n));let o="";for(let t=0;t<n.length;t++){let l=u>=0&&0==t||u<0&&t==n.length-1;u<0&&0==p&&t==n.length-1&&(p=e.length);let r=0;o="";for(let a=0;a<n[t].length;a++){let h=n[t].charAt(a);"{"==h||"}"==h?(o.length>0&&(e.push(o.toString()),i.push(r),s.push(l)),o="",r="{"==h?-1:0):"^"==h&&-1==r&&0==o.length?r=1:o+=h}o.length>0&&(e.push(o.toString()),i.push(r),s.push(l))}for(m=e,d=i,c=s;p<m.length-1&&0!=d[p];)p++}let f=t.numberArray(0,m.length),g=0;for(let t=0;t<m.length;t++)f[t]=this.measure.measureText(m[t],this.fontSizePix)[0],null!=d&&0!=d[t]&&(f[t]*=.6),g+=f[t];let b=this.measure.angToX(i),y=this.measure.angToY(s);for(let t=0;t<p;t++)b-=f[t];b-=.5*f[p];for(let t=0;t<m.length;t++){let i={anum:t==p||null!=c&&c[t]?e:0,text:m[t],fsz:this.fontSizePix,col:this.policy.data.atomCols[this.mol.atomicNumber(e)],oval:new J(b+.5*f[t],y,.5*f[t]*1.1,.5*this.fontSizePix*1.1)};null!=d&&0!=d[t]&&(i.fsz*=.6,d[t]<0?i.oval.cy+=.7*i.fsz*(this.measure.yIsUp()?-1:1):i.oval.cy-=.3*i.fsz*(this.measure.yIsUp()?-1:1)),t==p?(this.points[e-1]=i,this.space[e-1]=this.computeSpacePoint(i)):(this.points.push(i),this.space.push(this.computeSpacePoint(i))),b+=f[t]}}backOffAtom(t,e,i,s,n,o){if(e==s&&i==n)return 1;let l=e-s,r=i-n,a=b(l,r),h=1/a;const u=.1*this.measure.scale();let m=e+2*u*l*h,d=i+2*u*r*h,c=a,p=!1;for(let o of this.space)if(o.anum==t){const t=o.px.length;if(0==t)continue;for(let l=0;l<t;l++){let r=l<t-1?l+1:0,a=o.px[l],h=o.py[l],u=o.px[r],f=o.py[r];if(!G.doLineSegsIntersect(m,d,s,n,a,h,u,f))continue;let g=G.lineIntersect(e,i,s,n,a,h,u,f);p=!0,c=Math.min(c,b(g[0]-s,g[1]-n))}}return p?(c=Math.max(o,c-u),c/a):1}backOffAtomDelta(t,e,i,s,n,o){let l=this.backOffAtom(t,e,i,s,n,o);if(l>=1)return null;l=1-l;let r=(s-e)*l,a=(n-i)*l;return[y(r,a),r,a]}shrinkBond(t,e,i,s,n){return 1==n?[t,e]:[i+n*(t-i),s+n*(e-s)]}ensureMinimumBondLength(t,e,i,s,n,o,l){let r=e[0]-t[0],a=e[1]-t[1],h=y(r,a);if(h>=v((l=Math.min(l,b(n-i,o-s)))-1e-4))return;let u=Math.sqrt(h),m=b(t[0]-i,t[1]-s),d=b(n-e[0],o-e[1]),c=1-l/u,p=1/(m+d),f=m*c*p,g=d*c*p;t[0]-=r*f,t[1]-=a*f,e[0]+=r*g,e[1]+=a*g}orderedRingList(){let e=[],i=[6,5,7,4,3];for(let t=0;t<i.length;t++){let s=this.mol.findRingsOfSize(i[t]);for(let t=0;t<s.length;t++)e.push(s[t])}let s=e.length,n=t.numberArray(0,this.mol.numAtoms);for(let t=0;t<s;t++){let i=e[t];for(let t=0;t<i.length;t++)n[i[t]-1]++}let o=t.numberArray(0,s);for(let t=0;t<s;t++){let i=e[t];for(let e=0;e<i.length;e++)o[t]+=n[i[e]-1]}let l=t.idxSort(o),r=t.numberArray(0,s),a=0;for(let t=0;t<s;t++){let i=e[l[t]];for(let e=0;e<i.length;e++){let s=this.mol.findBond(i[e],i[e+1<i.length?e+1:0]);2==this.mol.bondOrder(s)&&r[t]++}a=Math.max(a,r[t])}let h=[];for(let t=a;t>=0;t--)for(let i=0;i<s;i++)r[i]==t&&h.push(e[l[i]]);return h}orthogonalDelta(t,e,i,s,n){let o=e-s,l=i-t,r=y(o,l),a=r>0?n/Math.sqrt(r):1;return[o*a,l*a]}processDoubleBond(t,e){let i=this.mol.bondFrom(t),s=this.mol.bondTo(t),n=this.mol.atomAdjList(i),o=this.mol.atomAdjList(s),l=this.points[i-1],r=this.points[s-1],a=l.oval.cx,h=l.oval.cy,u=r.oval.cx,m=r.oval.cy,d=this.orthogonalDelta(a,h,u,m,this.bondSepPix);const c=.5*this.measure.scale();let p=u-a,f=m-h,g=Math.atan2(f,p),b=0,y=0,x=0,A=0,v=0,M=0,T=0,w=0,E=!1;for(let t=0;t<n.length;t++)if(n[t]!=s){let s=this.mol.bondOrder(this.mol.findBond(i,n[t]));if(0==s)continue;if(s>1){E=!0;break}let o=!1;for(let i=0;i<(null==e?0:e.length);i++)e[i]==n[t]&&(o=!0);let l=N(Math.atan2(this.points[n[t]-1].oval.cy-h,this.points[n[t]-1].oval.cx-a),g);if(Math.abs(l)*k>175){E=!0;break}l>0?(o&&b++,v=n[t]):(o&&y++,M=n[t])}for(let t=0;t<o.length;t++)if(o[t]!=i){let i=this.mol.bondOrder(this.mol.findBond(s,o[t]));if(0==i)continue;if(i>1){E=!0;break}let n=!1;for(let i=0;i<(null==e?0:e.length);i++)e[i]==o[t]&&(n=!0);let l=N(Math.atan2(this.points[o[t]-1].oval.cy-m,this.points[o[t]-1].oval.cx-u),g);if(Math.abs(l)*k>175){E=!0;break}l>0?(n&&x++,T=o[t]):(n&&A++,w=o[t])}let C=0;E||b>1||y>1||x>1||A>1||b>0&&y>0||x>0&&A>0||(b>0||x>0?C=1:(y>0||A>0)&&(C=-1));let S=this.lineSizePix,B=a,q=h,O=u,I=m,L=0,D=0,R=0,P=0;0==C?(B=a+.5*d[0],q=h+.5*d[1],O=u+.5*d[0],I=m+.5*d[1],L=a-.5*d[0],D=h-.5*d[1],R=u-.5*d[0],P=m-.5*d[1]):C>0?(L=a+d[0],D=h+d[1],R=u+d[0],P=m+d[1],n.length>1&&null==this.points[i-1].text&&(L+=d[1],D-=d[0]),o.length>1&&null==this.points[s-1].text&&(R-=d[1],P+=d[0])):C<0&&(L=a-d[0],D=h-d[1],R=u-d[0],P=m-d[1],n.length>1&&null==this.points[i-1].text&&(L+=d[1],D-=d[0]),o.length>1&&null==this.points[s-1].text&&(R-=d[1],P+=d[0])),0!=C&&(this.mol.atomElement(i).length<=2&&1==this.mol.atomAdjCount(i)&&null!=this.points[i-1].text&&this.bumpAtomPosition(i,.5*d[0]*C,.5*d[1]*C),this.mol.atomElement(s).length<=2&&1==this.mol.atomAdjCount(s)&&null!=this.points[s-1].text&&this.bumpAtomPosition(s,.5*d[0]*C,.5*d[1]*C));let z=this.backOffAtomDelta(i,B,q,O,I,c),F=this.backOffAtomDelta(i,L,D,R,P,c);if(null!=z||null!=F){let t=(null==z?0:z[0])>(null==F?0:F[0])?z:F;B+=t[1],q+=t[2],L+=t[1],D+=t[2]}let _=this.backOffAtomDelta(s,O,I,B,q,c),Y=this.backOffAtomDelta(s,R,P,L,D,c);if(null!=_||null!=Y){let t=(null==_?0:_[0])>(null==Y?0:Y[0])?_:Y;O+=t[1],I+=t[2],R+=t[1],P+=t[2]}if(0==C&&!E){let e=null;null!=this.points[i-1].text||this.mol.bondInRing(t)||(e=this.adjustBondPosition(v,i,B,q,O,I),null!=e&&(B=e[0],q=e[1]),e=this.adjustBondPosition(M,i,L,D,R,P),null!=e&&(L=e[0],D=e[1])),null!=this.points[s-1].text||this.mol.bondInRing(t)||(e=this.adjustBondPosition(T,s,O,I,B,q),null!=e&&(O=e[0],I=e[1]),e=this.adjustBondPosition(w,s,R,P,L,D),null!=e&&(R=e[0],P=e[1]))}let X=this.mol.bondType(t)==Vt.BONDTYPE_UNKNOWN?Pe.Unknown:Pe.Normal,U=X==Pe.Unknown?.1*this.scale:0,j=this.effects.colBond[t];j||(j=this.policy.data.foreground);let H={bnum:t,bfr:i,bto:s,type:X,line:new tt(B,q,O,I),size:S,head:U,col:j},V={bnum:t,bfr:i,bto:s,type:X,line:new tt(L,D,R,P),size:S,head:U,col:j};this.lines.push(H),this.lines.push(V),this.space.push(this.computeSpaceLine(H)),this.space.push(this.computeSpaceLine(V))}placeHydrogen(e,i,s){let n=Xe.main;const o=.6,l=n.getIndex("H");let r=this.points[e],a=r.fsz*n.INV_UNITS_PER_EM,h=i>=2?i.toString():"",u=n.getOutlineX(l),m=n.getOutlineY(l),d=n.HORIZ_ADV_X[l],c=d;for(let e=0;e<h.length;e++){let i=h.charAt(e),s=n.getIndex(i);if(0==e)c+=n.getKerning("H",i);else{let t=h.charAt(e-1);c+=n.getKerning(t,i)*o}let l=n.getOutlineX(s),r=n.getOutlineY(s);t.addTo(l,c/o),t.addTo(r,-.4*n.ASCENT*1.3),t.mulBy(l,o),t.mulBy(r,o),u=u.concat(l),m=m.concat(r),c+=n.HORIZ_ADV_X[s]*o}if(h.length>0){let t=new Q(u,m,0);u=t.hullX,m=t.hullY}let p=-.5*d,f=.5*n.ASCENT*n.ASCENT_FUDGE;for(let t=0;t<u.length;t++)u[t]=r.oval.cx+(p+u[t])*a,m[t]=r.oval.cy+(f-m[t])*a*this.ymul;let g=0,b=0,y=this.measure.measureText(r.text,r.fsz);if(s){let e=[0,1,2,3],i=[1,0,2,3],s=[2,3,0,1],n=[3,2,0,1],o=e,l=this.mol.atomAdjList(r.anum);if(0==l.length){let t=["O","S","F","Cl","Br","I"];o=0==this.mol.atomCharge(r.anum)&&0==this.mol.atomUnpaired(r.anum)&&t.indexOf(this.mol.atomElement(r.anum))>=0?i:e}else{let t=!0,e=!0,a=!0,h=!0;const u=this.mol.atomX(r.anum),m=this.mol.atomY(r.anum);for(let i=0;i<l.length;i++){const s=this.mol.atomX(l[i]),n=this.mol.atomY(l[i]);s>u+.01&&(t=!1),s<u-.01&&(e=!1),n<m-.01&&(a=!1),n>m+.01&&(h=!1)}t||(e?o=i:a?o=n:h&&(o=s))}for(let e=0;e<4;e++){let i=0,s=0;0==o[e]?i=.5*y[0]+.5*d*a:1==o[e]?i=-.5*y[0]-(c-.5*d)*a:2==o[e]?s=(1.1*y[1]+.5*y[2])*-this.ymul:3==o[e]&&(s=(1.1*y[1]+.5*y[2])*this.ymul),t.addTo(u,i),t.addTo(m,s);let n=this.countPolyViolations(u,m,null,!0);if(t.addTo(u,-i),t.addTo(m,-s),0==n){g=i,b=s;break}}if(0==g&&0==b)return!1}else{const e=t.min(m),i=t.max(u),s=t.min(m),n=t.max(m),o=.5*(e+i),l=.5*(s+n),a=1+this.measure.scale()*this.policy.data.fontSize*He.FONT_CORRECT*.1/Math.max(i-o,n-l),h=u.length;let d=u.slice(0),c=m.slice(0);for(let t=0;t<h;t++)d[t]=(d[t]-o)*a+o,c[t]=(c[t]-l)*a+l;let p=0,f=0,y=0;for(let e=.5*(r.oval.rw+r.oval.rh);e<1.5*this.measure.scale();e+=.1*this.measure.scale()){let i=!1;for(let s=0;s<2*Math.PI;s+=5*S){let n=e*Math.cos(s),o=e*Math.sin(s);t.addTo(d,n),t.addTo(c,o);let l=this.countPolyViolations(d,c,null,!1);t.addTo(d,-n),t.addTo(c,-o),0==l&&(i=!0);let a=10*l+this.spatialCongestion(r.oval.cx+n,r.oval.cy+o,.5)+2*e;(0==p||a<p)&&(p=a,f=e,y=s,g=n,b=o)}if(i)break}}let x=this.measure.measureText("H",r.fsz);const A=1.1;let v={anum:0,text:"H",fsz:r.fsz,col:r.col,oval:new J(r.oval.cx+g,r.oval.cy+b,.5*x[0]*A,.5*x[1]*A)};if(this.points.push(v),h.length>0){const t=o*r.fsz;x=this.measure.measureText(h,t);let e={anum:0,text:h,fsz:t,col:r.col,oval:new J(v.oval.cx+.5*d*r.fsz*n.INV_UNITS_PER_EM+.5*x[0],v.oval.cy+.4*r.fsz,.5*x[0]*A,.5*x[1]*A)};this.points.push(e)}t.addTo(u,g),t.addTo(m,b);let M=t.min(u),T=t.min(m),w={anum:0,bnum:0,box:new Z(M,T,t.max(u)-M,t.max(m)-T),px:u,py:m};return this.space.push(w),!0}computeSpacePoint(e){let i={anum:e.anum,bnum:0,box:new Z,px:[],py:[]};const s=Xe.main;let n=[],o=[],l=0,r=0;if(null!=e.text)for(let i=0;i<e.text.length;i++){let a=e.text.charAt(i),h=s.getIndex(a);if(h>=0){if(0==l)n=s.getOutlineX(h),o=s.getOutlineY(h),r=1;else{let e=s.getOutlineX(h),i=s.getOutlineY(h);e.length>0&&(t.addTo(e,l),n=n.concat(e),o=o.concat(i),r++)}l+=s.HORIZ_ADV_X[h]}else l+=s.MISSING_HORZ;if(i<e.text.length-1){let t=e.text.charAt(i+1);l+=s.getKerning(a,t)}}if(n.length>0){if(r>1){let t=new Q(n,o,0);n=t.hullX,o=t.hullY}let a=-.5*l,h=.5*s.ASCENT*s.ASCENT_FUDGE,u=e.fsz*s.INV_UNITS_PER_EM;for(let t=0;t<n.length;t++)n[t]=e.oval.cx+(a+n[t])*u,o[t]=e.oval.cy+(h-o[t])*u*this.ymul;i.px=n,i.py=o;let m=t.min(n),d=t.min(o);i.box=new Z(m,d,t.max(n)-m,t.max(o)-d)}else i.box=Z.fromOval(e.oval),i.box.w>0&&i.box.h>0&&(i.px=[i.box.minX(),i.box.maxX(),i.box.maxX(),i.box.minX()],i.py=[i.box.minY(),i.box.minY(),i.box.maxY(),i.box.maxY()]);return i}computeSpaceLine(e){let i={anum:0,bnum:e.bnum,box:new Z,px:[],py:[]};if(e.type==Pe.Normal||e.type==Pe.Dotted||e.type==Pe.DotDir)i.px=[e.line.x1,e.line.x2],i.py=[e.line.y1,e.line.y2];else{const t=e.line.x2-e.line.x1,s=e.line.y2-e.line.y1,n=e.head/Math.sqrt(t*t+s*s),o=n*s,l=-n*t;e.type==Pe.Unknown?(i.px=[e.line.x1+o,e.line.x1-o,e.line.x2-o,e.line.x2+o],i.py=[e.line.y1+l,e.line.y1-l,e.line.y2-l,e.line.y2+l]):(i.px=[e.line.x1,e.line.x2-o,e.line.x2+o],i.py=[e.line.y1,e.line.y2-l,e.line.y2+l])}return i.box.x=t.min(i.px)-e.size,i.box.y=t.min(i.py)-e.size,i.box.w=t.max(i.px)-i.box.x+e.size,i.box.h=t.max(i.py)-i.box.y+e.size,i}bumpAtomPosition(e,i,s){let n=this.points[e-1];n.oval.cx+=i,n.oval.cy+=s;for(let n=this.space.length-1;n>=0;n--){let o=this.space[n-1];null!=o&&o.anum==e&&(o.box.x+=i,o.box.y+=s,t.addTo(o.px,i),t.addTo(o.py,s))}}spaceSubset(t,e,i,s){let n=[];for(let o of this.space)G.rectsIntersect(t,e,i,s,o.box.x,o.box.y,o.box.w,o.box.h)&&n.push(o);return n}countPolyViolations(e,i,s,n){null==s&&(s=this.space);let o=0;const l=e.length,r=s.length;let a=new Z,h=new Z;for(let t=0;t<l;t++){let u=t<l-1?t+1:0;a.x=Math.min(e[t],e[u])-1,a.y=Math.min(i[t],i[u])-1,a.w=Math.max(e[t],e[u])-a.x+2,a.h=Math.max(i[t],i[u])-a.y+2;for(let l=0;l<r;l++){let r=s[l];if(null==r.px)continue;if(h.x=r.box.x-1,h.y=r.box.y-1,h.w=r.box.w+1,h.h=r.box.h+1,!a.intersects(h))continue;let m=r.px.length;for(let s=0;s<m;s++){let l=s<m-1?s+1:0;if(h.x=Math.min(r.px[s],r.px[l])-1,h.y=Math.min(r.py[s],r.py[l])-1,h.w=Math.max(r.px[s],r.px[l])-h.x+2,h.h=Math.max(r.py[s],r.py[l])-h.y+2,a.intersects(h)){if(G.doLineSegsIntersect(e[t],i[t],e[u],i[u],r.px[s],r.py[s],r.px[l],r.py[l])){if(n)return 1;o++;break}if(1==m)break}}}}a.x=t.min(e),a.y=t.min(i),a.w=t.max(e)-a.x,a.h=t.max(i)-a.y;for(let t=r-1;t>=0;t--){let r=s[t];if(h.x=r.box.x,h.y=r.box.y,h.w=r.box.w,h.h=r.box.h,a.intersects(h)){for(let t=r.px.length-1;t>=0;t--)if(G.pointInPolygon(r.px[t],r.py[t],e,i)){if(n)return 1;o++;break}for(let t=0;t<l;t++)if(G.pointInPolygon(e[t],i[t],r.px,r.py)){if(n)return 1;o++;break}}}return o}adjustBondPosition(t,e,i,s,n,o){if(0==t||0==e)return null;for(let l=0;l<this.lines.length;l++){let r=this.lines[l];if(1!=this.mol.bondOrder(r.bnum)||this.mol.bondType(r.bnum)!=Vt.BONDTYPE_NORMAL)continue;let a=!1;if(this.mol.bondFrom(r.bnum)==t&&this.mol.bondTo(r.bnum)==e);else{if(this.mol.bondFrom(r.bnum)!=e||this.mol.bondTo(r.bnum)!=t)continue;a=!0}let h=N(Math.atan2(r.line.y2-r.line.y1,r.line.x2-r.line.x1),Math.atan2(o-s,n-i))*k;if(h>-5&&h<5||h>175||h<-175)continue;let u=G.lineIntersect(r.line.x1,r.line.y1,r.line.x2,r.line.y2,i,s,n,o);return 0==this.mol.atomRingBlock(e)&&(a?(r.line.x1=u[0],r.line.y1=u[1]):(r.line.x2=u[0],r.line.y2=u[1])),u}return null}priorityDoubleSubstit(t){let e=this.mol.bondFrom(t),i=this.mol.bondTo(t),s=this.mol.atomAdjList(e),n=this.mol.atomAdjList(i),o=this.points[e-1],l=this.points[i-1],r=o.oval.cx,a=o.oval.cy,h=l.oval.cx,u=l.oval.cy,m=h-r,d=u-a,c=Math.atan2(d,m),p=0,f=0,g=0,b=0;for(let t=0;t<s.length;t++)if(s[t]!=i)if(N(Math.atan2(this.points[s[t]-1].oval.cy-a,this.points[s[t]-1].oval.cx-r),c)>0){if(0!=p)return null;p=s[t]}else{if(0!=f)return null;f=s[t]}for(let t=0;t<n.length;t++)if(n[t]!=e)if(N(Math.atan2(this.points[n[t]-1].oval.cy-u,this.points[n[t]-1].oval.cx-h),c)>0){if(0!=g)return null;g=n[t]}else{if(0!=b)return null;b=n[t]}let y=(p>0?1:0)+(f>0?1:0),x=(g>0?1:0)+(b>0?1:0);if(1==y&&0==x)return[p>0?p:f];if(0==y&&1==x)return[g>0?g:b];if(1==y&&1==x){if(p>0&&g>0)return[p,g];if(f>0&&b>0)return[f,b];let t=this.orthogonalDelta(r,a,h,u,this.bondSepPix);return this.spatialCongestion(.5*(r+h)+t[0],.5*(a+u)+t[1])<this.spatialCongestion(.5*(r+h)-t[0],.5*(a+u)-t[1])?[p>0?p:g]:[f>0?f:b]}return 2==y&&1==x?0==g?[f,b]:[p,g]:1==y&&2==x?0==p?[f,b]:[p,g]:null}annotateAtom(t,e,i,s){let[n,o]=this.measure.measureText(e,s),l=this.points[t-1],r=l.oval.cx,a=l.oval.cy,h=.6*n,u=.6*o,m=[];for(let e of this.mol.atomAdjList(t)){let t=this.points[e-1].oval.cx-r,i=this.points[e-1].oval.cy-a;m.push(Math.atan2(i,t))}let d=.5*(l.oval.rw+l.oval.rh),c=.1*this.scale,p=E/36,f=Number.POSITIVE_INFINITY,g=0,b=0,y=[0,0,0,0],x=[0,0,0,0],A=h+d+8*c,v=u+d+8*c,M=this.spaceSubset(r-A,a-v,2*A,2*v);for(let t=0;t<8;t++){let e=d+t*c;for(let t=0;t<36;t++){let i=p*t,s=e*Math.cos(i),n=e*Math.sin(i),o=r+s-h,l=r+s+h,d=a+n-u,c=a+n+u;y[0]=o,x[0]=d,y[1]=l,x[1]=d,y[2]=l,x[2]=c,y[3]=o,x[3]=c;let A=1e3*this.countPolyViolations(y,x,M,!1);for(let t of m)A-=Math.abs(N(i,t));A<f&&(f=A,g=s,b=n)}if(f<500)break}let T=r+g,w=a+b,C={anum:0,text:e,fsz:s,col:i,oval:new J(T,w,h,u)};this.points.push(C);let S={anum:0,bnum:0,box:new Z(T-h,w-u,2*h,2*u),px:[T-h,T+h,T+h,T-h],py:[w-u,w-u,w+u,w+u]};this.space.push(S)}annotateBond(t,e,i,s){let[n,o]=this.measure.measureText(e,s),l=this.mol.bondFrom(t),r=this.mol.bondTo(t),a=this.points[l-1],h=this.points[r-1],u=.5*(a.oval.cx+h.oval.cx),m=.5*(a.oval.cy+h.oval.cy),d=.6*n,c=.6*o,p=Math.atan2(h.oval.cy-a.oval.cy,h.oval.cx-a.oval.cx),f=[p,p+Math.PI];for(let t of this.mol.atomAdjList(l))if(t!=r){let e=this.points[t-1].oval.cx-this.points[l-1].oval.cx,i=this.points[t-1].oval.cy-this.points[l-1].oval.cy;f.push(Math.atan2(i,e))}for(let t of this.mol.atomAdjList(r))if(t!=l){let e=this.points[t-1].oval.cx-this.points[r-1].oval.cx,i=this.points[t-1].oval.cy-this.points[r-1].oval.cy;f.push(Math.atan2(i,e))}let g=.2*this.scale*this.bondOrder[t-1],b=.1*this.scale,y=E/36,x=Number.POSITIVE_INFINITY,A=0,v=0,M=[0,0,0,0],T=[0,0,0,0],w=d+g+8*b,C=c+g+8*b,S=this.spaceSubset(u-w,m-C,2*w,2*C);for(let t=0;t<8;t++){let e=g+t*b;for(let t=0;t<36;t++){let i=y*t,s=e*Math.cos(i),n=e*Math.sin(i),o=u+s-d,l=u+s+d,r=m+n-c,a=m+n+c;M[0]=o,T[0]=r,M[1]=l,T[1]=r,M[2]=l,T[2]=a,M[3]=o,T[3]=a;let h=1e3*this.countPolyViolations(M,T,S,!1);for(let t of f)h-=Math.abs(N(i,t));h<x&&(x=h,A=s,v=n)}if(x<500)break}let k=u+A,B=m+v,q={anum:0,text:e,fsz:s,col:i,oval:new J(k,B,d,c)};this.points.push(q);let O={anum:0,bnum:0,box:new Z(k-d,B-c,2*d,2*c),px:[k-d,k+d,k+d,k-d],py:[B-c,B-c,B+c,B+c]};this.space.push(O)}boxOverlaps(t,e,i,s,n,o){let l=t,r=e,a=t+i,h=e+s;for(let t=0;t<this.points.length;t++){if(null!=n&&!n[t])continue;let e=this.points[t],i=e.oval.cx-e.oval.rw,s=e.oval.cy-e.oval.rh,o=e.oval.cx+e.oval.rw,u=e.oval.cy+e.oval.rh;if(!(a<i||l>o||h<s||r>u))return!0}for(let t=0;t<this.lines.length;t++){if(null!=o&&!o[t])continue;let e=this.lines[t],i=e.line.x1,s=e.line.y1,n=e.line.x2,u=e.line.y2;if(!(a<Math.min(i,n)||l>Math.max(i,n)||h<Math.min(s,u)||r>Math.max(s,u))){if(i>=l&&i<=a&&s>=r&&s<=h)return!0;if(n>=l&&n<=a&&u>=r&&u<=h)return!0;if(G.doLineSegsIntersect(i,s,n,u,l,r,a,r))return!0;if(G.doLineSegsIntersect(i,s,n,u,l,h,a,h))return!0;if(G.doLineSegsIntersect(i,s,n,u,l,r,l,h))return!0;if(G.doLineSegsIntersect(i,s,n,u,a,r,a,h))return!0}}return!1}resolveLineCrossings(t,e){for(;;){let i=!1;for(let s=0;s<this.lines.length;s++){let n=this.lines[s];if(n.bnum==t&&(n.type==Pe.Normal||n.type==Pe.Dotted||n.type==Pe.DotDir))for(let t=0;t<this.lines.length;t++){let s=this.lines[t];if(s.bnum!=e)continue;if(s.type==Pe.DotDir&&(s.type=Pe.Dotted),s.type!=Pe.Normal&&s.type!=Pe.Dotted)continue;if(n.bfr==s.bfr||n.bfr==s.bto||n.bto==s.bfr||n.bto==s.bto)continue;if(!G.doLineSegsIntersect(n.line.x1,n.line.y1,n.line.x2,n.line.y2,s.line.x1,s.line.y1,s.line.x2,s.line.y2))continue;let o=G.lineIntersect(n.line.x1,n.line.y1,n.line.x2,n.line.y2,s.line.x1,s.line.y1,s.line.x2,s.line.y2),l=s.line.x2-s.line.x1,r=s.line.y2-s.line.y1,a=Math.abs(l)>Math.abs(r)?(o[0]-s.line.x1)/l:(o[1]-s.line.y1)/r,h=b(l,r),u=s.size/h*(s.type==Pe.Normal?2:4);if(a>u&&a<1-u){let t={bnum:s.bnum,bfr:s.bfr,bto:s.bto,type:s.type,line:s.line.clone(),size:s.size,head:s.head,col:s.col};this.lines.push(t),s.line.x2=s.line.x1+l*(a-u),s.line.y2=s.line.y1+r*(a-u),t.line.x1=t.line.x1+l*(a+u),t.line.y1=t.line.y1+r*(a+u),i=!0}else a>u?(s.line.x2=s.line.x1+l*(a-u),s.line.y2=s.line.y1+r*(a-u),i=!0):a<1-u&&(s.line.x1=s.line.x1+l*(a+u),s.line.y1=s.line.y1+r*(a+u),i=!0)}}if(!i)break}}createCircularRing(e){let i=new Array(e.length),s=new Array(e.length);for(let t=0;t<e.length;t++){let n=this.points[e[t]-1];i[t]=n.oval.cx,s[t]=n.oval.cy}let n=t.sum(i)/e.length,o=t.sum(s)/e.length,l=[],r=[],a=!0,h=Number.NaN;const u=.7;for(let t of e){let i=this.points[t-1],s=i.oval.cx-n,m=i.oval.cy-o,d=s-i.oval.rw,c=s+i.oval.rw,p=m-i.oval.rh,f=m+i.oval.rh;l.push(d),r.push(m),l.push(d),r.push(p),l.push(d),r.push(f),l.push(s),r.push(p),l.push(s),r.push(f),l.push(c),r.push(m),l.push(c),r.push(p),l.push(c),r.push(f);let g=b(s,m),y=Math.atan2(m,s);l.push(u*g*Math.cos(y)),r.push(u*g*Math.sin(y));for(let s of this.mol.atomAdjList(t))if(e.indexOf(s)>=0){let t=this.points[s-1],e=.5*(i.oval.cx+t.oval.cx)-n,a=.5*(i.oval.cy+t.oval.cy)-o,h=b(e,a),m=Math.atan2(a,e);l.push(u*h*Math.cos(m)),r.push(u*h*Math.sin(m))}a&&(Number.isFinite(h)?Math.abs(h-g)>1&&(a=!1):h=g)}let m={atoms:e,cx:n,cy:o,rw:0,rh:0,theta:0,size:0};if(a)m.rw=m.rh=G.fitCircle(l,r);else{let t=0;for(let l=0;l<e.length;l++)t+=b(i[l]-n,s[l]-o);let l=t/e.length*(1-u);var d=new je(i,s,l);d.calculate(),m.cx=d.cx,m.cy=d.cy,m.rw=d.rw,m.rh=d.rh,m.theta=d.theta}m.size=this.lineSizePix,this.rings.push(m)}createCurvedPath(e,i,s){const n=e.length;let o=[],l=[],r=[];for(let t=0;t<n;t++){let i=this.points[e[t]-1];o.push(i.oval.cx),l.push(i.oval.cy),r.push(null!=i.text)}let a=[],h=[];const u=.25*Vt.IDEALBOND*this.scale;for(let t=0;t<n-1;t++){let e=o[t+1]-o[t],i=l[t+1]-l[t],s=u*M(b(e,i));a.push(i*s),h.push(-e*s)}let m=t.numberArray(0,n),d=t.numberArray(0,n),c=t.numberArray(0,n),p=t.numberArray(0,n);const f=r[0]?1.2:.7;if(i){const t=-h[0],e=a[0];m[0]=o[0]+t*f,d[0]=l[0]+e*f,c[0]=o[0]+t*f,p[0]=l[0]+e*f}else m[0]=o[0]+a[0]*f,d[0]=l[0]+h[0]*f,c[0]=o[0]-a[0]*f,p[0]=l[0]-h[0]*f;let g=0,y=0;for(let t=1;t<n-1;t++){const i=r[t]?1.2:.7,n=i;m[t]=o[t]+i*(a[t-1]+a[t]),d[t]=l[t]+i*(h[t-1]+h[t]),c[t]=o[t]-n*(a[t-1]+a[t]),p[t]=l[t]-n*(h[t-1]+h[t]);for(let i of this.mol.atomAdjList(e[t]))if(e.indexOf(i)<0&&i!=s){let e=this.points[i-1],s=e.oval.cx-o[t],n=e.oval.cy-l[t];s*(m[t]-o[t])+n*(d[t]-o[t])>n*(c[t]-o[t])+n*(p[t]-o[t])?g++:y++}}let x=n-1,A=r[x]?1.2:.7;if(i){let t=-h[x-1],e=a[x-1];m[x]=o[x]-t*A,d[x]=l[x]-e*A,c[x]=o[x]-t*A,p[x]=l[x]-e*A}else m[x]=o[x]+a[x-1]*A,d[x]=l[x]+h[x-1]*A,c[x]=o[x]-a[x-1]*A,p[x]=l[x]-h[x-1]*A;let v=0,T=0;for(let t=0;t<n-1;t++)v+=b(m[t+1]-m[t],d[t+1]-d[t]),T+=b(c[t+1]-c[t],p[t+1]-p[t]);v*=g+1,T*=y+1;let w=v<T?m:c,E=v<T?d:p,C={atoms:e,px:null,py:null,ctrl:null,size:this.lineSizePix};this.splineInterpolate(C,w,E),this.paths.push(C)}createBondCentroid(t,e){let i=this.points[t-1],s=i.oval.cx,n=i.oval.cy,o=0,l=0;for(let t of e)i=this.points[t-1],o+=i.oval.cx,l+=i.oval.cy;o/=e.length,l/=e.length,e.length<=2&&(o-=.1*(o-s),l-=.1*(l-n));const r=.25*this.measure.scale();let a=this.shrinkBond(s,n,o,l,this.backOffAtom(t,s,n,o,l,r));this.ensureMinimumBondLength(a,[o,l],s,n,o,l,r);let h={bnum:0,bfr:t,bto:0,type:Pe.Normal,line:new tt(a[0],a[1],o,l),size:this.lineSizePix,head:0,col:this.policy.data.foreground};this.lines.push(h),this.space.push(this.computeSpaceLine(h))}splineInterpolate(e,i,s){const n=i.length,o=.25;for(let l=0;l<n;l++)if(0==l){let n=i[l+1]-i[l],r=s[l+1]-s[l],a=i[l]+o*n,h=s[l]+o*r;e.px=t.append(e.px,i[l]),e.py=t.append(e.py,s[l]),e.ctrl=t.append(e.ctrl,!1),e.px=t.append(e.px,a),e.py=t.append(e.py,h),e.ctrl=t.append(e.ctrl,!0)}else if(l==n-1){let n=i[l]-i[l-1],r=s[l]-s[l-1],a=i[l]-o*n,h=s[l]-o*r;e.px=t.append(e.px,a),e.py=t.append(e.py,h),e.ctrl=t.append(e.ctrl,!0),e.px=t.append(e.px,i[l]),e.py=t.append(e.py,s[l]),e.ctrl=t.append(e.ctrl,!1)}else{let n=i[l+1]-i[l-1],r=s[l+1]-s[l-1],a=M(b(n,r));n*=a,r*=a;let h=o*b(i[l]-i[l-1],s[l]-s[l-1]),u=o*b(i[l+1]-i[l],s[l+1]-s[l]),m=i[l]-n*h,d=s[l]-r*h,c=i[l]+n*u,p=s[l]+r*u;e.px=t.append(e.px,m),e.py=t.append(e.py,d),e.ctrl=t.append(e.ctrl,!0),e.px=t.append(e.px,i[l]),e.py=t.append(e.py,s[l]),e.ctrl=t.append(e.ctrl,!1),e.px=t.append(e.px,c),e.py=t.append(e.py,p),e.ctrl=t.append(e.ctrl,!0)}}delocalisedAnnotation(t,e,i){const s=this.mol;let n="";if(-1==e?n="-":1==e?n="+":e<-1?n=Math.abs(e)+"-":e>1&&(n=e+"+"),i>0)for(let t=0;t<i;t++)n+=".";if(0==n.length)return;const o=t.length;let l=0,r=0;for(let e of t)l+=s.atomX(e),r+=s.atomY(e);l/=o,r/=o;let a=Wt.congestionPoint(s,l,r);for(let e=1;e<o-1;e++){let i=.5*(s.atomX(t[e-1])+s.atomX(t[e+1])),n=.5*(s.atomY(t[e-1])+s.atomY(t[e+1])),o=Wt.congestionPoint(s,i,n);o<a&&(a=o,l=i,r=n)}let h=.8*this.fontSizePix,u=this.measure.measureText(n,h),m=.55*u[0],d=.55*u[1],c={anum:0,text:n,fsz:h,col:this.policy.data.foreground,oval:new J(this.measure.angToX(l),this.measure.angToY(r),m,d)};this.points.push(c);let p={anum:0,bnum:0,box:new Z(c.oval.cx-m,c.oval.cy-d,2*m,2*d),px:[c.oval.cx-m,c.oval.cx+m,c.oval.cx+m,c.oval.cx-m],py:[c.oval.cy-d,c.oval.cy-d,c.oval.cy+d,c.oval.cy+d]};this.space.push(p)}processPolymerUnit(e,i){if(4==t.len(e.bondConn))return void this.processPolymerUnitPair(e);let s=[];const{mol:n,measure:o}=this;for(let t=1;t<=n.numBonds;t++){let o=n.bondFrom(t),l=n.bondTo(t),r=e.atoms.indexOf(o)>=0,a=e.atoms.indexOf(l)>=0,h=null;if(r&&!a)h={a1:o,a2:l};else{if(!a||r)continue;h={a1:l,a2:o}}h.x1=n.atomX(h.a1),h.y1=n.atomY(h.a1),h.x2=n.atomX(h.a2),h.y2=n.atomY(h.a2),h.shared=!1;for(let t of i)if(e!==t&&t.atoms.includes(h.a2)){h.shared=!0;break}let u=i.filter((t=>t===e||t.atoms.includes(h.a1)&&!t.atoms.includes(h.a2)));if(u.length>1){u.sort(((t,e)=>t.atoms.length-e.atoms.length));for(let t=0;t<u.length;t++)u[t]===e&&(h.nestOrder=t);h.nestCount=u.length}s.push(h)}let l=0,r=e.atoms.map((t=>n.atomX(t))),a=e.atoms.map((t=>n.atomY(t))),h=t.min(r),u=t.min(a),m=t.max(r),d=t.max(a);for(let t=1;t<s.length;t++){let e=s[l],i=s[t],n=e.x2-h-e.y2+u;i.x2-h-i.y2+u>n&&(l=t)}let c=!1,p=!1;if(2==s.length){let t=s[0==l?1:0],e=s[l],i=Math.atan2(t.y2-t.y1,t.x2-t.x1),n=Math.atan2(e.y2-e.y1,e.x2-e.x1);c=(i>145*S||i<-145*S)&&n<35*S&&n>-35*S}else if(0==s.length){let t=.5*(u+d);s.push({x1:h,y1:t,x2:h-1,y2:t}),s.push({x1:m,y1:t,x2:m+1,y2:t}),l=1,p=!0}let f=(p?.5*(d-u+1):c?1:.5)*this.scale,g=.2*this.scale;const y={bnum:0,bfr:0,bto:0,type:Pe.Normal,size:this.lineSizePix,head:0,col:this.policy.data.foreground},x={anum:0,fsz:.7*this.fontSizePix,bold:!1,col:this.policy.data.foreground};for(let t=0;t<s.length;t++){let i=s[t],n=o.angToX(i.x1),r=o.angToY(i.y1),a=o.angToX(i.x2),h=o.angToY(i.y2);if(i.shared&&(a-=.1*(a-n),h-=.1*(h-r)),i.nestCount>1){let t=a-n,e=h-r,s=(i.nestOrder+1)/i.nestCount;a=n+t*s,h=r+e*s}let u=.5*(n+a),m=.5*(r+h);c&&(n=a=u,r=h=m,t==l?(n--,a++):(n++,a--));let d=M(b(a-n,h-r)),p=(a-n)*d,A=(h-r)*d,v=A,T=-p,w=u-f*v,E=m-f*T,C=u+f*v,S=m+f*T,k=w-g*p,B=E-g*A,N=C-g*p,q=S-g*A,O=Object.assign(Object.assign({},y),{line:new tt(k,B,w,E)}),I=Object.assign(Object.assign({},y),{line:new tt(w,E,C,S)}),L=Object.assign(Object.assign({},y),{line:new tt(C,S,N,q)});if(this.lines.push(O),this.lines.push(I),this.lines.push(L),this.space.push(this.computeSpaceLine(O)),this.space.push(this.computeSpaceLine(I)),this.space.push(this.computeSpaceLine(L)),t==l){let t,s;i.shared?[t,s]=[w-.5*this.scale*v,E-.5*this.scale*T]:[t,s]=[w+2*g*p,E+2*g*A];let n=Object.assign(Object.assign({},x),{text:"n",oval:new J(t,s,0,0)});if(this.points.push(n),this.space.push(this.computeSpacePoint(n)),null!=e.connect){let n="?";e.connect==kt.HeadToTail?n="ht":e.connect==kt.HeadToHead?n="hh":e.connect==kt.Random&&(n="eu"),i.shared?[t,s]=[C+.5*this.scale*v,S+.5*this.scale*T]:[t,s]=[C+2.5*g*p,S+2.5*g*A];let o=Object.assign(Object.assign({},x),{text:n,oval:new J(t,s,0,0)});this.points.push(o),this.space.push(this.computeSpacePoint(o))}}}}processPolymerUnitPair(e){const{mol:i,measure:s}=this;let n=[],o=[];for(let t of e.bondConn){let e=i.bondFrom(t),l=i.bondTo(t);n.push(s.angToX(.5*(i.atomX(e)+i.atomX(l)))),o.push(s.angToY(.5*(i.atomY(e)+i.atomY(l))))}let l=.25*t.sum(n),r=.25*t.sum(o),a=.5*this.scale,h=[],u=[];for(let[t,e]of[[0,1],[2,3]]){let i=n[e]-n[t],s=o[e]-o[t],m=a*M(b(i,s)+.001);[i,s]=[i*m,s*m],n[t]-=2*i,o[t]-=2*s,n[e]+=2*i,o[e]+=2*s;let d=s,c=-i,p=y(.5*(n[t]+n[e])+d-l,.5*(o[t]+o[e])+c-r);y(.5*(n[t]+n[e])-d-l,.5*(o[t]+o[e])-c-r)<p&&([d,c]=[-d,-c]),h.push(d,d),u.push(c,c)}const m={bnum:0,bfr:0,bto:0,type:Pe.Normal,size:this.lineSizePix,head:0,col:this.policy.data.foreground},d={anum:0,fsz:.7*this.fontSizePix,bold:!1,col:this.policy.data.foreground};let c=(t,e,i,s)=>{let n=Object.assign(Object.assign({},m),{line:new tt(t,e,i,s)});this.lines.push(n),this.space.push(this.computeSpaceLine(n))},p=(t,e,i)=>{let s=Object.assign(Object.assign({},d),{text:i,oval:new J(t,e,0,0)});this.points.push(s),this.space.push(this.computeSpacePoint(s))};c(n[0],o[0],n[1],o[1]),c(n[0],o[0],n[0]+h[0],o[0]+u[0]),c(n[1],o[1],n[1]+h[1],o[1]+u[1]),c(n[2],o[2],n[3],o[3]),c(n[2],o[2],n[2]+h[2],o[2]+u[2]),c(n[3],o[3],n[3]+h[3],o[3]+u[3]);let f=t.min(n),g=t.min(o),x=[];for(let t=0;t<4;t++)x.push(n[t]-f+o[t]-g);let A=t.idxMax(x);p(n[A]-h[A],o[A]-u[A],"n");let v=A+(A%2==1?-1:1),T=(v+2)%4;p(n[T]-.5*h[T],o[T]-.5*u[T],"*"),p(n[v]-.5*h[v],o[v]-.5*u[v],"*")}}He.FONT_CORRECT=1.5;var Ve=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function l(t){try{a(s.next(t))}catch(t){o(t)}}function r(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(l,r)}a((s=s.apply(t,e||[])).next())}))};let We=null;const Ge=["units"];class Qe{static get main(){return We}constructor(){this.roots=[],this.mapTerms=new Map,this.alreadyLoaded=new Set}static init(){return Ve(this,void 0,void 0,(function*(){if(!We){We=new Qe;for(let t of Ge){let e=ot.RESOURCE_URL+"/data/ontology/"+t+".onto";We.loadFromURL(e)}}}))}getRoots(){return this.roots}hasTerm(t){return this.mapTerms.has(t)}getBranch(t){return this.mapTerms.get(t)}getBranchList(e){if("string"==typeof e){let t=this.mapTerms.get(e);if(!t)throw`Unknown branch URI: ${e}`;if(t.length>1)throw`Ambiguous branch URI occurs more than once: ${e}`;e=t[0]}let i=[],s=e=>{i.push(e);for(let i of t.safeArray(e.children))s(i)};return s(e),i}loadFromURL(t){return Ve(this,void 0,void 0,(function*(){if(this.alreadyLoaded.has(t))return;this.alreadyLoaded.add(t);let e=yield j(t);if(!e)throw`Resource not found: ${t}`;this.loadContent(e)}))}loadContent(t){let e=[],i=0;for(let s of t.split(/\n/)){if(i++,s=s.trim(),!s||s.startsWith("#"))continue;let t=s.indexOf("http");if(t<0)throw`Line ${i} invalid, no URI term: ${s}`;let n=0;for(let e=0;e<t;e++)"-"==s.charAt(e)&&n++;let o=s.substring(t);if(t=o.indexOf(" "),t<0)throw`Line ${i} invalid, no label: ${s}`;let l=o.substring(t+1);o=o.substring(0,t);let r=null;if(0==n&&(r=this.roots.find((t=>t.uri==o))),!r){if(r={uri:o,label:l,parent:null,children:[],depth:n},0==n)this.roots.push(r);else{for(let t=e.length-1;t>=0;t--)if(e[t].depth==n-1){r.parent=e[t],e[t].children.push(r);break}if(!r.parent)throw`Line ${i} invalid hierarchy, no parent found`}let t=this.mapTerms.get(o);t?t.push(r):this.mapTerms.set(o,[r])}e.push(r)}}debugString(t){let e=[],i=t=>{e.push("* ".repeat(t.depth)+`<${t.uri}> "${t.label}"`);for(let e of t.children)i(e)};return i(t),e.join("\n")}}var Ke,$e,Ze,Je;!function(t){t[t.Strong=0]="Strong",t[t.Medium=1]="Medium",t[t.Weak=2]="Weak"}(Ke||(Ke={}));class ti{constructor(t,e,i,s){this.packSize=t,this.boxes=e,this.hspace=i,this.vspace=s,this.layout=null,this.wantRatio=t.w/t.h}pack(){let e=[],i=this.boxes.length;for(let s=0;s<i;s++){let n={idxStart:s,springs:t.anyArray(Ke.Weak,i)};n.hash=n.idxStart+"/"+n.springs,this.processCandidate(n),e.push(n)}e=e.sort(((t,e)=>t.score-e.score)).slice(0,100);for(let t=100;t>0;t--){let t=new Set;for(let i of e)t.add(i.hash);let s=e.slice(0);for(let n of e)for(let e=0;e<i;e++)if(e!=n.idxStart)for(let i of[Ke.Strong,Ke.Medium,Ke.Weak])if(n.springs[e]!=i){let o={idxStart:n.idxStart,springs:n.springs.slice(0)};if(o.springs[e]=i,o.hash=o.idxStart+"/"+o.springs,t.has(o.hash))continue;this.processCandidate(o),s.push(o)}s=s.sort(((t,e)=>t.score-e.score)).slice(0,100);let n=!0;for(let t=0;t<e.length&&t<s.length;t++)if(e[t].hash!=s[t].hash){n=!1;break}if(!n)break;e=s}let s=e[0];this.outline=s.outline,this.layout=s.layout;let n=t.min(this.layout.map((t=>t.y)));for(let t of this.layout)t.y-=n;return!0}processCandidate(e){let i=this.boxes.length;e.layout=this.boxes.map((t=>new Z(0,0,t.w,t.h)));let s=t.booleanArray(!1,i);s[e.idxStart]=!0;let n=(t,n)=>{let o=e.layout[t],l=null;for(let n=t+1;n<i;n++)if(s[n]){let t=e.layout[n],i=[];if(t.minX()>0&&i.push({y:t.midY()-this.vspace,x1:0,x2:t.minX()-this.hspace}),i.push({y:t.minY()-this.vspace,x1:Math.max(0,t.minX()-this.hspace),x2:t.maxX()+this.hspace}),i.push({y:t.minY()-this.vspace+.5*o.h,x1:t.maxX()+this.hspace,x2:Number.POSITIVE_INFINITY}),null==l)l=i;else for(let t of i)this.mergeSegmentAbove(l,t)}let r=0,a=Number.NEGATIVE_INFINITY;for(let t=0;t<l.length;t++){let e=l[t].x1,i=Number.POSITIVE_INFINITY;for(let s=t;s<l.length&&(i=Math.min(i,l[s].y),!(o.w<l[s].x2-e));s++);if(i>a&&([r,a]=[e,i]),n==Ke.Strong)break;if(n==Ke.Medium&&e>.5*this.packSize.w)break}o.x=r,o.y=a-o.h,s[t]=!0},o=(t,i)=>{let n=e.layout[t],o=null;for(let i=t-1;i>=0;i--)if(s[i]){let t=e.layout[i],s=[];if(t.minX()>0&&s.push({y:t.midY()+this.vspace,x1:0,x2:t.minX()-this.hspace}),s.push({y:t.maxY()+this.vspace,x1:Math.max(0,t.minX()-this.hspace),x2:t.maxX()+this.hspace}),s.push({y:t.maxY()+this.vspace-.5*n.h,x1:t.maxX()+this.hspace,x2:Number.POSITIVE_INFINITY}),null==o)o=s;else for(let t of s)this.mergeSegmentBelow(o,t)}let l=0,r=Number.POSITIVE_INFINITY;for(let t=0;t<o.length;t++){let e=o[t].x1,s=Number.NEGATIVE_INFINITY;for(let i=t;i<o.length&&(s=Math.max(s,o[i].y),!(n.w<o[i].x2-e));i++);if(s<r&&([l,r]=[e,s]),i==Ke.Strong)break;if(i==Ke.Medium&&e>.5*this.packSize.w)break}n.x=l,n.y=r,s[t]=!0};for(let t=1;t<i;t++){let s=e.idxStart-t,l=e.idxStart+t;s>=0&&n(s,e.springs[s]),l<i&&o(l,e.springs[l])}let l=t.max(e.layout.map((t=>t.maxX()))),r=t.min(e.layout.map((t=>t.minY()))),a=t.max(e.layout.map((t=>t.maxY())));e.outline=new $(l-0,a-r);let h=e.outline.w/e.outline.h;e.score=Math.abs(h-this.wantRatio)*(e.outline.w+e.outline.h),e.score+=t.sum(e.layout.map((t=>t.x)));for(let t=0;t<e.layout.length-1;t++)e.score+=Math.max(0,e.layout[t].minY()-e.layout[t].maxY())}mergeSegmentAbove(t,e){for(let i of t){if(e.x1>=i.x1&&e.x1<=i.x2&&e.x2>=i.x1&&e.x2<=i.x2){if(e.y>i.y)return;t.push({y:i.y,x1:e.x2,x2:i.x2}),i.x2=e.x1;break}e.x1>=i.x1&&e.x1<=i.x2&&(e.y<i.y?i.x2=e.x1:e.x1=i.x2),e.x2>=i.x1&&e.x2<=i.x2&&(e.y<i.y?i.x1=e.x2:e.x2=i.x1)}for(let e=t.length-1;e>=0;e--)t[e].x1>=t[e].x2&&t.splice(e,1);e.x1<e.x2&&(t.push(e),t.sort(((t,e)=>t.x1-e.x1)))}mergeSegmentBelow(t,e){for(let i of t){if(e.x1>=i.x1&&e.x1<=i.x2&&e.x2>=i.x1&&e.x2<=i.x2){if(e.y<i.y)return;t.push({y:i.y,x1:e.x2,x2:i.x2}),i.x2=e.x1;break}e.x1>=i.x1&&e.x1<=i.x2&&(e.y>i.y?i.x2=e.x1:e.x1=i.x2),e.x2>=i.x1&&e.x2<=i.x2&&(e.y>i.y?i.x1=e.x2:e.x2=i.x1)}for(let e=t.length-1;e>=0;e--)t[e].x1>=t[e].x2&&t.splice(e,1);e.x1<e.x2&&(t.push(e),t.sort(((t,e)=>t.x1-e.x1)))}}!function(t){t[t.Name=0]="Name",t[t.Quantity=1]="Quantity",t[t.Identifier=2]="Identifier",t[t.Meta=3]="Meta"}($e||($e={}));class ei{constructor(t,e,i){this.mixture=t,this.measure=e,this.policy=i,this.norm=null,this.width=0,this.height=0,this.components=[],this.minBoxSize=null,this.showCollapsors=!1,this.collapsedBranches=[],this.packBranches=null,this.includeIdentifiers=!0,this.scale=i.data.pointScale,this.nameFontSize=.5*this.scale,this.limitStructW=this.limitStructH=10*this.scale,this.hardwrapName=12*this.scale,this.softwrapName=8*this.scale}arrange(){this.createComponents(),this.layoutSubComponents(0),this.contractComponents();let t=null;for(let e of this.components)t=t?t.union(e.boundary):e.boundary;for(let e of this.components)if(e.boundary.x-=t.x,e.boundary.y-=t.y,e.molLayout){let t=e.boundary,i=e.molBox;e.molLayout.squeezeInto(t.x+i.x,t.y+i.y,i.w,i.h)}this.width=t.w,this.height=t.h}scaleComponents(t){if(1!=t){this.scale*=t,this.width*=t,this.height*=t;for(let e of this.components){if(e.boundary.scaleBy(t),e.outline.scaleBy(t),e.molBox&&(e.molBox.scaleBy(t),e.molLayout)){let t=e.boundary.x+e.molBox.x,i=e.boundary.y+e.molBox.y;e.molLayout.squeezeInto(t,i,e.molBox.w,e.molBox.h)}e.nameBox&&e.nameBox.scaleBy(t),e.collapseBox&&e.collapseBox.scaleBy(t),e.fontSize*=t}}}findComponent(e){for(let i=0;i<this.components.length;i++)if(t.equals(this.components[i].origin,e))return i;return-1}static formatQuantity(t){let e=t=>{if(null==t)return"";if(t>1e4)return Math.round(t).toString();let e=t.toPrecision(6);if(e.indexOf("e")>=0||e.indexOf(".")<0)return e;for(;;){if(!e.endsWith("0")){if(e.endsWith(".")){e=e.substring(0,e.length-1);break}break}e=e.substring(0,e.length-1)}return e};if(t.ratio)return 2==t.ratio.length?e(t.ratio[0])+"/"+e(t.ratio[1]):null;if(null==t.quantity)return null;let i="";if(t.relation&&"="!=t.relation){let e=t.relation;">="==e?e="":"<="==e&&(e=""),i+=e}if(t.quantity instanceof Array){if(0==t.quantity.length)return;i+=e(t.quantity[0]),t.quantity.length>=2&&(i+=" - "+e(t.quantity[1]))}else i+=e(t.quantity),t.error&&(i+="  "+e(t.error));return t.units&&(t.units.startsWith("%")||(i+=" "),i+=t.units),i}formatNormQuantity(t){if(!this.norm)return;let e=this.norm.findNote(t);if(!e||!e.concQuantity)return;let i={quantity:e.concQuantity,error:e.concError,units:e.concUnits,relation:e.concRelation};return ei.formatQuantity(i)}createComponents(){let e=(i,s,n)=>{let o={origin:i,content:s,parentIdx:n},l=this.components.push(o)-1;o.isCollapsed=!1;for(let e of this.collapsedBranches)t.equals(e,o.origin)&&(o.isCollapsed=!0);if(s.contents&&!o.isCollapsed)for(let n=0;n<s.contents.length;n++){let o=t.append(i,n);e(o,s.contents[n],l)}};e([],this.mixture.mixfile,-1);let i=.25*this.scale;for(let[e,s]of this.components.entries()){let e=s.content;if(e.molfile&&(s.mol=Ut.readUnknown(e.molfile)),s.mol){s.molLayout=new He(s.mol,this.measure,this.policy),s.molLayout.arrange(),s.molLayout.squeezeInto(0,0,this.limitStructW,this.limitStructH);let t=s.molLayout.determineBoundary();s.molBox=new Z(i,i,Math.ceil(t[2]-t[0]),Math.ceil(t[3]-t[1]))}else s.molBox=Z.zero();s.nameLines=[],e.name&&this.wrapSplitName(s.nameLines,e.name,0,$e.Name);let n=ei.formatQuantity(e);if(n&&s.nameLines.push({text:n,col:0,source:$e.Quantity}),n=this.formatNormQuantity(s.origin),n&&s.nameLines.push({text:`(${n})`,col:8421504,source:$e.Quantity}),this.includeIdentifiers&&e.identifiers)for(let t in e.identifiers){let i=t+" ",n=e.identifiers[t];if(n instanceof Array)for(let t=0;t<n.length;t++)i+=(0==t?"":", ")+n[t];else i+=n;s.nameLines.push({text:this.truncateEllipsis(i),col:4325502,source:$e.Identifier})}if(e.metadata)for(let i of e.metadata){let e=e=>{if("number"==typeof e)return h(e,4);if(!Qe.main)return e;let i=Qe.main.getBranch(e);return t.notBlank(i)?i[0].label:e},n=[];n=Array.isArray(i)?i.map((t=>e(t))):[e(i)],s.nameLines.push({text:n.join(" "),col:11144,source:$e.Meta})}s.nameBox=new Z(i,i),s.fontSize=this.nameFontSize;for(let t=0;t<s.nameLines.length;t++){let e=this.measure.measureText(s.nameLines[t].text,s.fontSize);s.nameBox.w=Math.max(s.nameBox.w,e[0]),s.nameBox.h+=e[1]+(t>0?2*e[2]:0)}if(s.outline=Z.zero(),s.outline.w=Math.max(s.molBox.w,s.nameBox.w)+2*i,s.outline.h=s.molBox.h+s.nameBox.h+2*i,s.molBox.notEmpty()&&s.nameBox.notEmpty()&&(s.outline.h+=i,s.nameBox.y+=s.molBox.h+i,s.molBox.w=s.nameBox.w=Math.max(s.molBox.w,s.nameBox.w)),this.minBoxSize){let t=this.minBoxSize,e=t.w-s.outline.w,i=t.h-s.outline.h;e>0&&(s.outline.w+=e,s.molBox.w+=e),i>0&&(s.outline.h+=i,s.molBox.h+=i,s.nameBox.y+=i)}if(s.boundary=s.outline.clone(),(this.showCollapsors||s.isCollapsed)&&t.notBlank(s.content.contents)){let t=.05*this.scale,e=.3*this.scale;s.collapseBox=new Z(s.boundary.maxX()+t,s.boundary.midY()-.5*e,e,e),s.boundary.w+=t+e}}}layoutSubComponents(t){let e=[t],i=[],s=[],n=0,o=0;for(let l=t+1;l<this.components.length;l++){if(this.components[l].parentIdx!=t)continue;let r=this.layoutSubComponents(l);if(0==r.length)continue;let a=null;for(let t of r){e.push(t);let i=this.components[t].boundary;a=a?a.union(i):i}i.push(r),s.push(a),n=Math.max(n,a.w),o+=a.h}if(0==i.length)return e;let l=1*this.scale,r=.5*this.scale;o+=r*(i.length-1);let a=this.components[t].boundary,h=a.maxX()+l;if(this.packBranches&&i.length>2&&o>this.packBranches.h){let t=this.packBranches.clone();for(let e of s)t.h=Math.max(t.h,e.h);let n=new ti(t,s,r,r);if(n.pack()){let t=a.midY()-.5*n.outline.h;for(let e=0;e<i.length;e++){let o=n.layout[e],l=h-s[e].x+o.x,r=t-s[e].y+o.y;for(let t of i[e])this.components[t].boundary.x+=l,this.components[t].boundary.y+=r}return e}}let u=a.midY()-.5*o;for(let t=0;t<i.length;t++){let e=h-s[t].x,n=u-s[t].y;for(let s of i[t])this.components[s].boundary.x+=e,this.components[s].boundary.y+=n;u+=s[t].h+r}return e}contractComponents(){let e=[];for(let t=0;t<this.components.length;t++){e.push([]);for(let i=this.components[t].parentIdx;i>=0;i=this.components[i].parentIdx)e[i].push(t)}let i=1*this.scale,s=.25*this.scale;for(;;){let n=!1;for(let o=1;o<e.length;o++){let l=this.components[o].parentIdx,r=this.components[l].boundary.maxX()+i,a=this.components[o].boundary.minX()-r;if(a<1)continue;let h=[o,...e[o]],u=t.identity0(e.length).filter((t=>!h.includes(t)));for(let t of h){let e=this.components[t].boundary.withGrow(s,s);for(let t of u){let i=this.components[t].boundary;i.minX()>e.maxX()||e.minY()>i.maxY()||e.maxY()<i.minY()||(a=Math.min(a,e.minX()-i.maxX()))}}if(a>1){for(let t of h)this.components[t].boundary.x-=a;n=!0}}if(!n)break}}wrapSplitName(e,i,s,n){if(!i)return;let o=Xe.measureWidths(i,this.nameFontSize);if(t.last(o)<=this.softwrapName)return void e.push({text:i,col:s,source:n});let l=0;for(;o[l]<this.softwrapName;l++);for(;o[l]<this.hardwrapName;l++){let t=i.charAt(l);if(" ,;-/".includes(t)){l++;break}}e.push({text:i.substring(0,l).trim(),col:s,source:n}),this.wrapSplitName(e,i.substring(l).trim(),s,n)}truncateEllipsis(e){let i=Xe.measureWidths(e,this.nameFontSize);if(t.last(i)<=this.hardwrapName)return e;let s=Xe.measureText("...",this.nameFontSize)[0],n=1;for(;n<e.length&&!(i[n]+s>this.hardwrapName);n++);return e.substring(0,n)+"..."}}!function(t){t[t.Centre=0]="Centre",t[t.Left=1]="Left",t[t.Right=2]="Right",t[t.Baseline=0]="Baseline",t[t.Middle=4]="Middle",t[t.Top=8]="Top",t[t.Bottom=16]="Bottom"}(Ze||(Ze={})),function(t){t[t.Line=1]="Line",t[t.Rect=2]="Rect",t[t.Oval=3]="Oval",t[t.Path=4]="Path",t[t.Text=5]="Text",t[t.TextNative=6]="TextNative"}(Je||(Je={}));class ii{constructor(t){this.prettyPrint=t,this.lines=[],this.depth=0}spool(t){(null==t?void 0:t.length)>0&&this.lines.push(t)}start(t){this.prettyPrint&&this.depth>0&&this.lines.push("  ".repeat(this.depth)),this.spool(t)}stop(t){this.spool(t),this.prettyPrint&&this.lines.push("\n")}whole(t){this.prettyPrint&&this.depth>0&&this.lines.push("  ".repeat(this.depth)),this.spool(t),this.prettyPrint&&this.lines.push("\n")}attr(t,e){var i;if("number"==typeof e){e=e.toFixed(4);let t=null!==(i=/^(.*\.\d*?[1-9]+)0+$/.exec(e))&&void 0!==i?i:/^(.*)\.0+$/.exec(e);t&&(e=t[1])}this.spool(` ${t}="${e}"`)}inc(){this.depth++}dec(){this.depth--}toString(){return this.lines.join("")}}class si{constructor(e){this.types=[],this.prims=[],this.width=0,this.height=0,this.offsetX=0,this.offsetY=0,this.scale=1,this.density=1,this.charMissing=!1,this.lowX=null,this.lowY=null,this.highX=null,this.highY=null;const i=Xe.main;if(this.charMask=t.booleanArray(!1,i.UNICODE.length),null!=e){null!=e.size&&(this.width=e.size[0],this.height=e.size[1]),null!=e.types&&(this.types=e.types),null!=e.prims&&(this.prims=e.prims);for(let t of this.prims)if(t.primClass==Je.Text){let{txt:e}=t;for(let t=0;t<e.length;t++){let s=i.getIndex(e.charAt(t));s>=0?this.charMask[s]=!0:this.charMissing=!0}}}}drawLine(t,e,i,s,n,o){null==o&&(o=1);let l=this.findOrCreateType({primClass:Je.Line,thickness:o,colour:n});const r=.5*o;this.updateBounds(Math.min(t,i)-r,Math.min(e,s)-r),this.updateBounds(Math.max(t,i)+r,Math.max(e,s)+r),this.prims.push({primClass:Je.Line,typeidx:l,x1:t,y1:e,x2:i,y2:s})}drawRect(t,e,i,s,n,o,l){null==n&&(n=si.NOCOLOUR),null==l&&(l=si.NOCOLOUR),null==o&&(o=1);let r=this.findOrCreateType({primClass:Je.Rect,edgeCol:n,fillCol:l,thickness:o});const a=.5*o;this.updateBounds(t-a,e-a),this.updateBounds(t+i+a,e+s+a),this.prims.push({primClass:Je.Rect,typeidx:r,x:t,y:e,w:i,h:s})}drawOval(t,e,i,s,n,o,l){null==n&&(n=si.NOCOLOUR),null==l&&(l=si.NOCOLOUR),null==o&&(o=1);const r=.5*o;this.updateBounds(t-i-r,e-s-r),this.updateBounds(t+i+r,e+s+r);let a=this.findOrCreateType({primClass:Je.Oval,edgeCol:n,fillCol:l,thickness:o});this.prims.push({primClass:Je.Oval,typeidx:a,cx:t,cy:e,rw:i,rh:s})}drawPath(e,i,s,n,o,l,r,a){null==o&&(o=si.NOCOLOUR),null==r&&(r=si.NOCOLOUR),null==l&&(l=1),null==a&&(a=!1);const h=.5*l;for(let t=0;t<e.length;t++)this.updateBounds(e[t]-h,i[t]-h),0!=h&&this.updateBounds(e[t]+h,i[t]+h);let u=this.findOrCreateType({primClass:Je.Path,edgeCol:o,fillCol:r,thickness:l,hardEdge:a});this.prims.push({primClass:Je.Path,typeidx:u,count:e.length,x:t.duplicate(e),y:t.duplicate(i),ctrl:s&&[...s],closed:n})}drawPoly(t,e,i,s,n,o){this.drawPath(t,e,null,!0,i,s,n,o)}drawText(e,i,s,n,o,l,r){null==l&&(l=Ze.Left|Ze.Baseline),null==r&&(r=0);let a=1,h=0;0!=r&&([a,h]=[Math.cos(r*S),Math.sin(r*S)]);const u=Xe.main;for(let t=0;t<s.length;t++){let e=u.getIndex(s.charAt(t));e>=0?this.charMask[e]=!0:this.charMissing=!0}let m=u.measureText(s,n),d=0,c=0,p=0;l&Ze.Left||(p=l&Ze.Right?-m[0]:-.5*m[0]),0!=p&&(d+=p*a,c+=p*h);let f=0;l&Ze.Middle?f=.5*m[1]:l&Ze.Top?f=m[1]:l&Ze.Bottom&&(f=-m[2]),0!=f&&(d-=f*h,c+=f*a);let g=0,b=0,y=0,x=0,A=0;for(let e=0;e<s.length;e++){let i=s.charAt(e),n=u.getIndex(i);if(n>=0){let o=u.getOutlineX(n),l=u.getOutlineY(n);g=Math.min(g,A+t.min(o)),y=Math.max(y,A+t.max(o)),b=Math.min(b,-t.max(l)),x=Math.max(x,-t.min(l)),A+=u.HORIZ_ADV_X[n],e<s.length-1&&(A+=u.getKerning(i,s.charAt(e+1)))}else A+=u.MISSING_HORZ}const v=n*u.INV_UNITS_PER_EM;if(0==r)this.updateBounds(e+d+g*v,i+c+b*v),this.updateBounds(e+d+y*v,i+c+x*v);else{let t=g*v,s=b*v,n=y*v,o=x*v;this.updateBounds(e+d+t*a-s*h,i+c+t*h+s*a),this.updateBounds(e+d+n*a-s*h,i+c+n*h+s*a),this.updateBounds(e+d+n*a-o*h,i+c+n*h+o*a),this.updateBounds(e+d+t*a-o*h,i+c+t*h+o*a)}let M=this.findOrCreateType({primClass:Je.Text,size:n,colour:o});this.prims.push({primClass:Je.Text,typeidx:M,x:e+d,y:i+c,txt:s,direction:r})}drawTextNative(t,e,i,s,n,o,l,r){r||(r={}),null==l&&(l=Ze.Left|Ze.Baseline);let a=Xe.main.measureTextNative(i,s,n,r);l&Ze.Left||(l&Ze.Right?t-=a[0]:t-=.5*a[0]),l&Ze.Middle?e+=.5*a[1]:l&Ze.Top?e+=a[1]:l&Ze.Bottom&&(e-=a[2]),this.updateBounds(t,e-a[1]),this.updateBounds(t+a[0],e+a[2]);let h=this.findOrCreateType({primClass:Je.TextNative,family:s,size:n,colour:o,opt:r});this.prims.push({primClass:Je.TextNative,typeidx:h,x:t,y:e,txt:i})}boundLowX(){return this.lowX}boundLowY(){return this.lowY}boundHighX(){return this.highX}boundHighY(){return this.highY}getBounds(){return new Z(this.lowX,this.lowY,this.highX-this.lowX,this.highY-this.lowY)}measure(){this.width=Math.ceil(this.highX-this.lowX),this.height=Math.ceil(this.highY-this.lowY)}normalise(){0==this.lowX&&0==this.lowY||this.transformPrimitives(-this.lowX,-this.lowY,1,1),this.width=Math.ceil(this.highX-this.lowX),this.height=Math.ceil(this.highY-this.lowY)}setSize(t,e){this.width=t,this.height=e}transformIntoBox(t){this.transformPrimitives(-this.lowX,-this.lowY,1,1);let e=Math.ceil(this.highX-this.lowX),i=Math.ceil(this.highY-this.lowY),s=1;if(e>t.w){let n=t.w/e;e=t.w,i*=n,s*=n}if(i>t.h){let n=t.h/i;i=t.h,e*=n,s*=n}let n=.5*(t.w-e),o=.5*(t.h-i);this.transformPrimitives(t.x+n,t.y+o,s,s)}scaleExtent(t,e){let i=this.highX-this.lowX,s=this.highY-this.lowY;if(i<=t&&s<=e)return;let n=Math.min(t/i,e/s);this.transformPrimitives(0,0,n,n)}transformPrimitives(t,e,i,s){if(0==t&&0==e&&1==i&&1==s)return;for(let n of this.prims){const o=n.primClass;if(o==Je.Line){let o=n;o.x1=t+o.x1*i,o.y1=e+o.y1*s,o.x2=t+o.x2*i,o.y2=e+o.y2*s}else if(o==Je.Rect){let o=n;o.x=t+o.x*i,o.y=e+o.y*s,o.w=o.w*i,o.h=o.h*s}else if(o==Je.Oval){let o=n;o.cx=t+o.cx*i,o.cy=e+o.cy*s,o.rw*=i,o.rh*=s}else if(o==Je.Path){let o=n,l=o.count,r=o.x,a=o.y;for(let n=0;n<l;n++)r[n]=t+r[n]*i,a[n]=e+a[n]*s}else if(o==Je.Text||o==Je.TextNative){let o=n;o.x=t+o.x*i,o.y=e+o.y*s}}let n=.5*(i+s);if(1!=n)for(let t of this.types){const e=t.primClass;e==Je.Line||e==Je.Rect||e==Je.Oval||e==Je.Path?t.thickness*=n:(e==Je.Text||e==Je.TextNative)&&(t.size*=n)}this.lowX=t+this.lowX*i,this.lowY=e+this.lowY*s,this.highX=t+this.highX*i,this.highY=e+this.highY*s}renderInto(t){let e=a(t,"canvas",{width:this.width,height:this.height});return this.renderCanvas(e),e}renderCanvas(t,e){let i=t.getContext("2d");e&&i.clearRect(0,0,t.width,t.height);let s=this.width,n=this.height;this.density=F(),t.style.width=s+"px",t.style.height=n+"px",t.width=s*this.density,t.height=n*this.density,this.renderContext(i)}renderContext(t){t.save(),t.scale(this.density,this.density),this.typeObj=[];for(let t=0;t<this.types.length;t++){let e=this.types[t];e.primClass==Je.Line?this.typeObj[t]=this.setupTypeLine(e):e.primClass==Je.Rect?this.typeObj[t]=this.setupTypeRect(e):e.primClass==Je.Oval?this.typeObj[t]=this.setupTypeOval(e):e.primClass==Je.Path?this.typeObj[t]=this.setupTypePath(e):e.primClass==Je.Text?this.typeObj[t]=this.setupTypeText(e):e.primClass==Je.TextNative&&(this.typeObj[t]=this.setupTypeTextNative(e))}for(let e=0;e<this.prims.length;e++){let i=this.prims[e];i.primClass==Je.Line?this.renderLine(t,i):i.primClass==Je.Rect?this.renderRect(t,i):i.primClass==Je.Oval?this.renderOval(t,i):i.primClass==Je.Path?this.renderPath(t,i):i.primClass==Je.Text?this.renderText(t,i):i.primClass==Je.TextNative&&this.renderTextNative(t,i)}t.restore()}createSVG(t=!1,e=!1){let i=new ii(t);return i.start('<svg xmlns="http://www.w3.org/2000/svg"'),e&&i.attr("xmlns:xlink","http://www.w3.org/1999/xlink"),i.attr("width",this.width),i.attr("height",this.height),i.attr("viewBox",`0 0 ${this.width} ${this.height}`),i.stop(">"),i.inc(),this.renderSVG(i,e),i.dec(),i.whole("</svg>"),i.toString()}renderSVG(t,e=!1){this.typeObj=[];const i=Xe.main;t.whole("<defs>"),t.inc(),this.charMissing&&(t.start("<path"),t.attr("id","missing"),t.attr("d",i.MISSING_DATA),t.attr("edge","none"),t.stop("/>"));for(let e=0;e<i.UNICODE.length;e++)this.charMask[e]&&(t.start("<path"),t.attr("id","char"+e),t.attr("d",i.GLYPH_DATA[e]),t.attr("edge","none"),t.stop("/>"));t.dec(),t.whole("</defs>");for(let t=0;t<this.types.length;t++){let e=this.types[t];e.primClass==Je.Line?this.typeObj[t]=this.setupTypeLine(e):e.primClass==Je.Rect?this.typeObj[t]=this.setupTypeRect(e):e.primClass==Je.Oval?this.typeObj[t]=this.setupTypeOval(e):e.primClass==Je.Path?this.typeObj[t]=this.setupTypePath(e):e.primClass==Je.Text?this.typeObj[t]=this.setupTypeText(e):e.primClass==Je.TextNative&&(this.typeObj[t]=this.setupTypeTextNative(e))}for(let i=0;i<this.prims.length;){let s=this.prims[i],n=1;if(s.primClass!=Je.Path&&s.primClass!=Je.Text&&s.primClass!=Je.TextNative)for(;i+n<this.prims.length&&this.prims[i+n].primClass==s.primClass&&this.prims[i+n].typeidx==s.typeidx;n++);s.primClass==Je.Line?1==n?this.svgLine1(t,s):this.svgLineN(t,this.prims.slice(i,i+n)):s.primClass==Je.Rect?1==n?this.svgRect1(t,s):this.svgRectN(t,this.prims.slice(i,i+n)):s.primClass==Je.Oval?1==n?this.svgOval1(t,s):this.svgOvalN(t,this.prims.slice(i,i+n)):s.primClass==Je.Path?this.svgPath(t,s):s.primClass==Je.Text?this.svgText(t,s,e):s.primClass==Je.TextNative&&this.svgTextNative(t,s),i+=n}}spool(t){for(let e of this.prims)if(e.primClass==Je.Line){let{typeidx:i,x1:s,y1:n,x2:o,y2:l}=e,{thickness:r,colour:a}=this.types[i];t.drawLine(s,n,o,l,a,r)}else if(e.primClass==Je.Rect){let{typeidx:i,x:s,y:n,w:o,h:l}=e,{edgeCol:r,fillCol:a,thickness:h}=this.types[i];t.drawRect(s,n,o,l,r,h,a)}else if(e.primClass==Je.Oval){let{typeidx:i,cx:s,cy:n,rw:o,rh:l}=e,{edgeCol:r,fillCol:a,thickness:h}=this.types[i];t.drawOval(s,n,o,l,r,h,a)}else if(e.primClass==Je.Path){let{typeidx:i,count:s,x:n,y:o,ctrl:l,closed:r}=e,{edgeCol:a,fillCol:h,thickness:u,hardEdge:m}=this.types[i];t.drawPath(n,o,l,r,a,u,h,m)}else if(e.primClass==Je.Text){let{typeidx:i,x:s,y:n,txt:o,direction:l}=e,{size:r,colour:a}=this.types[i];t.drawText(s,n,o,r,a,null,l)}else if(e.primClass==Je.TextNative){let{typeidx:i,x:s,y:n,txt:o}=e,{family:l,size:r,colour:a}=this.types[i];t.drawTextNative(s,n,o,l,r,a)}}setupTypeLine(t){let e=t.thickness*this.scale,i=t.colour;return{primClass:t.primClass,thickness:e,colour:i}}setupTypeRect(t){let e=t.edgeCol,i=t.fillCol,s=t.thickness*this.scale;return{primClass:t.primClass,edgeCol:e,fillCol:i,thickness:s}}setupTypeOval(t){let e=t.edgeCol,i=t.fillCol,s=t.thickness*this.scale;return{primClass:t.primClass,edgeCol:e,fillCol:i,thickness:s}}setupTypePath(t){let e=t.edgeCol,i=t.fillCol,s=t.thickness*this.scale,n=t.hardEdge;return{primClass:t.primClass,edgeCol:e,fillCol:i,thickness:s,hardEdge:n}}setupTypeText(t){let e=t.size*this.scale,i=t.colour;return{primClass:t.primClass,colour:i,size:e}}setupTypeTextNative(t){let e=t.family,i=t.size*this.scale,s=t.colour,n=t.opt;return{primClass:t.primClass,colour:s,family:e,size:i,opt:n}}renderLine(t,e){let{x1:i,y1:s,x2:n,y2:o}=e,{colour:l,thickness:r}=this.typeObj[e.typeidx];i=this.offsetX+this.scale*i,s=this.offsetY+this.scale*s,n=this.offsetX+this.scale*n,o=this.offsetY+this.scale*o,null!=l&&(t.beginPath(),t.moveTo(i,s),t.lineTo(n,o),t.strokeStyle=c(l),t.lineWidth=r,t.lineCap="round",t.stroke())}renderRect(t,e){let{x:i,y:s,w:n,h:o}=e,{edgeCol:l,fillCol:r,thickness:a}=this.typeObj[e.typeidx];i=this.offsetX+this.scale*i,s=this.offsetY+this.scale*s,n*=this.scale,o*=this.scale,r!=si.NOCOLOUR&&(t.fillStyle=c(r),t.fillRect(i,s,n,o)),l!=si.NOCOLOUR&&(t.strokeStyle=c(l),t.lineWidth=a,t.lineCap="square",t.strokeRect(i,s,n,o))}renderOval(t,e){let{cx:i,cy:s,rw:n,rh:o}=e,{edgeCol:l,fillCol:r,thickness:a}=this.typeObj[e.typeidx];i=this.offsetX+this.scale*i,s=this.offsetY+this.scale*s,n*=this.scale,o*=this.scale,r!=si.NOCOLOUR&&(t.fillStyle=c(r),t.beginPath(),t.ellipse(i,s,n,o,0,0,2*Math.PI,!0),t.fill()),l!=si.NOCOLOUR&&(t.strokeStyle=c(l),t.lineWidth=a,t.beginPath(),t.ellipse(i,s,n,o,0,0,2*Math.PI,!0),t.stroke())}renderPath(t,e){let{count:i,x:s,y:n,ctrl:o,closed:l}=e,{edgeCol:r,fillCol:a,thickness:h,hardEdge:u}=this.typeObj[e.typeidx];s=[...s],n=[...n];for(let t=0;t<i;t++)s[t]=this.offsetX+this.scale*s[t],n[t]=this.offsetY+this.scale*n[t];for(let e=1;e<=2;e++)if(!(1==e&&a==si.NOCOLOUR||2==e&&r==si.NOCOLOUR)){t.beginPath(),t.moveTo(s[0],n[0]);for(let e=1;e<i;e++)o&&o[e]?e<i-1&&!o[e+1]?(t.quadraticCurveTo(s[e],n[e],s[e+1],n[e+1]),e++):e<i-1&&!o[e+2]&&(t.bezierCurveTo(s[e],n[e],s[e+1],n[e+1],s[e+2],n[e+2]),e+=2):t.lineTo(s[e],n[e]);l&&t.closePath(),1==e?(t.fillStyle=c(a),t.fill()):(t.strokeStyle=c(r),t.lineWidth=h,t.lineCap=u?"square":"round",t.lineJoin=u?"miter":"round",t.stroke())}}renderText(t,e){let{x:i,y:s,txt:n,direction:o}=e,{size:l,colour:r}=this.typeObj[e.typeidx],a=c(r);i=this.offsetX+this.scale*i,s=this.offsetY+this.scale*s;let h=Xe.main,u=l*this.scale/h.UNITS_PER_EM,m=0;for(let e=0;e<n.length;e++){let l=n.charAt(e),r=h.getIndex(l),d=null;if(r<0?(m+=h.MISSING_HORZ,d=h.getMissingPath()):d=h.getGlyphPath(r),d){t.save();let e=0!=o?o*S:0;0==e?t.translate(i+m*u,s):t.translate(i+Math.cos(e)*m*u,s+Math.sin(e)*m*u),t.scale(u,-u),0!=e&&t.rotate(-e),t.fillStyle=a,t.fill(d),t.restore()}m+=h.HORIZ_ADV_X[r],e<n.length-1&&(m+=h.getKerning(l,n.charAt(e+1)))}}renderTextNative(t,e){let{x:i,y:s,txt:n}=e,{size:o,colour:l,family:r,opt:a}=this.typeObj[e.typeidx],h=c(l);i=this.offsetX+this.scale*i,s=this.offsetY+this.scale*s,t.save();let u="";a.bold&&(u+="bold "),a.italic&&(u+="italic "),t.font=u+o*this.scale+"px "+r,t.fillStyle=h,t.fillText(n,i,s),t.restore()}svgLine1(t,e){let{x1:i,y1:s,x2:n,y2:o}=e,{colour:l,thickness:r}=this.typeObj[e.typeidx];i=this.offsetX+this.scale*i,s=this.offsetY+this.scale*s,n=this.offsetX+this.scale*n,o=this.offsetY+this.scale*o,l!=si.NOCOLOUR&&(t.start("<line"),t.attr("x1",i),t.attr("y1",s),t.attr("x2",n),t.attr("y2",o),this.defineSVGStroke(t,l),t.attr("stroke-width",r),t.attr("stroke-linecap","round"),t.stop("/>"))}svgLineN(t,e){let{colour:i,thickness:s}=this.typeObj[e[0].typeidx];t.start("<g"),this.defineSVGStroke(t,i),t.attr("stroke-width",s),t.attr("stroke-linecap","round"),t.stop(">"),t.inc();for(let i of e){let{x1:e,y1:s,x2:n,y2:o}=i;e=this.offsetX+this.scale*e,s=this.offsetY+this.scale*s,n=this.offsetX+this.scale*n,o=this.offsetY+this.scale*o,t.start("<line"),t.attr("x1",e),t.attr("y1",s),t.attr("x2",n),t.attr("y2",o),t.stop("/>")}t.dec(),t.whole("</g>")}svgRect1(t,e){let{x:i,y:s,w:n,h:o}=e,{edgeCol:l,fillCol:r,thickness:a}=this.typeObj[e.typeidx];i=this.offsetX+this.scale*i,s=this.offsetY+this.scale*s,n*=this.scale,o*=this.scale,t.start("<rect"),t.attr("x",i),t.attr("y",s),t.attr("width",n),t.attr("height",o),this.defineSVGStroke(t,l),l!=si.NOCOLOUR&&(t.attr("stroke-width",a),t.attr("stroke-linecap","square")),this.defineSVGFill(t,r),t.stop("/>")}svgRectN(t,e){let{edgeCol:i,fillCol:s,thickness:n}=this.typeObj[e[0].typeidx];t.start("<g"),this.defineSVGStroke(t,i),i!=si.NOCOLOUR&&(t.attr("stroke-width",n),t.attr("stroke-linecap","square")),this.defineSVGFill(t,s),t.stop(">"),t.inc();for(let i of e){let{x:e,y:s,w:n,h:o}=i;e=this.offsetX+this.scale*e,s=this.offsetY+this.scale*s,n*=this.scale,o*=this.scale,t.start("<rect"),t.attr("x",e),t.attr("y",s),t.attr("width",n),t.attr("height",o),t.stop("/>")}t.dec(),t.whole("</g>")}svgOval1(t,e){let{cx:i,cy:s,rw:n,rh:o}=e,{edgeCol:l,fillCol:r,thickness:a}=this.typeObj[e.typeidx];i=this.offsetX+this.scale*i,s=this.offsetY+this.scale*s,n*=this.scale,o*=this.scale,t.start("<ellipse"),t.attr("cx",i),t.attr("cy",s),t.attr("rx",n),t.attr("ry",o),this.defineSVGStroke(t,l),l!=si.NOCOLOUR&&t.attr("stroke-width",a),this.defineSVGFill(t,r),t.stop("/>")}svgOvalN(t,e){let{edgeCol:i,fillCol:s,thickness:n}=this.typeObj[e[0].typeidx];t.start("<g"),this.defineSVGStroke(t,i),i!=si.NOCOLOUR&&t.attr("stroke-width",n),this.defineSVGFill(t,s),t.stop(">"),t.inc();for(let i of e){let{cx:e,cy:s,rw:n,rh:o}=i;e=this.offsetX+this.scale*e,s=this.offsetY+this.scale*s,n*=this.scale,o*=this.scale,t.start("<ellipse"),t.attr("cx",e),t.attr("cy",s),t.attr("rx",n),t.attr("ry",o),t.stop("/>")}t.dec(),t.whole("</g>")}svgPath(t,e){let{count:i,x:s,y:n,ctrl:o,closed:l}=e,{edgeCol:r,fillCol:a,thickness:h,hardEdge:u}=this.typeObj[e.typeidx];s=[...s],n=[...n];for(let t=0;t<i;t++)s[t]=this.offsetX+this.scale*s[t],n[t]=this.offsetY+this.scale*n[t];let m="M "+s[0]+" "+n[0],d=1;for(;d<i;)o&&o[d]?o[d]&&d<i-1&&!o[d+1]?(m+=" Q "+s[d]+" "+n[d]+" "+s[d+1]+" "+n[d+1],d+=2):o[d]&&d<i-2&&o[d+1]&&!o[d+2]?(m+=" C "+s[d]+" "+n[d]+" "+s[d+1]+" "+n[d+1]+" "+s[d+2]+" "+n[d+2],d+=3):d++:(m+=" L "+s[d]+" "+n[d],d++);l&&(m+=" Z"),t.start("<path"),t.attr("d",m),this.defineSVGStroke(t,r),r!=si.NOCOLOUR&&(t.attr("stroke-width",h),t.attr("stroke-linejoin",u?"miter":"round"),t.attr("stroke-linecap",u?"square":"round")),this.defineSVGFill(t,a),t.stop("/>")}svgText(t,e,i=!0){let{x:s,y:n,txt:o,direction:l}=e,{size:r,colour:a}=this.typeObj[e.typeidx];s=this.offsetX+this.scale*s,n=this.offsetY+this.scale*n;let h=Xe.main,u=r*this.scale/h.UNITS_PER_EM;0!=l&&(t.start("<g"),t.attr("transform",`rotate(${l},${s},${n})`),t.stop(">"),t.inc()),t.start("<g"),t.attr("transform","translate("+s+","+n+")"),this.defineSVGFill(t,a),t.stop(">"),t.inc(),t.start("<g"),t.attr("transform","scale("+u+","+-u+")"),t.stop(">"),t.inc();let m=0;for(let e=0;e<o.length;e++){let s=o.charAt(e),n=h.getIndex(s);t.start("<use");let l=n<0?"#missing":"#char"+n;i?t.attr("xlink:href",l):t.attr("href",l),t.attr("x",m),t.stop("/>"),n>=0?(m+=h.HORIZ_ADV_X[n],e<o.length-1&&(m+=h.getKerning(s,o.charAt(e+1)))):m+=h.MISSING_HORZ}t.dec(),t.whole("</g>"),t.dec(),t.whole("</g>"),0!=l&&(t.dec(),t.whole("</g>"))}svgTextNative(t,e){let{x:i,y:s,txt:n}=e,{size:o,colour:l,family:r,opt:a}=this.typeObj[e.typeidx];i=this.offsetX+this.scale*i,s=this.offsetY+this.scale*s;let h=`fill: ${c(l)}; font-family: ${r}; font-size: ${o*this.scale};`;a.bold&&(h+=" font-weight: bold;"),a.italic&&(h+=" font-style: italic;"),t.start("<text"),t.attr("xml:space","preserve"),t.attr("x",i),t.attr("y",s),t.attr("style",h),t.stop(">"+n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")+"</text>")}defineSVGStroke(t,e){if(e==si.NOCOLOUR)return void t.attr("stroke-opacity","0");t.attr("stroke",u(e));let i=m(e);1!=i&&t.attr("stroke-opacity",i)}defineSVGFill(t,e){if(e==si.NOCOLOUR)return void t.attr("fill-opacity","0");t.attr("fill",u(e));let i=m(e);1!=i&&t.attr("fill-opacity",i)}findOrCreateType(t){for(let e=0;e<this.types.length;e++)if(this.types[e].primClass==t.primClass&&Object.keys(t).every((i=>t[i]==this.types[e][i])))return e;return this.types.push(t),this.types.length-1}updateBounds(t,e){if(null==this.lowX)return this.lowX=t,this.lowY=e,this.highX=t,void(this.highY=e);this.lowX=Math.min(this.lowX,t),this.lowY=Math.min(this.lowY,e),this.highX=Math.max(this.highX,t),this.highY=Math.max(this.highY,e)}}si.NOCOLOUR=-1;class ni{constructor(t,e){this.layout=t,this.vg=e,this.mnemonics=null,this.mol=t.getMolecule(),this.policy=t.getPolicy(),this.effects=t.getEffects(),this.scale=t.getScale(),this.invScale=1/this.scale}getMolecule(){return this.mol}getMetaVector(){return this.vg}getLayout(){return this.layout}getPolicy(){return this.policy}getEffects(){return this.effects}draw(){var t,e,i,s,n,o,l,r,a,h,u,m,d;this.drawUnderEffects();let{mol:c,layout:p,effects:f,policy:g,vg:b}=this,y=new Set(f.hideBonds);for(let e=1;e<=c.numBonds;e++)if(c.bondType(e)==Vt.BONDTYPE_INCLINED&&!y.has(e)){let i=c.bondTo(e);if(p.getPoint(i-1).text)continue;for(let s of c.atomAdjBonds(i))if(s!=e&&c.bondType(s)==Vt.BONDTYPE_INCLINED&&c.bondTo(s)==i&&!y.has(s)){let i=p.getLines().find((t=>t.bnum==e)),n=p.getLines().find((t=>t.bnum==s)),o=Math.atan2(i.line.y1-i.line.y2,i.line.x1-i.line.x2),l=Math.atan2(n.line.y1-n.line.y2,n.line.x1-n.line.x2);if(Math.abs(N(o,l))<170*S){this.drawFusedWedge(i,n),null===(t=this.mnemonics)||void 0===t||t.append(Re.Artifact,"Fused",[i.line.x1,i.line.y1,i.line.x2,i.line.y2,n.line.x1,n.line.y1,n.line.x2,n.line.y2]),y.add(e),y.add(s);break}}}for(let t=0;t<p.numLines();t++){let r=p.getLine(t);y.has(r.bnum)||(r.type==Pe.Normal?(b.drawLine(r.line.x1,r.line.y1,r.line.x2,r.line.y2,r.col,r.size),null===(e=this.mnemonics)||void 0===e||e.append(Re.Bond,"L",[r.line.x1,r.line.y1,r.line.x2,r.line.y2])):r.type==Pe.Inclined?(this.drawBondInclined(r),null===(i=this.mnemonics)||void 0===i||i.append(Re.Bond,"I",[r.line.x1,r.line.y1,r.line.x2,r.line.y2])):r.type==Pe.Declined?(this.drawBondDeclined(r),null===(s=this.mnemonics)||void 0===s||s.append(Re.Bond,"D",[r.line.x1,r.line.y1,r.line.x2,r.line.y2])):r.type==Pe.Unknown?(this.drawBondUnknown(r),null===(n=this.mnemonics)||void 0===n||n.append(Re.Bond,"U",[r.line.x1,r.line.y1,r.line.x2,r.line.y2])):r.type==Pe.Dotted||r.type==Pe.DotDir?(this.drawBondDotted(r),null===(o=this.mnemonics)||void 0===o||o.append(Re.Bond,"O",[r.line.x1,r.line.y1,r.line.x2,r.line.y2])):r.type!=Pe.IncDouble&&r.type!=Pe.IncTriple&&r.type!=Pe.IncQuadruple||(this.drawBondIncMulti(r),null===(l=this.mnemonics)||void 0===l||l.append(Re.Bond,"M",[r.line.x1,r.line.y1,r.line.x2,r.line.y2])))}let x=g.data.foreground;for(let t of p.getRings())if(0!=t.theta){var A=G.createBezierEllipse(t.cx,t.cy,t.rw,t.rh,t.theta);b.drawPath(A.px,A.py,A.ctrl,!0,x,t.size,si.NOCOLOUR,!1),null===(r=this.mnemonics)||void 0===r||r.append(Re.Artifact,"Ring",[t.cx,t.cy,t.rw,t.rh,t.theta])}else b.drawOval(t.cx,t.cy,t.rw,t.rh,x,t.size,si.NOCOLOUR),null===(a=this.mnemonics)||void 0===a||a.append(Re.Artifact,"Ring",[t.cx,t.cy,t.rw,t.rh]);for(let t of p.getPaths())b.drawPath(t.px,t.py,t.ctrl,!1,x,t.size,si.NOCOLOUR,!1),null===(h=this.mnemonics)||void 0===h||h.append(Re.Artifact,"Path",[...t.px,...t.py]);for(let t=0;t<p.numPoints();t++){let e=p.getPoint(t);if(f.hideAtoms.has(e.anum))continue;let i=e.text,s=e.oval.cx,n=e.oval.cy,o=e.oval.rw;if(null==i){null===(u=this.mnemonics)||void 0===u||u.append(Re.Atom,".",[s,n]);continue}let l=e.fsz,r=e.col;for(;i.endsWith(".");){let t=o/i.length,e=.15*l;b.drawOval(s+o-t,n,e,e,si.NOCOLOUR,0,r),s-=t,o-=t,i=i.substring(0,i.length-1)}for(;i.startsWith("+");){let t=o/i.length,e=s-o+t,a=n,h=.18*l,u=.1*l;b.drawLine(e-h,a,e+h,a,r,u),b.drawLine(e,a-h,e,a+h,r,u),s+=t,o-=t,i=i.substring(1,i.length)}for(;i.startsWith("-");){let t=o/i.length,e=s-o+t,a=n,h=.18*l,u=.1*l;b.drawLine(e-h,a,e+h,a,r,u),s+=t,o-=t,i=i.substring(1,i.length)}i.length>0?(b.drawText(s,n,i,l,r,Ze.Centre|Ze.Middle,e.rotation||0),null===(m=this.mnemonics)||void 0===m||m.append(Re.Atom,i,[s,n])):null===(d=this.mnemonics)||void 0===d||d.append(Re.Atom,".",[s,n])}this.drawOverEffects()}drawUnderEffects(){var t,e,i;let s=this.mol,n=(this.policy,this.effects),o=this.layout,l=this.scale,r=this.vg;for(let e=0,i=Math.min(n.atomFrameDotSz.length,s.numAtoms);e<i;e++){if(n.hideAtoms.has(e+1))continue;let i=n.atomFrameDotSz[e]*l,s=n.atomFrameCol[e],a=o.getPoint(e),h=a.oval.rw+.1*l,u=a.oval.rh+.1*l,m=Math.ceil(2*h/(3*i)),d=Math.ceil(2*u/(3*i)),c=2*h/m,p=2*u/d;for(let t=0;t<=m;t++){let e=a.oval.cx-h+t*c;r.drawOval(e,a.oval.cy-u,i,i,si.NOCOLOUR,0,s),r.drawOval(e,a.oval.cy+u,i,i,si.NOCOLOUR,0,s)}for(let t=1;t<d;t++){let e=a.oval.cy-u+t*p;r.drawOval(a.oval.cx-h,e,i,i,si.NOCOLOUR,0,s),r.drawOval(a.oval.cx+h,e,i,i,si.NOCOLOUR,0,s)}null===(t=this.mnemonics)||void 0===t||t.append(Re.Effect,"Dot",[a.oval.cx,a.oval.cy,a.oval.rw,a.oval.rh])}for(let t in n.dottedRectOutline){let i=parseInt(t),s=n.dottedRectOutline[t],a=o.getPoint(i-1),h=Math.max(a.oval.rw,.2*l),u=Math.max(a.oval.rh,.2*l),m=.05*l,d=Math.max(1,Math.round(h/(2*m))),c=Math.max(1,Math.round(u/(2*m))),p=2*h/d,f=2*u/c;for(let t=0;t<=d;t++){let e=a.oval.cx-h+t*p;r.drawOval(e,a.oval.cy-u,m,m,si.NOCOLOUR,0,s),r.drawOval(e,a.oval.cy+u,m,m,si.NOCOLOUR,0,s)}for(let t=1;t<c;t++){let e=a.oval.cy-u+t*f;r.drawOval(a.oval.cx-h,e,m,m,si.NOCOLOUR,0,s),r.drawOval(a.oval.cx+h,e,m,m,si.NOCOLOUR,0,s)}null===(e=this.mnemonics)||void 0===e||e.append(Re.Effect,"Rect",[a.oval.cx,a.oval.cy,a.oval.rw,a.oval.rh])}for(let t in n.dottedBondCross){let e=parseInt(t),s=n.dottedBondCross[t],a=0,h=0,u=0,m=0,d=0;for(let t=0;t<o.numLines();t++){let i=o.getLine(t);i.bnum==e&&(a+=i.line.x1,h+=i.line.y1,u+=i.line.x2,m+=i.line.y2,d+=1)}if(d>1){let t=1/d;[a,h,u,m]=[a*t,h*t,u*t,m*t]}let c=u-a,p=m-h,f=.2*l*M(b(c,p)),g=p*f,y=-c*f,x=.5*(a+u),A=.5*(h+m),v=.05*l;for(let t of[-2,-1,1,2]){let e=x+t*g,i=A+t*y;r.drawOval(e,i,v,v,si.NOCOLOUR,0,s)}null===(i=this.mnemonics)||void 0===i||i.append(Re.Effect,"Crossing",[a,h,u,m])}}drawOverEffects(){var t,e;let i=this.mol,s=(this.policy,this.effects),n=this.layout,o=this.scale,l=this.vg;for(let e of s.overlapAtoms){let i=n.getPoint(e-1),s=.2*o;l.drawLine(i.oval.cx-s,i.oval.cy-s,i.oval.cx+s,i.oval.cy+s,16711680,1),l.drawLine(i.oval.cx+s,i.oval.cy-s,i.oval.cx-s,i.oval.cy+s,16711680,1),null===(t=this.mnemonics)||void 0===t||t.append(Re.Effect,"Overlap",[i.oval.cx,i.oval.cy,i.oval.rw,i.oval.rh])}for(let t=0,r=Math.min(s.atomCircleSz.length,i.numAtoms);t<r;t++)if(s.atomCircleSz[t]>0){let i=s.atomCircleSz[t]*o,r=s.atomCircleCol[t],a=n.getPoint(t);l.drawOval(a.oval.cx,a.oval.cy,i,i,si.NOCOLOUR,0,r),null===(e=this.mnemonics)||void 0===e||e.append(Re.Effect,"Circle",[a.oval.cx,a.oval.cy,a.oval.rw,a.oval.rh])}}drawBondInclined(t){let e=t.line.x1,i=t.line.y1,s=t.line.x2,n=t.line.y2,o=s-e,l=n-i,r=t.col,a=(t.size,t.head/Math.sqrt(o*o+l*l)),h=a*l,u=-a*o,m=[e,s-h,s+h],d=[i,n-u,n+u];if(null==this.layout.getPoint(t.bto-1).text&&2==this.mol.atomAdjCount(t.bto)){let o=null;for(let e=0;e<this.layout.numLines();e++){let i=this.layout.getLine(e);if(i.type==Pe.Normal&&(i.bfr==t.bto||i.bto==t.bto)){if(null!=o){o=null;break}o=i}}if(null!=o){let l=Math.atan2(i-n,e-s),r=Math.atan2(o.line.y1-o.line.y2,o.line.x1-o.line.x2);t.bto==o.bfr&&(r+=Math.PI);let a=Math.abs(N(l,r));if(a>105*S&&a<135*S){let t=G.lineIntersect(m[0],d[0],m[1],d[1],o.line.x1,o.line.y1,o.line.x2,o.line.y2),e=G.lineIntersect(m[0],d[0],m[2],d[2],o.line.x1,o.line.y1,o.line.x2,o.line.y2);m[1]=t[0],d[1]=t[1],m[2]=e[0],d[2]=e[1];let i=m[1]-m[0],s=d[1]-d[0],n=.5*o.size/b(i,s);m[1]+=i*n,d[1]+=s*n;let l=m[2]-m[0],r=d[2]-d[0];o.size,b(l,r),m[2]+=l*n,d[2]+=r*n}}}if(null==this.layout.getPoint(t.bto-1).text&&3==this.mol.atomAdjCount(t.bto)){let o=null,l=null;for(let e=0;e<this.layout.numLines();e++){let i=this.layout.getLine(e);if(i.type==Pe.Normal&&(i.bfr==t.bto||i.bto==t.bto))if(null==o)o=i;else{if(null!=l){o=l=null;break}l=i}}if(null!=o&&null!=l){let r=Math.atan2(i-n,e-s),a=Math.atan2(o.line.y1-o.line.y2,o.line.x1-o.line.x2),h=Math.atan2(l.line.y1-l.line.y2,l.line.x1-l.line.x2);t.bto==o.bfr&&(a+=Math.PI),t.bto==l.bfr&&(h+=Math.PI);let u=N(r,a),c=Math.abs(u),p=N(r,h),f=Math.abs(p),g=Math.abs(N(a,h));if(c>105*S&&c<135*S||f>105*S&&f<135*S||g>105*S&&g<135*S){u<0&&([o,l]=[l,o]);let t=G.lineIntersect(m[0],d[0],m[1],d[1],o.line.x1,o.line.y1,o.line.x2,o.line.y2),r=G.lineIntersect(m[0],d[0],m[2],d[2],l.line.x1,l.line.y1,l.line.x2,l.line.y2);m=[e,t[0],s,r[0]],d=[i,t[1],n,r[1]]}}}this.vg.drawPoly(m,d,si.NOCOLOUR,0,r,!0)}drawFusedWedge(t,e){const i=(t,e)=>{let i=t.line.x1,s=t.line.y1,n=t.line.x2,o=t.line.y2,l=n-i,r=o-s,a=t.head/Math.sqrt(l*l+r*r),h=a*r,u=-a*l,m=n-h,d=o-u,c=n+h,p=o+u;return y(m-e.line.x1,d-e.line.y1)>y(c-e.line.x1,p-e.line.y1)?{outerX:m,outerY:d,innerX:c,innerY:p}:{outerX:c,outerY:p,innerX:m,innerY:d}};let s=i(t,e),n=i(e,t),[o,l]=G.lineIntersect(t.line.x1,t.line.y1,s.innerX,s.innerY,e.line.x1,e.line.y1,n.innerX,n.innerY),r=[t.line.x1,s.outerX,n.outerX,e.line.x1,o],a=[t.line.y1,s.outerY,n.outerY,e.line.y1,l];this.vg.drawPoly(r,a,si.NOCOLOUR,0,t.col,!0)}drawBondDeclined(t){let e=t.line.x1,i=t.line.y1,s=t.line.x2-e,n=t.line.y2-i,o=t.col,l=t.size,r=t.head,a=Math.sqrt(s*s+n*n),h=Math.ceil(2.5*a*this.invScale),u=r/a,m=u*n,d=-u*s,c=1/(h+1),p=1==this.mol.atomAdjCount(t.bto)&&null==this.layout.getPoint(t.bto-1).text?1:1-.15*this.scale/a;for(let t=0;t<=h+1;t++){let r=e+t*s*c*p,a=i+t*n*c*p,h=m*t*c,u=d*t*c;this.vg.drawLine(r-h,a-u,r+h,a+u,o,l)}}drawBondUnknown(e){let i=e.line.x1,s=e.line.y1,n=e.line.x2-i,o=e.line.y2-s,l=e.col,r=e.size,a=e.head,h=Math.sqrt(n*n+o*o),u=Math.ceil(3.5*h*this.invScale),m=a/h,d=m*o,c=-m*n,p=1+3*(u+1),f=t.numberArray(0,p),g=t.numberArray(0,p),b=t.booleanArray(!1,p);f[0]=i,g[0]=s,b[0]=!1;for(let t=0,e=1;t<=u;t++,e+=3){let l=i+t*n/(u+1),r=s+t*o/(u+1),a=i+(t+1)*n/(u+1),h=s+(t+1)*o/(u+1),m=(l+a)/2,p=(r+h)/2,y=t%2==0?1:-1;f[e]=l,f[e+1]=m+y*d,f[e+2]=a,g[e]=r,g[e+1]=p+y*c,g[e+2]=h,b[e]=!0,b[e+1]=!0,b[e+2]=!1}this.vg.drawPath(f,g,b,!1,l,r,si.NOCOLOUR,!1)}drawBondDotted(t){let e=t.line.x1,i=t.line.y1,s=t.line.x2,n=t.line.y2,o=s-e,l=n-i,r=t.col,a=t.size,h=a,u=b(o,l);if(u<.01)return;let m=.5*a/u;e+=m*o,i+=m*l,s-=m*o,n-=m*l,o=s-e,l=n-i;let d=Math.ceil(.2*u/h),c=1/(d+1);for(let s=0;s<=d+1;s++){let n=h;t.type==Pe.DotDir&&(n*=s*(1/(d+2))-.5+1);let a=e+s*o*c,u=i+s*l*c;this.vg.drawOval(a,u,n,n,si.NOCOLOUR,0,r)}}drawBondIncMulti(t){let e=t.line.x1,i=t.line.y1,s=t.line.x2,n=t.line.y2,o=s-e,l=n-i,r=t.col,a=(t.size,t.head/Math.sqrt(o*o+l*l)),h=a*l,u=-a*o;this.vg.drawPoly([e,s-h,s+h],[i,n-u,n+u],r,.05*this.scale,si.NOCOLOUR,!0),t.type==Pe.IncDouble?this.vg.drawLine(e,i,s,n,r,.03*this.scale):(this.vg.drawLine(e,i,s+.33*h,n+.33*u,r,.03*this.scale),this.vg.drawLine(e,i,s-.33*h,n-.33*u,r,.03*this.scale))}}class oi{constructor(t,e){this.layout=t,this.vg=e,this.hoverIndex=-1,this.activeIndex=-1,this.selectedIndex=-1,this.callbackDrawNameLine=null,this.measure=t.measure,this.policy=t.policy,this.scale=t.scale,this.invScale=1/this.scale}draw(){for(let t of this.layout.components)t.parentIdx>=0&&this.drawConnection(this.layout.components[t.parentIdx],t);for(let t=0;t<this.layout.components.length;t++)this.drawComponent(t)}drawConnection(t,e){let i=t.boundary.maxX(),s=e.boundary.minX(),n=t.boundary.midY(),o=e.boundary.midY(),l=i+.25*this.scale,r=n<o-1?-4:n>o+1?4:0,a=[i,l-4,l,l,l,l,l+4,s],h=[n,n,n,n-r,o+r,o,o,o],u=.1*this.scale;this.vg.drawPath(a,h,[!1,!1,!0,!1,!1,!0,!1,!1],!1,0,u,si.NOCOLOUR,!1)}drawComponent(t){let e=this.layout.components[t],i=e.outline.clone();i.offsetBy(e.boundary.x,e.boundary.y);let s=16316664;if(t==this.activeIndex?s=8558308:t==this.selectedIndex?s=11123711:t==this.hoverIndex&&(s=14737632),this.vg.drawRect(i.x,i.y,i.w,i.h,8421504,1,s),e.molLayout&&new ni(e.molLayout,this.vg).draw(),e.nameLines.length>0){let t=i.x,s=t+e.nameBox.midX(),n=i.y+e.nameBox.y;for(let o of e.nameLines){let l=this.measure.measureText(o.text,e.fontSize),r=l[1]+2*l[2];this.callbackDrawNameLine&&this.callbackDrawNameLine(e,o,this.vg,new Z(t,n,i.w,r))||this.vg.drawText(s,n,o.text,e.fontSize,o.col,Ze.Centre|Ze.Top),n+=r}}if(e.collapseBox){let t=e.collapseBox.clone();t.offsetBy(e.boundary.x,e.boundary.y),this.vg.drawRect(t.x,t.y,t.w,t.h,8421504,1,16316664);let i=t.midX(),s=t.midY(),n=.4*Math.min(t.w,t.h),o=.2*n;this.vg.drawLine(i-n,s,i+n,s,0,o),e.isCollapsed&&this.vg.drawLine(i,s-n,i,s+n,0,o)}}}class li{constructor(t=null){this.minPortionWidth=80,this.maxPortionWidth=80,this.maximumWidth=0,this.maximumHeight=0,this.minPortionHeight=20,this.maxPortionHeight=0,this.topMargin=50,this.title="Dialog",this.allowScroller=!0,this.zindex=null,this.callbackClose=null,this.callbackShown=null,this.parent=st(t),at("dialog","\n    *.wmk-dialog\n    {\n        font-family: 'Open Sans', sans-serif;\n\t\tfont-size: 16px;\n\t\tcolor: black;\n\t\tuser-select: none;\n    }\n\t*.wmk-noscroll\n\t{\n\t\toverflow: hidden;\n\t}\n")}onClose(t){this.callbackClose=t}onShown(t){this.callbackShown=t}open(){dt();let t=this.parent||it(document.body);t.addClass("wmk-noscroll");let e=this.domObscureBackground=it("<div/>").appendTo(t);e.css({position:"fixed"}),e.css({left:"0",right:"0",top:"0",bottom:"0"}),e.css({"background-color":"black",opacity:.8}),e.onClick((()=>this.close()));let i=this.domObscureForeground=it("<div/>").appendTo(t);i.css({position:"fixed"}),i.css({left:"0",right:"0",top:"0",bottom:"0"}),this.zindex>0&&(e.setCSS("z-index",this.zindex),i.setCSS("z-index",this.zindex+1));let s=this.domPanelBoundary=it('<div class="wmk-dialog"/>').appendTo(i);s.css({"min-width":this.minPortionWidth+"%"}),this.maximumWidth>0?s.css({"max-width":this.maximumWidth+"px"}):null!=this.maxPortionWidth&&s.css({"max-width":this.maxPortionWidth+"%"}),this.maximumHeight>0?s.css({"max-height":this.maximumHeight+"px"}):this.maxPortionHeight>0&&s.css({"max-height":this.maxPortionHeight+"vh"}),s.css({"background-color":"white","border-radius":"6px",border:"1px solid black"}),s.css({position:"absolute"}),s.css({left:50-.5*this.minPortionWidth+"%"}),s.css({top:this.topMargin+"px"}),s.css({"min-height":this.minPortionHeight+"%"});let n=it("<div/>").appendTo(s).css({display:"flex"});n.css({"flex-direction":"column","align-items":"stretch"}),this.maximumHeight>0?n.css({"max-height":this.maximumHeight+"px"}):this.maxPortionHeight>0&&n.css({"max-height":this.maxPortionHeight+"vh"});let o=this.domTitle=it("<div/>").appendTo(n);o.css({"flex-shrink":"0","flex-grow":"0"}),o.css({margin:"0",padding:"0"}),o.css({"background-color":"#F0F0F0"}),o.css({"background-image":"linear-gradient(to right bottom, #FFFFFF, #E0E0E0)"}),o.css({"border-bottom":"1px solid #C0C0C0"}),o.css({"border-radius":"6px 6px 0 0"});let l=it("<div/>").appendTo(n).css({width:"100%"});l.css({"flex-shrink":"1","flex-grow":"0"}),this.allowScroller&&l.css({"overflow-y":"auto"}),this.domBody=it("<div/>").appendTo(l).css({padding:"0.5em"});let r=it("<table/>").appendTo(o),a=it("<tr/>").appendTo(r);r.attr({width:"100%"});let h=it('<td valign="center"/>').appendTo(a).css({padding:"0.5em"});it("<font/>").appendTo(h).css({"font-size":"1.5em","font-weight":"600"}).setText(this.title);let u=this.domTitleButtons=it('<td align="right" valign="center"/>').appendTo(a).css({padding:"0.5em"});this.domClose=it('<button class="wmk-button wmk-button-default">Close</button>').appendTo(u),this.domClose.onClick((()=>this.close())),this.populate(),this.repositionSize(),this.callbackShown&&this.callbackShown(this)}close(){dt(),this.domObscureBackground.remove(),this.domObscureForeground.remove(),(this.parent||it(document.body)).removeClass("wmk-noscroll"),this.callbackClose&&this.callbackClose(this)}bump(){this.repositionSize()}bodyDOM(){return this.domBody}buttonsDOM(){return this.domTitleButtons}populate(){this.bodyDOM().setText("Empty dialog box.")}repositionSize(){let t=window.innerWidth,e=this.domPanelBoundary.width();this.domPanelBoundary.css({left:.5*(t-e)+"px"})}}const ri=require("path");class ai{get contentDOM(){return this.domContent}constructor(){this.tagType="div",this.domContent=null}render(t){let e=this.tagType;this.domContent=it(`<${e}/>`).appendTo(t)}remove(){this.domContent&&this.domContent.remove(),this.domContent=null}addTooltip(t,e){mt(this.contentDOM,t,e)}grabFocus(){this.domContent.grabFocus()}}var hi;!function(t){t[t.Left=0]="Left",t[t.Right=1]="Right",t[t.Top=2]="Top",t[t.Bottom=3]="Bottom",t[t.Centre=4]="Centre"}(hi||(hi={}));class ui extends ai{constructor(t,e,i,s,n){super(),this.position=t,this.parentX=e,this.parentY=i,this.parentWidth=s,this.parentHeight=n,this.idealSize=50,this.width=0,this.height=0,this.selectedButton=null,this.highlightButton=null,this.maxButtonColumns=0,this.maxButtonRows=0,this.border=8421504,this.background=16777215,this.buttonColNorm1=4707794,this.buttonColNorm2=36817,this.buttonColActv1=3211113,this.buttonColActv2=34384,this.buttonColSel1=16777215,this.buttonColSel2=14737632,this.canvas=null,this.stack=[],this.display=[],this.hasBigButtons=!0,this.prefabImgSize=44,this.gripHeight=30,this.gripWidth=50,this.isRaised=!0,this.outPadding=2,this.inPadding=2,this.x=0,this.y=0,this.isMacLike=!1,this.isMacLike=!!navigator.platform.match(/(Mac|iPhone|iPod|iPad)/i)}setParentSize(t,e){this.parentWidth=t,this.parentHeight=e,this.contentDOM&&(this.applyOffset(),this.redraw())}get topBank(){return this.stack.length>0?this.stack[this.stack.length-1]:null}get stackSize(){return this.stack.length}render(t){super.render(t),this.contentDOM.css({position:"absolute",width:`${this.width}px`,height:`${this.height}px`}),this.contentDOM.addClass("no_selection"),this.layoutButtons();let e="position: absolute; left: 0; top: 0;";e+="pointer-events: none;",this.canvas=a(this.contentDOM.el,"canvas",{width:this.width,height:this.height,style:"position: absolute; left: 0; top: 0;pointer-events: none;"}),this.canvas.style.width=this.width+"px",this.canvas.style.height=this.height+"px",this.applyOffset(),this.redraw(),this.contentDOM.onClick((t=>this.mouseClick(t))),this.contentDOM.onDblClick((t=>this.mouseDoubleClick(t))),this.contentDOM.onMouseDown((t=>{t.preventDefault(),this.mouseDown(t)})),this.contentDOM.onMouseUp((t=>this.mouseUp(t))),this.contentDOM.onMouseOver((t=>this.mouseOver(t))),this.contentDOM.onMouseLeave((t=>this.mouseOut(t))),this.contentDOM.onMouseMove((t=>this.mouseMove(t)))}pushBank(t){t.buttonView=this,t.isSubLevel=this.stack.length>0,t.init(),this.stack.push(t),null!=this.canvas&&(this.layoutButtons(),this.replaceCanvas(),this.applyOffset(),this.redraw())}popBank(){0!=this.stack.length&&(t.last(this.stack).bankClosed(),this.stack.length--,null!=this.canvas&&(this.layoutButtons(),this.replaceCanvas(),this.applyOffset(),this.redraw()))}refreshBank(){null!=this.canvas&&(this.layoutButtons(),this.replaceCanvas(),this.applyOffset(),this.redraw())}getSelectedButton(){return this.selectedButton}setSelectedButton(t){t!=this.selectedButton&&(this.selectedButton=t,this.redraw())}cycleSelected(t){let e=this.display.filter((t=>"*"!=t.id));e.sort(((t,e)=>1e4*t.y+t.x-(1e4*e.y+e.x)));let i=0,s=e.length;for(let t=0;t<s;t++)if(e[t].id==this.selectedButton){i=t;break}this.selectedButton=e[(i+t+s)%s].id,this.redraw()}raiseBank(){this.isRaised||(this.isRaised=!0,this.contentDOM&&(this.layoutButtons(),this.replaceCanvas(),this.applyOffset(),this.redraw()))}lowerBank(){this.isRaised&&(this.isRaised=!1,this.contentDOM&&(this.layoutButtons(),this.replaceCanvas(),this.applyOffset(),this.redraw()))}getHasBigButtons(){return this.hasBigButtons}setHasBigButtons(t){this.hasBigButtons=t,this.prefabImgSize=t?44:36,this.idealSize=t?50:40}withinOutline(t,e){let i=this.width,s=this.height;if(t<0||t>i||e<0||e>s)return!1;if(this.position==hi.Centre||0==this.stack.length)return!0;if(this.position==hi.Left){let n=.5*s-1,o=this.gripHeight,l=.5*this.gripWidth;return t<i-o||e>n-l&&e<n+l}if(this.position==hi.Right){let i=.5*s-1,n=this.gripHeight,o=.5*this.gripWidth;return t>n||e>i-o&&e<i+o}if(this.position==hi.Top){let n=.5*i-1,o=this.gripHeight,l=.5*this.gripWidth;return e<s-o||t>n-l&&t<n+l}if(this.position==hi.Bottom){let s=.5*i-1,n=this.gripHeight,o=.5*this.gripWidth;return e>n||t>s-o&&t<s+o}return!0}gripSize(){return this.gripHeight}sizeForButtons(t){return this.idealSize*t+this.inPadding*(t-1)+2*this.outPadding}layoutButtons(){if(null==this.contentDOM)return;let t=this.outPadding,e=this.inPadding;if(this.removeDisplayButtons(),0==this.stack.length)return this.width=10,this.height=10,void(this.position==hi.Left||this.position==hi.Right?this.height=this.parentHeight:this.position!=hi.Top&&this.position!=hi.Bottom||(this.width=this.parentWidth));if(!this.isRaised)return this.position==hi.Left||this.position==hi.Right?(this.width=this.gripHeight,this.height=this.gripWidth+2*t):this.position!=hi.Top&&this.position!=hi.Bottom||(this.width=this.gripWidth+2*t,this.height=this.gripHeight),void this.addGripButton();let i=this.stack[this.stack.length-1];i.buttons=[],i.update();let s=0,n=0;1==this.stack.length||(this.position==hi.Left||this.position==hi.Right?n=this.gripHeight+e:this.position!=hi.Top&&this.position!=hi.Bottom||(s=this.gripHeight+e));let o=null,l=null;if(this.position==hi.Left||this.position==hi.Right){let s=Math.floor((this.parentHeight-2*t-e)/(this.idealSize+e)),n=Math.ceil(.5*s);for(let t=s;t>=n;t--){let e=Math.ceil(i.buttons.length/t);for(let s=e;s<=e+1;s++){let e=this.layoutMaxHeight(i,t,s),n=this.scoreLayout(e)+1*e[0].length;(null==o||n<l)&&(o=e,l=n)}}}else if(this.position==hi.Top||this.position==hi.Bottom){let n=Math.floor((this.parentWidth-2*t-e-s)/(this.idealSize+e)),r=Math.ceil(.5*n);for(let t=n;t>=r;t--){let e=this.layoutMaxWidth(i,t),s=this.scoreLayout(e)+1*e.length;(null==o||s<l)&&(o=e,l=s)}}let r=o[0].length,a=o.length;if(this.width=2*t+e+(this.idealSize+e)*r+s,this.height=2*t+e+(this.idealSize+e)*a+n,this.position==hi.Left||this.position==hi.Right?this.width+=this.gripHeight:this.position!=hi.Top&&this.position!=hi.Bottom||(this.height+=this.gripHeight),this.addGripButton(),s>0||n>0){let i={id:"!",x:t+e,y:t+e,width:s-e,height:n-e};this.position==hi.Right?i.x+=this.gripHeight:this.position==hi.Bottom&&(i.y+=this.gripHeight),0==s&&(i.width=r*this.idealSize+e*(r-1)),0==n&&(i.height=a*this.idealSize+e*(a-1)),this.display.push(i)}for(let l=0;l<a;l++)for(let a=0;a<r;a++)for(let r=0;r<i.buttons.length;r++)if(o[l][a]==i.buttons[r].id){let o={id:i.buttons[r].id};o.x=t+e+s+(this.idealSize+e)*a,o.y=t+e+n+(this.idealSize+e)*l,this.position==hi.Right?o.x+=this.gripHeight:this.position==hi.Bottom&&(o.y+=this.gripHeight),o.width=this.idealSize,o.height=this.idealSize,this.display.push(o)}}addGripButton(){if(this.position==hi.Centre)return;let t={id:"*"};this.position==hi.Left?(t.width=this.gripHeight-3,t.height=this.gripWidth-6,t.x=this.width-t.width-3-1,t.y=.5*(this.height-t.height)):this.position==hi.Right?(t.width=this.gripHeight-3,t.height=this.gripWidth-6,t.x=4,t.y=.5*(this.height-t.height)):this.position==hi.Top?(t.width=this.gripWidth-6,t.height=this.gripHeight-3,t.x=.5*(this.width-t.width),t.y=this.height-t.height-3-1):this.position==hi.Bottom&&(t.width=this.gripWidth-6,t.height=this.gripHeight-3,t.x=.5*(this.width-t.width),t.y=4),this.display.push(t)}replaceCanvas(){this.contentDOM.empty();for(let t=0;t<this.display.length;t++)this.display[t].imgDOM=null,this.display[t].helpSpan=null;let t="position: absolute; left: 0; top: 0;";t+="pointer-events: none;",this.canvas=a(this.contentDOM.el,"canvas",{width:this.width,height:this.height,style:"position: absolute; left: 0; top: 0;pointer-events: none;"})}removeDisplayButtons(){this.contentDOM.empty(),this.display=[]}applyOffset(){let t,e;this.position==hi.Left?(t=0,e=.5*(this.parentHeight-this.height)):this.position==hi.Right?(t=this.parentWidth-this.width,e=.5*(this.parentHeight-this.height)):this.position==hi.Top?(t=.5*(this.parentWidth-this.width),e=0):this.position==hi.Bottom?(t=.5*(this.parentWidth-this.width),e=this.parentHeight-this.height):(t=.5*(this.parentWidth-this.width),e=.5*(this.parentHeight-this.height)),this.x=this.parentX+t,this.y=this.parentY+e,this.contentDOM.css({position:"absolute"}),g(this.contentDOM,this.x,this.y,this.width,this.height)}redraw(){if(!this.contentDOM||!this.canvas)return;let t=F();this.canvas.width=this.width*t,this.canvas.height=this.height*t,this.canvas.style.width=this.width+"px",this.canvas.style.height=this.height+"px";let e=this.canvas.getContext("2d");e.save(),e.scale(t,t),e.clearRect(0,0,this.width,this.height);let i=this.traceOutline();e.fillStyle=c(this.background),e.fill(i),e.strokeStyle=c(this.border),e.lineWidth=1,e.stroke(i),this.stack.length>0&&this.stack[this.stack.length-1],this.contentDOM.css({width:this.width+"px",height:this.height+"px"});for(let t=0;t<this.display.length;t++){const s=this.display[t],n=this.buttonFromID(s.id);let o,l;if(null!=this.highlightButton&&s.id==this.highlightButton?(o=this.buttonColActv1,l=this.buttonColActv2):null!=this.selectedButton&&s.id==this.selectedButton?(o=this.buttonColSel1,l=this.buttonColSel2):(o=this.buttonColNorm1,l=this.buttonColNorm2),e.save(),i=R(s.x+.5,s.y+.5,s.x+s.width-1,s.y+s.height-1,5),null!=l){let t=e.createLinearGradient(s.x,s.y,s.x+s.width,s.y+s.height);t.addColorStop(0,c(o)),t.addColorStop(1,c(l)),e.fillStyle=t}else e.fillStyle=c(o);if(e.fill(i),e.strokeStyle=c(this.border),e.lineWidth=.5,e.stroke(i),e.restore(),null!=s.imgDOM&&(s.imgDOM.remove(),s.imgDOM=null),null!=n){if(null==s.helpSpan){s.helpSpan=it('<span style="position: absolute;"/>').appendTo(this.contentDOM);let t=n.helpText;if(n.mnemonic){for(;t.endsWith(".");)t=t.substring(0,t.length-1);let e=n.mnemonic,i=e.match(/^(.*)CmdOrCtrl(.*)$/);i&&(e=i[1]+(this.isMacLike?"Cmd":"Ctrl")+i[2]),t+=" ["+e+"]"}this.addTooltip(s.helpSpan.el.outerHTML,t)}g(s.helpSpan,s.x,s.y,s.width,s.height)}if(null==n);else if(null!=n.imageFN&&null==s.imgDOM){s.imgDOM=it("<img/>").appendTo(this.contentDOM).css({position:"absolute","pointer-events":"none"}),s.imgDOM.setAttr("src",ot.RESOURCE_URL+"/img/actions/"+n.imageFN+".svg");const t=this.prefabImgSize,e=s.x+Math.floor(.5*(s.width-t)),i=s.y+Math.floor(.5*(s.height-t));g(s.imgDOM,e,i,t,t)}else if(null!=n.metavec){let t=n.metavec instanceof si?n.metavec:new si(n.metavec);t.offsetX=s.x+Math.floor(.5*(s.width-t.width)),t.offsetY=s.y+Math.floor(.5*(s.height-t.height)),t.renderContext(e)}else if(null!=n.text){let t=this.idealSize,i=new si({size:[t,t]}),o=.6*t,l=Xe.main.measureText(n.text,o);l[1]+l[2]>t&&(o*=t/(l[1]+l[2]),l=Xe.main.measureText(n.text,o)),l[0]>t&&(o*=t/l[0],l=Xe.main.measureText(n.text,o));let r=.5*(t-l[0]),a=.5*(t+l[1]);i.drawText(r-1,a,n.text,o,0),i.drawText(r+1,a,n.text,o,0),i.drawText(r,a-1,n.text,o,0),i.drawText(r,a+1,n.text,o,0),i.drawText(r,a,n.text,o,16777215),i.offsetX=s.x+Math.floor(.5*(s.width-i.width)),i.offsetY=s.y+Math.floor(.5*(s.height-i.height)),i.renderContext(e)}if(null!=n&&n.isSubMenu){e.save();let t=s.x+s.width-3,i=s.y+s.height-3;e.beginPath(),e.moveTo(t,i),e.lineTo(t-6,i),e.lineTo(t,i-6),e.closePath(),e.fillStyle="black",e.fill(),e.restore()}if("*"==s.id){e.save(),i=new Path2D;let t,n,o=this.isRaised;this.position==hi.Left||this.position==hi.Right?(t=[.2,.7,.7],n=[.5,.3,.7],this.position==hi.Left&&(o=!o)):this.position!=hi.Top&&this.position!=hi.Bottom||(t=[.5,.3,.7],n=[.2,.7,.7],this.position==hi.Top&&(o=!o)),o&&(t=[1-t[0],1-t[1],1-t[2]],n=[1-n[0],1-n[1],1-n[2]]),i.moveTo(s.x+s.width*t[0],s.y+s.height*n[0]),i.lineTo(s.x+s.width*t[1],s.y+s.height*n[1]),i.lineTo(s.x+s.width*t[2],s.y+s.height*n[2]),i.closePath(),e.fillStyle="white",e.strokeStyle="black",e.lineWidth=0,e.fill(i),e.stroke(i),e.restore()}else if("!"==s.id){e.save();let t=new Path2D,i=new Path2D,n=5,o=s.width-2*n,l=s.height-2*n;for(let e=5;e<o+l-1;e+=12){let r=0,a=e,h=e,u=0;if(a>l){let t=a-l;r+=t,a-=t}if(h>o){let t=h-o;h-=t,u+=t}t.moveTo(s.x+n+r,s.y+n+a),t.lineTo(s.x+n+h,s.y+n+u),i.moveTo(s.x+n+r+1,s.y+n+a),i.lineTo(s.x+n+h+1,s.y+n+u)}e.lineWidth=1,e.strokeStyle="#404040",e.stroke(t),e.strokeStyle="white",e.stroke(i),e.restore()}}e.restore()}delayedRedraw(){window.setTimeout((()=>this.redraw()),100)}buttonFromID(t){let e=this.stack[this.stack.length-1];for(let i=0;i<e.buttons.length;i++)if(e.buttons[i].id==t)return e.buttons[i];return null}displayFromID(t){for(let e=0;e<this.display.length;e++)if(this.display[e].id==t)return this.display[e];return null}traceOutline(){let t=this.width,e=this.height,i=t-1,s=e-1;if(this.position==hi.Centre||0==this.stack.length)return R(.5,.5,t-.5,e-.5,8);let n=new Path2D;if(this.position==hi.Left){let t=.5*e-1,o=this.gripHeight,l=.5*this.gripWidth;n.moveTo(.5,.5),n.lineTo(.5+i-o-8,.5),n.bezierCurveTo(.5+i-o,.5,.5+i-o,.5,.5+i-o,8.5),n.lineTo(.5+i-o,.5+t-l),n.lineTo(.5+i-8,.5+t-l),n.bezierCurveTo(.5+i,.5+t-l,.5+i,.5+t-l,.5+i,.5+t-l+8),n.lineTo(.5+i,.5+t+l-8),n.bezierCurveTo(.5+i,.5+t+l,.5+i,.5+t+l,.5+i-8,.5+t+l),n.lineTo(.5+i-o,.5+t+l),n.lineTo(.5+i-o,.5+s-8),n.bezierCurveTo(.5+i-o,.5+s,.5+i-o,.5+s,.5+i-o-8,.5+s),n.lineTo(.5,.5+s)}else if(this.position==hi.Right){let o=.5*e-1,l=this.gripHeight,r=.5*this.gripWidth;n.moveTo(t-.5,.5),n.lineTo(t-(.5+i-l-8),.5),n.bezierCurveTo(t-(.5+i-l),.5,t-(.5+i-l),.5,t-(.5+i-l),8.5),n.lineTo(t-(.5+i-l),.5+o-r),n.lineTo(t-(.5+i-8),.5+o-r),n.bezierCurveTo(t-(.5+i),.5+o-r,t-(.5+i),.5+o-r,t-(.5+i),.5+o-r+8),n.lineTo(t-(.5+i),.5+o+r-8),n.bezierCurveTo(t-(.5+i),.5+o+r,t-(.5+i),.5+o+r,t-(.5+i-8),.5+o+r),n.lineTo(t-(.5+i-l),.5+o+r),n.lineTo(t-(.5+i-l),.5+s-8),n.bezierCurveTo(t-(.5+i-l),.5+s,t-(.5+i-l),.5+s,t-(.5+i-l-8),.5+s),n.lineTo(t-.5,.5+s)}else if(this.position==hi.Top){let o=.5*t-1,l=this.gripHeight,r=.5*this.gripWidth;n.moveTo(.5,e-(.5+s)),n.lineTo(.5,e-(.5+l+8)),n.bezierCurveTo(.5,e-(.5+l),.5,e-(.5+l),8.5,e-(.5+l)),n.lineTo(.5+o-r,e-(.5+l)),n.lineTo(.5+o-r,e-8.5),n.bezierCurveTo(.5+o-r,e-.5,.5+o-r,e-.5,.5+o-r+8,e-.5),n.lineTo(.5+o+r-8,e-.5),n.bezierCurveTo(.5+o+r,e-.5,.5+o+r,e-.5,.5+o+r,e-8.5),n.lineTo(.5+o+r,e-(.5+l)),n.lineTo(.5+i-8,e-(.5+l)),n.bezierCurveTo(.5+i,e-(.5+l),.5+i,e-(.5+l),.5+i,e-(.5+l+8)),n.lineTo(.5+i,e-(.5+s))}else if(this.position==hi.Bottom){let e=.5*t-1,o=this.gripHeight,l=.5*this.gripWidth;n.moveTo(.5,.5+s),n.lineTo(.5,.5+o+8),n.bezierCurveTo(.5,.5+o,.5,.5+o,8.5,.5+o),n.lineTo(.5+e-l,.5+o),n.lineTo(.5+e-l,8.5),n.bezierCurveTo(.5+e-l,.5,.5+e-l,.5,.5+e-l+8,.5),n.lineTo(.5+e+l-8,.5),n.bezierCurveTo(.5+e+l,.5,.5+e+l,.5,.5+e+l,8.5),n.lineTo(.5+e+l,.5+o),n.lineTo(.5+i-8,.5+o),n.bezierCurveTo(.5+i,.5+o,.5+i,.5+o,.5+i,.5+o+8),n.lineTo(.5+i,.5+s)}return n}layoutMaxWidth(t,e){if(0==t.buttons.length)return[[null]];let i=new Array(t.buttons.length),s=new Array(t.buttons.length),n=0,o=0,l=0,r=0;for(let a=0;a<t.buttons.length;a++)l=Math.max(n+1,l),r=Math.max(o+1,r),i[a]=n,s[a]=o,n++,n>=e&&(n=0,o++);let a=new Array(r);for(let t=0;t<r;t++)a[t]=new Array(l);for(let e=0;e<t.buttons.length;e++)a[s[e]][i[e]]=t.buttons[e].id;return a}layoutMaxHeight(t,e,i){if(0==t.buttons.length)return[[null]];let s=new Array(t.buttons.length),n=new Array(t.buttons.length),o=0,l=0,r=0,a=0;for(let e=0;e<t.buttons.length;e++)r=Math.max(o+1,r),a=Math.max(l+1,a),s[e]=o,n[e]=l,o++,o>=i&&(o=0,l++);let h=new Array(a);for(let t=0;t<a;t++)h[t]=new Array(r);for(let e=0;e<t.buttons.length;e++)h[n[e]][s[e]]=t.buttons[e].id;return h}scoreLayout(t){let e=0,i=t.length,s=t[0].length;for(let n=0;n<i;n++)for(let i=0;i<s;i++)null==t[n][i]&&e++;return this.maxButtonRows>0&&i>this.maxButtonRows&&(e+=100*(i-this.maxButtonRows)),this.maxButtonColumns>0&&s>this.maxButtonColumns&&(e+=100*(s-this.maxButtonColumns)),e}pickButtonIndex(t,e){for(let i=0;i<this.display.length;i++){let s=this.display[i];if(t>=s.x&&e>=s.y&&t<s.x+s.width&&e<s.y+s.height)return i}return-1}pickButtonID(t,e){let i=this.pickButtonIndex(t,e);if(!(i<0))return this.display[i].id}triggerButton(t){"*"!=t?"!"!=t?this.stack[this.stack.length-1].hitButton(t):this.popBank():this.isRaised?this.lowerBank():this.raiseBank()}mouseClick(t){}mouseDoubleClick(t){t.stopImmediatePropagation()}mouseDown(t){this.contentDOM.parent().grabFocus();let e=f(t,this.contentDOM);if(!this.withinOutline(e[0],e[1]))return;let i=this.pickButtonID(e[0],e[1]);i!=this.highlightButton&&(this.highlightButton=i,this.redraw()),t.stopPropagation()}mouseUp(t){let e=f(t,this.contentDOM);if(!this.withinOutline(e[0],e[1]))return;let i=this.pickButtonID(e[0],e[1]);null!=i&&this.highlightButton==i?(this.highlightButton=void 0,this.triggerButton(i),this.delayedRedraw()):(this.highlightButton=void 0,this.delayedRedraw()),t.stopPropagation()}mouseOver(t){let e=f(t,this.contentDOM);this.withinOutline(e[0],e[1])&&t.stopPropagation()}mouseOut(t){let e=f(t,this.contentDOM);if(this.withinOutline(e[0],e[1])){if(null!=this.highlightButton){let e=f(t,this.contentDOM);this.pickButtonID(e[0],e[1])!=this.highlightButton&&(this.highlightButton=null,this.delayedRedraw())}t.stopPropagation()}else null!=this.highlightButton&&(this.highlightButton=null,this.delayedRedraw())}mouseMove(t){let e=f(t,this.contentDOM);this.withinOutline(e[0],e[1])}}class mi{constructor(){this.isSubLevel=!1,this.buttons=[]}init(){}claimKey(t){return!1}bankClosed(){}static matchKey(t,e,i){if(null==e||""==e)return!1;let s=!1,n=!1,o=!1,l=!1,r=e;for(;;)if(r.startsWith("Shift+"))s=!0,r=r.substring(6);else if(r.startsWith("Ctrl+"))n=!0,r=r.substring(5);else if(r.startsWith("Alt+"))o=!0,r=r.substring(4);else{if(!r.startsWith("Cmd+"))break;l=!0,r=r.substring(4)}return s==t.shiftKey&&n==t.ctrlKey&&o==t.altKey&&l==t.metaKey&&(i&&(r=i),r.toLowerCase()==t.key.toLowerCase())}}const di=["He","Ar","Kr","Xe","Rn"],ci=["Li","Na","K","Rb","Cs","Fr","Sc","Be","Mg","Ca","Sr","Ba","Ra","Y"],pi=["B","Al","Si","Ga","Ge","As","Se","In","Sn","Sb","Te","Tl","Pb","Bi","Po","At"],fi=["Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg"],gi=["La","Ce","Pr","Nd","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Ac","Th","Pa","U"],bi=["*","A","X","Y","Z","Q","M","T","E","L","R","R0","R1","R2","R3","R4","R5","R6","R7","R8"];var yi;!function(t){t[t.Main=0]="Main",t[t.Atom=1]="Atom",t[t.Bond=2]="Bond",t[t.Select=3]="Select",t[t.Move=4]="Move",t[t.Abbrev=5]="Abbrev",t[t.SBlock=6]="SBlock",t[t.PBlock=7]="PBlock",t[t.DBlock=8]="DBlock",t[t.FBlock=9]="FBlock",t[t.Noble=10]="Noble"}(yi||(yi={}));const xi=[{id:"undo",imageFN:"MainUndo",helpText:"Undo last change.",mnemonic:"CmdOrCtrl+Z"},{id:"redo",imageFN:"MainRedo",helpText:"Cancel last undo.",mnemonic:"CmdOrCtrl+Shift+Z"},{id:"zoomin",imageFN:"MainZoomIn",helpText:"Zoom in.",mnemonic:"="},{id:"zoomout",imageFN:"MainZoomOut",helpText:"Zoom out.",mnemonic:"-"},{id:"zoomfit",imageFN:"MainZoomFit",helpText:"Show whole diagram onscreen.",mnemonic:""},{id:"selside",imageFN:"MainSelSide",helpText:"Select alternate side of current atom or bond.",mnemonic:"E"},{id:"selall",imageFN:"MainSelAll",helpText:"Select all atoms.",mnemonic:"Shift+A"},{id:"selnone",imageFN:"MainSelNone",helpText:"Clear selection.",mnemonic:"Shift+Q"},{id:"delete",imageFN:"MainDelete",helpText:"Delete selected atoms and bonds.",mnemonic:"D"},{id:"cut",imageFN:"MainCut",helpText:"Copy selection to clipboard, and remove.",mnemonic:"CmdOrCtrl+X"},{id:"copy",imageFN:"MainCopy",helpText:"Copy selection to clipboard.",mnemonic:"CmdOrCtrl+C"},{id:"paste",imageFN:"MainPaste",helpText:"Paste clipboard contents."},{id:"atom",imageFN:"MainAtom",helpText:"Open the Atom submenu.",isSubMenu:!0,mnemonic:"A"},{id:"bond",imageFN:"MainBond",helpText:"Open the Bond submenu.",isSubMenu:!0,mnemonic:"B"},{id:"select",imageFN:"MainSelect",helpText:"Open the Selection submenu.",isSubMenu:!0,mnemonic:"S"},{id:"move",imageFN:"MainMove",helpText:"Open the Move submenu.",isSubMenu:!0,mnemonic:"M"}],Ai=[{id:"element:C",text:"C",helpText:"Change elements to Carbon.",mnemonic:"Shift+C"},{id:"element:N",text:"N",helpText:"Change elements to Nitrogen.",mnemonic:"Shift+N"},{id:"element:O",text:"O",helpText:"Change elements to Oxygen.",mnemonic:"Shift+O"},{id:"element:S",text:"S",helpText:"Change elements to Sulfur.",mnemonic:"Shift+S"},{id:"element:P",text:"P",helpText:"Change elements to Phosphorus.",mnemonic:"Shift+P"},{id:"element:H",text:"H",helpText:"Change elements to Hydrogen.",mnemonic:"Shift+H"},{id:"element:F",text:"F",helpText:"Change elements to Fluorine.",mnemonic:"Shift+F"},{id:"element:Cl",text:"Cl",helpText:"Change elements to Chlorine.",mnemonic:"Shift+L"},{id:"element:Br",text:"Br",helpText:"Change elements to Bromine.",mnemonic:"Shift+B"},{id:"element:I",text:"I",helpText:"Change elements to Iodine.",mnemonic:"Shift+I"},{id:"plus",imageFN:"AtomPlus",helpText:"Increase the atom charge.",mnemonic:"Shift+=",key:"+"},{id:"minus",imageFN:"AtomMinus",helpText:"Decrease the atom charge.",mnemonic:"Shift+-",key:"_"},{id:"abbrev",imageFN:"AtomAbbrev",helpText:"Open list of common labels.",isSubMenu:!0,mnemonic:""},{id:"sblock",imageFN:"AtomSBlock",helpText:"Open list of s-block elements.",isSubMenu:!0,mnemonic:""},{id:"pblock",imageFN:"AtomPBlock",helpText:"Open list of p-block elements.",isSubMenu:!0,mnemonic:""},{id:"dblock",imageFN:"AtomDBlock",helpText:"Open list of d-block elements.",isSubMenu:!0,mnemonic:""},{id:"fblock",imageFN:"AtomFBlock",helpText:"Open list of f-block elements.",isSubMenu:!0,mnemonic:""},{id:"noble",imageFN:"AtomNoble",helpText:"Open list of noble elements.",isSubMenu:!0,mnemonic:""}],vi=[{id:"one",imageFN:"BondOne",helpText:"Create or set bonds to single.",mnemonic:"1"},{id:"two",imageFN:"BondTwo",helpText:"Create or set bonds to double.",mnemonic:"2"},{id:"three",imageFN:"BondThree",helpText:"Create or set bonds to triple.",mnemonic:"3"},{id:"four",imageFN:"BondFour",helpText:"Create or set bonds to quadruple.",mnemonic:""},{id:"zero",imageFN:"BondZero",helpText:"Create or set bonds to zero-order.",mnemonic:"0"},{id:"inclined",imageFN:"BondUp",helpText:"Create or set bonds to inclined.",mnemonic:"5"},{id:"declined",imageFN:"BondDown",helpText:"Create or set bonds to declined.",mnemonic:"6"},{id:"squig",imageFN:"BondSquig",helpText:"Create or set bonds to unknown stereochemistry.",mnemonic:"4"},{id:"bondQAny",imageFN:"BondQAny",helpText:"Query bond that matches anything."},{id:"addtwo",imageFN:"BondAddTwo",helpText:"Add two new bonds to the subject atom.",mnemonic:"Shift+D"},{id:"insert",imageFN:"BondInsert",helpText:"Insert a methylene into the subject bond.",mnemonic:""},{id:"switch",imageFN:"BondSwitch",helpText:"Cycle through likely bond geometries.",mnemonic:"'"},{id:"rotate",imageFN:"BondRotate",helpText:"Rotate bond to invert substituent orientation.",mnemonic:""},{id:"linear",imageFN:"BondLinear",helpText:"Apply linear geometry.",mnemonic:"Shift+V"},{id:"trigonal",imageFN:"BondTrigonal",helpText:"Apply trigonal geometry.",mnemonic:"Shift+W"},{id:"tetra1",imageFN:"BondTetra1",helpText:"Apply tetrahedral geometry #1.",mnemonic:"Shift+E"},{id:"tetra2",imageFN:"BondTetra2",helpText:"Apply tetrahedral geometry #2.",mnemonic:"Shift+R"},{id:"sqplan",imageFN:"BondSqPlan",helpText:"Apply square planar geometry.",mnemonic:"Shift+T"},{id:"octa1",imageFN:"BondOcta1",helpText:"Apply octahedral geometry #1.",mnemonic:"Shift+Y"},{id:"octa2",imageFN:"BondOcta2",helpText:"Apply octahedral geometry #2.",mnemonic:"Shift+U"},{id:"metalligate",imageFN:"BondMetalLigate",helpText:"Arrange ligands around metal centre.",mnemonic:""},{id:"artifactpath",imageFN:"BondArtifactPath",helpText:"Add a path bond artifact.",mnemonic:""},{id:"artifactring",imageFN:"BondArtifactRing",helpText:"Add a ring bond artifact.",mnemonic:""},{id:"artifactarene",imageFN:"BondArtifactArene",helpText:"Add an arene bond artifact.",mnemonic:""},{id:"artifactclear",imageFN:"BondArtifactClear",helpText:"Remove a bond artifact.",mnemonic:""},{id:"polymer",imageFN:"BondPolymer",helpText:"Create a polymer block.",mnemonic:""}],Mi=[{id:"selgrow",imageFN:"SelectionGrow",helpText:"Add adjacent atoms to selection.",mnemonic:""},{id:"selshrink",imageFN:"SelectionShrink",helpText:"Unselect exterior atoms.",mnemonic:""},{id:"selchain",imageFN:"SelectionChain",helpText:"Extend selection to non-ring atoms.",mnemonic:""},{id:"smallring",imageFN:"SelectionSmRing",helpText:"Extend selection to small rings.",mnemonic:""},{id:"ringblock",imageFN:"SelectionRingBlk",helpText:"Extend selection to ring blocks.",mnemonic:""},{id:"curelement",imageFN:"SelectionCurElement",helpText:"Select all atoms of current element type.",mnemonic:""},{id:"selprev",imageFN:"MainSelPrev",helpText:"Select previous connected component.",mnemonic:"["},{id:"selnext",imageFN:"MainSelNext",helpText:"Select next connected component.",mnemonic:"]"},{id:"toggle",imageFN:"SelectionToggle",helpText:"Toggle selection of current.",mnemonic:","},{id:"uncurrent",imageFN:"SelectionUncurrent",helpText:"Undefine current object.",mnemonic:"."},{id:"join",imageFN:"MoveJoin",helpText:"Overlapping atoms will be joined as one.",mnemonic:""},{id:"new",imageFN:"MainNew",helpText:"Clear the molecular structure.",mnemonic:""},{id:"inline",imageFN:"AtomInline",helpText:"Make selected atoms into an inline abbreviation.",mnemonic:"/"},{id:"formula",imageFN:"AtomFormula",helpText:"Make selected atoms into their molecule formula.",mnemonic:"\\"},{id:"expandabbrev",imageFN:"AtomExpandAbbrev",helpText:"Expand out the inline abbreviation.",mnemonic:"Shift+/",key:"?"},{id:"clearabbrev",imageFN:"AtomClearAbbrev",helpText:"Remove inline abbreviation.",mnemonic:"Shift+\\",key:"|"}],Ti=[{id:"up",imageFN:"MoveUp",helpText:"Move subject atoms up slightly.",mnemonic:"Shift+Up",key:"ArrowUp"},{id:"down",imageFN:"MoveDown",helpText:"Move subject atoms down slightly.",mnemonic:"Shift+Down",key:"ArrowDown"},{id:"left",imageFN:"MoveLeft",helpText:"Move subject atoms slightly to the left.",mnemonic:"Shift+Left",key:"ArrowLeft"},{id:"right",imageFN:"MoveRight",helpText:"Move subject atoms slightly to the right.",mnemonic:"Shift+Right",key:"ArrowRight"},{id:"uplots",imageFN:"MoveUpLots",helpText:"Move subject atoms up somewhat.",mnemonic:""},{id:"downlots",imageFN:"MoveDownLots",helpText:"Move subject atoms down somewhat.",mnemonic:""},{id:"leftlots",imageFN:"MoveLeftLots",helpText:"Move subject atoms somewhat to the left.",mnemonic:""},{id:"rightlots",imageFN:"MoveRightLots",helpText:"Move subject atoms somewhat to the right.",mnemonic:""},{id:"upfar",imageFN:"MoveUpFar",helpText:"Move subject atoms far up.",mnemonic:""},{id:"downfar",imageFN:"MoveDownFar",helpText:"Move subject atoms far down.",mnemonic:""},{id:"leftfar",imageFN:"MoveLeftFar",helpText:"Move subject atoms far to the left.",mnemonic:""},{id:"rightfar",imageFN:"MoveRightFar",helpText:"Move subject atoms far to the right.",mnemonic:""},{id:"rotp01",imageFN:"MoveRotP01",helpText:"Rotate 1 counter-clockwise.",mnemonic:""},{id:"rotm01",imageFN:"MoveRotM01",helpText:"Rotate 1 clockwise.",mnemonic:""},{id:"rotp05",imageFN:"MoveRotP05",helpText:"Rotate 5 counter-clockwise.",mnemonic:""},{id:"rotm05",imageFN:"MoveRotM05",helpText:"Rotate 5 clockwise.",mnemonic:""},{id:"rotp15",imageFN:"MoveRotP15",helpText:"Rotate 15 counter-clockwise.",mnemonic:""},{id:"rotm15",imageFN:"MoveRotM15",helpText:"Rotate 15 clockwise.",mnemonic:""},{id:"rotp30",imageFN:"MoveRotP30",helpText:"Rotate 30 counter-clockwise.",mnemonic:"Shift+[",key:"{"},{id:"rotm30",imageFN:"MoveRotM30",helpText:"Rotate 30 clockwise.",mnemonic:"Shift+]",key:"}"},{id:"hflip",imageFN:"MoveHFlip",helpText:"Flip subject atoms horizontally.",mnemonic:"Shift+,",key:"<"},{id:"vflip",imageFN:"MoveVFlip",helpText:"Flip subject atoms vertically.",mnemonic:"Shift+.",key:">"},{id:"shrink",imageFN:"MoveShrink",helpText:"Decrease subject bond distances.",mnemonic:"Shift+Z"},{id:"grow",imageFN:"MoveGrow",helpText:"Increase subject bond distances.",mnemonic:"Shift+X"}];class wi extends mi{constructor(t,e=yi.Main){super(),this.owner=t,this.cmdType=e}update(){if(this.cmdType==yi.Main)for(let t of xi)this.buttons.push(t);else if(this.cmdType==yi.Atom)for(let t of Ai)this.buttons.push(t);else if(this.cmdType==yi.Bond)for(let t of vi)this.buttons.push(t);else if(this.cmdType==yi.Select)for(let t of Mi)this.buttons.push(t);else if(this.cmdType==yi.Move)for(let t of Ti)this.buttons.push(t);else this.cmdType==yi.Abbrev?this.populateElements(bi):this.cmdType==yi.SBlock?this.populateElements(ci):this.cmdType==yi.PBlock?this.populateElements(pi):this.cmdType==yi.DBlock?this.populateElements(fi):this.cmdType==yi.FBlock?this.populateElements(gi):this.cmdType==yi.Noble&&this.populateElements(di)}populateElements(t){for(let e of t)this.buttons.push({id:`element:${e}`,text:e,helpText:`Change elements to ${e}.`})}hitButton(t){let e=0,i=null;if(t.startsWith("element:")){let s=t.substring(8);e=Se.Element,i={element:s}}else"delete"==t?e=Se.Delete:"undo"==t?this.owner.canUndo()?this.owner.performUndo():this.owner.showMessage("Nothing to undo."):"redo"==t?this.owner.canRedo()?this.owner.performRedo():this.owner.showMessage("Nothing to redo."):"cut"==t?e=Se.Cut:"copy"==t?e=Se.Copy:"paste"==t?this.owner.performPaste():"new"==t?e=Se.Clear:"zoomfit"==t?this.owner.autoScale():"zoomout"==t?this.owner.zoom(.8):"zoomin"==t?this.owner.zoom(1.25):"selall"==t?e=Se.SelectAll:"selnone"==t?e=Se.SelectNone:"selprev"==t?e=Se.SelectPrevComp:"selnext"==t?e=Se.SelectNextComp:"selside"==t?e=Se.SelectSide:"plus"==t?(e=Se.Charge,i={delta:1}):"minus"==t?(e=Se.Charge,i={delta:-1}):"one"==t?(e=Se.BondOrder,i={order:1}):"two"==t?(e=Se.BondOrder,i={order:2}):"three"==t?(e=Se.BondOrder,i={order:3}):"four"==t?(e=Se.BondOrder,i={order:4}):"zero"==t?(e=Se.BondOrder,i={order:0}):"inclined"==t?(e=Se.BondType,i={type:Vt.BONDTYPE_INCLINED}):"declined"==t?(e=Se.BondType,i={type:Vt.BONDTYPE_DECLINED}):"squig"==t?(e=Se.BondType,i={type:Vt.BONDTYPE_UNKNOWN}):"linear"==t?(e=Se.BondGeom,i={geom:Gt.Linear}):"trigonal"==t?(e=Se.BondGeom,i={geom:Gt.Trigonal}):"tetra1"==t?(e=Se.BondGeom,i={geom:Gt.Tetra1}):"tetra2"==t?(e=Se.BondGeom,i={geom:Gt.Tetra2}):"sqplan"==t?(e=Se.BondGeom,i={geom:Gt.SqPlan}):"octa1"==t?(e=Se.BondGeom,i={geom:Gt.Octa1}):"octa2"==t?(e=Se.BondGeom,i={geom:Gt.Octa2}):"switch"==t?e=Se.BondSwitch:"rotate"==t?e=Se.BondRotate:"connect"==t?e=Se.Connect:"disconnect"==t?e=Se.Disconnect:"metalligate"==t?e=Se.MetalLigate:"artifactpath"==t?e=Se.BondArtifactPath:"artifactring"==t?e=Se.BondArtifactRing:"artifactarene"==t?e=Se.BondArtifactArene:"artifactclear"==t?e=Se.BondArtifactClear:"polymer"==t?e=Se.PolymerBlock:"addtwo"==t?e=Se.BondAddTwo:"insert"==t?e=Se.BondInsert:"curelement"==t?e=Se.SelectCurElement:"selgrow"==t?e=Se.SelectGrow:"selshrink"==t?e=Se.SelectShrink:"selprev"==t?e=Se.SelectPrevComp:"selnext"==t?e=Se.SelectNextComp:"selchain"==t?e=Se.SelectChain:"smallring"==t?e=Se.SelectSmRing:"ringblock"==t?e=Se.SelectRingBlk:"toggle"==t?e=Se.SelectToggle:"uncurrent"==t?e=Se.SelectUnCurrent:"join"==t?e=Se.Join:"inline"==t?e=Se.AbbrevGroup:"formula"==t?e=Se.AbbrevFormula:"clearabbrev"==t?e=Se.AbbrevClear:"expandabbrev"==t?e=Se.AbbrevExpand:"up"==t?(e=Se.Nudge,i={dir:"up"}):"down"==t?(e=Se.Nudge,i={dir:"down"}):"left"==t?(e=Se.Nudge,i={dir:"left"}):"right"==t?(e=Se.Nudge,i={dir:"right"}):"uplots"==t?(e=Se.NudgeLots,i={dir:"up"}):"downlots"==t?(e=Se.NudgeLots,i={dir:"down"}):"leftlots"==t?(e=Se.NudgeLots,i={dir:"left"}):"rightlots"==t?(e=Se.NudgeLots,i={dir:"right"}):"upfar"==t?(e=Se.NudgeFar,i={dir:"up"}):"downfar"==t?(e=Se.NudgeFar,i={dir:"down"}):"leftfar"==t?(e=Se.NudgeFar,i={dir:"left"}):"rightfar"==t?(e=Se.NudgeFar,i={dir:"right"}):"rotp01"==t?(e=Se.Rotate,i={theta:1}):"rotm01"==t?(e=Se.Rotate,i={theta:-1}):"rotp05"==t?(e=Se.Rotate,i={theta:5}):"rotm05"==t?(e=Se.Rotate,i={theta:-5}):"rotp15"==t?(e=Se.Rotate,i={theta:15}):"rotm15"==t?(e=Se.Rotate,i={theta:-15}):"rotp30"==t?(e=Se.Rotate,i={theta:30}):"rotm30"==t?(e=Se.Rotate,i={theta:-30}):"hflip"==t?(e=Se.Flip,i={axis:"hor"}):"vflip"==t?(e=Se.Flip,i={axis:"ver"}):"shrink"==t?(e=Se.Scale,i={mag:1/1.1}):"grow"==t?(e=Se.Scale,i={mag:1.1}):"bondQAny"==t?e=Se.QueryBondAny:"atom"==t?this.buttonView.pushBank(new wi(this.owner,yi.Atom)):"bond"==t?this.buttonView.pushBank(new wi(this.owner,yi.Bond)):"select"==t?this.buttonView.pushBank(new wi(this.owner,yi.Select)):"move"==t?this.buttonView.pushBank(new wi(this.owner,yi.Move)):"abbrev"==t?this.buttonView.pushBank(new wi(this.owner,yi.Abbrev)):"sblock"==t?this.buttonView.pushBank(new wi(this.owner,yi.SBlock)):"pblock"==t?this.buttonView.pushBank(new wi(this.owner,yi.PBlock)):"dblock"==t?this.buttonView.pushBank(new wi(this.owner,yi.DBlock)):"fblock"==t?this.buttonView.pushBank(new wi(this.owner,yi.FBlock)):"noble"==t?this.buttonView.pushBank(new wi(this.owner,yi.Noble)):alert('Unhandled command: "'+t+'"');e>0&&new Be(this.owner.getState(),e,i,this.owner).execute()}claimKey(t){for(let e of[xi,Ai,vi,Mi,Ti])for(let i of e)if(mi.matchKey(t,i.mnemonic,i.key))return this.hitButton(i.id),!0;return!1}}class Ei{constructor(t,e,i){this.state=t,this.sketcher=e,this.proxyClip=i}populate(){const{state:e,sketcher:i}=this;let s=[];(i.canUndo()||i.canRedo())&&(i.canUndo()&&s.push({label:"Undo",accelerator:"CmdOrCtrl+Z",click:()=>i.performUndo()}),i.canRedo()&&s.push({label:"Redo",accelerator:"CmdOrCtrl+Shift+Z",click:()=>i.performRedo()}),s.push(null)),(e.currentAtom>0||e.currentBond>0)&&s.push({label:"Edit",accelerator:"Enter",click:()=>i.editCurrent()}),this.maybeAppend(s,"Delete","D",Se.Delete),this.maybeAppend(s,"Cut","CmdOrCtrl+X",Se.Cut),this.maybeAppend(s,"Copy","CmdOrCtrl+C",Se.Copy),this.proxyClip.canAlwaysGet()&&s.push({label:"Paste",accelerator:"CmdOrCtrl+V",click:()=>i.performPaste()}),this.maybeAppend(s,"Charge +","Shift+=",Se.Charge,{delta:1}),this.maybeAppend(s,"Charge -","Shift+-",Se.Charge,{delta:-1}),this.maybeAppend(s,"Bond Order 0","0",Se.BondOrder,{order:0}),this.maybeAppend(s,"Bond Order 1","1",Se.BondOrder,{order:1}),this.maybeAppend(s,"Bond Order 2","2",Se.BondOrder,{order:2}),this.maybeAppend(s,"Bond Order 3","3",Se.BondOrder,{order:3}),this.maybeAppend(s,"Bond Order 4",null,Se.BondOrder,{order:4}),this.maybeAppend(s,"Unknown Stereochemistry","4",Se.BondType,{type:Vt.BONDTYPE_UNKNOWN}),this.maybeAppend(s,"Bond Wedge Up","5",Se.BondType,{type:Vt.BONDTYPE_INCLINED}),this.maybeAppend(s,"Bond Wedge Down","6",Se.BondType,{type:Vt.BONDTYPE_DECLINED}),this.maybeAppend(s,"Switch Geometry",null,Se.BondSwitch),this.maybeAppend(s,"Add Two Bonds","Shift+D",Se.BondAddTwo),this.maybeAppend(s,"Insert Atom",null,Se.BondInsert),this.maybeAppend(s,"Join Atoms",null,Se.Join),this.maybeAppend(s,"Abbreviate Group","/",Se.AbbrevGroup),this.maybeAppend(s,"Abbreviate Formula","\\",Se.AbbrevFormula),this.maybeAppend(s,"Clear Abbreviation","Shift+\\",Se.AbbrevClear),this.maybeAppend(s,"Expand Abbreviation","Shift+/",Se.AbbrevExpand);let n=this.rotateSubMenu();t.notBlank(n)&&s.push({label:"Rotate",subMenu:n});let o=this.querySubMenu();t.notBlank(o)&&s.push({label:"Query",subMenu:o});let l=new Ot(e.mol);for(let t of l.getUnits()){let n=e.currentAtom,o=0;if(e.currentBond>0&&([n,o]=e.mol.bondFromTo(e.currentBond)),t.atoms.includes(n)||t.atoms.includes(o)){let e="Polymer Block ("+t.atoms.length+" atom"+(1==t.atoms.length?"":"s")+")";s.push({label:e,click:()=>i.performPolymerBlock(t.atoms)})}}return s.length>0&&s.push(null),s.push({label:"Scale to Fit",click:()=>i.autoScale()}),s.push({label:"Zoom In",accelerator:"=",click:()=>i.zoom(1.25)}),s.push({label:"Zoom Out",accelerator:"-",click:()=>i.zoom(.8)}),s}maybeAppend(t,e,i,s,n=null){let o=new Be(this.state,s,n);o.execute(),(o.output.mol||o.toClipboard)&&t.push({label:e,accelerator:i,click:()=>{this.sketcher.setState(o.output,!0),o.toClipboard&&this.proxyClip.setString(o.toClipboard)}})}rotateSubMenu(){let t=[];return this.maybeAppend(t,"Bond",null,Se.BondRotate),this.maybeAppend(t,"+1 ",null,Se.Rotate,{theta:1}),this.maybeAppend(t,"-1 ",null,Se.Rotate,{theta:-1}),this.maybeAppend(t,"+5 ",null,Se.Rotate,{theta:5}),this.maybeAppend(t,"-5 ",null,Se.Rotate,{theta:-5}),this.maybeAppend(t,"+15 ",null,Se.Rotate,{theta:15}),this.maybeAppend(t,"-15 ",null,Se.Rotate,{theta:-15}),this.maybeAppend(t,"+30 ","Shift+[",Se.Rotate,{theta:30}),this.maybeAppend(t,"-30 ","Shift+]",Se.Rotate,{theta:-30}),this.maybeAppend(t,"H-Flip","Shift+,",Se.Flip,{axis:"hor"}),this.maybeAppend(t,"V-Flip","Shift+.",Se.Flip,{axis:"ver"}),this.maybeAppend(t,"Align",null,Se.AlignRegular),t}querySubMenu(){let t=[];return this.maybeAppend(t,"Clear",null,Se.QueryClear),this.maybeAppend(t,"Copy",null,Se.QueryCopy),t}}var Ci,Si,ki,Bi;!function(t){t[t.None=0]="None",t[t.Press=1]="Press",t[t.Lasso=2]="Lasso",t[t.Pan=3]="Pan",t[t.Zoom=4]="Zoom",t[t.Rotate=5]="Rotate",t[t.Move=6]="Move",t[t.Erasor=7]="Erasor",t[t.Atom=8]="Atom",t[t.Bond=9]="Bond",t[t.Charge=10]="Charge",t[t.Ring=11]="Ring"}(Ci||(Ci={})),function(t){t[t.None=0]="None",t[t.Stereochemistry=1]="Stereochemistry",t[t.MappingNumber=2]="MappingNumber",t[t.AtomIndex=3]="AtomIndex"}(Si||(Si={}));class Ni extends ai{constructor(){super(),this.mol=null,this.policy=null,this.offsetX=0,this.offsetY=0,this.pointScale=1,this.viewOpt={decoration:Si.Stereochemistry,showOxState:!0,showQuery:!0,showArtifacts:!0},this.width=0,this.height=0,this.border=8421504,this.borderRadius=4,this.background=16316664,this.canvasUnder=null,this.canvasMolecule=null,this.canvasOver=null,this.divMessage=null,this.layout=null,this.metavec=null,this.stereo=null,this.guidelines=null,this.filthy=!1,this.dragType=Ci.None,this.currentAtom=0,this.currentBond=0,this.hoverAtom=0,this.hoverBond=0,this.selectedMask=null,this.opAtom=0,this.opBond=0,this.opBudged=!1,this.opShift=!1,this.opCtrl=!1,this.opAlt=!1,this.lassoX=null,this.lassoY=null,this.lassoMask=null,this.clickX=0,this.clickY=0,this.mouseX=0,this.mouseY=0,this.dragGuides=null,this.templatePerms=null,this.currentPerm=0,this.fusionBank=null,this.cursorWatermark=0,this.cursorDX=0,this.cursorDY=0,this.toolAtomSymbol="",this.toolBondOrder=0,this.toolBondType=0,this.toolChargeDelta=0,this.toolRingArom=!1,this.toolRingFreeform=!1,this.toolRotateIncr=0,this.redrawCacheKey="",this.abbrevPolicy=_e.defaultBlackOnWhite(),this.abbrevPolicy.data.foreground=13684944,this.abbrevPolicy.data.atomCols=t.numberArray(13684944,this.abbrevPolicy.data.atomCols.length)}render(t){if(!this.width||!this.height)throw"Sketcher.render called without width and height";super.render(t),this.container=it("<div/>").appendTo(this.contentDOM),this.container.css({position:"relative",width:this.width+"px",height:this.height+"px"}),this.container.css({"background-color":c(this.background)}),this.border!=si.NOCOLOUR&&(this.container.css({border:"1px solid "+c(this.border)}),this.container.css({"border-radius":this.borderRadius+"px"})),this.container.css({outline:"none"}),this.container.attr({tabindex:"0"});let e={position:"absolute",left:"0",top:"0",width:`${this.width}px`,height:`${this.height}`,"pointer-events":"none"};this.divInfo=it("<div/>").appendTo(this.container).css({position:"absolute",left:"0",top:"0","pointer-events":"none"}),this.canvasUnder=it("<canvas/>").appendTo(this.container).css(e),this.canvasMolecule=it("<canvas/>").appendTo(this.container).css(e),this.canvasOver=it("<canvas/>").appendTo(this.container).css(e),this.divMessage=it("<div/>").appendTo(this.container).css(e),this.divMessage.css({"text-align":"center","vertical-align":"middle","font-weight":"bold","font-size":"120%"})}getState(){return{mol:this.mol.clone(),currentAtom:this.currentAtom,currentBond:this.currentBond,selectedMask:null==this.selectedMask?null:this.selectedMask.slice(0)}}getSelected(t){return!(null==this.selectedMask||t>this.selectedMask.length)&&this.selectedMask[t-1]}getLassoed(t){return!(null==this.lassoMask||t>this.lassoMask.length)&&this.lassoMask[t-1]}scale(){return this.pointScale}angToX(t){return t*this.pointScale+this.offsetX}angToY(t){return t*-this.pointScale+this.offsetY}xToAng(t){return(t-this.offsetX)/this.pointScale}yToAng(t){return(t-this.offsetY)/-this.pointScale}scaleToAng(t){return t/this.pointScale}angToScale(t){return t*this.pointScale}yIsUp(){return!1}measureText(t,e){return Xe.main.measureText(t,e)}delayedRedraw(){null!=this.canvasMolecule&&(this.filthy=!0,window.setTimeout((()=>{this.filthy&&this.redraw()}),10))}layoutMolecule(){let t=this.mol;this.hoverAtom>0&&Kt.hasAbbrev(t,this.hoverAtom)&&(t=t.clone(),t.setAtomElement(this.hoverAtom,""),t.setAtomCharge(this.hoverAtom,0),t.setAtomUnpaired(this.hoverAtom,0),Kt.clearAbbrev(t,this.hoverAtom));let e=this.sketchEffects(t);this.layout=new He(t,this,this.policy,e),this.layout.setWantArtifacts(this.viewOpt.showArtifacts),this.layout.arrange()}redrawMetaVector(){if(this.metavec=new si,new ni(this.layout,this.metavec).draw(),this.hoverAtom>0&&Kt.hasAbbrev(this.mol,this.hoverAtom)){let t=Kt.getAbbrev(this.mol,this.hoverAtom);this.orientAbbreviation(this.hoverAtom,t),this.abbrevPolicy.data.pointScale=this.policy.data.pointScale;let e=new He(t,this,this.abbrevPolicy,new Ye);e.arrange(),new ni(e,this.metavec).draw()}}redraw(){this.filthy=!1,this.redrawInfo(),this.redrawUnder(),this.redrawMolecule(),this.redrawOver()}redrawInfo(){let t=JSON.stringify([this.width,this.height,this.mol.toString()]);if(t==this.redrawCacheKey)return;if(this.redrawCacheKey=t,this.divInfo.empty(),this.divInfo.css({visibility:"hidden",left:"0",top:"0"}),0==this.mol.numAtoms)return;let e=it("<div/>").appendTo(this.divInfo);e.css({display:"inline-block","text-align":"right","font-family":"sans-serif","font-size":"80%",color:"#C0C0C0"});let i=Kt.molecularFormula(this.mol,["<sub>","</sub>","<sup>","</sup>"]),s=0;for(let t=1;t<=this.mol.numAtoms;t++)s+=this.mol.atomCharge(t);-1==s?i+="<sup>-</sup>":s<-1?i+=`<sup>${s}</sup>`:1==s?i+="<sup>+</sup>":s>1&&(i+=`<sup>+${s}</sup>`),i+="<br>"+Kt.molecularWeight(this.mol).toFixed(2),e.setHTML(i),setTimeout((()=>{let t=e.width(),i=e.height();g(this.divInfo,this.width-t-1,1,t,i),this.divInfo.css({visibility:"visible"})}),1)}redrawUnder(){let t=14737632,e=10526880,i=8421504,s=12632256,n=13684944,o=F();this.canvasUnder.elCanvas.width=this.width*o,this.canvasUnder.elCanvas.height=this.height*o,this.canvasUnder.css({width:`${this.width}px`,height:`${this.height}px`});let l=this.canvasUnder.elCanvas.getContext("2d");if(l.save(),l.scale(o,o),l.clearRect(0,0,this.width,this.height),this.hoverAtom>0){let e=new Ot(this.mol).getUnits();for(let t of e)t.atoms.includes(this.hoverAtom)&&this.drawPolymerUnit(l,t,e);let i=0;this.hoverAtom==this.currentAtom&&(i+=.1),this.getSelected(this.hoverAtom)&&(i+=.1),this.currentBond>0&&(this.mol.bondFrom(this.currentBond)==this.hoverAtom||this.mol.bondTo(this.currentBond)==this.hoverAtom)&&(i+=.1),this.drawAtomShade(l,this.hoverAtom,t,-1,i)}if(this.hoverBond>0){let e=this.mol.bondFrom(this.hoverBond),i=this.mol.bondTo(this.hoverBond),s=new Ot(this.mol).getUnits();for(let t of s)t.atoms.includes(e)&&t.atoms.includes(i)&&this.drawPolymerUnit(l,t,s);let n=0;this.hoverBond==this.currentBond&&(n+=.1),this.getSelected(e)&&this.getSelected(i)&&(n+=.1),this.drawBondShade(l,this.hoverBond,t,-1,n)}for(let t=1;t<=this.mol.numBonds;t++){let e=t==this.currentBond?.1:0,i=this.mol.bondFrom(t),o=this.mol.bondTo(t),r=this.getSelected(i),a=this.getSelected(o),h=this.getLassoed(i),u=this.getLassoed(o);r&&a?this.drawBondShade(l,t,s,-1,e):(r||h)&&(a||u)&&this.drawBondShade(l,t,n,-1,e)}for(let t=1;t<=this.mol.numAtoms;t++){let e=this.currentAtom==t?.1:0;this.getSelected(t)?this.drawAtomShade(l,t,s,-1,e):this.getLassoed(t)&&this.drawAtomShade(l,t,n,-1,e)}if(this.currentAtom>0&&this.drawAtomShade(l,this.currentAtom,e,i,0),this.currentBond>0&&this.drawBondShade(l,this.currentBond,e,i,0),(this.dragType==Ci.Move||this.dragType==Ci.Atom&&this.opAtom>0||this.dragType==Ci.Bond)&&null!=this.dragGuides&&this.dragGuides.length>0)for(let t of this.dragGuides)for(let e=0;e<t.x.length;e++){let i=this.policy.data.lineSize*this.pointScale;l.strokeStyle="#C0C0C0",l.lineWidth=i,P(l,t.sourceX,t.sourceY,t.destX[e],t.destY[e]),l.beginPath(),l.ellipse(t.destX[e],t.destY[e],2*i,2*i,0,0,E,!1),l.fillStyle="#C0C0C0",l.fill()}if(this.dragType==Ci.Ring){let[t,e]=this.determineFauxRing(),i=null==t?0:t.length;if(i>0){let s=this.pointScale,n=this.policy.data.lineSize*s;l.strokeStyle="#C0C0C0",l.lineWidth=n;for(let s=0;s<i;s++){let n=s<i-1?s+1:0;P(l,this.angToX(t[s]),this.angToY(e[s]),this.angToX(t[n]),this.angToY(e[n]))}if(this.toolRingArom){let s=0,n=0;for(let o=0;o<i;o++)s+=t[o],n+=e[o];s/=i,n/=i;let o=0;for(let l=0;l<i;l++)o+=b(t[l]-s,e[l]-n);o=this.angToScale(.5*o/i),l.beginPath(),l.ellipse(this.angToX(s),this.angToY(n),o,o,0,0,E,!1),l.stroke()}}}l.restore()}redrawMolecule(){let t=F();this.canvasMolecule.elCanvas.width=this.width*t,this.canvasMolecule.elCanvas.height=this.height*t,this.canvasMolecule.css({width:`${this.width}px`,height:`${this.height}px`});let e=this.canvasMolecule.elCanvas.getContext("2d");if(e.save(),e.scale(t,t),e.clearRect(0,0,this.width,this.height),null!=this.metavec&&this.metavec.renderContext(e),null!=this.templatePerms){let t=this.templatePerms[this.currentPerm];null!=t.metavec&&t.metavec.renderContext(e)}e.restore()}redrawOver(){let t=F();this.canvasOver.elCanvas.width=this.width*t,this.canvasOver.elCanvas.height=this.height*t,this.canvasOver.css({width:`${this.width}px`,height:`${this.height}px`});let e=this.canvasOver.elCanvas.getContext("2d");if(e.save(),e.scale(t,t),e.clearRect(0,0,this.width,this.height),(this.dragType==Ci.Lasso||this.dragType==Ci.Erasor)&&this.lassoX.length>1){let t=this.dragType==Ci.Erasor,i=new Path2D;i.moveTo(this.lassoX[0],this.lassoY[0]);for(let t=1;t<this.lassoX.length;t++)i.lineTo(this.lassoX[t],this.lassoY[t]);i.closePath(),e.fillStyle=c(t?3506372608:4026531840),e.fill(i),e.strokeStyle=t?"#804040":"#808080",e.lineWidth=.5,e.stroke(i)}if(this.dragType==Ci.Rotate){let[t,i,s,n]=this.determineDragTheta(),o=this.pointScale,l=this.policy.data.lineSize*o;e.strokeStyle="#E0E0E0",e.lineWidth=.5*l,P(e,t,i,t+n,i),e.strokeStyle="#808080",e.lineWidth=l,P(e,t,i,t+n*Math.cos(s),i+n*Math.sin(s)),e.beginPath(),e.ellipse(t,i,2*l,2*l,0,0,E,!1),e.fillStyle="#808080",e.fill();for(let n of this.subjectAtoms(!0,!1)){let o=this.angToX(this.mol.atomX(n)),r=this.angToY(this.mol.atomY(n)),a=Math.atan2(r-i,o-t),h=b(o-t,r-i),u=t+h*Math.cos(a+s),m=i+h*Math.sin(a+s);e.beginPath(),e.ellipse(u,m,2*l,2*l,0,0,E,!1),e.strokeStyle="black",e.lineWidth=.5,e.stroke()}}if(this.dragType==Ci.Move){let[t,i]=this.determineMoveDelta(),s=this.pointScale,n=this.policy.data.lineSize*s;for(let s of this.subjectAtoms(!1,!0)){let o=this.angToX(this.mol.atomX(s)),l=this.angToY(this.mol.atomY(s));e.beginPath(),e.ellipse(o+t,l+i,2*n,2*n,0,0,E,!1),e.strokeStyle="black",e.lineWidth=.5,e.stroke()}}if(this.dragType==Ci.Atom&&this.opAtom>0||this.dragType==Ci.Bond){let t=this.dragType==Ci.Atom?this.toolAtomSymbol:"C",i=this.dragType==Ci.Bond?this.toolBondOrder:1,s=this.dragType==Ci.Bond?this.toolBondType:Vt.BONDTYPE_NORMAL;this.drawOriginatingBond(e,t,i,s)}this.viewOpt.showQuery&&this.drawQueryFeatures(e),e.restore()}subjectAtoms(t=!1,e=!1){let i=[];if(null!=this.selectedMask){for(let t=0;t<this.selectedMask.length;t++)this.selectedMask[t]&&i.push(t+1);if(i.length>0)return i}if(this.currentAtom>0?i.push(this.currentAtom):this.currentBond>0&&(i.push(this.mol.bondFrom(this.currentBond)),i.push(this.mol.bondTo(this.currentBond))),e&&0==i.length&&this.opAtom>0&&i.push(this.opAtom),t&&0==i.length)for(let t=1;t<=this.mol.numAtoms;t++)i.push(t);return i}updateLasso(e,i){if(this.dragType!=Ci.Lasso&&this.dragType!=Ci.Erasor)return;(e<0||i<0||e>this.width||i>this.height)&&(this.dragType=Ci.None,this.lassoX=null,this.lassoY=null,this.lassoMask=null,this.delayedRedraw());let s=t.len(this.lassoX);s>0&&this.lassoX[s-1]==e&&this.lassoY[s-1]==i||(this.lassoX.push(e),this.lassoY.push(i),this.calculateLassoMask(),this.delayedRedraw())}calculateLassoMask(){this.lassoMask=new Array(this.mol.numAtoms);for(let t=0;t<this.mol.numAtoms;t++)this.lassoMask[t]=!1;for(let t=0;t<this.layout.numPoints();t++){let e=this.layout.getPoint(t);0!=e.anum&&(this.lassoMask[e.anum-1]=G.pointInPolygon(e.oval.cx,e.oval.cy,this.lassoX,this.lassoY))}}drawAtomShade(t,e,i,s,n){if(null==this.layout)return;let o=null;for(let t=0;t<this.layout.numPoints();t++)if(this.layout.getPoint(t).anum==e){o=this.layout.getPoint(t);break}if(null==o)return;let l=.2*this.pointScale,r=(v(l),o.oval.cx),a=o.oval.cy,h=Math.max(l,Math.max(o.oval.rw,o.oval.rh))+(.1+n)*this.pointScale;-1!=i&&(t.beginPath(),t.ellipse(r,a,h,h,0,0,E,!0),t.fillStyle=c(i),t.fill()),-1!=s&&(t.beginPath(),t.ellipse(r,a,h,h,0,0,E,!0),t.strokeStyle=c(s),t.lineWidth=1,t.stroke())}drawBondShade(t,e,i,s,n){if(null==this.layout)return;let o=0,l=0,r=0,a=0,h=0,u=0;for(let t=0;t<this.layout.numLines();t++){let i=this.layout.getLine(t);i.bnum==e&&(o+=i.line.x1,l+=i.line.y1,r+=i.line.x2,a+=i.line.y2,h++,u+=i.size+(.2+n)*this.pointScale)}if(0==h)return;let m=1/h;u*=m,o*=m,l*=m,r*=m,a*=m;let d=r-o,p=a-l,f=1/b(d,p);d*=f,p*=f;let g,y,x=p,A=-d,v=new Path2D,M=.8;v.moveTo(o+x*u,l+A*u),g=o+(x*u-d*u)*M,y=l+(A*u-p*u)*M,v.quadraticCurveTo(g,y,o-d*u,l-p*u),g=o+(-x*u-d*u)*M,y=l+(-A*u-p*u)*M,v.quadraticCurveTo(g,y,o-x*u,l-A*u),v.lineTo(r-x*u,a-A*u),g=r+(-x*u+d*u)*M,y=a+(-A*u+p*u)*M,v.quadraticCurveTo(g,y,r+d*u,a+p*u),g=r+(x*u+d*u)*M,y=a+(A*u+p*u)*M,v.quadraticCurveTo(g,y,r+x*u,a+A*u),v.closePath(),-1!=i&&(t.beginPath(),t.fillStyle=c(i),t.fill(v)),-1!=s&&(t.beginPath(),t.strokeStyle=c(s),t.lineWidth=1,t.stroke(v))}drawOriginatingBond(t,e,i,s){let n=this.clickX,o=this.clickY;if(this.opAtom>0)n=this.angToX(this.mol.atomX(this.opAtom)),o=this.angToY(this.mol.atomY(this.opAtom));else if(this.opBond>0){let[t,e]=this.mol.bondFromTo(this.opBond);n=this.angToX(.5*(this.mol.atomX(t)+this.mol.atomX(e))),o=this.angToY(.5*(this.mol.atomY(t)+this.mol.atomY(e)))}let l=this.mouseX,r=this.mouseY,a=this.snapToGuide(l,r),h=!1;a&&([l,r,h]=a);let u=this.pointScale;if(t.strokeStyle=h?"#4040FF":"#808080",t.lineWidth=this.policy.data.lineSize*u*(h?1.5:1),P(t,n,o,l,r),"C"!=e){let i=this.policy.data.fontSize*u;t.font=z(i);let s=t.measureText(e);t.fillStyle="#808080",t.fillText(e,l-.5*s.width,r+.5*i)}}drawQueryFeatures(t){const{layout:e,mol:i}=this;let s=[];for(let t=1;t<=i.numAtoms;t++)if(It.hasAnyQueryAtom(i,t)){let n=[];for(let e of i.atomExtra(t))e.startsWith("q")&&n.push(e);let o=e.getPoint(t-1);s.push({txt:n.join(","),x:o.oval.cx+o.oval.rw,y:o.oval.cy})}for(let t=1;t<=i.numBonds;t++)if(It.hasAnyQueryBond(i,t)){let n=[];for(let e of i.bondExtra(t))e.startsWith("q")&&!e.startsWith(Nt.Orders)&&n.push(e);let o=0,l=0,r=0;for(let i of e.getLines())i.bnum==t&&(o+=2,l+=i.line.x1+i.line.x2,r+=i.line.y1+i.line.y2);s.push({txt:n.join(","),x:l/o,y:r/o})}let n=.7*this.policy.data.fontSize*this.pointScale;for(let e of s)t.font=z(n),t.fillStyle="#FF40C0",t.fillText(e.txt,e.x,e.y)}drawPolymerUnit(e,i,s){const{mol:n,layout:o}=this;let l=[],r=[],a=this.pointScale;for(let t of i.atoms){let e=o.getPoint(t-1),i=Math.max(.5*a,Math.max(e.oval.rw,e.oval.rh));const s=36,n=E/s;for(let t=0;t<s;t++){let s=t*n;l.push(e.oval.cx+i*Math.cos(s)),r.push(e.oval.cy+i*Math.sin(s))}}let h=[],u=[],m=[];for(let t=1;t<=n.numBonds;t++){let e=n.bondFrom(t),s=n.bondTo(t),d=i.atoms.includes(e),c=i.atoms.includes(s);if(!d&&!c)continue;c?d||(h.push(t),u.push(s),m.push(e)):(h.push(t),u.push(e),m.push(s));let p=o.getPoint(e-1),f=o.getPoint(s-1),g=p.oval.cx,y=p.oval.cy,x=f.oval.cx,A=f.oval.cy;d?c||([x,A]=[.5*(g+x),.5*(y+A)]):[g,y]=[.5*(g+x),.5*(y+A)];let v=x-g,T=A-y,w=b(v,T),E=M(w),C=T*E*.3*a,S=-v*E*.3*a,k=Math.ceil(2*w/a)+1,B=Math.ceil(2*b(C,S)/a)+1;for(let t=0;t<=k;t++)l.push(g-C+v*t/k),r.push(y-S+T*t/k),l.push(g+C+v*t/k),r.push(y+S+T*t/k);for(let t=1;t<B;t++)l.push(g-C+2*C*t/B),r.push(y-S+2*S*t/B),l.push(x-C+2*C*t/B),r.push(A-S+2*S*t/B)}let[d,c]=G.outlinePolygon(l,r,.5*a),p=new Path2D;p.moveTo(d[0],c[0]);for(let t=1;t<d.length;t++)p.lineTo(d[t],c[t]);p.closePath(),e.save(),e.fillStyle="#F9EFFF",e.fill(p),e.strokeStyle="#C0C0C0",e.lineWidth=1,e.stroke(p),e.restore();let f=[],g=[],y=[];if(4==t.len(i.bondConn))g.push([u[h.indexOf(i.bondConn[0])],u[h.indexOf(i.bondConn[2])]]),g.push([u[h.indexOf(i.bondConn[1])],u[h.indexOf(i.bondConn[3])]]);else if(2==t.len(h)&&null!=i.connect)i.connect!=kt.HeadToTail&&i.connect!=kt.Random||g.push([u[0],u[1]]),i.connect!=kt.HeadToHead&&i.connect!=kt.Random||(f.push(u[0]),f.push(u[1]));else for(let e of h){let o=n.bondFrom(e),l=n.bondTo(e);i.atoms.includes(l)&&([o,l]=[l,o]);let r=i.bondIncl.get(e),a=i.bondExcl.get(e),h="*"!=n.atomElement(l);for(let e of h?[i]:s)for(let s of e.atoms){let l=!1;for(let t of n.atomAdjList(s))if(!e.atoms.includes(t)){l=!0;break}if(l){if(t.notBlank(r)){let t=e.atomName.get(s),i=!1;if(t)for(let e of t)i=i||r.includes(e);if(!i)continue}if(t.notBlank(a)){let t=e.atomName.get(s),i=!1;if(t)for(let e of t)i=i||a.includes(e);if(i)continue}s==o?f.push(o):i===e?g.push([o,s]):y.push([o,s])}}}f=t.uniqueStable(f),g=t.maskGet(g,t.maskUnique(g.map((e=>t.min(e)*n.numAtoms+t.max(e))))),y=t.maskGet(y,t.maskUnique(y.map((e=>t.min(e)*n.numAtoms+t.max(e))))),e.save(),e.strokeStyle="#6329C1",e.lineWidth=2,e.setLineDash([1,1]),e.beginPath();for(let t of f){let i=o.getPoint(t-1),s=i.oval.cx,n=i.oval.cy,l=0,r=0,d=0;for(let e=0;e<h.length;e++)if(u[e]==t){let t=o.getPoint(m[e]-1);l+=t.oval.cx,r+=t.oval.cy,d++}d>1&&(l/=d,r/=d),l=s+.5*(l-s),r=n+.5*(r-n);let c=l-s,p=r-n,f=M(b(c,p)),g=p*f,y=-c*f,x=.5*(s+l),A=.5*(n+r);const v=2*a;e.moveTo(s,n),e.quadraticCurveTo(x+g*v,A+y*v,l,r),e.quadraticCurveTo(x-g*v,A-y*v,s,n)}for(let[t,i]of g){let s=n.atomX(t),o=n.atomY(t),l=n.atomX(i),r=n.atomY(i),a=l-s,h=r-o,u=M(b(a,h)),m=h*u,d=-a*u,c=.5*(s+l),p=.5*(o+r);const f=5;let g=c+m*f,y=p+d*f,x=c-m*f,A=p-d*f,[v,T]=Wt.congestionPoint(n,g,y)<Wt.congestionPoint(n,x,A)?[g,y]:[x,A];e.moveTo(this.angToX(s),this.angToY(o)),e.quadraticCurveTo(this.angToX(v),this.angToY(T),this.angToX(l),this.angToY(r))}for(let[t,i]of y){let s=o.getPoint(t-1),n=o.getPoint(i-1);e.moveTo(s.oval.cx,s.oval.cy),e.lineTo(n.oval.cx,n.oval.cy)}e.stroke(),e.restore()}determineFauxRing(){let t=this.opAtom,e=this.opBond,i=this.mol,s=t>0?i.atomX(t):e>0?.5*(i.atomX(i.bondFrom(e))+i.atomX(i.bondTo(e))):this.xToAng(this.clickX),n=t>0?i.atomY(t):e>0?.5*(i.atomY(i.bondFrom(e))+i.atomY(i.bondTo(e))):this.yToAng(this.clickY),o=this.xToAng(this.mouseX)-s,l=this.yToAng(this.mouseY)-n,r=Math.min(9,Math.round(2*b(o,l)/Vt.IDEALBOND)+2);return r<3?[null,null]:e>0?Qt.proposeBondRing(i,r,e,o,l):t>0&&i.atomAdjCount(t)>0&&!this.toolRingFreeform?Qt.proposeAtomRing(i,r,t,o,l):Qt.proposeNewRing(i,r,s,n,o,l,!this.toolRingFreeform)}determineDragTheta(){let t=this.clickX,e=this.clickY,i=this.snapToGuide(t,e);null!=i&&(t=i[0],e=i[1]);let s=Math.atan2(this.mouseY-e,this.mouseX-t),n=b(this.mouseX-t,this.mouseY-e);return this.toolRotateIncr>0&&(s=Math.round(s/this.toolRotateIncr)*this.toolRotateIncr),[t,e,s,n]}determineMoveDelta(){let t=this.clickX,e=this.clickY,i=this.mouseX,s=this.mouseY;if(this.opAtom>0){t=this.angToX(this.mol.atomX(this.opAtom)),e=this.angToY(this.mol.atomY(this.opAtom));let n=this.snapToGuide(i,s);null!=n&&(i=n[0],s=n[1])}return[i-t,s-e]}snapToGuide(t,e){if(this.opBond>0){let i=this.pickObject(t,e);if(i<0){let[t,e]=this.mol.bondFromTo(-i);return[this.angToX(.5*(this.mol.atomX(t)+this.mol.atomX(e))),this.angToY(.5*(this.mol.atomY(t)+this.mol.atomY(e))),!1]}return null}let i=Number.POSITIVE_INFINITY,s=0,n=0,o=!1;const l=v(.5*this.pointScale);if(null!=this.dragGuides)for(let r=0;r<this.dragGuides.length;r++)for(let a=0;a<this.dragGuides[r].x.length;a++){let h=this.dragGuides[r].destX[a],u=this.dragGuides[r].destY[a],m=y(h-t,u-e);m<l&&m<i&&([i,s,n,o]=[m,h,u,!1])}for(let r=1;r<=this.mol.numAtoms;r++){let a=this.angToX(this.mol.atomX(r)),h=this.angToY(this.mol.atomY(r)),u=y(a-t,h-e);u<l&&u<i&&([i,s,n,o]=[u,a,h,!0])}return isFinite(i)?[s,n,o]:null}pickObjectCanvas(t,e,i={}){let s=.5*this.pointScale,n=0,o=Number.POSITIVE_INFINITY;if(!i.noAtoms)for(let i=0;i<this.layout.numPoints();i++){let l=this.layout.getPoint(i);if(0==l.anum)continue;let r=y(Math.abs(t-l.oval.cx),Math.abs(e-l.oval.cy));r>v(Math.max(s,Math.max(l.oval.rw,l.oval.rh)))||r<o&&(n=l.anum,o=r)}if(0!=n)return n;if(!i.noBonds)for(let i=0;i<this.layout.numLines();i++){let l=this.layout.getLine(i);if(0==l.bnum)continue;let r=l.line.x1,a=l.line.y1,h=l.line.x2,u=l.line.y2;if(t<Math.min(r,h)-s||e<Math.min(a,u)-s||t>Math.max(r,h)+s||e>Math.max(a,u)+s)continue;let m=G.pointLineSegDistance(t,e,r,a,h,u);m>s||m<o&&(n=-l.bnum,o=m)}return n}pickObject(t,e,i={}){return this.pickObjectCanvas(t,e,i)||0}sketchEffects(e){let i=new Ye;for(let t=1;t<=e.numAtoms;t++)Kt.hasAbbrev(e,t)&&t!=this.hoverAtom&&(i.dottedRectOutline[t]=8421504);if(i.overlapAtoms=Wt.overlappingAtomList(e,.2),i.atomDecoText=t.stringArray("",e.numAtoms),i.atomDecoCol=t.numberArray(ot.foreground,e.numAtoms),i.atomDecoSize=t.numberArray(.3,e.numAtoms),i.bondDecoText=t.stringArray("",e.numBonds),i.bondDecoCol=t.numberArray(ot.foreground,e.numBonds),i.bondDecoSize=t.numberArray(.3,e.numBonds),this.viewOpt.showOxState)for(let t=1;t<=e.numAtoms;t++){let s=Kt.atomOxidationState(e,t);null!=s&&(i.atomDecoText[t-1]=Kt.oxidationStateText(s),i.atomDecoCol[t-1]=16744576)}if(this.viewOpt.decoration==Si.Stereochemistry){this.stereo||(this.stereo=ce.create(pe.createStrict(e)));t:for(let t=1;t<=e.numAtoms;t++){let s=this.stereo.atomTetraChirality(t);if(s!=ce.STEREO_NONE){for(let i of e.atomAdjBonds(t))if(1!=e.bondOrder(i))continue t;if(s==ce.STEREO_UNKNOWN)for(let i of e.atomAdjList(t))if(gt.ELEMENT_BLOCKS[e.atomicNumber(i)]>=3)continue t;i.atomDecoText[t-1]=s==ce.STEREO_POS?"R":s==ce.STEREO_NEG?"S":s==ce.STEREO_UNKNOWN?"R/S":"?",i.atomDecoCol[t-1]=40960}}for(let t=1;t<=e.numBonds;t++){let e=this.stereo.bondSideStereo(t);e!=ce.STEREO_NONE&&(i.bondDecoText[t-1]=e==ce.STEREO_POS?"Z":e==ce.STEREO_NEG?"E":e==ce.STEREO_UNKNOWN?"Z/E":"?",i.bondDecoCol[t-1]=40960)}}else if(this.viewOpt.decoration==Si.MappingNumber){i.atomDecoText=t.stringArray("",e.numAtoms),i.atomDecoCol=t.numberArray(8388863,e.numAtoms),i.atomDecoSize=t.numberArray(.3,e.numAtoms);for(let t=1;t<=e.numAtoms;t++)e.atomMapNum(t)>0&&(i.atomDecoText[t-1]=e.atomMapNum(t).toString())}else if(this.viewOpt.decoration==Si.AtomIndex){i.atomDecoText=t.stringArray("",e.numAtoms),i.atomDecoCol=t.numberArray(8388863,e.numAtoms),i.atomDecoSize=t.numberArray(.3,e.numAtoms);for(let t=1;t<=e.numAtoms;t++)i.atomDecoText[t-1]=t.toString()}return i}orientAbbreviation(t,e){const{mol:i}=this;if(Kt.isBlank(e))return;if(1!=this.mol.atomAdjCount(t))return;let s=i.atomAdjList(t)[0],n=i.atomX(t)-i.atomX(s),o=i.atomY(t)-i.atomY(s),l=e.atomAdjList(1),r=0,a=0,h=M(l.length);for(let t of l)r+=e.atomX(t)-e.atomX(1),a+=e.atomY(t)-e.atomY(1);r*=h,a*=h;let u=Math.atan2(o,n),m=Math.atan2(a,r);Wt.rotateMolecule(e,u-m),1==l.length?(Wt.translateMolecule(e,i.atomX(t)-e.atomX(l[0]),i.atomY(t)-e.atomY(l[0])),e.setAtomPos(1,i.atomX(s),i.atomY(s))):Wt.translateMolecule(e,i.atomX(s)-e.atomX(1),i.atomY(s)-e.atomY(1));for(let t of e.atomAdjBonds(1)){let i=e.bondOther(t,1);e.atomHExplicit(i)==Vt.HEXPLICIT_UNKNOWN&&e.setAtomHExplicit(i,Math.max(0,e.atomHydrogens(i)))}e.deleteAtomAndBonds(1)}}class qi extends ai{constructor(t,e=!1){if(super(),this.options=t,this.isVertical=e,this.padding=6,this.htmlLabels=!1,this.numCols=0,this.selidx=0,this.buttonDiv=[],this.auxCell=[],this.callbackSelect=null,0==t.length)throw"molsync.ui.OptionList: must provide a list of option labels.";rt("option")||at("option",this.composeCSS())}getSelectedIndex(){return this.selidx}getSelectedValue(){return this.options[this.selidx]}getAuxiliaryCell(t){return this.auxCell[t].el}onSelect(t){this.callbackSelect=t}render(t){super.render(t),this.contentDOM.css({display:"block","baseline-shift":"1.5em"}),this.buttonDiv=[],this.auxCell=[];let e=it('<table class="wmk-option-table"/>').appendTo(this.contentDOM),i=this.isVertical?null:it("<tr/>").appendTo(e);for(let t=0;t<this.options.length;t++){(this.isVertical||this.numCols>0&&t>0&&t%this.numCols==0)&&(i=it("<tr/>").appendTo(e));let s=it('<td class="wmk-option-cell"/>').appendTo(i),n=it('<div class="wmk-option"/>').appendTo(s);n.css({padding:`${this.padding}px`}),n.onClick((()=>this.clickButton(t))),this.buttonDiv.push(n),this.isVertical&&(s=it('<td style="vertical-align: middle;"/>').appendTo(i),this.auxCell.push(s))}this.updateButtons()}clickButton(t){t!=this.selidx&&(this.setSelectedIndex(t),this.callbackSelect&&this.callbackSelect(t,this))}setSelectedIndex(t){this.selidx!=t&&(this.selidx=t,this.updateButtons())}setSelectedValue(t){let e=this.options.indexOf(t);e>=0&&this.setSelectedIndex(e)}updateButtons(){for(let t=0;t<this.options.length&&t<this.buttonDiv.length;t++){let e=this.buttonDiv[t],i=this.options[t];0==i.length&&t==this.selidx?e.setText(""):0==i.length?e.setText(""):this.htmlLabels?e.setHTML(i):e.setText(i),e.removeClass("wmk-option-unselected wmk-option-selected"),t!=this.selidx?e.addClass("wmk-option-unselected"):e.addClass("wmk-option-selected")}}composeCSS(){u(ot.lowlight);let t=u(ot.lowlightEdge1),e=u(ot.lowlightEdge2);return u(ot.highlight),`\n\t\t\t.wmk-option\n\t\t\t{\n\t\t\t\tmargin-bottom: 0;\n\t\t\t\tfont-family: 'Open Sans', sans-serif;\n\t\t\t\tfont-size: 14px;\n\t\t\t\tfont-weight: normal;\n\t\t\t\ttext-align: center;\n\t\t\t\twhite-space: nowrap;\n\t\t\t\tline-height: 1.2em;\n\t\t\t\tcursor: pointer;\n\t\t\t}\n\t\t\t.wmk-option-selected\n\t\t\t{\n\t\t\t\tcolor: white;\n\t\t\t\tbackground-color: #008FD2;\n\t\t\t\tbackground-image: linear-gradient(to right bottom, ${t}, ${e});\n\t\t\t}\n\t\t\t.wmk-option-unselected\n\t\t\t{\n\t\t\t\tcolor: #333;\n\t\t\t\tbackground-color: white;\n\t\t\t\tbackground-image: linear-gradient(to right bottom, #FFFFFF, #E0E0E0);\n\t\t\t}\n\t\t\t.wmk-option-unselected:hover\n\t\t\t{\n\t\t\t\tbackground-color: #808080;\n\t\t\t\tbackground-image: linear-gradient(to right bottom, #F0F0F0, #D0D0D0);\n\t\t\t}\n\t\t\t.wmk-option-unselected:active\n\t\t\t{\n\t\t\t\tcolor: white;\n\t\t\t\tbackground-color: #00C000;\n\t\t\t\tbackground-image: linear-gradient(to right bottom, ${u(ot.highlightEdge1)}, ${u(ot.highlightEdge2)});\n\t\t\t}\n\t\t\t.wmk-option-table\n\t\t\t{\n\t\t\t\tmargin: 1px;\n\t\t\t\tpadding: 0;\n\t\t\t\tborder-width: 0;\n\t\t\t\tborder-collapse: collapse;\n\t\t\t}\n\t\t\t.wmk-option-cell\n\t\t\t{\n\t\t\t\tmargin: 0;\n\t\t\t\tpadding: 0;\n\t\t\t\tborder-width: 0;\n\t\t\t\tborder-width: 1px;\n\t\t\t\tborder-style: solid;\n\t\t\t\tborder-color: #808080;\n\t\t\t}\n\t\t`}}class Oi extends ai{constructor(t){super(),this.options=t,this.unionHeight=!1,this.selidx=0,this.buttonDiv=[],this.panelDiv=[],this.padding=6,this.callbackSelect=null,rt("tabbar")||at("tabbar",this.composeCSS())}onSelect(t){this.callbackSelect=t}getSelectedIndex(){return this.selidx}getSelectedValue(){return this.options[this.selidx]}getPanelDOM(t){let e="number"==typeof t?t:this.options.indexOf(t);return e<0?null:this.panelDiv[e]}render(t){super.render(t);let e=it("<div/>").appendTo(this.contentDOM).css({display:"grid"});e.css({"align-items":"center","justify-content":"start","grid-row-gap":"0.5em"});let i="[start] 1fr ";for(let t=0;t<this.options.length;t++)i+="[btn"+t+"] auto ";i+="[btnX] 1fr [end]",e.css({"grid-template-columns":i});let s=it("<div/>").appendTo(e);s.css({"grid-column":"start / end","grid-row":"1",height:"100%"}),s.css({"border-bottom":"1px solid #C0C0C0"});for(let t=0;t<this.options.length;t++){let i=it('<div class="wmk-tabbar-cell"/>').appendTo(e);i.css({"grid-column":"btn"+t,"grid-row":"1"});let s=it('<div class="wmk-tabbar"/>').appendTo(i);s.css({padding:`${this.padding}px`}),s.onClick((()=>this.clickButton(t))),this.buttonDiv.push(s);let n=it("<div/>").appendTo(e);n.css({"grid-column":"start / end","grid-row":"2"}),n.css({"align-self":"start","justify-self":"center",width:"100%"}),this.panelDiv.push(n)}this.updateButtons()}clickButton(t){t!=this.selidx&&(this.setSelectedIndex(t),this.callbackSelect&&this.callbackSelect(t,this))}setSelectedIndex(t){if(this.selidx==t)return;this.selidx=t;let e=this.contentDOM;e.setCSS("min-width",`${e.width()}px`),this.updateButtons()}setSelectedValue(t){let e=this.options.indexOf(t);e>=0&&this.setSelectedIndex(e)}rotateSelected(t){this.setSelectedIndex((this.selidx+t+this.options.length)%this.options.length)}updateButtons(){for(let t=0;t<this.options.length&&t<this.buttonDiv.length;t++){let e=this.buttonDiv[t],i=this.options[t];0==i.length&&t==this.selidx?e.setText(""):0==i.length?e.setText(""):e.setText(i),e.removeClass("wmk-tabbar-unselected wmk-tabbar-selected"),t!=this.selidx?e.addClass("wmk-tabbar-unselected"):e.addClass("wmk-tabbar-selected"),this.unionHeight?this.panelDiv[t].setCSS("visibility",t==this.selidx?"visible":"hidden"):this.panelDiv[t].setCSS("display",t==this.selidx?"block":"none")}}composeCSS(){u(ot.lowlight);let t=u(ot.lowlightEdge1),e=u(ot.lowlightEdge2);return u(ot.highlight),`\n\t\t\t.wmk-tabbar\n\t\t\t{\n\t\t\t\tmargin-bottom: 0;\n\t\t\t\tfont-family: 'Open Sans', sans-serif;\n\t\t\t\tfont-size: 14px;\n\t\t\t\tfont-weight: normal;\n\t\t\t\ttext-align: center;\n\t\t\t\twhite-space: nowrap;\n\t\t\t\tvertical-align: middle;\n\t\t\t\tcursor: pointer;\n\t\t\t}\n\t\t\t.wmk-tabbar-selected\n\t\t\t{\n\t\t\t\tcolor: white;\n\t\t\t\tbackground-color: #008FD2;\n\t\t\t\tbackground-image: linear-gradient(to right bottom, ${t}, ${e});\n\t\t\t}\n\t\t\t.wmk-tabbar-unselected\n\t\t\t{\n\t\t\t\tcolor: #333;\n\t\t\t\tbackground-color: white;\n\t\t\t\tbackground-image: linear-gradient(to right bottom, #FFFFFF, #E0E0E0);\n\t\t\t}\n\t\t\t.wmk-tabbar-unselected:hover\n\t\t\t{\n\t\t\t\tbackground-color: #808080;\n\t\t\t\tbackground-image: linear-gradient(to right bottom, #F0F0F0, #D0D0D0);\n\t\t\t}\n\t\t\t.wmk-tabbar-unselected:active\n\t\t\t{\n\t\t\t\tcolor: white;\n\t\t\t\tbackground-color: #00C000;\n\t\t\t\tbackground-image: linear-gradient(to right bottom, ${u(ot.highlightEdge1)}, ${u(ot.highlightEdge2)});\n\t\t\t}\n\t\t\t.wmk-tabbar-table\n\t\t\t{\n\t\t\t\tmargin: 1px;\n\t\t\t\tpadding: 0;\n\t\t\t\tborder-width: 0;\n\t\t\t\tborder-collapse: collapse;\n\t\t\t}\n\t\t\t.wmk-tabbar-cell\n\t\t\t{\n\t\t\t\tmargin: 0 -1px -1px 0;\n\t\t\t\tpadding: 0;\n\t\t\t\tborder-width: 0;\n\t\t\t\tborder-width: 1px;\n\t\t\t\tborder-style: solid;\n\t\t\t\tborder-color: #808080;\n\t\t\t}\n\t\t`}}class Ii extends ai{constructor(t){super(),this.fields=t}render(t){super.render(t),this.divFields=it("<div/>").appendTo(this.contentDOM),this.fillTable();let e=it("<div/>").appendTo(this.contentDOM).css({"text-align":"center"});it('<button class="wmk-button wmk-button-default">Extra</button>').appendTo(e).onClick((()=>{this.fields.push(Vt.PREFIX_EXTRA),this.fillTable()})),it('<button class="wmk-button wmk-button-default">Transient</button>').appendTo(e).css({"margin-left":"0.5em"}).onClick((()=>{this.fields.push(Vt.PREFIX_TRANSIENT),this.fillTable()}))}getExtraFields(){let t=[];for(let e of this.fields)!e.startsWith(Vt.PREFIX_TRANSIENT)&&e.length>1&&t.push(e);return t}getTransientFields(){let t=[];for(let e of this.fields)e.startsWith(Vt.PREFIX_TRANSIENT)&&e.length>1&&t.push(e);return t}fillTable(){if(this.divFields.empty(),0==this.fields.length)return;let t=it("<table/>").appendTo(this.divFields).css({width:"100%"}),e=it("<tr/>").appendTo(t);it("<td/>").appendTo(e).css({"text-align":"right","font-weight":"bold","text-decoration":"underline"}).setText("Type"),it("<td/>").appendTo(e).css({"font-weight":"bold","text-decoration":"underline"}).setText("Value");for(let i=0;i<this.fields.length;i++){let s="?",n="";this.fields[i].length>0&&(s=this.fields[i].charAt(0),n=this.fields[i].substring(1)),e=it("<tr/>").appendTo(t);let o=it("<td/>").appendTo(e).css({"text-align":"right"}),l=it("<td/>").appendTo(e),r=it("<td/>").appendTo(e);it("<span/>").appendTo(o).css({padding:"0.2em",border:"1px solid black","background-color":"#C0C0C0"}).setText(s);let a=it('<input size="20"/>').appendTo(l).css({width:"100%",font:"inherit"});a.setValue(n),a.onInput((()=>{this.fields[i]=s+a.getValue()})),it('<button class="wmk-button wmk-button-small wmk-button-default"></button>').appendTo(r).css({"margin-left":"0.5em"}).onClick((()=>{this.fields.splice(i,1),this.fillTable()}))}}}!function(t){t[t.Atom=0]="Atom",t[t.Bond=1]="Bond"}(ki||(ki={})),function(t){t[t.Position=0]="Position",t[t.Link=1]="Link",t[t.Torsion=2]="Torsion"}(Bi||(Bi={}));class Li extends ai{constructor(e,i,s){if(super(),this.type=e,this.mol=i,this.idx=s,this.posX=[],this.posY=[],this.linkA=[],this.linkB=[],this.torsA=[],this.torsB=[],this.hovered=null,e==ki.Atom){const e=s;let n=i.atomAdjList(e);this.atomSubset=[e,...n];for(let t of i.atomAdjBonds(e))this.linkA.push(0),this.linkB.push(this.atomSubset.indexOf(i.bondOther(t,e)));let o=[];for(let t of n)o.push(Math.atan2(-(i.atomY(t)-i.atomY(e)),i.atomX(t)-i.atomX(e)));let l=t.idxSort(o);for(let t=0;t<l.length;t++)this.torsA.push(l[t]+1),this.torsB.push(l[t<l.length-1?t+1:0]+1);this.selected={type:Bi.Position,idx:0}}else{const t=s;let e=i.bondFrom(t),n=i.bondTo(t);this.atomSubset=[...i.atomAdjList(e),...i.atomAdjList(n)];let o=(t,e)=>{this.linkA.push(this.atomSubset.indexOf(t)),this.linkB.push(this.atomSubset.indexOf(e))};o(e,n);for(let t of i.atomAdjList(e))t!=n&&o(e,t);for(let t of i.atomAdjList(n))t!=e&&o(n,t);this.selected={type:Bi.Link,idx:0}}}render(t){super.render(t);let e=it("<div/>").appendTo(this.contentDOM).css({"text-align":"center"});this.divDiagram=it("<div/>").appendTo(e).css({display:"inline-block"}),this.contentDOM.onClick((t=>this.mouseClick(f(t,this.divDiagram)))),this.contentDOM.onMouseMove((t=>this.mouseMove(f(t,this.divDiagram)))),this.redraw()}selectionAtoms(t){const e=this.atomSubset;return t.type==Bi.Position?[e[t.idx]]:t.type==Bi.Link?[e[this.linkA[t.idx]],e[this.linkB[t.idx]]]:t.type==Bi.Torsion?[e[0],e[this.torsA[t.idx]],e[this.torsB[t.idx]]]:null}redraw(){this.divDiagram.empty();this.posX=[],this.posY=[];const e=.25;for(let t of this.atomSubset)this.posX.push(this.mol.atomX(t)),this.posY.push(this.mol.atomY(t));let i=t.min(this.posX)-e,s=t.max(this.posX)+e,n=t.min(this.posY)-e,o=t.max(this.posY)+e;this.scale=Math.min(40,Math.min(246/(s-i),246/(o-n)));let l=.5*(250-(s-i)*this.scale),r=.5*(250-(o-n)*this.scale);for(let t=0;t<this.atomSubset.length;t++)this.posX[t]=l+(this.posX[t]-i)*this.scale,this.posY[t]=250-(r+(this.posY[t]-n)*this.scale);this.posRad=e*this.scale;let a=new si;a.setSize(250,250);let h=ot.foreground,u=ot.background,m=36817,d=4707794;for(let t=0;t<this.atomSubset.length;t++)this.hovered&&this.hovered.type==Bi.Position&&this.hovered.idx==t?a.drawOval(this.posX[t],this.posY[t],this.posRad,this.posRad,h,1,u):this.selected&&this.selected.type==Bi.Position&&this.selected.idx==t?a.drawOval(this.posX[t],this.posY[t],this.posRad,this.posRad,m,1,d):a.drawOval(this.posX[t],this.posY[t],this.posRad,this.posRad,si.NOCOLOUR,0,h);for(let t of[1,2,3])for(let e=0;e<this.linkA.length;e++){let i=this.posX[this.linkA[e]],s=this.posY[this.linkA[e]],n=this.posX[this.linkB[e]],o=this.posY[this.linkB[e]];this.hovered&&this.hovered.type==Bi.Link&&this.hovered.idx==e?3==t&&(a.drawLine(i,s,n,o,h,.1*this.scale+2),a.drawLine(i,s,n,o,u,.1*this.scale)):this.selected&&this.selected.type==Bi.Link&&this.selected.idx==e?2==t&&(a.drawLine(i,s,n,o,m,.1*this.scale+2),a.drawLine(i,s,n,o,d,.1*this.scale)):1==t&&a.drawLine(i,s,n,o,h,.1*this.scale)}for(let e=0;e<this.torsA.length;e++){let i,s,n,o=this.posX[0],l=this.posY[0],r=.5*(this.posX[this.torsA[e]]-o),c=.5*(this.posY[this.torsA[e]]-l),p=.5*(this.posX[this.torsB[e]]-o),f=.5*(this.posY[this.torsB[e]]-l),g=.5*(b(r,c)+b(p,f)),y=Math.atan2(c,r)+10*S,x=Math.atan2(f,p)-10*S,A=N(x,y),v=g*Math.cos(y),M=g*Math.sin(y),T=g*Math.cos(x),w=g*Math.sin(x);if(A>0){let[e,r,a,h]=G.arcControlPoints(g,v,M,T,w);i=t.add([v,e,a,T],o),s=t.add([M,r,h,w],l),n=[!1,!0,!0,!1]}else{let e=y+.5*(A+E),r=g*Math.cos(e),a=g*Math.sin(e),[h,u,m,d]=G.arcControlPoints(g,v,M,r,a),[c,p,f,b]=G.arcControlPoints(g,r,a,T,w);i=t.add([v,h,m,r,c,f,T],o),s=t.add([M,u,d,a,p,b,w],l),n=[!1,!0,!0,!1,!0,!0,!1]}this.hovered&&this.hovered.type==Bi.Torsion&&this.hovered.idx==e?(a.drawPath(i,s,n,!1,h,.1*this.scale+2,si.NOCOLOUR,!1),a.drawPath(i,s,n,!1,u,.1*this.scale,si.NOCOLOUR,!1)):this.selected&&this.selected.type==Bi.Torsion&&this.selected.idx==e?(a.drawPath(i,s,n,!1,m,.1*this.scale+2,si.NOCOLOUR,!1),a.drawPath(i,s,n,!1,d,.1*this.scale,si.NOCOLOUR,!1)):a.drawPath(i,s,n,!1,h,.1*this.scale,si.NOCOLOUR,!1)}this.divDiagram.empty(),it(a.createSVG()).appendTo(this.divDiagram).css({"pointer-events":"none"})}mouseClick(t){if(event.stopPropagation(),this.type==ki.Bond)return;let e=this.whichSelection(t[0],t[1]);e&&(this.sameSelection(this.selected,e)||(this.selected=e,this.hovered=null,this.redraw(),this.callbackSelect(e)))}mouseMove(t){if(this.type==ki.Bond)return;let e=this.whichSelection(t[0],t[1]);e&&this.sameSelection(e,this.selected)&&(e=null),this.sameSelection(this.hovered,e)||(this.hovered=e,this.redraw())}whichSelection(t,e){let i=this.posX[0],s=this.posY[0];if(b(t-i,e-s)<=this.posRad)return{type:Bi.Position,idx:0};let n=0;for(let t=1;t<this.atomSubset.length;t++)n=Math.max(n,b(this.posX[t]-i,this.posY[t]-s)+this.posRad);if(b(t-i,e-s)>n)return null;let o=Math.atan2(e-s,t-i),l=null,r=Number.POSITIVE_INFINITY;for(let t=0;t<this.linkB.length;t++){let e=Math.abs(N(Math.atan2(this.posY[this.linkB[t]]-s,this.posX[this.linkB[t]]-i),o));e<10*S&&e<r&&(l={type:Bi.Link,idx:t},r=e)}for(let t=0;t<this.torsA.length;t++){let e=Math.atan2(this.posY[this.torsA[t]]-s,this.posX[this.torsA[t]]-i),n=e+.5*N(Math.atan2(this.posY[this.torsB[t]]-s,this.posX[this.torsB[t]]-i),e),a=Math.abs(N(n,o));a<r&&(l={type:Bi.Torsion,idx:t},r=a)}return l}sameSelection(t,e){return null==t&&null==e||null!=t&&null!=e&&t.type==e.type&&t.idx==e.idx}}const Di=[1,1,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,8.5,8.5,8.5,8.5,8.5,8.5,8.5,8.5,8.5,8.5,8.5,8.5,8.5,8.5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,9.5,9.5,9.5,9.5,9.5,9.5,9.5,9.5,9.5,9.5,9.5,9.5,9.5,9.5,7,7,7,7,7,7,7,7,7,7],Ri=[1,18,1,2,13,14,15,16,17,18,1,2,13,14,15,16,17,18,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,1,2,3.5,4.5,5.5,6.5,7.5,8.5,9.5,10.5,11.5,12.5,13.5,14.5,15.5,16.5,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,1,2,3.5,4.5,5.5,6.5,7.5,8.5,9.5,10.5,11.5,12.5,13.5,14.5,15.5,16.5,3,4,5,6,7,8,9,10,11,12];class Pi extends ai{constructor(){super(),this.divList=[],this.selectedAtno=[],at("periodictable","\n\t*.wmk-periodictable-element\n\t{\n\t\tborder: 1px solid black;\n\t\tborder-radius: 2px;\n\t\tmargin: 0;\n\t\tmin-width: 2em;\n\t\tpadding: 0.4em 0 0.3em 0;\n\t\ttext-align: center;\n\t\tcolor: #FFFFFF;\n\t\tcursor: pointer;\n\t}\n\t*.wmk-periodictable-block1\n\t{\n\t\tbackground-color: #313062;\n\t}\n\t*.wmk-periodictable-block1:hover\n\t{\n\t\tbackground-color: #414072;\n\t}\n\t*.wmk-periodictable-block2\n\t{\n\t\tbackground-color: #205224;\n\t}\n\t*.wmk-periodictable-block2:hover\n\t{\n\t\tbackground-color: #306234;\n\t}\n\t*.wmk-periodictable-block3\n\t{\n\t\tbackground-color: #522818;\n\t}\n\t*.wmk-periodictable-block3:hover\n\t{\n\t\tbackground-color: #623828;\n\t}\n\t*.wmk-periodictable-block4\n\t{\n\t\tbackground-color: #575212;\n\t}\n\t*.wmk-periodictable-block4:block\n\t{\n\t\tbackground-color: #676222;\n\t}\n\t*.wmk-periodictable-selected\n\t{\n\t\tbackground-color: #FFFFFF !important;\n\t\tcolor: #000000 !important;\n\t\tcursor: default;\n\t}\n")}render(t){super.render(t);let e=it("<div/>").appendTo(this.contentDOM).css({display:"grid"});e.css({"align-items":"center","justify-content":"start",gap:"1px"});let i=Di.map((t=>Math.round(2*t)+1)),s=Ri.map((t=>Math.round(2*t)+1)),n=i.length;for(let t=0;t<n;t++){let n=it("<div/>").appendTo(e);n.css({"grid-row":`${i[t]} / span 2`,"grid-column":`${s[t]} / span 2`}),n.addClass("wmk-periodictable-element");let o=gt.ELEMENT_BLOCKS[t+1];1==o?n.addClass("wmk-periodictable-block1"):2==o?n.addClass("wmk-periodictable-block2"):3==o?n.addClass("wmk-periodictable-block3"):4==o&&n.addClass("wmk-periodictable-block4");let l=gt.ELEMENTS[t+1];n.setText(l),this.divList.push(n),n.onClick((()=>{this.changeElement(l),this.callbackSelect(l)})),n.onDblClick((t=>{this.callbackDoubleClick(),t.preventDefault(),t.stopPropagation()}))}}onSelect(t){this.callbackSelect=t}onDoubleClick(t){this.callbackDoubleClick=t}changeElement(t){let e=gt.ELEMENTS.indexOf(t);this.selectedAtno=[e],this.updateSelected()}setSelectedElements(t){this.selectedAtno=t.map((t=>gt.ELEMENTS.indexOf(t))).filter((t=>t>0)),this.updateSelected()}updateSelected(){for(let t=1;t<=this.divList.length;t++)this.selectedAtno.includes(t)?this.divList[t-1].addClass("wmk-periodictable-selected"):this.divList[t-1].removeClass("wmk-periodictable-selected")}}class zi extends ai{constructor(t,e,i){super(),this.mol=t,this.atom=e,this.bond=i}render(t){super.render(t);let e=it("<div/>").appendTo(this.contentDOM);e.css({display:"grid","align-items":"center","justify-content":"start"}),e.css({"grid-row-gap":"0.5em","grid-column-gap":"0.5em"}),e.css({"grid-template-columns":"[title] auto [value] auto [end]"});let i=0,s=()=>it('<input size="20"/>').appendTo(e).css({"grid-area":`${i} / value`}),n=()=>{let t=it("<div/>").appendTo(e).css({"grid-area":`${i} / value`,dispkay:"flex"}),s=it("<label/>").appendTo(t).css({"margin-right":"0.5em"}),n=it('<input type="checkbox"/>').appendTo(s);return s.appendText("Not"),[n,it('<input size="20"/>').appendTo(t).css({"flex-grow":"1"})]};this.atom>0?(it("<div>Charges</div>").appendTo(e).css({"grid-area":++i+" / title"}),this.inputCharges=s(),it("<div>Aromatic</div>").appendTo(e).css({"grid-area":++i+" / title"}),this.optAromatic=new qi(["Maybe","Yes","No"]),this.optAromatic.render(it("<div/>").appendTo(e).css({"grid-area":`${i} / value`})),it("<div>Unsaturated</div>").appendTo(e).css({"grid-area":++i+" / title"}),this.optUnsaturated=new qi(["Maybe","Yes","No"]),this.optUnsaturated.render(it("<div/>").appendTo(e).css({"grid-area":`${i} / value`})),it("<div>Elements</div>").appendTo(e).css({"grid-area":++i+" / title"}),[this.chkNotElements,this.inputElements]=n(),it("<div>Ring Sizes</div>").appendTo(e).css({"grid-area":++i+" / title"}),[this.chkNotRingSizes,this.inputRingSizes]=n(),it("<div>Ring Block</div>").appendTo(e).css({"grid-area":++i+" / title"}),this.optRingBlock=new qi(["Maybe","Yes","No"]),this.optRingBlock.render(it("<div/>").appendTo(e).css({"grid-area":`${i} / value`})),it("<div># Small Rings</div>").appendTo(e).css({"grid-area":++i+" / title"}),this.inputNumRings=s(),it("<div># Ring Bonds</div>").appendTo(e).css({"grid-area":++i+" / title"}),this.inputRingBonds=s(),it("<div>Adjacency</div>").appendTo(e).css({"grid-area":++i+" / title"}),this.inputAdjacency=s(),it("<div>Bond Sums</div>").appendTo(e).css({"grid-area":++i+" / title"}),this.inputBondSums=s(),it("<div>Valences</div>").appendTo(e).css({"grid-area":++i+" / title"}),this.inputValences=s(),it("<div>Hydrogens</div>").appendTo(e).css({"grid-area":++i+" / title"}),this.inputHydrogens=s(),it("<div>Isotopes</div>").appendTo(e).css({"grid-area":++i+" / title"}),this.inputIsotopes=s(),this.setupAtom()):(it("<div>Ring Sizes</div>").appendTo(e).css({"grid-area":++i+" / title"}),[this.chkNotRingSizes,this.inputRingSizes]=n(),it("<div>Ring Block</div>").appendTo(e).css({"grid-area":++i+" / title"}),this.optRingBlock=new qi(["Maybe","Yes","No"]),this.optRingBlock.render(it("<div/>").appendTo(e).css({"grid-area":`${i} / value`})),it("<div># Small Rings</div>").appendTo(e).css({"grid-area":++i+" / title"}),this.inputNumRings=s(),it("<div>Num Rings</div>").appendTo(e).css({"grid-area":++i+" / title"}),this.inputNumRings=s(),it("<div>Bond Orders</div>").appendTo(e).css({"grid-area":++i+" / title"}),this.inputOrders=s(),this.setupBond())}updateAtom(){const{mol:t,atom:e}=this;It.deleteQueryAtomAll(t,e);let i=this.splitNumbers(this.inputCharges.getValue());i&&It.setQueryAtomCharges(t,e,i);let s=this.optAromatic.getSelectedIndex();s>0&&It.setQueryAtomAromatic(t,e,1==s);let n=this.optUnsaturated.getSelectedIndex();n>0&&It.setQueryAtomUnsaturated(t,e,1==n);let o=this.splitStrings(this.inputElements.getValue());o&&(this.chkNotElements.elInput.checked?It.setQueryAtomElementsNot(t,e,o):It.setQueryAtomElements(t,e,o));let l=this.splitNumbers(this.inputRingSizes.getValue());l&&(this.chkNotRingSizes.elInput.checked?It.setQueryAtomRingSizesNot(t,e,l):It.setQueryAtomRingSizes(t,e,l));let r=this.optRingBlock.getSelectedIndex();r>0&&It.setQueryAtomRingBlock(t,e,1==r);let a=this.splitNumbers(this.inputNumRings.getValue());a&&It.setQueryAtomNumRings(t,e,a);let h=this.splitNumbers(this.inputRingBonds.getValue());h&&It.setQueryAtomRingBonds(t,e,h);let u=this.splitNumbers(this.inputAdjacency.getValue());u&&It.setQueryAtomAdjacency(t,e,u);let m=this.splitNumbers(this.inputBondSums.getValue());m&&It.setQueryAtomBondSums(t,e,m);let d=this.splitNumbers(this.inputValences.getValue());d&&It.setQueryAtomValences(t,e,d);let c=this.splitNumbers(this.inputHydrogens.getValue());c&&It.setQueryAtomHydrogens(t,e,c);let p=this.splitNumbers(this.inputIsotopes.getValue());p&&It.setQueryAtomIsotope(t,e,p)}updateBond(){const{mol:t,bond:e}=this;It.deleteQueryBondAll(t,e);let i=this.splitNumbers(this.inputRingSizes.getValue());i&&(this.chkNotRingSizes.elInput.checked?It.setQueryBondRingSizesNot(t,e,i):It.setQueryBondRingSizes(t,e,i));let s=this.optRingBlock.getSelectedIndex();s>0&&It.setQueryBondRingBlock(t,e,1==s);let n=this.splitNumbers(this.inputNumRings.getValue());n&&It.setQueryBondNumRings(t,e,n);let o=this.splitNumbers(this.inputOrders.getValue());o&&It.setQueryBondOrders(t,e,o)}setupAtom(){const{mol:e,atom:i}=this;let s=It.queryAtomCharges(e,i),n=It.queryAtomAromatic(e,i),o=It.queryAtomUnsaturated(e,i),l=It.queryAtomElements(e,i),r=It.queryAtomElementsNot(e,i),a=It.queryAtomRingSizes(e,i),h=It.queryAtomRingSizesNot(e,i),u=It.queryAtomRingBlock(e,i),m=It.queryAtomNumRings(e,i),d=It.queryAtomRingBonds(e,i),c=It.queryAtomAdjacency(e,i),p=It.queryAtomBondSums(e,i),f=It.queryAtomValences(e,i),g=It.queryAtomHydrogens(e,i),b=It.queryAtomIsotope(e,i);It.queryAtomSubFrags(e,i),It.queryAtomSubFragsNot(e,i),this.inputCharges.setValue(t.notBlank(s)?s.join(","):""),this.optAromatic.setSelectedIndex(null==n?0:n?1:2),this.optUnsaturated.setSelectedIndex(null==o?0:o?1:2),this.chkNotElements.elInput.checked=t.isBlank(l)&&t.notBlank(r),this.inputElements.setValue(t.notBlank(l)?l.join(","):t.notBlank(r)?r.join(","):""),this.chkNotRingSizes.elInput.checked=t.isBlank(a)&&t.notBlank(h),this.inputRingSizes.setValue(t.notBlank(a)?a.join(","):t.notBlank(h)?h.join(","):""),this.optRingBlock.setSelectedIndex(null==u?0:u?1:2),this.inputNumRings.setValue(t.notBlank(m)?m.join(","):""),this.inputRingBonds.setValue(t.notBlank(d)?d.join(","):""),this.inputAdjacency.setValue(t.notBlank(c)?c.join(","):""),this.inputBondSums.setValue(t.notBlank(p)?p.join(","):""),this.inputValences.setValue(t.notBlank(f)?f.join(","):""),this.inputHydrogens.setValue(t.notBlank(g)?g.join(","):""),this.inputIsotopes.setValue(t.notBlank(b)?b.join(","):"")}setupBond(){const{mol:e,bond:i}=this;let s=It.queryBondRingSizes(e,i),n=It.queryBondRingSizesNot(e,i),o=It.queryBondRingBlock(e,i),l=It.queryBondNumRings(e,i),r=It.queryBondOrders(e,i);this.chkNotRingSizes.elInput.checked=t.isBlank(s)&&t.notBlank(n),this.inputRingSizes.setValue(t.notBlank(s)?s.join(","):t.notBlank(n)?n.join(","):""),this.optRingBlock.setSelectedIndex(null==o?0:o?1:2),this.inputNumRings.setValue(t.notBlank(l)?l.join(","):""),this.inputOrders.setValue(t.notBlank(r)?r.join(","):"")}splitStrings(t){let e=[];if(t)for(let i of t.split(/[\s\,\;]+/))i&&e.push(i);return e.length?e:null}splitNumbers(t){let e=[];if(t)for(let i of t.split(/[\s\,\;]+/)){i.startsWith("+")&&(i=i.substring(1));let t=parseInt(i);isNaN(t)||e.push(t)}return e.length?e:null}}class Fi extends li{constructor(t,e,i,s){super(),this.atom=e,this.proxyClip=i,this.callbackApply=s,this.newX=0,this.newY=0,this.tabs=null,this.abbrevList=null,this.svgAbbrev=null,this.abbrevIndices=[],this.currentAbbrev=-1,this.initMol=t,this.mol=t.clone(),this.title="Edit Atom",this.minPortionWidth=20,this.maxPortionWidth=95}populate(){this.proxyClip.pushHandler(new oe);let t=this.buttonsDOM(),e=this.bodyDOM();this.btnApply=it('<button class="wmk-button wmk-button-primary">Apply</button>').appendTo(t).css({"margin-left":"0.5em"}),this.btnApply.onClick((()=>this.applyChanges())),this.atom>0?(this.tabs=new Oi(["Atom","Abbreviation","Geometry","Query","Extra"]),this.tabs.render(e),this.tabs.onSelect((t=>this.selectedTab(t))),this.populateAtom(this.tabs.getPanelDOM("Atom")),this.populateAbbreviation(this.tabs.getPanelDOM("Abbreviation")),this.atom>0&&this.populateGeometry(this.tabs.getPanelDOM("Geometry")),this.populateQuery(this.tabs.getPanelDOM("Query")),this.populateExtra(this.tabs.getPanelDOM("Extra"))):this.populateAtom(e);let i=e.findAll("input,textarea");i.length>0&&i[0].grabFocus(!0);for(let t of i)t.css({font:"inherit"}),t.onKeyDown((t=>{"Enter"==t.key?this.applyChanges():"Escape"==t.key?this.close():"PageUp"==t.key?(this.tabs.rotateSelected(-1),this.selectedTab(this.tabs.getSelectedIndex()),t.preventDefault()):"PageDown"==t.key&&(this.tabs.rotateSelected(1),this.selectedTab(this.tabs.getSelectedIndex()),t.preventDefault()),t.stopPropagation()}))}close(){this.proxyClip.popHandler(),super.close()}applyChanges(){this.mol.keepTransient=!0,this.updateMolecule();let t=this.tabs?this.tabs.getSelectedValue():null;"Abbreviation"==t&&this.updateAbbrev(),"Geometry"==t&&this.updateGeometry(),"Query"==t&&this.updateQuery(),"Extra"==t&&this.updateExtra(),this.mol.keepTransient=!1,this.callbackApply&&this.callbackApply(this)}populateAtom(t){let e=it("<div/>").appendTo(t);e.css({display:"grid","align-items":"center","justify-content":"start"}),e.css({"grid-row-gap":"0.5em","grid-column-gap":"0.5em"}),e.css({"grid-template-columns":"[start col0] auto [col1] auto [col2] auto [col3] auto [col4 end]"}),e.appendHTML('<div style="grid-area: 1 / col0;">Symbol</div>'),this.inputSymbol=it('<input size="20"/>').appendTo(e),this.inputSymbol.css({"grid-area":"1 / col1 / auto / col4}"}),this.inputSymbol.onInput((()=>this.periodicWidget.changeElement(this.inputSymbol.getValue()))),e.appendHTML('<div style="grid-area: 2 / col0;">Charge</div>'),this.inputCharge=it('<input type="number" size="6"/>').appendTo(e),this.inputCharge.css({"grid-area":"2 / col1"}),e.appendHTML('<div style="grid-area: 2 / col2;">Unpaired</div>'),this.inputUnpaired=it('<input type="number" size="6"/>').appendTo(e),this.inputUnpaired.css({"grid-area":"2 / col3"}),e.appendHTML('<div style="grid-area: 3 / col0;">Hydrogens</div>'),this.optionHydrogen=new qi(["Auto","None","1","2","3","4","Other"]),this.optionHydrogen.render(it('<div style="grid-area: 3 / col1 / auto / col3"/>').appendTo(e)),this.optionHydrogen.onSelect((t=>this.inputHydrogen.elInput.disabled=6!=t)),this.inputHydrogen=it('<input type="number" size="4"/>').appendTo(e),this.inputHydrogen.css({"grid-area":"3 / col3"}),this.inputHydrogen.elInput.disabled=!0,e.appendHTML('<div style="grid-area: 4 / col0;">Isotope</div>'),this.optionIsotope=new qi(["Natural","Enriched"]),this.optionIsotope.render(it('<div style="grid-area: 4 / col1 / auto / col3"/>').appendTo(e)),this.optionIsotope.onSelect((t=>this.inputIsotope.elInput.disabled=0==t)),this.inputIsotope=it('<input type="number" size="6"/>').appendTo(e),this.inputIsotope.css({"grid-area":"4 / col3"}),this.inputIsotope.elInput.disabled=!0,e.appendHTML('<div style="grid-area: 5 / col0;">Mapping</div>'),this.inputMapping=it('<input type="number" size="6"/>').appendTo(e),this.inputMapping.css({"grid-area":"5 / col1"}),e.appendHTML('<div style="grid-area: 5 / col2;">Index</div>'),this.inputIndex=it('<input type="number" size="6" readonly="readonly"/>').appendTo(e),this.inputIndex.css({"grid-area":"5 / col3"});let i=it("<div/>").appendTo(e).css({"grid-area":"6 / start / 6 / end"});this.periodicWidget=new Pi,this.periodicWidget.onSelect((t=>this.inputSymbol.setValue(t))),this.periodicWidget.onDoubleClick((()=>this.applyChanges())),this.periodicWidget.render(i);const s=this.mol,n=this.atom;if(n>0){this.inputSymbol.setValue(s.atomElement(n)),this.inputCharge.setValue(s.atomCharge(n).toString()),this.inputUnpaired.setValue(s.atomUnpaired(n).toString());let t=s.atomHExplicit(n);t==Vt.HEXPLICIT_UNKNOWN?(this.optionHydrogen.setSelectedIndex(0),this.inputHydrogen.setValue(s.atomHydrogens(n).toString()),this.inputHydrogen.elInput.disabled=!0):t<=4?(this.optionHydrogen.setSelectedIndex(t+1),this.inputHydrogen.setValue(t.toString()),this.inputHydrogen.elInput.disabled=!0):(this.optionHydrogen.setSelectedIndex(6),this.inputHydrogen.setValue(t.toString()),this.inputHydrogen.elInput.disabled=!1),this.optionIsotope.setSelectedIndex(s.atomIsotope(n)==Vt.ISOTOPE_NATURAL?0:1),s.atomIsotope(n)!=Vt.ISOTOPE_NATURAL&&this.inputIsotope.setValue(s.atomIsotope(n).toString()),this.inputIsotope.elInput.disabled=s.atomIsotope(n)==Vt.ISOTOPE_NATURAL,this.inputMapping.setValue(s.atomMapNum(n).toString()),this.inputIndex.setValue(n.toString()),this.periodicWidget.changeElement(s.atomElement(n))}}populateAbbreviation(t){let e=it("<div/>").appendTo(t).css({display:"flex","align-items":"flex-start"});e.css({"max-width":"60vw","max-height":"50vh","overflow-y":"scroll"});let i=it("<div/>").appendTo(e).css({"margin-right":"0.5em",flex:"0 0"}),s=it("<div/>").appendTo(e).css({flex:"1 1 100%"});this.inputAbbrevSearch=it('<input size="10"/>').appendTo(i),this.inputAbbrevSearch.setAttr("placeholder","Search");let n="";this.inputAbbrevSearch.onKeyDown((t=>{"ArrowUp"==t.key?this.cycleAbbreviation(-1):"ArrowDown"==t.key&&this.cycleAbbreviation(1)})),this.inputAbbrevSearch.onInput((()=>{let t=this.inputAbbrevSearch.getValue();t!=n&&(n=t,this.fillAbbreviations())}));let o=it("<div/>").appendTo(i).css({"margin-top":"0.5em"});it('<button class="wmk-button wmk-button-default">Clear</button>').appendTo(o).onClick((()=>{this.selectAbbreviation(-1),this.atom>0&&Kt.hasAbbrev(this.mol,this.atom)&&this.applyChanges()})),this.tableAbbrev=it("<table/>").appendTo(s).css({"border-collapse":"collapse",width:"100%"}),this.fillAbbreviations()}populateGeometry(t){const{mol:e,atom:i}=this;let s=it("<div/>").appendTo(t).css({"text-align":"center"}),n=it("<div/>").appendTo(s).css({display:"inline-block"}),o=it("<div/>").appendTo(n);o.css({display:"grid","align-items":"center","justify-content":"start"}),o.css({"grid-row-gap":"0.5em","grid-column-gap":"0.5em"}),o.css({"grid-template-columns":"[start col0] auto [col1] auto [col2] auto [col3] auto [col4 end]"}),this.geomWidget=new Li(ki.Atom,e,i),this.geomWidget.render(it("<div/>").appendTo(o).css({"grid-area":"1 / col0 / auto / col4","text-align":"center"}));let l=it("<div/>").appendTo(o).css({"grid-area":"2 / col0"});this.inputGeom1=it('<input type="number" size="8"/>').appendTo(o).css({"grid-area":"2 / col1"});let r=it("<div/>").appendTo(o).css({"grid-area":"2 / col2"});this.inputGeom2=it('<input type="number" size="8"/>').appendTo(o).css({"grid-area":"2 / col3"}),this.geomWidget.callbackSelect=t=>{let i=this.geomWidget.selectionAtoms(t);if(t.type==Bi.Position)l.setText("Position X"),r.setText("Y"),this.inputGeom1.setValue(this.refGeom1=e.atomX(i[0]).toFixed(3)),this.inputGeom2.setValue(this.refGeom2=e.atomY(i[0]).toFixed(3));else if(t.type==Bi.Link){let t=e.atomX(i[1])-e.atomX(i[0]),s=e.atomY(i[1])-e.atomY(i[0]);l.setText("Distance"),r.setText("Angle"),this.inputGeom1.setValue(this.refGeom1=b(t,s).toFixed(3)),this.inputGeom2.setValue(this.refGeom2=(Math.atan2(s,t)*k).toFixed(1))}else if(t.type==Bi.Torsion){let t=e.atomX(i[0]),s=e.atomY(i[0]),n=Math.atan2(e.atomY(i[1])-s,e.atomX(i[1])-t),o=Math.atan2(e.atomY(i[2])-s,e.atomX(i[2])-t);l.setText("Angle"),r.setText(""),this.inputGeom1.setValue(this.refGeom1=(q(n,o)*k).toFixed(1)),this.inputGeom2.setValue(this.refGeom2="")}r.setCSS("display",t.type==Bi.Torsion?"none":"block"),this.inputGeom2.setCSS("display",t.type==Bi.Torsion?"none":"block")},this.geomWidget.callbackSelect(this.geomWidget.selected)}populateQuery(t){this.queryWidget=new zi(this.mol,this.atom,0),this.queryWidget.render(t)}populateExtra(t){let e=[...this.mol.atomExtra(this.atom),...this.mol.atomTransient(this.atom)];this.fieldsWidget=new Ii(e),this.fieldsWidget.render(t)}updateMolecule(){let{mol:t,atom:e}=this;0==e&&(e=this.atom=t.addAtom("C",this.newX,this.newY));let i=this.inputSymbol.getValue();""!=i&&t.setAtomElement(e,i);let s=parseInt(this.inputCharge.getValue());s>-20&&s<20&&t.setAtomCharge(e,s);let n=parseInt(this.inputUnpaired.getValue());n>=0&&n<20&&t.setAtomUnpaired(e,n);let o=this.optionHydrogen.getSelectedIndex();if(0==o)t.setAtomHExplicit(e,Vt.HEXPLICIT_UNKNOWN);else if(o<=5)t.setAtomHExplicit(e,o-1);else{let i=parseInt(this.inputHydrogen.getValue());i>=0&&i<20&&t.setAtomHExplicit(e,i)}if(1==this.optionIsotope.getSelectedIndex()){let i=parseInt(this.inputIsotope.getValue());i>=0&&i<300&&t.setAtomIsotope(e,i)}else t.setAtomIsotope(e,Vt.ISOTOPE_NATURAL);let l=parseInt(this.inputMapping.getValue());isNaN(l)||t.setAtomMapNum(e,l)}updateAbbrev(){const{mol:t,atom:e}=this;if(this.currentAbbrev<0){let i=t.atomElement(e);Kt.clearAbbrev(t,e),t.setAtomElement(e,i)}else{let i=this.abbrevList[this.currentAbbrev];t.setAtomElement(e,i.name),Kt.setAbbrev(t,e,i.frag)}}updateGeometry(){let e=this.inputGeom1.getValue(),i=this.inputGeom2.getValue();if(this.refGeom1==e&&this.refGeom2==i)return;const{mol:s}=this;let n=this.geomWidget.selected,o=this.geomWidget.selectionAtoms(n);if(n.type==Bi.Position){let t=parseFloat(e),n=parseFloat(i);if(isNaN(t)||isNaN(n)||Math.abs(t)>1e6||Math.abs(n)>1e6)return;s.setAtomPos(o[0],t,n)}else if(n.type==Bi.Link){if(this.refGeom1!=e){let i=parseFloat(e);if(isNaN(i)||Math.abs(i)>100)return;let n=t.booleanArray(!1,s.numAtoms);n[o[1]-1]=!0;let l={mol:s,currentAtom:0,currentBond:s.findBond(o[0],o[1]),selectedMask:n},r=new Be(l,Se.BondDist,{dist:i});return r.execute(),void(r.output.mol&&(this.mol=r.output.mol))}if(this.refGeom2!=i){let e=parseFloat(i);if(isNaN(e))return;let n=t.booleanArray(!1,s.numAtoms);n[o[1]-1]=!0;let l={mol:s,currentAtom:0,currentBond:s.findBond(o[0],o[1]),selectedMask:n},r=new Be(l,Se.AlignAngle,{angle:e*S});return r.execute(),void(r.output.mol&&(this.mol=r.output.mol))}}else if(n.type==Bi.Torsion){let i=parseFloat(e);if(isNaN(i))return;let n=t.booleanArray(!1,s.numAtoms);for(let t of o)n[t-1]=!0;let l={mol:s,currentAtom:o[2],currentBond:0,selectedMask:n},r=new Be(l,Se.AdjustTorsion,{angle:i*S});return r.execute(),void(r.output.mol&&(this.mol=r.output.mol))}}updateQuery(){this.queryWidget.updateAtom()}updateExtra(){this.mol.setAtomExtra(this.atom,this.fieldsWidget.getExtraFields()),this.mol.setAtomTransient(this.atom,this.fieldsWidget.getTransientFields())}fillAbbreviations(){if(Te.needsSetup())return void setTimeout((()=>Te.setupData().then((()=>this.fillAbbreviations()))),1);if(this.tableAbbrev.empty(),Te.main.submitMolecule(this.mol,!0),this.abbrevList=Te.main.getAbbrevs(),!this.svgAbbrev){this.svgAbbrev=[];let e=_e.defaultColourOnWhite(10),i=new Ue(0,0,e.data.pointScale);for(let s of this.abbrevList){let n=new Ye,o=s.frag.clone();n.atomCircleSz=t.numberArray(0,o.numAtoms),n.atomCircleCol=t.numberArray(0,o.numAtoms);for(let t=1;t<=o.numAtoms;t++)o.atomElement(t)==Kt.ABBREV_ATTACHMENT&&(o.setAtomElement(t,"C"),n.atomCircleSz[t-1]=.2,n.atomCircleCol[t-1]=49152);let l=new He(o,i,e,n);l.arrange();let r=new si;new ni(l,r).draw(),r.normalise(),this.svgAbbrev.push(r.createSVG())}const{mol:s,atom:n}=this;if(n>0&&Kt.hasAbbrev(s,n)){let t=s.atomElement(n),e=Kt.molecularFormula(Kt.getAbbrev(s,n));for(let i=0;i<this.abbrevList.length;i++)if(t==this.abbrevList[i].name){e==Kt.molecularFormula(this.abbrevList[i].frag)&&(this.currentAbbrev=i);break}}}let e=it("<tr/>").appendTo(this.tableAbbrev);e.appendHTML("<td><u>Label</u></td>"),e.appendHTML("<td><u>Structure</u></td>"),this.abbrevEntries=[],this.abbrevIndices=[];let i=this.inputAbbrevSearch.getValue().toLowerCase();for(let t=0;t<this.abbrevList.length;t++){if(this.currentAbbrev!=t&&!this.abbrevList[t].nameSearch.includes(i))continue;let e={tr:it("<tr/>").appendTo(this.tableAbbrev),idx:t,bgcol:this.abbrevEntries.length%2==0?"#FFFFFF":"#F8F8F8"};e.tr.setCSS("background-color",this.currentAbbrev==e.idx?u(ot.lowlight):e.bgcol);let s=it("<td/>").appendTo(e.tr),n=it("<td/>").appendTo(e.tr);s.setHTML(this.abbrevList[t].nameHTML),it(this.svgAbbrev[t]).appendTo(n).css({display:"block","pointer-events":"none"}),e.tr.css({cursor:"pointer"}),e.tr.onClick((()=>this.selectAbbreviation(t))),e.tr.onDblClick((t=>this.applyChanges())),this.abbrevEntries.push(e),this.abbrevIndices.push(t)}}selectAbbreviation(t){if(this.currentAbbrev!=t){this.currentAbbrev=t;for(let t of this.abbrevEntries)t.tr.setCSS("background-color",this.currentAbbrev==t.idx?u(ot.lowlight):t.bgcol),this.currentAbbrev==t.idx&&t.tr.el.scrollIntoView({block:"nearest"})}}cycleAbbreviation(t){let e=this.abbrevIndices.length;if(0==e)return;let i=this.abbrevIndices.indexOf(this.currentAbbrev);i=i<0?t<0?e-1:0:(i+e+t)%e,this.selectAbbreviation(this.abbrevIndices[i])}selectedTab(t){0==t?this.inputSymbol.grabFocus():1==t?this.inputAbbrevSearch.grabFocus():2==t&&this.inputGeom1.grabFocus()}}class _i extends li{constructor(t,e,i,s){super(),this.bond=e,this.proxyClip=i,this.callbackApply=s,this.initMol=t,this.mol=t.clone(),this.title="Edit Bond",this.minPortionWidth=20,this.maxPortionWidth=95}populate(){this.proxyClip.pushHandler(new oe);let t=this.buttonsDOM(),e=this.bodyDOM();this.btnApply=it('<button class="wmk-button wmk-button-primary">Apply</button>').appendTo(t).css({"margin-left":"0.5em"}),this.btnApply.onClick((()=>this.applyChanges())),this.tabs=new Oi(["Bond","Geometry","Query","Extra"]),this.tabs.render(e),this.tabs.onSelect((t=>this.selectedTab(t))),this.populateBond(this.tabs.getPanelDOM("Bond")),this.populateGeometry(this.tabs.getPanelDOM("Geometry")),this.populateQuery(this.tabs.getPanelDOM("Query")),this.populateExtra(this.tabs.getPanelDOM("Extra"));let i=e.findAll("input,textarea");i.length>0&&i[0].grabFocus(!0);for(let t of i)t.css({font:"inherit"}),t.onKeyDown((t=>{"Enter"==t.key?this.applyChanges():"Escape"==t.key?this.close():"PageUp"==t.key?(this.tabs.rotateSelected(-1),this.selectedTab(this.tabs.getSelectedIndex()),t.preventDefault()):"PageDown"==t.key&&(this.tabs.rotateSelected(1),this.selectedTab(this.tabs.getSelectedIndex()),t.preventDefault()),t.stopPropagation()}))}close(){this.proxyClip.popHandler(),super.close()}applyChanges(){this.mol.keepTransient=!0,this.updateMolecule(),"Geometry"==this.tabs.getSelectedValue()&&this.updateGeometry(),"Query"==this.tabs.getSelectedValue()&&this.updateQuery(),"Extra"==this.tabs.getSelectedValue()&&this.updateExtra(),this.mol.keepTransient=!1,this.callbackApply&&this.callbackApply(this)}populateBond(t){const{mol:e,bond:i}=this;let s=it("<div/>").appendTo(t);s.css({display:"grid","align-items":"center","justify-content":"start"}),s.css({"grid-row-gap":"0.5em","grid-column-gap":"0.5em"}),s.css({"grid-template-columns":"[start col0] auto [col1] auto [col2] auto [col3] auto [col4 end]"}),it("<div/>").appendTo(s).css({"grid-area":"1 / col0"}).setText("Order");let n=[];for(let t=0;t<=4;t++)n.push(`&nbsp;&nbsp;${t}&nbsp;&nbsp;`);this.optionOrder=new qi(n),this.optionOrder.htmlLabels=!0,this.optionOrder.setSelectedIndex(e.bondOrder(i)),this.optionOrder.render(it("<div/>").appendTo(s).css({"grid-column":"col1 / col4","grid-row":"1"})),it("<div/>").appendTo(s).css({"grid-area":"2 / col0"}).setText("Stereo"),this.optionStereo=new qi(["None","Up","Down","Unknown"]),this.optionStereo.setSelectedIndex(e.bondType(i)),this.optionStereo.render(it("<div/>").appendTo(s).css({"grid-column":"col1 / col4","grid-row":"2"})),it("<div/>").appendTo(s).css({"grid-area":"3 / col0"}).setText("From"),this.inputFrom=it('<input size="6"/>').appendTo(s).css({"grid-area":"3 / col1",font:"inherit"}),this.inputFrom.elInput.readOnly=!0,this.inputFrom.setValue(e.bondFrom(i).toString()),it("<div/>").appendTo(s).css({"grid-area":"3 / col2"}).setText("To"),this.inputTo=it('<input size="6"/>').appendTo(s).css({"grid-area":"3 / col3",font:"inherit"}),this.inputTo.elInput.readOnly=!0,this.inputTo.setValue(e.bondTo(i).toString()),it("<div/>").appendTo(s).css({"grid-area":"4 / col2"}).setText("Index"),this.inputIndex=it('<input size="6"/>').appendTo(s).css({"grid-area":"4 / col3",font:"inherit"}),this.inputIndex.elInput.readOnly=!0,this.inputIndex.setValue(i.toString())}populateGeometry(t){const{mol:e,bond:i}=this;let s=it("<div/>").appendTo(t).css({"text-align":"center"}),n=it("<div/>").appendTo(s).css({display:"inline-block"}),o=it("<div/>").appendTo(n);o.css({display:"grid","align-items":"center","justify-content":"start"}),o.css({"grid-row-gap":"0.5em","grid-column-gap":"0.5em"}),o.css({"grid-template-columns":"[start col0] auto [col1] auto [col2]"}),this.geomWidget=new Li(ki.Bond,e,i),this.geomWidget.render(it("<div/>").appendTo(o).css({"grid-area":"1 / col0 / auto / col2","text-align":"center"}));let l=it("<div/>").appendTo(o).css({"grid-area":"2 / col0"});this.inputGeom1=it('<input type="number" size="8"/>').appendTo(o).css({"grid-area":"2 / col1"}),this.geomWidget.callbackSelect=t=>{if(t.type==Bi.Link){let t=e.bondFrom(i),s=e.bondTo(i),n=e.atomX(s)-e.atomX(t),o=e.atomY(s)-e.atomY(t);l.setText("Distance"),this.inputGeom1.setValue(this.refGeom1=b(n,o).toFixed(3))}},this.geomWidget.callbackSelect(this.geomWidget.selected)}populateQuery(t){this.queryWidget=new zi(this.mol,0,this.bond),this.queryWidget.render(t)}populateExtra(t){let e=[...this.mol.bondExtra(this.bond),...this.mol.bondTransient(this.bond)];this.fieldsWidget=new Ii(e),this.fieldsWidget.render(t)}updateMolecule(){let{mol:t,bond:e}=this;t.setBondOrder(e,this.optionOrder.getSelectedIndex()),t.setBondType(e,this.optionStereo.getSelectedIndex())}updateGeometry(){let t=this.inputGeom1.getValue();if(this.refGeom1==t)return;const{mol:e}=this;let i=this.geomWidget.selected,s=this.geomWidget.selectionAtoms(i);if(i.type==Bi.Link&&this.refGeom1!=t){let i=parseFloat(t);if(isNaN(i)||Math.abs(i)>100)return;let n={mol:e,currentAtom:0,currentBond:e.findBond(s[0],s[1]),selectedMask:null},o=new Be(n,Se.BondDist,{dist:i});return o.execute(),void(this.mol=o.output.mol)}}updateQuery(){this.queryWidget.updateBond()}updateExtra(){this.mol.setBondExtra(this.bond,this.fieldsWidget.getExtraFields()),this.mol.setBondTransient(this.bond,this.fieldsWidget.getTransientFields())}selectedTab(t){0==t?this.inputFrom.grabFocus():1==t&&this.inputGeom1.grabFocus()}}const Yi="a".charCodeAt(0),Xi="A".charCodeAt(0);function Ui(t){return String.fromCharCode(Xi+Math.min(26,Math.max(0,t))-1)}function ji(t){return String.fromCharCode(Yi+Math.min(26,Math.max(0,t))-1)}class Hi extends li{constructor(e,i,s,n){super(),this.atoms=i,this.proxyClip=s,this.callbackApply=n,this.optionConnect=null,this.optionBondConn=null,this.currentID=0,this.unit=null,this.borderAtoms=[],this.outBonds=[],this.outAtoms=[],this.initMol=e,this.mol=e.clone(),this.title="Polymer Block",this.minPortionWidth=20,this.maxPortionWidth=95,this.polymer=new Ot(this.mol),i=t.sorted(i);for(let e of this.polymer.getIDList()){let s=this.polymer.getUnit(e);if(t.equals(i,s.atoms)){this.currentID=e,this.unit=s;break}}this.unit||(this.unit=new qt(i)),this.umol=this.mol.clone();let o=t.booleanArray(!1,this.umol.numAtoms);for(let t=1;t<=this.mol.numBonds;t++){let e=this.mol.bondFrom(t),i=this.mol.bondTo(t),s=this.atoms.includes(e),n=this.atoms.includes(i);(s||n)&&(o[e-1]=o[i-1]=!0),s&&!n&&(this.borderAtoms.push(e),this.outBonds.push(t),this.outAtoms.push(i)),n&&!s&&(this.borderAtoms.push(i),this.outBonds.push(t),this.outAtoms.push(e))}this.borderAtoms=t.sortedUnique(this.borderAtoms),this.umap=t.maskMap(o),this.umol=Kt.subgraphMask(this.umol,o),new Ot(this.umol).removeAll()}populate(){this.proxyClip.pushHandler(new oe);let e=this.buttonsDOM(),i=this.bodyDOM();this.btnApply=it('<button class="wmk-button wmk-button-primary">Apply</button>').appendTo(e).css({"margin-left":"0.5em"}),0==this.currentID&&this.btnApply.setText("Create"),this.btnApply.onClick((()=>this.applyChanges())),this.currentID>0&&(this.btnRemove=it('<button class="wmk-button wmk-button-default">Remove</button>').appendTo(e).css({"margin-left":"0.5em"}),this.btnRemove.onClick((()=>this.applyRemove())));let s=it("<div/>").appendTo(i);s.css({display:"grid","align-items":"center","justify-content":"start"}),s.css({"grid-row-gap":"0.5em","grid-column-gap":"0.5em"}),s.css({"grid-template-columns":"[start col0] auto [col1] auto [col2] auto [col3] auto [col4] auto [end]"}),it("<div/>").appendTo(s).css({"grid-area":"1 / col0"}).setText("# Atoms");let n=it('<input size="5"/>').appendTo(it("<div/>").appendTo(s).css({"grid-area":"1 / col1"}));n.elInput.readOnly=!0,n.setValue(this.unit.atoms.length.toString()),it("<div/>").appendTo(s).css({"grid-area":"1 / col2"}).setText("Out-bonds");let o=it('<input size="5"/>').appendTo(it("<div/>").appendTo(s).css({"grid-area":"1 / col3"}));o.elInput.readOnly=!0,o.setValue(this.outBonds.length.toString());let l=1;2==this.outBonds.length&&(l++,it("<div/>").appendTo(s).css({"grid-area":`${l} / col0`}).setText("Connectivity"),this.optionConnect=new qi(["Unknown","Head-to-Tail","Head-to-Head","Random"]),this.optionConnect.render(it("<div/>").appendTo(s).css({"grid-area":`${l} / col1 / auto / col4`})),this.unit.connect==kt.HeadToTail?this.optionConnect.setSelectedIndex(1):this.unit.connect==kt.HeadToHead?this.optionConnect.setSelectedIndex(2):this.unit.connect==kt.Random&&this.optionConnect.setSelectedIndex(3)),4==this.outBonds.length&&4==t.uniqueUnstable(this.outAtoms).length&&(l++,it("<div/>").appendTo(s).css({"grid-area":`${l} / col0`}).setText("2x2 Connectivity"),this.populate2x2Conn(it("<div/>").appendTo(s).css({"grid-area":`${l} / col1 / auto / end`})));let r=t=>{if(!t)return null;let e=[];for(let i of t.split(",")){let t=parseInt(i);if(!(t>0))return;e.push(t)}return e};for(let t=0;t<this.borderAtoms.length;t++){l++;let e=it("<div/>").appendTo(s).css({"grid-area":`${l} / col0`,"text-align":"right","padding-right":"0.5em"});0==t&&e.setText("Name "),it("<span/>").appendTo(e).css({color:"#008000"}).setText(Ui(t+1));let i=it('<input size="20"/>').appendTo(it("<div/>").appendTo(s).css({"grid-area":`${l} / col1 / auto / end`,width:"100%"})),n=this.borderAtoms[t],o=this.unit.atomName.get(n);o&&i.setValue(o.join(",")),i.onInput((()=>{let t=r(i.getValue());void 0!==t&&this.unit.atomName.set(n,t)}))}for(let t=0;t<this.outAtoms.length;t++){l++;let e=it("<div/>").appendTo(s).css({"grid-area":`${l} / col0`,"text-align":"right","padding-right":"0.5em"});0==t&&e.setText("Link "),it("<span/>").appendTo(e).css({color:"#800080"}).setText(ji(t+1)),it("<div/>").appendTo(s).css({"grid-area":`${l} / col1`}).setText("Include");let i=it('<input size="10"/>').appendTo(it("<div/>").appendTo(s).css({"grid-area":`${l} / col2`,width:"100%"}));it("<div/>").appendTo(s).css({"grid-area":`${l} / col3`}).setText("Exclude");let n=it('<input size="10"/>').appendTo(it("<div/>").appendTo(s).css({"grid-area":`${l} / col4`,width:"100%"})),o=this.outBonds[t],a=this.unit.bondIncl.get(o),h=this.unit.bondExcl.get(o);a&&i.setValue(a.join(",")),h&&n.setValue(h.join(",")),i.onInput((()=>{let t=r(i.getValue());void 0!==t&&this.unit.bondIncl.set(o,t)})),n.onInput((()=>{let t=r(n.getValue());void 0!==t&&this.unit.bondExcl.set(o,t)}))}l++,this.populateUncap(it("<div/>").appendTo(s).css({"grid-area":`${l} / col0 / auto / col4`,"text-align":"center"})),l++,this.divPreview=it("<div/>").appendTo(s).css({"grid-area":`${l} / col0 / auto / col4`,"text-align":"center"}),this.renderUnit();let a=i.findAll("input,textarea");a.length>0&&a[0].grabFocus(!0);for(let t of a)t.css({font:"inherit"}),t.onKeyDown((t=>{let e=t.keyCode||t.which;13==e&&this.applyChanges(),27==e&&this.close()}))}close(){this.proxyClip.popHandler(),super.close()}populate2x2Conn(e){const i=[[0,1,2,3],[0,1,3,2],[0,2,1,3],[0,2,3,1],[0,3,1,2],[0,3,2,1]];let s=[null],n=["None"],o=0;for(let e of i){let i=t.idxGet(this.outBonds,e);t.equals(i,this.unit.bondConn)&&(o=n.length),s.push(i),n.push(`${e[0]+1},${e[1]+1}:${e[2]+1},${e[3]+1}`)}this.optionBondConn=new qi(n),this.optionBondConn.setSelectedIndex(o),this.optionBondConn.render(e),this.optionBondConn.onSelect((t=>{this.unit.bondConn=s[t],this.renderUnit()}))}populateUncap(t){let e=[];t:for(let t of this.outAtoms)if(1==this.mol.atomAdjCount(t)&&"*"!=this.mol.atomElement(t)){for(let e of this.polymer.getUnits())if(e.atoms.includes(t))continue t;e.push(t)}if(0==e.length)return;let i=it('<button class="wmk-button wmk-button-default">Uncap Exterior</button>').appendTo(t);i.onClick((()=>{i.elInput.disabled=!0;for(let t of e)this.mol.setAtomElement(t,"*")}))}applyChanges(){if(this.optionConnect){let t=this.optionConnect.getSelectedIndex();0==t?this.unit.connect=null:1==t?this.unit.connect=kt.HeadToTail:2==t?this.unit.connect=kt.HeadToHead:3==t&&(this.unit.connect=kt.Random)}this.currentID&&this.polymer.removeUnit(this.currentID),this.currentID=this.polymer.createUnit(this.unit.clone()),this.polymer.rewriteMolecule(),this.callbackApply(this)}applyRemove(){this.currentID&&this.polymer.removeUnit(this.currentID),this.callbackApply(this)}renderUnit(){let e=this.umol.clone(),i=_e.defaultColourOnWhite(20),s=new Ue(0,0,i.data.pointScale),n=new Ye;n.atomCircleSz=t.numberArray(0,e.numAtoms),n.atomCircleCol=t.numberArray(0,e.numAtoms),n.atomDecoText=t.stringArray(null,e.numAtoms),n.atomDecoCol=t.numberArray(null,e.numAtoms),n.atomDecoSize=t.numberArray(null,e.numAtoms);let o=this.borderAtoms.map((t=>this.umap[t-1]+1)),l=this.outAtoms.map((t=>this.umap[t-1]+1));for(let t=1;t<=e.numAtoms;t++){let i=o.indexOf(t),s=l.indexOf(t);i>=0&&(n.atomDecoText[t-1]=Ui(i+1),n.atomDecoCol[t-1]=32768,n.atomDecoSize[t-1]=.5),s>=0&&(e.setAtomCharge(t,0),e.setAtomUnpaired(t,0),e.setAtomIsotope(t,0),n.atomCircleSz[t-1]=.1,n.atomCircleCol[t-1]=16711935,n.atomDecoText[t-1]=ji(s+1),n.atomDecoCol[t-1]=8388736,n.atomDecoSize[t-1]=.5,e.setAtomElement(t,"C"))}let r=new He(e,s,i,n);r.arrange(),r.squeezeInto(0,0,300,300);let a=new si;if(this.unit.bondConn){const t=[[0,1,13135112,2,!1],[2,3,13135112,2,!1],[0,2,3234360584,1,!0],[1,3,3234360584,1,!0]];for(let[e,i,s,n,o]of t){let t=this.outAtoms[this.outBonds.indexOf(this.unit.bondConn[e])],l=this.outAtoms[this.outBonds.indexOf(this.unit.bondConn[i])],h=r.getPoint(t-1),u=r.getPoint(l-1);if(a.drawLine(h.oval.cx,h.oval.cy,u.oval.cx,u.oval.cy,s,n),o)for(let t of[.2,.4,.6,.8]){let e=h.oval.cx+t*(u.oval.cx-h.oval.cx),i=h.oval.cy+t*(u.oval.cy-h.oval.cy);a.drawOval(e,i,2,2,s,n,null)}}}new ni(r,a).draw(),a.normalise(),this.divPreview.empty(),it(a.createSVG()).appendTo(this.divPreview).css({"pointer-events":"none"})}}var Vi,Wi=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function l(t){try{a(s.next(t))}catch(t){o(t)}}function r(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(l,r)}a((s=s.apply(t,e||[])).next())}))};class Gi extends mi{constructor(t,e){super(),this.owner=t,this.group=e,this.subgroups=null,this.templates=null}init(){let t=_e.defaultBlackOnWhite();t.data.pointScale=10,t.data.lineSize*=1.5,t.data.bondSep*=1.5,(()=>{Wi(this,void 0,void 0,(function*(){0==Gi.resourceData.length&&(yield this.loadResourceData()),null==this.group?this.prepareSubGroups():this.prepareTemplates()}))})()}update(){null==this.subgroups&&null==this.templates||(this.buttons=[],null==this.group?this.populateGroups():this.populateTemplates())}populateGroups(){let t=this.subgroups.groups,e=this.subgroups.titles,i=this.subgroups.preview;for(let s=0;s<t.length;s++)this.buttons.push({id:t[s],metavec:i[s],helpText:e[s]})}populateTemplates(){let t=this.templates.names,e=(this.templates.abbrev,this.templates.mnemonic,this.templates.preview);for(let i=0;i<t.length;i++)this.buttons.push({id:i.toString(),metavec:e[i],helpText:t[i]})}hitButton(t){if(null==this.group)this.buttonView.pushBank(new Gi(this.owner,t));else{let e=parseInt(t),i={fragNative:this.templates.molecules[e]};new Be(this.owner.getState(),Se.TemplateFusion,i,this.owner).execute()}}loadResourceData(){return Wi(this,void 0,void 0,(function*(){for(let t of Me){let e=ot.RESOURCE_URL+"/data/templates/"+t+".ds",i=yield j(e);Gi.resourceList.push(t),Gi.resourceData.push(ve.readXML(i))}}))}prepareSubGroups(){this.subgroups={groups:Gi.resourceList,titles:[],preview:[]};let t=this.buttonView.idealSize,e=.5*(t-2),i=_e.defaultBlackOnWhite();i.data.pointScale=10;let s=new Ye,n=new Ue(0,0,i.data.pointScale);for(let o of Gi.resourceData){this.subgroups.titles.push(o.title);let l=o.firstColOfType("molecule"),r=new si;for(let t=0,a=0;a<4&&t<o.numRows;t++){let h=o.getMolecule(t,l);if(Kt.isBlank(h))continue;let u=new He(h,n,i,s);u.arrange();let m=a%2,d=Math.floor(a/2);u.squeezeInto(1+m*e,1+d*e,e,e,1),new ni(u,r).draw(),a++}r.width=t,r.height=t,this.subgroups.preview.push(r)}this.buttonView.refreshBank()}prepareTemplates(){let t=Gi.resourceList.indexOf(this.group),e=Gi.resourceData[t];this.templates={molecules:[],names:[],abbrev:[],mnemonic:[],preview:[]};let i=this.buttonView.idealSize,s=_e.defaultBlackOnWhite();s.data.pointScale=12;let n=new Ye,o=new Ue(0,0,s.data.pointScale),l=e.findColByName("Molecule"),r=e.findColByName("Name"),a=e.findColByName("Abbrev"),h=e.findColByName("Mnemonic");for(let t=0;t<e.numRows;t++){let u=e.getMolecule(t,l);this.templates.molecules.push(u.toString()),this.templates.names.push(e.getString(t,r)),this.templates.abbrev.push(e.getString(t,a)),this.templates.mnemonic.push(e.getString(t,h));let m=new He(u,o,s,n);m.arrange(),m.squeezeInto(0,0,i,i,2);let d=new si;new ni(m,d).draw(),d.width=i,d.height=i,this.templates.preview.push(d)}this.buttonView.refreshBank()}}Gi.resourceList=[],Gi.resourceData=[];class Qi extends mi{constructor(t){super(),this.owner=t}update(){this.buttons=[],this.buttons.push({id:"accept",imageFN:"GenericAccept",helpText:"Apply this template."}),this.buttons.push({id:"prev",imageFN:"TemplatePrev",helpText:"Show previous fusion option."}),this.buttons.push({id:"next",imageFN:"TemplateNext",helpText:"Show next fusion option."})}hitButton(t){"accept"==t?this.owner.templateAccept():"prev"==t?this.owner.templateRotate(-1):"next"==t&&this.owner.templateRotate(1)}bankClosed(){this.owner.clearPermutations()}}!function(t){t.Arrow="arrow",t.Rotate="rotate",t.Pan="pan",t.Drag="drag",t.Erasor="erasor",t.BondOrder0="bond:Order0",t.BondOrder1="bond:Order1",t.BondOrder2="bond:Order2",t.BondOrder3="bond:Order3",t.BondUnknown="bond:Unknown",t.BondInclined="bond:Inclined",t.BondDeclined="bond:Declined",t.RingAliph="ringAliph",t.RingArom="ringArom",t.AtomPlus="atomPlus",t.AtomMinus="atomMinus",t.BondPfx="bond:",t.ElementPfx="element:"}(Vi||(Vi={}));const Ki=[{id:Vi.Arrow,imageFN:"ToolSelect",helpText:"Selection tool.",mnemonic:"Escape"},{id:Vi.Rotate,imageFN:"ToolRotate",helpText:"Rotate subject atoms.",mnemonic:""},{id:Vi.Pan,imageFN:"ToolPan",helpText:"Pan the viewport around the screen.",mnemonic:""},{id:Vi.Drag,imageFN:"ToolDrag",helpText:"Drag selected atoms to new positions.",mnemonic:""},{id:Vi.Erasor,imageFN:"ToolErasor",helpText:"Delete atoms or bonds by selecting.",mnemonic:"Delete"},{id:Vi.BondOrder0,imageFN:"BondZero",helpText:"Create or change a bond to zero order.",mnemonic:"Shift+0",key:")"},{id:Vi.BondOrder1,imageFN:"BondOne",helpText:"Create or change a bond to single.",mnemonic:"Shift+1",key:"!"},{id:Vi.BondOrder2,imageFN:"BondTwo",helpText:"Create or change a bond to double.",mnemonic:"Shift+2",key:"@"},{id:Vi.BondOrder3,imageFN:"BondThree",helpText:"Create or change a bond to triple.",mnemonic:"Shift+3",key:"#"},{id:Vi.BondUnknown,imageFN:"BondSquig",helpText:"Create or change a bond to unknown stereochemistry.",mnemonic:"Shift+4",key:"$"},{id:Vi.BondInclined,imageFN:"BondUp",helpText:"Create or change a bond to up-wedge.",mnemonic:"Shift+5",key:"%"},{id:Vi.BondDeclined,imageFN:"BondDown",helpText:"Create or change a bond to down-wedge.",mnemonic:"Shift+6",key:"^"},{id:Vi.RingAliph,imageFN:"ToolRing",helpText:"Create plain ring.",mnemonic:"Shift+7",key:"&"},{id:Vi.RingArom,imageFN:"ToolArom",helpText:"Create aromatic ring.",mnemonic:"Shift+8",key:"*"},{id:Vi.AtomPlus,imageFN:"AtomPlus",helpText:"Increase charge on atom.",mnemonic:""},{id:Vi.AtomMinus,imageFN:"AtomMinus",helpText:"Decrease charge on atom.",mnemonic:""},{id:Vi.ElementPfx+"C",text:"C",helpText:"Change elements to Carbon.",mnemonic:""},{id:Vi.ElementPfx+"N",text:"N",helpText:"Change elements to Nitrogen.",mnemonic:""},{id:Vi.ElementPfx+"O",text:"O",helpText:"Change elements to Oxygen.",mnemonic:""},{id:Vi.ElementPfx+"S",text:"S",helpText:"Change elements to Sulfur.",mnemonic:""},{id:Vi.ElementPfx+"P",text:"P",helpText:"Change elements to Phosphorus.",mnemonic:""},{id:Vi.ElementPfx+"H",text:"H",helpText:"Change elements to Hydrogen.",mnemonic:""},{id:Vi.ElementPfx+"F",text:"F",helpText:"Change elements to Fluorine.",mnemonic:""},{id:Vi.ElementPfx+"Cl",text:"Cl",helpText:"Change elements to Chlorine.",mnemonic:""},{id:Vi.ElementPfx+"Br",text:"Br",helpText:"Change elements to Bromine.",mnemonic:""},{id:Vi.ElementPfx+"A",text:"A",helpText:"Pick other element.",mnemonic:""}];class $i extends mi{constructor(t){super(),this.owner=t}update(){for(let t of Ki)this.buttons.push(t);this.buttonView.setSelectedButton("arrow")}hitButton(t){this.buttonView.setSelectedButton(t)}claimKey(t){for(let e of Ki)if(mi.matchKey(t,e.mnemonic,e.key))return this.hitButton(e.id),!0;return!1}}var Zi=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function l(t){try{a(s.next(t))}catch(t){o(t)}}function r(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(l,r)}a((s=s.apply(t,e||[])).next())}))};class Ji extends Ni{constructor(){super(),this.callbackSpecialPaste=null,this.inDialog=!1,this.initialFocus=!0,this.useToolBank=!0,this.lowerToolBank=!1,this.useCommandBank=!0,this.lowerCommandBank=!1,this.useTemplateBank=!0,this.lowerTemplateBank=!1,this.debugOutput=void 0,this.beenSetup=!1,this.undoStack=[],this.redoStack=[],this.fadeWatermark=0,this.toolView=null,this.commandView=null,this.templateView=null,this.proxyClip=null,this.proxyMenu=null}setSize(t,e){this.width=t,this.height=e}defineMolecule(t,e=!0,i=!1,s=!1){if(0!=t.compareTo(this.mol)){i&&this.stashUndo(),this.stopTemplateFusion(),this.mol=t.clone(),this.callbackChangeMolecule&&this.callbackChangeMolecule(this.mol),this.guidelines=[];for(let t=1;t<=this.mol.numAtoms;t++)for(let e of Qt.guidelineSprouts(this.mol,t))this.guidelines.push(e);this.beenSetup&&(s||(this.currentAtom=this.currentBond=0,this.selectedMask=null),this.stereo=null,this.hoverAtom=0,this.hoverBond=0,e?this.autoScale():this.renderMolecule())}}defineClipboard(t){this.proxyClip=t}defineContext(t){this.proxyMenu=t}defineMoleculeString(t,e,i){this.defineMolecule(Vt.fromString(t),e,i)}defineRenderPolicy(t){this.policy=t,this.pointScale=t.data.pointScale}defineBackground(t,e,i){null!=t&&(this.border=t),null!=e&&(this.borderRadius=e),null!=i&&(this.background=i)}clearMolecule(){this.defineMolecule(new Vt,!0,!0)}getMolecule(){return this.mol.clone()}setup(t){this.beenSetup=!0,null==this.mol&&(this.mol=new Vt),null==this.policy&&(this.policy=_e.defaultColourOnWhite(),this.pointScale=this.policy.data.pointScale),this.layoutMolecule(),this.centreAndShrink(),this.redrawMetaVector(),t&&t()}setupAsync(){return Zi(this,void 0,void 0,(function*(){return new Promise((t=>this.setup((()=>t()))))}))}render(t){super.render(t),this.centreAndShrink(),this.redraw();let e=0;this.useCommandBank&&(this.commandView=new ui(hi.Bottom,0,0,this.width,this.height),this.lowerCommandBank&&this.commandView.lowerBank(),this.commandView.setHasBigButtons(!1),this.commandView.pushBank(new wi(this)),this.commandView.render(this.container),e=this.commandView.height),this.useToolBank&&(this.toolView=new ui(hi.Left,0,0,this.width,this.height-e),this.lowerToolBank&&this.toolView.lowerBank(),this.toolView.setHasBigButtons(!1),this.toolView.pushBank(new $i(this)),this.toolView.render(this.container)),this.useTemplateBank&&(this.templateView=new ui(hi.Right,0,0,this.width,this.height-e),this.lowerTemplateBank&&this.templateView.lowerBank(),this.templateView.setHasBigButtons(!0),this.templateView.pushBank(new Gi(this,null)),this.templateView.render(this.container)),this.container.onClick((t=>this.mouseClick(t))),this.container.onDblClick((t=>this.mouseDoubleClick(t))),this.container.onMouseDown((t=>this.mouseDown(t))),this.container.onMouseUp((t=>this.mouseUp(t))),this.container.onMouseOver((t=>this.mouseOver(t))),this.container.onMouseLeave((t=>this.mouseOut(t))),this.container.onMouseMove((t=>this.mouseMove(t))),this.container.onKeyPress((t=>this.keyPressed(t))),this.container.onKeyDown((t=>this.keyDown(t))),this.container.onKeyUp((t=>this.keyUp(t))),this.container.onTouchStart((t=>this.touchStart(t))),this.container.onTouchMove((t=>this.touchMove(t))),this.container.onTouchCancel((t=>this.touchCancel(t))),this.container.onTouchEnd((t=>this.touchEnd(t))),this.contentDOM.onContextMenu((t=>this.contextMenu(t))),this.container.el.addEventListener("dragover",(t=>{t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy"})),this.container.el.addEventListener("drop",(t=>{t.stopPropagation(),t.preventDefault(),this.dropInto(t.dataTransfer)})),this.initialFocus&&this.grabFocus()}get decoration(){return this.viewOpt.decoration}set decoration(t){this.viewOpt.decoration!=t&&(this.viewOpt.decoration=t,this.renderMolecule())}get showOxState(){return this.viewOpt.showOxState}set showOxState(t){this.viewOpt.showOxState!=t&&(this.viewOpt.showOxState=t,this.renderMolecule())}get showQuery(){return this.viewOpt.showQuery}set showQuery(t){this.viewOpt.showQuery!=t&&(this.viewOpt.showQuery=t,this.renderMolecule())}get showArtifacts(){return this.viewOpt.showArtifacts}set showArtifacts(t){this.viewOpt.showArtifacts!=t&&(this.viewOpt.showArtifacts=t,this.renderMolecule())}changeSize(t,e){if(t!=this.width||e!=this.height){this.width=t,this.height=e;for(let i of[this.container,this.canvasUnder,this.canvasMolecule,this.canvasOver])i.css({width:`${t}px`,height:`${e}px`});for(let i of[this.commandView,this.toolView,this.templateView])i&&(i.setParentSize(t,e),i.refreshBank());this.autoScale()}}showMessage(t,e=!1){let i=++this.fadeWatermark;this.divMessage.css({color:e?"#FF0000":"#008000"}),this.divMessage.setText(t);let s=(null==this.toolView?0:this.toolView.width)+2,n=(null==this.templateView?0:this.templateView.width)+2,o=(null==this.commandView?0:this.commandView.height)+2;this.divMessage.css({left:s+"px"}),this.divMessage.css({width:this.width-s-n+"px"}),this.divMessage.css({height:this.height-o+"px"}),window.setTimeout((()=>{i==this.fadeWatermark&&this.divMessage.setText("")}),5e3)}clearMessage(){""!=this.divMessage.getText()&&(this.fadeWatermark++,this.divMessage.setText(""))}autoScale(){this.pointScale=this.policy.data.pointScale,this.layoutMolecule(),this.centreAndShrink(),this.redrawMetaVector(),this.layoutTemplatePerm(),this.delayedRedraw()}anySelected(){if(null==this.selectedMask)return!1;for(let t=0;t<this.selectedMask.length;t++)if(this.selectedMask[t])return!0;return!1}setSelected(t,e){if(null==this.selectedMask){this.selectedMask=new Array(this.mol.numAtoms);for(let t=this.selectedMask.length-1;t>=0;t--)this.selectedMask[t]=!1}for(;this.selectedMask.length<this.mol.numAtoms;)this.selectedMask.push(!1);this.selectedMask[t-1]=e,this.delayedRedraw()}changeCurrentAtom(t){this.currentAtom!=t&&(this.currentAtom=t,this.currentBond=0,this.delayedRedraw())}changeCurrentBond(t){this.currentBond!=t&&(this.currentBond=t,this.currentAtom=0,this.delayedRedraw())}clearSubject(){0==this.currentAtom&&0==this.currentBond&&t.allFalse(this.selectedMask)||(this.currentAtom=0,this.currentBond=0,this.selectedMask=t.booleanArray(!1,this.mol.numAtoms),this.delayedRedraw())}setState(t,e=!0){this.stopTemplateFusion(),null!=t.mol&&this.defineMolecule(t.mol.clone(),!1,e,!0),t.currentAtom>=0&&(this.currentAtom=t.currentAtom),t.currentBond>=0&&(this.currentBond=t.currentBond),null!=t.selectedMask&&(this.selectedMask=null==t.selectedMask?null:t.selectedMask.slice(0)),this.delayedRedraw()}stashUndo(){let t=this.getState();for(this.undoStack.push(t);this.undoStack.length>Ji.UNDO_SIZE;)this.undoStack.splice(0,1);this.redoStack=[]}setPermutations(t){this.templatePerms=t,this.pickTemplatePermutation(0),this.fusionBank=new Qi(this),this.templateView.pushBank(this.fusionBank),0==this.mol.numAtoms&&this.centreAndShrink()}stopTemplateFusion(){null!=this.fusionBank&&this.templateView.popBank()}clearPermutations(){null!=this.templatePerms&&(this.templatePerms=null,this.delayedRedraw(),this.fusionBank=null)}templateAccept(){let t=Vt.fromString(this.templatePerms[this.currentPerm].mol);this.templateView.popBank(),this.defineMolecule(t,!1,!0,!1)}templateRotate(t){let e=(this.currentPerm+t)%this.templatePerms.length;e<0&&(e+=this.templatePerms.length),this.pickTemplatePermutation(e)}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}performUndo(){if(0==this.undoStack.length)return;let t=this.getState();this.redoStack.push(t),this.setState(this.undoStack.pop(),!1)}performRedo(){if(0==this.redoStack.length)return;let t=this.getState();this.undoStack.push(t),this.setState(this.redoStack.pop(),!1)}performCopy(t){t||(t=this.getMolecule()),this.proxyClip&&this.proxyClip.setString(t.toString())}performCopySelection(t){new Be(this.getState(),t?Se.Cut:Se.Copy,{},this).execute()}performPaste(){if(this.proxyClip&&this.proxyClip.canAlwaysGet()){let t=this.proxyClip.getString();this.pasteText(t)}}performActivity(t,e={}){new Be(this.getState(),t,e,this).execute()}zoom(t){let e=.5*this.width,i=.5*this.height,s=Math.min(10*this.policy.data.pointScale,Math.max(.1*this.policy.data.pointScale,this.pointScale*t));s!=this.pointScale&&(this.offsetX=e-s/this.pointScale*(e-this.offsetX),this.offsetY=i-s/this.pointScale*(i-this.offsetY),this.pointScale=s,this.layoutMolecule(),this.redrawMetaVector(),this.layoutTemplatePerm(),this.delayedRedraw())}editCurrent(){this.currentBond>0?this.editBond(this.currentBond):this.editAtom(this.currentAtom)}pasteText(t){const e=()=>{let e=Ut.readUnknown(t);if(!e){let i=ve.readXML(t);if(i)t:for(let t=0;t<i.numRows;t++)for(let s=0;s<i.numCols;s++)if("molecule"==i.colType(s)&&i.notNull(t,s)){e=i.getMolecule(t,s);break t}}null!=e?this.pasteMolecule(e):alert("Text from clipboard is not a valid molecule.")};this.callbackSpecialPaste?(()=>{Zi(this,void 0,void 0,(function*(){let i=yield this.callbackSpecialPaste(t);i?this.pasteMolecule(i):e()}))})():e()}pasteMolecule(t){if(0==this.mol.numAtoms)return void this.defineMolecule(t,!0,!0,!0);let e=new Be(this.getState(),Se.QueryPaste,{qmol:t});if(e.execute(),e.output.mol)return void this.defineMolecule(e.output.mol,!1,!0,!0);let i={fragNative:t.toString()};new Be(this.getState(),Se.TemplateFusion,i,this).execute()}pickTemplatePermutation(t){this.templatePerms[t],this.currentPerm=t,this.layoutTemplatePerm(),this.delayedRedraw()}performPolymerBlock(t){let e=new Hi(this.mol,t,this.proxyClip,(()=>{0!=this.mol.compareTo(e.mol)&&this.defineMolecule(e.mol,!1,!0,!0),e.close()}));e.callbackClose=()=>{this.inDialog=!1,this.grabFocus()},this.inDialog=!0,e.open()}grabFocus(){this.container.grabFocus()}hasFocus(){return this.container.hasFocus()}centreAndShrink(){if(0==this.mol.numAtoms||null==this.layout)return this.offsetX=.5*this.width,this.offsetY=.5*this.height,void(this.pointScale=this.policy.data.pointScale);let t=this.layout.determineBoundary(0),e=this.width-6,i=this.height-6,s=t[2]-t[0],n=t[3]-t[1],o=1;if(s>e){let t=e/s;o*=t,s*=t,n*=t}if(n>i){let t=i/n;o*=t,s*=t,n*=t}o<1&&(this.pointScale*=o,this.layout.offsetEverything(this.offsetX*o,this.offsetY*o),this.layout.scaleEverything(o),t=this.layout.determineBoundary(0));let l=.5*(e-s)-t[0],r=.5*(i-n)-t[1];this.offsetX+=l,this.offsetY+=r,this.layout.offsetEverything(l,r)}layoutTemplatePerm(){if(this.currentPerm<0||null==this.templatePerms)return;let t=this.templatePerms[this.currentPerm],e=new _e(this.policy.data);e.data.foreground=8421504,e.data.atomCols=e.data.atomCols.slice(0);for(let t in e.data.atomCols)e.data.atomCols[t]=8421504;let i=new Ye,s=new He(Vt.fromString(t.display),this,e,i);s.arrange(),t.metavec=new si,new ni(s,t.metavec).draw()}renderMolecule(){this.layoutMolecule(),this.redrawMetaVector(),this.delayedRedraw()}pickObjectCanvas(t,e){if(null==this.layout)return 0;if(null!=this.toolView){let i=this.container.offset(),s=this.toolView.contentDOM.offset();if(this.toolView.withinOutline(t+i.x-s.x,e+i.y-s.y))return null}if(null!=this.commandView){let i=this.container.offset(),s=this.commandView.contentDOM.offset();if(this.commandView.withinOutline(t+i.x-s.x,e+i.y-s.y))return null}if(null!=this.templateView){let i=this.container.offset(),s=this.templateView.contentDOM.offset();if(this.templateView.withinOutline(t+i.x-s.x,e+i.y-s.y))return null}return super.pickObjectCanvas(t,e)}updateHoverCursor(t,e){let i=this.toolView?this.toolView.selectedButton:"",s=i&&i!=Vi.Pan&&i!=Vi.Rotate,n=0;this.dragType==Ci.None&&s&&(n=this.pickObject(t,e));let o=n>0?n:0,l=n<0?-n:0,r=this.hoverAtom>0&&Kt.hasAbbrev(this.mol,this.hoverAtom)?this.hoverAtom:0,a=o>0&&Kt.hasAbbrev(this.mol,o)?o:0;o==this.hoverAtom&&l==this.hoverBond||(this.hoverAtom=o,this.hoverBond=l,r!=a&&(this.layoutMolecule(),this.redrawMetaVector()),this.delayedRedraw())}determineDragGuide(t){if(0==this.opAtom||0==this.mol.atomAdjCount(this.opAtom)){let e={atom:this.opAtom,orders:[t],x:[],y:[],sourceX:0==this.opAtom?this.clickX:this.angToX(this.mol.atomX(this.opAtom)),sourceY:0==this.opAtom?this.clickY:this.angToY(this.mol.atomY(this.opAtom)),destX:[],destY:[]},i=0==this.opAtom?this.xToAng(this.clickX):this.mol.atomX(this.opAtom),s=0==this.opAtom?this.yToAng(this.clickY):this.mol.atomY(this.opAtom);for(let t=0;t<12;t++){let n=E*t/12,o=Vt.IDEALBOND*Math.cos(n),l=Vt.IDEALBOND*Math.sin(n);e.x.push(i+o),e.y.push(s+l),e.destX.push(e.sourceX+o*this.pointScale),e.destY.push(e.sourceY-l*this.pointScale)}return[e]}if(null==this.guidelines)return null;let e=null,i=null;for(let s=0;s<this.guidelines.length;s++){let n=this.guidelines[s];if(n.atom==this.opAtom){if(n.orders.indexOf(t)>=0){e=n;break}n.orders.indexOf(1)>=0&&(i=n)}}if(null==e&&(e=i),null==e)return[];let s=_(e);s.sourceX=this.angToX(this.mol.atomX(s.atom)),s.sourceY=this.angToY(this.mol.atomY(s.atom)),s.destX=[],s.destY=[];for(let t=0;t<s.x.length;t++)s.destX.push(this.angToX(s.x[t])),s.destY.push(this.angToY(s.y[t]));return[s]}determineMoveGuide(){let t=this.subjectAtoms(!1,!0);if(0==t.length||t.length==this.mol.numAtoms)return null;let e=[];for(let i=0;i<this.guidelines.length;i++){let s=this.guidelines[i];if(!(s.orders.indexOf(1)<0||t.indexOf(s.atom)>=0)){s=_(s),s.sourceX=this.angToX(this.mol.atomX(s.atom)),s.sourceY=this.angToY(this.mol.atomY(s.atom)),s.destX=[],s.destY=[];for(let t=0;t<s.x.length;t++)s.destX.push(this.angToX(s.x[t])),s.destY.push(this.angToY(s.y[t]));e.push(s)}}return e}editAtom(t){let e=new Fi(this.mol,t,this.proxyClip,(()=>{0!=this.mol.compareTo(e.mol)&&this.defineMolecule(e.mol,!1,!0,!0),e.close()}));if(e.callbackClose=()=>{this.inDialog=!1,this.grabFocus()},0==t&&this.mol.numAtoms>0){let t=this.mol.boundary();e.newX=t.maxX()+Vt.IDEALBOND,e.newY=t.midY()}this.inDialog=!0,e.open()}editBond(t){if(0==t)return;let e=new _i(this.mol,t,this.proxyClip,(()=>{0!=this.mol.compareTo(e.mol)&&this.defineMolecule(e.mol,!1,!0,!0),e.close()}));e.callbackClose=()=>{this.inDialog=!1,this.grabFocus()},this.inDialog=!0,e.open()}hitArrowKey(t,e){let i=++this.cursorWatermark;this.cursorDX+=t,this.cursorDY+=e,setTimeout((()=>{i==this.cursorWatermark&&this.cursorJumpDirection()}),100)}cursorJumpDirection(){let t=Math.atan2(this.cursorDY,this.cursorDX);this.currentAtom>0?this.jumpFromCurrentAtom(t):this.currentBond>0?this.jumpFromCurrentBond(t):this.jumpFromNowhere(t),this.cursorDX=0,this.cursorDY=0,this.cursorWatermark=0}jumpFromCurrentAtom(t){let e=this.mol.atomAdjList(this.currentAtom),i=0,s=Number.MAX_VALUE;for(let n of e){let e=this.mol.atomX(n)-this.mol.atomX(this.currentAtom),o=this.mol.atomY(n)-this.mol.atomY(this.currentAtom),l=Math.atan2(o,e),r=Math.abs(N(l,t));r<35*S&&r<s&&([i,s]=[n,r])}if(i>0)return void this.changeCurrentBond(this.mol.findBond(this.currentAtom,i));let n=0,o=Number.MIN_VALUE;for(let i=1;i<=this.mol.numAtoms;i++)if(i!=this.currentAtom&&e.indexOf(i)<0){let e=this.mol.atomX(i)-this.mol.atomX(this.currentAtom),s=this.mol.atomY(i)-this.mol.atomY(this.currentAtom),l=Math.atan2(s,e),r=Math.abs(N(l,t));if(r>45*S)continue;let a=Math.cos(r),h=Math.pow(a,2)/(y(e,s)+.001);h>o&&([n,o]=[i,h])}n>0&&this.changeCurrentAtom(n)}jumpFromCurrentBond(t){let[e,i]=this.mol.bondFromTo(this.currentBond),s=Math.atan2(this.mol.atomY(i)-this.mol.atomY(e),this.mol.atomX(i)-this.mol.atomX(e));Math.abs(N(t,s))<50*S&&this.changeCurrentAtom(i),Math.abs(N(t,s+Math.PI))<50*S&&this.changeCurrentAtom(e)}jumpFromNowhere(t){if(0==this.mol.numAtoms)return;if(1==this.mol.numAtoms)return void this.changeCurrentAtom(1);let e=0,i=0;for(let t=1;t<=this.mol.numAtoms;t++)e+=this.mol.atomX(t),i+=this.mol.atomY(t);let s=1/this.mol.numAtoms;e*=s,i*=s;let n=0,o=Number.MIN_VALUE;for(let s=1;s<=this.mol.numAtoms;s++){let l=this.mol.atomX(s)-e,r=this.mol.atomY(s)-i,a=Math.atan2(r,l),h=Math.cos(Math.abs(N(t+Math.PI,a)))*b(l,r);h>o&&([n,o]=[s,h])}n>0&&this.changeCurrentAtom(n)}createRing(e,i){const{mol:s}=this;let n=null,o=null;if(this.currentAtom>0){let i=0,l=0,r=s.atomAdjList(this.currentAtom),a=s.atomX(this.currentAtom),h=s.atomY(this.currentAtom);for(let t of r)i-=s.atomX(t)-a,l-=s.atomY(t)-h;if(Math.abs(i)<.001&&Math.abs(l)<.001)if(r.length>=2){let e=r.map((t=>Math.atan2(s.atomY(t)-a,s.atomX(t)-h)));t.sort(e);let n=Number.POSITIVE_INFINITY;for(let t=0;t<e.length;t++){let o=N(e[(t+1)%e.length],e[t]),r=Math.cos(o),u=Math.sin(o),m=Wt.congestionPoint(s,a+r,h+u);m<n&&([n,i,l]=[m,r,u])}}else[i,l]=[1,0];[n,o]=Qt.proposeAtomRing(this.mol,e,this.currentAtom,i,l)}else if(this.currentBond>0){let t=s.bondFrom(this.currentBond),i=s.bondTo(this.currentBond),l=s.atomX(t),r=s.atomY(t),a=s.atomX(i),h=s.atomY(i),u=.5*(l+a),m=.5*(r+h),d=r-h,c=a-l,[p,f]=Wt.congestionPoint(s,u-d,m-c)<Wt.congestionPoint(s,u+d,m+c)?[-d,-c]:[d,c];[n,o]=Qt.proposeBondRing(this.mol,e,this.currentBond,p,f)}else{let t=0,i=0;if(s.numAtoms>0){let e=s.boundary();[t,i]=[e.maxX()+Vt.IDEALBOND,e.midY()]}[n,o]=Qt.proposeNewRing(this.mol,e,t,i,0,-1,!1)}if(!n)return;let l={ringX:n,ringY:o,aromatic:i};new Be(this.getState(),Se.Ring,l,this).execute()}ctrlArrowKey(t,e){let i=++this.cursorWatermark;this.cursorDX+=t,this.cursorDY+=e,setTimeout((()=>{i==this.cursorWatermark&&(this.sproutDirection(this.cursorDX,this.cursorDY),this.cursorDX=this.cursorDY=0)}),100)}sproutDirection(t,e){new Be(this.getState(),Se.SproutDirection,{deltaX:t,deltaY:e},this).execute()}mouseClick(t){return t.stopPropagation(),this.grabFocus(),!1}mouseDoubleClick(t){if(t.stopPropagation(),t.preventDefault(),this.toolView.selectedButton!=Vi.Arrow)return;let e=f(t,this.container),i=this.pickObject(e[0],e[1]);if(i>0){let t=i;this.editAtom(t)}else{let t=-i;this.editBond(t)}return!1}mouseDown(t){if(t.stopPropagation(),t.preventDefault(),this.clearMessage(),t.ctrlKey&&!t.shiftKey&&!t.altKey)return void this.contextMenu(t);let[e,i]=f(t,this.container);return this.interactStart(e,i,t.shiftKey,t.ctrlKey,t.altKey),!1}mouseUp(t){t.stopPropagation();let[e,i]=f(t,this.container);return this.interactEnd(e,i),!1}mouseOver(t){t.stopPropagation();let[e,i]=f(t,this.container);return this.updateHoverCursor(e,i),this.updateLasso(e,i),!1}mouseOut(t){t.stopPropagation();let[e,i]=f(t,this.container);return this.updateHoverCursor(e,i),this.updateLasso(e,i),!1}mouseMove(t){t.stopPropagation();let[e,i]=f(t,this.container);if(this.updateHoverCursor(e,i),this.dragType!=Ci.None)return this.interactDrag(e,i),!1}keyPressed(t){}keyDown(t){let e=t.key;if("Escape"==e)for(let e of[this.templateView,this.commandView,this.toolView])if(null!=e&&e.stackSize>1)return e.popBank(),t.preventDefault(),void t.stopPropagation();let i=(t.shiftKey?"S":"")+(t.ctrlKey||t.metaKey?"C":"")+(t.altKey?"A":""),s=!(t.shiftKey||t.ctrlKey||t.altKey||t.metaKey);if("Enter"==e)this.editCurrent();else if("ArrowLeft"==e&&s)this.hitArrowKey(-1,0);else if("ArrowRight"==e&&s)this.hitArrowKey(1,0);else if("ArrowUp"==e&&s)this.hitArrowKey(0,1);else if("ArrowDown"==e&&s)this.hitArrowKey(0,-1);else if("z"==e&&"C"==i)this.performUndo();else if("Z"==e&&"SC"==i)this.performRedo();else if("z"==e&&s)this.toolView.cycleSelected(-1);else if("x"==e&&s)this.toolView.cycleSelected(1);else if(null!=this.toolView&&this.toolView.topBank.claimKey(t));else if(null!=this.commandView&&this.commandView.topBank.claimKey(t));else if(null!=this.templateView&&this.templateView.topBank.claimKey(t));else if("#"==e&&"SC"==i)this.createRing(3,!1);else if("$"==e&&"SC"==i)this.createRing(4,!1);else if("%"==e&&"SC"==i)this.createRing(5,!1);else if("^"==e&&"SC"==i)this.createRing(6,!1);else if("&"==e&&"SC"==i)this.createRing(7,!1);else if("3"==e&&"CA"==i)this.createRing(3,!0);else if("4"==e&&"CA"==i)this.createRing(4,!0);else if("5"==e&&"CA"==i)this.createRing(5,!0);else if("6"==e&&"CA"==i)this.createRing(6,!0);else if("7"==e&&"CA"==i)this.createRing(7,!0);else if("c"==e&&"C"==i&&this.proxyClip)this.proxyClip.triggerCopy(!1);else if("x"==e&&"C"==i&&this.proxyClip)this.proxyClip.triggerCopy(!0);else if("v"==e&&"C"==i&&this.proxyClip&&this.proxyClip.canAlwaysGet())this.proxyClip.triggerPaste();else if("ArrowLeft"==e&&"C"==i)this.ctrlArrowKey(-1,0);else if("ArrowRight"==e&&"C"==i)this.ctrlArrowKey(1,0);else if("ArrowUp"==e&&"C"==i)this.ctrlArrowKey(0,1);else if("ArrowDown"==e&&"C"==i)this.ctrlArrowKey(0,-1);else if("1"==e&&"C"==i)this.sproutDirection(-1,-1);else if("2"==e&&"C"==i)this.sproutDirection(0,-1);else if("3"==e&&"C"==i)this.sproutDirection(1,-1);else if("4"==e&&"C"==i)this.sproutDirection(-1,0);else if("6"==e&&"C"==i)this.sproutDirection(1,0);else if("7"==e&&"C"==i)this.sproutDirection(-1,1);else if("8"==e&&"C"==i)this.sproutDirection(0,1);else{if("9"!=e||"C"!=i)return;this.sproutDirection(1,1)}t.preventDefault(),t.stopPropagation()}keyUp(t){}touchStart(t){let[e,i]=f(t.touches[0],this.container);null!=this.pickObjectCanvas(e,i)&&(this.interactStart(e,i,t.shiftKey,t.ctrlKey,t.altKey),t.preventDefault())}touchMove(t){if(this.dragType!=Ci.None){let[e,i]=f(t.touches[0],this.container);this.interactDrag(e,i)}t.preventDefault()}touchCancel(t){}touchEnd(t){if(this.dragType!=Ci.None){let[e,i]=[this.mouseX,this.mouseY];this.interactEnd(e,i),t.preventDefault()}}mouseWheel(t){}contextMenu(t){if(t.preventDefault(),t.stopPropagation(),this.dragType=Ci.None,!this.proxyMenu)return;let[e,i]=f(t,this.container),s=this.pickObject(e,i);s>0?this.changeCurrentAtom(s):s<0&&this.changeCurrentBond(-s);let n=this.getState(),o=new Ei(n,this,this.proxyClip).populate();this.proxyMenu.openContextMenu(o,t)}interactStart(t,e,i,s,n){this.dragType=Ci.Press,this.opBudged=!1,this.dragGuides=null,this.mouseX=t,this.mouseY=e,this.clickX=t,this.clickY=e;let o=this.pickObject(t,e);this.opAtom=o>0?o:0,this.opBond=o<0?-o:0,this.opShift=i,this.opCtrl=s,this.opAlt=n;let l="";if(null!=this.toolView&&(l=this.toolView.selectedButton),l==Vi.Arrow)this.opShift||this.opCtrl||this.opAlt?this.opShift||this.opCtrl||!this.opAlt?!this.opShift&&this.opCtrl&&this.opAlt&&(this.dragType=Ci.Zoom):this.dragType=Ci.Pan:this.dragType=Ci.Press;else if(l==Vi.Rotate)this.dragType=Ci.Rotate,this.toolRotateIncr=this.opShift?0:15*S;else if(l==Vi.Pan)this.dragType=Ci.Pan;else if(l==Vi.Drag)this.dragType=Ci.Move,this.opAtom>0&&(this.dragGuides=this.determineMoveGuide()),this.delayedRedraw();else if(l==Vi.Erasor)this.dragType=Ci.Erasor,this.lassoX=[t],this.lassoY=[e],this.lassoMask=[];else if(l==Vi.RingAliph)this.dragType=Ci.Ring,this.toolRingArom=!1,this.toolRingFreeform=this.opShift;else if(l==Vi.RingArom)this.dragType=Ci.Ring,this.toolRingArom=!0,this.toolRingFreeform=this.opShift;else if(l==Vi.AtomPlus)this.dragType=Ci.Charge,this.toolChargeDelta=1;else if(l==Vi.AtomMinus)this.dragType=Ci.Charge,this.toolChargeDelta=-1;else if(l.startsWith(Vi.BondPfx)){if(this.dragType=Ci.Bond,this.toolBondOrder=1,this.toolBondType=Vt.BONDTYPE_NORMAL,l==Vi.BondOrder0?this.toolBondOrder=0:l==Vi.BondOrder2?this.toolBondOrder=2:l==Vi.BondOrder3?this.toolBondOrder=3:l==Vi.BondUnknown?this.toolBondType=Vt.BONDTYPE_UNKNOWN:l==Vi.BondInclined?this.toolBondType=Vt.BONDTYPE_INCLINED:l==Vi.BondDeclined&&(this.toolBondType=Vt.BONDTYPE_DECLINED),this.opBond>0){let[t,e]=this.mol.bondFromTo(this.opBond),i=!1;for(let s of new Ot(this.mol).getUnits()){let n=s.atoms.includes(t),o=s.atoms.includes(e);if(n&&!o||o&&!n){i=!0;break}}i&&(this.toolBondOrder=0,this.toolBondType=Vt.BONDTYPE_NORMAL)}0==this.opBond&&(this.dragGuides=this.determineDragGuide(this.toolBondOrder))}else l.startsWith(Vi.ElementPfx)&&(this.dragType=Ci.Atom,this.toolAtomSymbol=l.substring(Vi.ElementPfx.length),this.dragGuides=this.determineDragGuide(1))}interactDrag(t,e){if(!this.opBudged){let i=t-this.clickX,s=e-this.clickY;i*i+s*s>4&&(this.opBudged=!0)}if(this.dragType==Ci.Press&&0==this.opAtom&&0==this.opBond&&this.opBudged&&(this.dragType=Ci.Lasso,this.lassoX=[t],this.lassoY=[e],this.lassoMask=[]),this.dragType==Ci.Lasso||this.dragType==Ci.Erasor)this.updateLasso(t,e);else if(this.dragType==Ci.Pan){let i=t-this.mouseX,s=e-this.mouseY;0==i&&0==s||(this.offsetX+=i,this.offsetY+=s,this.layout.offsetEverything(i,s),this.metavec.transformPrimitives(i,s,1,1),this.currentPerm>=0&&null!=this.templatePerms&&this.templatePerms[this.currentPerm].metavec.transformPrimitives(i,s,1,1),this.delayedRedraw()),this.mouseX=t,this.mouseY=e}else if(this.dragType==Ci.Zoom){let i=e-this.mouseY;if(0!=i){i=Math.min(50,Math.max(-50,i));let t=this.pointScale*(1-.01*i);t=Math.min(10,Math.max(.1,t));let e=this.clickX-t/this.pointScale*(this.clickX-this.offsetX),s=this.clickY-t/this.pointScale*(this.clickY-this.offsetY);this.pointScale=t,this.offsetX=e,this.offsetY=s,this.delayedRedraw()}this.mouseX=t,this.mouseY=e}else this.dragType!=Ci.Rotate&&this.dragType!=Ci.Move&&this.dragType!=Ci.Atom&&this.dragType!=Ci.Bond&&this.dragType!=Ci.Ring||(this.mouseX=t,this.mouseY=e,this.delayedRedraw())}interactEnd(t,e){this.opBudged?this.interactEndDrag(t,e):this.interactEndClick(t,e),this.dragType=Ci.None,this.lassoX=null,this.lassoY=null,this.lassoMask=null,this.dragGuides=null,this.delayedRedraw()}interactEndClick(e,i){let s=this.pickObject(e,i),n=s>0?s:0,o=s<0?-s:0;if(this.dragType==Ci.Press)this.opShift||this.opCtrl||this.opAlt?!this.opShift||this.opCtrl||this.opAlt||n>0&&this.setSelected(n,!this.getSelected(n)):0==n&&0==o?t.anyTrue(this.selectedMask)?this.selectedMask=null:this.currentAtom>0?this.currentAtom=0:this.currentBond>0&&(this.currentBond=0):n!=this.currentAtom||o!=this.currentBond?(this.currentAtom=n,this.currentBond=o):0==n&&0==o&&this.anySelected()&&(this.selectedMask=null);else if(this.dragType==Ci.Move)0==s&&(t.anyTrue(this.selectedMask)?this.selectedMask=null:this.currentAtom>0?this.currentAtom=0:this.currentBond>0&&(this.currentBond=0));else if(this.dragType==Ci.Erasor){if(this.opAtom>0||this.opBond>0){let t=Object.assign(Object.assign({},this.getState()),{currentAtom:this.opAtom,currentBond:this.opBond,selectedMask:[]});new Be(t,Se.Delete,{},this).execute()}}else if(this.dragType==Ci.Atom){let t=this.toolAtomSymbol;if("A"==t){let t=new Fi(this.mol,this.opAtom,this.proxyClip,(()=>{let e=0==this.mol.numAtoms;0!=this.mol.compareTo(t.mol)&&this.defineMolecule(t.mol,e,!0),t.close()}));0==this.opAtom&&(t.newX=this.xToAng(this.clickX),t.newY=this.yToAng(this.clickY)),t.callbackClose=()=>{this.inDialog=!1,this.grabFocus()},this.inDialog=!0,t.open()}else if(t){let e={element:t,keepAbbrev:!0};if(0==this.opAtom){let t=this.xToAng(this.clickX),i=this.yToAng(this.clickY);0==this.mol.numAtoms&&(this.offsetX=this.clickX,this.offsetY=this.clickY,t=0,i=0),e.positionX=t,e.positionY=i}let i=Object.assign(Object.assign({},this.getState()),{currentAtom:this.opAtom,currentBond:0,selectedMask:null});new Be(i,Se.Element,e,this).execute()}}else if(this.dragType==Ci.Charge){if(this.opAtom>0||this.opBond>0){let t=Object.assign(Object.assign({},this.getState()),{currentAtom:this.opAtom,currentBond:this.opBond,selectedMask:null});new Be(t,Se.Charge,{delta:this.toolChargeDelta},this).execute()}}else if(this.dragType==Ci.Bond){let t,e=Object.assign(Object.assign({},this.getState()),{currentAtom:this.opAtom,currentBond:this.opBond,selectedMask:null});t=this.toolBondType==Vt.BONDTYPE_NORMAL?new Be(e,Se.BondOrder,{order:this.toolBondOrder},this):new Be(e,Se.BondType,{type:this.toolBondType},this),t.execute()}}interactEndDrag(t,e){if(this.dragType==Ci.Lasso){if(this.lassoX.length>=2){this.calculateLassoMask();for(let t=1;t<=this.mol.numAtoms;t++)this.getLassoed(t)&&!this.getSelected(t)&&this.setSelected(t,!0)}this.lassoX=null,this.lassoY=null,this.lassoMask=null,this.delayedRedraw()}else if(this.dragType==Ci.Erasor){let t=!1;for(let e=0;e<this.lassoMask.length;e++)if(this.lassoMask[e]){t=!0;break}if(t){let t=Object.assign(Object.assign({},this.getState()),{currentAtom:0,currentBond:0,selectedMask:this.lassoMask});new Be(t,Se.Delete,{},this).execute()}}else if(this.dragType==Ci.Rotate){let[t,e,i,s]=this.determineDragTheta(),n=-i*k,o=this.xToAng(t),l=this.yToAng(e);new Be(this.getState(),Se.Rotate,{theta:n,centreX:o,centreY:l},this).execute()}else if(this.dragType==Ci.Move){let[t,e]=this.determineMoveDelta(),i=this.pointScale;new Be(this.getState(),Se.Move,{refAtom:this.opAtom,deltaX:t/i,deltaY:-e/i},this).execute()}else if(this.dragType==Ci.Ring){let[t,e]=this.determineFauxRing();if(null!=t){let i={ringX:t,ringY:e,aromatic:this.toolRingArom};new Be(this.getState(),Se.Ring,i,this).execute()}}else if(this.dragType==Ci.Atom&&this.opAtom>0){let t=this.mouseX,e=this.mouseY,i=this.snapToGuide(t,e);null!=i&&([t,e]=i);let s={order:1,type:Vt.BONDTYPE_NORMAL,element:this.toolAtomSymbol,x1:this.mol.atomX(this.opAtom),y1:this.mol.atomY(this.opAtom),x2:this.xToAng(t),y2:this.yToAng(e)};"A"==this.toolAtomSymbol&&(s.element=window.prompt("Enter element symbol:","")),""!=s.element&&new Be(this.getState(),Se.BondAtom,s,this).execute()}else if(this.dragType==Ci.Bond){let t=this.mouseX,e=this.mouseY,i=this.snapToGuide(t,e);if(null!=i&&([t,e]=i,this.opBond>0)){let i=this.pickObject(t,e,{noAtoms:!0});if(i<0)return void this.connectPolymerBlock(this.opBond,-i)}let s={order:this.toolBondOrder,type:this.toolBondType,element:"C",x1:0==this.opAtom?this.xToAng(this.clickX):this.mol.atomX(this.opAtom),y1:0==this.opAtom?this.yToAng(this.clickY):this.mol.atomY(this.opAtom),x2:this.xToAng(t),y2:this.yToAng(e)};new Be(this.getState(),Se.BondAtom,s,this).execute()}}dropInto(t){let e=t.items,i=t.files;const s=[".el",".mol"],n=["text/plain","chemical/x-sketchel","x-mdl-molfile"];for(let t=0;t<e.length;t++)if("string"==e[t].kind&&n.indexOf(e[t].type)>=0)return void e[t].getAsString((t=>{let e=Vt.fromString(t);null!=e?this.defineMolecule(e,!0,!0,!0):console.log("Dragged data is not a SketchEl molecule: "+t)}));for(let t=0;t<i.length;t++)for(let e of s)if(i[t].name.endsWith(e)){let e=new FileReader;return e.onload=t=>{let i=e.result,s=Ut.readUnknown(i.toString());null!=s?this.defineMolecule(s,!0,!0):console.log("Dragged file is not a recognised molecule: "+i)},void e.readAsText(i[t])}}connectPolymerBlock(e,i){let[s,n]=this.mol.bondFromTo(e),[o,l]=this.mol.bondFromTo(i),r=this.getState(),a=new Ot(r.mol),h=null,u=null,m=0;for(let e of a.getUnits()){if(!h||e.atoms.length<h.atoms.length){let t=e.atoms.includes(s),i=e.atoms.includes(n);t&&!i?h=e:i&&!t&&([h,s,n]=[e,n,s])}if(!u||e.atoms.length<u.atoms.length){let t=e.atoms.includes(o),i=e.atoms.includes(l);t&&!i?u=e:i&&!t&&([u,o,l]=[e,l,o])}for(let i of e.atomName.values())m=Math.max(m,t.max(i))}if(!h||!u)return!1;let d=t.first(h.atomName.get(s));d||(d=++m,h.atomName.set(s,[d]));let c=t.first(u.atomName.get(o));c||(c=++m,u.atomName.set(o,[c])),h.bondIncl.set(e,t.append(h.bondIncl.get(e),c)),u.bondIncl.set(i,t.append(u.bondIncl.get(i),d)),a.rewriteMolecule(),this.setState(r)}}Ji.UNDO_SIZE=20;class ts extends li{constructor(t,e=null){super(e),this.mol=t,this.sketcher=new Ji,this.proxyClip=null,this.proxyMenu=null,this.callbackSave=null,this.title="Edit Compound",this.minPortionWidth=20,this.maxPortionWidth=95}onSave(t){this.callbackSave=t}getMolecule(){return this.sketcher.getMolecule()}getSketcher(){return this.sketcher}defineClipboard(t){this.proxyClip=t;let e=new oe;e.copyEvent=(t,e)=>(this.sketcher.performCopySelection(t),!0),e.pasteEvent=t=>(this.sketcher.pasteText(t.getString()),!0),t.pushHandler(e),this.sketcher.defineClipboard(t)}defineContext(t){this.proxyMenu=t,this.sketcher.defineContext(this.proxyMenu)}close(){this.proxyClip&&this.proxyClip.popHandler(),super.close()}populate(){let t=this.buttonsDOM(),e=this.bodyDOM();this.btnClear=it('<button class="wmk-button wmk-button-default">Clear</button>').appendTo(t).css({"margin-left":"0.5em"}),this.btnClear.onClick((()=>this.sketcher.clearMolecule())),this.btnCopy=it('<button class="wmk-button wmk-button-default">Copy</button>').appendTo(t).css({"margin-left":"0.5em"}),this.btnCopy.onClick((()=>this.actionCopy())),t.append(this.domClose),this.domClose.css({"margin-left":"0.5em"}),this.btnSave=it('<button class="wmk-button wmk-button-primary">Save</button>').appendTo(t).css({"margin-left":"0.5em"}),this.btnSave.onClick((()=>{this.callbackSave&&this.callbackSave(this)}));let i=it("<div/>").appendTo(e).css({width:"800px",height:"650px"});this.sketcher.setSize(800,650),this.sketcher.defineMolecule(this.mol),this.sketcher.setup((()=>this.sketcher.render(i)))}actionCopy(){this.sketcher.performCopySelection(!1)}actionCut(){this.sketcher.performCopySelection(!0)}actionPaste(){this.sketcher.performPaste()}actionUndo(){this.sketcher.performUndo()}actionRedo(){this.sketcher.performRedo()}}class es{constructor(t){this.popupBackground="white",this.obscureOpacity=.2,this.zindex=null,this.callbackClose=null,this.callbackPopulate=null,this.parent=st(t),at("popup","\n\t*.wmk-popup\n\t{\n\t\tfont-family: 'Open Sans', sans-serif;\n\t}\n")}onClose(t){this.callbackClose=t}open(){dt();let t=it(document.body),e=this.domObscureBackground=it("<div/>").appendTo(t);e.css({position:"fixed"}),e.css({left:"0",right:"0",top:"0",bottom:"0"}),e.css({"background-color":"black",opacity:this.obscureOpacity});let i=this.domObscureForeground=it("<div/>").appendTo(t);i.css({position:"fixed"}),i.css({left:"0",right:"0",top:"0",bottom:"0"}),i.onClick((()=>this.close())),this.zindex>0&&(e.setCSS("z-index",this.zindex),i.setCSS("z-index",this.zindex+1));let s=this.domPanelBoundary=it('<div class="wmk-popup"/>').appendTo(i).css({visibility:"hidden"});s.onClick((t=>t.stopPropagation())),s.css({"background-color":this.popupBackground,border:"1px solid black"}),s.css({position:"absolute",overflow:"auto"}),this.domBody=it("<div/>").appendTo(s).css({padding:"5px"}),this.populate(),this.positionAndShow()}close(){dt(),this.domPanelBoundary.remove(),this.domObscureBackground.remove(),this.domObscureForeground.remove(),this.callbackClose&&this.callbackClose(this),dt()}bump(){this.positionAndShow()}bodyDOM(){return this.domBody}populate(){this.callbackPopulate?this.callbackPopulate(this):this.bodyDOM().setText("Empty popup.")}positionAndShow(){dt();let t=window.innerWidth,e=window.innerHeight,i=this.parent.el.getBoundingClientRect(),s=i.left,n=i.top,o=i.right,l=i.bottom,r=this.domPanelBoundary,a=Math.max(s,t-o)-4;r.css({"max-width":a+"px"});let h=function(){if(H)return H;let t=it("<div/>").css({visibility:"hidden",width:"100px",height:"100px",overflow:"scroll"}).appendTo(it(document.body)),e=it("<div/>").css({width:"100%",height:"100%"}).appendTo(t);return H=new $(100-e.elHTML.offsetWidth,100-e.elHTML.offsetHeight),t.remove(),H}(),u=()=>{let i=this.domBody.width(),a=this.domBody.height(),u=0,m=0;l+2+a<e?m=l+2:n-2-a>0?m=n-2-a:e-l>n?(m=l+2,a=e-m-2):(m=2,a=n-m-2),r.height()>a&&(i+=h.w+10),s+i<t?u=s:i<o&&(u=o-i),g(r,u,m,i,a),r.css({visibility:"visible"})};setTimeout((()=>u()))}}class is extends ai{constructor(t,e){super(),this.callbackChange=e,this.lines=[];for(let e in t){let i=t[e];if("string"==typeof i)this.lines.push({key:e,value:i});else if(Array.isArray(i))for(let t of i)this.lines.push({key:e,value:t})}}render(t){super.render(t),this.divGrid=it("<div/>").appendTo(this.contentDOM).css({display:"grid",width:"100%",margin:"0"}),this.divGrid.css({"align-items":"baseline","justify-content":"start"}),this.divGrid.css({"grid-row-gap":"0.5em","grid-column-gap":"0.5em"}),this.divGrid.css({"grid-template-columns":"[start key] 1fr [value] 1fr [button] auto [end]"}),this.rebuildGrid()}rebuildGrid(){this.divGrid.empty();let t=0;for(let e=0;e<this.lines.length;e++){let i=this.lines[e];t++;let s=it("<div/>").appendTo(this.divGrid).css({"grid-area":`${t} / key`}),n=it("<div/>").appendTo(this.divGrid).css({"grid-area":`${t} / value`}),o=it("<div/>").appendTo(this.divGrid).css({"grid-area":`${t} / button`});i.inputKey=it("<input/>").appendTo(s).css({width:"100%",padding:"0",font:"inherit"}),i.inputKey.setValue(i.key),i.inputKey.onInput((()=>this.scrapeData())),i.inputValue=it("<input/>").appendTo(n).css({width:"100%",padding:"0",font:"inherit"}),i.inputValue.setValue(i.value),i.inputValue.onInput((()=>this.scrapeData()));let l=it('<button class="wmk-button wmk-button-small wmk-button-default"/>').appendTo(o);l.setText(""),l.onClick((()=>{this.lines.splice(e,1),this.rebuildGrid(),this.scrapeData()}))}t++;let e=it("<div/>").appendTo(this.divGrid).css({"grid-area":`${t} / start / ${t} / end`,"text-align":this.lines.length>0?"center":"left"}),i=it('<button class="wmk-button wmk-button-small wmk-button-default"/>').appendTo(e);i.setText(""),i.onClick((()=>{this.lines.push({key:"",value:""}),this.rebuildGrid(),this.scrapeData()}))}scrapeData(){let t={};for(let e of this.lines){if(e.key=e.inputKey.getValue(),e.value=e.inputValue.getValue(),!e.key||!e.value)continue;let i=t[e.key];i?"string"==typeof i?t[e.key]=[i,e.value]:Array.isArray(i)&&i.push(e.value):t[e.key]=e.value}this.callbackChange(t)}}class ss extends ai{constructor(t,e){if(super(),this.callbackChange=e,this.lines=[],t)for(let e of t)this.lines.push({datum:e});at("metadatawidget","\n\t*.wmk-metadataitem:hover\n\t{\n\t\tbackground-color: #C0C0FF;\n\t\tcursor: pointer;\n\t}\n")}render(t){super.render(t),this.divGrid=it("<div/>").appendTo(this.contentDOM).css({display:"grid",width:"100%",margin:"0"}),this.divGrid.css({"align-items":"baseline","justify-content":"start"}),this.divGrid.css({"grid-row-gap":"0.5em","grid-column-gap":"0.5em"}),this.divGrid.css({"grid-template-columns":"[start content] 1fr [button] auto [end]"}),this.rebuildGrid()}rebuildGrid(){this.divGrid.empty();let e=(e,i,s,n)=>{let o=it("<div/>").appendTo(e);if(o.css({padding:"0.2em","margin-right":"0.5em"}),"string"==typeof i){o.css({"background-color":0==n?"#D0D0D0":"#D0D0FF","border-radius":"3px"});let e=Qe.main.getBranch(i);t.notBlank(e)?(o.setText(e[0].label),mt(o,X(e[0].uri),null,1e3)):o.setText(i)}else{let t=it('<input type="number"/>').appendTo(o).css({width:"5em",padding:"0",font:"inherit"});null!=i&&(t.css({width:Math.max(5,i.toString().length)+"em"}),t.setValue(i.toString())),t.onInput((()=>{let e=parseFloat(t.getValue());isNaN(e)||(s.datum[n]=e)}))}},i=0;for(let s=0;s<this.lines.length;s++){let n=this.lines[s];i++;let o=it("<div/>").appendTo(this.divGrid).css({"grid-area":`${i} / content`}),l=it("<div/>").appendTo(this.divGrid).css({"grid-area":`${i} / button`});if(o.css({display:"flex","flex-wrap":"wrap","justify-content":"flex-start","align-items":"baseline"}),Array.isArray(n.datum)){for(let t=0;t<n.datum.length;t++)e(o,n.datum[t],n,t);if(n.datum.length>1){let e=it('<button class="wmk-button wmk-button-small wmk-button-default"/>').appendTo(o);e.setText(""),e.css({"margin-right":"0.5em"}),e.onClick((()=>{let e=n.datum;e.splice(e.length-1,1),"string"!=typeof t.last(e)&&e.splice(e.length-1,1),this.rebuildGrid(),this.triggerModified()}))}}else e(o,n.datum,n,0);let r=it('<button class="wmk-button wmk-button-small wmk-button-default"/>').appendTo(o);r.setText(""),r.css({"margin-right":"0.5em"}),r.onClick((()=>this.pickExtraTerm(r,n,!1)));let a=it('<button class="wmk-button wmk-button-small wmk-button-default"/>').appendTo(o);a.setText(""),a.css({"margin-right":"0.5em"}),a.onClick((()=>this.pickExtraTerm(a,n,!0)));let h=it('<button class="wmk-button wmk-button-small wmk-button-default"/>').appendTo(l);h.setText(""),h.onClick((()=>{this.lines.splice(s,1),this.rebuildGrid(),this.triggerModified()}))}i++;let s=it("<div/>").appendTo(this.divGrid).css({"grid-area":`${i} / start / ${i} / end`,"text-align":this.lines.length>0?"center":"left"}),n=it('<button class="wmk-button wmk-button-small wmk-button-default"/>').appendTo(s);n.setText(""),n.onClick((()=>this.pickNewTerm(n)))}triggerModified(){let t=this.lines.map((t=>t.datum));this.callbackChange(t)}pickNewTerm(t){let e=[];const i=["http://mixtures.io/rdf#MixtureMetadata"];for(let t of i)e.push(...Qe.main.getBranchList(t));let s=new es(t);s.callbackPopulate=()=>{this.populateBranch(s,e,(t=>{this.lines.push({datum:t.uri}),this.rebuildGrid(),this.triggerModified()}))},s.open()}pickExtraTerm(t,e,i){let s=[];const n=["http://mixtures.io/rdf#MixtureMetadata"],o=["http://purl.obolibrary.org/obo/UO_0000000"];for(let t of i?o:n)s.push(...Qe.main.getBranchList(t));let l=new es(t);l.callbackPopulate=()=>{this.populateBranch(l,s,(t=>{"string"==typeof e.datum&&(e.datum=[e.datum]),i&&e.datum.push(null),e.datum.push(t.uri),this.rebuildGrid(),this.triggerModified()}))},l.open()}populateBranch(t,e,i){let s=t.bodyDOM();for(let n of e){let e=it("<div/>").appendTo(s);n.depth>0&&(e.css({"margin-left":n.depth-.5+"em"}),it("<span></span>").appendTo(e).css({color:"#A0A0A0","margin-right":"0.5em"}));let o=it("<span/>").appendTo(e).class("wmk-metadataitem");o.setText(n.label),mt(o,X(n.uri),null,2e3),o.onClick((()=>{dt(),t.close(),i(n)}))}}}var ns;!function(t){t.Value="Value",t.Range="Range",t.Ratio="Ratio"}(ns||(ns={}));const os=["=","~","<","<=",">",">="],ls=["=","~","&lt;","&le;","&gt;","&ge;"];class rs extends li{constructor(t,e,i,s=null){super(s),this.inchi=e,this.parentSize=i,this.proxyClip=null,this.areaDescr=null,this.areaSyn=null,this.callbackSave=null,this.callbackSketch=null,this.component=Y(t),this.title="Edit Component",this.minPortionWidth=20,this.maxPortionWidth=95,at("editcomponent","\n\t*.wmk-editcomponent-input\n\t{\n\t}\n\t*.wmk-editcomponent-input::placeholder\n\t{\n\t\tfont-size: 70%;\n\t\tcolor: #D0D0D0;\n\t}\n\t*.wmk-editcomponent-units\n\t{\n\t\tcursor: pointer;\n\t}\n\t*.wmk-editcomponent-units:hover\n\t{\n\t\tbackground-color: #C0C0FF;\n\t\tcursor: pointer;\n\t}\n")}onSave(t){this.callbackSave=t}onSketch(t){this.callbackSketch=t}getComponent(){return this.component}populate(){this.proxyClip&&this.proxyClip.pushHandler(new oe);let e=this.buttonsDOM(),i=this.bodyDOM();this.callbackSketch&&(this.btnSketch=it('<button class="wmk-button wmk-button-default">Sketch</button>').appendTo(e),this.btnSketch.onClick((()=>this.invokeSketcher()))),e.appendText(" "),e.append(this.domClose),e.appendText(" "),this.btnSave=it('<button class="wmk-button wmk-button-primary">Save</button>').appendTo(e),this.btnSave.onClick((()=>this.saveAndClose())),i.css({padding:"0 0 0 1em"});let s=it("<div/>").appendTo(i);s.css({"overflow-y":"scroll",height:"100%"}),s.css({"max-height":this.parentSize[1]+"px"}),s.css({"padding-right":"18px","padding-bottom":"10px"});let n=this.fieldGrid().appendTo(s);this.createFieldName(n,1,"Name",!1),this.lineName=this.createValueLine(n,1),this.lineName.setValue(this.component.name),this.createFieldName(n,2,"Quantity",!1);let o=it("<div/>").appendTo(n);o.css({"grid-column":"value","grid-row":"2"}),this.createQuantity(o),this.createFieldName(n,3,"Description",!0),this.areaDescr=this.createValueMultiline(n,3),this.createFieldName(n,4,"Synonyms",!0),this.areaSyn=this.createValueMultiline(n,4),this.areaDescr.setValue(this.component.description),this.component.synonyms&&this.areaSyn.setValue(this.component.synonyms.join("\n"));let l=this.fieldGrid().appendTo(s),r=0;r++,this.createFieldName(l,++r,"Formula",!1);let a=this.createDiv(l,r).css({display:"flex","align-items":"center"});if(this.lineFormula=it("<input/>").appendTo(a).css({"flex-grow":"1",font:"inherit"}),this.lineFormula.setValue(this.component.formula),this.lineFormula.elInput.placeholder=this.calculateFormula(),this.lineFormula.onInput((()=>this.calculateWeight())),this.divWeight=it("<div/>").appendTo(a).css({"flex-grow":"0"}),this.calculateWeight(),this.createFieldName(l,++r,"InChI",!1),this.lineInChI=this.createValueLine(l,r),this.lineInChI.setValue(this.component.inchi),ie.isAvailable()&&this.component.molfile){let t=this.createDiv(l,++r);it('<button class="wmk-button wmk-button-default">Calculate from Structure</button>').appendTo(t).onClick((()=>{this.calculateInChI().then()}))}this.createFieldName(l,++r,"SMILES",!1),this.lineSMILES=this.createValueLine(l,r),this.lineSMILES.setValue(this.component.smiles),this.createFieldName(l,++r,"Identifiers",!0),new is(this.component.identifiers,(t=>{this.component.identifiers=t})).render(it("<div/>").appendTo(l).css({"grid-area":`${r} / value`})),this.createFieldName(l,++r,"Links",!0),new is(this.component.links,(t=>{this.component.links=t})).render(it("<div/>").appendTo(l).css({"grid-area":`${r} / value`})),Qe.main&&Qe.main.getRoots().length>0&&(this.createFieldName(l,++r,"Metadata",!0),new ss(this.component.metadata,(e=>{this.component.metadata=t.notBlank(e)?e:void 0})).render(it("<div/>").appendTo(l).css({"grid-area":`${r} / value`}))),this.lineName.grabFocus();for(let t of i.findAll("input"))t.onKeyDown((t=>this.trapEscape(t,!0)));for(let t of i.findAll("textarea"))t.onKeyDown((t=>this.trapEscape(t,!1)));for(let t of i.findAll("input,textarea"))t.elInput.spellcheck=!1}close(){this.proxyClip&&this.proxyClip.popHandler(),super.close()}saveAndClose(){let t=t=>""===t?null:t;this.component.name=t(this.lineName.getValue());let e=this.optQuantType.getSelectedValue();[this.component.ratio,this.component.quantity,this.component.error]=[null,null,null];let i=this.lineQuantVal1.getValue().trim(),s=this.lineQuantVal2.getValue().trim();e==ns.Value?(i&&(this.component.quantity=parseFloat(i)),s&&(this.component.error=parseFloat(s)),this.component.units=this.lineQuantUnits.getValue().trim()):e==ns.Range?(this.component.quantity=[parseFloat(i),parseFloat(s)],this.component.relation=null,this.component.units=this.lineQuantUnits.getValue().trim()):e==ns.Ratio&&(this.component.ratio=[parseFloat(i),parseFloat(s)],this.component.relation=null,this.component.units=null),qe.hasQuantity(this.component)||(this.component.quantity=null,this.component.error=null,this.component.ratio=null,this.component.units=null,this.component.relation=null),this.areaDescr&&(this.component.description=t(this.areaDescr.getValue())),this.component.synonyms=(()=>{let t=this.areaSyn.getValue().split("\n").filter((t=>t.length>0));return t.length>0?t:null})(),this.component.formula=t(this.lineFormula.getValue()),this.component.inchi=t(this.lineInChI.getValue()),this.component.smiles=t(this.lineSMILES.getValue()),this.callbackSave(this)}invokeSketcher(){this.saveAndClose(),this.callbackSketch(this)}fieldGrid(){let t=it("<div/>").css({display:"grid",width:"100%",margin:"1em 0 1em 0"});return t.css({"align-items":"center"}),t.css({"justify-content":"start","grid-row-gap":"0.5em"}),t.css({"grid-template-columns":"[start field] max-content [value] 1fr [end]"}),t}createFieldName(t,e,i,s){let n=it("<div/>").appendTo(t);return n.css({"grid-column":"field","grid-row":e.toString(),"align-self":s?"baseline":"center"}),s&&n.css({"padding-top":"0.2em"}),n.css({"padding-right":"0.5em","font-weight":"bold"}),n.setText(i),n}createValueLine(t,e){let i=it("<div/>").appendTo(t).css({"grid-area":`${e} / value`}),s=it("<input/>").appendTo(i);return s.css({width:"calc(100% - 4px)",padding:"0",font:"inherit"}),s}createValueMultiline(t,e){let i=it("<div/>").appendTo(t).css({"grid-area":`${e} / value`}),s=it("<textarea/>").appendTo(i);return s.attr({rows:"5"}),s.css({width:"calc(100% - 4px)",padding:"0",font:"inherit"}),s}createDiv(t,e){let i=it("<div/>").appendTo(t);return i.css({"grid-column":"value","grid-row":e.toString()}),i}trapEscape(t,e){if(27==t.keyCode)t.preventDefault(),t.stopPropagation(),this.close();else if(e&&13==t.keyCode){if(this.interpretQuantString())return;t.preventDefault(),t.stopPropagation(),this.saveAndClose()}}createQuantity(t){let e=it("<div/>").appendTo(t);e.css({display:"flex","align-items":"center"});let i=()=>it('<div style="padding-left: 0.5em;"/>').appendTo(e);this.optQuantType=new qi([ns.Value,ns.Range,ns.Ratio]),this.optQuantType.render(e),this.dropQuantRel=this.makeDropdownGroup(i(),this.component.relation,os,ls,((t,e)=>{this.component.relation=t})),this.lineQuantVal1=it("<input/>").appendTo(i()).class("wmk-editcomponent-input"),this.lineQuantVal1.attr({size:"10"}),this.lineQuantVal1.onChange((()=>this.interpretQuantString()));let s=it("<span/>").appendTo(e).css({padding:"0 0.5em 0 0.5em"});this.lineQuantVal2=it("<input/>").appendTo(i()).class("wmk-editcomponent-input"),this.lineQuantVal2.attr({size:"10"});let n=i();this.lineQuantUnits=it("<input/>").appendTo(n).class("wmk-editcomponent-input"),this.lineQuantUnits.attr({size:"10",placeholder:"units"}),this.btnQuantUnits=it('<button class="wmk-button wmk-button-small wmk-button-default"/>').appendTo(n).css({"margin-left":"0.2em"}),this.btnQuantUnits.setText(""),this.btnQuantUnits.onClick((()=>this.selectDropUnits()));let o=()=>{this.dropQuantRel.setCSS("display","block"),s.setHTML("&plusmn;"),this.lineQuantUnits.setCSS("display","inline-block"),this.btnQuantUnits.setCSS("display","inline-block")},l=()=>{this.dropQuantRel.setCSS("display","none"),s.setHTML("to"),this.lineQuantUnits.setCSS("display","inline-block"),this.btnQuantUnits.setCSS("display","inline-block")},r=()=>{this.dropQuantRel.setCSS("display","none"),s.setHTML("/"),this.lineQuantUnits.setCSS("display","none"),this.btnQuantUnits.setCSS("display","none")};if(null!=this.component.ratio){if(this.optQuantType.setSelectedValue(ns.Ratio),this.component.ratio){let[t,e]=this.component.ratio;this.lineQuantVal1.setValue(t.toString()),this.lineQuantVal2.setValue(e.toString())}r()}else if(Array.isArray(this.component.quantity)){this.optQuantType.setSelectedValue(ns.Range);let[t,e]=this.component.quantity;null!=t&&this.lineQuantVal1.setValue(t.toString()),null!=e&&this.lineQuantVal2.setValue(e.toString()),this.lineQuantUnits.setValue(this.component.units),l()}else this.optQuantType.setSelectedValue(ns.Value),null!=this.component.quantity&&this.lineQuantVal1.setValue(this.component.quantity.toString()),null!=this.component.error&&this.lineQuantVal2.setValue(this.component.error.toString()),this.lineQuantUnits.setValue(this.component.units),o();this.optQuantType.callbackSelect=t=>{0==t?o():1==t?l():2==t&&r()}}makeDropdownGroup(t,e,i,s,n){let o=it("<select/>").appendTo(t);o.css({height:"2.3em"});for(let t=0;t<i.length;t++){let n=it("<option/>").appendTo(o);n.setAttr("value",t.toString()),n.setHTML(s[t]),e!=i[t]&&e!=s[t]||n.setAttr("selected","true")}return o.onChange((()=>{let t=parseInt(o.getValue());n(i[t],s[t])})),o}selectDropUnits(){let t=new es(this.btnQuantUnits);t.callbackPopulate=()=>{let e=t.bodyDOM();for(let i of he.commonNames()){let s=it("<div/>").appendTo(e).class("wmk-editcomponent-units");s.setText(i),s.onClick((()=>{this.lineQuantUnits.setValue(i),t.close()}))}},t.open()}interpretQuantString(){let t=this.lineQuantVal1.getValue().trim(),e="";for(let i of os)t.startsWith(i)&&i.length>e.length&&(e=i);e?t=t.substring(e.length):t.startsWith("")?[e,t]=["<=",t.substring(1)]:t.startsWith("")&&([e,t]=[">=",t.substring(1)]);let i="";for(let[e,s]of Object.entries(he.NAME_TO_URI)){let n=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp(`^(.*[\\d\\s)])(${n})$`).exec(t);if(o){t=o[1],i=he.URI_TO_NAME[s];break}}let s=t=>(t.startsWith(".")&&(t="0"+t),!!/^-?[0-9]+\.?[0-9eE]*$/.test(t)&&!isNaN(parseFloat(t)));t=t.trim();let n=null,o="",l="",r=/^([0-9\-\.eE]+)-([0-9\-\.eE]+)$/.exec(t);if(r){if([n,o,l]=[ns.Range,r[1],r[2]],!s(o)||!s(l)||!i)return!1}else if(r=/^([0-9\-\.eE]+)\.\.([0-9\-\.eE]+)$/.exec(t)){if([n,o,l]=[ns.Range,r[1],r[2]],!s(o)||!s(l)||!i)return!1}else if(r=/^([0-9\-\.eE]+)\(([0-9\-\.eE]+)\)$/.exec(t)){if([n,o,l]=[ns.Value,r[1],r[2]],!s(o)||!s(l)||!i)return!1}else if(r=/^([0-9\-\.eE]+)\:([0-9\-\.eE]+)$/.exec(t)){if([n,o,l]=[ns.Ratio,r[1],r[2]],!s(o)||!s(l))return!1}else if(r=/^([0-9\-\.eE]+)\/([0-9\-\.eE]+)$/.exec(t)){if([n,o,l]=[ns.Ratio,r[1],r[2]],!s(o)||!s(l))return!1}else{if(!s(t)||!i)return!1;[n,o]=[ns.Value,t]}return this.optQuantType.setSelectedValue(n),this.dropQuantRel.setValue(Math.max(0,os.indexOf(e)).toString()),this.lineQuantVal1.setValue(o),this.lineQuantVal2.setValue(l),this.lineQuantUnits.setValue(i),this.component.units=i,!0}calculateInChI(){return t=this,e=void 0,s=function*(){if(!ie.isAvailable())return;let t=Ut.readUnknown(this.component.molfile);if(!Kt.isBlank(t))try{let{inchi:e}=yield this.inchi.generate(t);this.lineInChI.setValue(e)}catch(t){alert("InChI generation failed: "+t)}},new((i=void 0)||(i=Promise))((function(n,o){function l(t){try{a(s.next(t))}catch(t){o(t)}}function r(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(l,r)}a((s=s.apply(t,e||[])).next())}));var t,e,i,s}calculateFormula(){if(!this.component.molfile)return"";let t=Ut.readUnknown(this.component.molfile);if(Kt.isBlank(t))return"";for(let e=t.numAtoms;e>=1;e--)0==t.atomicNumber(e)&&t.deleteAtomAndBonds(e);return Kt.molecularFormula(t)}calculateWeight(){let t=0,e=this.lineFormula.getValue();for(e||(e=this.lineFormula.elInput.placeholder);e;){let i=e.match(/^([A-Z][a-z]?)(\d*)(.*?)$/);if(!i){t=0;break}let s=gt.ELEMENTS.indexOf(i[1]);if(s<=0){t=0;break}let n=1;if(i[2]&&(n=parseInt(i[2]),n<=0)){t=0;break}t+=gt.NATURAL_ATOMIC_WEIGHTS[s]*n,e=i[3]}t>0?(this.divWeight.css({"padding-left":"0.5em"}),this.divWeight.setText(t.toFixed(3)+" g/mol")):(this.divWeight.css({"padding-left":"0"}),this.divWeight.setText(""))}}const as="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound";class hs{static find(t){return e=this,i=void 0,n=function*(){return new Promise(((e,i)=>{let s=[];new hs(t,(t=>{s.push(t)}),(t=>{t?i(t):e(s)})).start()}))},new((s=void 0)||(s=Promise))((function(t,o){function l(t){try{a(n.next(t))}catch(t){o(t)}}function r(t){try{a(n.throw(t))}catch(t){o(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(l,r)}a((n=n.apply(e,i||[])).next())}));var e,i,s,n}constructor(t,e,i){this.searchText=t,this.callbackResult=e,this.callbackFinished=i,this.stopped=!1,this.cidList=[]}start(){let t=as+"/name/"+encodeURIComponent(this.searchText)+"/cids/JSON";i(692).get(t,(t=>{let e="";t.on("data",(t=>e+=t)),t.on("end",(()=>this.receivedList(e)))})).on("error",(t=>{this.stopped||this.callbackFinished(t.toString())}))}stop(){this.stopped=!0}receivedList(t){if(this.stopped)return;let e=null;try{e=JSON.parse(t)}catch(e){console.log("Received unparseable result: "+t),this.callbackFinished("Unparseable result from name query: "+e.toString())}e.IdentifierList?(this.cidList=e.IdentifierList.CID,this.fetchNext()):this.callbackFinished()}fetchNext(){if(this.stopped)return;if(0==this.cidList.length)return void this.callbackFinished();let t=this.cidList.shift(),e=as+"/cid/"+t+"/SDF";i(692).get(e,(t=>{let e="";t.on("data",(t=>e+=t)),t.on("end",(()=>this.receivedCompound(e)))})).on("error",(t=>{this.stopped||this.callbackFinished(t.toString())}))}receivedCompound(t){if(this.stopped)return;let e=new Ft(t).parse();for(let t=0;t<e.numRows;t++)this.unpackCompound(e,t);this.fetchNext()}unpackCompound(t,e){let i={mol:t.getMolecule(e,"Molecule"),names:[],formula:t.getString(e,"PUBCHEM_MOLECULAR_FORMULA"),inchi:t.getString(e,"PUBCHEM_IUPAC_INCHI"),inchiKey:t.getString(e,"PUBCHEM_IUPAC_INCHIKEY")};i.mol&&(Kt.stripHydrogens(i.mol),Wt.normaliseBondDistances(i.mol));const s=["PUBCHEM_IUPAC_TRADITIONAL_NAME","PUBCHEM_IUPAC_SYSTEMATIC_NAME","PUBCHEM_IUPAC_OPENEYE_NAME","PUBCHEM_IUPAC_CAS_NAME","PUBCHEM_IUPAC_NAME"];for(let n of s){let s=t.getString(e,n);if(s&&"string"==typeof s)for(let t of s.split("\n"))t&&i.names.indexOf(t)<0&&i.names.push(t)}this.callbackResult(i)}}class us extends li{constructor(t,e){super(),this.searchText=t,this.parentSize=e,this.pubchem=null,this.resultList=[],this.nameSelected=-1,this.nameList=[],this.nameDOM=[],this.molSelected=-1,this.molList=[],this.molDOM=[],this.callbackSelect=null,rt("mixtures-lookupcompound")||at("mixtures-lookupcompound",this.composeCSS()),this.title="Lookup Compound",this.minPortionWidth=95,this.maxPortionWidth=95,this.maximumHeight=e[1]}onSelect(t){this.callbackSelect=t}populate(){let t=this.buttonsDOM(),e=this.bodyDOM();this.spanStatus=it("<span/>").appendTo(t),t.appendText(" "),t.append(this.domClose),t.appendText(" "),this.btnSearch=it('<button class="wmk-button wmk-button-primary">Search</button>').appendTo(t),this.btnSearch.onClick((()=>this.runSearch())),t.appendText(" "),this.btnApply=it('<button class="wmk-button wmk-button-default">Apply</button>').appendTo(t),this.btnApply.onClick((()=>this.applyResult())),this.btnApply.elInput.disabled=!0,e.css({padding:"0 0 0 0.5em"}),this.vertical=it("<div/>").appendTo(e),this.vertical.css({"overflow-y":"scroll",height:"100%"}),this.vertical.css({"max-height":this.parentSize[1]-200+"px"}),this.vertical.css({"padding-right":"18px","padding-bottom":"10px"}),this.populateSearchEntry(),this.resultArea=it("<div/>").appendTo(this.vertical),this.searchText&&this.runSearch()}close(){this.pubchem&&this.pubchem.stop(),super.close()}getName(){return this.nameSelected<0?null:this.nameList[this.nameSelected]}getMolecule(){return this.molSelected<0?null:this.molList[this.molSelected]}populateSearchEntry(){let t=it("<div/>").appendTo(this.vertical).css({display:"grid"});t.css({width:"100%",margin:"0.5em 0 0.5em 0"}),t.css({"align-items":"center","justify-content":"start","grid-row-gap":"0.5em"}),t.css({"grid-template-columns":"[start field] max-content [value] 1fr [end]"}),it("<div/>").appendTo(t).css({"grid-column":"field","grid-row":"1","padding-right":"0.5em"}).setText("Name:");let e=it("<div/>").appendTo(t).css({"grid-column":"value","grid-row":"1"});this.searchInput=it("<input/>").appendTo(e).css({width:"100%",font:"inherit"}),this.searchInput.setValue(this.searchText),this.searchInput.onKeyDown((t=>this.trapKeys(t))),this.searchInput.grabFocus()}runSearch(){this.pubchem&&this.pubchem.stop(),this.resultArea.empty(),this.resultList=[],this.spanStatus.setText("Searching...");let t=this.searchInput.getValue();t&&(this.pubchem=new hs(t,(t=>this.gotResult(t)),(t=>this.finishedSearch(t))),this.pubchem.start())}applyResult(){this.callbackSelect(this),this.close()}gotResult(t){this.resultList.push(t);let e=it("<div/>").appendTo(this.resultArea).css({display:"grid"});e.css({width:"100%",margin:"0.5em 0 0.5em 0","align-items":"top","justify-content":"start"}),e.css({"grid-row-gap":"0.5em"}),e.css({"grid-template-columns":"[start molecule] max-content [names] 1fr [end]"});let i=it("<div/>").appendTo(e).css({"grid-column":"molecule","grid-row":"1","padding-right":"0.5em"});if(t.mol){let e=_e.defaultColourOnWhite(),s=new Ue(0,0,e.data.pointScale),n=new He(t.mol,s,e);n.arrange(),n.squeezeInto(0,0,300,300);let o=new si;new ni(n,o).draw(),o.normalise();let l=it(o.createSVG()).appendTo(i).css({display:"inline-block"});l.addClass("mixtures-lookupcompound-unselected");const r=this.molList.length;l.onClick((()=>this.selectMolecule(r))),this.molList.push(t.mol),this.molDOM.push(l)}else i.setText("(no structure)");let s=it("<div/>").appendTo(e).css({"grid-column":"names","grid-row":"1","padding-right":"0.5em"});if(0==t.names.length)s.setText("(no names)");else for(let e of t.names){let t=it("<div/>").appendTo(s),i=it("<span/>").appendTo(t);i.addClass("mixtures-lookupcompound-unselected"),i.setText(e);const n=this.nameList.length;t.onClick((()=>this.selectName(n))),this.nameList.push(e),this.nameDOM.push(i)}}finishedSearch(t){this.spanStatus.setText(""),t?alert("Search failed: "+t):0==this.resultList.length&&(this.resultArea.empty(),this.resultArea.setText("Nothing found."))}trapKeys(t){27==t.keyCode?(t.preventDefault(),this.close()):13==t.keyCode&&(t.preventDefault(),this.runSearch())}selectName(t){let e=this.nameSelected;e==t&&(t=-1),e>=0&&this.nameDOM[e].removeClass("mixtures-lookupcompound-selected"),t>=0&&this.nameDOM[t].addClass("mixtures-lookupcompound-selected"),this.nameSelected=t,this.btnApply.elInput.disabled=this.nameSelected<0&&this.molSelected<0}selectMolecule(t){let e=this.molSelected;e==t&&(t=-1),e>=0&&this.molDOM[e].removeClass("mixtures-lookupcompound-selected"),t>=0&&this.molDOM[t].addClass("mixtures-lookupcompound-selected"),this.molSelected=t,this.btnApply.elInput.disabled=this.nameSelected<0&&this.molSelected<0}composeCSS(){return"\n\t\t\t.mixtures-lookupcompound-unselected\n\t\t\t{\n\t\t\t\tcursor: pointer;\n\t\t\t\tbackground-color: transparent;\n\t\t\t\tborder: 1px solid transparent;\n\t\t\t\tpadding: 3px;\n\t\t\t\tborder-radius: 4px;\n\t\t\t}\n\t\t\t.mixtures-lookupcompound-selected\n\t\t\t{\n\t\t\t\tcursor: default;\n\t\t\t\tbackground-color: #E0E0E0;\n\t\t\t\tborder: 1px solid #808080;\n\t\t\t}\n\t\t"}}class ms{constructor(t){this.text=t}extract(){let e=new zt(this.text);try{e.parse()}catch(t){return null}if(!e.mol)return null;let i={mol:e.mol};if(e.groupAttachAny.size>0&&(i.attachAny=e.groupAttachAny),e.groupStereoRacemic.length>0&&(i.stereoRacemic=e.groupStereoRacemic),e.groupStereoRelative.length>0&&(i.stereoRelative=e.groupStereoRelative),e.groupLinkNodes.length>0&&(i.linkNodes=e.groupLinkNodes),e.groupMixtures.length>0&&(i.mixtures=e.groupMixtures),!(i.attachAny||i.stereoRacemic||i.stereoRelative||i.linkNodes||i.mixtures))return null;let s=[i];for(let t=0;t<s.length;){let e=s[t],i=this.enumerateAttachAny(e);if(i||(i=this.enumerateStereoRacemic(e)),i||(i=this.enumerateStereoRelative(e)),i||(i=this.enumerateLinkNodes(e)),i||(i=this.enumerateMixtures(e)),i){s[t]=i[0];for(let e=1;e<i.length;e++)s.splice(t+e,0,i[e])}else t++;if(s.length>100)break}if(0==s.length)return null;if(1==s.length&&t.isBlank(s[0].children))return null;let n=(t,e)=>{let i={};if(e.mol&&(i.molfile=new Yt(e.mol).write()),t.contents.push(i),e.children){i.contents=[];for(let t of e.children)n(i,t)}},o={contents:[]};e.molName&&(o.name=e.molName);for(let t of s)n(o,t);return o}enumerateAttachAny(e){if(!e.attachAny)return null;let i=null;for(let t of e.attachAny.keys()){i=t;break}if(null==i)return null;let s=e.attachAny.get(i);if(e.attachAny.delete(i),t.isBlank(s))return null;let n=e.mol,o=n.bondFrom(i),l=n.bondTo(i);"*"==n.atomElement(l)||("*"==n.atomElement(o)||n.atomAdjCount(o)<n.atomAdjCount(l))&&([o,l]=[l,o]);for(let t of e.attachAny.keys())this.removeAtom(e.attachAny.get(t),l);if(e.stereoRelative)for(let t of e.stereoRelative)this.removeAtom(t,l);if(e.stereoRacemic)for(let t of e.stereoRacemic)this.removeAtom(t,l);if(e.linkNodes)for(let t=e.linkNodes.length-1;t>=0;t--)e.linkNodes[t].atom!=l?(e.linkNodes[t].atom>l&&e.linkNodes[t].atom--,this.removeAtom(e.linkNodes[t].nbrs,l)):e.linkNodes.splice(t,1);if(e.mixtures)for(let t of e.mixtures)this.removeAtom(t.atoms,l);let r=[];for(let t of s){let s=n.clone();l==s.bondFrom(i)?s.setBondFrom(i,t):s.setBondTo(i,t),s.deleteAtomAndBonds(l),r.push(this.protoClone(e,s))}return r}enumerateStereoRacemic(e){if(t.isBlank(e.stereoRacemic))return null;let i=e.stereoRacemic.shift(),s=e.mol,n=new Set;for(let t of i)n.add(t);let o=[];for(let t=1;t<=s.numBonds;t++)if(n.has(s.bondFrom(t))||n.has(s.bondTo(t))){let e=s.bondType(t);e!=Vt.BONDTYPE_INCLINED&&e!=Vt.BONDTYPE_DECLINED||o.push(t)}let l=Math.min(256,1<<o.length),r=[this.protoClone(e,s)];for(let t=1;t<l;t++){let i=s.clone();for(let e=0,s=1;e<o.length;e++){if(t&s){let t=i.bondType(o[e]);t=t==Vt.BONDTYPE_INCLINED?Vt.BONDTYPE_DECLINED:Vt.BONDTYPE_INCLINED,i.setBondType(o[e],t)}s<<=1}r.push(this.protoClone(e,i))}return r}enumerateStereoRelative(e){if(t.isBlank(e.stereoRelative))return null;let i=e.stereoRelative.shift(),s=new Set;for(let t of i)s.add(t);let n=e.mol.clone();for(let t=1;t<=n.numBonds;t++)if(s.has(n.bondFrom(t))||s.has(n.bondTo(t))){let e=n.bondType(t);e==Vt.BONDTYPE_INCLINED?n.setBondType(t,Vt.BONDTYPE_DECLINED):e==Vt.BONDTYPE_DECLINED&&n.setBondType(t,Vt.BONDTYPE_INCLINED)}return[e,this.protoClone(e,n)]}enumerateLinkNodes(e){if(t.isBlank(e.linkNodes))return null;let i=e.linkNodes.shift(),s=e.mol,n=i.atom,o=i.nbrs.length>=1?i.nbrs[0]:0,l=[];for(let t=i.minRep;t<=i.maxRep;t++){if(1==t){l.push(this.protoClone(e,s));continue}let i=s.clone(),r=[];for(let e=2;e<=t;e++){let t=i.addAtom(i.atomElement(n),i.atomX(n),i.atomY(n));if(i.setAtomCharge(t,i.atomCharge(n)),i.setAtomUnpaired(t,i.atomUnpaired(t)),i.addBond(n,t,1),o>0){let e=0;for(let s of i.atomAdjList(n))if(s!=t&&s!=o){e=s;break}if(e>0){let s=i.findBond(n,e);i.bondFrom(s)==n?i.setBondFrom(s,t):i.setBondTo(s,t)}}r.push(n)}let a=this.protoClone(e,i);if(a.mixtures)for(let t of a.mixtures)t.atoms.includes(n)&&t.atoms.push(...r);l.push(a)}return l}enumerateMixtures(e){if(t.isBlank(e.mixtures))return null;let i=e.mol,s=e.mixtures,n=s.map((t=>t.index)),o=t.booleanArray(!0,s.length);for(let t of s)if(t.parent>0){let e=n.indexOf(t.parent);e>=0&&(o[e]=!1)}let l={children:[]},r=new Map;for(r.set(0,l);;){let t=!1;for(let e=0;e<s.length;e++)if(!o[e]&&!r.has(s[e].index)){let i=r.get(s[e].parent);if(!i)continue;let n={children:[]};i.children.push(n),r.set(s[e].index,n),t=!0}if(!t)break}let a=t.booleanArray(!0,i.numAtoms);for(let t of s)for(let e of t.atoms)a[e-1]=!1;for(let t=0;t<s.length;t++)if(o[t]){let e=a.slice(0);for(let i of s[t].atoms)e[i-1]=!0;let n={mol:Kt.subgraphMask(i,e)};r.get(s[t].parent).children.push(n)}return 1==l.children.length&&(l=l.children[0]),l.children}protoClone(t,e){return{mol:e,children:[],attachAny:t.attachAny?new Map(t.attachAny):null,stereoRacemic:Y(t.stereoRacemic),stereoRelative:Y(t.stereoRelative),linkNodes:Y(t.linkNodes),mixtures:Y(t.mixtures)}}removeAtom(t,e){for(let i=t.length-1;i>=0;i--)t[i]==e?t.splice(i,1):t[i]>e&&t[i]--}}var ds;!function(t){t[t.None=0]="None",t[t.Any=1]="Any",t[t.Pan=2]="Pan"}(ds||(ds={}));class cs extends ai{constructor(t,e,i){super(),this.inchi=t,this.proxyClip=e,this.proxyMenu=i,this.callbackUpdateTitle=null,this.callbackInteraction=null,this.monochrome=!1,this.mixture=new qe,this.policy=null,this.undoStack=[],this.redoStack=[],this.offsetX=0,this.offsetY=0,this.pointScale=25,this.filthy=!0,this.dirty=!1,this.layout=null,this.collapsedBranches=[],this.hoverIndex=-1,this.activeIndex=-1,this.selectedIndex=0,this.delayedSelect=null,this.dragReason=ds.None,this.dragIndex=-1,this.dragX=0,this.dragY=0,this.isEditing=!1,this.dlgCompound=null,this.structureIntegrity={}}render(t){super.render(t);let e=this.contentDOM;e.css({width:"100%",height:"100%"}),e.css({"background-color":"#F0F0F0"}),e.css({position:"relative","outline-width":"0"});let i="position: absolute; left: 0; top: 0; pointer-events: none;";this.canvasMixture=a(e,"canvas",{style:i}),this.canvasOver=a(e,"canvas",{style:i}),e.onClick((t=>this.mouseClick(t))),e.onDblClick((t=>this.mouseDoubleClick(t))),e.onMouseDown((t=>this.mouseDown(t))),e.onMouseUp((t=>this.mouseUp(t))),e.onMouseOver((t=>this.mouseOver(t))),e.onMouseLeave((t=>this.mouseOut(t))),e.onMouseMove((t=>this.mouseMove(t))),e.onKeyPress((t=>this.keyPressed(t))),e.onKeyDown((t=>this.keyDown(t))),e.onKeyUp((t=>this.keyUp(t))),e.onContextMenu((t=>this.contextMenu(t))),e.attr({id:"mixtureEditor_main",tabindex:"0"}),this.refocus(),this.redraw(!0,!1)}isReceivingCommands(){return!this.isEditing}setEditing(t){this.isEditing=t}compoundEditor(){return this.dlgCompound}addStructureIntegrityKey(t,e){this.structureIntegrity[t]=e}getMixture(){return this.mixture}setMixture(t,e=!1,i=!0){null==this.delayedSelect&&this.selectedIndex>=0&&null!=this.layout&&(this.delayedSelect=this.layout.components[this.selectedIndex].origin),i&&this.stashUndo(),this.mixture=t,this.offsetX=0,this.offsetY=0,this.pointScale=this.policy.data.pointScale,this.filthy=!0,this.layout=null,this.hoverIndex=-1,this.activeIndex=-1,this.selectedIndex=-1,this.redraw(!0),this.dirty=!0,this.callbackUpdateTitle&&this.callbackUpdateTitle()}getSelected(){if(this.selectedIndex<0||null==this.layout)return[null,null];let t=this.layout.components[this.selectedIndex];return[t.origin,t.content]}getCollapsedBranches(){return this.collapsedBranches}clearHistory(){this.undoStack=[],this.redoStack=[]}stashUndo(){for(this.undoStack.push(this.mixture.clone());this.undoStack.length>10;)this.undoStack.splice(0,1);this.redoStack=[]}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}performUndo(){0!=this.undoStack.length&&(this.redoStack.push(this.mixture.clone()),this.setMixture(this.undoStack.pop(),!1,!1))}performRedo(){0!=this.redoStack.length&&(this.undoStack.push(this.mixture.clone()),this.setMixture(this.redoStack.pop(),!1,!1))}isDirty(){return this.dirty}setDirty(t){this.dirty=t}isBlank(){return this.mixture.isEmpty()}delayedRedraw(){this.filthy=!0,window.setTimeout((()=>{this.filthy&&this.redraw()}),10)}zoom(t){this.pointScale*=t,this.layout=null,this.redraw()}zoomFull(){this.layout=null,this.pointScale=25,this.redraw(!0,!0)}zoomNormal(){this.layout=null,this.pointScale=25,this.redraw(!0,!1)}selectComponent(t){this.selectedIndex!=t&&(this.selectedIndex=t,this.activeIndex=-1,this.delayedRedraw())}selectOrigin(e){let i=this.layout.components;for(let s=0;s<i.length;s++)if(t.equals(i[s].origin,e))return void this.selectComponent(s)}editStructure(){if(this.selectedIndex<0)return;let t=this.layout.components[this.selectedIndex].origin,e=this.mixture.getComponent(t),i=e.molfile?Ut.readUnknown(e.molfile):null;this.dlgCompound=new ts(i||new Vt,this.contentDOM),this.dlgCompound.onSave((()=>{let i=this.dlgCompound.getMolecule();e=Y(e),this.checkStructureIntegrity(e,i);let s=Ut.writeMDLMOL(i);s||(s=null),e.molfile=s;let n=this.mixture.clone();n.setComponent(t,e)&&(this.setMixture(n),this.selectOrigin(t)),this.dlgCompound.close()})),this.dlgCompound.onClose((()=>{this.isEditing=!1,this.dlgCompound=null,this.refocus()})),this.dlgCompound.defineClipboard(this.proxyClip),this.dlgCompound.defineContext(this.proxyMenu),this.isEditing=!0,this.dlgCompound.open()}editDetails(){if(this.selectedIndex<0)return;let t=this.layout.components[this.selectedIndex].origin,e=this.mixture.getComponent(t),i=.8*window.innerWidth,s=.8*window.innerHeight,n=new rs(Y(e),this.inchi,[i,s],this.contentDOM);n.proxyClip=this.proxyClip,n.onSave((()=>{let e=this.mixture.clone();e.setComponent(t,n.getComponent())&&(this.setMixture(e),this.selectOrigin(t)),n.close()})),n.onSketch((()=>{this.selectOrigin(t),this.editStructure()})),n.onClose((()=>{this.isEditing=!1,this.refocus()})),this.isEditing=!0,n.open()}lookupCurrent(){if(this.selectedIndex<0)return;let t=this.layout.components[this.selectedIndex].origin,e=this.mixture.getComponent(t),i=this.contentDOM.width(),s=this.contentDOM.height(),n=new us(e.name,[i,s]);n.onSelect((()=>{let i=this.mixture.clone();e=Y(i.getComponent(t));let s=n.getName(),o=n.getMolecule();null!=s&&(e.name=s),null!=o&&(e.molfile=new Yt(o).write()),i.setComponent(t,e)&&(this.setMixture(i),this.selectOrigin(t)),n.close()})),n.onClose((()=>{this.isEditing=!1,this.refocus()})),n.open()}deleteCurrent(){if(this.selectedIndex<0)return;let e=this.layout.components[this.selectedIndex].origin;if(0==e.length)return;let i=this.mixture.clone();i.deleteComponent(e),this.delayedSelect=null,this.setMixture(i),e=e.slice(0),i.getComponent(e)||(t.last(e)>0?e[e.length-1]--:e.pop()),this.selectOrigin(e)}appendToCurrent(){if(this.selectedIndex<0)return;let e=this.layout.components[this.selectedIndex].origin,i=this.mixture.clone(),s=i.getComponent(e);s.contents||(s.contents=[]),s.contents.push({}),this.delayedSelect=t.concat(e,[s.contents.length-1]),this.setMixture(i)}prependBeforeCurrent(){if(this.selectedIndex<0)return;let t=this.layout.components[this.selectedIndex].origin,e=this.mixture.clone();e.prependBefore(t,{}),this.delayedSelect=t,this.setMixture(e)}insertBeforeCurrent(){if(this.selectedIndex<0)return;let e=this.layout.components[this.selectedIndex].origin;if(t.isBlank(e))return;let i=this.mixture.clone(),s=e.pop();i.getComponent(e).contents.splice(s,0,{}),e.push(s),this.delayedSelect=e,this.setMixture(i)}insertAfterCurrent(){if(this.selectedIndex<0)return;let e=this.layout.components[this.selectedIndex].origin;if(t.isBlank(e))return;let i=this.mixture.clone(),s=e.pop();i.getComponent(e).contents.splice(s+1,0,{}),e.push(s+1),this.delayedSelect=e,this.setMixture(i)}reorderCurrent(e){if(this.selectedIndex<0)return;let i=this.layout.components[this.selectedIndex].origin;if(0==i.length)return;let s=this.mixture.clone(),[n,o]=qe.splitOrigin(i),l=s.getComponent(n);o+e<0||o+e>=l.contents.length||(t.swap(l.contents,o,o+e),this.delayedSelect=t.concat(n,[o+e]),this.setMixture(s))}clipboardCopy(t,e=!1){if(this.selectedIndex<0)return;let i=this.layout.components[this.selectedIndex].origin,s=Y(this.mixture.getComponent(i));delete s.mixfileVersion,e||(s.contents=[]);let n=qe.serialiseComponent(s);this.proxyClip.setString(n),i.length>0&&t&&this.deleteCurrent()}clipboardPaste(){let e=this.proxyClip.getString(),i=null;try{i=JSON.parse(e)}catch(t){}let s=[];if(this.selectedIndex>=0&&(s=this.layout.components[this.selectedIndex].origin),i||(i=new ms(e).extract()),!i){let t=Ut.readUnknown(e);if(Kt.notBlank(t)){let e=this.mixture.clone(),i=e.getComponent(s);i&&(i.molfile=new Yt(t).write(),this.setMixture(e))}else alert("Clipboard does not contain a mixture component.");return}if(!i.name&&!i.molfile&&!i.quantity&&t.isBlank(i.contents))return void alert("Clipboard content is either not a component, or has no interesting content.");if(this.selectedIndex<0&&this.mixture.isEmpty()){let t=new qe(i);return this.delayedSelect=[],void this.setMixture(t)}let n=this.mixture.clone(),o=n.getComponent(s);qe.isComponentEmpty(o)?(Object.keys(o).forEach((t=>delete o[t])),Object.keys(i).forEach((t=>o[t]=i[t])),this.delayedSelect=s):(o.contents||(o.contents=[]),o.contents.push(i),this.delayedSelect=t.concat(s,[o.contents.length-1])),this.setMixture(n)}refocus(){this.contentDOM.grabFocus()}getComponentPosition(e){for(let i of this.layout.components)if(t.equals(e,i.origin)){let t=i.boundary.clone();return t.x+=this.offsetX,t.y+=this.offsetY,t}return null}redraw(e=!1,i=!1){this.filthy=!1;let s=this.contentDOM.width(),n=this.contentDOM.height(),o=F();for(let t of[this.canvasMixture,this.canvasOver])t.width=s*o,t.height=n*o,t.style.width=s+"px",t.style.height=n+"px";if(!this.layout){let t=new Ue(0,0,this.pointScale);this.policy=this.monochrome?_e.defaultBlackOnWhite(this.pointScale):_e.defaultColourOnWhite(this.pointScale),this.layout=new ei(this.mixture,t,this.policy),this.layout.showCollapsors=!0,this.layout.collapsedBranches=this.collapsedBranches,this.layout.packBranches=new $(.8*this.contentDOM.width(),.8*this.contentDOM.height()),this.layout.norm=new Ne(this.mixture),this.layout.norm.analyse(),this.layout.arrange(),e&&this.scaleToFit(i)}if(this.delayedSelect){for(let e=0;e<this.layout.components.length;e++)if(t.equals(this.delayedSelect,this.layout.components[e].origin)){this.selectedIndex=e,this.ensureComponentVisible(e);break}this.delayedSelect=null}let l=new si,r=new oi(this.layout,l);r.hoverIndex=this.hoverIndex,r.activeIndex=this.activeIndex,r.selectedIndex=this.selectedIndex,r.draw(),l.offsetX=this.offsetX,l.offsetY=this.offsetY,l.setSize(s,n),l.renderCanvas(this.canvasMixture,!0)}scaleToFit(t){let e=this.contentDOM.width(),i=this.contentDOM.height();if(t){if(this.layout.width>e-4||this.layout.height>i-4){let t=Math.min((e-4)/this.layout.width,(i-4)/this.layout.height);this.pointScale*=t,this.layout.scaleComponents(t)}this.offsetX=.5*(e-this.layout.width),this.offsetY=.5*(i-this.layout.height)}else this.offsetX=Math.max(4,.5*(e-this.layout.width)),this.offsetY=.5*(i-this.layout.height)}ensureComponentVisible(t){let e=this.contentDOM.width(),i=this.contentDOM.height(),s=this.layout.components[t].boundary.withOffsetBy(this.offsetX,this.offsetY);s.minX()<4?this.offsetX-=s.minX()-4:s.maxX()>e-4&&(this.offsetX+=e-4-s.maxX()),s.minY()<4?this.offsetY-=s.minY()-4:s.maxY()>i-4&&(this.offsetY+=i-4-s.maxY())}updateHoverCursor(t){let[e,i]=f(t,this.contentDOM),s=this.activeIndex>=0?-1:this.pickComponent(e,i);s!=this.hoverIndex&&(this.hoverIndex=s,this.delayedRedraw())}pickComponent(t,e){let i=this.pickComponentSection(t,e);return null==i||i[1]?-1:i[0]}pickComponentSection(t,e){if(!this.layout)return null;for(let i=0;i<this.layout.components.length;i++){let s=this.layout.components[i],n=t-this.offsetX-s.boundary.x,o=e-this.offsetY-s.boundary.y;if(s.outline.contains(n,o))return[i,!1];if(s.collapseBox&&s.collapseBox.contains(n,o))return[i,!0]}return null}navigateDirection(e){let i=-1;if(this.selectedIndex<0)i=0;else{let s=this.layout.components[this.selectedIndex].origin.slice(0);if("tab"==e)if(t.isBlank(s)){let i=this.mixture.getComponent(s);if(t.isBlank(i.contents))return this.delayedSelect=[0],void this.appendToCurrent();e="right"}else{let i=this.mixture.getComponent(s.slice(0,s.length-1));if(t.last(s)==i.contents.length-1)return void this.insertAfterCurrent();e="down"}if("left"==e){if(0==s.length)return;s.pop(),i=this.layout.findComponent(s)}else if("right"==e)s.push(0),i=this.layout.findComponent(s);else if("up"==e){if(0==s.length||0==s[s.length-1])return;s[s.length-1]--,i=this.layout.findComponent(s)}else if("down"==e){if(0==s.length)return;s[s.length-1]++,i=this.layout.findComponent(s)}}i>=0&&i<this.layout.components.length&&(this.delayedSelect=this.layout.components[i].origin,this.delayedRedraw())}toggleCollapsed(e){let i=this.layout.components[e].origin,s=!1;for(let e=0;e<this.collapsedBranches.length;e++)if(t.equals(i,this.collapsedBranches[e])){this.collapsedBranches.splice(e,1),s=!0;break}s||this.collapsedBranches.push(i),this.layout=null,this.redraw()}mouseClick(t){if(this.isEditing)return;if(t.ctrlKey)return void t.preventDefault();let[e,i]=f(t,this.contentDOM),s=this.pickComponentSection(e,i);s&&s[1]&&this.toggleCollapsed(s[0])}mouseDoubleClick(t){if(this.isEditing)return;t.stopImmediatePropagation();let[e,i]=f(t,this.contentDOM),s=this.pickComponent(e,i);s>=0&&(this.hoverIndex=-1,this.activeIndex=-1,this.selectedIndex=s,this.delayedRedraw(),this.editDetails())}mouseDown(t){if(this.isEditing)return;if(this.callbackInteraction&&this.callbackInteraction(),1!=t.which)return;if(t.ctrlKey)return void t.preventDefault();let[e,i]=f(t,this.contentDOM),s=this.pickComponent(e,i);this.dragReason=ds.Any,this.dragIndex=s,this.dragX=e,this.dragY=i,s!=this.activeIndex&&(this.activeIndex=s,this.delayedRedraw())}mouseUp(t){if(!this.isEditing)if(t.ctrlKey)t.preventDefault();else{if(this.dragReason!=ds.Pan){let[e,i]=f(t,this.contentDOM),s=this.pickComponent(e,i);s==this.activeIndex&&(this.selectedIndex=s),this.activeIndex=-1,this.delayedRedraw()}this.dragReason=ds.None}}mouseOver(t){this.isEditing||this.updateHoverCursor(t)}mouseOut(t){this.isEditing||(this.updateHoverCursor(t),this.dragReason=ds.None)}mouseMove(t){if(!this.isEditing&&(this.updateHoverCursor(t),this.dragReason==ds.Any&&this.dragIndex<0&&(this.dragReason=ds.Pan),this.dragReason==ds.Pan)){let[e,i]=f(t,this.contentDOM),s=e-this.dragX,n=i-this.dragY;0!=s&&0!=n&&(this.offsetX+=s,this.offsetY+=n,this.delayedRedraw(),[this.dragX,this.dragY]=[e,i])}}keyPressed(t){}keyDown(t){if(this.isEditing)return;if(this.callbackInteraction&&this.callbackInteraction(),!this.isReceivingCommands())return;let e=t.key;if(!(t.shiftKey||t.ctrlKey||t.altKey||t.metaKey)){if("Enter"==e)this.selectedIndex>=0&&this.editDetails();else if("Escape"==e);else if("ArrowLeft"==e)this.navigateDirection("left");else if("ArrowRight"==e)this.navigateDirection("right");else if("ArrowUp"==e)this.navigateDirection("up");else if("ArrowDown"==e)this.navigateDirection("down");else{if("Tab"!=e)return;this.navigateDirection("tab")}t.preventDefault(),t.stopPropagation()}}keyUp(t){}mouseWheel(t){this.callbackInteraction&&this.callbackInteraction();let[e,i]=f(t,this.contentDOM),s=Math.abs(t.deltaX)>Math.abs(t.deltaY)?t.deltaX:t.deltaY,n=1+.05*Math.abs(s);s<0&&(n=1/n);let o=this.pointScale*n;this.offsetX=e-o/this.pointScale*(e-this.offsetX),this.offsetY=i-o/this.pointScale*(i-this.offsetY),this.pointScale=o,this.layout=null,this.delayedRedraw(),t.preventDefault()}contextMenu(e){if(this.callbackInteraction&&this.callbackInteraction(),e.preventDefault(),!this.isReceivingCommands())return;let[i,s]=f(e,this.contentDOM),n=this.pickComponent(i,s);this.selectedIndex=n,this.activeIndex=-1,this.delayedRedraw();let o=new Zt.Menu;if(n>=0){let e=this.layout.components[n].content,i=this.layout.components[n].origin,s=()=>this.selectComponent(n);if(o.append(new Zt.MenuItem({label:"Edit Structure",click:()=>{s(),this.editStructure()}})),o.append(new Zt.MenuItem({label:"Edit Details",click:()=>{s(),this.editDetails()}})),o.append(new Zt.MenuItem({label:"Lookup Name",click:()=>{s(),this.lookupCurrent()}})),o.append(new Zt.MenuItem({label:"Append",click:()=>{s(),this.appendToCurrent()}})),o.append(new Zt.MenuItem({label:"Prepend",click:()=>{s(),this.prependBeforeCurrent()}})),i.length>0&&(o.append(new Zt.MenuItem({label:"Insert Before",click:()=>{s(),this.insertBeforeCurrent()}})),o.append(new Zt.MenuItem({label:"Insert After",click:()=>{s(),this.insertAfterCurrent()}})),o.append(new Zt.MenuItem({label:"Delete",click:()=>{this.selectComponent(n),this.deleteCurrent()}})),i[i.length-1]>0&&o.append(new Zt.MenuItem({label:"Move Up",click:()=>{s(),this.reorderCurrent(-1)}})),i[i.length-1]<t.arrayLength(this.mixture.getParentComponent(i).contents)-1&&o.append(new Zt.MenuItem({label:"Move Down",click:()=>{s(),this.reorderCurrent(1)}}))),o.append(new Zt.MenuItem({label:"Copy",click:()=>{s(),this.clipboardCopy(!1)}})),t.arrayLength(e.contents)>0&&o.append(new Zt.MenuItem({label:"Copy Branch",click:()=>{s(),this.clipboardCopy(!1,!0)}})),i.length>0&&o.append(new Zt.MenuItem({label:"Cut",click:()=>{s(),this.clipboardCopy(!0)}})),o.append(new Zt.MenuItem({label:"Paste",click:()=>{s(),this.clipboardPaste()}})),t.notBlank(e.contents)){let t=this.layout.components[n].isCollapsed?"Expand Branch":"Collapse Branch";o.append(new Zt.MenuItem({label:t,click:()=>this.toggleCollapsed(n)}))}}else o.append(new Zt.MenuItem({label:"Zoom In",click:()=>this.zoom(1.25)})),o.append(new Zt.MenuItem({label:"Zoom Out",click:()=>this.zoom(.8)}));o.popup({window:(0,Zt.getCurrentWindow)()})}checkStructureIntegrity(t,e){let i=Object.keys(this.structureIntegrity).filter((e=>t.identifiers&&t.identifiers[e]||t.links&&t.links[e]));if(0==i.length)return;let s=t.molfile?Ut.readUnknown(t.molfile):null;if(Kt.isBlank(s)&&Kt.isBlank(e))return;if(s&&e&&Wt.sketchMappable(s,e))return;let n=Kt.isBlank(e)?"Structure has been removed.":"Structure has changed.";n+=`\nThe following reference${1==i.length?"":"s"} may have become stale:`;for(let t of i)n+="\n    "+this.structureIntegrity[t];if(n+=1==i.length?"\nRemove this reference?":"\nRemove these references?",confirm(n))for(let e of i)t.identifiers&&delete t.identifiers[e],t.links&&delete t.links[e]}}var ps=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function l(t){try{a(s.next(t))}catch(t){o(t)}}function r(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(l,r)}a((s=s.apply(t,e||[])).next())}))};const fs=[[{icon:"CommandSave.svg",tip:"Save",cmd:pt.Save}],[{icon:"CommandEdit.svg",tip:"Edit component",cmd:pt.EditDetails},{icon:"CommandStructure.svg",tip:"Edit structure",cmd:pt.EditStructure},{icon:"CommandLookup.svg",tip:"Lookup compound",cmd:pt.Lookup},{icon:"CommandPicture.svg",tip:"Export graphics",cmd:pt.ExportSVG}],[{icon:"CommandAppend.svg",tip:"Append component to the right",cmd:pt.Append},{icon:"CommandPrepend.svg",tip:"Prepend component to the left",cmd:pt.Prepend},{icon:"CommandInsertBefore.svg",tip:"Insert component above",cmd:pt.InsertBefore},{icon:"CommandInsertAfter.svg",tip:"Append component below",cmd:pt.InsertAfter},{icon:"CommandDelete.svg",tip:"Delete",cmd:pt.Delete},{icon:"CommandMoveUp.svg",tip:"Move Up",cmd:pt.MoveUp},{icon:"CommandMoveDown.svg",tip:"Move Down",cmd:pt.MoveDown}],[{icon:"CommandUndo.svg",tip:"Undo",cmd:pt.Undo},{icon:"CommandRedo.svg",tip:"Redo",cmd:pt.Redo}],[{icon:"CommandCopy.svg",tip:"Copy",cmd:pt.Copy},{icon:"CommandCut.svg",tip:"Cut",cmd:pt.Cut},{icon:"CommandPaste.svg",tip:"Paste",cmd:pt.Paste}],[{icon:"CommandZoomNormal.svg",tip:"Zoom full",cmd:pt.ZoomFull},{icon:"CommandZoomIn.svg",tip:"Zoom in",cmd:pt.ZoomIn},{icon:"CommandZoomOut.svg",tip:"Zoom out",cmd:pt.ZoomOut}]];class gs extends se{constructor(t,e,i){super(t),this.proxyClip=e,this.proxyMenu=i,this.filename=null,this.banner=new ft(fs,(t=>this.menuAction(t))),this.editor=new cs(this.inchi,this.proxyClip,this.proxyMenu),this.editor.callbackUpdateTitle=()=>this.updateTitle();let s=it("<div/>").appendTo(t).css({display:"flex"});s.css({"flex-direction":"column",width:"100%",height:"100%"});let n=it("<div/>").appendTo(s).css({"flex-grow":"0"}),o=it("<div/>").appendTo(s).css({"flex-grow":"1"});this.banner.render(n),this.editor.render(o),this.banner.callbackRefocus=()=>this.editor.refocus()}setMixture(t){this.editor.clearHistory(),this.editor.setMixture(t,!0,!1),this.editor.setDirty(!1)}loadFile(t){if(!t)return this.editor.clearHistory(),this.editor.setMixture(new qe,!0,!0),this.updateTitle(),void(this.filename=null);$t.readFile(t,"utf-8",((e,i)=>{if(e)throw e;let s;try{s=qe.deserialise(i)}catch(t){return console.log("Invalid mixture file: "+t+"\n"+i),void alert("Not a valid mixture file.")}s.mixfile.mixfileVersion=1,this.editor.clearHistory(),this.editor.setMixture(s,!0,!1),this.editor.setDirty(!1),this.filename=t,this.updateTitle()}))}saveFile(t){let e=this.editor.getMixture().serialise();$t.writeFile(t,e,(t=>{t&&alert("Unable to save: "+t)}))}onResize(){super.onResize(),this.editor.delayedRedraw()}menuAction(t){let e=this.editor.compoundEditor();e?t==pt.Cut?e.actionCut():t==pt.Copy?e.actionCopy():t==pt.Paste?e.actionPaste():t==pt.Undo?e.actionUndo():t==pt.Redo&&e.actionRedo():this.editor.isReceivingCommands()?super.menuAction(t):[pt.Cut,pt.Copy,pt.Paste,pt.Undo,pt.Redo].indexOf(t)>=0&&document.execCommand(t)}customMenuAction(t){t==pt.ExportSDF?this.actionExportSDF():t==pt.ExportSVG?this.actionFileExportSVG():t==pt.CreateMInChI?this.actionFileCreateMInChI():t==pt.Undo?this.editor.performUndo():t==pt.Redo?this.editor.performRedo():t==pt.Cut?this.editor.clipboardCopy(!0):t==pt.Copy?this.editor.clipboardCopy(!1):t==pt.CopyBranch?this.editor.clipboardCopy(!1,!0):t==pt.Paste?this.editor.clipboardPaste():t==pt.EditStructure?this.editor.editStructure():t==pt.EditDetails?this.editor.editDetails():t==pt.Lookup?this.editor.lookupCurrent():t==pt.Delete?this.editor.deleteCurrent():t==pt.Append?this.editor.appendToCurrent():t==pt.Prepend?this.editor.prependBeforeCurrent():t==pt.InsertBefore?this.editor.insertBeforeCurrent():t==pt.InsertAfter?this.editor.insertAfterCurrent():t==pt.MoveUp?this.editor.reorderCurrent(-1):t==pt.MoveDown?this.editor.reorderCurrent(1):t==pt.ZoomFull?this.editor.zoomFull():t==pt.ZoomNormal?this.editor.zoomNormal():t==pt.ZoomIn?this.editor.zoom(1.25):t==pt.ZoomOut?this.editor.zoom(.8):super.customMenuAction(t)}actionFileOpen(){let t={title:"Open Mixture",properties:["openFile"],defaultPath:this.filename&&this.filename.indexOf(ri.sep)?this.filename.substring(0,this.filename.lastIndexOf(ri.sep)):void 0,filters:[{name:"Mixfile",extensions:["mixfile"]},{name:"Mixfile Collection",extensions:["json"]}]};Zt.dialog.showOpenDialog(t).then((t=>{if(t.canceled)return;let e=this.editor.getMixture().isEmpty();for(let i of t.filePaths)e&&i.endsWith(".mixfile")?(this.loadFile(i),e=!1):i.endsWith(".json")?Bs("CollectionPanel",i):Bs("MixturePanel",i)}))}actionFileSave(){this.editor.isBlank()||(this.filename?(this.saveFile(this.filename),this.editor.setDirty(!1),this.updateTitle()):this.actionFileSaveAs())}actionFileSaveAs(){this.editor.isBlank()||Zt.dialog.showSaveDialog({title:"Save Mixfile",filters:[{name:"Mixfile",extensions:["mixfile"]}]}).then((t=>{t.canceled||(this.saveFile(t.filePath),this.filename=t.filePath,this.editor.setDirty(!1),this.updateTitle())}))}actionExportSDF(){let t=this.editor.getMixture();if(t.isEmpty())return;let e=new Fe;e.append(t.mixfile);let i=e.write(),s=this.filename;if(s){let t=s.lastIndexOf(".");t>0&&t>s.lastIndexOf("/")&&t>s.lastIndexOf("\\")&&(s=s.substring(0,t)),s+=".sdf"}else s=void 0;let n={title:"Export as SDfile",defaultPath:s,filters:[{name:"SDfile",extensions:["sdf"]}]};this.filename&&this.filename.endsWith(".mixfile")&&(n.defaultPath=(this.filename.substring(0,this.filename.length-8)+".sdf").split(/[\/\\]/).pop()),Zt.dialog.showSaveDialog(n).then((t=>{t.canceled||$t.writeFile(t.filePath,i,(t=>{t&&alert("Unable to save: "+t)}))}))}actionFileExportSVG(){let t=this.filename;if(t){let e=t.lastIndexOf(".");e>0&&e>t.lastIndexOf("/")&&e>t.lastIndexOf("\\")&&(t=t.substring(0,e)),t+=".svg"}else t=void 0;let e={title:"Save SVG Diagram",defaultPath:t,filters:[{name:"Scalable Vector Graphics",extensions:["svg"]}]};Zt.dialog.showSaveDialog(e).then((t=>{if(t.canceled)return;let e=_e.defaultColourOnWhite(),i=new Ue(0,0,e.data.pointScale),s=new ei(this.editor.getMixture(),i,e);s.collapsedBranches=this.editor.getCollapsedBranches(),s.packBranches=new $(.8*this.editor.contentDOM.width(),.8*this.editor.contentDOM.height()),s.arrange();let n=new si;new oi(s,n).draw(),n.normalise();let o=n.createSVG(!0,!0);$t.writeFile(t.filePath,o,(t=>{t&&alert("Unable to save: "+t)}))}))}actionFileCreateMInChI(){if(!ie.isAvailable())return void alert("InChI executable has not been configured. Specify with --inchi parameter.");let t=new ze(this.editor.getMixture().mixfile,this.inchi),e=this;(new class extends li{constructor(){super(),this.title="MInChI"}populate(){e.proxyClip.pushHandler(new oe),this.bodyDOM().setText("Calculating..."),(()=>{ps(this,void 0,void 0,(function*(){return yield this.renderResult()}))})()}close(){e.proxyClip.popHandler(),super.close()}renderResult(){return ps(this,void 0,void 0,(function*(){yield function(){return l(this,void 0,void 0,(function*(){return new Promise((t=>setTimeout((()=>t()))))}))}(),yield t.fillInChI(),t.formulate();let i=this.bodyDOM();i.empty();let s=it("<div/>").appendTo(i),n=it("<span/>").appendTo(s).css({"font-family":"monospace","padding-top":"0.5em","word-break":"break-all"}),o=t.getResult(),r=t.getSegment();for(let t=0;t<o.length;t++){let e=it("<span/>").appendTo(n);e.setText(o[t]),r[t]==De.Header?e.setCSS("background-color","#FFC0C0"):r[t]==De.Component?e.setCSS("background-color","#C0C0FF"):r[t]==De.Hierarchy?e.setCSS("background-color","#E0E080"):r[t]==De.Concentration&&e.setCSS("background-color","#80E080"),n.appendHTML("<wbr/>")}it('<button class="wmk-button wmk-button-small wmk-button-default">Copy</button>').appendTo(s).css({"margin-left":"0.5em"}).onClick((()=>e.proxyClip.setString(o)))}))}}).open()}updateTitle(){if(null==this.filename)return void(document.title="Mixtures");let t=Math.max(this.filename.lastIndexOf("/"),this.filename.lastIndexOf("\\")),e="Mixtures - "+this.filename.substring(t+1);this.editor.isDirty()&&!this.editor.isBlank()&&(e+="*"),document.title=e}}class bs{hasContextMenu(){return!1}openContextMenu(t,e,i){}}const ys=require("process");var xs=i(157);class As{constructor(t){this.mixtures=[],t&&(this.mixtures=t.slice(0))}get count(){return this.mixtures.length}getMixture(t){return this.mixtures[t].clone()}getMixtureDirect(t){return this.mixtures[t]}setMixture(t,e){this.mixtures[t]=e.clone()}setMixtureDirect(t,e){this.mixtures[t]=e}deleteMixture(t){this.mixtures.splice(t,1)}appendMixture(t){return this.mixtures.push(t.clone()),this.mixtures.length-1}appendMixtureDirect(t){return this.mixtures.push(t),this.mixtures.length-1}appendCollection(t){this.mixtures=this.mixtures.concat(t.mixtures)}insertMixture(t,e){this.mixtures.splice(t,0,e.clone())}swapMixtures(t,e){let[i,s]=[this.mixtures[t],this.mixtures[e]];this.mixtures[t]=s,this.mixtures[e]=i}static deserialise(t){let e=JSON.parse(t);if(!Array.isArray(e))throw"Input content is not a JSON array.";let i=[];for(let t of e)i.push(new qe(t));return new As(i)}serialise(t){let e=[];for(let t of this.mixtures)e.push(t.mixfile);return t||e.length<=100?qe.beautify(e):"[\n    "+e.map((t=>JSON.stringify(t))).join(",\n    ")+"\n]\n"}}const vs=[[{icon:"CommandSave.svg",tip:"Save",cmd:pt.Save}],[{icon:"CommandEdit.svg",tip:"Edit component",cmd:pt.EditDetails},{icon:"CommandStructure.svg",tip:"Edit structure",cmd:pt.EditStructure},{icon:"CommandLookup.svg",tip:"Lookup compound",cmd:pt.Lookup},{icon:"CommandPicture.svg",tip:"Export graphics",cmd:pt.ExportSVG}],[{icon:"CommandAppend.svg",tip:"Append component",cmd:pt.Append},{icon:"CommandPrepend.svg",tip:"Prepend component",cmd:pt.Prepend},{icon:"CommandDelete.svg",tip:"Delete",cmd:pt.Delete},{icon:"CommandMoveUp.svg",tip:"Move Up",cmd:pt.MoveUp},{icon:"CommandMoveDown.svg",tip:"Move Down",cmd:pt.MoveDown}],[{icon:"CommandUndo.svg",tip:"Undo",cmd:pt.Undo},{icon:"CommandRedo.svg",tip:"Redo",cmd:pt.Redo}],[{icon:"CommandCopy.svg",tip:"Copy",cmd:pt.Copy},{icon:"CommandCut.svg",tip:"Cut",cmd:pt.Cut},{icon:"CommandPaste.svg",tip:"Paste",cmd:pt.Paste}],[{icon:"CommandViewDetail.svg",tip:"Detail",cmd:pt.ViewDetail},{icon:"CommandViewCard.svg",tip:"Cards",cmd:pt.ViewCard},{icon:"CommandZoomNormal.svg",tip:"Zoom full",cmd:pt.ZoomFull},{icon:"CommandZoomIn.svg",tip:"Zoom in",cmd:pt.ZoomIn},{icon:"CommandZoomOut.svg",tip:"Zoom out",cmd:pt.ZoomOut}]];var Ms;!function(t){t[t.Detail=0]="Detail",t[t.Card=1]="Card"}(Ms||(Ms={}));const Ts="#E0E0E0";class ws extends se{constructor(t,e,i){super(t),this.proxyClip=e,this.proxyMenu=i,this.filename=null,this.collection=new As,this.curPage=0,this.pageBlock=[],this.isDirty=!1,this.policy=_e.defaultColourOnWhite(20),this.viewType=Ms.Detail,this.selected=-1,this.mapMixDiv=new Map,this.editor=null,this.banner=new ft(vs,(t=>this.menuAction(t)));let s=it("<div/>").appendTo(t).css({display:"flex"});s.css({"flex-direction":"column",width:"100%",height:"100%"});let n=it("<div/>").appendTo(s).css({"flex-grow":"0"});this.divMain=it("<div/>").appendTo(s).css({"flex-grow":"1","overflow-y":"scroll"}),this.divFooter=it("<div/>").appendTo(s).css({"flex-grow":"0"}),this.banner.render(n),this.dividePages(),this.renderMain(),this.updateBanner()}setCollection(t){this.collection=t,this.dividePages(),this.renderMain()}loadFile(t){t?$t.readFile(t,"utf-8",((e,i)=>{if(e)throw e;let s;try{s=As.deserialise(i)}catch(t){return console.log("Invalid mixture collection file: "+t+"\n"+i),void alert("Not a valid mixture collection file.")}this.setCollection(s),this.filename=t,this.isDirty=!1,this.updateTitle()})):this.setCollection(new As)}menuAction(t){if(this.editor){let e=this.editor.compoundEditor();if(e)return void(t==pt.Cut?e.actionCut():t==pt.Copy?e.actionCopy():t==pt.Paste?e.actionPaste():t==pt.Undo?e.actionUndo():t==pt.Redo&&e.actionRedo());if(!this.editor.isReceivingCommands())return void([pt.Cut,pt.Copy,pt.Paste,pt.Undo,pt.Redo].indexOf(t)>=0&&document.execCommand(t))}super.menuAction(t)}customMenuAction(t){this.editor?t==pt.Undo?this.editor.performUndo():t==pt.Redo?this.editor.performRedo():t==pt.Cut?this.editor.clipboardCopy(!0):t==pt.Copy?this.editor.clipboardCopy(!1):t==pt.CopyBranch?this.editor.clipboardCopy(!1,!0):t==pt.Paste?this.editor.clipboardPaste():t==pt.EditStructure?this.editor.editStructure():t==pt.EditDetails?this.editor.editDetails():t==pt.Lookup?this.editor.lookupCurrent():t==pt.Delete?this.editor.deleteCurrent():t==pt.Append?this.editor.appendToCurrent():t==pt.Prepend?this.editor.prependBeforeCurrent():t==pt.MoveUp?this.editor.reorderCurrent(-1):t==pt.MoveDown?this.editor.reorderCurrent(1):t==pt.ZoomFull||t==pt.ZoomNormal?this.editor.zoomFull():t==pt.ZoomIn?this.editor.zoom(1.25):t==pt.ZoomOut?this.editor.zoom(.8):super.customMenuAction(t):t==pt.Cut?this.clipboardCopy(!0):t==pt.Copy?this.clipboardCopy(!1):t==pt.Paste?this.clipboardPaste():t==pt.EditDetails?this.editMixture():t==pt.Delete?this.deleteMixture():t==pt.Append?this.appendMixture():t==pt.Prepend?this.prependMixture():t==pt.MoveUp?this.reorderCurrent(-1):t==pt.MoveDown?this.reorderCurrent(1):t==pt.ZoomFull?this.zoomScale():t==pt.ZoomIn?this.zoomScale(1.25):t==pt.ZoomOut?this.zoomScale(.8):t==pt.ViewDetail||t==pt.ViewCard?this.changeView(t):super.customMenuAction(t)}renderMain(){this.divMain.empty(),this.divFooter.empty(),this.selected=-1,this.mapMixDiv.clear();let e=it("<div/>").appendTo(this.divMain);this.viewType==Ms.Card&&(e.css({display:"flex","flex-wrap":"wrap"}),e.css({"justify-content":"flex-start","align-items":"flex-start"}));for(let t of this.pageBlock[this.curPage]){let i=this.createMixture(t,this.collection.getMixture(t)).appendTo(e);i.onClick((()=>this.changeSelection(t))),i.onDblClick((()=>this.editMixture())),this.mapMixDiv.set(t,i)}let i=this.pageBlock.length;if(i>1){if(this.divFooter.css({"text-align":"center","border-top":"1px solid #808080","background-color":"white"}),this.curPage>0){let t=it("<a/>").appendTo(this.divFooter).attr({href:"#"});t.setText("Previous"),t.onClick((t=>{this.curPage--,this.renderMain(),t.preventDefault()}))}let e=[];for(let t=Math.max(0,this.curPage-5);t<=Math.min(i-1,this.curPage+5);t++)e.push(t);0!=t.first(e)&&e.unshift(0),t.last(e)!=i-1&&e.push(i-1);for(let t=0;t<e.length;t++){let i=e[t];if(t>0&&i!=e[t-1]+1&&this.divFooter.appendText("..."),i!=this.curPage){let t=it("<a/>").appendTo(this.divFooter).attr({href:"#"});t.setText(`${i+1}`),t.onClick((t=>{this.curPage=i,this.renderMain(),t.preventDefault()}))}else this.divFooter.appendHTML(`<span>${i+1}</span>`)}if(this.curPage<i-1){let t=it("<a/>").appendTo(this.divFooter).attr({href:"#"});t.setText("Next"),t.onClick((t=>{this.curPage++,this.renderMain(),t.preventDefault()}))}for(let t of this.divFooter.findAll("a,span"))t.css({"margin-left":"0.25em","margin-right":"0.25em"});this.divFooter.appendText(` (${this.collection.count})`)}}dividePages(){let t=this.collection.count;if(0==t)return this.pageBlock=[[]],void(this.curPage=0);let e=[];this.pageBlock=[e];for(let i=0;i<t;i++)e.length>=100&&this.pageBlock.push(e=[]),e.push(i);this.curPage=Math.min(this.curPage,this.pageBlock.length-1)}createMixture(t,e){let i=it("<div/>");this.viewType==Ms.Detail?i.css({display:"block"}):i.css({display:"inline-block"});let s=it("<div/>").appendTo(i).css({display:"flex"});s.css({margin:"2px",padding:"2px","border-radius":"4px"}),s.css({"background-color":Ts,border:"1px solid #808080"});let n=new Ue(0,0,this.policy.data.pointScale),o=new ei(e,n,this.policy);o.arrange();let l=new si;new oi(o,l).draw();let r=(t+1).toString(),a=Xe.measureText(r,10);l.drawRect(0,0,a[0]+4,a[1]+4,si.NOCOLOUR,0,0),l.drawText(2,2,r,10,16777215,Ze.Top|Ze.Left),l.normalise();let h=it("<div/>").appendTo(s).css({display:"inline-block"});return it(l.createSVG()).appendTo(h).css({display:"block"}),this.viewType==Ms.Detail&&this.displayFields(it("<div/>").appendTo(s),e),s}changeView(t){t==pt.ViewDetail?this.viewType=Ms.Detail:t==pt.ViewCard&&(this.viewType=Ms.Card),this.renderMain()}changeSelection(t){if(this.selected>=0){let t=this.mapMixDiv.get(this.selected);t&&t.css({"background-color":Ts})}if(this.selected=t,t>=0){let e=this.mapMixDiv.get(t);e&&e.css({"background-color":"#B9CBFF"})}}actionFileOpen(){Zt.dialog.showOpenDialog({title:"Open Mixtures",properties:["openFile"],filters:[{name:"Mixfile Collection",extensions:["json"]},{name:"Mixfile",extensions:["mixfile"]}]}).then((t=>{if(!t.canceled)for(let e of t.filePaths)e.endsWith(".mixfile")?Bs("MixturePanel",e):Bs("CollectionPanel",e)}))}actionFileSave(){this.editor?this.stopEdit():this.filename?(this.saveFile(this.filename),this.isDirty=!1,this.updateTitle()):this.actionFileSaveAs()}actionFileSaveAs(){Zt.dialog.showSaveDialog({}).then((t=>{t.canceled||(this.saveFile(t.filePath),this.filename=t.filePath,this.isDirty=!1,this.updateTitle())}))}saveFile(t){let e=this.collection.serialise();$t.writeFile(t,e,(t=>{t&&alert("Unable to save: "+t)}))}updateTitle(){if(null==this.filename)return void(document.title="Mixture Collection");let t=Math.max(this.filename.lastIndexOf("/"),this.filename.lastIndexOf("\\")),e="Mixture Collection - "+this.filename.substring(t+1);this.isDirty&&(e+="*"),document.title=e}updateBanner(){let t=null!=this.editor;this.banner.activateButtons({[pt.EditStructure]:t,[pt.Lookup]:t,[pt.ExportSVG]:t,[pt.Undo]:t,[pt.Redo]:t,[pt.ViewDetail]:!t,[pt.ViewCard]:!t})}scrollToIndex(t){if(t<0)return;let e=this.mapMixDiv.get(t);e&&(this.divMain.el.scrollTop=e.offset().y-this.divMain.offset().y+this.divMain.el.scrollTop)}editMixture(){this.selected<0||(this.editor=new cs(this.inchi,this.proxyClip,this.proxyMenu),this.divMain.empty(),this.editor.render(this.divMain),this.editor.setMixture(this.collection.getMixture(this.selected)),this.editor.setDirty(!1),this.updateBanner())}stopEdit(){if(!this.editor)return;let t=this.selected;this.editor.isDirty()&&(this.collection.setMixture(t,this.editor.getMixture()),this.isDirty=!0),this.editor=null,this.renderMain(),this.changeSelection(t),this.scrollToIndex(t),this.updateBanner(),this.updateTitle()}clipboardCopy(t){let e=this.selected;if(e<0||this.editor)return;let i=this.collection.getMixture(e).serialise();if(this.proxyClip.setString(i),t){this.collection.deleteMixture(e),this.isDirty=!0;let t=this.divMain.el.scrollTop;this.renderMain(),this.divMain.el.scrollTop=t,this.updateBanner(),this.updateTitle()}}clipboardPaste(){let t=qe.deserialise(this.proxyClip.getString());t?this.appendMixture(t):alert("No mixture on clipboard.")}deleteMixture(){let t=this.selected;t<0||this.editor||(this.collection.deleteMixture(t),this.renderMain(),t<this.collection.count&&this.scrollToIndex(t),this.isDirty=!0,this.updateTitle())}appendMixture(t){if(t||(t=new qe),this.editor)return;let e;this.selected<0?e=this.collection.appendMixture(t):(e=this.selected+1,this.collection.insertMixture(e,t)),this.dividePages(),this.renderMain(),this.changeSelection(e),this.scrollToIndex(e),this.isDirty=!0,this.updateTitle()}prependMixture(){if(this.editor)return;let t=Math.max(0,this.selected);this.collection.insertMixture(t,new qe);let e=this.divMain.el.scrollTop;this.renderMain(),this.changeSelection(t),this.divMain.el.scrollTop=e,this.isDirty=!0,this.updateTitle()}reorderCurrent(t){let e=this.selected;if(e<0||e+t<0||e+t>=this.collection.count||this.editor)return;this.collection.swapMixtures(e,e+t);let i=this.divMain.el.scrollTop;this.renderMain(),this.changeSelection(e+t),this.divMain.el.scrollTop=i,this.isDirty=!0,this.updateTitle()}zoomScale(t){}displayFields(t,e){let i=[],s=e.mixfile;const n=["name","molfile","quantity","ratio","units","relation","mixfileVersion"];for(let t in s)if(!n.includes(t)){let e=s[t];if("string"!=typeof e&&"number"!=typeof e)continue;i.push([t,e.toString()])}if(0==i.length)return;i.sort(((t,e)=>t[0].localeCompare(e[0]))),t.css({"padding-left":"0.5em"});let o=it("<div/>").appendTo(t).css({display:"flex"});o.css({"flex-direction":"row","flex-wrap":"wrap","justify-content":"flex-start","align-items":"flex-start"});for(let[t,e]of i){let i=it("<div/>").appendTo(o).css({"white-space":"nowrap",margin:"0 0.2em 0.2em 0"}),s=it("<div/>").appendTo(i).css({display:"inline-block",padding:"0.2em","background-color":"#C0C0C0",border:"1px solid black"}),n=it("<div/>").appendTo(i).css({display:"inline-block",padding:"0.2em","background-color":"#F8F8F8",border:"1px solid black"});s.css({"border-right":"none"}),s.css({"border-radius":"0.2em 0 0 0.2em"}),n.css({"border-radius":"0 0.2em 0.2em 0"}),s.setText(t),n.setText(e)}}}var Es=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function l(t){try{a(s.next(t))}catch(t){o(t)}}function r(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(l,r)}a((s=s.apply(t,e||[])).next())}))};let Cs=!1;function Ss(t){Cs=t}function ks(t,e){return Es(this,void 0,void 0,(function*(){let i=nt.find("#"+e);Cs=!0,function(t){ot.RESOURCE_URL=t;try{document}catch(t){return}document&&at("main",function(){let t=u(ot.lowlight);return`\n\t\t.wmk-button\n\t\t{\n\t\t\tdisplay: inline-block;\n\t\t\tpadding: 6px 12px;\n\t\t\tmargin-bottom: 0;\n\t\t\tfont-family: 'Open Sans', sans-serif;\n\t\t\tfont-size: 14px;\n\t\t\tfont-weight: normal;\n\t\t\tline-height: 1.42857143;\n\t\t\ttext-align: center;\n\t\t\twhite-space: nowrap;\n\t\t\tvertical-align: middle;\n\t\t\tcursor: pointer;\n\t\t\tbackground-image: none;\n\t\t\tborder: 1px solid transparent;\n\t\t\tborder-radius: 4px;\n\t\t\t-ms-touch-action: manipulation; touch-action: manipulation;\n\t\t\t-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;\n\t\t}\n\t\t.wmk-button:focus,\n\t\t.wmk-button:active:focus,\n\t\t.wmk-button.active:focus,\n\t\t.wmk-button.focus,\n\t\t.wmk-button:active.focus,\n\t\t.wmk-button.active.focus\n\t\t{\n\t\t\toutline: thin dotted;\n\t\t\toutline: 5px auto -webkit-focus-ring-color;\n\t\t\toutline-offset: -2px;\n\t\t}\n\t\t.wmk-button:hover,\n\t\t.wmk-button:focus,\n\t\t.wmk-button.focus\n\t\t{\n\t\t\tcolor: #333;\n\t\t\ttext-decoration: none;\n\t\t}\n\t\t.wmk-button:active,\n\t\t.wmk-button.active\n\t\t{\n\t\t\tbackground-image: none;\n\t\t\toutline: 0;\n\t\t\t-webkit-box-shadow: inset 0 3px 5px rgba(0, 0, 0, .125);\n\t\t\tbox-shadow: inset 0 3px 5px rgba(0, 0, 0, .125);\n\t\t}\n\t\t.wmk-button.disabled,\n\t\t.wmk-button[disabled],\n\t\tfieldset[disabled] .wmk-button\n\t\t{\n\t\t\tcursor: not-allowed;\n\t\t\tfilter: alpha(opacity=65);\n\t\t\t-webkit-box-shadow: none;\n\t\t\tbox-shadow: none;\n\t\t\topacity: .65;\n\t\t}\n\t\ta.wmk-button.disabled,\n\t\tfieldset[disabled] a.wmk-button\n\t\t{\n\t\t\tpointer-events: none;\n\t\t}\n\n\t\t/* shrunken button */\n\n\t\t.wmk-button-small\n\t\t{\n\t\t\tpadding: 2px 4px;\n\t\t\tline-height: 1;\n\t\t\tfont-size: 12px;\n\t\t}\n\n\t\t/* default button */\n\n\t\t.wmk-button-default\n\t\t{\n\t\t\tcolor: #333;\n\t\t\tbackground-color: #fff;\n\t\t\tbackground-image: linear-gradient(to right bottom, #FFFFFF, #E0E0E0);\n\t\t\tborder-color: #ccc;\n\t\t}\n\t\t.wmk-button-default:focus,\n\t\t.wmk-button-default.focus\n\t\t{\n\t\t\tcolor: #333;\n\t\t\tbackground-color: #e6e6e6;\n\t\t\tborder-color: #8c8c8c;\n\t\t}\n\t\t.wmk-button-default:hover\n\t\t{\n\t\t\tcolor: #333;\n\t\t\tbackground-color: #e6e6e6;\n\t\t\tborder-color: #adadad;\n\t\t}\n\t\t.wmk-button-default:active,\n\t\t.wmk-button-default.active,\n\t\t.open > .dropdown-toggle.wmk-button-default\n\t\t{\n\t\t\tcolor: #333;\n\t\t\tbackground-color: #e6e6e6;\n\t\t\tborder-color: #adadad;\n\t\t}\n\t\t.wmk-button-default:active:hover,\n\t\t.wmk-button-default.active:hover,\n\t\t.open > .dropdown-toggle.wmk-button-default:hover,\n\t\t.wmk-button-default:active:focus,\n\t\t.wmk-button-default.active:focus,\n\t\t.open > .dropdown-toggle.wmk-button-default:focus,\n\t\t.wmk-button-default:active.focus,\n\t\t.wmk-button-default.active.focus,\n\t\t.open > .dropdown-toggle.wmk-button-default.focus\n\t\t{\n\t\t\tcolor: #333;\n\t\t\tbackground-color: #d4d4d4;\n\t\t\tborder-color: #8c8c8c;\n\t\t}\n\t\t.wmk-button-default:active,\n\t\t.wmk-button-default.active,\n\t\t.open > .dropdown-toggle.wmk-button-default\n\t\t{\n\t\t\tbackground-image: none;\n\t\t}\n\t\t.wmk-button-default.disabled:hover,\n\t\t.wmk-button-default[disabled]:hover,\n\t\tfieldset[disabled] .wmk-button-default:hover,\n\t\t.wmk-button-default.disabled:focus,\n\t\t.wmk-button-default[disabled]:focus,\n\t\tfieldset[disabled] .wmk-button-default:focus,\n\t\t.wmk-button-default.disabled.focus,\n\t\t.wmk-button-default[disabled].focus,\n\t\tfieldset[disabled] .wmk-button-default.focus\n\t\t{\n\t\t\tbackground-color: #fff;\n\t\t\tborder-color: #ccc;\n\t\t}\n\t\t.wmk-button-default .badge\n\t\t{\n\t\t\tcolor: #fff;\n\t\t\tbackground-color: #333;\n\t\t}\n\n\t\t/* primary button */\n\n\t\t.wmk-button-primary\n\t\t{\n\t\t\tcolor: #fff;\n\t\t\tbackground-color: #008FD2;\n\t\t\tbackground-image: linear-gradient(to right bottom, ${u(ot.lowlightEdge1)}, ${u(ot.lowlightEdge2)});\n\t\t\tborder-color: #00C0C0;\n\t\t}\n\t\t.wmk-button-primary:focus,\n\t\t.wmk-button-primary.focus\n\t\t{\n\t\t\tcolor: #fff;\n\t\t\tbackground-color: ${t};\n\t\t\tborder-color: #122b40;\n\t\t}\n\t\t.wmk-button-primary:hover\n\t\t{\n\t\t\tcolor: #fff;\n\t\t\tbackground-color: #286090;\n\t\t\tborder-color: #204d74;\n\t\t}\n\t\t.wmk-button-primary:active,\n\t\t.wmk-button-primary.active,\n\t\t.open > .dropdown-toggle.wmk-button-primary\n\t\t{\n\t\t\tcolor: #fff;\n\t\t\tbackground-color: #286090;\n\t\t\tborder-color: #20744d;\n\t\t}\n\t\t.wmk-button-primary:active:hover,\n\t\t.wmk-button-primary.active:hover,\n\t\t.open > .dropdown-toggle.wmk-button-primary:hover,\n\t\t.wmk-button-primary:active:focus,\n\t\t.wmk-button-primary.active:focus,\n\t\t.open > .dropdown-toggle.wmk-button-primary:focus,\n\t\t.wmk-button-primary:active.focus,\n\t\t.wmk-button-primary.active.focus,\n\t\t.open > .dropdown-toggle.wmk-button-primary.focus\n\t\t{\n\t\t\tcolor: #fff;\n\t\t\tbackground-color: ${u(ot.highlight)};\n\t\t\tbackground-image: linear-gradient(to right bottom, ${u(ot.highlightEdge1)}, ${u(ot.highlightEdge2)});\n\t\t\tborder-color: #12802b;\n\t\t}\n\t\t.wmk-button-primary:active,\n\t\t.wmk-button-primary.active,\n\t\t.open > .dropdown-toggle.wmk-button-primary\n\t\t{\n\t\t\tbackground-image: none;\n\t\t}\n\t\t.wmk-button-primary.disabled:hover,\n\t\t.wmk-button-primary[disabled]:hover,\n\t\tfieldset[disabled] .wmk-button-primary:hover,\n\t\t.wmk-button-primary.disabled:focus,\n\t\t.wmk-button-primary[disabled]:focus,\n\t\tfieldset[disabled] .wmk-button-primary:focus,\n\t\t.wmk-button-primary.disabled.focus,\n\t\t.wmk-button-primary[disabled].focus,\n\t\tfieldset[disabled] .wmk-button-primary.focus\n\t\t{\n\t\t\tbackground-color: #337ab7;\n\t\t\tborder-color: #2ea46d;\n\t\t}\n\t\t.wmk-button-primary .badge\n\t\t{\n\t\t\tcolor: #337ab7;\n\t\t\tbackground-color: #fff;\n\t\t}\n\t`}())}(t),yield Qe.init(),yield Qe.main.loadFromURL(t+"/data/ontology/metacategory.onto"),ys.env.ELECTRON_DISABLE_SECURITY_WARNINGS="true";let s=window.location.href.substring(0,window.location.href.lastIndexOf("/"));ot.RESOURCE_URL=ri.normalize(s+"/res");let n=window.location.search.substring(1).split("&"),o=null,l=null;for(let t of n){let e=t.indexOf("=");if(e<0)continue;let i=t.substring(0,e),s=decodeURIComponent(t.substring(e+1));"panel"==i?o=s:"fn"==i&&(l=s)}!o&&l&&l.endsWith(".json")&&(o="CollectionPanel");let r=new le;r.getString=()=>Zt.clipboard.readText(),r.setString=t=>Zt.clipboard.writeText(t),r.setHTML=t=>Zt.clipboard.writeHTML(t),r.canSetHTML=()=>!0,r.canAlwaysGet=()=>!0;let a,h=new bs;h.hasContextMenu=()=>!0,h.openContextMenu=(t,e)=>{let i=(t,e)=>{for(let s of e)if(s&&s.label){if(s.click)t.append(new Zt.MenuItem(s));else if(s.subMenu){let e=new Zt.Menu;i(e,s.subMenu),t.append(new Zt.MenuItem({label:s.label,submenu:e}))}}else t.append(new Zt.MenuItem({type:"separator"}))},s=new Zt.Menu;i(s,t),s.popup({window:(0,Zt.getCurrentWindow)()})},o&&"MixturePanel"!=o?"CollectionPanel"==o&&(a=new ws(i,r,h)):a=new gs(i,r,h),a.loadFile(l),xs.ipcRenderer.on("menuAction",((t,e)=>a.menuAction(e)))}))}function Bs(t,e,i={}){let s=Object.assign({},i);t&&(s.panelClass=t),e&&(s.filename=e),xs.ipcRenderer.send("openWindow",s)}})(),Mixtures=s})();
//# sourceMappingURL=mixtures.js.map